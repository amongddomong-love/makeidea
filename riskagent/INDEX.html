  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹œì¥ì§€í‘œ ë„¤íŠ¸ì›Œí¬ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover" />
  <!-- Favicon 404 ì—ëŸ¬ ë°©ì§€ -->
  <link rel="icon" href="data:,">
  <!-- ë¡œì»¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ -->
  <script src="libs/chart.min.js" defer></script>
  <script src="libs/d3.v7.min.js" defer></script>
  <script src="libs/xlsx.full.min.js" defer></script>
  <!-- PDF.js (ë¸Œë¼ìš°ì € ë‚´ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <!-- PPTX ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ (UMD ë¹Œë“œ) -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js" defer></script>
  <style>
    :root {
      --sidebar-width: 400px;
      --sidebar-bg: #f5f7fa;
      --main-bg: #fff;
      --main-text: #222;
      --accent: #4a90e2;
      --accent-hover: #0056b3;
      --border: #e0e0e0;
      --size-btn-bg: #4a90e2;
      --size-btn-hover: #0056b3;
      --size-display-bg: rgba(74, 144, 226, 0.1);
    }
    [data-theme="dark"] {
      --sidebar-bg: #23272f;
      --main-bg: #181a20;
      --main-text: #f5f5f5;
      --accent: #7ab7ff;
      --accent-hover: #5a9bff;
      --border: #333;
      --size-btn-bg: #7ab7ff;
      --size-btn-hover: #5a9bff;
      --size-display-bg: rgba(122, 183, 255, 0.1);
    }
    /* ğŸ”¥ ìµœìƒìœ„ ì»¨í…Œì´ë„ˆ: viewportë¥¼ 100% ì±„ìš°ê³  ì—¬ë°± ì™„ì „ ì œê±° */
    html { 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      height: 100vh; /* viewport ë†’ì´ 100% */
      width: 100vw; /* viewport ë„ˆë¹„ 100% */
      position: fixed; /* ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨, í™”ë©´ ê³ ì • */
      box-sizing: border-box; /* padding/borderë¥¼ width/heightì— í¬í•¨ */
    }
    body { 
      margin: 0; 
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: var(--main-bg); 
      color: var(--main-text); 
      transition: background 0.3s, color 0.3s; 
      overflow: hidden; 
      height: 100vh; /* viewport ë†’ì´ 100% */
      width: 100vw; /* viewport ë„ˆë¹„ 100% */
      position: fixed; /* ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨ */
      box-sizing: border-box;
    }
    
    /* ëª¨ë“  ìš”ì†Œì— box-sizing ì ìš©í•˜ì—¬ í¬ê¸° ê³„ì‚° ì¼ê´€ì„± í™•ë³´ */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œì˜ ê¸°ë³¸ í„°ì¹˜ ë° ìŠ¤í¬ë¡¤ ê°œì„  */
    @media screen and (orientation: landscape) and (max-height: 600px) {
      body { 
        -webkit-text-size-adjust: 100%; /* iOS Safari í…ìŠ¤íŠ¸ í¬ê¸° ìë™ ì¡°ì • ë°©ì§€ */
        -webkit-tap-highlight-color: transparent; /* í„°ì¹˜ì‹œ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
      }
      
      .layout { 
        min-height: 100vh; 
        max-height: 100vh; /* í™”ë©´ ë†’ì´ ì œí•œ */
      }
      
      /* ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ì˜ì—­ í„°ì¹˜ ê°œì„  */
      #network-graph { 
        touch-action: manipulation; /* ë”ë¸”íƒ­ ì¤Œ ë°©ì§€í•˜ë©´ì„œ íŒ¬ í—ˆìš© */
      }
      
      #network-graph svg { 
        touch-action: none; /* SVGì—ì„œëŠ” ê¸°ë³¸ í„°ì¹˜ ë™ì‘ ì°¨ë‹¨í•˜ê³  D3 ì¤Œì´ ì²˜ë¦¬ */
        pointer-events: all; /* ëª¨ë“  í¬ì¸í„° ì´ë²¤íŠ¸ í—ˆìš© */
      }
    }
    
    /* ğŸ“± ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ: íƒ­ì„ ì•„ë˜ìª½ì— ë°°ì¹˜ */
    @media screen and (orientation: portrait) and (max-width: 900px) {
      .layout {
        flex-direction: column !important;
        height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden !important;
      }
      
      main { 
        order: 1 !important;
        flex: 1 !important;
        min-height: 0;
        overflow: hidden;
      }
      
      aside.sidebar-left { 
        display: none !important; /* ì„¸ë¡œëª¨ë“œì—ì„œëŠ” ì™¼ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */
      }
      
      aside.sidebar-right { 
        order: 2 !important;
        width: 100vw !important;
        height: 70vh !important; /* í™”ë©´ ë†’ì´ì˜ 70% */
        max-height: 70vh !important;
        min-height: 320px !important;
        border-left: none !important;
        border-top: 2px solid var(--border) !important;
        position: relative !important;
        overflow-y: auto !important;
        flex-shrink: 0 !important;
      }
      
      /* ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ì˜ì—­ í™•ì¥ */
      #network-graph { 
        width: 100% !important;
        height: 100% !important;
      }
      
      /* íƒ­ ë‚´ë¶€ íŒ¨ë”© ì¡°ì • */
      aside.sidebar-right {
        padding: 8px 12px !important;
      }
      
      aside.sidebar-right h4 { 
        font-size: 14px !important; 
        margin: 6px 0 !important; 
      }
      
      aside.sidebar-right .agent-card { 
        padding: 8px !important; 
        margin-bottom: 8px !important; 
      }
      
      aside.sidebar-right textarea { 
        font-size: 12px !important; 
        min-height: 60px !important; 
      }
      
      /* ğŸ“± ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ í¬ê¸° ì¡°ì • (ì„¸ë¡œëª¨ë“œëŠ” ê¸°ì¡´ í¬ê¸° ìœ ì§€) */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 12px 20px !important; /* ì•½ê°„ ì¶•ì†Œ */
        font-size: 16px !important;
        font-weight: 700 !important;
        width: 85% !important;
        max-width: 100% !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(74,144,226,0.35) !important;
        line-height: 1.2 !important;
      }
      
      /* ğŸ“± ë³´ê³ ì„œë³´ê¸° ë²„íŠ¼ í¬ê¸° ì¡°ì • (ì™„ë£Œ ì‹œ í‘œì‹œ) */
      #btn-export-html {
        padding: 18px 30px !important;
        font-size: 18px !important;
        width: 85% !important;
        max-width: 100% !important;
      }
      
      /* ğŸ“± ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
      #btn-restart-pipeline {
        padding: 14px 28px !important;
        font-size: 15px !important;
        width: 75% !important;
        max-width: 100% !important;
      }
      
      /* ğŸ“± íƒ­ í¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡¤ ì™„ì „íˆ ìˆ¨ê¹€ (ê³µê°„ ì°¨ì§€ ì•ˆí•¨) */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
      
      /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ ì—¬ë°± ì œê±° (ì»´íŒ©íŠ¸í•˜ê²Œ) */
      aside.sidebar-right > div:first-of-type {
        margin-bottom: 0 !important;
      }
      
      /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì—¬ë°± ì œê±° */
      aside.sidebar-right > div:first-of-type > div {
        margin-bottom: 0 !important;
      }
      
      /* ìƒíƒœ ë©”ì‹œì§€ ì—¬ë°± ì œê±° */
      #send-status {
        margin-top: 4px !important;
        margin-bottom: 4px !important;
      }
    }
    
    /* ë°ìŠ¤í¬í†± ë° íƒœë¸”ë¦¿ ì„¸ë¡œëª¨ë“œ (900px ì´ˆê³¼) */
    @media screen and (orientation: portrait) and (min-width: 901px) {
      main { order: initial; min-width: 0; }
      aside.sidebar-left { 
        order: initial; 
        display: block; /* ì„¸ë¡œëª¨ë“œì—ì„œëŠ” ì™¼ìª½ ì‚¬ì´ë“œë°” í‘œì‹œ */
      }
      aside.sidebar-right { order: initial; }
    }
    /* ğŸ”¥ ë©”ì¸ ë ˆì´ì•„ì›ƒ: flex ê¸°ë°˜ìœ¼ë¡œ viewportë¥¼ ì •í™•íˆ 100% ì±„ì›€ (ì—¬ë°± ì—†ìŒ) */
    .layout { 
      display: flex; 
      flex-direction: row; /* ê°€ë¡œ ë°©í–¥: ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„(ì™¼ìª½) + ì‚¬ì´ë“œë°”(ì˜¤ë¥¸ìª½) */
      width: 100vw; /* viewport ë„ˆë¹„ 100% */
      height: 100vh; /* viewport ë†’ì´ 100% */
      max-width: 100vw; 
      max-height: 100vh;
      margin: 0; /* ì¤‘ì•™ ì •ë ¬ ë“± ë¶ˆí•„ìš”í•œ ì—¬ë°± ì œê±° */
      padding: 0; 
      overflow: hidden; /* í™”ë©´ ë°–ìœ¼ë¡œ ë„˜ì¹˜ëŠ” ì½˜í…ì¸  ìˆ¨ê¹€ */
      position: relative; /* ìì‹ ìš”ì†Œ ìœ„ì¹˜ ì œì–´ */
      box-sizing: border-box;
    }
    /* ğŸ”¥ ì‚¬ì´ë“œë°” ê³µí†µ ìŠ¤íƒ€ì¼ */
    aside.sidebar-left, aside.sidebar-right { 
      background: var(--sidebar-bg); 
      padding: 16px; 
      box-sizing: border-box; 
      border-right: 1px solid var(--border); 
      transition: background 0.3s; 
    }
    
    /* ì™¼ìª½ ì‚¬ì´ë“œë°” (ë°ìŠ¤í¬í†±ì—ì„œë§Œ í‘œì‹œ) */
    aside.sidebar-left { 
      width: 380px; 
      min-width: 320px; 
    }
    
    /* ğŸ”¥ ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ë°ìŠ¤í¬í†±) */
    aside.sidebar-right { 
      flex: 0 0 auto; 
      width: var(--sidebar-width, 400px); 
      min-width: 250px;
      max-width: 800px;
      margin: 0;
      border-right: none; 
      border-left: 1px solid var(--border); 
      overflow-y: auto; 
      overflow-x: hidden; 
      overscroll-behavior: contain; 
      -webkit-overflow-scrolling: touch; 
      height: 100vh; 
      position: relative; 
      transition: width 0.2s ease;
      box-sizing: border-box;
      order: 2; /* flex order: ì˜¤ë¥¸ìª½ì— ìœ„ì¹˜ */
      display: flex;
      flex-direction: column;
    }

    /* â–¼ ì¶”ê°€: ì‹¤í–‰ì¤‘ í•˜ì´ë¼ì´íŠ¸(íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ í™œì„± ì‹œ íƒ­ ê°•ì¡°) */
    aside.sidebar-right .agent-card.running {
      outline: 2px solid var(--accent, #4FC3F7);
      box-shadow: 0 0 10px rgba(79,195,247,.7);
      transition: box-shadow .2s ease, outline-color .2s ease;
    }

    /* (ì°¸ê³ ) activeì™€ runningì„ ë³‘í–‰ ì‚¬ìš©í•  ê²½ìš° ì‹œê° ê²¹ì¹¨ ë°©ì§€ */
    aside.sidebar-right .agent-card.active.running {
      outline-width: 3px;
    }

    /* â–¼ ìš°ì¸¡ íŒ¨ë„ "ë‹¨ë… í‘œì‹œ" ëª¨ë“œ: ì‹¤í–‰ì¤‘ ì¹´ë“œë§Œ ë³´ì´ê¸° */
    .right-tab-panel.solo-mode .agent-card { 
      display: none !important;
    }
    .right-tab-panel.solo-mode .agent-card.running { 
      display: block !important;
    }



    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤/ìƒíƒœ/ì„ íƒ ì •ë³´ ë“±ì€ ê³„ì† í‘œì‹œ */
    .right-tab-panel.solo-mode .agent-controls,
    .right-tab-panel.solo-mode #send-status,
    .right-tab-panel.solo-mode [data-keep-visible="true"] {
      display: revert !important;
    }

    /* âœ… ì™„ë£Œ í›„ ì „ì²´ ì „ê°œ(show-all) ìƒíƒœì—ì„œëŠ” solo-mode ê°•ì œ ìˆ¨ê¹€ì„ ë¬´ì‹œ */
    .right-tab-panel.show-all .agent-card {
      display: block !important;
    }

    /* GPT2 Worst ëª¨ë“œê°€ í™œì„±í™”ë˜ë©´ ëª¨ë“  ë‹¤ë¥¸ ëª¨ë“œë³´ë‹¤ ìš°ì„  */
    .right-tab-panel.gpt2worst-mode .agent-card {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    .right-tab-panel.gpt2worst-mode .agent-card.gpt2worst-visible {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* GPT2 Worst ëª¨ë“œì—ì„œ show-all, solo-mode ë“± ëª¨ë“  ë‹¤ë¥¸ í´ë˜ìŠ¤ ë¬´ì‹œ */
    .right-tab-panel.gpt2worst-mode.show-all .agent-card:not(.gpt2worst-visible),
    .right-tab-panel.gpt2worst-mode.solo-mode .agent-card:not(.gpt2worst-visible) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* GPT1, GPT2 ì¹´ë“œ ê¹œë°•ì„ íš¨ê³¼ */
    @keyframes cardBlink {
      0%, 100% { 
        opacity: 1; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid transparent;
      }
      50% { 
        opacity: 0.8; 
        box-shadow: 0 4px 16px rgba(122, 183, 255, 0.3);
        border: 2px solid var(--accent);
      }
    }

    .agent-card.card-blink {
      animation: cardBlink 1.5s ease-in-out infinite;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }

    /* íŒŒë€ìƒ‰ í…Œë‘ë¦¬ í„ìŠ¤ íš¨ê³¼ */
    @keyframes borderPulse {
      0%, 100% {
        border: 2px solid transparent;
        box-shadow: 0 0 0 0 rgba(122, 183, 255, 0.7);
      }
      50% {
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 8px rgba(122, 183, 255, 0.3);
      }
    }

    .agent-card.border-pulse {
      animation: borderPulse 2s ease-in-out infinite;
      border-radius: 8px;
    }

    /* ê°•í•œ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ ê¸€ë¡œìš° íš¨ê³¼ */
    @keyframes borderGlow {
      0%, 100% {
        border: 3px solid transparent;
        box-shadow: 
          0 0 0 0 rgba(122, 183, 255, 0),
          inset 0 0 0 0 rgba(122, 183, 255, 0);
      }
      50% {
        border: 3px solid var(--accent);
        box-shadow: 
          0 0 20px rgba(122, 183, 255, 0.6),
          inset 0 0 10px rgba(122, 183, 255, 0.1);
      }
    }

    .agent-card.border-glow {
      animation: borderGlow 1.5s ease-in-out infinite;
      border-radius: 8px;
      position: relative;
    }

    /* í…Œë‘ë¦¬ ê·¸ë¼ë°ì´ì…˜ íš¨ê³¼ */
    @keyframes borderGradient {
      0% {
        border-image: linear-gradient(45deg, transparent, var(--accent), transparent) 1;
        border-width: 3px;
      }
      50% {
        border-image: linear-gradient(45deg, var(--accent), transparent, var(--accent)) 1;
        border-width: 3px;
      }
      100% {
        border-image: linear-gradient(45deg, transparent, var(--accent), transparent) 1;
        border-width: 3px;
      }
    }

    .agent-card.border-gradient {
      animation: borderGradient 3s ease-in-out infinite;
      border-radius: 8px;
    }

    /* GPT2 ì¹´ë“œ ì „í™˜ íš¨ê³¼ */
    @keyframes gpt2Transition {
      0% {
        opacity: 1;
        border: 3px solid transparent;
      }
      25% {
        opacity: 0.9;
        border: 3px solid var(--accent);
      }
      50% {
        opacity: 1;
        border: 3px solid var(--accent);
        box-shadow: 0 0 30px rgba(122, 183, 255, 0.8);
      }
      75% {
        opacity: 0.9;
        border: 3px solid var(--accent);
      }
      100% {
        opacity: 1;
        border: 3px solid transparent;
      }
    }

    .agent-card.gpt2-transition {
      animation: gpt2Transition 2s ease-in-out;
      border-radius: 8px;
    }

    /* ê¸€ì”¨ íƒ€ì´í•‘ íš¨ê³¼ */
    @keyframes typewriter {
      from { width: 0; }
      to { width: 100%; }
    }

    .typewriter-text {
      overflow: hidden;
      white-space: nowrap;
      animation: typewriter 2s steps(40, end);
      border-right: 2px solid var(--accent);
    }

    /* ê¸€ì”¨ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
    @keyframes textHighlight {
      0% { 
        background: linear-gradient(90deg, transparent, rgba(122, 183, 255, 0.2), transparent);
        background-size: 200% 100%;
        background-position: -200% 0;
      }
      100% { 
        background: linear-gradient(90deg, transparent, rgba(122, 183, 255, 0.2), transparent);
        background-size: 200% 100%;
        background-position: 200% 0;
      }
    }

    .text-highlight {
      animation: textHighlight 2s ease-in-out infinite;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* âœ… ì™„ë£Œ í›„ ì˜¤ë²„ë ˆì´/ë¸”ë§í¬ ê°•ì œ ì œê±°(í˜¹ì‹œ ë‚¨ì•„ìˆì„ ê²½ìš° ì‹œê° ë®ì„ ë°©ì§€) */
    .right-tab-panel.show-all .execution-overlay,
    .pipeline-complete .execution-overlay,
    .pipeline-complete .bordered-blinking,
    .pipeline-complete .bordered-blinking-edge {
      display: none !important;
    }

    /* íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ ëª¨ë“  ì‹¤í–‰ ì¤‘ íš¨ê³¼ ê°•ì œ ì¢…ë£Œ */
    body.pipeline-complete .gpt3-module-box.running,
    body.pipeline-complete .gpt0-module-box.running,
    body.pipeline-complete .gpt1-module-box.running,
    body.pipeline-complete .gpt2-module-box.running,
    body.pipeline-complete .gpt4-module-box.running {
      animation: none !important;
      border-color: #2fc06e !important;
      box-shadow: 0 0 0 2px rgba(47, 192, 110, 0.25) !important;
    }

    /* íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ ì‹¤í–‰ ì¤‘ ì˜¤ë²„ë ˆì´ ê°•ì œ ì œê±° */
    body.pipeline-complete .execution-overlay {
      display: none !important;
    }

    /* íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ ì§„í–‰ í‘œì‹œ íš¨ê³¼ ê°•ì œ ì œê±° */
    body.pipeline-complete .progress-indicator {
      animation: none !important;
    }

    /* íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ GPT3 ëª¨ë“ˆ ë°•ìŠ¤ ì‹¤í–‰ ì¤‘ íš¨ê³¼ ì™„ì „ ì œê±° */
    body.pipeline-complete .gpt3-module-box {
      animation: none !important;
    }

    body.pipeline-complete .gpt3-module-box::before {
      animation: none !important;
      opacity: 1 !important;
      background: linear-gradient(90deg, #2fc06e, #27ae60) !important;
    }

    /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ ê²¹ì¹¨/í´ë¦¬í•‘ ë°©ì§€ ë³´ê°• */
    .agent-card {
      position: relative;
      z-index: 0;
      margin-bottom: 12px;
      overflow: visible;        /* â† ë‚´ë¶€ ìš”ì†Œê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
      isolation: isolate;       /* â† ê° ì¹´ë“œë³„ ìŠ¤íƒ ì»¨í…ìŠ¤íŠ¸ ë¶„ë¦¬ë¡œ ì‹œê° ê²¹ì¹¨ ë°©ì§€ */
    }
    .agent-card + .agent-card {
      margin-top: 12px;
    }

    /* ì™„ë£Œ í›„(show-all)ì—ëŠ” ì–´ë–¤ ìˆ¨ê¹€ ê·œì¹™ë³´ë‹¤ ìš°ì„  í‘œì‹œ ë³´ì¥ */
    #gpt1-panel.show-all .agent-card,
    .right-tab-panel.show-all .agent-card { display: block !important; }

    /* âœ… ì•µì»¤ ìì²´ëŠ” ë ˆì´ì•„ì›ƒ ì˜í–¥ ì œê±° */
    .gpt3-anchor, .gpt4-anchor {
      display: block;
      height: 0;
      margin: 0;
      padding: 0;
    }

    /* íƒ­ í¬ê¸°ì— ë”°ë¥¸ ë°˜ì‘í˜• í…ìŠ¤íŠ¸ í¬ê¸° */
    @media (min-width: 500px) {
      aside.sidebar-right h4 { font-size: 16px; }
      aside.sidebar-right .agent-card { padding: 16px; }
      aside.sidebar-right textarea { font-size: 14px; }
      aside.sidebar-right .copy-btn { font-size: 12px; padding: 6px 10px; }
      aside.sidebar-right .action-btn { font-size: 14px; padding: 10px 16px; }
      aside.sidebar-right .prompt-text { font-size: 13px; }
    }

    @media (min-width: 600px) {
      aside.sidebar-right h4 { font-size: 18px; }
      aside.sidebar-right .agent-card { padding: 18px; }
      aside.sidebar-right textarea { font-size: 16px; }
      aside.sidebar-right .copy-btn { font-size: 13px; padding: 7px 12px; }
      aside.sidebar-right .action-btn { font-size: 15px; padding: 12px 18px; }
      aside.sidebar-right .prompt-text { font-size: 14px; }
    }

    @media (min-width: 700px) {
      aside.sidebar-right h4 { font-size: 20px; }
      aside.sidebar-right .agent-card { padding: 20px; }
      aside.sidebar-right textarea { font-size: 18px; }
      aside.sidebar-right .copy-btn { font-size: 14px; padding: 8px 14px; }
      aside.sidebar-right .action-btn { font-size: 16px; padding: 14px 20px; }
      aside.sidebar-right .prompt-text { font-size: 15px; }
    }

    /* ğŸ”¥ ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ (600px ì´í•˜): 7:3 ë¹„ìœ¨ (ë©”ì¸ 70% / ì‚¬ì´ë“œë°” 30%) */
    @media screen and (orientation: landscape) and (max-width: 900px) and (max-height: 600px) {
      :root {
        --sidebar-width: 30vw; /* ì‚¬ì´ë“œë°” 30% ê³ ì • */
      }
      
      /* ë ˆì´ì•„ì›ƒ: viewportë¥¼ ì •í™•íˆ 100% ì±„ì›€ (ì—¬ë°± 0) */
      .layout {
        flex-direction: row !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        position: fixed !important; /* í™”ë©´ ê³ ì •ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨ */
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* ì™¼ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */
      aside.sidebar-left { 
        display: none !important;
      }
      
      /* ğŸ”¥ ë©”ì¸ ì˜ì—­: 70vw ê³ ì • (7:3 ë¹„ìœ¨ì˜ 7) */
      main {
        order: 1 !important;
        flex: 0 0 70vw !important; /* flex-shrink: 0, flex-basis: 70vw (ê³ ì •) */
        width: 70vw !important; /* ì „ì²´ ë„ˆë¹„ì˜ 70% */
        max-width: 70vw !important;
        min-width: 0 !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ğŸ”¥ ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”: 30vw ê³ ì • (7:3 ë¹„ìœ¨ì˜ 3) */
      aside.sidebar-right {
        order: 2 !important;
        flex: 0 0 30vw !important; /* flex-shrink: 0, flex-basis: 30vw (ê³ ì •) */
        width: 30vw !important; /* ì „ì²´ ë„ˆë¹„ì˜ 30% */
        max-width: 30vw !important;
        min-width: 0 !important; /* ì ˆëŒ€ í¬ê¸°(px) ì œê±° */
        height: 100vh !important;
        margin: 0 !important;
        padding: 8px 12px !important;
        transform: translateX(0) !important;
        position: relative !important;
        z-index: 10 !important;
        display: flex !important;
        visibility: visible !important;
        border-left: 1px solid var(--border) !important;
        border-top: none !important;
        border-right: none !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ê°€ë¡œëª¨ë“œì—ì„œë„ íŒ¨ë„ ìˆ¨ê¹€/í‘œì‹œ ì •ìƒ ì‘ë™ */
      aside.sidebar-right.hidden {
        transform: translateX(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
      }
      
      /* íƒ­ ë‚´ë¶€ íŒ¨ë”© ì¡°ì • */
      aside.sidebar-right { 
        padding: 8px 12px !important;
        box-sizing: border-box;
      }
      
      /* ë²„íŠ¼ê³¼ ì»¨íŠ¸ë¡¤ í¬ê¸° ì¡°ì • */
      .darkmode-toggle, .size-control-btn { 
        padding: 4px 8px; 
        font-size: 12px; 
        min-height: 32px; /* í„°ì¹˜í•˜ê¸° ì ë‹¹í•œ ë†’ì´ */
      }
      
      /* í°íŠ¸ í¬ê¸° ì¡°ì • */
      aside.sidebar-right h4 { font-size: 14px; margin: 8px 0; }
      aside.sidebar-right .agent-card { padding: 8px; margin-bottom: 8px; }
      aside.sidebar-right textarea { font-size: 12px; min-height: 60px; }
      aside.sidebar-right .copy-btn { font-size: 10px; padding: 4px 6px; }
      aside.sidebar-right .action-btn { font-size: 12px; padding: 6px 10px; }
      aside.sidebar-right .prompt-text { font-size: 11px; line-height: 1.3; }
      
      /* ğŸ”¥ ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„: ì—¬ë°± ì™„ì „ ì œê±°, ë¶€ëª¨ë¥¼ 100% ì±„ì›€ */
      #network-graph { 
        margin: 0 !important; /* ì—¬ë°± ì™„ì „ ì œê±° */
        padding: 0 !important;
        width: 100% !important; /* ë¶€ëª¨(main)ì˜ ë„ˆë¹„ 100% */
        height: 100% !important; /* ë¶€ëª¨(main)ì˜ ë†’ì´ 100% */
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important; /* border-radius ì œê±°ë¡œ ê³µê°„ ì ˆì•½ */
        box-shadow: none !important; /* ê·¸ë¦¼ì ì œê±° */
      }
      
      /* ğŸ”¥ ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ë‚´ë¶€ SVG: transform ì œê±°, 100% ì±„ì›€ */
      #network-graph svg {
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        max-height: none !important;
        transform: none !important; /* transform scale ì œê±° */
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* ğŸ”¥ ìƒë‹¨ë°”: íŒ¨ë”© ìµœì†Œí™”ë¡œ ê³µê°„ ì ˆì•½ */
      .topbar { 
        padding: 2px 6px !important;
        gap: 4px !important;
        min-height: 30px !important;
      }
      
      /* ğŸ”¥ ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ: ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ ë†’ì´ 60%ë¡œ ì¶•ì†Œ */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 9px 15px !important; /* 15px * 0.6 = 9px */
        font-size: 14px !important; /* ì‘ê²Œ ì¡°ì • */
        height: auto !important;
        min-height: 36px !important; /* í„°ì¹˜ ì˜ì—­ í™•ë³´ */
        line-height: 1.2 !important;
      }
      
      /* ğŸ”¥ íƒ­ í¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡¤ ì™„ì „íˆ ìˆ¨ê¹€ (ê°€ë¡œëª¨ë“œ) */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
      
      /* ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œ ëª¨ë°”ì¼ ìµœì í™” */
      .scenario-node {
        stroke-width: 2px !important;
      }
      
      .scenario-group text {
        font-size: 14px !important;
        font-weight: 600 !important;
      }
      
      .keyword-node rect {
        stroke-width: 1.5px !important;
      }
      
      .keyword-node text {
        font-size: 11px !important;
        font-weight: 500 !important;
      }
      
      /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ ì••ì¶• */
      .topbar { padding: 6px 12px; }
      
      /* íƒ­ í¬ê¸° ì»¨íŠ¸ë¡¤ ì˜ì—­ ì¡°ì • */
      #tab-size-display { font-size: 12px; min-width: 50px; }
      
      /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (ëª¨ë°”ì¼ì—ì„œ ë” ì–‡ê²Œ) */
      aside.sidebar-right::-webkit-scrollbar { width: 6px; }
      aside.sidebar-right::-webkit-scrollbar-track { background: transparent; }
      aside.sidebar-right::-webkit-scrollbar-thumb { 
        background: rgba(0,0,0,0.2); 
        border-radius: 3px; 
      }
    }

    /* ğŸ”¥ ë§¤ìš° ì‘ì€ í™”ë©´ ê°€ë¡œëª¨ë“œ (500px ì´í•˜): 7:3 ë¹„ìœ¨ ìœ ì§€ (ë©”ì¸ 70% / ì‚¬ì´ë“œë°” 30%) */
    @media screen and (orientation: landscape) and (max-width: 900px) and (max-height: 500px) {
      :root {
        --sidebar-width: 30vw; /* ì‚¬ì´ë“œë°” 30% ê³ ì • (7:3 ë¹„ìœ¨) */
      }
      
      /* ğŸ”¥ ë©”ì¸ ì˜ì—­: 70vw ê³ ì • (7:3 ë¹„ìœ¨ì˜ 7) */
      main {
        flex: 0 0 70vw !important; /* flex-shrink: 0, flex-basis: 70vw (ê³ ì •) */
        width: 70vw !important; /* ì „ì²´ ë„ˆë¹„ì˜ 70% */
        max-width: 70vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ğŸ”¥ ì‚¬ì´ë“œë°”: 30vw ê³ ì • (7:3 ë¹„ìœ¨ì˜ 3) */
      aside.sidebar-right { 
        flex: 0 0 30vw !important; /* flex-shrink: 0, flex-basis: 30vw (ê³ ì •) */
        width: 30vw !important; /* ì „ì²´ ë„ˆë¹„ì˜ 30% */
        max-width: 30vw !important;
        min-width: 0 !important; /* ì ˆëŒ€ í¬ê¸°(px) ì œê±° */
        padding: 4px 6px !important;
        margin: 0 !important;
        height: 100vh !important;
        box-sizing: border-box !important;
      }
      
      /* ë” ì‘ì€ í°íŠ¸ì™€ ê°„ê²© */
      aside.sidebar-right h4 { font-size: 12px; margin: 6px 0; }
      aside.sidebar-right .agent-card { padding: 6px; margin-bottom: 6px; }
      aside.sidebar-right textarea { font-size: 11px; min-height: 50px; }
      .darkmode-toggle, .size-control-btn { 
        padding: 3px 6px; 
        font-size: 11px; 
        min-height: 28px; 
      }
      
      /* ë¦¬ìŠ¤íŠ¸ì™€ í…ìŠ¤íŠ¸ ê°„ê²© ì¤„ì„ */
      #selected-indicators-list { font-size: 10px; margin: 0; padding-left: 12px; }
      .prompt-text { font-size: 10px; line-height: 1.2; }
      
      /* ë²„íŠ¼ ê·¸ë£¹ ê°„ê²© ì¤„ì„ */
      div[style*="display:flex"] { gap: 4px !important; }
      
      /* ğŸ”¥ ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„: ì—¬ë°± ì™„ì „ ì œê±° */
      #network-graph { 
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
      }
      
      /* ğŸ”¥ ìƒë‹¨ë°”: íŒ¨ë”© ìµœì†Œí™” */
      .topbar { 
        padding: 2px 4px !important;
        gap: 3px !important;
        min-height: 26px !important;
      }
      
      /* ğŸ”¥ ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ (ì‘ì€ í™”ë©´): ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ ë†’ì´ 60%ë¡œ ì¶•ì†Œ */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 8px 12px !important; /* ë” ì‘ê²Œ */
        font-size: 13px !important;
        height: auto !important;
        min-height: 32px !important;
        line-height: 1.2 !important;
      }
      
      /* ğŸ”¥ íƒ­ í¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡¤ ì™„ì „íˆ ìˆ¨ê¹€ */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
      
      /* ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œ ì‘ì€ í™”ë©´ ìµœì í™” */
      .scenario-node {
        stroke-width: 2.5px !important;
      }
      
      .scenario-group text {
        font-size: 13px !important;
        font-weight: 700 !important;
      }
      
      .keyword-node rect {
        stroke-width: 2px !important;
      }
      
      .keyword-node text {
        font-size: 10px !important;
        font-weight: 600 !important;
      }
      
      /* í„°ì¹˜ ìµœì í™” - ëª¨ë“  í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œì— ì¶©ë¶„í•œ í„°ì¹˜ ì˜ì—­ í™•ë³´ */
      button, select, input, textarea { 
        min-height: 28px; 
        touch-action: manipulation; /* ë”ë¸”íƒ­ ì¤Œ ë°©ì§€ */
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ í–¥ìƒ */
      aside.sidebar-right { 
        -webkit-overflow-scrolling: touch; 
        scroll-behavior: smooth; 
        touch-action: pan-y; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ë§Œ í—ˆìš© */
      }
      
      /* í…ìŠ¤íŠ¸ ì„ íƒ ìµœì í™” */
      .prompt-text, textarea { 
        -webkit-user-select: text; 
        user-select: text; 
      }
      
      /* ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì„ í† ê¸€ì„ ìœ„í•œ ëª¨ë°”ì¼ ìµœì í™” */
      .sidebar-hidden aside.sidebar-right { 
        transform: translateX(100%); 
        transition: transform 0.3s ease; 
      }
      
      .sidebar-hidden main { 
        margin-right: 0; 
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ì˜¤ë²„í”Œë¡œìš° ìŠ¤í¬ë¡¤ ê°œì„  */
      aside.sidebar-right { 
        overflow-x: hidden; 
        overflow-y: auto; 
        overscroll-behavior-y: contain; /* ìŠ¤í¬ë¡¤ ë°”ìš´ìŠ¤ ë°©ì§€ */
      }
    }

    /* ğŸ”¥ í° í™”ë©´ ê°€ë¡œëª¨ë“œ (íƒœë¸”ë¦¿, 900px ì´ìƒ): 7:3 ë¹„ìœ¨ (ë©”ì¸ 70% / ì‚¬ì´ë“œë°” 30%) */
    @media screen and (orientation: landscape) and (min-width: 900px) and (max-height: 600px) {
      :root {
        --sidebar-width: 30vw; /* ì‚¬ì´ë“œë°” 30% ê³ ì • (7:3 ë¹„ìœ¨) */
      }
      
      /* ë ˆì´ì•„ì›ƒ: viewportë¥¼ 100% ì±„ì›€ */
      .layout {
        flex-direction: row !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
      }
      
      /* ì™¼ìª½ ì‚¬ì´ë“œë°” ìˆ¨ê¹€ */
      aside.sidebar-left { 
        display: none !important;
      }
      
      /* ğŸ”¥ ë©”ì¸ ì˜ì—­: 70vw ê³ ì • (7:3 ë¹„ìœ¨ì˜ 7) */
      main {
        order: 1 !important;
        flex: 0 0 70vw !important; /* flex-shrink: 0, flex-basis: 70vw (ê³ ì •) */
        width: 70vw !important; /* ì „ì²´ ë„ˆë¹„ì˜ 70% */
        max-width: 70vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ğŸ”¥ ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”: 30vw ê³ ì • (7:3 ë¹„ìœ¨ì˜ 3) */
      aside.sidebar-right {
        order: 2 !important;
        flex: 0 0 30vw !important; /* flex-shrink: 0, flex-basis: 30vw (ê³ ì •) */
        width: 30vw !important; /* ì „ì²´ ë„ˆë¹„ì˜ 30% */
        max-width: 30vw !important;
        min-width: 0 !important; /* ì ˆëŒ€ í¬ê¸°(px) ì œê±° */
        height: 100vh !important;
        margin: 0 !important;
        padding: 12px 16px !important;
        transform: translateX(0) !important;
        position: relative !important;
        z-index: 10 !important;
        display: flex !important;
        visibility: visible !important;
        border-left: 1px solid var(--border) !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* íŒ¨ë„ ìˆ¨ê¹€ ìƒíƒœ */
      aside.sidebar-right.hidden {
        transform: translateX(100%) !important;
        pointer-events: none !important;
      }
      
      /* íƒœë¸”ë¦¿ì—ì„œëŠ” í°íŠ¸ë¥¼ ì¡°ê¸ˆ ë” í¬ê²Œ */
      aside.sidebar-right h4 { font-size: 16px; }
      aside.sidebar-right .agent-card { padding: 12px; }
      aside.sidebar-right textarea { font-size: 14px; }
      .darkmode-toggle, .size-control-btn { 
        padding: 6px 12px; 
        font-size: 13px; 
        min-height: 36px; 
      }
      
      /* ğŸ”¥ íƒœë¸”ë¦¿ ê°€ë¡œëª¨ë“œ: ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 10px 18px !important;
        font-size: 15px !important;
        min-height: 40px !important;
        line-height: 1.2 !important;
      }
      
      /* ğŸ”¥ íƒ­ í¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡¤ ìˆ¨ê¹€ */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
    }

    /* +/- ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
    .size-control-btn {
      background: var(--size-btn-bg);
      color: white;
      border: 2px solid var(--size-btn-bg);
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .size-control-btn:hover {
      background: var(--size-btn-hover);
      border-color: var(--size-btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .size-control-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .size-display {
      background: var(--size-display-bg);
      border: 1px solid var(--accent);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: 'Courier New', monospace;
    }
    
    /* ğŸ”¥ ë³µì‚¬ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë‹¤í¬ëª¨ë“œ ì˜í–¥ ë°›ì§€ ì•ŠìŒ) */
    .copy-btn {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      padding: 4px 8px;
      font-size: 11px;
    }
    
    .copy-btn:hover {
      background: linear-gradient(135deg, #357abd, #2c5d9f);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(74,144,226,0.3);
    }
    
    .copy-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(74,144,226,0.2);
    }
    
    /* ğŸ”¥ ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë°ìŠ¤í¬í†±) */
    #top-pipeline-btn,
    .analysis-start-btn {
      padding: 15px 25px;
      font-size: 16px;
    }
    /* ğŸ”¥ ë©”ì¸ ì˜ì—­: ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ flex: 1 ì„¤ì • (ì—¬ë°± 0) */
    main { 
      flex: 1 1 0; /* flex-grow: 1, flex-shrink: 1, flex-basis: 0 - ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
      display: flex; 
      flex-direction: column; 
      background: var(--main-bg); 
      min-width: 0; /* flex ì•„ì´í…œì´ ì»¨í…ì¸  í¬ê¸°ë³´ë‹¤ ì‘ì•„ì§ˆ ìˆ˜ ìˆë„ë¡ */
      overflow: hidden; 
      order: 1; /* flex order: ë©”ì¸ì´ ë¨¼ì € */
      margin: 0; /* ì—¬ë°± ì™„ì „ ì œê±° */
      padding: 0;
      height: 100%; /* ë¶€ëª¨(.layout)ì˜ ë†’ì´ 100% ì‚¬ìš© */
      box-sizing: border-box;
    }
    
    .topbar { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 6px 12px; 
      border-bottom: 1px solid var(--border); 
      background: var(--sidebar-bg); 
      flex-shrink: 0; /* topbarëŠ” ê³ ì • ë†’ì´ ìœ ì§€ */
    }
    .topbar select { margin-left: 12px; }
    .darkmode-toggle { background: none; color: var(--accent); border: 1px solid var(--accent); border-radius: 4px; padding: 6px 14px; cursor: pointer; }
    
    /* ğŸ”¥ ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ: ë¶€ëª¨(main)ë¥¼ ì™„ì „íˆ ì±„ì›€ (ì—¬ë°± ìµœì†Œí™”) */
    #network-graph { 
      flex: 1 1 0; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
      background: var(--main-bg); 
      border-radius: 0; /* ëª¨ë°”ì¼ì—ì„œ border-radius ì œê±°ë¡œ ê³µê°„ ì ˆì•½ */
      margin: 0; /* ì—¬ë°± ì™„ì „ ì œê±° */
      padding: 0;
      box-shadow: none; /* ê·¸ë¦¼ì ì œê±°ë¡œ ê³µê°„ ì ˆì•½ */
      position: relative; 
      overflow: hidden; 
      width: 100%; /* ë¶€ëª¨ì˜ ë„ˆë¹„ 100% */
      height: 100%; /* ë¶€ëª¨ì˜ ë†’ì´ 100% */
      max-width: none; /* ìµœëŒ€ í¬ê¸° ì œí•œ ì œê±° */
      max-height: none;
      box-sizing: border-box;
    }
    
    /* ğŸ”¥ ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ë‚´ë¶€ SVG: ì»¨í…Œì´ë„ˆë¥¼ ì™„ì „íˆ ì±„ì›€ */
    #network-graph svg {
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    /* ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ í˜¸ë²„ íš¨ê³¼ */
    .scenario-node {
      transition: all 0.3s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    .scenario-node:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2));
    }
    
    /* ì‹œë‚˜ë¦¬ì˜¤ë‚´ìš© ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
    .scenario-doc-btn rect {
      transition: all 0.2s ease;
    }
    .scenario-doc-btn:hover rect {
      opacity: 1 !important;
      filter: brightness(1.1);
    }

    /* ğŸ“± ëª¨ë°”ì¼ ì´ˆê¸° ëª¨ë“œ: GPT0ë§Œ í‘œì‹œ (ì„¸ë¡œ/ê°€ë¡œ ê³µí†µ) */
    @media screen and (max-width: 900px) {
      aside.sidebar-right.mobile-initial-mode .agent-card {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      
      aside.sidebar-right.mobile-initial-mode .agent-card#card-gpt0 {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* ë¶„ì„ ì‹œì‘ í›„ ëª¨ë“  ì¹´ë“œ í‘œì‹œ */
      aside.sidebar-right.show-all .agent-card {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* ì„¸ë¡œ ëª¨ë“œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
      @media (orientation: portrait) {
        /* íƒ­ì´ ì•„ë˜ìª½ì— ìˆì„ ë•Œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        aside.sidebar-right::-webkit-scrollbar { 
          width: 4px; 
          height: 4px; 
        }
        aside.sidebar-right::-webkit-scrollbar-thumb { 
          background: rgba(0,0,0,0.3); 
          border-radius: 2px; 
        }
      }
      
      /* ê°€ë¡œ ëª¨ë“œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
      @media (orientation: landscape) {
        /* íƒ­ì´ ì˜¤ë¥¸ìª½ì— ìˆì„ ë•Œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        aside.sidebar-right::-webkit-scrollbar { 
          width: 6px; 
        }
        aside.sidebar-right::-webkit-scrollbar-thumb { 
          background: rgba(0,0,0,0.3); 
          border-radius: 3px; 
        }
      }
    }
      /* í‚¤ì›Œë“œ ë…¸ë“œ ìŠ¤íƒ€ì¼ */
      .keyword-node rect { fill: #3a3d44; stroke: #c3c8d0; stroke-width: 1.6; rx: 9; ry: 9; }
      .keyword-node:hover rect { filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); }
      .keyword-node rect:hover { filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); }
      /* Phase ê¹œë°•ì„ íš¨ê³¼ (ë°•ìŠ¤ ë‚´ë¶€ë„ ê°•ì¡°) */
      .keyword-node.kw-blink-yellow rect { stroke: #FFD54F; animation: kwBlinkYellow 1.4s ease-in-out infinite; }
      .keyword-node.kw-blink-yellow text { fill: #FFE082; }
      .keyword-node.kw-blink-red rect { stroke: #E53935; animation: kwBlinkRed 1.4s ease-in-out infinite; }
      .keyword-node.kw-blink-red text { fill: #FF8A80; }
      @keyframes kwBlinkYellow { 0%, 100% { filter: drop-shadow(0 0 0 rgba(255, 235, 59, 0)); fill: #3a3d44; } 50% { filter: drop-shadow(0 0 10px rgba(255, 235, 59, 0.95)); fill: rgba(255, 235, 59, 0.18); } }
      @keyframes kwBlinkRed { 0%, 100% { filter: drop-shadow(0 0 0 rgba(229, 57, 53, 0)); fill: #3a3d44; } 50% { filter: drop-shadow(0 0 10px rgba(229, 57, 53, 0.95)); fill: rgba(229, 57, 53, 0.18); } }
      .keyword-node text { fill: var(--main-text); font-size: 13px; pointer-events: none; text-anchor: middle; dominant-baseline: middle; }
      /* í‚¤ì›Œë“œ ì—°ê²°ì„  ì• ë‹ˆë©”ì´ì…˜ (ì ì„  ì´ë™ íš¨ê³¼) */
      .kw-animated { stroke-dasharray: 6 6; animation: kw-dash-move 2.5s linear infinite; }
      @keyframes kw-dash-move { to { stroke-dashoffset: -60; } }
    
    /* ì—°ê²°ì„  í˜¸ë²„ íš¨ê³¼ */
    .connection-line {
      transition: all 0.2s ease;
    }
    .connection-line:hover {
      stroke-width: 12 !important;
      stroke-opacity: 1 !important;
    }
    
    /* PDF ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .pdf-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .pdf-modal.show {
      display: flex;
    }
    
    .pdf-container {
      width: 90%;
      height: 90%;
      max-width: 1200px;
      max-height: 800px;
      background: var(--main-bg);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      transform: scale(0.7) translateY(50px);
      animation: modalSlideIn 0.4s ease forwards;
    }
    /* ë‰´ìŠ¤ ëª¨ë‹¬ì€ 80% ë¹„ìœ¨ ì ìš© */
    #news-modal .pdf-container { width: 80%; height: 80%; }
    
    .pdf-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--sidebar-bg);
      border-radius: 12px 12px 0 0;
    }
    
    .pdf-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--main-text);
    }
    
    .pdf-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--main-text);
      padding: 5px 10px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .pdf-close:hover {
      background: var(--border);
    }
    
    .pdf-frame {
      width: 100%;
      height: calc(100% - 80px);
      border: none;
      border-radius: 0 0 12px 12px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes modalSlideIn {
      to {
        transform: scale(1) translateY(0);
      }
    }
    /* í‚¤ì›Œë“œ íˆ´íŒ */
    .kw-tooltip {
      position: fixed;
      z-index: 2000;
      background: rgba(32, 32, 32, 0.95);
      color: #fff;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 6px;
      pointer-events: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      max-width: 420px;
      line-height: 1.4;
      display: none;
    }
    .indicator-cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      justify-items: center;
      align-content: center;
      min-height: 60vh;
    }
    .indicator-card {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      margin: 8px auto;
    }
    .indicator-card.selected, .indicator-card:hover {
      border: 2px solid var(--accent);
      transform: scale(1.2);
      box-shadow: 0 2px 8px rgba(74,144,226,0.3);
    }
    .indicator-tooltip {
      position: absolute;
      bottom: 35px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--main-text);
      color: var(--main-bg);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    .indicator-card:hover .indicator-tooltip {
      opacity: 1;
    }
    .impact-box {
      width: 120px;
      height: 60px;
      padding: 10px 0;
      text-align: center;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: border 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .impact-box.selected {
      border: 2px solid var(--accent);
    }
    @media (max-width: 1024px) { .layout { flex-direction: column; } aside.sidebar-left, aside.sidebar-right { width: 100%; border: none; } main { min-width: 100vw; } .topbar { flex-direction: column; align-items: stretch; } }
    @media (max-width: 700px) { .layout { flex-direction: column; } aside.sidebar-left, aside.sidebar-right { width: 100%; } #network-graph { min-height: 250px; } }

    /* ì—ì´ì „íŠ¸ ì¹´ë“œ & í”„ë¡¬í”„íŠ¸ ì œì•ˆ ìŠ¤íƒ€ì¼ - í†µì¼ëœ ë””ìì¸ */
    .agent-card { 
      border: 2px solid var(--border); 
      border-radius: 12px; 
      padding: 16px; 
      margin-bottom: 16px; 
      transition: all 0.3s ease; 
      background: var(--main-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      overflow: visible;
    }
    
    /* ì¹´ë“œ ìƒë‹¨ ê·¸ë¼ë°ì´ì…˜ ë°” */
    .agent-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .agent-card.active { 
      border-color: var(--accent); 
      box-shadow: 0 8px 32px rgba(74,144,226,0.2), 0 0 0 1px rgba(74,144,226,0.1); 
      transform: translateY(-2px);
    }
    .agent-card.active::before {
      opacity: 1;
    }
    
    .agent-card h4 { 
      margin: 0 0 12px 0; 
      font-size: 16px; 
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ì¹´ë“œ ì§„í–‰ ìƒíƒœ íš¨ê³¼ - í†µì¼ëœ ìŠ¤íƒ€ì¼ */
    .agent-card.running { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(122,183,255,0.2), 0 8px 32px rgba(122,183,255,0.15); 
      animation: borderPulseBlue 1.5s ease-in-out infinite;
      transform: translateY(-1px);
    }
    .agent-card.running::before {
      opacity: 1;
      animation: topBarPulse 1.5s ease-in-out infinite;
    }
    
    .agent-card.done { 
      border-color: #2fc06e; 
      box-shadow: 0 0 0 3px rgba(47,192,110,0.2), 0 8px 32px rgba(47,192,110,0.15); 
      transform: translateY(-1px);
    }
    .agent-card.done::before {
      opacity: 1;
      background: linear-gradient(90deg, #2fc06e, #27ae60);
    }

    @keyframes borderPulseBlue {
      0% { box-shadow: 0 0 0 0 rgba(122,183,255,0.65), 0 10px 26px rgba(122,183,255,0.18); }
      70% { box-shadow: 0 0 0 8px rgba(122,183,255,0), 0 6px 18px rgba(122,183,255,0.10); }
      100% { box-shadow: 0 0 0 0 rgba(122,183,255,0), 0 10px 26px rgba(122,183,255,0.18); }
    }
    
    @keyframes topBarPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ì§„í–‰ ì¤‘ ì¹´ë“œ íƒ€ì´í‹€ ìƒ¤ì´ë‹ íš¨ê³¼ */
    .agent-card.running h4 {
      background: linear-gradient(90deg, #888 0%, #fff 50%, #888 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: titleShine 1.2s linear infinite;
    }
    @keyframes titleShine { 0% { background-position: 200% 0; } 100% { background-position: 0 0; } }

    /* ì§„í–‰ ë¬¸êµ¬(ìš°ì¸¡ ìƒë‹¨) í•˜ì–€ìƒ‰ ë¹› ì´ë™ íš¨ê³¼ */
    #gpt1-panel #send-status.status-shine {
      background: linear-gradient(90deg, var(--main-text) 0%, #ffffff 50%, var(--main-text) 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: statusShine 1.2s linear infinite;
      font-weight: 600;
    }
    @keyframes statusShine { 0% { background-position: 200% 0; } 100% { background-position: 0 0; } }

    /* ìš°ì¸¡ íŒ¨ë„ ìë™ ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
    #gpt1-panel { scroll-behavior: smooth; }

    /* ì˜¤ë¥¸ìª½ íƒ­ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ìŠ¤íƒ€ì¼ - ì œê±°ë¨ */
    /* ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ì´ ì œê±°ë˜ì–´ ê´€ë ¨ ìŠ¤íƒ€ì¼ë„ ì œê±° */

    /* PPT ì¶œë ¥ CTA ê°•ì¡° */
    #btn-export-ppt.ppt-cta {
      position: relative;
      animation: ctaPulse 1.2s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(44,123,229,0.45);
      border-color: #2C7BE5 !important;
      color: #fff !important;
      background: #2C7BE5 !important;
    }
    #btn-export-ppt.ppt-cta::after {
      content: ' â† ì—¬ê¸°ì„œ PPT ì‘ì„±';
      position: absolute; right: 100%; top: 50%; transform: translateY(-50%);
      color: var(--accent); font-size: 12px; white-space: nowrap; margin-right: 8px;
    }
    @keyframes ctaPulse {
      0% { box-shadow: 0 0 0 0 rgba(44,123,229,0.45); }
      70% { box-shadow: 0 0 0 10px rgba(44,123,229,0); }
      100% { box-shadow: 0 0 0 0 rgba(44,123,229,0); }
    }
    .prompt-suggestion { display:none; border: 1px dashed var(--accent); background: rgba(122,183,255,0.08); padding: 8px; border-radius: 8px; font-size: 12px; line-height: 1.5; margin-bottom: 10px; }
    .prompt-suggestion.show { display:block; animation: fadeIn 0.25s ease; }

    /* ë§í’ì„  ë²„ë¸” ì œê±° */

    /* â–¼ ì¶”ê°€: ëª¨ë“  ë‹¨ê³„ ê³µí†µ í™•ì¥ í´ë˜ìŠ¤ */
    .output-panel.expanded {
      max-height: none !important;
      height: auto !important;
      overflow: visible !important;
    }

    /* (ì„ íƒ) details/summary ê¸°ë°˜ì´ë©´ open ì†ì„±ì— ëŒ€í•œ ë³´ì • */
    details.output-panel[open] {
      max-height: none !important;
    }

    /* ì‚¬ì´ë“œ íŒ¨ë„ ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ UX */
    #gpt1-panel { cursor: default; overflow-x: hidden; }
    #gpt1-panel.drag-scroll { cursor: grab; }
    #gpt1-panel.drag-scrolling { cursor: grabbing; user-select: none; }
    
    /* ìš°ì¸¡ íŒ¨ë„ ìˆ¨ê¹€/í‘œì‹œ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
    .sidebar-right { 
      transition: transform 0.25s ease; 
      position: relative;
      transform: translateX(0); /* ê¸°ë³¸ ìƒíƒœì—ì„œëŠ” í™”ë©´ì— í‘œì‹œ */
    }
    
    .sidebar-right.hidden { 
      transform: translateX(100%); 
      pointer-events: none;
    }
    
    /* ìš°ì¸¡ íŒ¨ë„ì´ ìˆ¨ê²¨ì¡Œì„ ë•Œ ë©”ì¸ ì˜ì—­ ì „ì²´ ì‚¬ìš© */
    .layout.panel-hidden main {
      flex: 1;
      margin-right: 0;
    }

    /* íŒŒì´í”„ë¼ì¸ ë¼ì¸ ì• ë‹ˆë©”ì´ì…˜ (ë°©í–¥ê° + ì§„í–‰ í‘œì‹œ) */
    .pipeline-line { 
      stroke-linecap: round; 
      stroke-dasharray: 8 8; /* ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ê¸°ë³¸ dasharray ì¶”ê°€ */
    }
    @keyframes dash-move { to { stroke-dashoffset: -20; } }
    .pipeline-line.flow { animation: dash-move 0.8s linear infinite; filter: drop-shadow(0 0 6px rgba(122,183,255,0.8)); stroke-width: 7 !important; }

    /* GPT0 ëª¨ë“ˆ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ - í†µì¼ëœ ë””ìì¸ */
    .gpt0-module-box {
      background: var(--main-bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .gpt0-module-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .gpt0-module-box:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px rgba(74, 144, 226, 0.2), 0 0 0 1px rgba(74, 144, 226, 0.1);
      transform: translateY(-2px);
    }

    .gpt0-module-box:hover::before {
      opacity: 1;
    }

    /* GPT0 ëª¨ë“ˆ ì‹¤í–‰ ì¤‘ íš¨ê³¼ */
    .gpt0-module-box.running {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25), 0 8px 32px rgba(74, 144, 226, 0.15);
      animation: gpt0Running 1.5s ease-in-out infinite;
      transform: translateY(-1px);
    }

    .gpt0-module-box.running::before {
      opacity: 1;
      animation: gpt0TopBar 1.5s ease-in-out infinite;
    }

    @keyframes gpt0Running {
      0%, 100% { 
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25), 0 4px 12px rgba(74, 144, 226, 0.15);
      }
      50% { 
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.4), 0 6px 16px rgba(74, 144, 226, 0.25);
      }
    }

    @keyframes gpt0TopBar {
      0%, 100% { 
        background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      }
      50% { 
        background: linear-gradient(90deg, var(--accent-hover), var(--accent));
      }
    }

    /* ëª¨ë“ˆ ë°•ìŠ¤ ì™„ë£Œ(ê³µí†µ) */
    .gpt0-module-box.done,
    .gpt1-module-box.done,
    .gpt2-module-box.done,
    .gpt3-module-box.done,
    .gpt4-module-box.done {
      border-color: #2fc06e;
      box-shadow: 0 0 0 2px rgba(47, 192, 110, 0.25);
    }

    .gpt0-module-box.done::before,
    .gpt1-module-box.done::before,
    .gpt2-module-box.done::before,
    .gpt3-module-box.done::before,
    .gpt4-module-box.done::before {
      opacity: 1;
      background: linear-gradient(90deg, #2fc06e, #27ae60);
    }

    /* GPT1~4 ëª¨ë“ˆ ë°•ìŠ¤ ê¸°ë³¸ ìŠ¤íƒ€ì¼ - í†µì¼ëœ ë””ìì¸ */
    .gpt1-module-box,
    .gpt2-module-box,
    .gpt3-module-box,
    .gpt4-module-box {
      background: var(--main-bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .gpt1-module-box::before,
    .gpt2-module-box::before,
    .gpt3-module-box::before,
    .gpt4-module-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .gpt1-module-box:hover,
    .gpt2-module-box:hover,
    .gpt3-module-box:hover,
    .gpt4-module-box:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px rgba(74, 144, 226, 0.2), 0 0 0 1px rgba(74, 144, 226, 0.1);
      transform: translateY(-2px);
    }

    .gpt1-module-box:hover::before,
    .gpt2-module-box:hover::before,
    .gpt3-module-box:hover::before,
    .gpt4-module-box:hover::before {
      opacity: 1;
    }

    /* GPT1~4 ëª¨ë“ˆ ì‹¤í–‰ ì¤‘ íš¨ê³¼ */
    .gpt1-module-box.running,
    .gpt2-module-box.running,
    .gpt3-module-box.running,
    .gpt4-module-box.running {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25), 0 8px 32px rgba(74, 144, 226, 0.15);
      animation: gpt0Running 1.5s ease-in-out infinite;
      transform: translateY(-1px);
    }

    .gpt1-module-box.running::before,
    .gpt2-module-box.running::before,
    .gpt3-module-box.running::before,
    .gpt4-module-box.running::before {
      opacity: 1;
      animation: gpt0TopBar 1.5s ease-in-out infinite;
    }

    /* ì‹¤í–‰ ì¤‘ ì—ì´ì „íŠ¸ ë°•ìŠ¤ ë°˜ì§ì„ íš¨ê³¼ */
    @keyframes pulse-green {
      0% { stroke: #2fc06e; fill: rgba(40, 160, 90, 0.18); }
      100% { stroke: #5fe08f; fill: rgba(40, 160, 90, 0.36); }
    }
    .agent-running rect {
      stroke: #2fc06e !important;
      animation: pulse-green 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 6px rgba(47,192,110,0.6));
    }
    .agent-running text { fill: #d9ffe6 !important; }
    /* í•˜ì´ë¼ì´íŠ¸/ë””ë° íš¨ê³¼ */
    .dimmed { opacity: 0.15; filter: grayscale(60%); transition: opacity 150ms ease, filter 150ms ease; }
    .highlighted { opacity: 1 !important; filter: none !important; }
    .highlight-label { font: 12px/1.2 'Segoe UI', Arial, sans-serif; fill: var(--main-text); pointer-events: none; paint-order: stroke; stroke: var(--main-bg); stroke-width: 3px; }
    /* ì „ë¶€ Yì¼ ë•Œ ì—°ê²°ì„  ê¹œë°•ì„ */
    @keyframes blinkLine {
      0%, 100% { stroke-opacity: 0.9; filter: drop-shadow(0 0 0 rgba(229,57,53,0)); }
      50% { stroke-opacity: 0.35; filter: drop-shadow(0 0 6px rgba(229,57,53,0.6)); }
    }
    .blink-y-all { animation: blinkLine 1.1s ease-in-out infinite; }
    /* PPT ì§„í–‰ ë²„íŠ¼ íš¨ê³¼ (ëŠë¦¬ê²Œ, ë²„íŠ¼ ë‚´ë¶€ë§Œ ê¹œë°•) */
    .ppt-progress { background: #2ecc71 !important; color: #fff !important; border-color: #27ae60 !important; }
    .ppt-progress { animation: pulsePptInner 2.2s ease-in-out infinite; }
    /* 'PPTì¶œë ¥' ë²„íŠ¼ë§Œ ê¹œë°•ì„ (ë°•ìŠ¤ ì „ì²´ ì•„ë‹˜) */
    #btn-export-ppt.ppt-progress { position: relative; overflow: hidden; }
    #btn-export-ppt.ppt-progress::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 4px;
      box-shadow: inset 0 0 12px rgba(255,255,255,0.25);
      animation: pulseBtn 2.2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes pulseBtn { 0%,100% { opacity: 0.2; } 50% { opacity: 1; } }
    
    /* ë³´ê³ ì„œ ë²„íŠ¼ ê¹œë°•ì„ íš¨ê³¼ */
    #btn-export-html.report-progress { 
      position: relative; 
      overflow: hidden;
      background: #2ecc71 !important; 
      color: #fff !important; 
      border-color: #27ae60 !important;
      animation: pulsePptInner 2.2s ease-in-out infinite;
    }
    #btn-export-html.report-progress::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 4px;
      box-shadow: inset 0 0 12px rgba(255,255,255,0.25);
      animation: pulseBtn 2.2s ease-in-out infinite;
      pointer-events: none;
    }
    
         /* ë³´ê³ ì„œ ì˜ì—­ CTA(ê°•ì¡°) íš¨ê³¼ */
     @keyframes reportBoxGlow {
       0%, 100% { box-shadow: 0 0 0 rgba(46,204,113,0); }
       50% { box-shadow: 0 0 18px rgba(46,204,113,0.6); }
     }
     #report-actions.report-actions-cta { animation: reportBoxGlow 1.6s ease-in-out 4; }
     #btn-export-html.report-cta { animation: pulseBtn 1.2s ease-in-out 6; }
     
     /* íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ ë²„íŠ¼ ê°•ì¡° ì• ë‹ˆë©”ì´ì…˜ */
     @keyframes pulseSuccess {
       0%, 100% { transform: scale(1); }
       50% { transform: scale(1.05); }
     }
     
          /* ìƒë‹¨ íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ íš¨ê³¼ */
     #top-pipeline-btn:hover:not(:disabled) {
       background: linear-gradient(135deg, #357abd, #2c5d9f) !important;
       box-shadow: 0 6px 20px rgba(74,144,226,0.5) !important;
       transform: translateY(-2px) scale(1.02);
     }
     
     /* ë³´ê³ ì„œë³´ê¸° ë²„íŠ¼ íš¨ê³¼ */
     #btn-export-html:hover:not(:disabled) {
       background: linear-gradient(135deg, #e67e22, #d35400) !important;
       box-shadow: 0 5px 18px rgba(243,156,18,0.5) !important;
       transform: translateY(-2px) scale(1.02);
     }
     
     /* ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ íš¨ê³¼ */
     #btn-restart-pipeline:hover:not(:disabled) {
       background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
       box-shadow: 0 4px 15px rgba(39,174,96,0.45) !important;
       transform: translateY(-2px) scale(1.02);
     }
     
     #top-pipeline-btn:active:not(:disabled) {
       transform: translateY(0) scale(0.98);
       box-shadow: 0 2px 8px rgba(74,144,226,0.3) !important;
     }
     
     #btn-export-html:active:not(:disabled) {
       transform: translateY(0) scale(0.98);
       box-shadow: 0 2px 8px rgba(243,156,18,0.3) !important;
     }
     
     #btn-restart-pipeline:active:not(:disabled) {
       transform: translateY(0) scale(0.98);
       box-shadow: 0 2px 6px rgba(39,174,96,0.25) !important;
     }
     
     #top-pipeline-btn:disabled {
       opacity: 0.6;
       cursor: not-allowed;
       transform: none !important;
     }
     
     #top-pipeline-btn.blink-text {
       animation: blinkText 0.9s linear infinite;
     }
     
     /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°˜ì‘í˜• ë””ìì¸ */
     @media (max-width: 500px) {
       .sidebar-right .size-control-btn {
         padding: 3px 6px !important;
         font-size: 12px !important;
         min-width: 24px !important;
       }
       
       .sidebar-right #tab-size-display {
         font-size: 10px !important;
         min-width: 40px !important;
       }
       
       .sidebar-right .darkmode-toggle {
         padding: 4px 8px !important;
         font-size: 10px !important;
         min-width: 60px !important;
       }
     }
     
     @media (max-width: 400px) {
       .sidebar-right > div:first-child {
         gap: 2px !important;
       }
       
       .sidebar-right .darkmode-toggle {
         padding: 3px 6px !important;
         font-size: 9px !important;
         min-width: 50px !important;
       }
    }
    
    /* í…ìŠ¤íŠ¸ ê¹œë°•ì„ (ì§„í–‰ í‘œì‹œìš©) */
    .blink-text { animation: blinkText 0.9s linear infinite; }
    @keyframes blinkText { 0%, 49% { opacity: 0.35; } 50%, 100% { opacity: 1; } }
    
    /* íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì• ë‹ˆë©”ì´ì…˜ - ì£¼í™©ìƒ‰ íš¨ê³¼ ì œê±°ë¨ */
    .pipeline-executing {
      /* ì£¼í™©ìƒ‰ í¬ê¸° íš¨ê³¼ ì œê±° - ì‚¬ìš©ì ìš”ì²­ìœ¼ë¡œ ë¹ˆ í´ë˜ìŠ¤ ìœ ì§€ */
      opacity: 1; /* ë¹ˆ ê·œì¹™ ë°©ì§€ìš© */
    }
    
    /* íŒŒì´í”„ë¼ì¸ ì§„í–‰ ìƒíƒœ í‘œì‹œ */
    .progress-indicator {
      position: relative;
      border: 2px solid #4a90e2 !important;
      background: rgba(74, 144, 226, 0.05) !important;
      animation: progressGlow 2s infinite;
    }
    
    @keyframes progressGlow {
      0%, 100% { 
        box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
      }
      50% { 
        box-shadow: 0 0 20px rgba(74, 144, 226, 0.6);
      }
    }
    
    .execution-overlay {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: rgba(74, 144, 226, 0.1) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 1000 !important;
      border-radius: 8px !important;
      backdrop-filter: blur(1px) !important;
    }
    
    .execution-text {
      background: rgba(74, 144, 226, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      animation: fadeInOut 2s infinite;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    
    @keyframes pipelinePulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 20px rgba(255, 107, 53, 0.5); 
      }
      50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 30px rgba(255, 107, 53, 0.8); 
      }
    }
    
    /* ë°•ìŠ¤ ë‚´ë¶€ ì§„í–‰ ìƒí™© í‘œì‹œ */
    .progress-indicator {
      position: relative;
      overflow: hidden;
    }
    
    .progress-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(74, 144, 226, 0.3), transparent);
      animation: progressSweep 2s ease-in-out infinite;
    }
    
    @keyframes progressSweep {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    /* ì‹¤í–‰ ì¤‘ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ */
    .execution-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(74, 144, 226, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      border-radius: 12px;
      backdrop-filter: blur(2px);
    }
    
    .execution-text {
      color: white;
      font-weight: 700;
      font-size: 16px;
      text-align: center;
      animation: executeTextPulse 1.5s ease-in-out infinite;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    @keyframes executeTextPulse {
      0%, 100% { 
        opacity: 0.8;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.05);
      }
    }
    @keyframes pulsePptInner {
      0%, 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.00); }
      50%      { box-shadow: inset 0 0 18px 0 rgba(255,255,255,0.20); }
    }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes loading-pulse {
      0%, 100% { 
        opacity: 0.7;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.02);
      }
    }

    @keyframes loading-fade {
      0%, 100% { 
        opacity: 0.5;
      }
      50% { 
        opacity: 1;
      }
    }

    /* ì¹´ë“œ ë³¸ë¬¸ ê°€ë…ì„± í–¥ìƒ */
    .report-card h3 { 
      margin: 0.6rem 0 0.4rem; 
      font-weight: 700; 
      color: var(--main-text);
    }
    .report-card p { 
      margin: 0.4rem 0; 
      line-height: 1.6; 
    }
    .report-card ul, .report-card ol { 
      margin: 0.2rem 0 0.8rem 1.2rem; 
    }

    /* ë©”íŠ¸ë¦­ ëª©ë¡ì„ ë˜ë ·í•˜ê²Œ */
    .report-card ul li strong { 
      font-weight: 700; 
    }
    .report-card ul li { 
      padding-left: 2px; 
    }

    /* ìˆ«ì ê°•ì¡°(ì–‘/ìŒ) â€“ ê°„ë‹¨ ë§¤ì¹­ */
    .metric-pos { 
      color: #11875d; 
      font-weight: 700; 
    }
    .metric-neg { 
      color: #c4302b; 
      font-weight: 700; 
    }

    /* ë‹¤í¬ í…Œë§ˆì—ì„œì˜ ë©”íŠ¸ë¦­ ìƒ‰ìƒ ì¡°ì • */
    [data-theme="dark"] .metric-pos { 
      color: #22c55e; 
    }
    [data-theme="dark"] .metric-neg { 
      color: #ef4444; 
    }
    
    /* GPT1 ë°•ìŠ¤ ì§§ì€ í¬ì»¤ìŠ¤ í•˜ì´ë¼ì´íŠ¸ (í•„ìš” ì‹œ ì¡°ì •) */
    .pipeline-focus {
      outline: 2px solid rgba(0, 160, 255, .75);
      box-shadow: 0 0 0 4px rgba(0, 160, 255, .15);
      transition: box-shadow .3s ease;
    }

    /* âœ… GPT4 ì™„ë£Œ í›„ ì „ì²´ ë…¸ì¶œ ë³´ì¥ */
    #gpt1-panel.show-all .agent-card {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    #gpt1-panel.show-all .agent-card.collapsed {
      display: block !important;
    }

    /* === [ì¶”ê°€] Right íƒ­: ì¹´ë“œ í™•ì¥ ë™ì‘ ë³´ê°• === */

    /* ê¸°ë³¸(ì¶•ì•½) ë†’ì´: ìŠ¤í¬ë¡¤ í—ˆìš© */
    aside.sidebar-right .agent-card .card-body,
    aside.sidebar-right .agent-card .content,
    aside.sidebar-right .agent-card .output-box,
    aside.sidebar-right .agent-card .result-box {
      max-height: 14rem;      /* í•„ìš”ì‹œ 12~16remë¡œ ì¡°ì • */
      overflow: auto;
    }

    /* expanded ì‹œ: ë†’ì´ ì œí•œ í•´ì œ */
    aside.sidebar-right .agent-card.expanded .card-body,
    aside.sidebar-right .agent-card.expanded .content,
    aside.sidebar-right .agent-card.expanded .output-box,
    aside.sidebar-right .agent-card.expanded .result-box {
      max-height: none !important;
      height: auto !important;
      overflow: visible;
    }

    /* í…ìŠ¤íŠ¸ ì˜ì—­ ê°€ë…ì„±(ìµœì†Œ ë†’ì´ í™•ë³´) */
    aside.sidebar-right .agent-card textarea,
    aside.sidebar-right .agent-card pre {
      min-height: 12rem;      /* í•„ìš”ì‹œ 10~14rem ì¡°ì • */
      resize: vertical;       /* ì‚¬ìš©ìê°€ ìˆ˜ë™ ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥ */
    }

    /* show-all ëª¨ë“œì—ì„œ ê°•ì œ í‘œì‹œ(ë‹¤ë¥¸ ëª¨ë“œ ì”ì—¬ ìŠ¤íƒ€ì¼ ìƒì‡„) */
    aside.sidebar-right.show-all .agent-card {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* Right íƒ­ í™•ì¥ ì‹œ textareaë„ ìµœëŒ€ë†’ì´ í•´ì œ */
    aside.sidebar-right .agent-card:not(.expanded) textarea {
      max-height: 14rem;
      overflow: auto;
    }
    aside.sidebar-right .agent-card.expanded textarea {
      max-height: none;
    }
  </style>
  
  <!-- [PATCH] ì™„ë£Œ ì‹œ ì „ì²´ ë…¸ì¶œ/íš¨ê³¼ ì •ì§€ ìŠ¤íƒ€ì¼ -->
  <style id="patch-output-autogrow">
    /* GPT0~4 ì¶œë ¥ í…ìŠ¤íŠ¸ ë°•ìŠ¤ëŠ” ë†’ì´ 200px ê³ ì • ë° ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    #card-gpt0 textarea,
    #card-gpt1 textarea,
    #card-gpt2 textarea,
    #card-gpt3 textarea,
    #card-gpt4 textarea {
      height: 200px !important;
      overflow: auto !important;
      resize: vertical !important;
    }
    
    /* GPT0 ëª¨ë“ˆë³„ ì¶œë ¥ë°•ìŠ¤ ìŠ¤í¬ë¡¤ ìŠ¤íƒ€ì¼ */
    #gpt0-marketdata,
    #gpt0-news,
    #gpt0-scenario-summary,
    #gpt0-marketstate {
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    
    /* ì›¹í‚· ë¸Œë¼ìš°ì €ìš© ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    #gpt0-marketdata::-webkit-scrollbar,
    #gpt0-news::-webkit-scrollbar,
    #gpt0-scenario-summary::-webkit-scrollbar,
    #gpt0-marketstate::-webkit-scrollbar {
      width: 8px;
    }
    
    #gpt0-marketdata::-webkit-scrollbar-track,
    #gpt0-news::-webkit-scrollbar-track,
    #gpt0-scenario-summary::-webkit-scrollbar-track,
    #gpt0-marketstate::-webkit-scrollbar-track {
      background: transparent;
    }
    
    #gpt0-marketdata::-webkit-scrollbar-thumb,
    #gpt0-news::-webkit-scrollbar-thumb,
    #gpt0-scenario-summary::-webkit-scrollbar-thumb,
    #gpt0-marketstate::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
    
    #gpt0-marketdata::-webkit-scrollbar-thumb:hover,
    #gpt0-news::-webkit-scrollbar-thumb:hover,
    #gpt0-scenario-summary::-webkit-scrollbar-thumb:hover,
    #gpt0-marketstate::-webkit-scrollbar-thumb:hover {
      background: var(--accent-hover);
    }
  </style>
  <style id="patch-pipeline-complete-visibility">
    /* ì™„ë£Œ í”Œë˜ê·¸ê°€ ë¶™ìœ¼ë©´ ì˜¤ë¥¸ìª½ íƒ­(ë° ì£¼ìš” íŒ¨ë„)ì˜ ëª¨ë“  ë°•ìŠ¤ë¥¼ ê°•ì œ ë…¸ì¶œ */
    body.pipeline-complete .right-tab .gpt-box,
    body.pipeline-complete [data-panel="right"] .gpt-box,
    body.pipeline-complete #gpt1-panel .gpt-box,
    body.pipeline-complete #gpt2-panel .gpt-box,
    body.pipeline-complete #gpt3-panel .gpt-box,
    body.pipeline-complete #gpt4-panel .gpt-box,
    body.pipeline-complete #gpt-panels .gpt-box,
    body.pipeline-complete .right-tab [data-role="box"],
    body.pipeline-complete [data-panel="right"] [data-role="box"],
    body.pipeline-complete #gpt-panels [data-role="box"],
    body.pipeline-complete .agent-card,
    body.pipeline-complete .module-card,
    body.pipeline-complete .panel-box {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
      height: auto !important;
      max-height: none !important;
    }

    /* ì•„ì½”ë””ì–¸/ë””í…Œì¼ ê°•ì œ í¼ì¹¨ */
    body.pipeline-complete .right-tab details,
    body.pipeline-complete [data-panel="right"] details,
    body.pipeline-complete #gpt-panels details {
      overflow: visible !important;
    }

    /* ì™„ë£Œ í›„ ì”ì—¬ ì• ë‹ˆë©”ì´ì…˜/ìŠ¤ì¼ˆë ˆí†¤/ìŠ¤í”¼ë„ˆ ë¹„í™œì„± */
    body.pipeline-complete .animate-pulse,
    body.pipeline-complete .blink,
    body.pipeline-complete .shimmer,
    body.pipeline-complete .loading,
    body.pipeline-complete .skeleton,
    body.pipeline-complete .status-shine,
    body.pipeline-complete .progress,
    body.pipeline-complete .progress-bar {
      animation: none !important;
    }
    body.pipeline-complete .execution-overlay,
    body.pipeline-complete .progress-indicator,
    body.pipeline-complete .spinner {
      display: none !important;
    }
  </style>
  <style id="patch-gpt23-header-safe">
    /* GPT2/GPT3 ì¹´ë“œ ì œëª©ì´ ë ˆì´ì•„ì›ƒì„ ëˆ„ë¥´ì§€ ì•Šë„ë¡ ì•ˆì „ ì²˜ë¦¬ */
    #card-gpt2 h4, #card-gpt3 h4 {
      display: block;
      margin: 0 0 8px;
      padding: 6px 10px;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="layout">
    <!-- ì¤‘ì•™: ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ -->
    <main id="main-content">
      <section id="network-graph"></section>
    </main>

    <!-- ì˜¤ë¥¸ìª½: GPT íŒ¨ë„ (ìš”ì•½/ê²°ê³¼ ë³´ê´€) + ë²„ë¸” UI ì˜¤ë²„ë ˆì´ -->
    <aside class="sidebar-right right-tab-panel" id="gpt1-panel">

      
      <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
      <div style="margin-bottom:6px;">
        
        <!-- 1ì¤„: ë¶„ì„ì‹œì‘ ë²„íŠ¼ -->
        <div style="display:flex;justify-content:center;margin-bottom:6px;">
          <button class="darkmode-toggle analysis-start-btn" id="top-pipeline-btn" style="width:70%; max-width:280px; background:linear-gradient(135deg, #4a90e2, #357abd); color:white; font-weight:700;border-radius:10px;box-shadow:0 3px 10px rgba(74,144,226,0.3);transition:all 0.3s ease;" onclick="handlePipelineAndReport()">ë¶„ì„ì‹¤í–‰</button>
        </div>
        
        <!-- 2ì¤„: ë³´ê³ ì„œë³´ê¸° ë²„íŠ¼ (ì™„ë£Œ ì‹œ í‘œì‹œ) -->
        <div id="report-buttons-container" style="display:none;flex-direction:column;gap:8px;margin-bottom:6px;">
          <button class="darkmode-toggle" id="btn-export-html" style="padding:16px 30px; width:70%; max-width:280px; background:linear-gradient(135deg, #f39c12, #e67e22); color:white; font-weight:700;font-size:16px;border-radius:10px;box-shadow:0 3px 10px rgba(243,156,18,0.3);transition:all 0.3s ease;margin:0 auto;display:block;" onclick="showHtmlReport()">ğŸ“Š ë³´ê³ ì„œë³´ê¸°</button>
          <!-- ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ ìˆ¨ê¹€ -->
          <button class="darkmode-toggle" id="btn-restart-pipeline" style="padding:10px 24px; width:60%; max-width:240px; background:linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-weight:600;font-size:14px;border-radius:8px;box-shadow:0 2px 8px rgba(39,174,96,0.25);transition:all 0.3s ease;margin:0 auto;display:none;" onclick="restartPipeline()">ğŸ”„ ë‹¤ì‹œì‹¤í–‰</button>
        </div>
        
        <!-- 3ì¤„: íƒ­ í¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡¤ (ë§ˆì§€ë§‰ ì¤„) -->
        <div id="tab-size-control-container" style="display:flex;align-items:center;gap:6px;justify-content:center;">
          <button class="size-control-btn" style="padding:4px 8px;font-size:14px;min-width:28px;font-weight:bold;border-radius:4px;" onclick="increaseTabSize()">+</button>
          <span id="tab-size-display" class="size-display" style="font-size:12px;font-weight:600;min-width:50px;text-align:center;">400px</span>
          <button class="size-control-btn" style="padding:4px 8px;font-size:14px;min-width:28px;font-weight:bold;border-radius:4px;" onclick="decreaseTabSize()">âˆ’</button>
        </div>
        
      </div>
      <div id="send-status" style="margin:2px 0 8px;font-size:12px;color:#888;text-align:center;"></div>
      
        <script>
    // ==== GPT3 ê²°ê³¼ ì €ì¥ ê³µí†µ ìœ í‹¸ ====
    function setIfNonEmpty(id, text){
      const el = document.getElementById(id);
      const t  = (text || '').trim();
      if (el && t) el.value = t;               // âœ… ë¹ˆ ë¬¸ìì—´ì´ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
    }

    // ==== [C] í´ë°±: ìƒíƒœ ë¼ë²¨ ê´€ì°° â†’ ì´ë²¤íŠ¸ ìë™ ë°œí–‰ ====
        (function(){
          const statusEl = document.querySelector('#send-status, .pipeline-status, .status-text');
          if (!statusEl) return;
          let last = '';

          const map = [
            { re: /GPT\s*0|GPT0|ì‚¬ì „ìˆ˜ì§‘|ì‹œí™©/i,      evt: 'gpt0:start' }, // â˜… ì¶”ê°€
            { re: /GPT\s*1|GPT1|ì¢…í•©ë¶„ì„|ìš”ì•½ ìƒì„±/i, evt: 'gpt1:start' },
            { re: /GPT\s*2|GPT2|ì‹œë‚˜ë¦¬ì˜¤/i,          evt: 'gpt2:start' },
            { re: /GPT\s*3|GPT3|ë„ë©”ì¸|ë”¥ë‹¤ì´ë¸Œ/i,    evt: 'gpt3:start' },
            { re: /GPT\s*4|GPT4|ìµœì¢…|ë³´ê³ ì„œ/i,        evt: 'gpt4:start' },
            { re: /ì™„ë£Œ|ë³´ê³ ì„œ\s*ì‘ì„±\s*ì™„ë£Œ|ë³´ê³ ì„œ\s*ìƒì„±\s*ì™„ë£Œ|íŒŒì´í”„ë¼ì¸\s*ì™„ë£Œ|ì¢…ë£Œ/i, evt: 'pipeline:done' }
          ];

          // ì¹´ë“œ ì°¸ì¡° ìºì‹œ ì „ì—­ í™•ë³´
          const c0 = document.getElementById('card-gpt0');
          const c1 = document.getElementById('card-gpt1');
          const c2 = document.getElementById('card-gpt2');
          const c3 = document.getElementById('card-gpt3');
          const c4 = document.getElementById('card-gpt4');
          function clearRunning(){ [c0,c1,c2,c3,c4].forEach(el => el?.classList.remove('running')); }

          new MutationObserver(() => {
            const text = statusEl.textContent || '';
            if (text === last) return;
            last = text;
            for (const {re, evt} of map) {
              if (re.test(text)) {
                window.dispatchEvent(new CustomEvent(evt));
                break;
              }
            }
          }).observe(statusEl, { childList: true, subtree: true, characterData: true });
        })();

        // ==== [D] "ì´ˆê¸° ì „ì²´â†’ì´í›„ ë‹¨ë…í‘œì‹œ" í† ê¸€ í•¸ë“¤ëŸ¬ ====
        (function applySoloViewMode(){
          const panel = document.getElementById('gpt1-panel'); // ìš°ì¸¡ íŒ¨ë„ ì»¨í…Œì´ë„ˆ
          if (!panel) return;

          // ê¸°ë³¸ ì •ì±…: í•­ìƒ ì „ì²´ í‘œì‹œ
          function exitSolo() { panel.classList.remove('solo-mode'); }
          function enterSolo() { /* no-op: ë‹¨ë…í‘œì‹œ ë¯¸ì‚¬ìš© */ }

          // ì´ˆê¸° ì§„ì… ì‹œ ì „ì²´í‘œì‹œ ê°•ì œ
          panel.classList.add('show-all');
          panel.classList.remove('solo-mode');

          // ê³µí†µ ìœ í‹¸(ë¡œì»¬ ìŠ¤ì½”í”„ì—ì„œ ìì²´ ì²˜ë¦¬, ì „ì—­ ì˜ì¡´ ì œê±°)
          function removeRunningInRightPanel() {
            document.querySelectorAll('.right-tab-panel .agent-card.running')
              .forEach(el => el.classList.remove('running'));
          }
          function markRunningById(id) {
            const card = document.getElementById(id);
            if (card) card.classList.add('running');
          }
          function scrollToAnchorOrCard(anchorSel, cardId) {
            // ğŸ”’ ìŠ¤ì½”í”„ ì ê¸ˆ ì ìš©
            const scope = window.__RightFocusScope || null;
            if (scope === 'gpt3') {
              anchorSel = '.gpt3-anchor';
              cardId    = 'card-gpt3';
            } else if (scope === 'gpt4') {
              anchorSel = '.gpt4-anchor';
              cardId    = 'card-gpt4';
            }

            // 1) ì•µì»¤ê°€ ìˆìœ¼ë©´ ì•µì»¤ ê¸°ì¤€ ìŠ¤í¬ë¡¤
            const anchor = document.querySelector(anchorSel);
            const panel  = document.querySelector('.right-tab-panel');
            if (panel && anchor) {
              panel.scrollTo({ top: Math.max(0,(anchor.offsetTop||0) - 40), behavior: 'smooth' });
              return;
            }
            // 2) í´ë°±: ì¹´ë“œ ID ê¸°ì¤€ ìŠ¤í¬ë¡¤
            const card = document.getElementById(cardId);
            if (panel && card) {
              panel.scrollTo({ top: Math.max(0,(card.offsetTop||0) - 40), behavior: 'smooth' });
            }
          }

          // âš™ï¸ ì •ì±…:
          // - gpt0 ì‹œì‘: ì „ì²´ í‘œì‹œ ìœ ì§€ + ê°•ì¡°ë§Œ
          // - gpt1~gpt4 ì‹œì‘: ì „ì²´ í‘œì‹œ ìœ ì§€ + ê°•ì¡°ë§Œ
          window.addEventListener('gpt0:start', () => {
            panel.classList.add('show-all');
            exitSolo();
          });
          window.addEventListener('gpt1:start', () => {
            panel.classList.add('show-all');
            exitSolo();
          });
      // GPT2/3/4ê°€ ë¨¼ì € ì‹œì‘ë˜ë©´ GPT1â†’GPT2 ì§€ì—° íƒ€ì´ë¨¸ ì·¨ì†Œ(ë ˆì´ìŠ¤ ê°€ë“œ)
      ;['gpt2:start','gpt3:start','gpt4:start'].forEach(evt => {
        window.addEventListener(evt, () => {
          if (window.__gpt1ToGpt2Timer) {
            clearTimeout(window.__gpt1ToGpt2Timer);
            window.__gpt1ToGpt2Timer = null;
          }
        });
      });
          // ìš°ì¸¡ íŒ¨ë„ ìë™ ìŠ¤í¬ë¡¤/í¬ì»¤ìŠ¤ ìŠ¤ì½”í”„: null | 'gpt3' | 'gpt4'
          window.__RightFocusScope = window.__RightFocusScope || null;
          window.addEventListener('gpt3:start', () => { window.__RightFocusScope = 'gpt3'; });
          window.addEventListener('gpt4:start', () => { window.__RightFocusScope = 'gpt4'; });
          window.addEventListener('pipeline:done', () => { window.__RightFocusScope = null; });
          window.addEventListener('gpt4:done', () => { window.__RightFocusScope = null; });

      // GPT2 êµ¬ê°„: ìƒë‹¨ ìƒíƒœ ë¼ë²¨ì— ì§„í–‰ì¤‘ íš¨ê³¼ ì ìš©
      window.addEventListener('gpt2:start', () => {
        const s = document.getElementById('send-status');
        if (!s) return;
        s.classList.add('progress-indicator','status-shine');
        s.setAttribute('aria-busy','true');
      });
      // GPT3 ì‹œì‘ ì‹œ ë˜ëŠ” íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ íš¨ê³¼ í•´ì œ
      window.addEventListener('gpt3:start', () => {
        const s = document.getElementById('send-status');
        if (!s) return;
        s.classList.remove('progress-indicator','status-shine');
        s.removeAttribute('aria-busy');
      });
      window.addEventListener('pipeline:done', () => {
        const s = document.getElementById('send-status');
        if (!s) return;
        s.classList.remove('progress-indicator','status-shine');
        s.removeAttribute('aria-busy');
      });
          window.addEventListener('gpt2:start', () => {
            // ë³´ì¡° ê°€ë“œ: GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ êµ¬ê°„ì—ì„œëŠ” solo-mode í•´ì œ
            if (typeof disableSoloMode === 'function') disableSoloMode();
            panel.classList.add('show-all');
            exitSolo();
          });
          window.addEventListener('gpt3:start', () => {
            const panel = document.querySelector('.right-tab-panel');
            panel?.classList.add('show-all');  // â† ì „ì²´í‘œì‹œ ìœ ì§€(ë³€ê²½)
            exitSolo();                        // â† ë‹¨ë…í‘œì‹œ í•´ì œ(ë³€ê²½)
            removeRunningInRightPanel();
            markRunningById('card-gpt3');
            scrollToAnchorOrCard('.gpt3-anchor', 'card-gpt3');
          });
          window.addEventListener('gpt4:start', () => {
            const panel = document.querySelector('.right-tab-panel');
            panel?.classList.add('show-all');  // â† ì „ì²´í‘œì‹œ ìœ ì§€(ë³€ê²½)
            exitSolo();                        // â† ë‹¨ë…í‘œì‹œ í•´ì œ(ë³€ê²½)
            removeRunningInRightPanel();
            markRunningById('card-gpt4');                 // â† ë°˜ë“œì‹œ running ë¶€ì—¬
            scrollToAnchorOrCard('.gpt4-anchor', 'card-gpt4'); // â† ì•µì»¤ ì—†ìœ¼ë©´ ì¹´ë“œë¡œ í´ë°±
          });
        })();

        // ì™„ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€: solo-mode í•´ì œ ë° í‘œì‹œ ìƒíƒœ ì •ë¦¬
        window.addEventListener('pipeline:done', () => {
          console.log('ğŸ‰ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ - ëª¨ë“  íš¨ê³¼ ë° íƒ€ì´ë¨¸ ì •ë¦¬');
          
          // GPT3 ì§€ì—° íš¨ê³¼ íƒ€ì´ë¨¸ ì •ë¦¬ (í˜¹ì‹œ ë‚¨ì•„ìˆì„ ê²½ìš°)
          if (window.gpt3DelayedEffectTimer) {
            clearTimeout(window.gpt3DelayedEffectTimer);
            window.gpt3DelayedEffectTimer = null;
            console.log('âœ… GPT3 ì§€ì—° íš¨ê³¼ íƒ€ì´ë¨¸ ì •ë¦¬ ì™„ë£Œ');
          }
          
          // solo-mode ì§ì ‘ í•´ì œ
          document.querySelector('.right-tab-panel')?.classList.remove('solo-mode','gpt2worst-mode');

          // running/ì‹¤í–‰ í‘œì‹œ ì •ë¦¬
          document.querySelectorAll('.right-tab-panel .agent-card.running')
            .forEach(el => el.classList.remove('running'));

          // GPT3 ëª¨ë“ˆë³„ ë°•ìŠ¤ íš¨ê³¼ ì™„ì „ ì¢…ë£Œ
          document.querySelectorAll('.gpt3-module-box.running')
            .forEach(el => el.classList.remove('running'));

          // ëª¨ë“  ëª¨ë“ˆ ë°•ìŠ¤ì— done í´ë˜ìŠ¤ ì¶”ê°€
          document.querySelectorAll(
            '.gpt0-module-box,.gpt1-module-box,.gpt2-module-box,.gpt3-module-box,.gpt4-module-box'
          ).forEach(el => el.classList.add('done'));

          // ì‹¤í–‰ ì¤‘ ì˜¤ë²„ë ˆì´ ì œê±°
          document.querySelectorAll('.execution-overlay')
            .forEach(el => el.remove());

          // ì§„í–‰ í‘œì‹œ íš¨ê³¼ ì œê±°
          document.querySelectorAll('.progress-indicator')
            .forEach(el => el.classList.remove('progress-indicator'));

          // íŒŒì´í”„ë¼ì¸ ì™„ë£Œ í”Œë˜ê·¸ ì¶”ê°€ (CSS íš¨ê³¼ ê°•ì œ ì¢…ë£Œìš©)
          document.body.classList.add('pipeline-complete');
        });

        // âœ… GPT2 WORST ì§„í–‰ ì‹œ GPT1Â·GPT2 ë°•ìŠ¤ ê°•ì œ ë…¸ì¶œ ë° GPT4 ì™„ë£Œ ì‹œ ëª¨ë“  ë°•ìŠ¤ ë…¸ì¶œ
        (function initRightTabShowPolicy(){
          if (window.__initRightTabShowPolicy) return;
          window.__initRightTabShowPolicy = true;

          function getPanel() {
            return document.querySelector('.right-tab-panel, #gpt1-panel, #gpt-right-panel, #right-tab, aside#right-panel, [data-panel="right"]');
          }
          function markVisible(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.remove('hidden','collapsed');
            card.style.display = ''; // display:none ê°•ì œ í•´ì œ(ìˆì„ ê²½ìš°)
            card.classList.add('running'); // solo-modeì—ì„œë„ í‘œì‹œë˜ë„ë¡
          }
          function addExecuting(selector) {
            document.querySelectorAll(selector).forEach(el => el.classList.add('pipeline-executing'));
          }
          function removeExecuting(selector) {
            document.querySelectorAll(selector).forEach(el => el.classList.remove('pipeline-executing'));
          }
          function scrollBetween(id1, id2) {
            const panel = getPanel();
            const a = document.getElementById(id1);
            const b = document.getElementById(id2);
            if (!(panel && a && b)) return;
            setTimeout(() => {
              try {
                const mid = (a.offsetTop + b.offsetTop) / 2;
                panel.scrollTo({ top: Math.max(0, mid - 80), behavior: 'smooth' });
              } catch(_) {}
            }, 60);
          }

          // âœ… GPT2 WORST ì‹œì‘ â†’ í†µí•© ì²˜ë¦¬ (onGpt2WorstStartUI í•¨ìˆ˜ ì‚¬ìš©)
          window.addEventListener('gpt2worst:start', () => {
            console.log('ğŸ”” GPT2 Worst ì´ë²¤íŠ¸ ìˆ˜ì‹  - í†µí•© ì²˜ë¦¬');
            onGpt2WorstStartUI();
          });

          // âœ… GPT3/GPT4 ì‹œì‘ ì‹œì—ë„ show-allì„ ìœ ì§€(ì „ì²´í‘œì‹œ ì •ì±…)
          window.addEventListener('gpt3:start', () => {
            const panel = getPanel();
            panel?.classList.add('show-all');    // â† ì „ì²´í‘œì‹œ ìœ ì§€
          });
          window.addEventListener('gpt4:start', () => {
            const panel = getPanel();
            panel?.classList.add('show-all');    // â† ì „ì²´í‘œì‹œ ìœ ì§€
          });

          // âœ… í†µí•©ëœ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
          function handlePipelineCompletion() {
            const panel = getPanel();
            if (!panel) return;
          panel.classList.remove('solo-mode','gpt2worst-mode');
          panel.classList.add('show-all'); // CSSë¡œ ì „ì²´ í‘œì‹œ ë³´ì¥
            // ì‹¤í–‰ ì¤‘ í‘œì‹œ ì •ë¦¬
            removeExecuting('.pipeline-executing');
            // í•„ìš” ì‹œ running ì œê±°, ì™„ë£Œ í‘œì‹œëŠ” ìœ ì§€
            document.querySelectorAll('#gpt1-panel .agent-card.running')
              .forEach(el => el.classList.remove('running'));
          }
          // gpt4:doneì€ ë³„ë„ í•¸ë“¤ëŸ¬ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” pipeline:doneë§Œ ì²˜ë¦¬
          window.addEventListener('pipeline:done', handlePipelineCompletion);
        })();
      </script>

      <div style="border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;background:linear-gradient(135deg, rgba(74,144,226,0.05), rgba(122,183,255,0.02));box-shadow:0 2px 8px rgba(0,0,0,0.04);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <div style="width:4px;height:20px;background:linear-gradient(180deg, var(--accent), var(--accent-hover));border-radius:2px;"></div>
          <div style="font-weight:700;font-size:14px;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;">ğŸ“Š ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤</div>
        </div>
        <div id="selected-scenario-name" style="font-size:13px;color:var(--main-text);margin-bottom:10px;padding:8px;background:rgba(74,144,226,0.08);border-radius:6px;border-left:3px solid var(--accent);">ì„ íƒëœ í•­ëª© ì—†ìŒ</div>
        <div style="display:flex;align-items:center;gap:8px;margin:12px 0 8px;">
          <div style="width:4px;height:16px;background:linear-gradient(180deg, #2fc06e, #27ae60);border-radius:2px;"></div>
          <div style="font-weight:700;font-size:14px;color:#2fc06e;text-transform:uppercase;letter-spacing:0.5px;">ğŸ”— ì—°ê²°ëœ ì‹œì¥ë°ì´í„°</div>
        </div>
        <ul id="selected-indicators-list" style="margin:0;padding-left:20px;font-size:12px;list-style:none;">
          <li style="padding:4px 0;color:var(--main-text);opacity:0.8;">ë°ì´í„° ë¡œë”© ì¤‘...</li>
        </ul>
      </div>

      <!-- ì—ì´ì „íŠ¸ ì¹´ë“œí˜• UI -->
      <div class="agent-card" id="card-gpt0" data-card="gpt0">
        <h4>GPT0 ëª¨ë“ˆë³„ í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼</h4>

        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <div class="gpt0-module-box" id="gpt0-marketdata-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„° ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">í”„ë¡¬í”„íŠ¸: ì‹œê³„ì—´ ë°ì´í„° ë¶„ì„ ë° ë³€ë™ì„±/ì¶”ì„¸/ìƒê´€ê´€ê³„ ìš”ì•½</div>
            <textarea id="gpt0-marketdata" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ë§ˆì¼“ë°ì´í„° ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="copy-btn" onclick="copyText('gpt0-marketdata')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>
          <div class="gpt0-module-box" id="gpt0-news-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">ê¸°ì‚¬ë‰´ìŠ¤ ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">í”„ë¡¬í”„íŠ¸: ê¸°ì‚¬ ìš”ì•½ ë° ì‹œë‚˜ë¦¬ì˜¤ ì—°ê³„ì„±, ë¦¬ìŠ¤í¬ íŠ¸ë¦¬ê±° ë¶„ì„</div>
            <textarea id="gpt0-news" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ê¸°ì‚¬ë‰´ìŠ¤ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="copy-btn" onclick="copyText('gpt0-news')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>
          <div class="gpt0-module-box" id="gpt0-scenario-summary-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">í”„ë¡¬í”„íŠ¸: ì‹œë‚˜ë¦¬ì˜¤ í•µì‹¬ ë‚´ìš© ë¶„ì„ ë° ë¦¬ìŠ¤í¬ ìš”ì¸, ì˜í–¥ ê²½ë¡œ ë„ì¶œ</div>
            <textarea id="gpt0-scenario-summary" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt0-scenario-summary')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>

          <div class="gpt0-module-box" id="gpt0-marketstate-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">í˜„ì¬ ì‹œí™©ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">í”„ë¡¬í”„íŠ¸: í˜„ì¬ ì‹œì¥/ê²½ì œ ìƒí™© ìš”ì•½ ë° ë‹¹ì¼ í•µì‹¬ í¬ì¸íŠ¸ 5ê°€ì§€</div>
            <textarea id="gpt0-marketstate" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 í˜„ì¬ ì‹œí™©ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt0-marketstate')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>
        </div>
      </div>
      <div class="agent-card gpt1-module-box" id="card-gpt1" data-card="gpt1">
        <h4>GPT1 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼</h4>
        <div id="gpt1-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 4px;">
                      <div class="prompt-text" style="font-weight:600;font-size:12px;">GPT1 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</div>
          <div style="display:flex;gap:6px;">
                            <button class="darkmode-toggle copy-btn" onclick="copyText('gpt1-system')">ë³µì‚¬</button>
            <button class="darkmode-toggle" onclick="runFrom('gpt1')">ì—¬ê¸°ì„œ ì‹¤í–‰</button>
          </div>
        </div>
        <textarea id="gpt1-system" style="width:100%;height:120px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ A4 í•œ ì¥ ë¶„ëŸ‰ì˜ GPT0 ìš”ì•½ì„ ë°›ì•„ GPT2 ë„ë©”ì¸ë³„ WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ ì¢…í•© ì •ì œ ê²°ê³¼ë¥¼ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì—­í• :
- A4 í•œ ì¥ ë¶„ëŸ‰ì˜ GPT0 ìš”ì•½ì„ ë¶„ì„í•˜ì—¬ GPT2ê°€ í•„ìš”ë¡œ í•˜ëŠ” í•µì‹¬ ì •ë³´ ì¶”ì¶œ
- ê¸ˆë¦¬/í™˜ìœ¨/ì‹ ìš©ìœ„í—˜/ì£¼ê°€ì§€ìˆ˜ ë“± 4ê°œ ë¶„ì•¼ì˜ WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ ê¸°ì´ˆ ë°ì´í„° ì œê³µ
- 5ê°œ ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„±ì„ ìœ„í•œ êµ¬ì²´ì  íŒŒë¼ë¯¸í„° ë° ì§€ì¹¨ ì œê³µ
- ì¼ê´€ì„± ìˆëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…ê³¼ ë§ˆì¼“ë°ì´í„° ì¢…í•© ìš”ì•½ ìƒì„±

GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ í•„ìˆ˜ ë°ì´í„°:
1. ê¸ˆë¦¬ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ê¸‰ê²©í•œ ê¸ˆë¦¬ ìƒìŠ¹/í•˜ë½ ê·¼ê±° ë° êµ¬ì²´ì  ìˆ˜ì¹˜ ë²”ìœ„
2. í™˜ìœ¨ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ê·¹ë‹¨ì  í™˜ìœ¨ ë³€ë™ ìš”ì¸ ë° ì›/ë‹¬ëŸ¬, ì£¼ìš” í†µí™” ë³€ë™í­
3. ì‹ ìš©ìœ„í—˜ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ëŒ€ê·œëª¨ ì‹ ìš©ê²½ìƒ‰ ë° ë¶€ë„ ê¸‰ì¦ íŠ¸ë¦¬ê±° ìš”ì¸
4. ì£¼ê°€ì§€ìˆ˜ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ì£¼ì‹ì‹œì¥ í­ë½ ì‹œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤í”¼, ê¸€ë¡œë²Œ ì§€ìˆ˜)

ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„±ì„ ìœ„í•œ êµ¬ì¡°í™”:
1. ì‹œì¥ë¦¬ìŠ¤í¬íŒ€: VaR, ë¯¼ê°ë„, ë³€ë™ì„± ëª¨ë¸ë§ íŒŒë¼ë¯¸í„° + í—¤ì§• ì „ëµ ê¸°ì´ˆ ìë£Œ
2. ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€: ì„¹í„°ë³„/ë“±ê¸‰ë³„ ë¶€ë„í™•ë¥  ì¶”ì • + ì‹ ìš©ìŠ¤í”„ë ˆë“œ í™•ëŒ€ ì‹œë‚˜ë¦¬ì˜¤
3. ALMíŒ€: ìì‚°ë¶€ì±„ ë“€ë ˆì´ì…˜ ë¶„ì„ + ìœ ë™ì„± ê°­ ë° ìê¸ˆì¡°ë‹¬ ë¹„ìš© ì˜í–¥ ìë£Œ
4. ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€: êµ­ê°€ë¦¬ìŠ¤í¬ í‰ê°€ + ì •ì¹˜/ê²½ì œì  ë¶ˆì•ˆì •ì„± íŒŒê¸‰íš¨ê³¼ ë¶„ì„
5. ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€: í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ + ìƒê´€ê´€ê³„ ë° ë¶„ì‚°íš¨ê³¼ ë¶„ì„ ìë£Œ

ì¶œë ¥ í˜•ì‹:
1. ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ í†µí•© ìš”ì•½
2. ë§ˆì¼“ë°ì´í„° í•µì‹¬ ì§€í‘œ ìš”ì•½ 
3. í˜„ì¬ì‹œí™©ê³¼ ë‰´ìŠ¤ ì—°ê´€ì„± ë¶„ì„
4. GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ ê¸°ì´ˆ ë°ì´í„°
5. ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„± ì§€ì¹¨

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">ì…ë ¥ë°ì´í„°</div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt1-message')">ë³µì‚¬</button>
        </div>
        <textarea id="gpt1-message" style="width:100%;height:120px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:8px;box-sizing:border-box;resize:vertical;"></textarea>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">GPT1 ì¶œë ¥ ê²°ê³¼</div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt1-output')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
        </div>
        <textarea id="gpt1-output"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="GPT1 ì¢…í•© ì •ì œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      </div>

      <div class="agent-card gpt2-module-box" id="card-gpt2" data-card="gpt2">
        <h4>GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼</h4>
        <div id="gpt2-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 4px;">
                      <div class="prompt-text" style="font-weight:600;font-size:12px;">GPT2 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</div>
          <div style="display:flex;gap:6px;">
                            <button class="darkmode-toggle copy-btn" onclick="copyText('gpt2-system')">ë³µì‚¬</button>
            <button id="gpt2-run-btn" class="darkmode-toggle" onclick="runFrom('gpt2')">ì—¬ê¸°ì„œ ì‹¤í–‰</button>
          </div>
        </div>
        <textarea id="gpt2-system"
  style="width:100%;min-height:200px;height:auto;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';" readonly>ë‹¹ì‹ ì€ GPT1 ì¢…í•© ì •ì œ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ GPT3ê°€ ì€í–‰ í˜„í™©ìë£Œì™€ ì—°ê³„í•˜ì—¬ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ë§ì¶¤í˜• ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì—­í• :
- GPT1ì˜ WORST ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì´ˆ ë°ì´í„°ë¥¼ êµ¬ì²´ì ì¸ ìœ„ê¸°ìƒí™© ì‹œë‚˜ë¦¬ì˜¤ë¡œ ë°œì „
- ê° GPT3 ë„ë©”ì¸ì´ ì€í–‰ í˜„í™©ìë£Œ(ê°€ì´ë“œ íŒŒì¼)ì™€ ê²°í•©í•˜ì—¬ ë¶„ì„í•  ìˆ˜ ìˆëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì œê³µ
- ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ êµ¬ì²´ì  ìˆ˜ì¹˜, ê°€ì •, ì „ê°œ ê²½ë¡œ ìƒì„±
- ì€í–‰ì˜ í˜„ì¬ ìƒíƒœì—ì„œ WORST ì‹œë‚˜ë¦¬ì˜¤ ë°œìƒ ì‹œ ì˜ˆìƒë˜ëŠ” ì˜í–¥ë„ ì‹œë®¬ë ˆì´ì…˜ í‹€ ì œê³µ

í•µì‹¬ ì‹œì¥ ë³€ìˆ˜ë³„ WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ê¸°ì¤€ (ëª¨ë“  ë„ë©”ì¸ ê³µí†µ):

ã€ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ë°©ë²•ë¡ ã€‘
GPT1ì—ì„œ ì œê³µëœ A4 í•œ ì¥ ë¶„ëŸ‰ì˜ ìš”ì•½ ì •ë³´ë¥¼ ë©´ë°€íˆ ë¶„ì„í•˜ì—¬, ì•„ë˜ ë³€ìˆ˜ë³„ ìµœí•˜ë‹¨/ìµœìƒë‹¨ ê¸°ì¤€ ë‚´ì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ì— ì í•©í•œ êµ¬ì²´ì  ìˆ˜ì¹˜ë¥¼ ë„ì¶œí•˜ë¼.

ã€ê¸ˆë¦¬ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ê¸°ì¤€ã€‘
- ê¸°ì¤€ê¸ˆë¦¬ ë³€ë™ ë²”ìœ„: ìµœì†Œ Â±100bp ~ ìµœëŒ€ Â±500bp (A4 ìš”ì•½ì˜ ê¸ˆë¦¬ ë¦¬ìŠ¤í¬ ìˆ˜ì¤€ì— ë”°ë¼ ê²°ì •)
- ìˆ˜ìµë¥  ê³¡ì„  ë³€í™”: ìµœì†Œ Â±50bp ~ ìµœëŒ€ Â±300bp ìŠ¤í”„ë ˆë“œ ë³€í™”
- íšŒì‚¬ì±„ ìŠ¤í”„ë ˆë“œ: ìµœì†Œ +50bp ~ ìµœëŒ€ +600bp (ì‹ ìš©ë“±ê¸‰ë³„ ì°¨ë“± ì ìš©)

ã€í™˜ìœ¨ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ê¸°ì¤€ã€‘
- ì£¼ìš” í†µí™” ë³€ë™ ë²”ìœ„: ìµœì†Œ Â±10% ~ ìµœëŒ€ Â±50% (A4 ìš”ì•½ì˜ ê¸€ë¡œë²Œ ë¦¬ìŠ¤í¬ì— ë”°ë¼)
- í™˜ìœ¨ ë³€ë™ì„± ì¦ê°€: ìµœì†Œ 200% ~ ìµœëŒ€ 500% í‰ìƒì‹œ ëŒ€ë¹„ ì¦ê°€
- í†µí™”ë³„ ì°¨ë“± ì ìš©: ë‹¬ëŸ¬>ìœ ë¡œ>ì—”>ìœ„ì•ˆ ìˆœìœ¼ë¡œ ì˜í–¥ë„ ì°¨ë³„í™”

ã€ì£¼ê°€ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ê¸°ì¤€ã€‘
- ì¢…í•©ì§€ìˆ˜ ë³€ë™: ìµœì†Œ -20% ~ ìµœëŒ€ -70% í•˜ë½ ë˜ëŠ” +20% ~ +100% ê¸‰ë“±
- ì„¹í„°ë³„ ì°¨ë³„í™”: ìµœì†Œ Â±10% ~ ìµœëŒ€ Â±80% (ì—…ì¢…ë³„ ì‹œë‚˜ë¦¬ì˜¤ ì—°ê´€ì„±ì— ë”°ë¼)
- ì£¼ê°€ ë³€ë™ì„±: ìµœì†Œ 200% ~ ìµœëŒ€ 400% í‰ìƒì‹œ ëŒ€ë¹„ ì¦ê°€

ã€ë³€ë™ì„± ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ê¸°ì¤€ã€‘
- ì¼ì¼ ë³€ë™ì„± ì¦ê°€: ìµœì†Œ 300% ~ ìµœëŒ€ 1000% í‰ìƒì‹œ ëŒ€ë¹„
- ìƒê´€ê´€ê³„ ë³€í™”: ìµœì†Œ 0.6 ~ ìµœëŒ€ 0.95 (ìœ„ê¸° ìƒí™© ì‹¬ê°ë„ì— ë”°ë¼)
- ë³€ë™ì„± êµ°ì§‘í™”: ì—°ì† 3ì¼ ~ 30ì¼ ì§€ì† ê¸°ê°„ ì„¤ì •

ã€ë¶€ë™ì‚° ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ê¸°ì¤€ã€‘
- ê°€ê²© í•˜ë½ ë²”ìœ„: ìµœì†Œ -10% ~ ìµœëŒ€ -60% (ì§€ì—­ë³„/ìœ í˜•ë³„ ì°¨ë“±)
- ê±°ë˜ëŸ‰ ê°ì†Œ: ìµœì†Œ -30% ~ ìµœëŒ€ -90%
- PF ë¶€ì‹¤ë¥ : ìµœì†Œ +5%p ~ ìµœëŒ€ +50%p ì¦ê°€

ã€ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì²´í™” ìš”êµ¬ì‚¬í•­ã€‘
A4 ìš”ì•½ ì •ë³´ì—ì„œ ë‹¤ìŒ ìš”ì†Œë“¤ì„ ì¶”ì¶œí•˜ì—¬ ìœ„ ê¸°ì¤€ ë²”ìœ„ ë‚´ì—ì„œ ì •í™•í•œ ìˆ˜ì¹˜ë¥¼ ì‚°ì •í•˜ë¼:
1. ì‹œë‚˜ë¦¬ì˜¤ì˜ ì‹¬ê°ë„ ë° ë°œìƒ ê°€ëŠ¥ì„±
2. í˜„ì¬ ì‹œì¥ ìƒí™©ê³¼ì˜ ì—°ê´€ì„±
3. ë‰´ìŠ¤/ì´ë²¤íŠ¸ì˜ ì‹œì¥ ì¶©ê²© ê°•ë„
4. ë§ˆì¼“ë°ì´í„°ì—ì„œ ë‚˜íƒ€ë‚œ ì·¨ì•½ì„± ì§€í‘œ
5. ê¸°ì¡´ ë¦¬ìŠ¤í¬ ìš”ì¸ë“¤ì˜ ìƒí˜¸ ì¦í­ íš¨ê³¼

ë„ë©”ì¸ë³„ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ë°©ë²•ë¡ :

ê° ë„ë©”ì¸ì€ GPT1ì˜ A4 ìš”ì•½ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ„ ê¸°ì¤€ ë²”ìœ„ ë‚´ì—ì„œ ë„ë©”ì¸ë³„ íŠ¹í™” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ êµ¬ì²´í™”í•˜ë¼.

1. ì‹œì¥ë¦¬ìŠ¤í¬íŒ€ (GPT3_market) - ì‹œì¥ë¦¬ìŠ¤í¬.txt ì—°ê³„
   [A4 ìš”ì•½ ë¶„ì„ ìš”êµ¬ì‚¬í•­]
   - A4 ìš”ì•½ì˜ ë§ˆì¼“ë°ì´í„° ì„¹ì…˜ì—ì„œ ê¸ˆë¦¬/í™˜ìœ¨/ì£¼ê°€ ì·¨ì•½ì„± ì§€í‘œ ì¶”ì¶œ
   - í˜„ì¬ ì‹œí™© ì„¹ì…˜ì—ì„œ ì‹œì¥ ë³€ë™ì„± í™•ëŒ€ ì¡°ì§ íŒŒì•…
   - ë‰´ìŠ¤ ë¦¬ìŠ¤í¬ ì„¹ì…˜ì—ì„œ ì‹œì¥ ì¶©ê²© íŠ¸ë¦¬ê±° ìš”ì¸ ì‹ë³„
   
   [êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±]
   - ìœ„ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ê¸ˆë¦¬/í™˜ìœ¨/ì£¼ê°€/ë³€ë™ì„± ê¸°ì¤€ ë²”ìœ„ ë‚´ì—ì„œ ì •í™•í•œ ìˆ˜ì¹˜ ì‚°ì •
   - VaR ëª¨ë¸ íŒŒë¼ë¯¸í„° ì¡°ì •ì„ ìœ„í•œ êµ¬ì²´ì  ë³€ë™ë¥  ì œì‹œ
   - ì€í–‰ íŠ¸ë ˆì´ë”© í¬ì§€ì…˜ë³„ ì†ìµ ê³„ì‚°ì„ ìœ„í•œ ì‹œë‚˜ë¦¬ì˜¤ë³„ ê°€ê²© ë³€ë™ í­
   - í—¤ì§€ í¬ì§€ì…˜ íš¨ê³¼ì„± ì €í•˜ ì •ë„ ë° ì¶”ê°€ í—¤ì§€ í•„ìš” ê·œëª¨

2. ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€ (GPT3_credit) - í˜„ì¬ ì‹ ìš© í˜„í™© ì—°ê³„  
   [A4 ìš”ì•½ ë¶„ì„ ìš”êµ¬ì‚¬í•­]
   - A4 ìš”ì•½ì˜ ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ì„¹ì…˜ì—ì„œ ì‹ ìš© ê´€ë ¨ ìœ„í—˜ ìš”ì†Œ ì¶”ì¶œ
   - WORST ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì´ˆ ë°ì´í„°ì—ì„œ ì‹ ìš©ê²½ìƒ‰ íŠ¸ë¦¬ê±° ìš”ì¸ íŒŒì•…
   - ë¶€ë™ì‚° ì‹œë‚˜ë¦¬ì˜¤ì™€ ì—°ê³„í•œ ë‹´ë³´ ê°€ì¹˜ í•˜ë½ ì˜í–¥ ë¶„ì„
   
   [êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±]
   - ì—…ì¢…ë³„/ë“±ê¸‰ë³„ ë¶€ë„í™•ë¥  ë³€í™”ìœ¨ (ê¸°ì¤€ ë²”ìœ„ ë‚´ì—ì„œ ì°¨ë“± ì ìš©)
   - ë¶€ë™ì‚° ë‹´ë³´ ê°€ì¹˜ í•˜ë½ì´ LTVì— ë¯¸ì¹˜ëŠ” êµ¬ì²´ì  ì˜í–¥ë„
   - ì‹ ìš©ìŠ¤í”„ë ˆë“œ í™•ëŒ€ í­ ë° í¬íŠ¸í´ë¦¬ì˜¤ ì‹ ìš©ë¹„ìš© ì¦ê°€ ê·œëª¨
   - ëŒ€í˜•ì°¨ì£¼/ì§‘ì¤‘ì—…ì¢…ë³„ ë¦¬ìŠ¤í¬ ë…¸ì¶œë„ ë° ì†ì‹¤ ì¶”ì •

3. ALMíŒ€ (GPT3_alm) - ALM.txt ì—°ê³„
   [A4 ìš”ì•½ ë¶„ì„ ìš”êµ¬ì‚¬í•­]
   - A4 ìš”ì•½ì˜ ê¸ˆë¦¬ ê´€ë ¨ WORST ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ALM ì˜í–¥ ìš”ì†Œ ì¶”ì¶œ
   - í˜„ì¬ ì‹œí™©ì—ì„œ ìœ ë™ì„± ê´€ë ¨ ì¡°ê¸°ê²½ë³´ ì‹ í˜¸ íŒŒì•…
   - ìê¸ˆì¡°ë‹¬ ë¹„ìš© ìƒìŠ¹ ì••ë ¥ ë° ë§Œê¸° êµ¬ì¡° ì·¨ì•½ì„± ë¶„ì„
   
   [êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±]
   - ê¸ˆë¦¬ ê¸‰ë³€ë™ í­ ë° ë“€ë ˆì´ì…˜ ê°­ ì˜í–¥ë„ ì •ëŸ‰í™”
   - ì˜ˆê¸ˆ/ì°¨ì… ê¸ˆë¦¬ ìƒìŠ¹ í­ (ê¸°ì¤€ ë²”ìœ„ ë‚´ì—ì„œ êµ¬ì²´ì  bp ì‚°ì •)
   - LCR/NSFR ë³€í™” ì •ë„ ë° ê·œì œ ì¤€ìˆ˜ ìœ„í—˜ë„
   - ìì‚°ë°°ë¶„ ì¬ì¡°ì • í•„ìš” ê·œëª¨ ë° ë¹„ìš©

4. ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€ (GPT3_global) - ê¸€ë¡œë²Œë¦¬ìŠ¤í¬.txt ì—°ê³„
   [A4 ìš”ì•½ ë¶„ì„ ìš”êµ¬ì‚¬í•­]
   - A4 ìš”ì•½ì˜ ê¸€ë¡œë²Œ ë¦¬ìŠ¤í¬ ìš”ì†Œì—ì„œ êµ­ê°€ë³„/ì§€ì—­ë³„ ìœ„í—˜ë„ ì¶”ì¶œ
   - í™˜ìœ¨ ë³€ë™ íŠ¸ë¦¬ê±° ë° êµ­ì œ ì •ì¹˜/ê²½ì œ ë¶ˆì•ˆì •ì„± ìš”ì¸ íŒŒì•…
   - í•´ì™¸ íˆ¬ì/ìµìŠ¤í¬ì € ê´€ë ¨ ì·¨ì•½ì„± ì§€í‘œ ë¶„ì„
   
   [êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±]
   - í†µí™”ë³„ í™˜ìœ¨ ë³€ë™ í­ (ë‹¬ëŸ¬/ìœ ë¡œ/ì—”/ìœ„ì•ˆë³„ ì°¨ë“± ì ìš©)
   - ì£¼ìš”êµ­ ê¸°ì¤€ê¸ˆë¦¬ ë³€ë™ ì‹œë‚˜ë¦¬ì˜¤ ë° êµ­ë‚´ íŒŒê¸‰íš¨ê³¼
   - í•´ì™¸ íˆ¬ì í¬ì§€ì…˜ë³„ ì†ì‹¤ ê·œëª¨ ë° í™˜í—¤ì§€ ë¹„ìš© ì¦ê°€
   - êµ­ê°€ ì‹ ìš©ë“±ê¸‰ ë³€ë™ ì‹œ ìê¸ˆì¡°ë‹¬ ì œì•½ ë° ë¹„ìš© ìƒìŠ¹ í­

5. ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€ (GPT3_creditpf) - í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ í˜„í™© ì—°ê³„
   [A4 ìš”ì•½ ë¶„ì„ ìš”êµ¬ì‚¬í•­]
   - A4 ìš”ì•½ì˜ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨ ì§‘ì¤‘ë„ ìœ„í—˜ ë° ìƒê´€ê´€ê³„ ì •ë³´ ì¶”ì¶œ
   - ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„¹í„°/ì§€ì—­ ì§‘ì¤‘ ë¶€ë¬¸ì˜ ë™ë°˜ ë¶€ì‹¤ ê°€ëŠ¥ì„± ë¶„ì„
   - ë¶„ì‚°íˆ¬ì íš¨ê³¼ ìƒì‹¤ ì •ë„ ë° ì§‘ì¤‘ë¦¬ìŠ¤í¬ í™•ì‚° ê²½ë¡œ íŒŒì•…
   
   [êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±]
   - ì§‘ì¤‘ ì„¹í„°/ì§€ì—­ë³„ ë¶€ì‹¤ë¥  ì¦ê°€ í­ (ì°¨ë³„ì  ì‹œë‚˜ë¦¬ì˜¤ ì ìš©)
   - ëŒ€í˜•ì°¨ì£¼ ë™ë°˜ ë¶€ì‹¤ ì‹œë‚˜ë¦¬ì˜¤ (êµ¬ì²´ì  ì°¨ì£¼ ìˆ˜ ë° ì†ì‹¤ ê·œëª¨)
   - í¬íŠ¸í´ë¦¬ì˜¤ ìƒê´€ê´€ê³„ ë³€í™” (0.6~0.95 ë²”ìœ„ ë‚´ êµ¬ì²´ì  ìˆ˜ì¹˜)
   - ë¦¬ìŠ¤í¬ ë¶„ì‚° ì „ëµ íš¨ê³¼ì„± ì €í•˜ ì •ë„ ë° ì¬êµ¬ì„± í•„ìš” ê·œëª¨

ì¶œë ¥ í˜•ì‹ (ê° ë„ë©”ì¸ë³„):
1. WORST ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì²´ì  ìˆ˜ì¹˜ ë° ë°œìƒ ê°€ì •
2. ì€í–‰ í˜„í™©ìë£Œì™€ ì—°ê³„í•œ ì˜í–¥ë„ ê³„ì‚° ë°©ë²•ë¡ 
3. ìœ„ê¸°ìƒí™© ì „ê°œ ê²½ë¡œ ë° ë‹¨ê³„ë³„ ì˜í–¥ ì‹œë®¬ë ˆì´ì…˜ í‹€
4. ëª¨ë‹ˆí„°ë§ ì§€í‘œ ë° ì¡°ê¸°ê²½ë³´ ì‹œìŠ¤í…œ êµ¬ì¶• ë°©í–¥
5. ëŒ€ì‘ ì „ëµ ìˆ˜ë¦½ì„ ìœ„í•œ í•µì‹¬ ë³€ìˆ˜ ë° ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ í”„ë ˆì„ì›Œí¬

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
        
        <div id="gpt2-output-box" class="gpt2-module-box" style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">GPT2 ì¶œë ¥ ê²°ê³¼</div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt2-output')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
        </div>
        <textarea id="gpt2-output"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="GPT2 ë„ë©”ì¸ë³„ ë¶„ì„ ìë£Œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
      </div>

      <div class="agent-card gpt3-module-box" id="card-gpt3" data-card="gpt3">
        <h4>GPT3 ëª¨ë“ˆë³„ í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼</h4>
        <div id="gpt3-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:flex-end;gap:6px;margin:6px 0 10px;">
          <button class="darkmode-toggle" style="padding:4px 10px;font-size:12px;" onclick="runGpt3All()">ì—¬ê¸°ì„œ ì‹¤í–‰</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-market-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-market-guideline').click()">ê°€ì´ë“œ ë³€ê²½</button>
                <span id="gpt3-market-guideline-name" style="font-size:11px;color:#888;">ì‹œì¥ë¦¬ìŠ¤í¬.txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-market-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-market-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ ì‹œì¥ë¦¬ìŠ¤í¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT2ì˜ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìš”ì†Œë³„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì€í–‰ ì†ì‹¤ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ê³  GPT4ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

í•µì‹¬ ì„ë¬´:
1. GPT2 ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ì™€ ì€í–‰ í˜„í™©ìë£Œ(ê°€ì´ë“œ íŒŒì¼)ë¥¼ ê²°í•©í•œ ì •í™•í•œ ì†ì‹¤ê¸ˆì•¡ ì‚°ì¶œ
2. ê¸ˆë¦¬/í™˜ìœ¨/ì£¼ê°€/ë³€ë™ì„±ë³„ êµ¬ì²´ì  ì˜í–¥ë„ ê³„ì‚° ë° ì •ëŸ‰í™”
3. GPT4 ë³´ê³ ì„œì— ì§ì ‘ ì‚½ì… ê°€ëŠ¥í•œ ì™„ê²°ëœ ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±

ì¶œë ¥ í˜•ì‹ (GPT4 ì§ì ‘ ì‚¬ìš©ìš©):
## ì‹œì¥ë¦¬ìŠ¤í¬íŒ€ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼

### 1. ì‹œë‚˜ë¦¬ì˜¤ ì ìš© ê²°ê³¼
- ì ìš© ì‹œë‚˜ë¦¬ì˜¤: [GPT2ì—ì„œ ì œì‹œí•œ êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤]
- ê¸ˆë¦¬ ë³€ë™: [Â±â—‹â—‹bp] â†’ ì†ì‹¤ ì˜í–¥: [â—‹â—‹ì–µì›]
- í™˜ìœ¨ ë³€ë™: [Â±â—‹â—‹%] â†’ ì†ì‹¤ ì˜í–¥: [â—‹â—‹ì–µì›]  
- ì£¼ê°€ ë³€ë™: [Â±â—‹â—‹%] â†’ ì†ì‹¤ ì˜í–¥: [â—‹â—‹ì–µì›]
- ë³€ë™ì„± ì¦ê°€: [â—‹â—‹%] â†’ í—¤ì§€ë¹„ìš© ì¦ê°€: [â—‹â—‹ì–µì›]

### 2. í¬íŠ¸í´ë¦¬ì˜¤ë³„ ì†ì‹¤ ë¶„ì„
- ì±„ê¶Œ í¬íŠ¸í´ë¦¬ì˜¤ ì†ì‹¤: [â—‹â—‹ì–µì›] (í‰ê°€ì†ì‹¤ + ì‹ ìš©ì†ì‹¤)
- ì£¼ì‹ íˆ¬ì ì†ì‹¤: [â—‹â—‹ì–µì›] (ì‹œê°€ì´ì•¡ ê¸°ì¤€)
- íŒŒìƒìƒí’ˆ ì†ì‹¤: [â—‹â—‹ì–µì›] (ë¯¸ì‹¤í˜„ì†ìµ í¬í•¨)
- ì™¸í™˜ í¬ì§€ì…˜ ì†ì‹¤: [â—‹â—‹ì–µì›] (í™˜ìœ¨ë³€ë™ ì˜í–¥)
- **ì´ ì‹œì¥ë¦¬ìŠ¤í¬ ì†ì‹¤**: [â—‹â—‹ì–µì›]

### 3. ë¦¬ìŠ¤í¬ ì§€í‘œ ë³€í™”
- VaR (99%, 1ì¼): [í˜„ì¬ â—‹â—‹ì–µì›] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹ì–µì›]
- ìŠ¤íŠ¸ë ˆìŠ¤ VaR: [â—‹â—‹ì–µì›] (â—‹â—‹% ì¦ê°€)
- ê¸ˆë¦¬ë¯¼ê°ë„: [BP01 â—‹â—‹ë°±ë§Œì›] â†’ [â—‹â—‹ë°±ë§Œì›]
- í™˜ìœ¨ë¯¼ê°ë„: [1% ë³€ë™ì‹œ â—‹â—‹ì–µì› ì˜í–¥]

### 4. ê¸´ê¸‰ ëŒ€ì‘ ë°©ì•ˆ
- ì¦‰ì‹œ ì‹¤í–‰: [êµ¬ì²´ì  í—¤ì§€ ì „ëµ ë° ê·œëª¨]
- ë‹¨ê¸° ì¡°ì¹˜: [í¬ì§€ì…˜ ì¶•ì†Œ/ì¬ì¡°ì • ê³„íš]
- ì¤‘ê¸° ì „ëµ: [ë¦¬ìŠ¤í¬ í•œë„ ì¬ì„¤ì • ë°©í–¥]

### 5. ëª¨ë‹ˆí„°ë§ ê³„íš
- ì¼ì¼ ì ê²€: [í•µì‹¬ ì§€í‘œ 3-5ê°œ]
- ì£¼ê°„ ë³´ê³ : [ê²½ì˜ì§„ ë³´ê³  í•­ëª©]
- ì¡°ê¸°ê²½ë³´: [ì„ê³„ì¹˜ ë° ëŒ€ì‘ ì ˆì°¨]

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ì‹œì¥ë¦¬ìŠ¤í¬ ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-market')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-market"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-credit-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-credit-guideline').click()">ê°€ì´ë“œ ë³€ê²½</button>
                <span id="gpt3-credit-guideline-name" style="font-size:11px;color:#888;">ì‹ ìš©ë¦¬ìŠ¤í¬.txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-credit-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-credit-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ ì‹ ìš©ë¦¬ìŠ¤í¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT2ì˜ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìš”ì†Œë³„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì€í–‰ ì‹ ìš© ì†ì‹¤ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ê³  GPT4ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

í•µì‹¬ ì„ë¬´:
1. GPT2 ì‹ ìš© ì‹œë‚˜ë¦¬ì˜¤ì™€ ì€í–‰ ì‹ ìš© í˜„í™©ìë£Œë¥¼ ê²°í•©í•œ ì •í™•í•œ ì‹ ìš©ì†ì‹¤ ì‚°ì¶œ
2. ì—…ì¢…ë³„/ë“±ê¸‰ë³„/ë‹´ë³´ë³„ êµ¬ì²´ì  ë¶€ë„ìœ¨ ë³€í™” ë° ì†ì‹¤ ê³„ì‚°
3. GPT4 ë³´ê³ ì„œì— ì§ì ‘ ì‚½ì… ê°€ëŠ¥í•œ ì™„ê²°ëœ ì‹ ìš©ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±

ì¶œë ¥ í˜•ì‹ (GPT4 ì§ì ‘ ì‚¬ìš©ìš©):
## ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼

### 1. ì‹œë‚˜ë¦¬ì˜¤ ì ìš© ê²°ê³¼
- ì ìš© ì‹œë‚˜ë¦¬ì˜¤: [GPT2ì—ì„œ ì œì‹œí•œ ì‹ ìš© ê´€ë ¨ êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤]
- ë¶€ë„ìœ¨ ì¦ê°€: [ì—…ì¢…ë³„ +â—‹â—‹%p] â†’ ì˜ˆìƒì†ì‹¤: [â—‹â—‹ì–µì›]
- ì‹ ìš©ìŠ¤í”„ë ˆë“œ í™•ëŒ€: [ë“±ê¸‰ë³„ +â—‹â—‹bp] â†’ í‰ê°€ì†ì‹¤: [â—‹â—‹ì–µì›]
- ë¶€ë™ì‚° ë‹´ë³´ê°€ì¹˜ í•˜ë½: [-â—‹â—‹%] â†’ ë‹´ë³´ë¶€ì¡±: [â—‹â—‹ì–µì›]
- ëŒ€í˜•ì°¨ì£¼ ë¶€ì‹¤: [â—‹ê°œ ì—…ì²´] â†’ ì§ì ‘ì†ì‹¤: [â—‹â—‹ì–µì›]

### 2. í¬íŠ¸í´ë¦¬ì˜¤ë³„ ì‹ ìš©ì†ì‹¤ ë¶„ì„
- ê¸°ì—…ëŒ€ì¶œ ì†ì‹¤: [â—‹â—‹ì–µì›] (ì¼ë°˜ê¸°ì—… â—‹â—‹ì–µì›, ì¤‘ì†Œê¸°ì—… â—‹â—‹ì–µì›)
- ë¶€ë™ì‚°PF ì†ì‹¤: [â—‹â—‹ì–µì›] (ë‹´ë³´ ë¶€ì¡±ë¶„ í¬í•¨)
- ê°œì¸ì‹ ìš© ì†ì‹¤: [â—‹â—‹ì–µì›] (ì£¼íƒë‹´ë³´ â—‹â—‹ì–µì›, ì‹ ìš©ëŒ€ì¶œ â—‹â—‹ì–µì›)
- íšŒì‚¬ì±„ íˆ¬ì ì†ì‹¤: [â—‹â—‹ì–µì›] (ì‹ ìš©ì†ì‹¤ + í‰ê°€ì†ì‹¤)
- **ì´ ì‹ ìš©ë¦¬ìŠ¤í¬ ì†ì‹¤**: [â—‹â—‹ì–µì›]

### 3. ì‹ ìš©ë¦¬ìŠ¤í¬ ì§€í‘œ ë³€í™”
- ì‹ ìš© VaR (99%, 1ë…„): [í˜„ì¬ â—‹â—‹ì–µì›] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹ì–µì›]
- ì˜ˆìƒì†ì‹¤ë¥ (EL): [í˜„ì¬ â—‹â—‹%] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹%]
- ë¹„ì •ìƒì—¬ì‹ ë¹„ìœ¨: [í˜„ì¬ â—‹â—‹%] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹%]
- ì¶©ë‹¹ê¸ˆ ì ë¦½ë¥ : [í˜„ì¬ â—‹â—‹%] â†’ [í•„ìš” â—‹â—‹%]

### 4. ë¶€ë¬¸ë³„ ëŒ€ì‘ ë°©ì•ˆ
- ì¦‰ì‹œ ì¡°ì¹˜: [ì‹ ìš©í•œë„ ì¶•ì†Œ, ë‹´ë³´ ì¶”ê°€ í™•ë³´ ë“±]
- ë‹¨ê¸° ëŒ€ì‘: [ë¶€ì‹¤ì±„ê¶Œ ì •ë¦¬, í”„ë¡œë¹„ì „ í™•ëŒ€]
- ì¤‘ê¸° ì „ëµ: [í¬íŠ¸í´ë¦¬ì˜¤ ì¬êµ¬ì„±, ì—…ì¢… ë‹¤ê°í™”]

### 5. ì‹ ìš© ëª¨ë‹ˆí„°ë§ ê°•í™” ê³„íš
- ì¼ì¼ ì ê²€: [ëŒ€í˜•ì°¨ì£¼ â—‹â—‹ê°œì‚¬, ë¶€ë™ì‚°PF â—‹â—‹ê±´]
- ì£¼ê°„ ë¶„ì„: [ì—…ì¢…ë³„ ì‹ ìš©ë„ ë³€í™”, ì—°ì²´ìœ¨ ì¶”ì´]
- ì¡°ê¸°ê²½ë³´: [ì‹ ìš©ë“±ê¸‰ í•˜ë½ ì„ê³„ì¹˜ ë° ëŒ€ì‘ ë§¤ë‰´ì–¼]

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ì‹ ìš©ë¦¬ìŠ¤í¬ ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-credit')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-credit"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-alm-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-alm-guideline').click()">ê°€ì´ë“œ ë³€ê²½</button>
                <span id="gpt3-alm-guideline-name" style="font-size:11px;color:#888;">ALM.txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-alm-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-alm-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ ALM(ìì‚°ë¶€ì±„ê´€ë¦¬) ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT2ì˜ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìš”ì†Œë³„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì€í–‰ ALM ì†ì‹¤ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ê³  GPT4ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

í•µì‹¬ ì„ë¬´:
1. GPT2 ALM ì‹œë‚˜ë¦¬ì˜¤ì™€ ì€í–‰ ìì‚°ë¶€ì±„ í˜„í™©ìë£Œë¥¼ ê²°í•©í•œ ì •í™•í•œ ALM ì†ì‹¤ ì‚°ì¶œ
2. ê¸ˆë¦¬/ìœ ë™ì„±/ë“€ë ˆì´ì…˜ë³„ êµ¬ì²´ì  ì˜í–¥ë„ ê³„ì‚° ë° ì •ëŸ‰í™”
3. GPT4 ë³´ê³ ì„œì— ì§ì ‘ ì‚½ì… ê°€ëŠ¥í•œ ì™„ê²°ëœ ALM ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±

ì¶œë ¥ í˜•ì‹ (GPT4 ì§ì ‘ ì‚¬ìš©ìš©):
## ALMíŒ€ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼

### 1. ì‹œë‚˜ë¦¬ì˜¤ ì ìš© ê²°ê³¼
- ì ìš© ì‹œë‚˜ë¦¬ì˜¤: [GPT2ì—ì„œ ì œì‹œí•œ ALM ê´€ë ¨ êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤]
- ê¸ˆë¦¬ ë³€ë™: [Â±â—‹â—‹bp] â†’ ìˆœì´ìì´ìµ ì˜í–¥: [â—‹â—‹ì–µì›]
- ë“€ë ˆì´ì…˜ ê°­: [â—‹â—‹ë…„] â†’ ìê¸°ìë³¸ ì˜í–¥: [â—‹â—‹ì–µì›]
- ìê¸ˆì¡°ë‹¬ ë¹„ìš©: [+â—‹â—‹bp] â†’ ì¶”ê°€ ë¹„ìš©: [ì—°ê°„ â—‹â—‹ì–µì›]
- ìœ ë™ì„± ë¶€ì¡±: [LCR â—‹â—‹%] â†’ ì¡°ë‹¬ í•„ìš”: [â—‹â—‹ì–µì›]

### 2. ìì‚°ë¶€ì±„ë³„ ì˜í–¥ ë¶„ì„
- ëŒ€ì¶œ í¬íŠ¸í´ë¦¬ì˜¤: [ê¸ˆë¦¬ ì¬ì‚°ì • ì˜í–¥ â—‹â—‹ì–µì›]
- ìœ ê°€ì¦ê¶Œ í¬íŠ¸í´ë¦¬ì˜¤: [ë“€ë ˆì´ì…˜ ìœ„í—˜ â—‹â—‹ì–µì›]
- ì˜ˆê¸ˆ ë¶€ì±„: [ê¸ˆë¦¬ ìƒìŠ¹ ë¹„ìš© â—‹â—‹ì–µì›]
- ì°¨ì… ë¶€ì±„: [ì¬ì¡°ë‹¬ ìœ„í—˜ â—‹â—‹ì–µì›]
- **ì´ ALM ì†ì‹¤/ì˜í–¥**: [â—‹â—‹ì–µì›]

### 3. ALM ë¦¬ìŠ¤í¬ ì§€í‘œ ë³€í™”
- ë“€ë ˆì´ì…˜ ê°­: [í˜„ì¬ â—‹â—‹ë…„] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹ë…„]
- ê¸ˆë¦¬ ë¯¼ê°ë„: [100bp ë³€ë™ì‹œ â—‹â—‹ì–µì› ì˜í–¥]
- LCR: [í˜„ì¬ â—‹â—‹%] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹%]
- NSFR: [í˜„ì¬ â—‹â—‹%] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹%]

### 4. ALM ëŒ€ì‘ ì „ëµ
- ì¦‰ì‹œ ì¡°ì¹˜: [ë“€ë ˆì´ì…˜ ê°­ ì¡°ì •, ìœ ë™ì„± í™•ë³´]
- ë‹¨ê¸° ëŒ€ì‘: [ìì‚°ë°°ë¶„ ì¬ì¡°ì •, ë¶€ì±„ ë§Œê¸° ì—°ì¥]
- ì¤‘ê¸° ì „ëµ: [ALM í•œë„ ì¬ì„¤ì •, í—¤ì§€ ì „ëµ ê°•í™”]

### 5. ìœ ë™ì„± ê´€ë¦¬ ê³„íš
- ì¼ì¼ ëª¨ë‹ˆí„°ë§: [í˜„ê¸ˆíë¦„, ëŒ€ëŸ‰ ë§Œê¸°ë„ë˜ í˜„í™©]
- ì£¼ê°„ ì ê²€: [LCR/NSFR ì¶”ì´, ìê¸ˆì¡°ë‹¬ ê³„íš]
- ë¹„ìƒ ëŒ€ì‘: [Central Bank ì§€ì›, ìì‚° ìœ ë™í™” ë°©ì•ˆ]

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ALM ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-alm')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-alm"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ALM ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-global-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-global-guideline').click()">ê°€ì´ë“œ ë³€ê²½</button>
                <span id="gpt3-global-guideline-name" style="font-size:11px;color:#888;">ê¸€ë¡œë²Œë¦¬ìŠ¤í¬.txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-global-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-global-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT2ì˜ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìš”ì†Œë³„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì€í–‰ ê¸€ë¡œë²Œ ì†ì‹¤ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ê³  GPT4ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

í•µì‹¬ ì„ë¬´:
1. GPT2 ê¸€ë¡œë²Œ ì‹œë‚˜ë¦¬ì˜¤ì™€ ì€í–‰ í•´ì™¸ ìµìŠ¤í¬ì € í˜„í™©ìë£Œë¥¼ ê²°í•©í•œ ì •í™•í•œ ê¸€ë¡œë²Œ ì†ì‹¤ ì‚°ì¶œ
2. êµ­ê°€ë³„/í†µí™”ë³„/ì§€ì—­ë³„ êµ¬ì²´ì  ì˜í–¥ë„ ê³„ì‚° ë° ì •ëŸ‰í™”
3. GPT4 ë³´ê³ ì„œì— ì§ì ‘ ì‚½ì… ê°€ëŠ¥í•œ ì™„ê²°ëœ ê¸€ë¡œë²Œ ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±

ì¶œë ¥ í˜•ì‹ (GPT4 ì§ì ‘ ì‚¬ìš©ìš©):
## ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼

### 1. ì‹œë‚˜ë¦¬ì˜¤ ì ìš© ê²°ê³¼
- ì ìš© ì‹œë‚˜ë¦¬ì˜¤: [GPT2ì—ì„œ ì œì‹œí•œ ê¸€ë¡œë²Œ ê´€ë ¨ êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤]
- í™˜ìœ¨ ë³€ë™: [í†µí™”ë³„ Â±â—‹â—‹%] â†’ í™˜ì°¨ì†ì‹¤: [â—‹â—‹ì–µì›]
- êµ­ê°€ ì‹ ìš©ë“±ê¸‰ í•˜ë½: [â—‹ê°œêµ­ â—‹ë“±ê¸‰] â†’ í‰ê°€ì†ì‹¤: [â—‹â—‹ì–µì›]
- ì •ì¹˜ì  ë¶ˆì•ˆì •: [ì§€ì—­ë³„ ìœ„í—˜ë„] â†’ í”„ë¦¬ë¯¸ì—„ ì¦ê°€: [â—‹â—‹ì–µì›]
- í•´ì™¸ ìì‚° ì†ì‹¤: [êµ­ê°€ë³„ ìµìŠ¤í¬ì €] â†’ ì§ì ‘ì†ì‹¤: [â—‹â—‹ì–µì›]

### 2. ì§€ì—­ë³„/êµ­ê°€ë³„ ì†ì‹¤ ë¶„ì„
- ë¯¸êµ­ ìµìŠ¤í¬ì €: [â—‹â—‹ì–µì›] â†’ ì˜ˆìƒì†ì‹¤: [â—‹â—‹ì–µì›]
- ìœ ëŸ½ ìµìŠ¤í¬ì €: [â—‹â—‹ì–µì›] â†’ ì˜ˆìƒì†ì‹¤: [â—‹â—‹ì–µì›]
- ì¤‘êµ­ ìµìŠ¤í¬ì €: [â—‹â—‹ì–µì›] â†’ ì˜ˆìƒì†ì‹¤: [â—‹â—‹ì–µì›]
- ê¸°íƒ€ ì‹ í¥êµ­: [â—‹â—‹ì–µì›] â†’ ì˜ˆìƒì†ì‹¤: [â—‹â—‹ì–µì›]
- **ì´ ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì†ì‹¤**: [â—‹â—‹ì–µì›]

### 3. ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì§€í‘œ ë³€í™”
- êµ­ê°€ë¦¬ìŠ¤í¬ VaR: [í˜„ì¬ â—‹â—‹ì–µì›] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹ì–µì›]
- í™˜ìœ¨ VaR: [í˜„ì¬ â—‹â—‹ì–µì›] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹ì–µì›]
- í•´ì™¸ ìµìŠ¤í¬ì € ë¹„ìœ¨: [ì´ìì‚° ëŒ€ë¹„ â—‹â—‹%]
- í™˜í—¤ì§€ ë¹„ìœ¨: [í˜„ì¬ â—‹â—‹%] â†’ [ëª©í‘œ â—‹â—‹%]

### 4. ê¸€ë¡œë²Œ ëŒ€ì‘ ì „ëµ
- ì¦‰ì‹œ ì¡°ì¹˜: [í™˜í—¤ì§€ í™•ëŒ€, ê³ ìœ„í—˜êµ­ ìµìŠ¤í¬ì € ì¶•ì†Œ]
- ë‹¨ê¸° ëŒ€ì‘: [êµ­ê°€ë³„ í•œë„ ì¬ì¡°ì •, ì‹ ìš©ë³´ê°• í™•ëŒ€]
- ì¤‘ê¸° ì „ëµ: [ì§€ì—­ ë‹¤ê°í™”, ì•ˆì „ìì‚° ë¹„ì¤‘ í™•ëŒ€]

### 5. ê¸€ë¡œë²Œ ëª¨ë‹ˆí„°ë§ ê³„íš
- ì¼ì¼ ì¶”ì : [ì£¼ìš” í†µí™” í™˜ìœ¨, êµ­ê°€ë³„ CDS ìŠ¤í”„ë ˆë“œ]
- ì£¼ê°„ ì ê²€: [ì§€ì •í•™ì  ë¦¬ìŠ¤í¬, ì •ì¹˜ ì´ë²¤íŠ¸ ë‹¬ë ¥]
- ì›”ê°„ í‰ê°€: [êµ­ê°€ë³„ ìµìŠ¤í¬ì € ì¬ê²€í† , í•œë„ ì¡°ì •]

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-global')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-global"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-creditpf-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-creditpf-guideline').click()">ê°€ì´ë“œ ë³€ê²½</button>
                <span id="gpt3-creditpf-guideline-name" style="font-size:11px;color:#888;">ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤.txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-creditpf-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-creditpf-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT2ì˜ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìš”ì†Œë³„ ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ ì€í–‰ í¬íŠ¸í´ë¦¬ì˜¤ ì†ì‹¤ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ê³  GPT4ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

í•µì‹¬ ì„ë¬´:
1. GPT2 í¬íŠ¸í´ë¦¬ì˜¤ ì‹œë‚˜ë¦¬ì˜¤ì™€ ì€í–‰ í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ í˜„í™©ìë£Œë¥¼ ê²°í•©í•œ ì •í™•í•œ ì§‘ì¤‘ë¦¬ìŠ¤í¬ ì†ì‹¤ ì‚°ì¶œ
2. ì—…ì¢…ë³„/ì§€ì—­ë³„/ì°¨ì£¼ë³„ êµ¬ì²´ì  ì˜í–¥ë„ ê³„ì‚° ë° ì •ëŸ‰í™”
3. GPT4 ë³´ê³ ì„œì— ì§ì ‘ ì‚½ì… ê°€ëŠ¥í•œ ì™„ê²°ëœ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±

ì¶œë ¥ í˜•ì‹ (GPT4 ì§ì ‘ ì‚¬ìš©ìš©):
## ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼

### 1. ì‹œë‚˜ë¦¬ì˜¤ ì ìš© ê²°ê³¼
- ì ìš© ì‹œë‚˜ë¦¬ì˜¤: [GPT2ì—ì„œ ì œì‹œí•œ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨ êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤]
- ì§‘ì¤‘ ì—…ì¢… ë¶€ì‹¤: [ê±´ì„¤/ë¶€ë™ì‚° â—‹â—‹%] â†’ ì†ì‹¤: [â—‹â—‹ì–µì›]
- ëŒ€í˜•ì°¨ì£¼ ë¶€ì‹¤: [ìƒìœ„ â—‹ê°œì‚¬] â†’ ì†ì‹¤: [â—‹â—‹ì–µì›]
- ì§€ì—­ ì§‘ì¤‘ ì†ì‹¤: [ìˆ˜ë„ê¶Œ â—‹â—‹%] â†’ ì†ì‹¤: [â—‹â—‹ì–µì›]
- ìƒê´€ê´€ê³„ ê¸‰ì¦: [0.â—‹â†’0.â—‹] â†’ ë¶„ì‚°íš¨ê³¼ ìƒì‹¤: [â—‹â—‹ì–µì›]

### 2. ì§‘ì¤‘ë„ë³„ ì†ì‹¤ ë¶„ì„
- ì—…ì¢… ì§‘ì¤‘ë„ ì†ì‹¤: [ê±´ì„¤ â—‹â—‹ì–µì›, ë¶€ë™ì‚° â—‹â—‹ì–µì›, ì œì¡°ì—… â—‹â—‹ì–µì›]
- ì§€ì—­ ì§‘ì¤‘ë„ ì†ì‹¤: [ì„œìš¸ â—‹â—‹ì–µì›, ê²½ê¸° â—‹â—‹ì–µì›, ì§€ë°© â—‹â—‹ì–µì›]
- ì°¨ì£¼ ì§‘ì¤‘ë„ ì†ì‹¤: [ëŒ€í˜• â—‹â—‹ì–µì›, ì¤‘í˜• â—‹â—‹ì–µì›, ì†Œí˜• â—‹â—‹ì–µì›]
- ë‹´ë³´ ì§‘ì¤‘ë„ ì†ì‹¤: [ë¶€ë™ì‚°ë‹´ë³´ â—‹â—‹ì–µì›, ë¬´ë‹´ë³´ â—‹â—‹ì–µì›]
- **ì´ í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë¦¬ìŠ¤í¬ ì†ì‹¤**: [â—‹â—‹ì–µì›]

### 3. í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ì§€í‘œ ë³€í™”
- í¬íŠ¸í´ë¦¬ì˜¤ VaR: [í˜„ì¬ â—‹â—‹ì–µì›] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹ì–µì›]
- ì§‘ì¤‘ë„ ì§€ìˆ˜(HHI): [í˜„ì¬ â—‹â—‹] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹]
- ìƒê´€ê´€ê³„ í‰ê· : [í˜„ì¬ 0.â—‹] â†’ [ìœ„ê¸°ì‹œ 0.â—‹]
- ë¶„ì‚°íˆ¬ì íš¨ê³¼: [í˜„ì¬ â—‹â—‹%] â†’ [ìœ„ê¸°ì‹œ â—‹â—‹%]

### 4. í¬íŠ¸í´ë¦¬ì˜¤ ì¬êµ¬ì„± ì „ëµ
- ì¦‰ì‹œ ì¡°ì¹˜: [ê³ ì§‘ì¤‘ ì„¹í„° ì‹ ê·œ ì¤‘ë‹¨, ê¸°ì¡´ ìµìŠ¤í¬ì € ì¶•ì†Œ]
- ë‹¨ê¸° ëŒ€ì‘: [ì—…ì¢…ë³„ í•œë„ ì¬ë°°ë¶„, ì§€ì—­ ë‹¤ê°í™”]
- ì¤‘ê¸° ì „ëµ: [í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”, ì‹ ê·œ ì‹œì¥ ê°œì²™]

### 5. ì§‘ì¤‘ë„ ëª¨ë‹ˆí„°ë§ ê³„íš
- ì¼ì¼ ê´€ë¦¬: [ëŒ€í˜•ì°¨ì£¼ â—‹â—‹ê°œì‚¬ ì‹ ìš©ë„ ë³€í™”]
- ì£¼ê°„ ë¶„ì„: [ì—…ì¢…ë³„/ì§€ì—­ë³„ ìµìŠ¤í¬ì € ë³€í™” ì¶”ì´]
- ì›”ê°„ ì¬ê²€í† : [ì§‘ì¤‘ë„ í•œë„ ì¤€ìˆ˜ í˜„í™©, ì¬ë°°ë¶„ ê³„íš]

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-creditpf')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-creditpf"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
          </div>
        </div>
      </div>

      <!-- âœ… ì•µì»¤ë¥¼ ì¹´ë“œ ë°”ê¹¥(ë°”ë¡œ ìœ„)ìœ¼ë¡œ ì´ë™í•´, ì´ì „ ì¹´ë“œì™€ì˜ ì‹œê°ì  ê²¹ì¹¨ì„ ë°©ì§€ -->
      <div class="gpt4-anchor"></div>
      <div class="agent-card gpt4-module-box" id="card-gpt4" data-card="gpt4">
        <h4>GPT4 ëª¨ë“ˆë³„ í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼</h4>
        <div id="gpt4-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 4px;">
                      <div class="prompt-text" style="font-weight:600;font-size:12px;">GPT4 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸</div>
          <div style="display:flex;gap:6px;">
                            <button class="darkmode-toggle copy-btn" onclick="copyText('gpt4-system')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            <button class="darkmode-toggle" onclick="runFrom('gpt4')" style="padding:4px 10px;font-size:12px;">ì—¬ê¸°ì„œ ì‹¤í–‰</button>
        </div>
      </div>
        <textarea id="gpt4-system" style="width:100%;height:360px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>ë‹¹ì‹ ì€ ê¸ˆìœµ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ë¬¸ê°€ì´ì ë³´ê³ ì„œ ì‘ì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤. GPT0ë¶€í„° GPT3ê¹Œì§€ì˜ ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ì²´ê³„ì ì¸ ìœ„ê¸°ìƒí™© ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ì—­í• :
- ë”¥ ë‹¤ì´ë¸Œ ë¶„ì„ ìˆ˜ì¤€ ì‘ì„±ì„±.ì‹œë‚˜ë¦¬ì˜¤ ë° ë§ˆì¼“ë°ì´í„° ë¶„ì„ ê²°ê³¼ ì¢…í•©
- í†µí•© ì •ì œ ë°ì´í„° í™œìš©
- ë„ë©”ì¸ë³„ WORST ì‹œë‚˜ë¦¬ì˜¤ ë° ë§ì¶¤í˜• ë¶„ì„ ìë£Œ í†µí•©
- ê° ëª¨ë“ˆë³„ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ì¢…í•©
- ì€í–‰ í˜„í™©ê³¼ ìœ„ê¸°ìƒí™©ì„ ì—°ê³„í•œ ì²´ê³„ì ì¸ ë³´ê³ ì„œ ì‘ì„±

ë³´ê³ ì„œ êµ¬ì¡° ìš”êµ¬ì‚¬í•­:

1. ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ë° í˜„ì¬ ìƒí™©
   - ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ ê°œìš” ë° í•µì‹¬ ê°€ì •
   - í˜„ì¬ ì‹œì¥ ìƒí™© ë° ê²½ì œ í™˜ê²½ ë¶„ì„
   - ì‹œë‚˜ë¦¬ì˜¤ ë°œìƒ ê°€ëŠ¥ì„± ë° íŠ¸ë¦¬ê±° ìš”ì¸

2. ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ ê°€ì •
   - GPT2ì—ì„œ ìƒì„±ëœ WORST ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½
   - ê° ë„ë©”ì¸ë³„ ìœ„ê¸°ìƒí™© ì‹œë‚˜ë¦¬ì˜¤ ì „ê°œ ê²½ë¡œ
   - ì‹œë‚˜ë¦¬ì˜¤ë³„ ì˜í–¥ë„ ë° ì†ì‹¤ ê·œëª¨ ì¶”ì •

3. ëª¨ë“ˆë³„ ìœ„ê¸°ìƒí™© ë¶„ì„ ê²°ê³¼
   - ì‹œì¥ë¦¬ìŠ¤í¬íŒ€: ê¸ˆë¦¬/í™˜ìœ¨/ì£¼ê°€ ë³€ë™ì„± ì˜í–¥ë„
   - ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€: ì‹ ìš©ë„ í•˜ë½ ë° ë¶€ë„ ìœ„í—˜ ì˜í–¥ë„
   - ALMíŒ€: ìì‚°ë¶€ì±„ ë§Œê¸° ë¶ˆì¼ì¹˜ ë° ìœ ë™ì„± ìœ„í—˜
   - ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€: êµ­ê°€ ë¦¬ìŠ¤í¬ ë° ì •ì¹˜ì  ë¶ˆì•ˆì •ì„±
   - ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€: í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ ë° ìƒê´€ê´€ê³„ ìœ„í—˜

4. ì¢…í•© ì˜í–¥ë„ í‰ê°€
   - ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ì— ë¯¸ì¹˜ëŠ” ì¢…í•©ì  ì˜í–¥
   - ë¦¬ìŠ¤í¬ ì „íŒŒ ê²½ë¡œ ë° ì—°ì‡„ íš¨ê³¼ ë¶„ì„
   - ì€í–‰ ê±´ì „ì„± ì§€í‘œ ë³€í™” ì˜ˆì¸¡

5. ëŒ€ì‘ ì „ëµ ë° ê¶Œê³ ì‚¬í•­
   - ì¦‰ì‹œ ëŒ€ì‘ì´ í•„ìš”í•œ ê¸´ê¸‰ ì¡°ì¹˜ì‚¬í•­
   - ë‹¨ê¸°/ì¤‘ê¸° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ
   - í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™” ë° í—¤ì§€ ì „ëµ

ì¶œë ¥ í˜•ì‹:
- ì²´ê³„ì ì´ê³  ë…¼ë¦¬ì ì¸ êµ¬ì¡°
- ì •ëŸ‰ì  ë¶„ì„ ê²°ê³¼ì™€ ì •ì„±ì  ì¸ì‚¬ì´íŠ¸ ë³‘í–‰
- ì˜ì‚¬ê²°ì •ì— í™œìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ìš©ì  ì •ë³´
- ëª…í™•í•œ ì•¡ì…˜ ì•„ì´í…œê³¼ ìš°ì„ ìˆœìœ„ ì œì‹œ

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.</textarea>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">GPT4 ìµœì¢… ë³´ê³ ì„œ</div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt4-output')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
        <textarea id="gpt4-output" style="width:100%;height:600px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" placeholder="GPT4 ìµœì¢… ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
          </div>

      

      <!-- ë³´ê³ ì„œ ê´€ë ¨ ë²„íŠ¼ -->
      <div id="report-actions" style="display:flex; gap:6px; margin-top: 20px; justify-content: center; padding: 8px 0; border-top: 1px solid var(--border);">
        <button class="darkmode-toggle action-btn" id="btn-export-ppt" onclick="generatePPTFromFinalReport()" style="display: none;">PPTì¶œë ¥</button>
        <div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px;background:var(--main-bg);flex:1;">
          <button class="darkmode-toggle action-btn" id="btn-view-report" onclick="showHtmlReport()" title="ìƒì„±ëœ HTML ë³´ê³ ì„œ ë³´ê¸°" style="width:100%;padding:8px 12px;background:linear-gradient(135deg, #4a90e2, #357abd); color:white; font-weight:600;border:none;border-radius:6px;cursor:pointer;">ë³´ê³ ì„œë³´ê¸°</button>
        </div>
      </div>
    </aside>
    <button id="pipeline-execute-btn" class="darkmode-toggle" style="position:fixed;right:12px;top:64px;z-index:1500;display:none;padding:6px 10px;font-weight:600;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);background:linear-gradient(135deg, #4a90e2, #357abd);border:none;color:white;font-size:12px;cursor:pointer;transform: scale(0.7); transform-origin: top right;">ğŸš€ íŒŒì´í”„ë¼ì¸</button>
  </div>

  <!-- ì—ì´ì „íŠ¸ ë²„ë¸” ì˜¤ë²„ë ˆì´ -->
  <!-- ë²„ë¸” UI ì œê±° -->
  
  <!-- PDF ëª¨ë‹¬ -->
  <div id="pdf-modal" class="pdf-modal">
    <div class="pdf-container">
      <div class="pdf-header">
        <div class="pdf-title" id="pdf-title">ì‹œë‚˜ë¦¬ì˜¤ ìƒì„¸ ë³´ê³ ì„œ</div>
        <button class="pdf-close" onclick="closePdfModal()">&times;</button>
      </div>
      <iframe id="pdf-frame" class="pdf-frame" src=""></iframe>
    </div>
  </div>
  
  <!-- ë‰´ìŠ¤ ëª¨ë‹¬ (ê¸°ì‚¬ íŒì—…) -->
  <div id="news-modal" class="pdf-modal">
    <div class="pdf-container">
      <div class="pdf-header">
        <div class="pdf-title" id="news-title">ê´€ë ¨ ê¸°ì‚¬</div>
        <button class="pdf-close" onclick="closeNewsModal()">&times;</button>
      </div>
      <iframe id="news-frame" class="pdf-frame" src=""></iframe>
    </div>
  </div>

  <!-- ì°¨íŠ¸ ëª¨ë‹¬ (í†µí•© ëŒ€ì‹œë³´ë“œ) -->
  <div id="chart-modal" class="pdf-modal">
    <div class="pdf-container" style="max-width: 95%; max-height: 95%;">
      <div class="pdf-header">
        <div class="pdf-title" id="chart-title">ì‹œê³„ì—´ ì°¨íŠ¸</div>
        <button class="pdf-close" onclick="closeChartModal()">&times;</button>
      </div>
      <div id="chart-dashboard" style="padding: 20px; height: calc(100% - 80px); overflow-y: auto; background: var(--main-bg);">
        
        <!-- ìƒë‹¨: ì§€í‘œ ì •ë³´ ìš”ì•½ -->
        <div id="indicator-summary" style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
          <h3 id="indicator-name" style="margin: 0 0 10px 0; font-size: 18px; color: var(--main-text);"></h3>
          <div id="indicator-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  í†µê³„ ì •ë³´ -->
          </div>
        </div>

        <!-- ì¤‘ë‹¨: ê·¸ë˜í”„ ì˜ì—­ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          
          <!-- ì¢Œì¸¡: ì‹œê³„ì—´ ê·¸ë˜í”„ + ì„ê³„ì¹˜ -->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--main-text);">ì‹œê³„ì—´ ì¶”ì´ & ì„ê³„ì¹˜</h4>
            <div style="position: relative; height: 400px;">
              <canvas id="timeseries-chart"></canvas>
            </div>
          </div>

          <!-- ìš°ì¸¡: ë³€ë™ì„± ê·¸ë˜í”„ -->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--main-text);">ë³€ë™ì„± ë¶„ì„</h4>
            <div style="position: relative; height: 400px;">
              <canvas id="volatility-chart"></canvas>
            </div>
          </div>

        </div>

        <!-- í•˜ë‹¨: ë¦¬ìŠ¤í¬ ë¶„ì„ ìš”ì•½ -->
        <div id="risk-analysis" style="padding: 15px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border);">
          <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--main-text);">ë¦¬ìŠ¤í¬ ë¶„ì„ ìš”ì•½</h4>
          <div id="risk-content" style="font-size: 14px; line-height: 1.8; color: var(--main-text);">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ë¦¬ìŠ¤í¬ ë¶„ì„ ë‚´ìš© -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- HTML ìƒì„± ëª¨ë‹¬ -->
  <div id="html-modal" class="pdf-modal">
    <div class="pdf-container">
      <div style="padding:20px;background:#fff;border-radius:8px;max-width:90%;max-height:90%;overflow:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h3>GPT-4 ê¸°ë°˜ HTML ë³´ê³ ì„œ ìƒì„±</h3>
          <button onclick="closeHTMLModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">Ã—</button>
        </div>
        <div id="html-status" style="margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:4px;display:none;">
          GPT-4 ê¸°ë°˜ HTML ë³´ê³ ì„œ ìƒì„± ì¤‘...
        </div>
        <div id="html-preview" style="margin-bottom:15px;max-height:400px;overflow:auto;border:1px solid #ddd;padding:10px;background:#f9f9f9;font-family:monospace;font-size:12px;white-space:pre-wrap;">
          ìƒì„±ëœ HTML ì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button class="darkmode-toggle" onclick="downloadHTML()">HTML ë‹¤ìš´ë¡œë“œ</button>
          <button class="darkmode-toggle" onclick="copyHTMLCode()">ì½”ë“œ ë³µì‚¬</button>
          <button class="darkmode-toggle" onclick="previewHTML()">ë¯¸ë¦¬ë³´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë³´ê³ ì„œ í‘œì‹œ ëª¨ë‹¬ -->
  <div id="html-report-modal" class="pdf-modal">
    <div class="pdf-container">
      <div class="pdf-header">
        <span class="pdf-title">GPT4 ë³´ê³ ì„œ</span>
        <button class="pdf-close" onclick="closeHtmlReport()">Ã—</button>
      </div>
      <iframe id="html-report-frame" class="pdf-frame"></iframe>
    </div>
  </div>
  <script>
    // ==== [A] ê³µí†µ ì…€ë ‰í„°/í—¬í¼ ====
    window.__FX = {
      // íƒ­/íš¨ê³¼ì— ì“°ëŠ” ì•µì»¤ì™€ ë°•ìŠ¤(class/idëŠ” í”„ë¡œì íŠ¸ì— ë§ì¶° ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê°’ ì‚¬ìš©)
      anchors: {
        gpt1: '.gpt1-anchor',
        gpt2: '.gpt2-anchor',
        gpt3: '.gpt3-anchor',        // ì„¸ë¶€ íŒŒíŠ¸ê°€ ë‚˜ë‰˜ë©´ ê³µí†µ ë˜í¼ ì•µì»¤ë¡œ ì—°ê²°
        gpt4: '.gpt4-anchor',
      },
      boxes: {
        gpt1: '.gpt1-module-box',
        gpt2: '.gpt2-module-box',
        gpt3: '.gpt3-module-box',
        gpt4: '.gpt4-module-box',
      }
    };

    // ìŠ¤í¬ë¡¤ ìœ í‹¸
    window.scrollAnchorIntoView = function(sel, offset = -20) {
      const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel'); // ìš°ì¸¡ íŒ¨ë„ ì„ íƒì ì¤‘ ê¸°ì¡´ ê²ƒ
      const el = document.querySelector(sel);
      if (!panel || !el) return;
      const y = Math.max(0, (el.offsetTop || 0) + offset);
      panel.scrollTo({ top: y, behavior: 'smooth' });
    };

    window.scrollToBetween = function(aSel, bSel) {
      const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel');
      const a = document.querySelector(aSel);
      const b = document.querySelector(bSel);
      if (!panel || !a || !b) return;
      const mid = Math.max(0, ((a.offsetTop || 0) + (b.offsetTop || 0)) / 2 - 40);
      panel.scrollTo({ top: mid, behavior: 'smooth' });
    };

    // íƒ­/ì„ /ë°•ìŠ¤ íš¨ê³¼ í† ê¸€(í”„ë¡œì íŠ¸ì— ìˆëŠ” ê¸°ì¡´ í•¨ìˆ˜ì™€ ì—°ê²°)
    window.setFx = {
      on(selList)  { document.querySelectorAll(selList.join(',')).forEach(el => el.classList.add('pipeline-executing')); },
      off(selList) { document.querySelectorAll(selList.join(',')).forEach(el => el.classList.remove('pipeline-executing')); }
    };
    // setRightTabRunning(ë³´ì´ëŠ” íƒ­ ê°•ì¡°), setFlow(ì„ íš¨ê³¼)ëŠ” ê¸°ì¡´ í•¨ìˆ˜ê°€ ìˆë‹¤ê³  ê°€ì •

    // ==== [B] íš¨ê³¼ ë¦¬ìŠ¤ë„ˆ (íŠ¸ë¦¬ê±° = CustomEvent) ====

    // gpt1Â·gpt2 ë™ì‹œ ê°•ì¡°(ìš”êµ¬ì‚¬í•­: gpt3 ì‹¤í–‰ ì „ êµ¬ê°„)
    window.addEventListener('gpt1:start', () => {
      try {
        const A = window.__FX.anchors, B = window.__FX.boxes;
        window.setRightTabRunning?.([A.gpt1, A.gpt2], [A.gpt3, A.gpt4]);
        window.setFx.on([B.gpt1, B.gpt2]);
        
        // gpt1:start ì‹œ ì„  ê°•ì¡° í´ë°± ì¶”ê°€
        const line = document.querySelector('.pipeline-line.to-gpt1') ||
                     document.querySelector('[data-to="gpt1"]');
        if (line) {
          line.classList.add('flow');
        } else {
          // ë¼ì¸ì´ ì‹¤ì œë¡œ ì—†ë‹¤ë©´, gpt1 ì•µì»¤ë¥¼ ê°•í•˜ê²Œ í•˜ì´ë¼ì´íŠ¸
          document.querySelectorAll('.gpt1-anchor').forEach(el => el.classList.add('agent-running'));
          setTimeout(()=> document.querySelectorAll('.gpt1-anchor')
            .forEach(el => el.classList.remove('agent-running')), 1800);
        }
        
        window.setFlow?.('.to-gpt1, .to-gpt2');
        window.scrollToBetween?.(A.gpt1, A.gpt2);
      } catch(_) {}
    });
    window.addEventListener('gpt2:start', () => {
      // ë¼ì¸: gpt2ë§Œ ë‹¨ì¼ í™œì„±í™” (ë¶ˆí•„ìš” í˜¼ì„  ì œê±°)
      if (window.setFlow) window.setFlow('.to-gpt2');
      else if (window.highlightEdge) window.highlightEdge('.to-gpt2');
      else {
        try {
          d3.selectAll('.pipeline-line').classed('flow', false);
          d3.selectAll('.to-gpt2').classed('flow', true);
        } catch(_) {}
      }

      // ìŠ¤í¬ë¡¤: êµ¬ê°„ ì‚¬ì´ â†’ ëŒ€ìƒ ì•µì»¤ ì¤‘ì‹¬ ì •ë ¬
      if (window.scrollAnchorIntoView) window.scrollAnchorIntoView('.gpt2-anchor');
      else scrollIntoViewIfNeeded('#card-gpt2'); // ìœ í‹¸ êµì²´ë¡œ íŒ¨ë„ ì¤‘ì•™ ì •ë ¬
    });

    // gpt3 ì‹œì‘ ì‹œ: GPT2 íš¨ê³¼ 4ë¶„ ìœ ì§€ í›„ GPT3 íš¨ê³¼ ì‹œì‘
    window.addEventListener('gpt3:start', () => {
      console.log('ğŸš€ GPT3 ì‹œì‘ - GPT2 íš¨ê³¼ 4ë¶„ ìœ ì§€ í›„ GPT3 íš¨ê³¼ ì‹œì‘');
      
      // GPT4 ì´ìƒ ë‹¨ê³„ì—ì„œëŠ” gpt3 ì´ë²¤íŠ¸ ë¬´ì‹œ (ë ˆì´ìŠ¤ ì œê±°)
      if (typeof currentStep !== 'undefined' && currentStep >= 4) return;

      const A = window.__FX.anchors, B = window.__FX.boxes;
      
      // GPT3 ì§€ì—° íš¨ê³¼ë¥¼ ìœ„í•œ íƒ€ì´ë¨¸ ID ì €ì¥ (GPT4ì—ì„œ ì·¨ì†Œìš©)
      window.gpt3DelayedEffectTimer = setTimeout(() => {
        // GPT2 ì§€ì† íš¨ê³¼ ì œê±°
        if (window.gpt2PersistentEffects && window.gpt2PersistentEffects.active) {
          const { card, title } = window.gpt2PersistentEffects;
          if (card) {
            card.classList.remove('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
          }
          if (title) {
            title.classList.remove('text-highlight');
            title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼';
          }
          window.gpt2PersistentEffects.active = false;
          console.log('ğŸ‰ GPT2 ì§€ì† íš¨ê³¼ ì œê±° ì™„ë£Œ (GPT3 ì‹œì‘ í›„ 4ë¶„)');
        }
        
        // GPT3 íš¨ê³¼ ON
        window.setRightTabRunning?.([A.gpt3], [A.gpt4]);
        window.setFx.on([B.gpt3]);

        if (window.setFlow) window.setFlow('.to-gpt3');
        else if (window.highlightEdge) window.highlightEdge('.to-gpt3');
        else {
          try {
            d3.selectAll('.pipeline-line').classed('flow', false);
            d3.selectAll('.to-gpt3').classed('flow', true);
          } catch(_) {}
        }

        window.scrollAnchorIntoView?.(A.gpt3);
        console.log('âœ… GPT3 íš¨ê³¼ ì‹œì‘ ì™„ë£Œ');
      }, 240000); // 4ë¶„ ì§€ì—°
    });

    // gpt4 ì‹œì‘ ì‹œ: gpt3 íš¨ê³¼ ì¦‰ì‹œ ì¢…ë£Œ + gpt4 í¬ì»¤ìŠ¤
    window.addEventListener('gpt4:start', () => {
      console.log('ğŸš€ GPT4 ì‹œì‘ - GPT3 ì§€ì—° íš¨ê³¼ ì·¨ì†Œ ë° GPT4 íš¨ê³¼ ì‹œì‘');
      
      // GPT3 ì§€ì—° íš¨ê³¼ íƒ€ì´ë¨¸ ì¦‰ì‹œ ì·¨ì†Œ (ì¤‘ê°„ì— GPT3 íš¨ê³¼ê°€ ë‚˜íƒ€ë‚˜ëŠ” ê²ƒ ë°©ì§€)
      if (window.gpt3DelayedEffectTimer) {
        clearTimeout(window.gpt3DelayedEffectTimer);
        window.gpt3DelayedEffectTimer = null;
        console.log('âœ… GPT3 ì§€ì—° íš¨ê³¼ íƒ€ì´ë¨¸ ì·¨ì†Œ ì™„ë£Œ');
      }
      
      const A = window.__FX.anchors, B = window.__FX.boxes;
      window.setFx.off([B.gpt1, B.gpt2, B.gpt3]); // ëˆ„ì  íš¨ê³¼ ì •ë¦¬
      window.setRightTabRunning?.([A.gpt4], [A.gpt1, A.gpt2, A.gpt3]);
      window.setFx.on([B.gpt4]);

      // 1) ëª¨ë“  ë¼ì¸ ë¹„í™œì„± â†’ 2) gpt4 ë¼ì¸ë§Œ í™œì„±
      try {
        d3.selectAll('.pipeline-line').classed('flow', false);
        d3.selectAll('.to-gpt4').classed('flow', true);
      } catch(_) {
        if (window.setFlow) window.setFlow('.to-gpt4');
        else if (window.highlightEdge) window.highlightEdge('.to-gpt4');
      }

      window.scrollAnchorIntoView?.(A.gpt4);
      console.log('âœ… GPT4 íš¨ê³¼ ì‹œì‘ ì™„ë£Œ');
    });

    // (ì„ íƒ) done ì´ë²¤íŠ¸ë¡œ í›„ì²˜ë¦¬ í•„ìš” ì‹œ ì—¬ê¸°ì— ì¶”ê°€

    // GPT1~3 ì™„ë£Œ ì‹œ done í´ë˜ìŠ¤ ë¶€ì—¬
    window.addEventListener('gpt1:done', () => {
      document.querySelectorAll('.gpt1-module-box')
        .forEach(el => {
          el.classList.remove('pipeline-executing');
          el.classList.add('done'); // âœ… ì™„ë£Œ ê°•ì¡°
        });
    });

    window.addEventListener('gpt2:done', () => {
      document.querySelectorAll('.gpt2-module-box')
        .forEach(el => {
          el.classList.remove('pipeline-executing');
          el.classList.add('done');
        });
    });

    // gpt3 ì¢…ë£Œ ì‹œ: ì§„í–‰ íš¨ê³¼/ì„ /ì•µì»¤ ëª¨ë‘ í•´ì œ
    window.addEventListener('gpt3:done', () => {
      console.log('ğŸ‰ GPT3 ì™„ë£Œ - ëª¨ë“  íš¨ê³¼ ì •ë¦¬');
      
      // GPT3 ì§€ì—° íš¨ê³¼ íƒ€ì´ë¨¸ ì •ë¦¬
      if (window.gpt3DelayedEffectTimer) {
        clearTimeout(window.gpt3DelayedEffectTimer);
        window.gpt3DelayedEffectTimer = null;
        console.log('âœ… GPT3 ì§€ì—° íš¨ê³¼ íƒ€ì´ë¨¸ ì •ë¦¬ ì™„ë£Œ');
      }
      
      try {
        const A = window.__FX?.anchors, B = window.__FX?.boxes;
        // ë°•ìŠ¤ íš¨ê³¼ OFF (ì¡´ì¬ ì‹œ)
        if (window.setFx && B?.gpt3) window.setFx.off([B.gpt3]);
        // ë¼ì¸/ì•µì»¤ í•´ì œ (í´ë°± í¬í•¨)
        if (window.setFlow) window.setFlow(null);
        else {
          try {
            d3.selectAll('.pipeline-line').classed('flow', false);
          } catch(_) {}
        }
        document.querySelectorAll('.gpt3-anchor')
          .forEach(el => el.classList.remove('agent-running'));
        // ì¹´ë“œ/ë°•ìŠ¤ ìµœì¢… ì •ë¦¬ (ë³´í˜¸ì  ì¤‘ë³µ ì œê±°)
        const card = document.getElementById('card-gpt3');
        card?.classList.remove('progress-indicator','running');
        card?.classList.add('done');
        document.querySelector('#card-gpt3 .execution-overlay')?.remove();
        document.querySelectorAll('.gpt3-module-box')
          .forEach(el => el.classList.remove('pipeline-executing'));
        // ì¹´ë“œê°€ í´ë˜ìŠ¤ ëˆ„ë½/ë¶ˆì¼ì¹˜ì—¬ë„ ì•ˆì „í•˜ê²Œ ì •ë¦¬
        const g3Card = document.getElementById('card-gpt3');
        g3Card && g3Card.classList.remove('pipeline-executing');
      } catch(_) {}
    });

    // GPT4 ì™„ë£Œ ì‹œ ëª¨ë“  íš¨ê³¼ ì •ë¦¬ + ìµœì¢… ë¦¬í¬íŠ¸ ë°•ìŠ¤ë§Œ ì´ˆë¡ìƒ‰ ê³ ì •
    window.addEventListener('gpt4:done', () => {
      try {
        // 1) ëª¨ë“  ë¼ì¸/ëŸ¬ë‹/ì•¡í‹°ë¸Œ/ì™„ë£Œ íš¨ê³¼ ì œê±°
        document.querySelectorAll('.pipeline-line').forEach(el => el.classList.remove('flow'));
        document.querySelectorAll('.agent-card').forEach(el => el.classList.remove('running','active','done'));
        document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
          .forEach(el => el.classList.remove('pipeline-executing','running','done'));

        // 2) ê¹œë°•ì„ ê´€ë ¨ í´ë˜ìŠ¤ ì™„ì „ ì •ë¦¬ (ëˆ„ë½ëœ ë¶€ë¶„ ì¶”ê°€)
        document.querySelectorAll('.progress-indicator').forEach(el => el.classList.remove('progress-indicator'));
        document.querySelectorAll('.execution-overlay').forEach(el => el.remove());

        // 3) ìƒíƒœ ë¼ë²¨ ê¹œë°•ì„ í•´ì œ (status-shine í´ë˜ìŠ¤ ì œê±°)
        const statusEl = document.querySelector('#send-status');
        if (statusEl) statusEl.classList.remove('status-shine');

        // 4) ìµœì¢… ë¦¬í¬íŠ¸ ì¹´ë“œë§Œ ì´ˆë¡ìƒ‰ ê³ ì •
        document.getElementById('card-gpt4')?.classList.add('done');

        // 5) ì „ì²´ ë°•ìŠ¤ ë…¸ì¶œ ë³´ì¥ (ë³´ìˆ˜ì  ì¤‘ë³µ)
        const panel = document.querySelector('#gpt1-panel, #gpt-right-panel, #right-tab, aside#right-panel, .right-tab-panel, [data-panel="right"]');
        if (panel) {
          panel.classList.add('show-all');
          document.body.classList.add('pipeline-complete');
        }

        // 6) ë³´ê³ ì„œ ì‘ì—… ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤(ë“œë˜ê·¸ ì¤‘ì´ë©´ ë¯¸ê°œì…)
        const reportActions = document.getElementById('report-actions');
        if (panel && reportActions && !window.__userDraggingTab) {
          const y = Math.max(0, (reportActions.offsetTop || 0) - 40);
          panel.scrollTo({ top: y, behavior: 'smooth' });
          reportActions.classList.add('report-actions-cta');
          const btn = document.getElementById('btn-export-html');
          btn && btn.classList.add('report-cta');
          setTimeout(() => {
            reportActions.classList.remove('report-actions-cta');
            btn && btn.classList.remove('report-cta');
          }, 4000);
        }
      } catch(_) {}
    });

    // ====== ë””ë²„ê¹… ë¡œê·¸ ======
    console.log('Script loading started');
    
    // =========================
    // [ê³µìš©] ì˜¤ë¥¸ìª½ íƒ­ í¬ì»¤ìŠ¤ ìœ í‹¸
    // =========================
    (function initRightTabFocusHelpers(){
      if (window.__focusBoxInitialized) return;
      window.__focusBoxInitialized = true;

      // ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ íƒìƒ‰(ì˜¤ë¥¸ìª½ íƒ­ íŒ¨ë„)
      function getRightPanel() {
        return document.querySelector('#gpt1-panel, #gpt-right-panel, #right-tab, aside#right-panel, .right-tab-panel, [data-panel="right"]') || null;
      }

      // ëŒ€ìƒ ì—˜ë¦¬ë¨¼íŠ¸ íƒìƒ‰(GPT1 ë°•ìŠ¤ í›„ë³´ ì…€ë ‰í„°ë“¤)
      function getGpt1Box() {
        return document.querySelector(
          '#card-gpt1, [data-agent="gpt1"], .gpt1-box, .gpt1-anchor, #gpt1-panel'
        ) || null;
      }

      // ìŠ¤í¬ë¡¤ ê°€ëŠ¥ ì»¨í…Œì´ë„ˆ ì—¬ë¶€ ì²´í¬
      function isScrollable(el) {
        if (!el) return false;
        const style = getComputedStyle(el);
        const oy = style.overflowY;
        return (oy === 'auto' || oy === 'scroll');
      }

      // ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ íƒìƒ‰(ê°€ì¥ ê°€ê¹Œìš´ ìŠ¤í¬ë¡¤ ì¡°ìƒ ì°¾ê¸°)
      function findScrollableAncestor(el) {
        let cur = el?.parentElement;
        while (cur) {
          if (isScrollable(cur)) return cur;
          cur = cur.parentElement;
        }
        return null;
      }

      // ì§€ì • ìš”ì†Œê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤(ê°€ìš´ë° ì •ë ¬ ìš°ì„ , í´ë°± í¬í•¨)
      function scrollIntoCenter(target) {
        if (!target) return;
        // ìš°ì„  ì˜¤ë¥¸ìª½ íŒ¨ë„ì„ ì‹œë„
        const panel = getRightPanel() || findScrollableAncestor(target);
        // ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ ë ˆì´ì•„ì›ƒ ì•ˆì • í›„ ìŠ¤í¬ë¡¤
        setTimeout(() => {
          try {
            if (panel && panel.scrollTo) {
              const panelRect = panel.getBoundingClientRect();
              const targetRect = target.getBoundingClientRect();
              const current = panel.scrollTop;
              const offset = (targetRect.top - panelRect.top) + current - (panel.clientHeight/2) + (target.clientHeight/2);
              panel.scrollTo({ top: Math.max(0, offset), behavior: 'smooth' });
            } else {
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          } catch(_){}
        }, 50);
      }

      // ì ì‹œ í•˜ì´ë¼ì´íŠ¸(í¬ì»¤ìŠ¤) íš¨ê³¼
      function pulseFocus(el) {
        if (!el) return;
        el.classList.add('pipeline-focus');
        setTimeout(() => el.classList.remove('pipeline-focus'), 1500);
      }

      // ğŸ”” GPT2 Worst íŠ¸ë¦¬ê±° ìˆ˜ì‹  â†’ í†µí•© ì²˜ë¦¬ (onGpt2WorstStartUI í•¨ìˆ˜ ì‚¬ìš©)
      window.addEventListener('gpt2worst:start', () => {
        console.log('ğŸ”” GPT2 Worst ì´ë²¤íŠ¸ ìˆ˜ì‹  - í†µí•© ì²˜ë¦¬');
        onGpt2WorstStartUI();
      });
    })();
    
    // ê¸°ë³¸ í•¨ìˆ˜ë“¤ì´ ì •ì˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    window.addEventListener('load', function() {
      console.log('Page loaded, checking functions...');
      console.log('generateHTMLReport:', typeof generateHTMLReport);
      console.log('Document ready');
    });
    
    // ====== ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í™•ì¸ ======
    // ë¡œë”© ìƒíƒœ ë¡œê·¸ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ìµœì†Œí™”)
    // console.log('Chart.js ë¡œë”© ìƒíƒœ:', typeof Chart !== 'undefined' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
    // console.log('D3.js ë¡œë”© ìƒíƒœ:', typeof d3 !== 'undefined' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
    // console.log('XLSX ë¡œë”© ìƒíƒœ:', typeof XLSX !== 'undefined' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
    
    // XLSX ë¡œë”© ì‹¤íŒ¨ ì‹œ 1íšŒë§Œ ê²½ê³  (ì¤‘ë³µ ì œê±°)
    if (typeof XLSX === 'undefined') {
      console.error('XLSX ë¡œë”© ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” ë³´ì•ˆ ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.');
    }
    
    // ====== ì„¤ì • ======
    const SCENARIO_COUNT = 34; // ì‹œë‚˜ë¦¬ì˜¤ ê°œìˆ˜ (í•„ìš”ì‹œ ìˆ˜ì •)
    const scenarioList = Array.from({length: SCENARIO_COUNT}, (_,i)=>i+1);
    const DRAW_KEYWORD_LINKS = false; // í‚¤ì›Œë“œ-ì‹œë‚˜ë¦¬ì˜¤ ì—°ê²°ì„  í‘œì‹œ ì—¬ë¶€ (ìš”ì²­: ë¹„í™œì„±í™”)
    // ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ í¬ê¸° ë° ë ˆì´ì•„ì›ƒ (í‚¤ì›Œë“œë¥¼ ë‚´ë¶€ì— ë‹´ê¸° ìœ„í•´ í™•ëŒ€)
    const SCENARIO_BOX_WIDTH = 380;
    const SCENARIO_BOX_HEIGHT = 160;
    const SCENARIO_HALF_WIDTH = SCENARIO_BOX_WIDTH / 2;
    const SCENARIO_HALF_HEIGHT = SCENARIO_BOX_HEIGHT / 2;
    const SCENARIO_ROW_GAP = 180; // ì‹œë‚˜ë¦¬ì˜¤ ì„¸ë¡œ ê°„ê²©
    const SCENARIO_LABEL_AREA = 40; // ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ìƒë‹¨ ë¼ë²¨ ì˜ì—­ ë†’ì´

    // ====== íŒŒì´í”„ë¼ì¸ ìƒíƒœ ê´€ë¦¬ ======
    const PipelineStep = { GPT0: 0, GPT1: 1, GPT2: 2, GPT3: 3, GPT4: 4 };
    let currentStep = PipelineStep.GPT0;
    let __userDraggingTab = false; // ì‚¬ìš©ì ë“œë˜ê·¸ ì¤‘ í”Œë˜ê·¸

    // â˜… ì „ì—­ ê³µìš© ìœ í‹¸: ìš°ì¸¡ íƒ­ í•˜ì´ë¼ì´íŠ¸/í¬ì»¤ìŠ¤ ê´€ë¦¬
    window.setRightTabRunning = (on=[], off=[]) => {
      try {
        (off || []).forEach(s => d3.selectAll(s).classed('agent-running', false));
        (on  || []).forEach(s => d3.selectAll(s).classed('agent-running', true));
      } catch (_) {}
    };

    // ====== íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ ì „í™˜ í—¬í¼ í•¨ìˆ˜ ======
    function gotoStep(step) {
      currentStep = step;
      stopAllEffects(); // ê¸°ì¡´ ëª¨ë“  ë°•ìŠ¤/ì„  íš¨ê³¼ ì¢…ë£Œ
      
      console.log(`[UI] ë‹¨ê³„ ì „í™˜: ${Object.keys(PipelineStep)[step]} (${step})`);
      
      // ğŸ“± ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ í•´ë‹¹ ì¹´ë“œ í‘œì‹œ ë° ìŠ¤í¬ë¡¤
      if (typeof isMobileEnvironment === 'function' && isMobileEnvironment()) {
        const cardMap = {
          0: 'gpt0',
          1: 'gpt1',
          2: 'gpt2',
          3: 'gpt3',
          4: 'gpt4'
        };
        const cardId = cardMap[step];
        if (cardId) {
          const card = getAgentCard(cardId);
          const panel = $rightPanel();
          if (card && panel) {
            // í•´ë‹¹ ì¹´ë“œë§Œ í‘œì‹œí•˜ê³  í¬ì»¤ìŠ¤
            card.style.display = 'block';
            card.style.visibility = 'visible';
            card.style.opacity = '1';
            
            // ìŠ¤í¬ë¡¤
            setTimeout(() => {
              panel.scrollTo({ top: card.offsetTop - 12, behavior: 'smooth' });
            }, 100);
          }
        }
      }
      
      switch (step) {
        case PipelineStep.GPT0:
          // ë°•ìŠ¤ íš¨ê³¼: ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ë•Œê¹Œì§€ ì§€ì†
          highlightCard('#card-gpt0');

          // ğŸ”¹ ì„ (ì—£ì§€) íš¨ê³¼ ì¶”ê°€: GPT0 ì‹œì‘ ì‹œ íë¦„ì„ ìœ ì§€
          //    - gpt0 â†’ gpt1ë¡œ ì´ì–´ì§€ëŠ” íë¦„ì„ í•¨ê»˜ ì¼¬(ì—°ì†ì„± ê°•ì¡°)
          highlightEdge('.to-gpt0, .to-gpt1');

          setActiveRightTab('gpt0');
          highlightRightTab('gpt0');           // â–¼ ì¶”ê°€: ì‹¤í–‰ì¤‘ íƒ­ ê°•ì¡°
          
          // â˜… GPT0 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate'],
            ['.gpt1-anchor','.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf','.gpt4-anchor']
          );
          
          scrollIntoViewIfNeeded('#card-gpt0');
          expandOutputFor('gpt0');             // â–¼ B íŒŒíŠ¸ì—ì„œ ì •ì˜ (ì¶œë ¥ì˜ì—­ í™•ì¥)
          break;
        case PipelineStep.GPT1:
          highlightCard('#card-gpt1');
          // â˜… GPT2 ì„ ì  ê¸ˆì§€: ì—¬ê¸°ì„œ '.to-gpt2' ë¼ì¸/ìŠ¤í¬ë¡¤ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
          setActiveRightTab('gpt1');
          highlightRightTab('gpt1');           // â–¼ ì¶”ê°€
          
          // â˜… GPT1 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt1-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf','.gpt4-anchor']
          );
          
          scrollIntoViewIfNeeded('#card-gpt1');
          expandOutputFor('gpt1');             // â–¼ ì¶”ê°€
          break;
        case PipelineStep.GPT2:
          // GPT2 Worst ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ gotoStepì˜ ê¸°ë³¸ ë™ì‘ì„ ê±´ë„ˆë›°ê¸°
          const panel = document.querySelector('#gpt1-panel, .right-tab-panel');
          if (panel && panel.classList.contains('gpt2worst-mode')) {
            console.log('âš ï¸ GPT2 Worst ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ gotoStep ê¸°ë³¸ ë™ì‘ì„ ê±´ë„ˆëœë‹ˆë‹¤');
            break;
          }
          
          highlightCard('#card-gpt2');
          highlightEdge('.to-gpt2'); // GPT2 ì‹œì‘ ì‹œì ì—ë§Œ
          setActiveRightTab('gpt2');
          highlightRightTab('gpt2');           // â–¼ ì¶”ê°€
          
          // â˜… GPT2 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt2-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf','.gpt4-anchor']
          );
          
          scrollIntoViewIfNeeded('#card-gpt2');
          expandOutputFor('gpt2');             // â–¼ ì¶”ê°€
          break;
        case PipelineStep.GPT3:
          highlightCard('#card-gpt3');
          highlightEdge('.to-gpt3');
          setActiveRightTab('gpt3');
          highlightRightTab('gpt3');           // â–¼ ì¶”ê°€
          
          // â˜… GPT3 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']
          );
          
          // ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ ë³´ê°•
          highlightCard('#card-gpt3');
          highlightEdge('.to-gpt3');
          
          scrollIntoViewIfNeeded('#card-gpt3');
          expandOutputFor('gpt3');             // â–¼ ì¶”ê°€
          break;
        case PipelineStep.GPT4:
          highlightCard('#card-gpt4');
          highlightEdge('.to-gpt4');
          setActiveRightTab('gpt4');
          highlightRightTab('gpt4');           // â–¼ ì¶”ê°€
          
          // â˜… GPT4 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt4-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf']
          );
          
          // ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ ë³´ê°•
          highlightCard('#card-gpt4');
          highlightEdge('.to-gpt4');
          
          scrollIntoViewIfNeeded('#card-gpt4');
          expandOutputFor('gpt4');             // â–¼ ì¶”ê°€
          break;
      }
    }

    function scrollIntoViewIfNeeded(sel) {
      const el = document.querySelector(sel);
      if (!el) return;
      if (window.__userDraggingTab) return;

      const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel');
      if (panel && panel.contains(el)) {
        const targetY = Math.max(
          0,
          (el.offsetTop || 0) - (panel.clientHeight / 2) + (el.clientHeight / 2)
        );
        panel.scrollTo({ top: targetY, behavior: 'smooth' });
      } else {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function stopAllEffects() {
      // ëª¨ë“  ë°•ìŠ¤/ì„  íš¨ê³¼ ì¢…ë£Œ
      d3.selectAll('.pipeline-line').classed('flow', false);
      
      // â˜… ì „ì—­ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  íƒ­ íš¨ê³¼ í•´ì œ
      window.setRightTabRunning([], [
        '.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
        '.gpt1-anchor','.gpt2-anchor',
        '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
        '.gpt4-anchor'
      ]);
      
      // ğŸ”¹ ì¹´ë“œ íš¨ê³¼ë„ í•¨ê»˜ ì •ë¦¬ (running í´ë˜ìŠ¤ ì œê±°)
      document.querySelectorAll('.agent-card').forEach(card => {
        card.classList.remove('running');
      });
      
      document.querySelectorAll('.progress-indicator').forEach(el => {
        el.classList.remove('progress-indicator');
      });
      document.querySelectorAll('.execution-overlay').forEach(el => {
        el.remove();
      });
    }

    function highlightCard(sel) {
      // í•´ë‹¹ ì¹´ë“œ(ë°•ìŠ¤) íš¨ê³¼ ì‹œì‘ - ì§€ì† ìœ ì§€(ë‹¤ìŒ ë‹¨ê³„ ì „í™˜ ì‹œ í•´ì œ)
      const card = document.querySelector(sel);
      if (!card) return;

      // ê¸°ì¡´ 'active' ë‹¨ë°œì„±(2ì´ˆ) íš¨ê³¼ ì œê±° â†’ ì§€ì†í˜• í´ë˜ìŠ¤ë¡œ ì „í™˜
      card.classList.remove('active');
      card.classList.add('running');  // âš ï¸ CSSì— .running ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ë„ë¡(ì•„ë˜ ì•ˆë‚´ ì°¸ê³ )
    }

    function highlightEdge(sel) {
      // í•´ë‹¹ ë¼ì¸(ì—£ì§€) íš¨ê³¼ ì‹œì‘
      if (sel) {
        d3.selectAll('.pipeline-line').classed('flow', false);
        d3.selectAll(sel).classed('flow', true);
      }
    }

    function setActiveRightTab(key) {
      // ê¸°ë³¸ active í† ê¸€ ë™ì‘ ìœ ì§€
      try {
        const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel');
        const card = document.getElementById(`card-${key}`);
        if (panel && card) {
          const y = Math.max(0, (card.offsetTop || 0) - 40);
          panel.scrollTo({ top: y, behavior: 'smooth' });
        }
      } catch (e) {
        console.warn('íƒ­ í™œì„±í™” ì¤‘ ì˜¤ë¥˜:', e);
      }
    }

    /* â–¼ ì‹ ê·œ ì¶”ê°€: íŒŒì´í”„ë¼ì¸ "ì‹¤í–‰ì¤‘" í•˜ì´ë¼ì´íŠ¸ ì „ìš© */
    function highlightRightTab(tabKey) {
      // ëª¨ë“  íƒ­ì—ì„œ running ì œê±°
      document.querySelectorAll('.agent-card.running').forEach(el => el.classList.remove('running'));

      // ëŒ€ìƒ íƒ­ì— running ë¶€ì—¬(ì§€ì† ê°•ì¡°)
      const target = document.getElementById(`card-${tabKey}`);
      if (target) target.classList.add('running');
    }

    /* â–¼ ì‹ ê·œ: ë‹¨ê³„ë³„ ì¶œë ¥ ì»¨í…Œì´ë„ˆ í™•ì¥ ìœ í‹¸ */
    function expandOutputFor(stepKey) {
      // 1) ì£¼ ì…€ë ‰í„°: #gptN-output
      const sel1 = `#${stepKey}-output`;

      // 2) ëŒ€ì•ˆ ì…€ë ‰í„°(data-attr ê¸°ë°˜)
      const sel2 = `.output-panel[data-output="${stepKey}"]`;

      // 3) ìš°ì„ ìˆœìœ„ëŒ€ë¡œ íƒìƒ‰
      const panel =
        document.querySelector(sel1) ||
        document.querySelector(sel2);

      if (!panel) return;

      // details ìš”ì†Œë©´ open, ì¼ë°˜ divë©´ expanded
      const isDetails = panel.tagName?.toLowerCase() === 'details';
      if (isDetails) {
        panel.setAttribute('open', '');
      }
      panel.classList.add('expanded');
    }

    // ====== ì•ˆì „í•œ ìˆ«ì í¬ë§¤íŒ… ê°€ë“œ ======
    function safeToFixed(val, digits = 2) {
      const num = Number(val);
      if (!isFinite(num)) return '-';
      try { 
        return num.toFixed(digits); 
      } catch { 
        return '-'; 
      }
    }

    // ====== UI ìš”ì†Œ ======
    const indicatorListUl = document.getElementById('indicator-list'); // This element is no longer used for the list
    const indicatorCardsDiv = document.getElementById('indicator-cards'); // New element for indicator cards
    const networkGraphDiv = document.getElementById('network-graph');

    // ====== ìƒíƒœ ======
    let scenarioData = {}; // {n: {overview, indicators, keywords, links, impacts}}
    let scenarioIdToNum = {}; // Scenario_ID -> n
    let indicatorIdToNameMap = new Map(); // ì „ì—­ ID-Name ë§µ (ID -> Bloomberg Ticker)
    let indicatorIdToDisplayNameMap = new Map(); // ì „ì—­ ID-DisplayName ë§µ (ID -> Indicator_Name)
    let selectedIndicators = new Set(); // New state for selected indicators
    let keywordNewsData = []; // keyword_news.xlsx ì „ì²´ ë¡œìš° ì €ì¥
    let keywordBaseData = []; // keyword.xlsx ì „ì²´ ë¡œìš° ì €ì¥
    const keywordByScenarioId = new Map(); // Scenario_ID -> [{text}]
    const keywordByScenarioNum = new Map(); // ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸(n) -> [{text}]
    const newsMetaByScenarioId = new Map(); // Scenario_ID -> Map(text -> {phase,title,press,url})
    const newsMetaByScenarioNum = new Map(); // ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ -> Map(text -> {phase,title,press,url})
    const normalizeScenarioId = (id)=> String(id||'').trim().toUpperCase();
    const scenarioIdToNumber = (id)=>{ const m = String(id||'').match(/\d{1,3}/); return m? parseInt(m[0],10): null; };
    const normalizeKeywordText = (text) => String(text || '')
      .normalize('NFKC')
      .replace(/[\u3000]/g, ' ')
      .replace(/[ï¼ˆï¼‰ï¼»ï¼½ã€ã€‘]/g, (m) => ({'ï¼ˆ':'(', 'ï¼‰':')', 'ï¼»':'[', 'ï¼½':']', 'ã€':'[', 'ã€‘':']'}[m] || m))
      .replace(/\s+/g, ' ')
      .trim();

    function simplifyForCompare(text) {
      return normalizeKeywordText(text)
        .toLowerCase()
        .replace(/[^\p{L}\p{N}]/gu, '');
    }

    function findNewsMeta(scenKey, scenNum, ktext) {
      const norm = normalizeKeywordText(ktext);
      const byNum = newsMetaByScenarioNum.get(scenNum);
      const byId = newsMetaByScenarioId.get(scenKey);
      let meta = (byNum && byNum.get(norm)) || (byId && byId.get(norm)) || null;
      if (meta) return meta;
      const targetSimple = simplifyForCompare(norm);
      const searchMap = (m) => {
        if (!m) return null;
        for (const [k, v] of m) {
          if (simplifyForCompare(k) === targetSimple) return v;
        }
        return null;
      };
      return searchMap(byNum) || searchMap(byId) || null;
    }
    
    // ë³´ê³ ì„œ ìƒíƒœ ê´€ë¦¬
    let reportState = {
      isGenerated: false,
      htmlContent: ''
    };
    
    // ê·¸ë˜í”„ ìƒíƒœ(ì™¸ë¶€ ì œì–´ìš©)
      let graphState = {
      g: null,
      svg: null,
      currentTransform: { x: 0, y: 0, scale: 1 },
      containerRect: null,
      width: 0,
      height: 0,
      posByScenarioNum: new Map(),
        gptAnchors: {},
        pipelineRunning: false,
        lockedHighlight: null,
        clearHighlight: null
    };

    // ====== ë‹¤í¬ëª¨ë“œ ======
    function toggleDarkMode() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      
      // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ ë³€ê²½ (ë¶„ì„ì‹¤í–‰, ë³´ê³ ì„œë³´ê¸°, ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ ì œì™¸)
      const toggleBtn = document.querySelector('.darkmode-toggle:not(#top-pipeline-btn):not(.analysis-start-btn):not(#btn-export-html):not(#btn-restart-pipeline)');
      if (toggleBtn) {
        toggleBtn.textContent = newTheme === 'dark' ? 'ğŸŒ™ ë‹¤í¬' : 'â˜€ï¸ ë¼ì´íŠ¸';
      }
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í…Œë§ˆ ì €ì¥
      localStorage.setItem('theme', newTheme);
      
      console.log(`Theme changed to: ${newTheme}`);
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í…Œë§ˆ ì ìš©
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark'; // ê¸°ë³¸ê°’: dark
      document.body.setAttribute('data-theme', savedTheme);
      
      // í† ê¸€ ë²„íŠ¼ ì•„ì´ì½˜ ì„¤ì • (ë¶„ì„ì‹¤í–‰, ë³´ê³ ì„œë³´ê¸°, ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ ì œì™¸)
      const toggleBtn = document.querySelector('.darkmode-toggle:not(#top-pipeline-btn):not(.analysis-start-btn):not(#btn-export-html):not(#btn-restart-pipeline)');
      if (toggleBtn) {
        toggleBtn.textContent = savedTheme === 'dark' ? 'ğŸŒ™ ë‹¤í¬' : 'â˜€ï¸ ë¼ì´íŠ¸';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    function initializePage() {
      initializeTheme();
      initializeCardGuidance();
      setupDragScrollDetection();
    }

    // ì¹´ë“œ ì•ˆë‚´ í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸° ê³ ì • ë¬¸êµ¬ë¡œ ì„¸íŒ…
    function initializeCardGuidance(){
      const g1 = document.getElementById('gpt1-suggest');
      if (g1) {
        g1.textContent = 'â€¢ ëª©í‘œ: í•µì‹¬ ìš”ì•½ ë° ë©”ì‹œì§€ êµ¬ì„±\nâ€¢ ë°ì´í„°(ì¼ë¶€ ë¯¸ë¦¬ë³´ê¸°): ìš°ì¸¡ ìƒë‹¨ ì„ íƒ ì‹œ ê°±ì‹ \nâ€¢ ì‚°ì¶œ: í•µì‹¬ í¬ì¸íŠ¸ 3~5ê°œì™€ ê·¼ê±°';
        g1.classList.add('show');
      }
      const g2 = document.getElementById('gpt2-suggest');
      if (g2) {
        g2.textContent = 'â€¢ ëª©í‘œ: ë„ë©”ì¸ë³„ ì…ë ¥ ë¶„ë°°Â·ì •ì œ(ì‹œì¥/ì‹ ìš©/ALM/ê¸€ë¡œë²Œ/ì‹ ìš©PF)\nâ€¢ ì…ë ¥: GPT1 ì‚°ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ ê³„íš ìˆ˜ë¦½\nâ€¢ ì‚°ì¶œ: ë„ë©”ì¸ë³„ ê³¼ì—…/í•„ìš” ë°ì´í„°/ì¶œë ¥ í¬ë§·';
        g2.classList.add('show');
      }
      const g3 = document.getElementById('gpt3-suggest');
      if (g3) {
        g3.textContent = 'ê° ë„ë©”ì¸(ì‹œì¥/ì‹ ìš©/ALM/ê¸€ë¡œë²Œ/ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤) ê´€ì ì—ì„œ ì˜í–¥ ê²½ë¡œì™€ ë¦¬ìŠ¤í¬ ì§€í‘œ ë„ì¶œ.';
        g3.classList.add('show');
      }
      const g4 = document.getElementById('gpt4-suggest');
      if (g4) {
        g4.textContent = 'ë„ë©”ì¸ ê²°ê³¼ë¥¼ ì·¨í•©í•˜ì—¬ ë³´ê³ ìš© ìµœì¢… ë¦¬í¬íŠ¸ ì‘ì„±(ìš”ì•½/ê·¼ê±°/ê¶Œê³ ì•ˆ).';
        g4.classList.add('show');
      }
    }
    // ====== Excel íŒŒì¼ ë¡œë”© ======
    // ë©”ì¸ ì§€í‘œ íŒŒì¼ ë¡œë”©
    async function loadMainIndicatorFile() {
      try {
        const url = 'go_scen/data/indicator.xlsx';
        console.log(`ğŸ” ì§€í‘œ íŒŒì¼ ë¡œë“œ ì‹œë„: ${url}`);
        
        const resp = await fetch(url);
        if (!resp.ok) {
          console.error(`âŒ ì§€í‘œ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: HTTP ${resp.status} ${resp.statusText}`);
          console.error(`íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”: ${url}`);
          throw new Error(`Failed to load main indicator file: ${resp.status}`);
        }
        
        const arrayBuffer = await resp.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type:'array'});
        
        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
          console.error('âŒ Excel íŒŒì¼ì— ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
          return [];
        }
        
        console.log(`ğŸ“Š Excel ì‹œíŠ¸ëª…ë“¤: ${workbook.SheetNames.join(', ')}`);
        
        // ì²« ë²ˆì§¸ ì‹œíŠ¸ì—ì„œ ì§€í‘œ ì •ë³´ ì½ê¸°
        const indicatorSheet = workbook.Sheets[workbook.SheetNames[0]];
        const indicators = indicatorSheet ? XLSX.utils.sheet_to_json(indicatorSheet) : [];
        
        console.log(`âœ… ë©”ì¸ ì§€í‘œ íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${indicators.length}ê°œ ì§€í‘œ`);
        if (indicators.length > 0) {
          console.log('ğŸ“‹ ì§€í‘œ ë°ì´í„° ìƒ˜í”Œ (ì²« 3ê°œ):', indicators.slice(0, 3));
          console.log('ğŸ“‹ ì§€í‘œ ì»¬ëŸ¼ë“¤:', Object.keys(indicators[0]));
        } else {
          console.warn('âš ï¸ ì§€í‘œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. Excel íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        return indicators;
      } catch(e) {
        console.error('âŒ ë©”ì¸ ì§€í‘œ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜:', e);
        console.error('ğŸ“ íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”: go_scen/data/indicator.xlsx');
        console.error('ğŸ”§ íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ì˜¬ë°”ë¥¸ Excel í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
        return [];
      }
    }

  // ë§ˆì¼“ë°ì´í„° íŒŒì¼ ë¡œë”© í•¨ìˆ˜
  async function loadMarketDataFile() {
    try {
      const url = 'go_scen/data/market_data/market_data.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load market_data.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²« ë²ˆì§¸ ì‹œíŠ¸ì—ì„œ ë§ˆì¼“ë°ì´í„° ì½ê¸°
      const marketSheet = workbook.Sheets[workbook.SheetNames[0]];
      const marketData = marketSheet ? XLSX.utils.sheet_to_json(marketSheet) : [];
      
      console.log('ğŸ” ë§ˆì¼“ë°ì´í„° ì›ë³¸ ë°ì´í„°:', marketData.slice(0, 3));
      console.log('ğŸ” ë§ˆì¼“ë°ì´í„° ì»¬ëŸ¼ëª…:', Object.keys(marketData[0] || {}));
      
      // ì‹œë‚˜ë¦¬ì˜¤ë³„ë¡œ ë°ì´í„° ì •ë¦¬
      marketDataByScenario = {};
      let marketProcessedCount = 0;
      let marketSkippedCount = 0;
      
      marketData.forEach((row, index) => {
        console.log(`ğŸ” ë§ˆì¼“ë°ì´í„° í–‰ ${index + 1}:`, row);
        console.log(`ğŸ” í–‰ ${index + 1}ì˜ ëª¨ë“  ì»¬ëŸ¼ëª…:`, Object.keys(row));
        
        // ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… ëŒ€ì‘ - ë” ì²´ê³„ì ìœ¼ë¡œ ê²€ìƒ‰
        let id = null;
        let data = null;
        
        // id ì»¬ëŸ¼ ê²€ìƒ‰ (ì •í™•í•œ ë§¤ì¹­ ìš°ì„ )
        if (row.id) {
          id = row.id;
          console.log(`âœ… id ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${id}"`);
        } else if (row.ID) {
          id = row.ID;
          console.log(`âœ… ID ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${id}"`);
        } else if (row.Id) {
          id = row.Id;
          console.log(`âœ… Id ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${id}"`);
        } else {
          // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
          const idKeys = Object.keys(row).filter(key => 
            key.toLowerCase() === 'id'
          );
          if (idKeys.length > 0) {
            id = row[idKeys[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ id ì»¬ëŸ¼ ì°¾ìŒ: "${idKeys[0]}" = "${id}"`);
          }
        }
        
        // data ì»¬ëŸ¼ ê²€ìƒ‰
        if (row.data) {
          data = row.data;
          console.log(`âœ… data ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${data}"`);
        } else if (row.Data) {
          data = row.Data;
          console.log(`âœ… Data ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${data}"`);
        } else if (row.DATA) {
          data = row.DATA;
          console.log(`âœ… DATA ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${data}"`);
        } else {
          // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
          const dataKeys = Object.keys(row).filter(key => 
            key.toLowerCase() === 'data'
          );
          if (dataKeys.length > 0) {
            data = row[dataKeys[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ data ì»¬ëŸ¼ ì°¾ìŒ: "${dataKeys[0]}" = "${data}"`);
          }
        }
        
        console.log(`ğŸ” ìµœì¢… íŒŒì‹±ëœ ì •ë³´: id="${id}", data="${data}"`);
        
        if (id && data) {
          // idì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: "IND001:returns" -> "IND001")
          const parts = String(id).split(':');
          const indicatorId = parts[0];
          const dataType = parts[1];
          
          if (!marketDataByScenario[indicatorId]) {
            marketDataByScenario[indicatorId] = {};
          }
          
          try {
            // JSON íŒŒì‹±
            const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
            marketDataByScenario[indicatorId][dataType] = parsedData;
            marketProcessedCount++;
            console.log(`âœ… ë§ˆì¼“ë°ì´í„° ì¶”ê°€: ${indicatorId}.${dataType}`);
          } catch (e) {
            console.warn(`JSON íŒŒì‹± ì‹¤íŒ¨: ${id}`, e);
            marketSkippedCount++;
          }
        } else {
          marketSkippedCount++;
          console.log(`âŒ ê±´ë„ˆë›´ ë§ˆì¼“ë°ì´í„° í–‰ ${index + 1}: id="${id}", data="${data}"`);
        }
      });
      
      console.log(`ğŸ“Š ë§ˆì¼“ë°ì´í„° ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬ë¨ ${marketProcessedCount}ê°œ, ê±´ë„ˆë›´ ${marketSkippedCount}ê°œ`);
      
      // ì‚¬ìš© ê°€ëŠ¥í•œ ID íŒ¨í„´ ì˜ˆì‹œ ì¶œë ¥
      const availableIds = Object.keys(marketDataByScenario);
      if (availableIds.length > 0) {
        console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ID íŒ¨í„´ ì˜ˆì‹œ:');
        availableIds.slice(0, 5).forEach(id => {
          const dataTypes = Object.keys(marketDataByScenario[id]);
          console.log(`  ${id}: ${dataTypes.join(', ')}`);
        });
      }
      
      console.log(`âœ… ë§ˆì¼“ë°ì´í„° íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${Object.keys(marketDataByScenario).length}ê°œ ì§€í‘œ`);
      console.log('ë§ˆì¼“ë°ì´í„° ìƒ˜í”Œ:', Object.keys(marketDataByScenario).slice(0, 3));
      
      return marketDataByScenario;
    } catch(e) {
      console.error('Error loading market_data.xlsx:', e);
      marketDataByScenario = {};
      return {};
    }
  }

  // ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ íŒŒì¼ ë¡œë”© í•¨ìˆ˜
  async function loadIndicatorMappingFile() {
    try {
      const url = 'go_scen/data/indicator.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load indicator.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²« ë²ˆì§¸ ì‹œíŠ¸ì—ì„œ ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì½ê¸°
      const indicatorSheet = workbook.Sheets[workbook.SheetNames[0]];
      const indicatorData = indicatorSheet ? XLSX.utils.sheet_to_json(indicatorSheet) : [];
      
      console.log('ğŸ” ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì›ë³¸ ë°ì´í„°:', indicatorData.slice(0, 3));
      console.log('ğŸ” ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì»¬ëŸ¼ëª…:', Object.keys(indicatorData[0] || {}));
      
      // ë§¤í•‘ ë°ì´í„° ì •ë¦¬
      indicatorToScenarioMap.clear();
      scenarioToIndicatorsMap.clear();
      let mappingProcessedCount = 0;
      let mappingSkippedCount = 0;
      
      indicatorData.forEach((row, index) => {
        console.log(`ğŸ” ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ í–‰ ${index + 1}:`, row);
        
        // ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… ëŒ€ì‘
        let indicatorId = null;
        let indicatorName = null;
        let bloombergTicker = null;
        let scenarioReport = null;
        
        // Indicator_ID ì»¬ëŸ¼ ê²€ìƒ‰
        if (row['Indicator_ID']) {
          indicatorId = row['Indicator_ID'];
        } else if (row['indicator_id']) {
          indicatorId = row['indicator_id'];
        } else if (row['IndicatorID']) {
          indicatorId = row['IndicatorID'];
        }
        
        // Indicator_Name ì»¬ëŸ¼ ê²€ìƒ‰
        if (row['Indicator_Name']) {
          indicatorName = row['Indicator_Name'];
        } else if (row['indicator_name']) {
          indicatorName = row['indicator_name'];
        } else if (row['IndicatorName']) {
          indicatorName = row['IndicatorName'];
        }
        
        // Bloomberg_Ticker ì»¬ëŸ¼ ê²€ìƒ‰
        if (row['Bloomberg_Ticker']) {
          bloombergTicker = row['Bloomberg_Ticker'];
        } else if (row['bloomberg_ticker']) {
          bloombergTicker = row['bloomberg_ticker'];
        } else if (row['BloombergTicker']) {
          bloombergTicker = row['BloombergTicker'];
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ ì»¬ëŸ¼ ê²€ìƒ‰
        if (row['ì‹œë‚˜ë¦¬ì˜¤']) {
          scenarioReport = row['ì‹œë‚˜ë¦¬ì˜¤'];
        } else if (row['scenario']) {
          scenarioReport = row['scenario'];
        } else if (row['Scenario']) {
          scenarioReport = row['Scenario'];
        }
        
        console.log(`ğŸ” íŒŒì‹±ëœ ì •ë³´: ID=${indicatorId}, Name=${indicatorName}, Ticker=${bloombergTicker}, Scenario=${scenarioReport}`);
        
        if (indicatorId && scenarioReport) {
          // ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ ì¶”ì¶œ (scenario_report_18 -> 18, scenario_report_04 -> 4)
          const scenarioMatch = String(scenarioReport).match(/scenario_report_(\d+)/);
          if (scenarioMatch) {
            const scenarioNumber = parseInt(scenarioMatch[1]);
            const fallbackMeta = (!indicatorName || !bloombergTicker)
              ? findIndicatorMetaFromScenario(indicatorId, scenarioNumber)
              : null;
            const finalIndicatorName = indicatorName || fallbackMeta?.name || '';
            const finalBloombergTicker = bloombergTicker || fallbackMeta?.ticker || '';
            
            // ë§¤í•‘ ì €ì¥
            indicatorToScenarioMap.set(indicatorId, {
              scenarioNumber,
              indicatorName: finalIndicatorName,
              bloombergTicker: finalBloombergTicker,
              scenarioReport
            });
            
            if (!scenarioToIndicatorsMap.has(scenarioNumber)) {
              scenarioToIndicatorsMap.set(scenarioNumber, []);
            }
            scenarioToIndicatorsMap.get(scenarioNumber).push({
              indicatorId,
              indicatorName: finalIndicatorName,
              bloombergTicker: finalBloombergTicker,
              scenarioReport
            });
            
            mappingProcessedCount++;
            console.log(`âœ… ë§¤í•‘ ì¶”ê°€: ${indicatorId} -> ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}`);
          } else {
            mappingSkippedCount++;
            console.log(`âŒ ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ ì¶”ì¶œ ì‹¤íŒ¨: ${scenarioReport}`);
          }
        } else {
          mappingSkippedCount++;
          console.log(`âŒ í•„ìˆ˜ ë°ì´í„° ëˆ„ë½: ID=${indicatorId}, Scenario=${scenarioReport}`);
        }
      });
      
      console.log(`ğŸ“Š ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬ë¨ ${mappingProcessedCount}ê°œ, ê±´ë„ˆë›´ ${mappingSkippedCount}ê°œ`);
      console.log('ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì§€í‘œ ë§¤í•‘ ìš”ì•½:');
      scenarioToIndicatorsMap.forEach((indicators, scenarioNum) => {
        console.log(`  ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNum}: ${indicators.map(i => i.indicatorId).join(', ')}`);
      });
      
      return { indicatorToScenarioMap, scenarioToIndicatorsMap };
    } catch (error) {
      console.error('âŒ ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ íŒŒì¼ ë¡œë”© ì‹¤íŒ¨:', error);
      return { indicatorToScenarioMap: new Map(), scenarioToIndicatorsMap: new Map() };
    }
  }

  // ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ íŒŒì¼ ë¡œë”© í•¨ìˆ˜
  async function loadScenarioSummaryFile() {
    try {
      const url = 'go_scen/data/market_data/scenario_summary.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load scenario_summary.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²« ë²ˆì§¸ ì‹œíŠ¸ì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ì½ê¸°
      const summarySheet = workbook.Sheets[workbook.SheetNames[0]];
      const summaryData = summarySheet ? XLSX.utils.sheet_to_json(summarySheet) : [];
      
      console.log('ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ì›ë³¸ ë°ì´í„°:', summaryData.slice(0, 3));
      console.log('ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ì»¬ëŸ¼ëª…:', Object.keys(summaryData[0] || {}));
      
      // ì‹œë‚˜ë¦¬ì˜¤IDë³„ë¡œ ë°ì´í„° ì •ë¦¬
      scenarioSummaryByScenarioId = {};
      let summaryProcessedCount = 0;
      let summarySkippedCount = 0;
      
      summaryData.forEach((row, index) => {
        console.log(`ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ í–‰ ${index + 1}:`, row);
        console.log(`ğŸ” í–‰ ${index + 1}ì˜ ëª¨ë“  ì»¬ëŸ¼ëª…:`, Object.keys(row));
        
        // ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… ëŒ€ì‘ - ë” ì²´ê³„ì ìœ¼ë¡œ ê²€ìƒ‰
        let scenarioId = null;
        let content = null;
        
        // Scenario_ID ì»¬ëŸ¼ ê²€ìƒ‰ (ì •í™•í•œ ë§¤ì¹­ ìš°ì„ )
        if (row['Scenario_ID']) {
          scenarioId = row['Scenario_ID'];
          console.log(`âœ… Scenario_ID ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['ì‹œë‚˜ë¦¬ì˜¤ID']) {
          scenarioId = row['ì‹œë‚˜ë¦¬ì˜¤ID'];
          console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ID ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['scenario_id']) {
          scenarioId = row['scenario_id'];
          console.log(`âœ… scenario_id ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${scenarioId}"`);
        } else {
          // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
          const scenarioKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('scenario') || 
            key.toLowerCase().includes('ì‹œë‚˜ë¦¬ì˜¤')
          );
          if (scenarioKeys.length > 0) {
            scenarioId = row[scenarioKeys[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ì‹œë‚˜ë¦¬ì˜¤ ì»¬ëŸ¼ ì°¾ìŒ: "${scenarioKeys[0]}" = "${scenarioId}"`);
          }
        }
        
        // ë‚´ìš© ì»¬ëŸ¼ ê²€ìƒ‰
        if (row['ë‚´ìš©']) {
          content = row['ë‚´ìš©'];
          console.log(`âœ… ë‚´ìš© ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${content}"`);
        } else if (row['Content']) {
          content = row['Content'];
          console.log(`âœ… Content ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${content}"`);
        } else {
          // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
          const contentKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('content') || 
            key.toLowerCase().includes('ë‚´ìš©') ||
            key.toLowerCase().includes('ìš”ì•½')
          );
          if (contentKeys.length > 0) {
            content = row[contentKeys[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ë‚´ìš© ì»¬ëŸ¼ ì°¾ìŒ: "${contentKeys[0]}" = "${content}"`);
          }
        }
        
        console.log(`ğŸ” ìµœì¢… íŒŒì‹±ëœ ì •ë³´: scenarioId="${scenarioId}", content="${content}"`);
        
        if (scenarioId && content) {
          const cleanScenarioId = String(scenarioId).trim();
          const cleanContent = String(content).trim();
          scenarioSummaryByScenarioId[cleanScenarioId] = cleanContent;
          summaryProcessedCount++;
          console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ì¶”ê°€: ${cleanScenarioId}`);
        } else {
          summarySkippedCount++;
          console.log(`âŒ ê±´ë„ˆë›´ ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ í–‰ ${index + 1}: scenarioId="${scenarioId}", content="${content}"`);
        }
      });
      
      console.log(`ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬ë¨ ${summaryProcessedCount}ê°œ, ê±´ë„ˆëœ€ ${summarySkippedCount}ê°œ`);
      
      console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${Object.keys(scenarioSummaryByScenarioId).length}ê°œ ì‹œë‚˜ë¦¬ì˜¤`);
      console.log('ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ìƒ˜í”Œ:', Object.keys(scenarioSummaryByScenarioId).slice(0, 3));
      console.log('ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ìƒì„¸ êµ¬ì¡°:', scenarioSummaryByScenarioId);
      
      // SC004, SC022 íŠ¹ë³„ í™•ì¸
      ['SC004', 'SC022'].forEach(scenarioId => {
        if (scenarioSummaryByScenarioId[scenarioId]) {
          console.log(`ğŸ¯ ${scenarioId} ìš”ì•½ ë°ì´í„° í™•ì¸:`, scenarioSummaryByScenarioId[scenarioId]);
        } else {
          console.log(`âŒ ${scenarioId} ìš”ì•½ ë°ì´í„° ì—†ìŒ`);
          // ìœ ì‚¬í•œ í‚¤ ì°¾ê¸°
          const scenarioNum = scenarioId.replace('SC', '');
          const similarKeys = Object.keys(scenarioSummaryByScenarioId).filter(key => 
            key.includes(scenarioNum) || 
            key.includes(scenarioId) || 
            key.includes(scenarioId.replace('SC', ''))
          );
          console.log(`ğŸ” ${scenarioId}ì™€ ìœ ì‚¬í•œ í‚¤ë“¤:`, similarKeys);
        }
      });
      
      return scenarioSummaryByScenarioId;
    } catch(e) {
      console.error('Error loading scenario_summary.xlsx:', e);
      scenarioSummaryByScenarioId = {};
      return {};
    }
  }

  // í‚¤ì›Œë“œ ë‰´ìŠ¤ íŒŒì¼ ë¡œë”© í•¨ìˆ˜
  async function loadKeywordNewsFile() {
    try {
      const url = 'go_scen/data/news/bigkinds/daily_news/keyword_news.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load keyword_news.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²« ë²ˆì§¸ ì‹œíŠ¸ì—ì„œ í‚¤ì›Œë“œ ë‰´ìŠ¤ ì½ê¸°
      const newsSheet = workbook.Sheets[workbook.SheetNames[0]];
      const newsData = newsSheet ? XLSX.utils.sheet_to_json(newsSheet) : [];
      
      console.log('ğŸ” ë‰´ìŠ¤ë°ì´í„° ì›ë³¸ ë°ì´í„°:', newsData.slice(0, 3));
      console.log('ğŸ” ë‰´ìŠ¤ë°ì´í„° ì»¬ëŸ¼ëª…:', Object.keys(newsData[0] || {}));
      
      // ì‹œë‚˜ë¦¬ì˜¤IDë³„ë¡œ ë°ì´í„° ì •ë¦¬
      keywordNewsByScenarioId = {};
      let processedCount = 0;
      let skippedCount = 0;
      
      newsData.forEach((row, index) => {
        console.log(`ğŸ” ë‰´ìŠ¤ ë°ì´í„° í–‰ ${index + 1}:`, row);
        console.log(`ğŸ” í–‰ ${index + 1}ì˜ ëª¨ë“  ì»¬ëŸ¼ëª…:`, Object.keys(row));
        
        // ë‹¤ì–‘í•œ ì»¬ëŸ¼ëª… ëŒ€ì‘ - ë” ì²´ê³„ì ìœ¼ë¡œ ê²€ìƒ‰
        let scenarioId = null;
        let newsContent = null;
        let keyword = null;
        let url = null;
        let title = null;
        let press = null;
        
        // Scenario_ID ì»¬ëŸ¼ ê²€ìƒ‰ (ì •í™•í•œ ë§¤ì¹­ ìš°ì„ )
        if (row['Scenario_ID']) {
          scenarioId = row['Scenario_ID'];
          console.log(`âœ… Scenario_ID ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['scenario_id']) {
          scenarioId = row['scenario_id'];
          console.log(`âœ… scenario_id ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['SCENARIO_ID']) {
          scenarioId = row['SCENARIO_ID'];
          console.log(`âœ… SCENARIO_ID ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${scenarioId}"`);
        } else {
          // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
          const scenarioKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('scenario') || 
            key.toLowerCase().includes('ì‹œë‚˜ë¦¬ì˜¤')
          );
          if (scenarioKeys.length > 0) {
            scenarioId = row[scenarioKeys[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ì‹œë‚˜ë¦¬ì˜¤ ì»¬ëŸ¼ ì°¾ìŒ: "${scenarioKeys[0]}" = "${scenarioId}"`);
          }
        }
        
        // news ì»¬ëŸ¼ ê²€ìƒ‰
        if (row['news']) {
          newsContent = row['news'];
          console.log(`âœ… news ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${newsContent}"`);
        } else if (row['News']) {
          newsContent = row['News'];
          console.log(`âœ… News ì»¬ëŸ¼ì—ì„œ ê°’ ì°¾ìŒ: "${newsContent}"`);
        } else {
          // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
          const newsKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('news') || 
            key.toLowerCase().includes('ë‰´ìŠ¤') ||
            key.toLowerCase().includes('ë‚´ìš©')
          );
          if (newsKeys.length > 0) {
            newsContent = row[newsKeys[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ë‰´ìŠ¤ ì»¬ëŸ¼ ì°¾ìŒ: "${newsKeys[0]}" = "${newsContent}"`);
          }
        }
        
        // ê¸°íƒ€ ì»¬ëŸ¼ë“¤ë„ ë™ì¼í•˜ê²Œ ê²€ìƒ‰
        keyword = row['News_kor'] || row['news_kor'] || row['NEWS_KOR'] || row['í‚¤ì›Œë“œ'] || row['ì£¼ì œ'] || '';
        url = row['URL'] || row['Url'] || row['url'] || row['ë§í¬'] || '';
        title = row['ì œëª©'] || row['Title'] || row['title'] || row['TITLE'] || '';
        press = row['ì–¸ë¡ ì‚¬'] || row['Press'] || row['press'] || row['ë§¤ì²´'] || '';
        
        console.log(`ğŸ” ìµœì¢… íŒŒì‹±ëœ ì •ë³´: scenarioId="${scenarioId}", newsContent="${newsContent}", keyword="${keyword}"`);
        
        // ì¡°ê±´ ê²€ì‚¬ ë° ì²˜ë¦¬ - ë” ìœ ì—°í•œ ì¡°ê±´
        if (scenarioId) {
          const cleanScenarioId = String(scenarioId).trim();
          
          // newsContentê°€ ë¹„ì–´ìˆì–´ë„ ê¸°ë³¸ ì •ë³´ëŠ” ì €ì¥
          const hasNewsContent = newsContent && String(newsContent).trim().length > 0;
          
          // SC004 íŠ¹ë³„ ë¡œê¹…
          if (cleanScenarioId === 'SC004') {
            console.log(`ğŸ¯ SC004 ë°ì´í„° ì²˜ë¦¬ ì¤‘:`);
            console.log(`  - ì›ë³¸ scenarioId: "${scenarioId}"`);
            console.log(`  - ì •ë¦¬ëœ scenarioId: "${cleanScenarioId}"`);
            console.log(`  - newsContent: "${newsContent}"`);
            console.log(`  - hasNewsContent: ${hasNewsContent}`);
            console.log(`  - keyword: "${keyword}"`);
            console.log(`  - title: "${title}"`);
            console.log(`  - press: "${press}"`);
          }
          
          if (hasNewsContent) {
            console.log(`âœ… ì™„ì „í•œ ë°ì´í„°: ì‹œë‚˜ë¦¬ì˜¤ ${cleanScenarioId}ì— ë‰´ìŠ¤ ì¶”ê°€`);
          } else {
            console.log(`âš ï¸ ë¶€ë¶„ ë°ì´í„°: ì‹œë‚˜ë¦¬ì˜¤ ${cleanScenarioId}ì— ê¸°ë³¸ ì •ë³´ë§Œ ì¶”ê°€ (ë‰´ìŠ¤ ë‚´ìš© ì—†ìŒ)`);
          }
          
          if (!keywordNewsByScenarioId[cleanScenarioId]) {
            keywordNewsByScenarioId[cleanScenarioId] = [];
          }
          
          const newsItem = {
            keyword: keyword ? String(keyword).trim() : '',
            news: hasNewsContent ? String(newsContent).trim() : 'ë‰´ìŠ¤ ë‚´ìš© ì—†ìŒ',
            url: url ? String(url).trim() : '',
            title: title ? String(title).trim() : '',
            press: press ? String(press).trim() : ''
          };
          
          keywordNewsByScenarioId[cleanScenarioId].push(newsItem);
          
          // SC004 íŠ¹ë³„ ë¡œê¹…
          if (cleanScenarioId === 'SC004') {
            console.log(`  - ì¶”ê°€ëœ ë‰´ìŠ¤ ì•„ì´í…œ:`, newsItem);
            console.log(`  - í˜„ì¬ SC004 ë°°ì—´ ê¸¸ì´: ${keywordNewsByScenarioId[cleanScenarioId].length}`);
          }
          
          processedCount++;
        } else {
          console.log(`âŒ ê±´ë„ˆë›´ í–‰ ${index + 1}: scenarioId="${scenarioId}", newsContent="${newsContent}"`);
          skippedCount++;
        }
      });
      
      console.log(`ğŸ“Š ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬ë¨ ${processedCount}ê°œ, ê±´ë„ˆëœ€ ${skippedCount}ê°œ`);
      
      console.log(`âœ… í‚¤ì›Œë“œ ë‰´ìŠ¤ íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${Object.keys(keywordNewsByScenarioId).length}ê°œ ì‹œë‚˜ë¦¬ì˜¤`);
      console.log('í‚¤ì›Œë“œ ë‰´ìŠ¤ ìƒ˜í”Œ:', Object.keys(keywordNewsByScenarioId).slice(0, 3));
      console.log('í‚¤ì›Œë“œ ë‰´ìŠ¤ ìƒì„¸ êµ¬ì¡°:', keywordNewsByScenarioId);
      
      // SC004, SC022 íŠ¹ë³„ í™•ì¸
      ['SC004', 'SC022'].forEach(scenarioId => {
        if (keywordNewsByScenarioId[scenarioId]) {
          console.log(`ğŸ¯ ${scenarioId} ë‰´ìŠ¤ ë°ì´í„° í™•ì¸:`, keywordNewsByScenarioId[scenarioId]);
        } else {
          console.log(`âŒ ${scenarioId} ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ`);
          // ìœ ì‚¬í•œ í‚¤ ì°¾ê¸°
          const scenarioNum = scenarioId.replace('SC', '');
          const similarKeys = Object.keys(keywordNewsByScenarioId).filter(key => 
            key.includes(scenarioNum) || 
            key.includes(scenarioId) || 
            key.includes(scenarioId.replace('SC', ''))
          );
          console.log(`ğŸ” ${scenarioId}ì™€ ìœ ì‚¬í•œ í‚¤ë“¤:`, similarKeys);
        }
      });
      
      // ì „ì²´ ë°ì´í„° êµ¬ì¡° ìƒì„¸ ë¶„ì„
      console.log('ğŸ” ì „ì²´ keywordNewsByScenarioId êµ¬ì¡°:');
      Object.keys(keywordNewsByScenarioId).forEach(key => {
        console.log(`  ${key}: ${keywordNewsByScenarioId[key].length}ê°œ ë‰´ìŠ¤`);
        if (key.includes('4') || key.includes('004')) {
          console.log(`    ğŸ“‹ ${key} ìƒì„¸ ë‚´ìš©:`, keywordNewsByScenarioId[key]);
        }
      });
      
      return keywordNewsByScenarioId;
    } catch(e) {
      console.error('Error loading keyword_news.xlsx:', e);
      keywordNewsByScenarioId = {};
      return {};
    }
  }

  // ê¸°ë³¸ GPT3 ê°€ì´ë“œë¼ì¸ íŒŒì¼ë“¤ ë¡œë”© í•¨ìˆ˜
  async function loadDefaultGpt3Guidelines() {
    try {
      // ê¸°ë³¸ ê°€ì´ë“œë¼ì¸ íŒŒì¼ ê²½ë¡œ ë§µí•‘
      const guidelineFiles = {
        'market': 'go_scen/data/bank/ì‹œì¥ë¦¬ìŠ¤í¬.txt',
        'credit': 'go_scen/data/bank/ì‹ ìš©ë¦¬ìŠ¤í¬.txt', 
        'alm': 'go_scen/data/bank/ALM.txt',
        'global': 'go_scen/data/bank/ê¸€ë¡œë²Œë¦¬ìŠ¤í¬.txt',
        'creditpf': 'go_scen/data/bank/ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤.txt'
      };

      // window.gpt3Guidelines ê°ì²´ ì´ˆê¸°í™”
      if (!window.gpt3Guidelines) {
        window.gpt3Guidelines = {};
      }

      let loadedCount = 0;
      
      // ê° ê°€ì´ë“œë¼ì¸ íŒŒì¼ ë¡œë”©
      for (const [key, filePath] of Object.entries(guidelineFiles)) {
        try {
          const resp = await fetch(filePath);
          if (resp.ok) {
            const text = await resp.text();
            window.gpt3Guidelines[key] = text.slice(0, 200000); // ìµœëŒ€ 200KB ì œí•œ
            loadedCount++;
            
            // UIì— íŒŒì¼ëª… í‘œì‹œ ì—…ë°ì´íŠ¸
            const nameElementId = `gpt3-${key}-guideline-name`;
            const nameElement = document.getElementById(nameElementId);
            if (nameElement) {
              const fileName = filePath.split('/').pop();
              nameElement.textContent = fileName;
            }
          } else {
            console.warn(`ê¸°ë³¸ ê°€ì´ë“œë¼ì¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${filePath}`);
          }
        } catch (e) {
          console.warn(`ê¸°ë³¸ ê°€ì´ë“œë¼ì¸ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜ (${key}):`, e);
        }
      }

      console.log(`âœ… ê¸°ë³¸ GPT3 ê°€ì´ë“œë¼ì¸ ë¡œë“œ ì™„ë£Œ: ${loadedCount}/${Object.keys(guidelineFiles).length}ê°œ íŒŒì¼`);
      
      return window.gpt3Guidelines;
    } catch(e) {
      console.error('Error loading default GPT3 guidelines:', e);
      return {};
    }
  }

    async function loadScenarioExcel(n) {
      try {
        // 01~09ê¹Œì§€ëŠ” ë‘ ìë¦¬ íŒ¨ë”©, 10 ì´ìƒì€ ê·¸ëŒ€ë¡œ
        const folderName = String(n).padStart(2, '0');
        const fileName = `scenario_report_${folderName}.xlsx`;
        
        const url = `go_scen/scen/${folderName}/${fileName}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Failed to load file for scenario ${n}`);
        const arrayBuffer = await resp.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type:'array'});

        // [0] ì‹œíŠ¸: ì‹œë‚˜ë¦¬ì˜¤ ê°œìš”
        const overviewSheet = workbook.Sheets[workbook.SheetNames[0]];
        const overview = XLSX.utils.sheet_to_json(overviewSheet)[0] || {};
        // [1] ì‹œíŠ¸: ì‹œì¥ì§€í‘œ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ë©”ì¸ íŒŒì¼ ì‚¬ìš©)
        const indicatorSheet = workbook.Sheets[workbook.SheetNames[1]];
        const indicators = indicatorSheet ? XLSX.utils.sheet_to_json(indicatorSheet) : [];
        // [2] ì‹œíŠ¸: ë‰´ìŠ¤ í‚¤ì›Œë“œ
        const keywordSheet = workbook.Sheets[workbook.SheetNames[2]];
        const keywords = keywordSheet ? XLSX.utils.sheet_to_json(keywordSheet) : [];
        // [3] ì‹œíŠ¸: ì‹œë‚˜ë¦¬ì˜¤-ì§€í‘œ ì—°ê³„
        const linkSheet = workbook.Sheets[workbook.SheetNames[3]];
        const links = linkSheet ? XLSX.utils.sheet_to_json(linkSheet) : [];
        // [4] ì‹œíŠ¸: ì˜í–¥ ë¶„ì„
        const impactSheet = workbook.Sheets[workbook.SheetNames[4]];
        const impacts = impactSheet ? XLSX.utils.sheet_to_json(impactSheet) : [];

        scenarioData[n] = { overview, indicators, keywords, links, impacts };
        if (overview && overview.Scenario_ID) scenarioIdToNum[overview.Scenario_ID] = n;
      } catch(e) {
        console.error(`Error loading scenario ${n}:`, e);
        scenarioData[n] = { overview: {}, indicators: [], keywords: [], links: [], impacts: [] };
      }
    }

    function findIndicatorMetaFromScenario(indicatorId, scenarioNumber) {
      if (!indicatorId || scenarioNumber == null) return null;
      const normalizeId = (value) => String(value || '').trim().toUpperCase();
      const scenarioEntry = scenarioData[scenarioNumber];
      if (!scenarioEntry) return null;
      const targetId = normalizeId(indicatorId);
      const candidates = [];
      if (Array.isArray(scenarioEntry.indicators)) candidates.push(...scenarioEntry.indicators);
      if (Array.isArray(scenarioEntry.links)) candidates.push(...scenarioEntry.links);
      for (const item of candidates) {
        const candidateId = normalizeId(
          item.Indicator_ID || item.indicator_id || item.IndicatorID || item.indicatorId || item.id || item.ID
        );
        if (!candidateId || candidateId !== targetId) continue;
        const name =
          item.Indicator_Name || item.indicator_name || item.IndicatorName ||
          item.indicatorName || item.name || item.Name || item.NAME || '';
        const ticker =
          item.Bloomberg_Ticker || item.bloomberg_ticker || item.BloombergTicker ||
          item.bloombergTicker || item.ticker || item.Ticker || item.TICKER || '';
        return { name, ticker };
      }
      return null;
    }

    // ====== GPT1 ì „ì†¡ ìƒíƒœ ======
    let selectedScenarioForGPT = null;
    
    // ====== ë§ˆì¼“ë°ì´í„° ì €ì¥ì†Œ ======
    // let marketDataByScenario = {}; // ì „ì—­ ë³€ìˆ˜ì™€ ì¤‘ë³µ ì„ ì–¸ ì œê±°
    
    // ====== ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ì €ì¥ì†Œ ======
    // let scenarioSummaryByScenarioId = {}; // ì „ì—­ ë³€ìˆ˜ì™€ ì¤‘ë³µ ì„ ì–¸ ì œê±°
    
    // ====== í‚¤ì›Œë“œ ë‰´ìŠ¤ ì €ì¥ì†Œ ======
    // let keywordNewsByScenarioId = {}; // ì „ì—­ ë³€ìˆ˜ì™€ ì¤‘ë³µ ì„ ì–¸ ì œê±°

    // ====== ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì €ì¥ì†Œ ======
    let indicatorToScenarioMap = new Map(); // Indicator_ID -> ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸
    let scenarioToIndicatorsMap = new Map(); // ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ -> Indicator_ID ë°°ì—´

    // ====== ì´ˆê¸°í™” ë° ì „ì²´ ë Œë”ë§ ê´€ë¦¬ ======
    async function initializeApp() {
      const graphEl = document.getElementById('network-graph');
      if (graphEl) graphEl.textContent = '';
      
      // 1ë‹¨ê³„: ë©”ì¸ ì§€í‘œ íŒŒì¼ ë¡œë“œ
      const mainIndicators = await loadMainIndicatorFile();
      
      // 2ë‹¨ê³„: ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ Excel íŒŒì¼ ë¡œë“œ
      await Promise.all(scenarioList.map(n => loadScenarioExcel(n)));
      
      // 2.1ë‹¨ê³„: ë§ˆì¼“ë°ì´í„° íŒŒì¼ ë¡œë“œ
      await loadMarketDataFile();
      
      // 2.2ë‹¨ê³„: ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ íŒŒì¼ ë¡œë“œ
      await loadScenarioSummaryFile();
      
      // 2.3ë‹¨ê³„: í‚¤ì›Œë“œ ë‰´ìŠ¤ íŒŒì¼ ë¡œë“œ
      await loadKeywordNewsFile();
      
      // 2.4ë‹¨ê³„: ê¸°ë³¸ GPT3 ê°€ì´ë“œë¼ì¸ íŒŒì¼ë“¤ ë¡œë“œ
      await loadDefaultGpt3Guidelines();

      // 2.5ë‹¨ê³„: ì§€í‘œ-ì‹œë‚˜ë¦¬ì˜¤ ë§¤í•‘ íŒŒì¼ ë¡œë“œ (indicator.xlsx)
      await loadIndicatorMappingFile();

      // 2.5ë‹¨ê³„: í‚¤ì›Œë“œ ê¸°ë³¸ í’€ ë¡œë“œ (keyword.xlsx)
      try {
        const kwBaseUrl = 'go_scen/data/news/keyword.xlsx';
        const resp = await fetch(kwBaseUrl);
        if (!resp.ok) throw new Error('keyword.xlsx ë¡œë“œ ì‹¤íŒ¨');
        const arrayBuffer = await resp.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        keywordBaseData = XLSX.utils.sheet_to_json(sheet) || [];
        keywordByScenarioId.clear();
        keywordByScenarioNum.clear();
        keywordBaseData.forEach(row => {
          const scenId = row.Scenario_ID || row.scenario_id || row.SCENARIO_ID;
          const newsKorRaw = row.News_kor || row.News_Kor || row.news_kor || row.keyword || row.Keyword;
          if (!scenId || !newsKorRaw) return;
          const key = normalizeScenarioId(scenId);
          if (!keywordByScenarioId.has(key)) keywordByScenarioId.set(key, []);
          const newsKor = normalizeKeywordText(newsKorRaw);
          keywordByScenarioId.get(key).push({ text: newsKor });
          const n = scenarioIdToNumber(key);
          if (n != null) {
            if (!keywordByScenarioNum.has(n)) keywordByScenarioNum.set(n, []);
            keywordByScenarioNum.get(n).push({ text: newsKor });
          }
        });
        try { console.log('[KW-BASE] byId keys=', Array.from(keywordByScenarioId.keys())); console.log('[KW-BASE] byNum keys=', Array.from(keywordByScenarioNum.keys())); } catch(_) {}
      } catch (e) {
        console.error('í‚¤ì›Œë“œ ê¸°ë³¸ í’€ ë¡œë“œ ì˜¤ë¥˜:', e);
      }

      // 2.6ë‹¨ê³„: ë‰´ìŠ¤ ë©”íƒ€(phase/title/press/url) ë³‘í•© (keyword_news.xlsx)
      try {
        const kwNewsUrl = 'go_scen/data/news/bigkinds/daily_news/keyword_news.xlsx';
        const resp2 = await fetch(kwNewsUrl);
        if (!resp2.ok) throw new Error('keyword_news.xlsx ë¡œë“œ ì‹¤íŒ¨');
        const ab2 = await resp2.arrayBuffer();
        const wb2 = XLSX.read(ab2, { type: 'array' });
        const sheet2 = wb2.Sheets[wb2.SheetNames[0]];
        keywordNewsData = XLSX.utils.sheet_to_json(sheet2) || [];
        newsMetaByScenarioId.clear();
        newsMetaByScenarioNum.clear();
        keywordNewsData.forEach(row => {
          const scenId = row.Scenario_ID || row.scenario_id || row.SCENARIO_ID;
          const textRaw = row.News_kor || row.News_Kor || row.news_kor;
          if (!scenId || !textRaw) return;
          const phase = row.Phase || row.phase || row.PHASE;
          const url = row.URL || row.Url || row.url;
          const title = row['ì œëª©'] || row.Title || row.title;
          const press = row['ì–¸ë¡ ì‚¬'] || row['ë§¤ì²´'] || row.Press || row.press;
          const key = normalizeScenarioId(scenId);
          const ktext = normalizeKeywordText(textRaw);
          if (!newsMetaByScenarioId.has(key)) newsMetaByScenarioId.set(key, new Map());
          newsMetaByScenarioId.get(key).set(ktext, { phase: String(phase || '').trim(), url: url ? String(url) : '', title: title ? String(title) : '', press: press ? String(press) : '' });
          const n = scenarioIdToNumber(key);
          if (n != null) {
            if (!newsMetaByScenarioNum.has(n)) newsMetaByScenarioNum.set(n, new Map());
            newsMetaByScenarioNum.get(n).set(ktext, { phase: String(phase || '').trim(), url: url ? String(url) : '', title: title ? String(title) : '', press: press ? String(press) : '' });
          }
        });
      } catch (e) {
        console.error('í‚¤ì›Œë“œ ë‰´ìŠ¤ ë©”íƒ€ ë¡œë“œ ì˜¤ë¥˜:', e);
      }
      
      // 3ë‹¨ê³„: ë©”ì¸ ì§€í‘œ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì „ì—­ ì§€í‘œ ID-Name ë§µ ìƒì„±
      const tempIndicatorMap = new Map();
      const tempDisplayNameMap = new Map();
      
      // ë©”ì¸ ì§€í‘œ íŒŒì¼ì—ì„œ ì§€í‘œ ì •ë³´ ìˆ˜ì§‘
      console.log('ğŸ” ë©”ì¸ ì§€í‘œ íŒŒì¼ ì»¬ëŸ¼ êµ¬ì¡° ë¶„ì„:');
      if (mainIndicators.length > 0) {
        console.log('ì²« ë²ˆì§¸ ì§€í‘œ ë°ì´í„°ì˜ í‚¤ë“¤:', Object.keys(mainIndicators[0]));
        console.log('ì²« ë²ˆì§¸ ì§€í‘œ ë°ì´í„° ì „ì²´:', mainIndicators[0]);
      }
      
      let foundInMainFile = 0;
      let missingNameCount = 0;
      
      mainIndicators.forEach((indicator, index) => {
        // ê°€ëŠ¥í•œ ì»¬ëŸ¼ëª…ë“¤ì„ ì‹œë„ (íŒŒì¼ êµ¬ì¡°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        const indicatorId = indicator.Indicator_ID || indicator.ID || indicator.ì§€í‘œID || indicator.id;
        const bloombergTicker = indicator.Bloomberg_Ticker || indicator.Ticker || indicator.ticker || indicator.Bloomberg_Code;
        const indicatorName = indicator.Indicator_Name || indicator.Name || indicator.ì§€í‘œëª… || indicator.name;
        
        if (indicatorId && bloombergTicker) {
          tempIndicatorMap.set(indicatorId, bloombergTicker);
          // Indicator_Nameì´ ìˆìœ¼ë©´ ì €ì¥, ì—†ìœ¼ë©´ Bloomberg_Ticker ì‚¬ìš©
          tempDisplayNameMap.set(indicatorId, indicatorName || bloombergTicker);
          foundInMainFile++;
        } else {
          missingNameCount++;
          if (index < 5) { // ì²˜ìŒ 5ê°œë§Œ ë¡œê·¸
            console.log(`âŒ ì§€í‘œ ì •ë³´ ë¶€ì¡± [${index}]:`, indicator);
            console.log(`  - ID: ${indicatorId}, Bloomberg_Ticker: ${bloombergTicker}, Indicator_Name: ${indicatorName}`);
          }
        }
        
        // IND004 íŠ¹ë³„ í™•ì¸
        if (indicatorId === 'IND004') {
          console.log('ğŸ” IND004 ìƒì„¸ ì •ë³´:', indicator);
          console.log(`ID: ${indicatorId}, Bloomberg_Ticker: ${bloombergTicker}, Indicator_Name: ${indicatorName}`);
        }
      });
      
      console.log(`âœ… ë©”ì¸ íŒŒì¼ì—ì„œ ë§¤í•‘ ì„±ê³µ: ${foundInMainFile}ê°œ`);
      console.log(`âŒ ì´ë¦„ ì •ë³´ ë¶€ì¡±: ${missingNameCount}ê°œ`);
      
      // 4ë‹¨ê³„: ì‹œë‚˜ë¦¬ì˜¤ linksì—ì„œ ëˆ„ë½ëœ ì§€í‘œë“¤ í™•ì¸ (ìƒì„±í•˜ì§€ ì•Šê³  ë¡œê·¸ë§Œ)
      const missingIndicators = new Set(); // ëˆ„ë½ëœ ì§€í‘œë“¤ ì¶”ì 
      
      Object.values(scenarioData).forEach(scenario => {
        if (scenario.links) {
          scenario.links.forEach(link => {
            if (link.Indicator_ID && !tempIndicatorMap.has(link.Indicator_ID)) {
              missingIndicators.add(link.Indicator_ID);
            }
          });
        }
      });
      
      if (missingIndicators.size > 0) {
        console.log(`âš ï¸ indicator íŒŒì¼ì— ì—†ëŠ” ì§€í‘œ IDë“¤ (${missingIndicators.size}ê°œ):`);
        Array.from(missingIndicators).slice(0, 20).forEach(id => {
          console.log(`  - ${id} (ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì°¸ì¡°ë˜ì§€ë§Œ indicator íŒŒì¼ì— ì—†ìŒ)`);
        });
      }
      
      // ë©”ì¸ íŒŒì¼ì—ì„œ ì°¾ì€ ì§€í‘œ IDë“¤ í™•ì¸
      console.log('ğŸ“Š indicator íŒŒì¼ì—ì„œ ë¡œë“œëœ ì§€í‘œë“¤ (ì²˜ìŒ 20ê°œ):');
      let mainFileCount = 0;
      for (const [id, ticker] of tempIndicatorMap.entries()) {
        if (mainFileCount < 20) {
          console.log(`  - ${id} -> "${ticker}"`);
          mainFileCount++;
        }
      }

      
      // ìµœì¢… ë§µì— ë³µì‚¬ (ID -> Bloomberg Ticker, ID -> Indicator_Name)
      indicatorIdToNameMap = tempIndicatorMap;
      indicatorIdToDisplayNameMap = tempDisplayNameMap;
      
      // ì§€í‘œ ë§µì´ ë¹„ì–´ìˆëŠ” ê²½ìš° ê²½ê³ 
      if (indicatorIdToNameMap.size === 0) {
        console.error('ğŸš¨ ì‹¬ê°í•œ ë¬¸ì œ: ì§€í‘œ ë§µì´ ì™„ì „íˆ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
        console.error('ğŸ“‹ ê°€ëŠ¥í•œ ì›ì¸:');
        console.error('  1. indicator.xlsx íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
        console.error('  2. íŒŒì¼ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦„ (Indicator_ID, Bloomberg_Ticker ì»¬ëŸ¼ ë¶€ì¬)');
        console.error('  3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œë¡œ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨');
        console.error('ğŸ”§ í•´ê²° ë°©ë²•: go_scen/data/indicator.xlsx íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.');
      }
      
      console.log(`âœ… í‘œì‹œëª… ë§µ ìƒì„± ì™„ë£Œ: ${indicatorIdToDisplayNameMap.size}ê°œ ì§€í‘œ (ID -> Indicator_Name)`);
      if (indicatorIdToDisplayNameMap.size > 0) {
        console.log('ğŸ“‹ í‘œì‹œëª… ìƒ˜í”Œ (ì²˜ìŒ 5ê°œ):');
        let count = 0;
        for (const [id, name] of indicatorIdToDisplayNameMap.entries()) {
          if (count < 5) {
            console.log(`  - ${id} -> "${name}"`);
            count++;
          }
        }
      }
      
      // ì¤‘ë³µ Bloomberg Ticker í™•ì¸
      const tickerCount = new Map();
      const duplicateTickers = [];
      
      for (const [id, ticker] of indicatorIdToNameMap.entries()) {
        if (tickerCount.has(ticker)) {
          tickerCount.set(ticker, tickerCount.get(ticker) + 1);
          if (!duplicateTickers.includes(ticker)) {
            duplicateTickers.push(ticker);
          }
        } else {
          tickerCount.set(ticker, 1);
        }
      }
      
      console.log(`âœ… ì§€í‘œ ë§µ ìƒì„± ì™„ë£Œ: ${indicatorIdToNameMap.size}ê°œ ì§€í‘œ (ID -> Bloomberg Ticker)`);
      console.log(`ğŸ“Š indicator íŒŒì¼: ${mainIndicators.length}ê°œ ì§€í‘œ`);
      
      if (duplicateTickers.length > 0) {
        console.log(`âš ï¸ ì¤‘ë³µëœ Bloomberg Ticker ë°œê²¬: ${duplicateTickers.length}ê°œ`);
        duplicateTickers.forEach(ticker => {
          const duplicateIds = [];
          for (const [id, mapTicker] of indicatorIdToNameMap.entries()) {
            if (mapTicker === ticker) {
              duplicateIds.push(id);
            }
          }
          console.log(`"${ticker}": [${duplicateIds.join(', ')}] (${duplicateIds.length}ê°œ)`);
        });
      } else {
        console.log(`âœ… ì¤‘ë³µ Bloomberg Ticker ì—†ìŒ`);
      }
      
      // íŠ¹ì • ì§€í‘œ IND111 ë””ë²„ê¹…
      console.log(`ğŸ” IND111 ë””ë²„ê¹…:`);
      console.log(`IND111ì´ ì§€í‘œ ë§µì— ì¡´ì¬: ${indicatorIdToNameMap.has('IND111')}`);
      console.log(`IND111 ë§¤í•‘ ì´ë¦„: ${indicatorIdToNameMap.get('IND111') || 'undefined'}`);
      
      // IND111ì„ ì‚¬ìš©í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ í™•ì¸
      const scenariosUsingIND111 = [];
      Object.entries(scenarioData).forEach(([scenarioNum, scenario]) => {
        if (scenario.links) {
          const hasIND111 = scenario.links.some(link => link.Indicator_ID === 'IND111');
          if (hasIND111) {
            scenariosUsingIND111.push(scenarioNum);
          }
        }
      });
      console.log(`IND111ì„ ì‚¬ìš©í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë“¤: [${scenariosUsingIND111.join(', ')}]`);
      
      // ë©”ì¸ ì§€í‘œ íŒŒì¼ì—ì„œ IND111 í™•ì¸
      const ind111InMain = mainIndicators.find(ind => 
        (ind.Indicator_ID || ind.ID || ind.ì§€í‘œID || ind.id) === 'IND111'
      );
      console.log(`ë©”ì¸ ì§€í‘œ íŒŒì¼ì— IND111 ì¡´ì¬: ${!!ind111InMain}`);
      if (ind111InMain) {
        console.log(`ë©”ì¸ íŒŒì¼ì˜ IND111 ë°ì´í„°:`, ind111InMain);
      }
      
      // ë””ë²„ê¹…: ì²˜ìŒ 10ê°œ ì§€í‘œ í™•ì¸
      console.log('ì²˜ìŒ 10ê°œ ì§€í‘œ ë§¤í•‘ (ID -> Bloomberg Ticker):');
      let debugCount = 0;
      for (const [id, ticker] of indicatorIdToNameMap.entries()) {
        if (debugCount < 10) {
          console.log(`${id}: ${ticker}`);
          debugCount++;
        } else {
          break;
        }
      }
      
      await loadRiskEngContent();
      renderNetwork();
      
      // ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°ì¡°ì • ì´ˆê¸°í™”
      restoreRightPanelSize();
      
      // ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
      initializeDragResize();
      

    }

    // ====== ë„¤íŠ¸ì›Œí¬ ê·¸ë˜í”„ ë Œë”ë§ ======
    function renderNetwork() {
      const container = document.getElementById('network-graph');
      container.innerHTML = '';
      
      // í•„ìˆ˜ ë°ì´í„° ì¤€ë¹„ ìƒíƒœ í™•ì¸
      if (indicatorIdToNameMap.size === 0) {
        console.warn('âš ï¸ ë„¤íŠ¸ì›Œí¬ ë Œë”ë§ ì§€ì—°: ì§€í‘œ ë§µì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        container.innerHTML = `
          <div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:20px;">ğŸ“Š</div>
            <div style="font-size:16px; margin-bottom:10px; animation: loading-pulse 1.5s ease-in-out infinite;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            <div style="font-size:12px; animation: loading-fade 2s ease-in-out infinite;">ì§€í‘œ íŒŒì¼ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
          </div>
        `;
        return;
      }
      
      // ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ì•ˆì „í•œ í¬ê¸° ê³„ì‚°
      const containerRect = container.getBoundingClientRect();
      const width = Math.max(containerRect.width, 1200) * 1.2; // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°, ìµœì†Œ í¬ê¸° ë³´ì¥
      const height = Math.max(containerRect.height, 800) * 1.2; // ì»¨í…Œì´ë„ˆ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°, ìµœì†Œ í¬ê¸° ë³´ì¥
      
      const svg = d3.select('#network-graph')
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${width} ${height}`)
        .style('position', 'absolute')
        .style('top', '0')
        .style('left', '0');
      
      const g = svg.append('g');
      
      // ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±: ë§í¬(ì„ )ê°€ ë¨¼ì €, ë…¸ë“œ(ì›)ê°€ ë‚˜ì¤‘ â†’ ë…¸ë“œê°€ í•­ìƒ ì„  ìœ„ì— í‘œì‹œë¨
      const linkLayer = g.append('g').attr('class', 'link-layer');
      const nodeLayer = g.append('g').attr('class', 'node-layer');

      // ì¤Œ ë° íŒ¬ ê¸°ëŠ¥ ì¶”ê°€ (í„°ì¹˜ ìµœì í™”)
      const zoom = d3.zoom()
        .scaleExtent([0.1, 3]) // ì¤Œ ë²”ìœ„ ì„¤ì •
        .filter((event) => {
          // í„°ì¹˜ì™€ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ëª¨ë‘ í—ˆìš©, ë”ë¸”í´ë¦­ì€ ì œì™¸
          return !event.ctrlKey && event.type !== 'dblclick';
        })
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom)
        .on('dblclick.zoom', null); // ë”ë¸”í´ë¦­ ì¤Œ ë¹„í™œì„±í™” (í„°ì¹˜ ì¥ì¹˜ì—ì„œ ì˜ë„ì¹˜ ì•Šì€ ì¤Œ ë°©ì§€)

      // ê·¸ë˜í”„ ìƒíƒœ ë³´ê´€
      graphState.svg = svg;
      graphState.g = g;
      graphState.containerRect = containerRect;
      graphState.width = width;
      graphState.height = height;
      graphState.posByScenarioNum = new Map();
      graphState.midPointByScenarioNum = new Map(); // ì‹œë‚˜ë¦¬ì˜¤-ë§ˆì¼“ë°ì´í„° ì‹¤ì„ ì˜ ì¤‘ê°„ì  ì €ì¥

      // ì „ì²´ ë ˆì´ì•„ì›ƒì˜ ì¤‘ê°„ ìœ„ì¹˜ ê³„ì‚°
      const layoutCenterY = height / 2;
      
      // ì§€í‘œ ë§µì„ ë°°ì—´ë¡œ ë³€í™˜ (indicator.xlsxì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì§€í‘œë§Œ í‘œì‹œ)
      const referencedIndicatorIds = new Set();
      Object.values(scenarioData).forEach(scen => {
        if (Array.isArray(scen.indicators)) scen.indicators.forEach(ind => ind?.Indicator_ID && referencedIndicatorIds.add(ind.Indicator_ID));
        if (Array.isArray(scen.links)) scen.links.forEach(l => l?.Indicator_ID && referencedIndicatorIds.add(l.Indicator_ID));
      });
      
      // indicator.xlsxì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì§€í‘œë§Œ ìˆ˜ì§‘ (ì‚­ì œëœ ì§€í‘œëŠ” ì œì™¸)
      const allIndicatorEntries = Array.from(
        Array.from(indicatorIdToNameMap.entries()).filter(([id]) => isAllowedIndicatorId(id))
      );
      
      // âŒ ì œê±°ë¨: indicator íŒŒì¼ì— ì—†ëŠ” IDë¥¼ ê°•ì œë¡œ ì¶”ê°€í•˜ë˜ ë¡œì§
      // ì´ì œ indicator.xlsxì—ì„œ ì‚­ì œëœ ì§€í‘œ(ì˜ˆ: IND033)ëŠ” UIì— í‘œì‹œë˜ì§€ ì•ŠìŒ
      // referencedIndicatorIds.forEach(id => {
      //   if (!isAllowedIndicatorId(id)) return;
      //   if (!indicatorIdToNameMap.has(id)) {
      //     allIndicatorEntries.push([id, id]);
      //   }
      // });
      
      // ID ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedIndicators = allIndicatorEntries.sort(([idA], [idB]) => idA.localeCompare(idB));
      
      // ì‹œì¥ì§€í‘œë¥¼ SVGì— ì§ì ‘ ë Œë”ë§ (ì™¼ìª½) - ì‹œë‚˜ë¦¬ì˜¤ì™€ ê±°ë¦¬ ì¡°ì •
      const indicatorStartX = width / 2 - 1300; // ì‹œë‚˜ë¦¬ì˜¤ì™€ ì ì ˆí•œ ê±°ë¦¬ (ì¤‘ì•™ì—ì„œ ì™¼ìª½ìœ¼ë¡œ 1300px)
      // ì‹œì¥ì§€í‘œ ì „ì²´ ë†’ì´ ê³„ì‚° (5ì—´ ê¸°ì¤€)
      const indicatorRows = Math.ceil(sortedIndicators.length / 5);
      const indicatorTotalHeight = (indicatorRows - 1) * 80; // í–‰ ê°„ê²© í™•ëŒ€ (50 â†’ 80)
      const indicatorStartY = layoutCenterY - indicatorTotalHeight / 2; // ì¤‘ê°„ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
      const indicatorSpacing = 80; // ì§€í‘œ ê°„ê²© í™•ëŒ€ (50 â†’ 80)
      const indicatorCols = 5;
      
      // ì‹œë‚˜ë¦¬ì˜¤ 30 ë””ë²„ê¹…ì„ ìœ„í•œ ë ˆì´ì•„ì›ƒ ì •ë³´ ì¶œë ¥
      console.log(`ğŸ“ === ì§€í‘œ ë ˆì´ì•„ì›ƒ ê³„ì‚° ì •ë³´ ===`);
      console.log(`- width: ${width}, height: ${height}`);
      console.log(`- layoutCenterY: ${layoutCenterY}`);
      console.log(`- indicatorStartX: ${indicatorStartX}, indicatorStartY: ${indicatorStartY}`);
      console.log(`- indicatorRows: ${indicatorRows}, indicatorCols: ${indicatorCols}`);
      console.log(`- indicatorSpacing: ${indicatorSpacing}`);
      console.log(`- ì „ì²´ ì§€í‘œ ìˆ˜: ${sortedIndicators.length}`);
      console.log(`- indicatorTotalHeight: ${indicatorTotalHeight}`);
      
      const indicatorNodes = sortedIndicators.map(([indicatorId, indicatorName], index) => {
        const col = index % indicatorCols;
        const row = Math.floor(index / indicatorCols);
        const x = indicatorStartX + col * indicatorSpacing;
        const y = indicatorStartY + row * indicatorSpacing;
        
        // Indicator_Name (í‘œì‹œëª…) ê°€ì ¸ì˜¤ê¸°
        const displayName = indicatorIdToDisplayNameMap.get(indicatorId) || indicatorName;
        
        // IND140~IND145 ì§€í‘œë“¤ì˜ ìœ„ì¹˜ ë””ë²„ê¹…
        if (indicatorId && indicatorId.match(/IND14[0-5]/)) {
          console.log(`ğŸ¯ ${indicatorId} (${indicatorName}) ìœ„ì¹˜ ê³„ì‚°:`);
          console.log(`   - index: ${index}, col: ${col}, row: ${row}`);
          console.log(`   - indicatorStartX: ${indicatorStartX}, indicatorStartY: ${indicatorStartY}`);
          console.log(`   - indicatorSpacing: ${indicatorSpacing}`);
          console.log(`   - ìµœì¢… ìœ„ì¹˜: (${x}, ${y})`);
        }
        
        // ìƒ‰ìƒ ê²°ì • (ì‹œë‚˜ë¦¬ì˜¤ indicatorsì—ì„œ ì°¾ê¸°)
        let color = '#3498db';
        for (let scenario of Object.values(scenarioData)) {
          if (scenario.indicators) {
            const indicator = scenario.indicators.find(ind => 
              ind.Indicator_ID === indicatorId || ind.Indicator_Name === indicatorName
            );
            if (indicator) {
              color = getIndicatorColor(indicator);
              break;
            }
          }
        }
        
        return {
          id: indicatorName,
          name: indicatorName,
          displayName: displayName, // Indicator_Name ì¶”ê°€
          indicatorId: indicatorId,
          x: x,
          y: y,
          color: color,
          type: 'indicator'
        };
      });
      
      // ë Œë”ë§ë˜ëŠ” ì§€í‘œ ë…¸ë“œ ì¤‘ë³µ í™•ì¸
      const renderedNames = indicatorNodes.map(node => node.name);
      const renderedNameSet = new Set(renderedNames);
      
      console.log(`ğŸ¨ ë Œë”ë§í•  ì§€í‘œ ë…¸ë“œ: ${indicatorNodes.length}ê°œ`);
      console.log(`ğŸ¨ ê³ ìœ  ì§€í‘œ ì´ë¦„: ${renderedNameSet.size}ê°œ`);
      
      // IND140~IND145 ë²”ìœ„ì˜ ë…¸ë“œë“¤ í™•ì¸
      console.log(`ğŸ” === ìƒì„±ëœ IND140~IND145 ë…¸ë“œë“¤ í™•ì¸ ===`);
      const ind140Plus = indicatorNodes.filter(node => {
        if (node.indicatorId && node.indicatorId.startsWith('IND')) {
          const num = parseInt(node.indicatorId.substring(3));
          return num >= 140 && num <= 145;
        }
        return false;
      });
      
      if (ind140Plus.length > 0) {
        console.log(`IND140~IND145 ë…¸ë“œë“¤ (${ind140Plus.length}ê°œ):`);
        ind140Plus.forEach(node => {
          console.log(`  - ${node.indicatorId}: "${node.name}" ìœ„ì¹˜(${node.x}, ${node.y})`);
        });
      } else {
        console.log(`âŒ IND140~IND145 ë²”ìœ„ì˜ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤`);
      }
      
      // ë§ˆì§€ë§‰ ëª‡ ê°œ ì§€í‘œ ë…¸ë“œ í™•ì¸ (ëìª½ì— ìˆì–´ì•¼ í•  ì§€í‘œë“¤)
      console.log(`ğŸ“ === ë§ˆì§€ë§‰ 10ê°œ ì§€í‘œ ë…¸ë“œë“¤ ===`);
      indicatorNodes.slice(-10).forEach((node, index) => {
        const globalIndex = indicatorNodes.length - 10 + index;
        console.log(`  ${globalIndex + 1}. ${node.indicatorId}: "${node.name}" ìœ„ì¹˜(${node.x}, ${node.y})`);
      });
      
      if (renderedNames.length !== renderedNameSet.size) {
        console.log(`âš ï¸ ë Œë”ë§ ì‹œ ì¤‘ë³µëœ ì§€í‘œê°€ ìˆìŠµë‹ˆë‹¤!`);
        const duplicatesInRendering = [];
        renderedNames.forEach((name, index) => {
          const firstIndex = renderedNames.indexOf(name);
          if (firstIndex !== index && !duplicatesInRendering.includes(name)) {
            duplicatesInRendering.push(name);
          }
        });
        console.log(`ì¤‘ë³µ ë Œë”ë§ë˜ëŠ” ì§€í‘œë“¤:`, duplicatesInRendering);
      }
      
      // ê°„ê²© ìƒìˆ˜
      const GAP_X = 500;           // ë‹¨ê³„ ê°„ ê¸°ë³¸ ê°„ê²© (ì¡°ì •ë¨)
      const GAP_GPT1_TO_GPT3 = GAP_X * 2; // gpt1â†”gpt3 ê°„ê²©
      const GAP_GPT0_FROM_GPT1 = GAP_X;   // gpt1ë¡œë¶€í„° gpt0ê¹Œì§€ ì¢Œì¸¡ ì˜¤í”„ì…‹(ì‹œë‚˜ë¦¬ì˜¤ ìª½ìœ¼ë¡œ ë‹¹ê¹€)
      const GAP_GPT1_TO_GPT2 = 300;       // gpt1â†”gpt2 ê°„ê²©(íŠ¹ìˆ˜ ì¡°ì •)
      const SCEN_GPT_PATH_RATIO = 0.15; // ì‹œë‚˜ë¦¬ì˜¤â†’í—ˆë¸Œ ì¤‘ê°„ì  ë³´ê°„(ë” ì§§ê²Œ)
      // ì „ì²´ ê¸¸ì´ë¥¼ í—ˆë¸Œê¹Œì§€ 100% ë„ë‹¬ì‹œí‚¤ë˜, ë‚´ë¶€ì—ì„œ ì‹¤ì„ /ì ì„  ë¶„í• ë§Œ ì ìš©
      const SCEN_GPT_TOTAL_FRAC = 1; // í—ˆë¸Œê¹Œì§€ ë„ë‹¬ (ê¸¸ì´ í”½ìŠ¤í•˜ì§€ ì•ŠìŒ)
      const SCEN_GPT_SOLID_FRAC_IN_TOTAL = 0.6; // ì¶•ì†Œëœ ê¸¸ì´ ì¤‘ ì‹¤ì„  ë¹„ìœ¨(60%)

      // gpt0(ì‚¬ì „ìˆ˜ì§‘ í•˜ìœ„ ì—ì´ì „íŠ¸ ë¬¶ìŒ) ê¸°ì¤€ìœ¼ë¡œ ë°°ì¹˜í•œ ë’¤, gpt1ì„ ë™ì¼ ê°„ê²©ë§Œí¼ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜
      // gpt0ë¥¼ ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ë” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ì‹œí‚¨ ì ˆëŒ€ ìœ„ì¹˜
      const gpt0X = width / 2 + 1000 + 1000;
      // gpt1 ì•µì»¤ëŠ” gpt0 ê¸°ì¤€ gpt3ì™€ì˜ ê±°ë¦¬ë§Œí¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ
      const gptAnchorX = gpt0X + GAP_GPT1_TO_GPT3;
      const gptAnchorY = layoutCenterY;    // ì¤‘ì•™ ì •ë ¬

      // ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œë“¤ ìƒì„±
      const scenarioNodes = Object.entries(scenarioData).map(([n, data]) => ({
        id: data.overview.Scenario_ID || `ì‹œë‚˜ë¦¬ì˜¤${n}`,
        name: data.overview.Scenario_Name || `ì‹œë‚˜ë¦¬ì˜¤ ${n}`,
        n: parseInt(n),
        type: 'scenario'
      }));

      // í‚¤ì›Œë“œ ë…¸ë“œ ì¤€ë¹„ (ì¢Œí‘œëŠ” ì‹œë‚˜ë¦¬ì˜¤ ê³ ì • í›„ ê³„ì‚°)
      const keywordNodes = [];
      const keywordMaxPerRow = 4;
      Object.entries(scenarioData).forEach(([n, data]) => {
        const scenId = data.overview.Scenario_ID || `ì‹œë‚˜ë¦¬ì˜¤${n}`;
        const normId = normalizeScenarioId(scenId);
        const scenNum = Number(n);

        // 1) ê¸°ë³¸ í‚¤ì›Œë“œ í’€: keyword.xlsx ê¸°ì¤€
        const baseByNum = keywordByScenarioNum.get(scenNum) || [];
        const baseById = keywordByScenarioId.get(normId) || [];
        const merged = [];
        const seen = new Set();
        [...baseByNum, ...baseById].forEach(it => {
          const key = normalizeKeywordText(it.text);
          if (!seen.has(key)) {
            seen.add(key);
            // ë‰´ìŠ¤ ë©”íƒ€ ë³‘í•©(ìˆìœ¼ë©´ ì¶”ê°€)
            const meta = (newsMetaByScenarioNum.get(scenNum)?.get(key)) || (newsMetaByScenarioId.get(normId)?.get(key)) || null;
            merged.push({ text: key, phase: meta?.phase || '', url: meta?.url || '', title: meta?.title || '', press: meta?.press || '' });
          }
        });

        if (!merged.length) { try { if (['SC004','SC009','SC022'].includes(normId)) console.log('[KW] ì—†ìŒ:', scenId); } catch(_) {} return; }
        try { if (['SC004','SC009','SC022'].includes(normId)) console.log('[KW] ë¡œë”©:', scenId, merged.map(it=>it.text)); } catch(_) {}
        merged.forEach((k, idx) => {
          keywordNodes.push({
            id: `kw_${scenId}_${idx}`,
            label: k.text,
            phase: k.phase || '',
            url: (k.url || '').trim(),
            title: (k.title || '').trim(),
            press: (k.press || '').trim(),
            scenarioId: scenId,
            scenarioNum: scenNum,
            type: 'keyword',
            rowIndex: Math.floor(idx / keywordMaxPerRow),
            colIndex: idx % keywordMaxPerRow
          });
        });
      });

      const nodes = [...scenarioNodes, ...keywordNodes];
      // ì „ì—­ í‚¤ì›Œë“œ ìˆœë²ˆ(ë†’ì´ ë°°ì¹˜ìš©) ê³„ì‚°: ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸, ë¼ë²¨ ê¸°ì¤€ ì •ë ¬
      const allKeywordNodes = nodes.filter(n => n.type === 'keyword');
      const globalKwRowById = new Map();
      allKeywordNodes
        .slice()
        .sort((a, b) => {
          const sn = (a.scenarioNum ?? 0) - (b.scenarioNum ?? 0);
          if (sn !== 0) return sn;
          return String(a.label || '').localeCompare(String(b.label || ''));
        })
        .forEach((k, i) => globalKwRowById.set(k.id, i));
      try { console.log('[KW] ì´ í‚¤ì›Œë“œ ë…¸ë“œ ìˆ˜=', keywordNodes.length); } catch(_) {}

      // ë§í¬ ìƒì„±
      const rawLinks = [];
      
      // ì‹œë‚˜ë¦¬ì˜¤-ì§€í‘œ ë§í¬
      Object.entries(scenarioData).forEach(([n, data]) => {
        if (data.links) {
          data.links.forEach(link => {
            const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
            if (indicatorName) {
              rawLinks.push({
                source: indicatorName,
                target: data.overview.Scenario_ID || `ì‹œë‚˜ë¦¬ì˜¤${n}`,
                weight: link.Weight || link.Correlation_Coeff || 1,
                type: 'indicator-scenario'
              });
            }
          });
        }
      });

      // ë§í¬ í•„í„°ë§
      const allNodeIDs = new Set(nodes.map(n => n.id));
      
      const filteredLinks = rawLinks.filter(link => {
        // 1. source, targetì´ ë¬¸ìì—´ì¸ì§€ í™•ì¸
        if (typeof link.source !== 'string' || typeof link.target !== 'string') return false;
        
        // 2. source, targetì´ ë…¸ë“œì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if (!allNodeIDs.has(link.target)) return false; // ì‹œë‚˜ë¦¬ì˜¤ë§Œ í™•ì¸
        
        return true;
      });

      // D3 ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •
      // í‚¤ì›Œë“œ ë…¸ë“œëŠ” ì‹œë®¬ë ˆì´ì…˜ ëŒ€ìƒì—ì„œ ì œì™¸í•˜ì—¬ ì´ˆê¸° ë°°ì¹˜ê°€ ë³€í•˜ì§€ ì•Šë„ë¡ í•¨
      const simulation = d3.forceSimulation(scenarioNodes)
        .force("link", d3.forceLink([]).id(d => d.id).distance(200).strength(0.3))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      // ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œ ìœ„ì¹˜ ì„¤ì • (2ì—´ ë°°ì¹˜) - ì¤‘ê°„ ìœ„ì¹˜ ê¸°ì¤€
      const cols = 2;
      const colGap = 400; // ì¢Œìš° ê°„ê²© ì ë‹¹íˆ ì¡°ì • (350 â†’ 400)
      // ì‹œë‚˜ë¦¬ì˜¤ ì „ì²´ ë†’ì´ ê³„ì‚° (2ì—´ ê¸°ì¤€)
      const scenarioRows = Math.ceil(scenarioNodes.length / 2);
      const scenarioTotalHeight = (scenarioRows - 1) * SCENARIO_ROW_GAP;
      const startY = layoutCenterY - scenarioTotalHeight / 2; // ì¤‘ê°„ ìœ„ì¹˜ ê¸°ì¤€
      const colX = [width / 2 - colGap / 2, width / 2 + colGap / 2];

      scenarioNodes.forEach((node, i) => {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const baseY = startY + row * SCENARIO_ROW_GAP;
        const offset = (i % 2 === 0) ? -10 : 10;
        
        node.fx = colX[col];
        node.fy = baseY + offset;
        // ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì „ì— ê³ ì • ì¢Œí‘œë¡œ ì´ˆê¸°í™”í•˜ì—¬ ì„ ì´ ì •í™•íˆ í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ì— ì—°ê²°ë˜ë„ë¡ í•¨
        node.x = node.fx;
        node.y = node.fy;

        // ì™¸ë¶€ ì œì–´ìš© ìœ„ì¹˜ ì €ì¥
        graphState.posByScenarioNum.set(node.n, { x: node.fx, y: node.fy });
      });

      // í‚¤ì›Œë“œ íˆ´íŒ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±(ìµœìƒìœ„, ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ë³´ë‹¤ ìœ„)
      let kwTooltip = document.getElementById('kw-tooltip');
      if (!kwTooltip) {
        kwTooltip = document.createElement('div');
        kwTooltip.id = 'kw-tooltip';
        kwTooltip.className = 'kw-tooltip';
        document.body.appendChild(kwTooltip);
      }

      // (í‚¤ì›Œë“œ ë‚´ë¶€ ë°°ì¹˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ ê·¸ë£¹ ìƒì„± ì´í›„ì— ìˆ˜í–‰)

      // ì‹œì¥ì§€í‘œ ë Œë”ë§ (ë” í¬ê³  ì„¸ë ¨ëœ ë””ìì¸) - nodeLayerì— ì¶”ê°€
      const indicatorGroup = nodeLayer.selectAll(".indicator-group")
        .data(indicatorNodes)
        .enter().append("g")
        .attr("class", "indicator-group")
        .attr("transform", d => `translate(${d.x}, ${d.y})`)
        .style("cursor", "pointer")
        .on("click", function(event, d) {
          // ì•ˆì „ì¥ì¹˜: indicator.xlsxì— ì¡´ì¬í•˜ëŠ” ì§€í‘œë§Œ í´ë¦­ ì²˜ë¦¬
          if (d.indicatorId && indicatorIdToNameMap.has(d.indicatorId)) {
            // IND500~IND532 ë²”ìœ„ì˜ ì§€í‘œëŠ” RISK_MONITOR.htmlë¡œ ì´ë™
            const id = String(d.indicatorId);
            const num = parseInt(id.slice(3), 10);
            if (!Number.isNaN(num) && num >= 500 && num <= 532) {
              window.open('RISK_MONITOR.html', '_blank');
            } else {
              // ê¸°ì¡´ ì§€í‘œëŠ” ì‹œê³„ì—´ ì°¨íŠ¸ ì—´ê¸° - displayName(Indicator_Name) ì‚¬ìš©
              openTimeseriesChart(d.indicatorId, d.displayName || d.name);
            }
          } else if (d.indicatorId && !indicatorIdToNameMap.has(d.indicatorId)) {
            // indicator.xlsxì—ì„œ ì‚­ì œëœ ì§€í‘œ í´ë¦­ ì‹œ ì•Œë¦¼
            console.warn(`âš ï¸ ì§€í‘œ ${d.indicatorId}ëŠ” indicator.xlsxì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
            alert(`ì´ ì§€í‘œ(${d.indicatorId})ëŠ” ë” ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`);
          }
        })
        .on("mouseenter", function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", d => `translate(${d.x}, ${d.y}) scale(1.2)`);
          
          d3.select(this).selectAll("circle")
            .transition()
            .duration(200)
            .style("filter", "drop-shadow(0 3px 8px rgba(0,0,0,0.3))");
        })
        .on("mouseleave", function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", d => `translate(${d.x}, ${d.y}) scale(1)`);
          
          d3.select(this).selectAll("circle")
            .transition()
            .duration(200)
            .style("filter", "none");
        });
      
      // ì™¸ê³½ í…Œë‘ë¦¬ (ê·¸ë¦¼ì íš¨ê³¼)
      indicatorGroup.append("circle")
        .attr("r", 18) // ì™¸ê³½ ì›
        .attr("fill", "rgba(0,0,0,0.2)")
        .attr("transform", "translate(2, 2)"); // ê·¸ë¦¼ì íš¨ê³¼
      
      // ë©”ì¸ ì›í˜•
      indicatorGroup.append("circle")
        .attr("class", "indicator-main")
        .attr("r", 16) // í¬ê¸° í™•ëŒ€ (12 â†’ 16)
        .attr("fill", d => d.color)
        .attr("stroke", d => {
          // d.indicatorId ì˜ˆ: "IND500" í˜•ì‹ ê°€ì •(ë¹„ì •ìƒ í¬ë§·ë„ ì•ˆì „ ì²˜ë¦¬)
          const id = (d && d.indicatorId) ? String(d.indicatorId) : "";
          const num = parseInt(id.slice(3), 10); // "IND" ì´í›„ ìˆ«ìë§Œ íŒŒì‹±
          // ìƒˆë¡œ ì¶”ê°€ëœ êµ¬ê°„(IND500 ì´ìƒ)ì€ ë¹¨ê°•ìƒ‰ ì™¸ê³½ì„ , ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´(#fff)
          if (!Number.isNaN(num) && num >= 500) return "#E53935";
          return "#fff";
        })
        .attr("stroke-width", 3); // í…Œë‘ë¦¬ ë‘ê»˜ ìœ ì§€
      
      // ë‚´ë¶€ í•˜ì´ë¼ì´íŠ¸ (ê´‘íƒ íš¨ê³¼)
      indicatorGroup.append("circle")
        .attr("r", 6)
        .attr("fill", "rgba(255,255,255,0.3)")
        .attr("transform", "translate(-3, -3)") // ì™¼ìª½ ìœ„ í•˜ì´ë¼ì´íŠ¸
        .style("pointer-events", "none");
      
      // ë” ë‚˜ì€ íˆ´íŒ êµ¬í˜„
      indicatorGroup.append("title")
        .text(d => {
          if (d.indicatorId) {
            return `${d.name} (${d.indicatorId})`;
          }
          return d.name || 'Bloomberg Ticker ì •ë³´ ì—†ìŒ';
        });
      
      // ì¸ë””ì¼€ì´í„° ìƒ‰ìƒ(C1 í”Œë˜ê·¸) ë¹„ë™ê¸° ë°˜ì˜
      (async () => {
        const nodes = indicatorGroup.nodes();
        for (const node of nodes) {
          try {
            const d = d3.select(node).datum();
            if (!d || !d.indicatorId) continue;
            const flag = await fetchIndicatorFlag(d.indicatorId);
            const fill = flag === 'Y' ? '#FF8A00' : '#B3E5FC';
            d3.select(node).select('.indicator-main').attr('fill', fill);
          } catch (_) { /* ignore */ }
        }
      })();

      // GPT1 ì•µì»¤ ì‹œê°í™” - nodeLayerì— ì¶”ê°€
      const gptAnchorGroup = nodeLayer.append('g')
        .attr('class', 'gpt1-anchor')
        .attr('transform', `translate(${gptAnchorX}, ${gptAnchorY})`);

      gptAnchorGroup.append('rect')
        .attr('x', -110)
        .attr('y', -28)
        .attr('width', 220)
        .attr('height', 56)
        .attr('fill', '#2c2c2c')
        .attr('stroke', '#7ab7ff')
        .attr('stroke-width', 2)
        .attr('rx', 12)
        .attr('ry', 12);

      gptAnchorGroup.append('text')
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#fff')
        .attr('font-weight', 'bold')
        .attr('font-size', '1.2em')
        .text('ë°ì´í„°ì§‘ê³„');

      // GPT2, GPT3 ì•µì»¤ ì‹œê°í™” (ìš°ì¸¡ìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ í‘œì‹œ)
      // gpt2ë¶€í„° ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ (gpt1â†’gpt2ë§Œ 300ìœ¼ë¡œ íŠ¹ìˆ˜ ì¡°ì •)
      const gpt2AnchorX = gptAnchorX + GAP_GPT1_TO_GPT2;
      const gpt2AnchorY = gptAnchorY;
      const gpt3AnchorX = gpt2AnchorX + GAP_X;
      const gpt3AnchorY = gptAnchorY;
      const gpt4AnchorX = gpt3AnchorX + GAP_X;
      const gpt4AnchorY = gptAnchorY;

      const gpt2AnchorGroup = nodeLayer.append('g')
        .attr('class', 'gpt2-anchor')
        .attr('transform', `translate(${gpt2AnchorX}, ${gpt2AnchorY})`);
      gpt2AnchorGroup.append('rect')
        .attr('x', -110).attr('y', -28).attr('width', 220).attr('height', 56)
        .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
        .attr('rx', 12).attr('ry', 12);
      gpt2AnchorGroup.append('text')
        .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
        .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '1.2em')
        .text('ë¶„ì„ ì¤‘ê³„');

      // GPT3 ë„ë©”ì¸ ì—ì´ì „íŠ¸ 5ê°œ ì•µì»¤ (ì„¸ë¡œ ìŠ¤íƒ)
      const gpt3Agents = [
        { id: 'market', label: 'ì‹œì¥ë¦¬ìŠ¤í¬ ì—ì´ì „íŠ¸' },
        { id: 'credit', label: 'ì‹ ìš©ë¦¬ìŠ¤í¬ ì—ì´ì „íŠ¸' },
        { id: 'alm', label: 'ALM ì—ì´ì „íŠ¸' },
        { id: 'global', label: 'ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì—ì´ì „íŠ¸' },
        { id: 'creditpf', label: 'ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì—ì´ì „íŠ¸' }
      ];

      const gpt3Groups = gpt3Agents.map((agent, idx) => {
        const gy = gpt3AnchorY + (idx - 2) * 80; // ìœ„ì•„ë˜ë¡œ ë°°ì¹˜
        const grp = nodeLayer.append('g')
          .attr('class', `gpt3-anchor-${agent.id}`)
          .attr('transform', `translate(${gpt3AnchorX}, ${gy})`);
        grp.append('rect')
          .attr('x', -130).attr('y', -24).attr('width', 260).attr('height', 48)
          .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
          .attr('rx', 12).attr('ry', 12);
        grp.append('text')
          .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
          .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '0.95em')
          .text(agent.label);
        return { id: agent.id, x: gpt3AnchorX, y: gy };
      });

      // GPT0 ì„œë¸Œì—ì´ì „íŠ¸ (ì‚¬ì „ìˆ˜ì§‘ í•˜ìœ„, ì¢Œì¸¡ ìŠ¤íƒ)
      // gpt0ë¥¼ ì‹œë‚˜ë¦¬ì˜¤ ìª½ìœ¼ë¡œ ì´ë™ (gpt1ì—ì„œ í•œ ì¹¸=GAP_X ë§Œí¼ ì¢Œì¸¡)
      const gpt0AnchorX2 = gptAnchorX - GAP_GPT0_FROM_GPT1;
      const gpt0Agents = [
        { id: 'marketdata', label: 'ë§ˆì¼“ë°ì´í„° ë¶„ì„' },
        { id: 'news',       label: 'ê¸°ì‚¬ë‰´ìŠ¤ ë¶„ì„' },
        { id: 'scenario-summary', label: 'ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ë¶„ì„' },
        { id: 'marketstate',label: 'í˜„ì¬ ì‹œí™©ë¶„ì„' }
      ];
      const gpt0Groups = gpt0Agents.map((agent, idx) => {
        const gy = gptAnchorY + (idx - 1.5) * 80;
        const grp = nodeLayer.append('g')
          .attr('class', `gpt0-anchor-${agent.id}`)
          .attr('transform', `translate(${gpt0AnchorX2}, ${gy})`);
        grp.append('rect')
          .attr('x', -130).attr('y', -24).attr('width', 260).attr('height', 48)
          .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
          .attr('rx', 12).attr('ry', 12);
        grp.append('text')
          .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
          .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '0.95em')
          .text(agent.label);
        return { id: agent.id, x: gpt0AnchorX2, y: gy };
      });

      // GPT íŒŒì´í”„ë¼ì¸ ë¼ì¸ í‘œì‹œ (GPT0 â†’ GPT1 â†’ GPT2 â†’ GPT3 â†’ GPT4)
      const pipelineColor = '#7ab7ff';
      const pipelineGroup = linkLayer.append('g').attr('class','pipeline');
      // GPT0 í—ˆë¸Œ ìœ„ì¹˜(ì‹œë‚˜ë¦¬ì˜¤Â·ì„œë¸Œì—ì´ì „íŠ¸ ì„ ì´ ëª¨ì´ëŠ” ì§€ì )
      // ì‹œë‚˜ë¦¬ì˜¤ ê³µí†µ ê¼­ì§€ì ì€ drawScenarioConnectionsì—ì„œ ê³„ì‚°(commonHubX/Y)
      // ì—¬ê¸°ì„œëŠ” gpt0 â†’ ê³µí†µ í—ˆë¸Œ, ê³µí†µ í—ˆë¸Œ â†’ gpt1 ë¼ì¸ë§Œ ìœ ì§€
      const gptHubX = gpt0AnchorX2 - 500; // ê³µí†µ ê¼­ì§€ì ê³¼ ì¼ì¹˜ (gpt0ê°€ ì´ë™í•˜ë©´ í—ˆë¸Œë„ í•¨ê»˜ ì´ë™)
      // ê³µí†µ í—ˆë¸Œ â†’ GPT0 ê° ëª¨ë“ˆ ì ì„  (gpt3 ë¶„ê¸° ìŠ¤íƒ€ì¼)
      gpt0Groups.forEach(({x, y}) => {
        const c1x = gptHubX + 320;   // ì¶œë°œ ì»¨íŠ¸ë¡¤ í¬ì¸íŠ¸
        const c2x = x - 320;         // ë„ì°© ì»¨íŠ¸ë¡¤ í¬ì¸íŠ¸
        pipelineGroup.append('path').lower()
          .attr('d', `M ${gptHubX},${gptAnchorY} C ${c1x},${gptAnchorY} ${c2x},${y} ${x - 140},${y}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0)
          .attr('class','pipeline-line to-gpt0')
          .attr('data-from','hub')
          .attr('data-to','gpt0')
          .style('cursor', 'default');
      });
      // GPT0 ê° ëª¨ë“ˆ â†’ GPT1 ì ì„  (gpt3â†’gpt4ì™€ ë™ì¼ ìŠ¤íƒ€ì¼)
      gpt0Groups.forEach(({x, y}) => {
        const c1x = x + 320;
        const c2x = gptAnchorX - 320;
        pipelineGroup.append('path').lower()
          .attr('d', `M ${x + 140},${y} C ${c1x},${y} ${c2x},${gptAnchorY} ${gptAnchorX - 120},${gptAnchorY}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0)
          .attr('class','pipeline-line to-gpt1')
          .attr('data-from','gpt0')
          .attr('data-to','gpt1')
          .style('cursor', 'default');
      });

      pipelineGroup.append('line')
        .attr('x1', gptAnchorX + 120).attr('y1', gptAnchorY)
        .attr('x2', gpt2AnchorX - 120).attr('y2', gpt2AnchorY)
        .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
        .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0).attr('class','pipeline-line to-gpt2')
        .attr('data-from','gpt1')
        .attr('data-to','gpt2')
        .style('cursor', 'default');
      // GPT2 â†’ GPT3 ê° ë„ë©”ì¸ìœ¼ë¡œ ë¶„ê¸°
      gpt3Groups.forEach(({x, y}) => {
        const c1x = gpt2AnchorX + 320; // ì¶œë°œ ìª½ ì»¨íŠ¸ë¡¤ í¬ì¸íŠ¸(ê±°ë¦¬ í™•ëŒ€)
        const c2x = x - 320;           // ë„ì°© ìª½ ì»¨íŠ¸ë¡¤ í¬ì¸íŠ¸(ê±°ë¦¬ í™•ëŒ€)
        pipelineGroup.append('path').lower()
          .attr('d', `M ${gpt2AnchorX + 120},${gpt2AnchorY} C ${c1x},${gpt2AnchorY} ${c2x},${y} ${x - 140},${y}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0).attr('class','pipeline-line to-gpt3')
          .attr('data-from','gpt2')
          .attr('data-to','gpt3')
          .style('cursor', 'default');
      });

      // GPT4 ì•µì»¤ ì‹œê°í™” (GPT3 ì˜¤ë¥¸ìª½)
      const gpt4AnchorGroup = g.append('g')
        .attr('class', 'gpt4-anchor')
        .attr('transform', `translate(${gpt4AnchorX}, ${gpt4AnchorY})`);
      gpt4AnchorGroup.append('rect')
        .attr('x', -110).attr('y', -28).attr('width', 220).attr('height', 56)
        .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
        .attr('rx', 12).attr('ry', 12);
      gpt4AnchorGroup.append('text')
        .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
        .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '1.2em')
        .text('ìµœì¢… ë¦¬í¬íŠ¸');

      // GPT3 â†’ GPT4 íŒŒì´í”„ë¼ì¸ ë¼ì¸
      gpt3Groups.forEach(({x, y}) => {
        const c1x = x + 320;
        const c2x = gpt4AnchorX - 320;
        pipelineGroup.append('path').lower()
          .attr('d', `M ${x + 140},${y} C ${c1x},${y} ${c2x},${gpt4AnchorY} ${gpt4AnchorX - 120},${gpt4AnchorY}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0).attr('class','pipeline-line to-gpt4')
          .attr('data-from','gpt3')
          .attr('data-to','gpt4')
          .style('cursor', 'default');
      });

      // ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œ ë Œë”ë§ (ì§ì‚¬ê°í˜• ë°•ìŠ¤) - nodeLayerì— ì¶”ê°€
      const scenarioGroup = nodeLayer.selectAll(".scenario-group")
        .data(scenarioNodes)
        .enter().append("g")
        .attr("class", "scenario-group")
        .attr("data-scen", d => d.n);
      
      // ì§ì‚¬ê°í˜• ë°•ìŠ¤ - í‚¤ì›Œë“œê°€ ë‚´ë¶€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ í™•ëŒ€ëœ í¬ê¸° ë°˜ì˜
      const scenarioNode = scenarioGroup.append("rect")
        .attr("class", "scenario-node")
        .attr("x", -SCENARIO_HALF_WIDTH)
        .attr("y", -SCENARIO_HALF_HEIGHT)
        .attr("width", SCENARIO_BOX_WIDTH)
        .attr("height", SCENARIO_BOX_HEIGHT)
        .attr("fill", "#f39c12")
        .attr("stroke", "#e67e22")
        .attr("stroke-width", 2)
        .attr("rx", 15) // ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ
        .attr("ry", 15)
        .style("cursor", "pointer")
        .on("click", function(event, d) {
          // âš ï¸ í‚¤ì›Œë“œ ë°•ìŠ¤ í´ë¦­ì¸ ê²½ìš° ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
          const clickedElement = event.target;
          const isKeywordClick = clickedElement.closest('.keyword-node');
          if (isKeywordClick) {
            return; // í‚¤ì›Œë“œ í´ë¦­ì´ë©´ ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ì´ë²¤íŠ¸ ì‹¤í–‰ ì•ˆ í•¨
          }
          
          // âœ… ë³€ê²½: ë°•ìŠ¤ í´ë¦­ â†’ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ë° ë°ì´í„° ì¤€ë¹„
          const scenNum = d.n ?? d.number ?? d.scenarioNumber;
          const scenName = d.name ?? d.title ?? `ì‹œë‚˜ë¦¬ì˜¤ ${scenNum}`;
          
          // ì—°ê²°ëœ ì‹œì¥ë°ì´í„° ì •ë³´ í‘œì‹œ (onClickScenarioToGptLink í•¨ìˆ˜ í˜¸ì¶œ)
          if (typeof onClickScenarioToGptLink === 'function') {
            onClickScenarioToGptLink(scenNum);
          }
          
          // ğŸ“± ëª¨ë°”ì¼ í™˜ê²½ ì²´í¬ ë° GPT0 ì¹´ë“œë§Œ í‘œì‹œ
          if (typeof showOnlyGpt0CardMobile === 'function') {
            showOnlyGpt0CardMobile();
          }
          
          // ì—°ê²°ì„  í•˜ì´ë¼ì´íŠ¸ (ì‹œê°ì  í‘œì‹œë§Œ)
          highlightConnection({ type: 'scenario-to-gpt', scenarioNumber: scenNum });
          
          // âš ï¸ gotoStep ì œê±°: ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ì„ í´ë¦­í•´ì•¼ GPT0ë¶€í„° ì‹œì‘
          // íƒ­ ìµœìƒë‹¨(ë¶„ì„ì‹œì‘ ë²„íŠ¼ ìœ„ì¹˜)ìœ¼ë¡œ ìŠ¤í¬ë¡¤
          const panel = document.querySelector('.sidebar-right, aside.sidebar-right, #gpt1-panel');
          if (panel) {
            setTimeout(() => {
              try {
                panel.scrollTo({ top: 0, behavior: 'smooth' });
              } catch(_) {}
            }, 100);
          }
          
          // í´ë¦­ëœ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸
          scenarioGroup.selectAll("rect").attr("stroke", "#e67e22").attr("stroke-width", 2);
          d3.select(this).attr("stroke", "#e74c3c").attr("stroke-width", 4);
        });

      // ì‹œë‚˜ë¦¬ì˜¤ ë¼ë²¨ (ì§ì‚¬ê°í˜• ë°•ìŠ¤ ì•ˆì— ì§ì ‘ ë°°ì¹˜) - ë†’ì´ ì¶•ì†Œì— ë§ì¶° í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì •
      scenarioGroup.each(function(d) {
        const group = d3.select(this);
        const words = d.name.split(' ');
        
        if (words.length > 2) { // ë” ì ì€ ë‹¨ì–´ìˆ˜ì—ì„œë„ ì¤„ë°”ê¿ˆ
          // ê¸´ í…ìŠ¤íŠ¸ëŠ” ë‘ ì¤„ë¡œ ë¶„í• 
          const midPoint = Math.ceil(words.length / 2);
          const firstLine = words.slice(0, midPoint).join(' ');
          const secondLine = words.slice(midPoint).join(' ');
          
          group.append("text")
            .attr("text-anchor", "middle")
            .attr("fill", "white")
            .attr("font-size", () => window.innerWidth <= 900 ? "1.4em" : "1.1em") // ëª¨ë°”ì¼ì—ì„œ í°íŠ¸ í¬ê¸° ì¦ê°€
            .attr("font-weight", "bold")
            .attr("y", -SCENARIO_HALF_HEIGHT + 20) // ë¼ë²¨ ì²« ì¤„
            .style("pointer-events", "none")
            .text(firstLine);
            
          group.append("text")
            .attr("text-anchor", "middle")
            .attr("fill", "white")
            .attr("font-size", () => window.innerWidth <= 900 ? "1.4em" : "1.1em") // ëª¨ë°”ì¼ì—ì„œ í°íŠ¸ í¬ê¸° ì¦ê°€
            .attr("font-weight", "bold")
            .attr("y", -SCENARIO_HALF_HEIGHT + 40) // ë¼ë²¨ ë‘ ë²ˆì§¸ ì¤„
            .style("pointer-events", "none")
            .text(secondLine);
        } else {
          // ì§§ì€ í…ìŠ¤íŠ¸ëŠ” í•œ ì¤„ë¡œ
          group.append("text")
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .attr("fill", "white")
            .attr("font-size", () => window.innerWidth <= 900 ? "1.6em" : "1.3em") // ëª¨ë°”ì¼ì—ì„œ í°íŠ¸ í¬ê¸° ì¦ê°€
            .attr("font-weight", "bold")
            .attr("y", -SCENARIO_HALF_HEIGHT + 30)
            .style("pointer-events", "none")
            .text(d.name);
        }
      });

      // ğŸ“Œ 'ì‹œë‚˜ë¦¬ì˜¤ë‚´ìš©' ë²„íŠ¼ ì¶”ê°€ (PDF ì˜¤í”ˆ ì „ìš©) - ë°•ìŠ¤ ë‚´ë¶€ ë§¨ ì•„ë˜
      scenarioGroup.each(function(d) {
        const group = d3.select(this);
        
        // ë²„íŠ¼ í¬ê¸° ì„¤ì • (ë†’ì´ë¥¼ ë°˜ìœ¼ë¡œ ì¤„ì„)
        const buttonWidth = 160;
        const buttonHeight = 12;
        
        // ë²„íŠ¼ ê·¸ë£¹ ìƒì„± (ë°•ìŠ¤ ë§¨ ì•„ë˜ ë°°ì¹˜)
        const docBtn = group.append('g')
          .attr('class', 'scenario-doc-btn')
          .attr('transform', `translate(${-buttonWidth / 2}, ${SCENARIO_HALF_HEIGHT - buttonHeight - 6})`)
          .style('cursor', 'pointer')
          .on('click', function(event, d) {
            // ë¶€ëª¨(ë°•ìŠ¤) í´ë¦­(=ë¶„ì„ì¤€ë¹„) ì „íŒŒ ë°©ì§€
            event.stopPropagation();
            
            const scenNum = d.n ?? d.number ?? d.scenarioNumber;
            const scenName = d.name ?? d.title ?? `ì‹œë‚˜ë¦¬ì˜¤ ${scenNum}`;
            
            // ê¸°ì¡´ PDF ì˜¤í”ˆ í•¨ìˆ˜ í˜¸ì¶œ
            openScenarioPDF(scenNum, scenName);
          });
        
        // ë²„íŠ¼ ë°°ê²½
        docBtn.append('rect')
          .attr('rx', 8).attr('ry', 8)
          .attr('width', buttonWidth).attr('height', buttonHeight)
          .attr('fill', '#1e88e5')
          .attr('opacity', 0.9);
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ (ì‘ì€ í°íŠ¸ë¡œ ì¡°ì •)
        docBtn.append('text')
          .attr('x', buttonWidth / 2).attr('y', buttonHeight / 2 + 1)
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .attr('fill', '#fff')
          .attr('font-size', 10)
          .attr('font-weight', 'bold')
          .style('pointer-events', 'none')
          .text('ì‹œë‚˜ë¦¬ì˜¤ë‚´ìš©');
      });

      // ì—°ê²°ì„ ì´ ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ìœ„ë¡œ ì˜¬ë¼ì˜¤ì§€ ì•Šë„ë¡, ì‹œë‚˜ë¦¬ì˜¤ ê·¸ë£¹ì„ ìµœìƒìœ„ë¡œ ì˜¬ë¦¼
      scenarioGroup.raise();

      // === í‚¤ì›Œë“œë¥¼ ê° ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ë‚´ë¶€ì— ë°°ì¹˜ ===
      scenarioGroup.each(function(d){
        const group = d3.select(this);
        const scenNum = Number(d.n);
        const itemsAll = keywordNodes.filter(k => k.scenarioNum === scenNum);
        if (!itemsAll || !itemsAll.length) return;

        // 4ì—´ ë°°ì¹˜ (ê³ ì • ë°•ìŠ¤ ë†’ì´ ë‚´ì—ì„œë§Œ í‘œì‹œ)
        const cols = 4; // ë‚´ë¶€ ì¹¼ëŸ¼ ìˆ˜
        const boxW = 82, boxH = 22, hGap = 10, vGap = 8; // 4x3 ë°°ì¹˜ì— ë§ì¶° ê°€ë¡œ í™•ì¥, ì•½ê°„ ë†’ì„
        const padX = 14; // ì–‘ì˜† ì—¬ë°± ì†Œí­ í™•ëŒ€
        const padTop = SCENARIO_LABEL_AREA + 10; // ë¼ë²¨ê³¼ í‚¤ì›Œë“œ ê°„ê²© ì¡°ê¸ˆ ë” í™•ë³´
        const startX = -SCENARIO_HALF_WIDTH + padX;
        const startY = -SCENARIO_HALF_HEIGHT + padTop;
        // ê³ ì • ë°•ìŠ¤ ë†’ì´ì— ë§ëŠ” ìµœëŒ€ í–‰/ì•„ì´í…œ ìˆ˜ ê³„ì‚°
        const usableHeight = SCENARIO_BOX_HEIGHT - padTop - 14;
        const maxRows = Math.max(1, Math.floor(usableHeight / (boxH + vGap)));
        const maxItems = cols * maxRows;
        const items = itemsAll.slice(0, maxItems);

        items.forEach((it, idx) => {
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          it.kx = startX + col * (boxW + hGap);
          it.ky = startY + row * (boxH + vGap);
          it.width = boxW; it.height = boxH; it.kwidth = boxW; it.kheight = boxH;
        });

        const kw = group.selectAll('.keyword-node')
          .data(items, d => d.id)
          .enter().append('g')
          .attr('class', 'keyword-node')
          .attr('transform', d => `translate(${d.kx}, ${d.ky})`)
          .style('cursor', d => (d.title && d.title.trim()) ? 'pointer' : 'default')
          .on('click', function(event, d){
            // ğŸ”¥ 1. ìƒìœ„ ì´ë²¤íŠ¸ ì „íŒŒ ì°¨ë‹¨ (ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ í´ë¦­ ë°©ì§€)
            event.stopPropagation();
            event.preventDefault();
            
            const url = (d.url || '').trim();
            if (!url) return;
            
            // ğŸ”¥ 2. ëª¨ë°”ì¼ ê°ì§€
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                          || window.innerWidth <= 900;
            
            // ğŸ”¥ 3. PCì™€ ëª¨ë°”ì¼ ë™ì‘ í†µì¼: ì§ì ‘ ë‰´ìŠ¤ í˜ì´ì§€ë¡œ ì´ë™
            try {
              if (isMobile) {
                // ëª¨ë°”ì¼: ì§ì ‘ ë‰´ìŠ¤ URLë¡œ ìƒˆ íƒ­/ìƒˆ ì°½ ì—´ê¸° (íŒì—… ì°¨ë‹¨ ë°©ì§€)
                window.open(url, '_blank', 'noopener,noreferrer');
              } else {
                // PC: ëª¨ë‹¬ ë°©ì‹ ì‹œë„, ì‹¤íŒ¨ ì‹œ ì§ì ‘ ë§í¬ë¡œ
                try {
                  openNewsModal(d.label, url);
                } catch(modalErr) {
                  console.warn('ëª¨ë‹¬ ì—´ê¸° ì‹¤íŒ¨, ì§ì ‘ ë§í¬ë¡œ ì´ë™:', modalErr);
                  window.open(url, '_blank', 'noopener,noreferrer');
                }
              }
            } catch(err) {
              console.error('ë‰´ìŠ¤ ë§í¬ ì—´ê¸° ì‹¤íŒ¨:', err);
              // ìµœì¢… fallback: í˜„ì¬ íƒ­ì—ì„œ ì´ë™
              window.location.href = url;
            }
          });

        // Phase ìƒ‰ìƒì— ë”°ë¥¸ ê¹œë°•ì„ íš¨ê³¼ ë° ìƒ‰ìƒ ì§€ì • (ëª¨ë“  í‚¤ì›Œë“œ ìƒì„±)
        kw.append('rect')
          .attr('width', d => d.width)
          .attr('height', d => d.height)
          .each(function(d){
            const phase = String(d.phase || '').toLowerCase();
            if (phase === 'yellow' || phase === 'y') d3.select(this.parentNode).classed('kw-blink-yellow', true);
            if (phase === 'red' || phase === 'r') d3.select(this.parentNode).classed('kw-blink-red', true);
          })
          .attr('stroke', function(d){
            const phase = String(d.phase || '').toLowerCase();
            if (phase === 'yellow' || phase === 'y') return '#FFD54F';
            if (phase === 'red' || phase === 'r') return '#E53935';
            return '#c3c8d0';
          });

        kw.each(function(d){
          const el = d3.select(this);
          el.append('text')
            .attr('x', d.width / 2)
            .attr('y', d.height / 2 + 0.5)
            .style('font-size', '11px')
            .text(d.label);
        })
        .on('mouseenter', function(event, d){
          const scenKey = normalizeScenarioId(d.scenarioId || '');
          const ktext = normalizeKeywordText(d.label || '');
          const meta = findNewsMeta(scenKey, d.scenarioNum, ktext);
          const effectiveTitle = (d.title && d.title.trim()) || meta?.title || '';
          const effectivePress = (d.press && d.press.trim()) || meta?.press || '';
          if (!effectiveTitle) return;
          const press = effectivePress ? ` [${effectivePress}]` : '';
          kwTooltip.textContent = effectiveTitle + press;
          kwTooltip.style.display = 'block';
          const pad = 12;
          kwTooltip.style.left = (event.clientX + pad) + 'px';
          kwTooltip.style.top = (event.clientY + pad) + 'px';
        })
        .on('mousemove', function(event, d){
          const scenKey = normalizeScenarioId(d.scenarioId || '');
          const ktext = normalizeKeywordText(d.label || '');
          const meta = findNewsMeta(scenKey, d.scenarioNum, ktext);
          const effectiveTitle = (d.title && d.title.trim()) || meta?.title || '';
          if (!effectiveTitle) return;
          const pad = 12;
          kwTooltip.style.left = (event.clientX + pad) + 'px';
          kwTooltip.style.top = (event.clientY + pad) + 'px';
        })
        .on('mouseleave', function(){
          kwTooltip.style.display = 'none';
        });
      });

      // ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•´ ì§€í‘œ ì—°ê²°ì„  ê·¸ë¦¬ê¸° (ì§€í‘œ) + GPT1 ì—°ê²°ì„  (ì‹œë‚˜ë¦¬ì˜¤â†’GPT1)
      async function drawScenarioConnections(scenarioNumber) {
        // ì‹œë‚˜ë¦¬ì˜¤ë³„ ìƒ‰ìƒ ì •ì˜
        const colors = [
          '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
          '#e67e22', '#1abc9c', '#34495e', '#f1c40f', '#95a5a6',
          '#c0392b', '#2980b9', '#27ae60', '#d35400', '#8e44ad',
          '#16a085', '#2c3e50', '#f39c12', '#bdc3c7', '#7f8c8d',
          '#e8c547', '#5dade2', '#58d68d', '#ec7063', '#af7ac5',
          '#fad7a0', '#85c1e9', '#a9dfbf', '#f1948a', '#d7bde2',
          '#fdeaa7', '#a3d4f7', '#c8e6c9', '#ffcdd2', '#e1bee7'
        ];
        
        const color = colors[(scenarioNumber - 1) % colors.length];
        
        // í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ì˜ ê´€ë ¨ ì§€í‘œë“¤ ê°€ì ¸ì˜¤ê¸° (IDì™€ ì´ë¦„ ëª¨ë‘ í¬í•¨)
        let scenarioIndicators = [];
        
        // ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ INDICATOR ì‹œíŠ¸ë¥¼ ìš°ì„  ì‚¬ìš© (ë°ì´í„° ë¶ˆì¼ì¹˜ í•´ê²°)
        if (scenarioData[scenarioNumber] && scenarioData[scenarioNumber].indicators && scenarioData[scenarioNumber].indicators.length > 0) {
          console.log(`ğŸ”§ ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: INDICATOR ì‹œíŠ¸ ìš°ì„  ì‚¬ìš©`);
          
          scenarioIndicators = scenarioData[scenarioNumber].indicators.map(indicator => {
            const indicatorName = indicatorIdToNameMap.get(indicator.Indicator_ID);
            
            // íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤ ë””ë²„ê¹…
            if (indicator.Indicator_ID === 'IND111' || scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
              console.log(`ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber} (INDICATOR ì‹œíŠ¸): ${indicator.Indicator_ID} -> ${indicatorName || 'undefined'}`);
            }
            
            // LINKS ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì§€í‘œì˜ ê°€ì¤‘ì¹˜/ìƒê´€ê³„ìˆ˜ ì°¾ê¸° (ìˆìœ¼ë©´)
            const linkData = scenarioData[scenarioNumber].links?.find(link => link.Indicator_ID === indicator.Indicator_ID);
            
            return indicatorName ? {
              id: indicator.Indicator_ID,
              name: indicatorName,
              weight: linkData?.Weight || 1.0, // ê¸°ë³¸ ê°€ì¤‘ì¹˜
              correlation: linkData?.Correlation_Coeff || 0.0 // ê¸°ë³¸ ìƒê´€ê³„ìˆ˜
            } : null;
          }).filter(Boolean);
          
        } else if (scenarioData[scenarioNumber] && scenarioData[scenarioNumber].links) {
          // Fallback: INDICATOR ì‹œíŠ¸ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ LINKS ì‹œíŠ¸ ì‚¬ìš©
          console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: INDICATOR ì‹œíŠ¸ ì—†ìŒ, LINKS ì‹œíŠ¸ ì‚¬ìš©`);
          
          scenarioIndicators = scenarioData[scenarioNumber].links.map(link => {
            const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
            
            // íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤ ë””ë²„ê¹…
            if (link.Indicator_ID === 'IND111' || scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
              console.log(`ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber} (LINKS ì‹œíŠ¸): ${link.Indicator_ID} -> ${indicatorName || 'undefined'}`);
            }
            
            return indicatorName ? {
              id: link.Indicator_ID,
              name: indicatorName,
              weight: link.Weight,
              correlation: link.Correlation_Coeff
            } : null;
          }).filter(Boolean);
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ 7, 13, 22, 30ì— ëŒ€í•œ ì¶”ê°€ ë””ë²„ê¹…
        if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
          console.log(`ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ìƒì„¸ ì—°ê²° ì •ë³´:`);
          console.log(`ì›ë³¸ links:`, scenarioData[scenarioNumber]?.links?.map(l => l.Indicator_ID));
          console.log(`ë§¤í•‘ëœ ì§€í‘œë“¤:`, scenarioIndicators.map(s => `${s.id} -> "${s.name}"`));
          
                     // ì‹œë‚˜ë¦¬ì˜¤ë³„ íŠ¹ë³„ ìƒì„¸ ë¶„ì„
           if (scenarioNumber === 7) {
             console.log(`ğŸ“Š === ì‹œë‚˜ë¦¬ì˜¤ 07 ë§ˆì¼“ë°ì´í„° ì—°ê²° ìƒì„¸ ë¶„ì„ ===`);
             const scenarioLinks = scenarioData[7]?.links || [];
             scenarioLinks.forEach((link, index) => {
               const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
               console.log(`${index + 1}. ${link.Indicator_ID} -> "${indicatorName}" ${indicatorName ? 'âœ…' : 'âŒ'}`);
             });
             console.log(`ì´ ${scenarioLinks.length}ê°œì˜ ì§€í‘œì™€ ì—°ê²° ì‹œë„`);
             console.log(`ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ëœ ì§€í‘œ: ${scenarioIndicators.length}ê°œ`);
             
             if (scenarioIndicators.length === 0) {
               console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ 7ì—ì„œ ì—°ê²°ì„ ì´ ê·¸ë ¤ì§€ì§€ ì•ŠëŠ” ì´ìœ :`);
               console.log(`- ëª¨ë“  ì§€í‘œ IDê°€ indicatorIdToNameMapì— ë§¤í•‘ë˜ì§€ ì•ŠìŒ`);
               console.log(`- ë˜ëŠ” links ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ`);
             }
           }
           
           if (scenarioNumber === 13) {
             console.log(`ğŸ“Š === ì‹œë‚˜ë¦¬ì˜¤ 13 ë§ˆì¼“ë°ì´í„° ì—°ê²° ìƒì„¸ ë¶„ì„ ===`);
             const scenarioLinks = scenarioData[13]?.links || [];
             scenarioLinks.forEach((link, index) => {
               const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
               console.log(`${index + 1}. ${link.Indicator_ID} -> "${indicatorName}" ${indicatorName ? 'âœ…' : 'âŒ'}`);
             });
             console.log(`ì´ ${scenarioLinks.length}ê°œì˜ ì§€í‘œì™€ ì—°ê²° ì‹œë„`);
             console.log(`ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ëœ ì§€í‘œ: ${scenarioIndicators.length}ê°œ`);
             
             if (scenarioIndicators.length === 0) {
               console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ 13ì—ì„œ ì—°ê²°ì„ ì´ ê·¸ë ¤ì§€ì§€ ì•ŠëŠ” ì´ìœ :`);
               console.log(`- ëª¨ë“  ì§€í‘œ IDê°€ indicatorIdToNameMapì— ë§¤í•‘ë˜ì§€ ì•ŠìŒ`);
               console.log(`- ë˜ëŠ” links ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ`);
             }
           }
           
           if (scenarioNumber === 22) {
             console.log(`ğŸ“Š === ì‹œë‚˜ë¦¬ì˜¤ 22 ë§ˆì¼“ë°ì´í„° ì—°ê²° ìƒì„¸ ë¶„ì„ ===`);
             const scenarioLinks = scenarioData[22]?.links || [];
             scenarioLinks.forEach((link, index) => {
               const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
               console.log(`${index + 1}. ${link.Indicator_ID} -> "${indicatorName}" ${indicatorName ? 'âœ…' : 'âŒ'}`);
             });
             console.log(`ì´ ${scenarioLinks.length}ê°œì˜ ì§€í‘œì™€ ì—°ê²° ì‹œë„`);
             console.log(`ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ëœ ì§€í‘œ: ${scenarioIndicators.length}ê°œ`);
             
             if (scenarioIndicators.length === 0) {
               console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ 22ì—ì„œ ì—°ê²°ì„ ì´ ê·¸ë ¤ì§€ì§€ ì•ŠëŠ” ì´ìœ :`);
               console.log(`- ëª¨ë“  ì§€í‘œ IDê°€ indicatorIdToNameMapì— ë§¤í•‘ë˜ì§€ ì•ŠìŒ`);
               console.log(`- ë˜ëŠ” links ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ`);
             }
           }
           
                       if (scenarioNumber === 30) {
              console.log(`ğŸ“Š === ì‹œë‚˜ë¦¬ì˜¤ 30 ë§ˆì¼“ë°ì´í„° ì—°ê²° ìƒì„¸ ë¶„ì„ ===`);
              const scenarioLinks = scenarioData[30]?.links || [];
              
              // ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ 30 ë°ì´í„° í™•ì¸
              console.log(`ì‹œë‚˜ë¦¬ì˜¤ 30 ì „ì²´ ë°ì´í„°:`, scenarioData[30]);
              console.log(`ì‹œë‚˜ë¦¬ì˜¤ 30 ê°œìš”:`, scenarioData[30]?.overview);
              console.log(`ì‹œë‚˜ë¦¬ì˜¤ 30 links ì›ë³¸:`, scenarioData[30]?.links);
              
              // ì‹œë‚˜ë¦¬ì˜¤ 30 indicators ì‹œíŠ¸ë„ í™•ì¸ (INDICATOR ì‹œíŠ¸ ë‚´ìš©)
              console.log(`ğŸ“‹ === ì‹œë‚˜ë¦¬ì˜¤ 30 INDICATOR ì‹œíŠ¸ ë‚´ìš© ===`);
              console.log(`ì‹œë‚˜ë¦¬ì˜¤ 30 indicators:`, scenarioData[30]?.indicators);
              if (scenarioData[30]?.indicators) {
                scenarioData[30].indicators.forEach((ind, index) => {
                  console.log(`${index + 1}. ${ind.Indicator_ID}: "${ind.Indicator_Name}" -> ${ind.Bloomberg_Ticker || ind.Ticker || 'í‹°ì»¤ì—†ìŒ'}`);
                });
              }
              
              // ë°ì´í„° ë¶ˆì¼ì¹˜ í™•ì¸
              const indicatorSheetIds = scenarioData[30]?.indicators?.map(ind => ind.Indicator_ID) || [];
              const linksSheetIds = scenarioData[30]?.links?.map(link => link.Indicator_ID) || [];
              
              console.log(`âš ï¸ === ë°ì´í„° ë¶ˆì¼ì¹˜ ë¶„ì„ ===`);
              console.log(`INDICATOR ì‹œíŠ¸ IDë“¤: [${indicatorSheetIds.join(', ')}]`);
              console.log(`LINKS ì‹œíŠ¸ IDë“¤: [${linksSheetIds.join(', ')}]`);
              console.log(`ë°ì´í„° ì¼ì¹˜ ì—¬ë¶€: ${JSON.stringify(indicatorSheetIds) === JSON.stringify(linksSheetIds) ? 'âœ… ì¼ì¹˜' : 'âŒ ë¶ˆì¼ì¹˜'}`);
              
              if (JSON.stringify(indicatorSheetIds) !== JSON.stringify(linksSheetIds)) {
                console.log(`ğŸ” ë¶ˆì¼ì¹˜ ìƒì„¸ ë¶„ì„:`);
                console.log(`- INDICATORì—ë§Œ ìˆëŠ” IDë“¤: [${indicatorSheetIds.filter(id => !linksSheetIds.includes(id)).join(', ')}]`);
                console.log(`- LINKSì—ë§Œ ìˆëŠ” IDë“¤: [${linksSheetIds.filter(id => !indicatorSheetIds.includes(id)).join(', ')}]`);
              }
              
              // ê° ë§í¬ë³„ ìƒì„¸ ë¶„ì„
              scenarioLinks.forEach((link, index) => {
                const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
                console.log(`${index + 1}. ë§í¬ ìƒì„¸:`);
                console.log(`   - Indicator_ID: ${link.Indicator_ID}`);
                console.log(`   - Weight: ${link.Weight || 'undefined'}`);
                console.log(`   - Correlation_Coeff: ${link.Correlation_Coeff || 'undefined'}`);
                console.log(`   - ë§¤í•‘ëœ Bloomberg Ticker: "${indicatorName}" ${indicatorName ? 'âœ…' : 'âŒ'}`);
                
                // ë§¤í•‘ ì‹¤íŒ¨í•œ ê²½ìš° ì¶”ê°€ ë””ë²„ê¹…
                if (!indicatorName) {
                  console.log(`   âŒ ë§¤í•‘ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„:`);
                  console.log(`   - indicatorIdToNameMapì— ${link.Indicator_ID} í‚¤ ì¡´ì¬: ${indicatorIdToNameMap.has(link.Indicator_ID)}`);
                  console.log(`   - í˜„ì¬ indicatorIdToNameMap í¬ê¸°: ${indicatorIdToNameMap.size}`);
                }
              });
              
              // IND140~IND145 í™•ì¸
              console.log(`ğŸ” === IND140~IND145 ì§€í‘œ ë§¤í•‘ í™•ì¸ ===`);
              for (let i = 140; i <= 145; i++) {
                const indicatorId = `IND${String(i).padStart(3, '0')}`;
                const ticker = indicatorIdToNameMap.get(indicatorId);
                console.log(`${indicatorId}: ${ticker ? `"${ticker}" âœ…` : 'âŒ ë§¤í•‘ ì—†ìŒ'}`);
              }
              
              // indicator íŒŒì¼ì—ì„œ IND140~IND145 ë²”ìœ„ í™•ì¸
              console.log(`ğŸ” === indicator íŒŒì¼ì—ì„œ IND140+ ì§€í‘œë“¤ í™•ì¸ ===`);
              const highNumberIndicators = [];
              for (const [id, ticker] of indicatorIdToNameMap.entries()) {
                if (id.startsWith('IND') && parseInt(id.substring(3)) >= 140) {
                  highNumberIndicators.push({id, ticker, num: parseInt(id.substring(3))});
                }
              }
              highNumberIndicators.sort((a, b) => a.num - b.num);
              console.log(`IND140 ì´ìƒ ì§€í‘œë“¤ (${highNumberIndicators.length}ê°œ):`, 
                highNumberIndicators.map(item => `${item.id}: "${item.ticker}"`));
              
              console.log(`ì´ ${scenarioLinks.length}ê°œì˜ ì§€í‘œì™€ ì—°ê²° ì‹œë„`);
              console.log(`ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ëœ ì§€í‘œ: ${scenarioIndicators.length}ê°œ`);
              
              if (scenarioIndicators.length === 0) {
                console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ 30ì—ì„œ ì—°ê²°ì„ ì´ ê·¸ë ¤ì§€ì§€ ì•ŠëŠ” ì´ìœ :`);
                console.log(`- ëª¨ë“  ì§€í‘œ IDê°€ indicatorIdToNameMapì— ë§¤í•‘ë˜ì§€ ì•ŠìŒ`);
                console.log(`- ë˜ëŠ” links ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ`);
              } else if (scenarioIndicators.length !== scenarioLinks.length) {
                console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ 30 ë¶€ë¶„ ë§¤í•‘ ë¬¸ì œ:`);
                console.log(`- ì „ì²´ ë§í¬: ${scenarioLinks.length}ê°œ`);
                console.log(`- ì„±ê³µ ë§¤í•‘: ${scenarioIndicators.length}ê°œ`);
                console.log(`- ì‹¤íŒ¨ ë§¤í•‘: ${scenarioLinks.length - scenarioIndicators.length}ê°œ`);
                
                // ì‹¤íŒ¨í•œ ì§€í‘œ IDë“¤ ì°¾ê¸°
                const failedIds = [];
                scenarioLinks.forEach(link => {
                  if (!indicatorIdToNameMap.get(link.Indicator_ID)) {
                    failedIds.push(link.Indicator_ID);
                  }
                });
                console.log(`- ì‹¤íŒ¨í•œ ì§€í‘œ IDë“¤: [${failedIds.join(', ')}]`);
              }
            }
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œ ìœ„ì¹˜ ì°¾ê¸° (ë…¸ë“œ ì—†ìœ¼ë©´ ì¢…ë£Œ, ì§€í‘œ ìœ ë¬´ì™€ ë¬´ê´€í•˜ê²Œ GPT ì—°ê²°ì„ ì€ ê·¸ë¦¼)
        const scenarioNodeData = nodes.find(n => n.n === scenarioNumber);
        if (!scenarioNodeData) {
          return;
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ì˜ ì™¼ìª½ ë©´ ê³„ì‚°(ì‹¤ì œ ë…¸ë“œì˜ ê³ ì • ì¢Œí‘œ ì‚¬ìš©)
        const scenarioX = (scenarioNodeData.fx ?? scenarioNodeData.x) - SCENARIO_HALF_WIDTH;
        const scenarioY = (scenarioNodeData.fy ?? scenarioNodeData.y);
        // ê³µí†µ ì¤‘ê°„ì (í‚¤ì›Œë“œ ì—°ê²°ìš©) ì„ ê³„ì‚°: ì§€í‘œ ì¡´ì¬ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ ì €ì¥
        const fallbackMidX = scenarioX + (indicatorStartX + 160 - scenarioX) * 0.6;
        graphState.midPointByScenarioNum.set(scenarioNumber, { x: fallbackMidX, y: scenarioY });
        try { console.log(`[KW] mid ì €ì¥: scen=${scenarioNumber}, mid=(${fallbackMidX},${scenarioY})`); } catch(_) {}
        
        // ê´€ë ¨ ì§€í‘œë“¤ì˜ ìœ„ì¹˜ ì°¾ê¸°
        const relatedIndicatorPositions = [];
        
        scenarioIndicators.forEach((indicatorData) => {
          // ì •í™•í•œ Indicator_IDë¡œ ë…¸ë“œ ì°¾ê¸° (ì¤‘ë³µ Bloomberg Ticker ë¬¸ì œ í•´ê²°)
          let indicatorNode = indicatorNodes.find(node => node.indicatorId === indicatorData.id);
          if (!indicatorNode) {
            // fallback: ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
            indicatorNode = indicatorNodes.find(node => node.name === indicatorData.name);
          }
          
          if (indicatorNode) {
            // ì‹œë‚˜ë¦¬ì˜¤ 30ì˜ ê²½ìš° ì§€í‘œ ë…¸ë“œ ì •ë³´ ìƒì„¸ ì¶œë ¥
            if (scenarioNumber === 30) {
              console.log(`ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ 30 ì§€í‘œ ë…¸ë“œ ì°¾ìŒ:`);
              console.log(`   - ì›ë˜ Indicator_ID: ${indicatorData.id}`);
              console.log(`   - Bloomberg Ticker: "${indicatorData.name}"`);
              console.log(`   - ì°¾ì€ ì§€í‘œID: ${indicatorNode.indicatorId}`);
              console.log(`   - ìœ„ì¹˜: (${indicatorNode.x}, ${indicatorNode.y})`);
              console.log(`   - ID ë§¤ì¹­ ì—¬ë¶€: ${indicatorData.id === indicatorNode.indicatorId ? 'âœ… ì •í™•' : 'âŒ ì¤‘ë³µ Tickerë¡œ ì¸í•œ ì˜¤ë§¤ì¹­'}`);
              console.log(`   - Weight: ${indicatorData.weight}, Correlation: ${indicatorData.correlation}`);
              console.log(`   - ì „ì²´ ë…¸ë“œ ì •ë³´:`, indicatorNode);
            }
            
            relatedIndicatorPositions.push({
              x: indicatorNode.x,
              y: indicatorNode.y,
              name: indicatorData.name,
              node: indicatorNode,
              originalId: indicatorData.id
            });
          } else {
            // ì§€í‘œ ë…¸ë“œë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° ë””ë²„ê¹…
            if (indicatorData && (indicatorData.id === 'IND111' || scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30)) {
              console.log(`âŒ ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: ì§€í‘œ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ${indicatorData.id} (${indicatorData.name})`);
              console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ ì§€í‘œ ë…¸ë“œë“¤ (ì²˜ìŒ 20ê°œ):`, indicatorNodes.map(n => `"${n.name}" (${n.indicatorId})`).slice(0, 20));
              
              // ì‹œë‚˜ë¦¬ì˜¤ 30ì¸ ê²½ìš° ì¶”ê°€ ë¶„ì„
              if (scenarioNumber === 30) {
                console.log(`ğŸ” ì‹œë‚˜ë¦¬ì˜¤ 30 ë…¸ë“œ ì°¾ê¸° ì‹¤íŒ¨ ìƒì„¸ ë¶„ì„:`);
                console.log(`   - ì°¾ê³ ì í•˜ëŠ” Indicator_ID: ${indicatorData.id}`);
                console.log(`   - ì°¾ê³ ì í•˜ëŠ” Bloomberg Ticker: "${indicatorData.name}"`);
                console.log(`   - ì „ì²´ ì§€í‘œ ë…¸ë“œ ìˆ˜: ${indicatorNodes.length}`);
                
                // ê°™ì€ IDë¥¼ ê°€ì§„ ë…¸ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                const sameIdNodes = indicatorNodes.filter(node => node.indicatorId === indicatorData.id);
                console.log(`   - ê°™ì€ ID (${indicatorData.id})ë¥¼ ê°€ì§„ ë…¸ë“œë“¤:`, sameIdNodes.map(n => `"${n.name}" (${n.indicatorId})`));
                
                // ë¹„ìŠ·í•œ ì´ë¦„ì˜ ë…¸ë“œ ì°¾ê¸°
                const similarNodes = indicatorNodes.filter(node => 
                  node.name.includes(indicatorData.name.split(' ')[0]) || 
                  indicatorData.name.includes(node.name.split(' ')[0])
                );
                console.log(`   - ìœ ì‚¬í•œ ì´ë¦„ì˜ ë…¸ë“œë“¤:`, similarNodes.map(n => `"${n.name}" (${n.indicatorId})`));
              }
            }
          }
        });
        
        // ===== 1ë‹¨ê³„: ì‹œë‚˜ë¦¬ì˜¤ â†’ ê³µí†µ ì¤‘ê°„ì  (í•˜ë‚˜ì˜ ì‹¤ì„ ) - í•­ìƒ ê·¸ë¦¬ê¸° =====
        // ì§€í‘œ ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ê³µí†µ ì¤‘ê°„ì ê¹Œì§€ëŠ” í•­ìƒ ì‹¤ì„  í‘œì‹œ
        const commonMidX = scenarioX + (indicatorStartX + 160 - scenarioX) * 0.6;
        const commonMidY = scenarioY;
        // ì¤‘ê°„ì  ì €ì¥ (í‚¤ì›Œë“œ ë°•ìŠ¤ ì—°ê²°ìš©)
        graphState.midPointByScenarioNum.set(scenarioNumber, { x: commonMidX, y: commonMidY });
        
        // Y ì¹´ìš´íŠ¸ ê³„ì‚° (ìƒ‰ìƒ ê²°ì •ìš©)
        const { yCount, total } = await computeScenarioYRate(scenarioNumber);
        console.log(`[C1ìƒ‰ìƒ] ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: total=${total}, yCount=${yCount}`);
        
        // ì„  ìƒ‰ìƒ ì •ì±…(ê°œì •): ì „ë¶€ G=íŒŒë‘, Y(1~2)=ë…¸ë‘, Y(3+)=ë¹¨ê°• (ë”¥ì˜¤ë Œì§€ ì œê±°)
        // ì—°ê²°ì„ ì€ ì‹œë‚˜ë¦¬ì˜¤â†’ì§€í‘œ êµ¬ê°„ ë‚´ë‚´ ë™ì¼ ìƒ‰ ìœ ì§€(3ìƒ‰ ê³ ì •)
        const baseColor = getScenarioLinkColorByCount(yCount);
        const mdHasYellowOrOrange = (yCount >= 1 && yCount < 3); // ë”¥ì˜¤ë Œì§€ ì œê±°, 1~2ê°œëŠ” ë…¸ë‘ ì·¨ê¸‰
        
        // ì‹œë‚˜ë¦¬ì˜¤ â†’ ê³µí†µ ì¤‘ê°„ì  ì‹¤ì„  (í•­ìƒ í‘œì‹œ)
        linkLayer.append("line")
          .attr("class", "connection-line")
          .attr("x1", scenarioX)
          .attr("y1", scenarioY)
          .attr("x2", commonMidX)
          .attr("y2", commonMidY)
          .attr("stroke", baseColor)
          .attr("stroke-width", 4)
          .attr("stroke-opacity", 0.85)
          .style("cursor", "pointer")
          .each(function(){ this.__meta = { kind: 'ind-scen-common', scenId: scenarioNodeData.id, scenNum: scenarioNumber }; })
          .on('click', ()=>{
            highlightConnection({ type: 'scenario-to-gpt', scenarioNumber });
          });

        // ê³µí†µ ì¤‘ê°„ì ì— ì›í˜• ë§ˆì»¤ (í•­ìƒ í‘œì‹œ, baseColorì™€ ì¼ì¹˜)
        linkLayer.append("circle")
          .attr("cx", commonMidX)
          .attr("cy", commonMidY)
          .attr("r", 6)
          .attr("fill", baseColor)
          .attr("stroke", "#fff")
          .attr("stroke-width", 2);

        // ===== 2ë‹¨ê³„: ê³µí†µ ì¤‘ê°„ì  â†’ ê° ì§€í‘œë¡œ ì ì„  ë¶„ê¸° (ì§€í‘œê°€ ìˆì„ ë•Œë§Œ) =====
        // âœ… ì „ì²´ ì§€í‘œì˜ í”Œë˜ê·¸ë¥¼ ë¨¼ì € ìˆ˜ì§‘í•˜ì—¬ Y ê°œìˆ˜ ê³„ì‚° (GPT ì„  ìƒ‰ìƒ ê²°ì •ì—ë„ ì‚¬ìš©)
        let indicatorYCount = 0;
        let indicatorTotal = 0;
        let indicatorHasRed = false;
        
        if (scenarioIndicators.length > 0 && relatedIndicatorPositions.length > 0) {
          // ì‹œë‚˜ë¦¬ì˜¤ 7, 13, 22, 30 ì—°ê²°ì„  ê·¸ë¦¬ê¸° ì‹œì‘ ë¡œê·¸
          if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
            console.log(`ğŸ¨ ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ì—°ê²°ì„  ê·¸ë¦¬ê¸° ì‹œì‘:`);
            console.log(`ì—°ê²°ë  ì§€í‘œ ìœ„ì¹˜ë“¤:`, relatedIndicatorPositions.map(p => 
              `${p.originalId || '?'} -> "${p.name}" (${p.x}, ${p.y})`
            ));
            console.log(`ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ìƒ‰ìƒ: ${color}`);
          }

          indicatorTotal = relatedIndicatorPositions.length;
          for (const pos of relatedIndicatorPositions) {
            try {
              const f = await fetchIndicatorFlag(pos.originalId || '');
              if (f === 'Y') indicatorYCount++;
            } catch (_) {
              // ì‹¤íŒ¨ ì‹œ Gë¡œ ê°„ì£¼
            }
          }

          // ì§€í‘œ ë¶„ê¸° ì„  ìƒ‰ìƒ: ì‹œë‚˜ë¦¬ì˜¤â†’ì§€í‘œ ë¼ì¸ì€ í•­ìƒ ê°™ì€ ìƒ‰(3ìƒ‰ ì¤‘ í•˜ë‚˜)ë¡œ ê³ ì •
          // baseColorì™€ ë™ì¼í•˜ê²Œ ì ìš© (íŒŒë‘/ë…¸ë‘/ë¹¨ê°•ë§Œ ì‚¬ìš©)
          const branchColor = baseColor;
          indicatorHasRed = (yCount >= 3); // Y 3ê°œ ì´ìƒì¼ ë•Œë§Œ RED

          console.log(`[ì§€í‘œìƒ‰ìƒ] ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: Y=${indicatorYCount}/${indicatorTotal}, ìƒ‰ìƒ=${branchColor}, hasRed=${indicatorHasRed}`);

          // 2ë‹¨ê³„: ê³µí†µ ì¤‘ê°„ì  â†’ ê° ì§€í‘œë¡œ ì ì„  ë¶„ê¸°
          for (const [i, pos] of relatedIndicatorPositions.entries()) {
            if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
              console.log(`  ğŸ“ ì§€í‘œ ${i + 1}: ${pos.originalId || '?'} -> "${pos.name}" ìœ„ì¹˜ (${pos.x}, ${pos.y})`);
            }

            const segLine = linkLayer.append("line")
              .attr("class", "connection-line")
              .attr("x1", commonMidX)
              .attr("y1", commonMidY)
              .attr("x2", pos.x)
              .attr("y2", pos.y)
              .attr("stroke", branchColor) // baseColor ê·¸ëŒ€ë¡œ
              .attr("stroke-width", branchColor === '#E53935' ? 4 : (branchColor === '#FFD54F' ? 3 : 2))
              .attr("stroke-opacity", 0.85)
              .attr("stroke-dasharray", "8,4")
              .style("cursor", "pointer")
              .each(function(){ this.__meta = { kind: 'ind-scen', indId: pos.originalId || null, scenId: scenarioNodeData.id, scenNum: scenarioNumber }; })
              .on('click', ()=>{
                const indId = pos.originalId || null;
                highlightConnection({ type: 'indicator-scenario', indicatorId: indId, scenarioId: scenarioNodeData.id });
              });
            // ë””ë²„ê·¸ ë¡œê·¸: ê° ì„¸ê·¸ë¨¼íŠ¸ì— ì„ íƒëœ ìƒ‰ìƒ ë¡œê·¸ ì¶œë ¥
            console.log(`[C1ìƒ‰ìƒ] ì„¸ê·¸ë¨¼íŠ¸ ${pos.originalId} ìƒ‰ìƒ=${branchColor}`);
            // "ì „ë¶€ Yì¼ ë•Œ ì—°ê²°ì„  ê¹œë°•ì„" ìœ ì§€ (yCount ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •)
            if (yCount === total && total > 0) {
              segLine.classed('blink-y-all', true);
            }

            linkLayer.append("circle")
              .attr("cx", pos.x)
              .attr("cy", pos.y)
              .attr("r", 3)
              .attr("fill", branchColor)
              .attr("stroke", "#fff")
              .attr("stroke-width", 1);
          }
          
          // ì‹œë‚˜ë¦¬ì˜¤ 7, 13, 22, 30 ì—°ê²°ì„  ê·¸ë¦¬ê¸° ì™„ë£Œ ë¡œê·¸
          if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
            console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ì—°ê²°ì„  ê·¸ë¦¬ê¸° ì™„ë£Œ: ${relatedIndicatorPositions.length}ê°œ ì§€í‘œì™€ ì—°ê²°ë¨`);
          }
        } else {
          // ì§€í‘œ ì—°ê²°ì´ ì—†ëŠ” ê²½ìš° (ê³µí†µ ì‹¤ì„ ì€ ì´ë¯¸ ê·¸ë ¤ì§)
          if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
            console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: ì§€í‘œ ë¶„ê¸°ì„  ì—†ìŒ (ê³µí†µ ì‹¤ì„ ë§Œ í‘œì‹œë¨, relatedIndicatorPositions.length = 0)`);
          }
        }

        // === í‚¤ì›Œë“œ ë°•ìŠ¤ â†’ ì‹œë‚˜ë¦¬ì˜¤-ë§ˆì¼“ë°ì´í„° ì‹¤ì„  ì¤‘ê°„ì  ì—°ê²°ì„  ===
        try {
          const mid = graphState.midPointByScenarioNum.get(scenarioNumber);
          const scenIdForLink = scenarioNodeData.id;
          // ë™ì¼ ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸(n) ì¼ì¹˜ í‚¤ì›Œë“œë§Œ ì„  ì—°ê²° (ë²ˆí˜¸ ê¸°ì¤€ ìš°ì„ )
          const scenNumForLink = scenarioNumber;
          const keywordNodesForScenario = nodes.filter(n => n.type === 'keyword' && n.scenarioNum === scenNumForLink);
          try { console.log(`[KW] scen=${scenarioNumber}(${scenIdForLink}) keyword ë…¸ë“œ ìˆ˜=`, keywordNodesForScenario.length, 'mid?', !!mid); } catch(_) {}
          if (DRAW_KEYWORD_LINKS && mid && keywordNodesForScenario.length) {
            // í‚¤ì›Œë“œ ì—°ê²°ì„ ì€ linkLayerì— ë Œë”ë§
            const kwLineGroup = linkLayer.append('g').attr('class','keyword-links');
            const kwTotal = keywordNodesForScenario.length;
            // ê°€ë¡œ ë°°ì¹˜: ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ì™¼ìª½ì—ì„œ ì‹œì‘í•´ ì—°ì† ë°°ì¹˜ (ì‹¤ì„  ì‹œì‘ì  ê¸°ì¤€ ì™¼ìª½)
            // ì„  ë„ì°© ì§€ì ì€ ì‹¤ì„ ì˜ 0%â†’40% êµ¬ê°„ì— ìˆœì„œëŒ€ë¡œ ë°°ì¹˜
            const lineRatioStart = 0.7, lineRatioEnd = 0.4;
            const ratioOnLine = (i)=> {
              if (kwTotal <= 1) return lineRatioStart;
              const t = i / (kwTotal - 1);
              return lineRatioStart + (lineRatioEnd - lineRatioStart) * t;
            };
            const leftMargin = 10;
            const segmentEndX   = scenarioX - leftMargin; // ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ì¢Œì¸¡ ê°€ì¥ìë¦¬ì—ì„œ ì¡°ê¸ˆ ì™¼ìª½
            // ë¨¼ì € í‚¤ì›Œë“œ ê°œìˆ˜ë§Œí¼ ê³ ì • í­ ë°•ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì¢Œì¸¡ì—ì„œë¶€í„° ì •í™•íˆ ë°€ì°© ë°°ì¹˜
            const fixedBoxW     = 160; // ê³ ì • í­
            const gapX          = 0;   // ì™„ì „ ë°€ì°©
            const totalWidth    = fixedBoxW * Math.max(1, kwTotal) + gapX * Math.max(0, kwTotal - 1);
            const segmentStartX = segmentEndX - totalWidth;
            const dynBoxW       = fixedBoxW;
            const anchorX = segmentEndX - dynBoxW / 2; // ì²« ë°•ìŠ¤ ì¤‘ì•™(ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ)
            const anchorY = mid.y;
            // ì „ì—­ ìƒë‹¨ í•œê³„ ë° ê¸°ë³¸ ê°„ê²© ì‚°ì •
            // ===== í•˜ë“œ ì½”ë”© ìŠ¤íƒ ë°°ì¹˜ ê·œì¹™ =====
            // - ê°€ì¥ ì•„ë˜(ì‹œë‚˜ë¦¬ì˜¤ì— ê°€ì¥ ê°€ê¹Œìš´) í‚¤ì›Œë“œëŠ”: minScenarioY - MARGIN - boxH
            // - ë‹¤ìŒ í‚¤ì›Œë“œëŠ” ìœ„ë¡œ STEPì”© ì´ë™: minScenarioY - MARGIN - boxH - STEP * idx
            const MARGIN = 24; // @ (ìš”ì²­í•œ ê¸°ì¤€ ê°„ê²©)
            const STEP = 120;   // ê³ ì • ìŠ¤í… ê°„ê²© (ìš”ì²­: 120)
            const baseBottomY = minScenarioY - MARGIN; // ì‹œë‚˜ë¦¬ì˜¤ ìµœìƒë‹¨ë³´ë‹¤ ì•½ê°„ ìœ„
            // ì‹œë‚˜ë¦¬ì˜¤ê°„ ì¶©ëŒ ì™„í™”(ì†Œí­ ì˜¤í”„ì…‹)
            const scenarioOrder = [...scenarioNodes].sort((a,b)=> (a.fy ?? a.y) - (b.fy ?? b.y));
            const orderIndex = scenarioOrder.findIndex(n => n.n === scenarioNumber);
            const scenarioStagger = Math.max(0, (orderIndex % 3)) * 6;
            
            keywordNodesForScenario.forEach((kn, idx) => {
              const phase = (kn.phase || '').toLowerCase();
              let strokeColor = '#9aa0a6';
              if (phase === 'yellow' || phase === 'y') strokeColor = '#FFD54F';
              if (phase === 'red' || phase === 'r') strokeColor = '#E53935';
              // í‚¤ì›Œë“œ ë°•ìŠ¤ ê³ ì • ìŠ¤í… ê¸°ë°˜ ìˆ˜ì§ ë°°ì¹˜
              const boxW = kn.kwidth ?? kn.width ?? 240;
              const baseH = 38;
              const heightOffset = ((idx % 5) - 2) * 4; // -8, -4, 0, +4, +8
              const boxH = Math.max(34, Math.min(50, baseH + heightOffset));
              // ì—°ì† ê°€ë¡œ ë°°ì¹˜: ìš°â†’ì¢Œë¡œ ë“±ê°„ê²©(ì‹œë‚˜ë¦¬ì˜¤ ì™¼ìª½ì— ë¶™ì—¬ ë‚˜ì—´)
              const anchorXForIdx = segmentEndX - dynBoxW / 2 - idx * (dynBoxW + gapX);
              const kx = anchorXForIdx - dynBoxW / 2;
              // í•˜ë“œì½”ë”©: ê°€ì¥ ë‚®ì€ í‚¤ì›Œë“œê°€ baseBottomY - boxH, ë‹¤ìŒì€ STEPì”© ìœ„ë¡œ
              const kyCandidate = (baseBottomY - boxH) - (STEP * idx) - scenarioStagger;
              const ky = kyCandidate;
              kn.kx = kx; kn.ky = ky; kn.kwidth = dynBoxW; kn.kheight = boxH; kn.width = dynBoxW; kn.height = boxH; kn.fx = kx; kn.fy = ky;
              // DOM ìœ„ì¹˜ ë° í¬ê¸° ì—…ë°ì´íŠ¸ (í•´ë‹¹ ë°ì´í„° ë°”ì¸ë”©ëœ ê·¸ë£¹ë§Œ)
              // ë‚´ë¶€ ë°°ì¹˜ë¡œ ë³€ê²½ë¨: ì™¸ë¶€ ì „ì—­ keywordGroup ì°¸ì¡° ì œê±°
              const kgSel = g.selectAll('.keyword-node').filter(d => d === kn);
              kgSel.attr('transform', `translate(${kx}, ${ky})`);
              kgSel.select('rect').attr('width', dynBoxW).attr('height', boxH);
              kgSel.select('text').attr('x', dynBoxW / 2).attr('y', boxH / 2);
              // ì§ì„  ì—°ê²°: ë°•ìŠ¤ ê°€ìš´ë° ì•„ë˜ìª½ â†’ ë„ì°©ì (anchor)
              const startX = anchorXForIdx;
              const startY = ky + boxH;
              kwLineGroup.append('line')
                .attr('class', 'connection-line')
                .attr('x1', startX)
                .attr('y1', startY)
                .attr('x2', scenarioX + (mid.x - scenarioX) * ratioOnLine(idx))
                .attr('y2', anchorY)
                .attr('stroke', strokeColor)
            .attr('stroke-width', 3)
                .attr('stroke-opacity', 0.95)
                .attr('stroke-linecap', 'round')
                .classed('kw-animated', true);
            });
          }
        } catch(_) {}

        // === ì‹œë‚˜ë¦¬ì˜¤ â†’ GPT1 ì—°ê²°ì„  (í´ë¦­ ê°€ëŠ¥) ===
        // ì‹œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ì˜¤ë¥¸ìª½ ë©´ì˜ ì¤‘ì•™ì„ ì‹œì‘ì ìœ¼ë¡œ ì„¤ì •
        const scenarioRightX = (scenarioNodeData.fx ?? scenarioNodeData.x) + SCENARIO_HALF_WIDTH;
        const scenarioRightY = (scenarioNodeData.fy ?? scenarioNodeData.y);

        // ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì„ ë“¤ì´ í•˜ë‚˜ì˜ ê³µí†µ ê¼­ì§€ì ìœ¼ë¡œ ëª¨ì´ë„ë¡ ê³ ì • ì¢Œí‘œ ì‚¬ìš©
        const commonHubX = gpt0AnchorX2 - 500; // gpt0 ì™¼ìª½ì—ì„œ ë” ì™¼ìª½ ê³µí†µì 
        const commonHubY = gptAnchorY;       // ìˆ˜í‰ ì •ë ¬
        // ë””ë²„ê¹…ìš©: í˜„ì¬ ê¼­ì§€ì  í”½ì…€ ìœ„ì¹˜
        try { console.debug('[COMMON-HUB]', { x: commonHubX, y: commonHubY }); } catch(_) {}

        // ì„ ë“¤ì´ ë¨¼ì € gpt0 í—ˆë¸Œë¡œ ëª¨ì´ë„ë¡ ì¤‘ê°„ ì ì„ gptHubX ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
        // gpt0ë“¤ì´ gpt1 ìœ„ì¹˜ì— ìˆìœ¼ë¯€ë¡œ ì¤‘ê°„ì ë„ í—ˆë¸Œì— ê°€ê¹ê²Œ ë‹¹ê¹€
        // ê¸¸ì´ë¥¼ ì ˆë°˜ìœ¼ë¡œ ì¤„ì—¬(ë³´ê°„ ë¹„ìœ¨ â†“), gpt0 í—ˆë¸Œ ìœ„ì¹˜ë§Œ ë”°ë¼ê°€ë„ë¡ í•¨
        const gptMidX = scenarioRightX + (commonHubX - scenarioRightX) * SCEN_GPT_PATH_RATIO;
        const gptMidY = scenarioRightY;

        // ì„  ìƒ‰ìƒ ì¡°ê±´
        // 1) ì§€í‘œìª½ ì„ ì´ redì¸ ê²½ìš° (ì „ì²´ ì§€í‘œê°€ Y)
        // 2) í‚¤ì›Œë“œ redê°€ 3ê°œ ì´ìƒì¼ ê²½ìš°
        // ìœ„ ë‘ ì¡°ê±´ ì¤‘ í•˜ë‚˜ë¼ë„ ë§Œì¡±í•˜ë©´ ë¹¨ê°•, ì•„ë‹ˆë©´ ë…¸ë‘ì´ ìˆìœ¼ë©´ ë…¸ë‘, ê·¸ ì™¸ íŒŒë‘
        const kwNodesAll = (nodes || []).filter(n => n && n.type === 'keyword' && n.scenarioNum === scenarioNumber);
        const kwRedCount = kwNodesAll.filter(kn => {
          const ph = String(kn.phase || '').toLowerCase();
          return ph === 'red' || ph === 'r';
        }).length;
        const kwHasYellow = kwNodesAll.some(kn => {
          const ph = String(kn.phase || '').toLowerCase();
          return ph === 'yellow' || ph === 'y';
        });

        // âœ… ì¶”ê°€: ë‰´ìŠ¤í‚¤ì›Œë“œ "ê²½ê³ " ê°œìˆ˜(ë…¸ë‘/ë¹¨ê°• í•©ê³„)
        const kwWarnCount = kwNodesAll.filter(kn => {
          const ph = String(kn.phase || '').toLowerCase();
          return ph === 'yellow' || ph === 'y' || ph === 'red' || ph === 'r';
        }).length;

        // GPT ê²½ë¡œ ìƒ‰ìƒ ê²°ì • (ê°œì •: ì§€í‘œì„ ê³¼ ë‰´ìŠ¤ ì¡°í•©)
        let toGptColor = '#2196F3'; // ê¸°ë³¸ íŒŒë‘
        const indicatorIsWarning = (yCount >= 1); // ì§€í‘œì„ ì´ yellow ë˜ëŠ” red
        const indicatorIsRed = (yCount >= 3);      // âœ… ì§€í‘œ RED ê¸°ì¤€(3ê°œ ì´ìƒ)
        
        // RED: ì§€í‘œì„ ì´ yellow/redì´ë©´ì„œ AND red ë‰´ìŠ¤ê°€ 3ê°œ ì´ìƒ
        if (indicatorIsWarning && kwRedCount >= 3) {
          toGptColor = '#E53935';
        } else if (indicatorIsRed || (kwWarnCount >= 3)) {
          // âœ… YELLOW: ì§€í‘œ ê²½ê³ ê°€ RED(3+)ì´ê±°ë‚˜, ë‰´ìŠ¤í‚¤ì›Œë“œ ê²½ê³ (ë…¸ë‘/ë¹¨ê°•) í•©ê³„ê°€ 3ê°œ ì´ìƒ
          toGptColor = '#FFD54F';
        }
        // else: íŒŒë‘ ìœ ì§€ (ì§€í‘œ ì •ìƒ + ë‰´ìŠ¤ ì—†ìŒ)
        
        console.log(`[GPTìƒ‰ìƒ] ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: yCount=${yCount}, indicatorIsRed=${indicatorIsRed}, kwRedCount=${kwRedCount}, kwWarnCount=${kwWarnCount}, toGptColor=${toGptColor}`);

        // í—ˆë¸Œê¹Œì§€ ë„ë‹¬í•˜ë˜, ë‚´ë¶€ì—ì„œëŠ” ì‹¤ì„ /ì ì„  ë¹„ìœ¨ë§Œ ì ìš© (ì´ ê¸¸ì´ëŠ” í—ˆë¸Œê¹Œì§€ 100%)
        const distX = (commonHubX - scenarioRightX);
        const solidFrac = Math.min(1, Math.max(0, SCEN_GPT_SOLID_FRAC_IN_TOTAL)); // 0~1
        const dashedFrac = Math.min(1, Math.max(0, 1 - solidFrac));
        const realEndX = scenarioRightX + distX * solidFrac;
        const realEndY = scenarioRightY; // ìˆ˜í‰ ìœ ì§€
        const gptPathData = [
          { x1: scenarioRightX, y1: scenarioRightY, x2: realEndX, y2: realEndY, w: 4, dash: null, a: 0.9 },
          { x1: realEndX, y1: realEndY, x2: commonHubX, y2: commonHubY, w: 3, dash: '6,4', a: 0.9 }
        ];

        gptPathData.forEach(seg => {
          const line = linkLayer.append('line')
            .attr('class', 'connection-line')
            .attr('x1', seg.x1)
            .attr('y1', seg.y1)
            .attr('x2', seg.x2)
            .attr('y2', seg.y2)
            .attr('stroke', toGptColor)
            .attr('stroke-width', (toGptColor==='#E53935'||toGptColor==='#FFD54F') ? seg.w*2 : seg.w)
            .attr('stroke-opacity', seg.a)
            .style('cursor', 'pointer');
          if (seg.dash) line.attr('stroke-dasharray', seg.dash);

          // ë©”íƒ€ ë°ì´í„° ì €ì¥ (ì‹œë‚˜ë¦¬ì˜¤â†’GPT ë¼ì¸)
          line.each(function(){ this.__meta = { kind: 'scen-gpt', scenNum: scenarioNumber }; });

          line.on('click', () => {
            onClickScenarioToGptLink(scenarioNumber);
            highlightConnection({ type: 'scenario-to-gpt', scenarioNumber });
          });
        });

        // GPT ì•µì»¤ ìª½ ëì  í‘œì‹œ
        linkLayer.append('circle')
          .attr('cx', commonHubX)
          .attr('cy', commonHubY)
          .attr('r', 5)
          .attr('fill', toGptColor)
          .attr('stroke', '#fff')
              .attr('stroke-width', 2)
          .style('cursor', 'pointer')
          .on('click', () => onClickScenarioToGptLink(scenarioNumber));
      }
      
      // ì—°ê²° í†µê³„ ë¶„ì„
      console.log('ğŸ”— === ì‹œë‚˜ë¦¬ì˜¤ë³„ ì—°ê²° í†µê³„ ë¶„ì„ ===');
      let totalConnections = 0;
      let connectedScenarios = 0;
      let disconnectedScenarios = [];
      
      for (let i = 1; i <= SCENARIO_COUNT; i++) {
        if (scenarioData[i]) {
          let sourceData = [];
          let sourceType = '';
          
          // INDICATOR ì‹œíŠ¸ê°€ ìˆê³  ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ìš°ì„  ì‚¬ìš©
          if (scenarioData[i].indicators && scenarioData[i].indicators.length > 0) {
            sourceData = scenarioData[i].indicators;
            sourceType = 'INDICATOR ì‹œíŠ¸';
          } else if (scenarioData[i].links) {
            sourceData = scenarioData[i].links;
            sourceType = 'LINKS ì‹œíŠ¸';
          }
          
          if (sourceData.length > 0) {
            const connectedIndicators = sourceData.map(item => {
              const indicatorId = item.Indicator_ID;
              const indicatorName = indicatorIdToNameMap.get(indicatorId);
              return indicatorName ? {
                id: indicatorId,
                name: indicatorName
              } : null;
            }).filter(Boolean);
            
            if (connectedIndicators.length > 0) {
              connectedScenarios++;
              totalConnections += connectedIndicators.length;
            } else {
              disconnectedScenarios.push(i);
            }
            
            console.log(`ì‹œë‚˜ë¦¬ì˜¤ ${i}: ${sourceData.length}ê°œ ì§€í‘œ (${sourceType}) â†’ ${connectedIndicators.length}ê°œ ì—°ê²°ë¨`);
          } else {
            disconnectedScenarios.push(i);
            console.log(`ì‹œë‚˜ë¦¬ì˜¤ ${i}: ì§€í‘œ ë°ì´í„° ì—†ìŒ`);
          }
        }
      }
      
      console.log(`ğŸ“Š ì—°ê²° í†µê³„:`);
      console.log(`- ì—°ê²°ëœ ì‹œë‚˜ë¦¬ì˜¤: ${connectedScenarios}/${SCENARIO_COUNT}ê°œ`);
      console.log(`- ì—°ê²° ì•ˆëœ ì‹œë‚˜ë¦¬ì˜¤: [${disconnectedScenarios.join(', ')}]`);
      console.log(`- ì´ ì—°ê²° ìˆ˜: ${totalConnections}ê°œ`);
      
      // ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•´ ì—°ê²°ì„  ê·¸ë¦¬ê¸° (ìµœëŒ€ 30ê°œ)
      (async () => {
        for (let i = 1; i <= SCENARIO_COUNT; i++) {
          await drawScenarioConnections(i);
        }
      })();

      // ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
      simulation.on("tick", () => {
        scenarioGroup.attr("transform", d => `translate(${d.x}, ${d.y})`);
        // í‚¤ì›Œë“œ ë…¸ë“œëŠ” ê³ ì • ì¢Œí‘œ ìœ ì§€
        g.selectAll('.keyword-node').attr('transform', function(d){ return `translate(${d.kx}, ${d.ky})`; });
      });

      // í‚¤ì›Œë“œ ì¢Œí‘œ ì ˆëŒ€ ê³ ì • ìœ í‹¸ë¦¬í‹°
      function lockKeywordPositions(){
        const sel = g.selectAll('.keyword-node');
        sel.each(function(d){ if (!d) return; d.fx = d.kx; d.fy = d.ky; });
        sel.attr('transform', d => `translate(${d.kx}, ${d.ky})`);
      }
      // ì‹œë®¬ë ˆì´ì…˜ ì¢…ë£Œ ì‹œì™€ ì´ˆê¸°ì— í•œ ë²ˆ ë” ê³ ì •
      simulation.on('end', lockKeywordPositions);
      try { setTimeout(lockKeywordPositions, 0); setTimeout(lockKeywordPositions, 600); } catch(_) {}

      // ====== ì—°ê²° í•˜ì´ë¼ì´íŠ¸ ìœ í‹¸ ======
      function highlightConnection(payload){
        // ëª¨ë‘ ë””ë°
        g.selectAll('.indicator-group, .scenario-group, .connection-line').classed('dimmed', true).classed('highlighted', false);
        // ê¸°ì¡´ ì„ì‹œ ë¼ë²¨ ì œê±°
        g.selectAll('.highlight-temp-label').remove();

        if (payload.type === 'indicator-scenario' && payload.indicatorId && payload.scenarioId){
          // ì •í™• ë§¤ì¹­ë˜ëŠ” ìš”ì†Œë§Œ ê°•ì¡°
          g.selectAll('.indicator-group').filter(d=>d.indicatorId===payload.indicatorId).classed('dimmed', false).classed('highlighted', true);
          g.selectAll('.scenario-group').filter(d=>d.id===payload.scenarioId).classed('dimmed', false).classed('highlighted', true);
          g.selectAll('.connection-line').filter(function(){
            return this.__meta && this.__meta.kind==='ind-scen' && this.__meta.indId===payload.indicatorId && this.__meta.scenId===payload.scenarioId;
          }).classed('dimmed', false).classed('highlighted', true);
          // ì´ë¦„ ë¼ë²¨ (ëŒ€ìƒ ì§€í‘œë§Œ)
          const indNode = indicatorNodes.find(n=>n.indicatorId===payload.indicatorId);
          if (indNode){
            g.append('text')
              .attr('class','highlight-temp-label')
              .attr('x', indNode.x + 22)
              .attr('y', indNode.y + 4)
              .classed('highlight-label', true)
              .text(indNode.name);
          }
        }
        if (payload.type === 'scenario-to-gpt' && payload.scenarioNumber){
          // ìŠ¤ì½”í”„ ê°’ ê³„ì‚°
          const scenarioNode = scenarioNodes.find(s=>s.n===payload.scenarioNumber);
          const scenId = scenarioNode?.id;
          // 1) ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œ ê°•ì¡°
          g.selectAll('.scenario-group').filter(d=>d.n===payload.scenarioNumber).classed('dimmed', false).classed('highlighted', true);
          if (scenId) {
            // 2) ì‹œë‚˜ë¦¬ì˜¤â†’ê³µí†µì¤‘ê°„ ì‹¤ì„ (íŠ¸ë í¬) ê°•ì¡° (í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¡œ ì—„ê²© í•„í„°)
            g.selectAll('.connection-line').filter(function(){ return this.__meta && this.__meta.kind==='ind-scen-common' && this.__meta.scenId===scenId && this.__meta.scenNum===payload.scenarioNumber; })
              .classed('dimmed', false).classed('highlighted', true);
          // 3) ì‹œë‚˜ë¦¬ì˜¤â†’ì§€í‘œ ì ì„  ê°•ì¡° (í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¡œ ì—„ê²© í•„í„°)
            const scenarioLines = g.selectAll('.connection-line').filter(function(){ return this.__meta && this.__meta.kind==='ind-scen' && this.__meta.scenId===scenId && this.__meta.scenNum===payload.scenarioNumber; })
              .classed('dimmed', false).classed('highlighted', true);
            // 4) ì—°ê²°ëœ ì§€í‘œ ë…¸ë“œ ê°•ì¡° + ë¼ë²¨ í‘œì‹œ (ë¼ì¸ ë©”íƒ€ ê¸°ë°˜ - ì‹¤ì œ í™”ë©´ì— ê·¸ë ¤ì§„ ì—°ê²°ë§Œ)
            const connectedIndIdSet = new Set();
            scenarioLines.each(function(){ const m=this.__meta; if (m && m.indId) connectedIndIdSet.add(m.indId); });
            // ê°•ì¡° ë° ë¼ë²¨ ì¶”ê°€ (ì •í™•íˆ ë§¤ì¹­ë˜ëŠ” ì§€í‘œë§Œ)
            g.selectAll('.indicator-group').filter(d=>connectedIndIdSet.has(d.indicatorId)).each(function(d){
              d3.select(this).classed('dimmed', false).classed('highlighted', true);
              g.append('text')
                .attr('class','highlight-temp-label')
                .attr('x', d.x + 22)
                .attr('y', d.y + 4)
                .classed('highlight-label', true)
                .text(d.name);
            });
          }
          // 5) ì‹œë‚˜ë¦¬ì˜¤â†’GPT ì„  ê°•ì¡°
          g.selectAll('.connection-line').filter(function(){ return this.__meta && this.__meta.kind==='scen-gpt' && this.__meta.scenNum===payload.scenarioNumber; })
            .classed('dimmed', false).classed('highlighted', true);
        }

        // í•´ì œ í•¸ë“¤ëŸ¬ (íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ì—” ì ê¸ˆ ìœ ì§€)
        const clear = ()=>{
          if (graphState.pipelineRunning && graphState.lockedHighlight) return; // ì ê¸ˆ ìƒíƒœ ìœ ì§€
          g.selectAll('.indicator-group, .scenario-group, .connection-line').classed('dimmed', false).classed('highlighted', false);
          g.selectAll('.highlight-temp-label').remove();
          svg.on('dblclick', null);
          window.removeEventListener('keydown', escHandler);
          graphState.lockedHighlight = null;
        };
        const escHandler = (e)=>{ if (e.key==='Escape') clear(); };
        graphState.clearHighlight = clear;
        // ë”ë¸”í´ë¦­ìœ¼ë¡œ í•´ì œí•˜ë„ë¡ ë³€ê²½ (í™”ë©´ ì´ë™ ì‹œì—ëŠ” í•´ì œë˜ì§€ ì•ŠìŒ)
        setTimeout(()=>{ svg.on('dblclick', (ev)=>{ if (ev.target===svg.node()) clear(); }); window.addEventListener('keydown', escHandler); }, 0);
        // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ì—” ì ê¸ˆ ìœ ì§€
        if (graphState.pipelineRunning) {
          graphState.lockedHighlight = payload;
        }
      }

      // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ì™€ ì¤Œ ê¸°ëŠ¥
      let isDragging = false;
      let dragStart = { x: 0, y: 0 };
      let currentTransform = { x: 0, y: 0, scale: 1 };
      graphState.currentTransform = currentTransform;
      
      // ì´ˆê¸° ë·°ë¥¼ ì¤‘ì•™ìœ¼ë¡œ ì„¤ì •
      const initialX = (containerRect.width - width) / 2;
      const initialY = (containerRect.height - height) / 2;
      currentTransform.x = initialX;
      currentTransform.y = initialY;
      const applyTransform = () => {
        g.attr("transform", `translate(${currentTransform.x}, ${currentTransform.y}) scale(${currentTransform.scale})`);
      };
      graphState.applyTransform = applyTransform;
      applyTransform();

      svg.on("mousedown", function(event) {
        isDragging = true;
        dragStart = { 
          x: event.clientX - currentTransform.x, 
          y: event.clientY - currentTransform.y 
        };
        event.preventDefault();
      });

      svg.on("mousemove", function(event) {
        if (isDragging) {
          currentTransform.x = event.clientX - dragStart.x;
          currentTransform.y = event.clientY - dragStart.y;
          applyTransform();
        }
      });

      svg.on("mouseup", function() {
        isDragging = false;
      });

      svg.on("mouseleave", function() {
        isDragging = false;
      });
      
      // ë§ˆìš°ìŠ¤ íœ  ì¤Œ ê¸°ëŠ¥
      svg.on("wheel", function(event) {
        event.preventDefault();
        
        const rect = container.getBoundingClientRect();
        const mouseX = event.clientX - rect.left;
        const mouseY = event.clientY - rect.top;
        
        const delta = event.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.1, Math.min(3, currentTransform.scale * delta));
        
        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì¤Œ
        const scaleDiff = newScale - currentTransform.scale;
        currentTransform.x -= (mouseX - currentTransform.x) * scaleDiff / currentTransform.scale;
        currentTransform.y -= (mouseY - currentTransform.y) * scaleDiff / currentTransform.scale;
        currentTransform.scale = newScale;
        
        applyTransform();
      });
    }

    // ì§€í‘œ ìœ„í—˜ë„ ìƒ‰ìƒ
    function getIndicatorColor(ind) {
      const curr = ind.Current_Value || 0;
      const high = ind.Threshold_High || 100;
      const low = ind.Threshold_Low || 0;
      if (curr > high) return '#e74c3c'; // ë¹¨ê°•
      if (curr > high * 0.95) return '#f1c40f'; // ë…¸ë‘ (95% ì´ìƒ)
      return '#3498db'; // íŒŒë‘
    }

    // ====== ì—°ê²°ì„  ìƒ‰ìƒ ë³´ì • (C1 í”Œë˜ê·¸ ê¸°ë°˜) ======
    // í—ˆìš© ID íŒ¨í„´: 'IND' + ì„¸ ìë¦¬ ìˆ«ì (ì˜ˆ: IND001 ~ IND999)
    const IND_ID_RE = /^IND\d{3}$/;
    // ì œì™¸ ëŒ€ìƒ: IND101~IND105 ì œê±°
    const IND_EXCLUDE = new Set(['IND101','IND102','IND103','IND104','IND105']);
    const normalizeIndicatorId = (id) => String(id || '').trim().toUpperCase();
    const isAllowedIndicatorId = (id) => {
      const cleaned = normalizeIndicatorId(id);
      return IND_ID_RE.test(cleaned) && !IND_EXCLUDE.has(cleaned);
    };
    // ìºì‹œ: Indicator_ID -> 'Y' | 'G' | null
    const indicatorFlagCache = new Map();
    const USE_REMOTE_IND_FLAG = true; // ë³€ë™ì„± í”Œë˜ê·¸ ì›ê²© ì¡°íšŒ í™œì„±í™”(ìƒ‰ìƒ ë°˜ì˜). 404ëŠ” ë‚´ë¶€ í´ë°± ì²˜ë¦¬

    async function fetchIndicatorFlag(indicatorId) {
      const cleaned = normalizeIndicatorId(indicatorId);
      if (!isAllowedIndicatorId(cleaned)) return 'G';
      // ìºì‹œì— ìˆë”ë¼ë„ Gì¸ ê²½ìš° í•œ ë²ˆì€ ê°•ì œ ê°±ì‹  ì‹œë„ (ê³¼ê±° ì˜ëª» íŒì •ëœ ê°’ êµì •)
      const cached = indicatorFlagCache.get(cleaned);
      if (cached && cached !== 'G') return cached;
      if (!USE_REMOTE_IND_FLAG) {
        // ì›ê²© ì¡°íšŒ ë¹„í™œì„±í™”: ê¸°ë³¸ 'G' ë°˜í™˜
        indicatorFlagCache.set(cleaned, 'G');
        return 'G';
      }
      try {
        const path = `go_scen/data/set/${cleaned}.xlsx?t=${Date.now()}`;
        const resp = await fetch(path, { cache: 'no-store' });
        if (!resp.ok) throw new Error('not ok');
        const ab = await resp.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets['Sheet1'] || wb.Sheets[wb.SheetNames[0]];
        const cell = ws ? ws['C1'] : null;
        const raw = (cell && (cell.v ?? cell.w ?? '')) + '';
        const flag = String(raw).trim().toUpperCase().includes('Y') ? 'Y' : 'G';
        indicatorFlagCache.set(cleaned, flag);
        return flag;
      } catch (_) {
        indicatorFlagCache.set(cleaned, 'G');
        return 'G';
      }
    }

    async function computeScenarioYRate(scenarioNumber) {
      const data = scenarioData[scenarioNumber] || {};
      let ids = [];
      if (Array.isArray(data.indicators) && data.indicators.length > 0) {
        ids = data.indicators.map(ind => normalizeIndicatorId(ind.Indicator_ID)).filter(isAllowedIndicatorId);
      } else if (Array.isArray(data.links)) {
        ids = data.links.map(l => normalizeIndicatorId(l.Indicator_ID)).filter(isAllowedIndicatorId);
      }
      if (ids.length === 0) return { yCount: 0, total: 0 };
      const flags = await Promise.all(ids.map(id => fetchIndicatorFlag(id)));
      const yCount = flags.filter(f => f === 'Y').length;
      return { yCount, total: ids.length };
    }

    function mixColorHex(hexA, hexB, t) {
      const a = {
        r: parseInt(hexA.slice(1, 3), 16),
        g: parseInt(hexA.slice(3, 5), 16),
        b: parseInt(hexA.slice(5, 7), 16)
      };
      const b = {
        r: parseInt(hexB.slice(1, 3), 16),
        g: parseInt(hexB.slice(3, 5), 16),
        b: parseInt(hexB.slice(5, 7), 16)
      };
      const clamp = (x) => Math.min(255, Math.max(0, Math.round(x)));
      const r = clamp(a.r + (b.r - a.r) * t);
      const g = clamp(a.g + (b.g - a.g) * t);
      const bb = clamp(a.b + (b.b - a.b) * t);
      const toHex = (n) => n.toString(16).padStart(2, '0');
      return `#${toHex(r)}${toHex(g)}${toHex(bb)}`;
    }

    function getLinkColorFromRate(rate) {
      const lightGreen = '#9BE7A8'; // ì—°í•œ ê·¸ë¦°
      const deepOrange = '#FF6A00'; // ì§„í•œ ì˜¤ë Œì§€
      const t = Math.max(0, Math.min(1, rate || 0));
      return mixColorHex(lightGreen, deepOrange, t);
    }

    // ê°œìˆ˜ ê¸°ë°˜ ì—°ê²°ì„  ìƒ‰ìƒ ì •ì±… (3ìƒ‰ë§Œ ì‚¬ìš©)
    function getScenarioLinkColorByCount(yCount) {
      if (yCount >= 3) return '#E53935'; // RED (ê²½ê³ )
      if (yCount >= 1) return '#FFD54F'; // YELLOW (ì£¼ì˜)
      return '#2196F3';                  // BLUE (ì •ìƒ)
    }

    function openScenarioPDF(n, scenarioId) {
      // 01~09ê¹Œì§€ëŠ” ë‘ ìë¦¬ íŒ¨ë”©, 10 ì´ìƒì€ ê·¸ëŒ€ë¡œ
      const folderName = String(n).padStart(2, '0');
      const pdfPath = `go_scen/scen/${folderName}/scenario_${folderName}.pdf`;
      const pdfTitle = `ì‹œë‚˜ë¦¬ì˜¤ ${n}: ${scenarioId || 'ìƒì„¸ ë³´ê³ ì„œ'}`;
      
      // ëª¨ë‹¬ ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
      const modal = document.getElementById('pdf-modal');
      const titleElement = document.getElementById('pdf-title');
      const frameElement = document.getElementById('pdf-frame');
      
      // ì œëª© ì„¤ì •
      titleElement.textContent = pdfTitle;
      
      // PDF ë¡œë“œ
      frameElement.src = pdfPath;
      
      // ëª¨ë‹¬ í‘œì‹œ
      modal.classList.add('show');
      
      // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener('keydown', handleEscKey);
      
      // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          closePdfModal();
        }
      });
    }

    function openNewsModal(title, url) {
      try {
        // ğŸ”¥ ëª¨ë°”ì¼ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                      || window.innerWidth <= 900;
        
        // ğŸ”¥ ëª¨ë°”ì¼ì—ì„œëŠ” ì§ì ‘ ë‰´ìŠ¤ URLë¡œ ì´ë™ (íŒì—… ì°¨ë‹¨ ë°©ì§€)
        if (isMobile) {
          window.open(url, '_blank', 'noopener,noreferrer');
          return;
        }
        
        // ğŸ”¥ PCì—ì„œëŠ” iframe ëª¨ë‹¬ ë°©ì‹ ì‚¬ìš©
        // ìƒˆ íƒ­ì—ì„œ ë‰´ìŠ¤ ì—´ê¸° - ë°ì€ ë°°ê²½ê³¼ 80% ê¸€ê¼´ í¬ê¸° ì ìš©
        const newsWindow = window.open('', '_blank', 'noopener,noreferrer');
        if (newsWindow) {
          newsWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${title || 'ê´€ë ¨ ê¸°ì‚¬'}</title>
              <style>
                body {
                  margin: 0;
                  padding: 20px;
                  background-color: #ffffff;
                  color: #1a1a1a;
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                  font-size: 0.8em; /* 80% ê¸€ê¼´ í¬ê¸° */
                  line-height: 1.6;
                }
                iframe {
                  width: 100%;
                  height: calc(100vh - 40px);
                  border: none;
                  background-color: #ffffff;
                }
                h1 {
                  font-size: 1.5em;
                  margin-bottom: 20px;
                  color: #1a1a1a;
                  padding-bottom: 10px;
                  border-bottom: 2px solid #e0e0e0;
                }
              </style>
            </head>
            <body>
              <h1>${title || 'ê´€ë ¨ ê¸°ì‚¬'}</h1>
              <iframe src="${url || ''}" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
            </body>
            </html>
          `);
          newsWindow.document.close();
        } else {
          // window.openì´ ì°¨ë‹¨ëœ ê²½ìš° ì§ì ‘ ë§í¬ë¡œ ì´ë™
          throw new Error('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } catch(e) { 
        console.error('openNewsModal ì‹¤íŒ¨:', e);
        // ğŸ”¥ ì‹¤íŒ¨ ì‹œ ì§ì ‘ ë‰´ìŠ¤ URLë¡œ ì´ë™ (fallback)
        try { 
          window.open(url, '_blank', 'noopener,noreferrer'); 
        } catch(__) {
          // ìµœì¢… fallback: í˜„ì¬ íƒ­ì—ì„œ ì´ë™
          window.location.href = url;
        }
      }
    }

    function closeNewsModal() {
      try {
        const modal = document.getElementById('news-modal');
        const frameElement = document.getElementById('news-frame');
        frameElement.src = '';
        modal.classList.remove('show');
      } catch(_) {}
    }

    // ì™¸ë¶€ ì œì–´: ì‹œë‚˜ë¦¬ì˜¤ í•˜ì´ë¼ì´íŠ¸ ë° ì„¼í„°ë§/ì¤Œ
    function highlightScenario(n) {
      try {
        const sel = d3.selectAll(`.scenario-group`).select('rect');
        sel.attr('stroke', '#e67e22').attr('stroke-width', 2);
        d3.select(`.scenario-group[data-scen='${n}']`).select('rect').attr('stroke', '#e74c3c').attr('stroke-width', 4);
      } catch (e) { console.warn('highlightScenario ì‹¤íŒ¨', e); }
    }

    function centerOnScenario(n, scale = 1.3) {
      const pos = graphState.posByScenarioNum.get(Number(n));
      if (!pos || !graphState.g) return;
      const rect = graphState.containerRect || document.getElementById('network-graph').getBoundingClientRect();
      const ct = graphState.currentTransform;
      ct.scale = Math.max(0.1, Math.min(3, scale));
      ct.x = rect.width / 2 - ct.scale * pos.x;
      ct.y = rect.height / 2 - ct.scale * pos.y;
      graphState.applyTransform && graphState.applyTransform();
    }

    function zoomDelta(delta) {
      const ct = graphState.currentTransform;
      const rect = graphState.containerRect || document.getElementById('network-graph').getBoundingClientRect();
      // í™”ë©´ ì¤‘ì•™ ê¸°ì¤€ ì¤Œ
      const mouseX = rect.width / 2;
      const mouseY = rect.height / 2;
      const newScale = Math.max(0.1, Math.min(3, ct.scale * (delta > 0 ? 1.1 : 0.9)));
      const scaleDiff = newScale - ct.scale;
      ct.x -= (mouseX - ct.x) * scaleDiff / ct.scale;
      ct.y -= (mouseY - ct.y) * scaleDiff / ct.scale;
      ct.scale = newScale;
      graphState.applyTransform && graphState.applyTransform();
    }
    
    function closePdfModal() {
      const modal = document.getElementById('pdf-modal');
      const frameElement = document.getElementById('pdf-frame');
      
      // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      modal.classList.remove('show');
      
      // PDF í”„ë ˆì„ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì ˆì•½)
      frameElement.src = '';
      
      // ESC í‚¤ ì´ë²¤íŠ¸ ì œê±°
      document.removeEventListener('keydown', handleEscKey);
    }
    
    function handleEscKey(event) {
      if (event.key === 'Escape') {
        closePdfModal();
        closeChartModal();
      }
    }

    // ====== ë§ˆì¼“ë°ì´í„° í†µê³„/ë³€ë™ì„± ê³„ì‚° ìœ í‹¸ë¦¬í‹° ======
    
    // ë³€ë™ì„± ê³„ì‚° (ë¡¤ë§ ìœˆë„ìš°)
    function calculateRollingVolatility(data, window = 20) {
      const volatility = [];
      for (let i = window - 1; i < data.length; i++) {
        const slice = data.slice(i - window + 1, i + 1);
        const returns = [];
        for (let j = 1; j < slice.length; j++) {
          const ret = (slice[j].value - slice[j-1].value) / slice[j-1].value;
          if (!isNaN(ret) && isFinite(ret)) returns.push(ret);
        }
        if (returns.length > 0) {
          const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
          const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
          volatility.push({
            date: slice[slice.length - 1].date,
            vol: Math.sqrt(variance) * Math.sqrt(252) * 100 // ì—°ìœ¨í™” ë° %ë¡œ ë³€í™˜
          });
        } else {
          volatility.push({ date: slice[slice.length - 1].date, vol: 0 });
        }
      }
      return volatility;
    }

    // ê¸°ë³¸ í†µê³„ ê³„ì‚°
    function calculateStatistics(data) {
      const values = data.map(d => parseFloat(d.value)).filter(v => !isNaN(v));
      if (values.length === 0) return null;
      
      const sorted = [...values].sort((a, b) => a - b);
      const min = sorted[0];
      const max = sorted[sorted.length - 1];
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      const current = values[values.length - 1];
      const prev = values[values.length - 2] || current;
      const change = current - prev;
      const changePercent = (change / prev) * 100;
      
      // ìµœê·¼ 3ê°œì›” (ì•½ 63 ê±°ë˜ì¼) ìµœê³ /ìµœì €
      const recent3M = values.slice(-63);
      const recent3MHigh = Math.max(...recent3M);
      const recent3MLow = Math.min(...recent3M);
      
      // 52ì£¼ ìœ„ì¹˜ ê³„ì‚° (ì•½ 252 ê±°ë˜ì¼)
      const recent52w = values.slice(-252);
      if (recent52w.length > 0) {
        const high52w = Math.max(...recent52w);
        const low52w = Math.min(...recent52w);
        const pos52w = ((current - low52w) / (high52w - low52w)) * 100;
        
        return {
          current, min, max, mean, change, changePercent,
          recent3MHigh, recent3MLow,
          high52w, low52w, pos52w: isNaN(pos52w) ? 50 : pos52w
        };
      }
      
      return {
        current, min, max, mean, change, changePercent,
        recent3MHigh, recent3MLow,
        high52w: max, low52w: min, pos52w: 50
      };
    }

    // ì„ê³„ì¹˜ ìƒì„± (í‰ê·  ê¸°ë°˜ ë˜ëŠ” ê³ ì •ê°’)
    function generateThresholds(stats, indicatorId) {
      // íŠ¹ì • ì§€í‘œë³„ ê³ ì • ì„ê³„ì¹˜
      const customThresholds = {
        // USD/KRW í™˜ìœ¨ (IND071)
        'IND071': { 
          yellow: 1400,  // ì£¼ì˜
          orange: 1600,  // ê²½ê³ 
          red: 1800      // ì‹¬ê°
        },
        // í•„ìš”ì‹œ ì¶”ê°€ ì§€í‘œ ì„¤ì • ê°€ëŠ¥
        // 'IND001': { yellow: 3.0, orange: 3.5, red: 4.0 }
        'IND077': { yellow: 16, orange: 22, red: 30 },
        'IND037': { yellow: 150, orange: 200, red: 250 },
      };
      
      // ê³ ì • ì„ê³„ì¹˜ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (customThresholds[indicatorId]) {
        console.log(`ğŸ¯ ${indicatorId}: ê³ ì • ì„ê³„ì¹˜ ì‚¬ìš©`, customThresholds[indicatorId]);
        return customThresholds[indicatorId];
      }
      
      // ê¸°ë³¸ ì„ê³„ì¹˜ (í‰ê·  ê¸°ì¤€)
      const thresholds = {
        yellow: stats.mean + stats.mean * 0.1,  // í‰ê·  + 10%
        orange: stats.mean + stats.mean * 0.2,  // í‰ê·  + 20%
        red: stats.mean + stats.mean * 0.3,     // í‰ê·  + 30%
      };
      
      console.log(`ğŸ¯ ${indicatorId}: ìë™ ì„ê³„ì¹˜ ì‚¬ìš©`, thresholds);
      return thresholds;
    }

    // ë¦¬ìŠ¤í¬ ë ˆë²¨ íŒë‹¨
    function assessRiskLevel(current, thresholds, stats, volStats) {
      let level = 'ì •ìƒ';
      let color = '#27ae60';
      let comment = '';
      
      // ë ˆë²¨ íŒë‹¨
      if (current >= thresholds.red) {
        level = 'ì‹¬ê°';
        color = '#e74c3c';
        comment = 'ì„ê³„ì¹˜ë¥¼ í¬ê²Œ ì´ˆê³¼í•˜ì—¬ ì¦‰ê°ì ì¸ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      } else if (current >= thresholds.orange) {
        level = 'ê²½ê³ ';
        color = '#e67e22';
        comment = 'ì£¼ì˜ êµ¬ê°„ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤. ë©´ë°€í•œ ê´€ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      } else if (current >= thresholds.yellow) {
        level = 'ì£¼ì˜';
        color = '#f39c12';
        comment = 'í‰ê·  ìˆ˜ì¤€ì„ ìƒíšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤.';
      } else {
        comment = 'ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.';
      }
      
      // ë³€ë™ì„± ë¶„ì„
      if (volStats) {
        const currentVol = volStats.current;
        const avgVol = volStats.mean;
        
        if (currentVol > avgVol * 1.5) {
          comment += ' ìµœê·¼ ë³€ë™ì„±ì´ í¬ê²Œ í™•ëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.';
          if (level === 'ì •ìƒ') {
            level = 'ì£¼ì˜';
            color = '#f39c12';
          }
        } else if (currentVol < avgVol * 0.5) {
          comment += ' ë³€ë™ì„±ì´ ë‚®ì€ ì•ˆì •ì ì¸ ìƒíƒœì…ë‹ˆë‹¤.';
        }
      }
      
      return { level, color, comment };
    }

    // í†µí•© ë§ˆì¼“ë°ì´í„° ëŒ€ì‹œë³´ë“œ
    async function openTimeseriesChart(indicatorId, indicatorDisplayName) {
      try {
        console.log(`ğŸš€ ë§ˆì¼“ë°ì´í„° ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹œì‘: ${indicatorId} - ${indicatorDisplayName}`);
        
        // ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
        const excelPath = `go_scen/data/set/${indicatorId}.xlsx`;
        console.log(`ğŸ“ íŒŒì¼ ê²½ë¡œ: ${excelPath}`);
        
        // ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        const response = await fetch(excelPath);
        if (!response.ok) {
          throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${excelPath}`);
        }
        console.log(`âœ… íŒŒì¼ ë¡œë“œ ì„±ê³µ`);
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type: 'array'});
        console.log(`ğŸ“Š ì›Œí¬ë¶ ì‹œíŠ¸ ëª©ë¡:`, workbook.SheetNames);
        
        // Sheet1 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const worksheet = workbook.Sheets['Sheet1'] || workbook.Sheets[workbook.SheetNames[0]];
        if (!worksheet) {
          throw new Error('ì›Œí¬ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // A4ë¶€í„° ë°ì´í„° ì½ê¸°
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
          range: 'A4:B10000',
          header: ['date', 'value'],
          raw: false
        });
        console.log(`ğŸ“ ì›ë³¸ ë°ì´í„° í–‰ ìˆ˜: ${jsonData.length}`);
        
        // ë¹ˆ ë°ì´í„° ì œê±° ë° ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§
        const validData = jsonData.filter(row => 
          row.date && row.value !== null && row.value !== undefined && row.value !== ''
        ).map(row => ({
          date: row.date,
          value: parseFloat(row.value)
        })).filter(row => !isNaN(row.value));
        
        if (validData.length === 0) {
          throw new Error('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        console.log(`âœ… ìœ íš¨ ë°ì´í„°: ${validData.length}ê°œ ë ˆì½”ë“œ`);
        console.log(`ğŸ“… ì²« ë°ì´í„°:`, validData[0]);
        console.log(`ğŸ“… ë§ˆì§€ë§‰ ë°ì´í„°:`, validData[validData.length - 1]);
        
        // í†µê³„ ê³„ì‚°
        console.log(`ğŸ§® í†µê³„ ê³„ì‚° ì‹œì‘...`);
        const stats = calculateStatistics(validData);
        if (!stats) {
          throw new Error('í†µê³„ ê³„ì‚° ì‹¤íŒ¨');
        }
        console.log(`âœ… í†µê³„ ê³„ì‚° ì™„ë£Œ:`, stats);
        
        const thresholds = generateThresholds(stats, indicatorId);
        console.log(`ğŸ¯ ì„ê³„ì¹˜ ìƒì„± ì™„ë£Œ:`, thresholds);
        
        // ë³€ë™ì„± ê³„ì‚° (20ì¼, 60ì¼)
        console.log(`ğŸ“ˆ ë³€ë™ì„± ê³„ì‚° ì‹œì‘...`);
        const vol20 = calculateRollingVolatility(validData, 20);
        const vol60 = calculateRollingVolatility(validData, 60);
        console.log(`âœ… ë³€ë™ì„± ê³„ì‚° ì™„ë£Œ: 20ì¼=${vol20.length}ê°œ, 60ì¼=${vol60.length}ê°œ`);
        
        // ë³€ë™ì„± í†µê³„
        const volValues = vol20.map(v => v.vol);
        const volStats = volValues.length > 0 ? {
          current: volValues[volValues.length - 1] || 0,
          mean: volValues.reduce((a, b) => a + b, 0) / volValues.length,
          max: Math.max(...volValues),
          min: Math.min(...volValues)
        } : null;
        console.log(`ğŸ“Š ë³€ë™ì„± í†µê³„:`, volStats);
        
        // ë¦¬ìŠ¤í¬ í‰ê°€
        console.log(`âš ï¸ ë¦¬ìŠ¤í¬ í‰ê°€ ì‹œì‘...`);
        const risk = assessRiskLevel(stats.current, thresholds, stats, volStats);
        console.log(`âœ… ë¦¬ìŠ¤í¬ í‰ê°€ ì™„ë£Œ:`, risk);
        
        // ëª¨ë‹¬ ì—´ê¸°
        const modal = document.getElementById('chart-modal');
        if (!modal) {
          throw new Error('ì°¨íŠ¸ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const titleElement = document.getElementById('chart-title');
        if (titleElement) {
          titleElement.textContent = `${indicatorDisplayName} (${indicatorId}) ë§ˆì¼“ë°ì´í„° ë¶„ì„`;
        }
        
        console.log(`ğŸ–¼ï¸ ëª¨ë‹¬ ì—´ê¸°...`);
        modal.classList.add('show');
        
        // ëŒ€ì‹œë³´ë“œ ë Œë”ë§ (ëª¨ë‹¬ì´ í‘œì‹œëœ í›„)
        console.log(`ğŸ¨ ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì‹œì‘...`);
        setTimeout(() => {
          try {
            renderMarketDataDashboard({
              indicatorId,
              indicatorDisplayName,
              data: validData,
              stats,
              thresholds,
              vol20,
              vol60,
              volStats,
              risk
            });
            console.log(`âœ… ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ì™„ë£Œ!`);
          } catch (renderError) {
            console.error('âŒ ë Œë”ë§ ì˜¤ë¥˜:', renderError);
            alert(`ë Œë”ë§ ì˜¤ë¥˜: ${renderError.message}`);
          }
        }, 100);
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', handleEscKeyChart);
        
        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeChartModal();
          }
        });
        
      } catch (error) {
        console.error('âŒ ë§ˆì¼“ë°ì´í„° ëŒ€ì‹œë³´ë“œ ë¡œë”© ì˜¤ë¥˜:', error);
        console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
        alert(`ëŒ€ì‹œë³´ë“œë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
      }
    }

    // ====== í†µí•© ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ======
    let timeseriesChartInstance = null;
    let volatilityChartInstance = null;

    function renderMarketDataDashboard(dashboardData) {
      console.log('ğŸ¨ renderMarketDataDashboard ì‹œì‘:', dashboardData);
      
      const {
        indicatorId,
        indicatorDisplayName,
        data,
        stats,
        thresholds,
        vol20,
        vol60,
        volStats,
        risk
      } = dashboardData;

      // í…Œë§ˆ í™•ì¸
      const isDarkMode = document.body.getAttribute('data-theme') === 'dark';
      const textColor = isDarkMode ? '#f5f5f5' : '#333333';
      const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
      const backgroundColor = isDarkMode ? '#181a20' : '#ffffff';

      try {
        // 1. ìƒë‹¨ ìš”ì•½ ì •ë³´ ë Œë”ë§
        console.log('1ï¸âƒ£ ìƒë‹¨ ìš”ì•½ ë Œë”ë§...');
        renderIndicatorSummary(indicatorDisplayName, stats, risk, volStats);
        console.log('âœ… ìƒë‹¨ ìš”ì•½ ì™„ë£Œ');
      } catch (err) {
        console.error('âŒ ìƒë‹¨ ìš”ì•½ ì˜¤ë¥˜:', err);
      }

      try {
        // 2. ì‹œê³„ì—´ ê·¸ë˜í”„ + ì„ê³„ì¹˜ ë Œë”ë§
        console.log('2ï¸âƒ£ ì‹œê³„ì—´ ê·¸ë˜í”„ ë Œë”ë§...');
        renderTimeseriesWithThresholds(data, indicatorDisplayName, thresholds, risk, textColor, gridColor, backgroundColor);
        console.log('âœ… ì‹œê³„ì—´ ê·¸ë˜í”„ ì™„ë£Œ');
      } catch (err) {
        console.error('âŒ ì‹œê³„ì—´ ê·¸ë˜í”„ ì˜¤ë¥˜:', err);
      }

      try {
        // 3. ë³€ë™ì„± ê·¸ë˜í”„ ë Œë”ë§
        console.log('3ï¸âƒ£ ë³€ë™ì„± ê·¸ë˜í”„ ë Œë”ë§...');
        renderVolatilityChart(vol20, vol60, textColor, gridColor, backgroundColor);
        console.log('âœ… ë³€ë™ì„± ê·¸ë˜í”„ ì™„ë£Œ');
      } catch (err) {
        console.error('âŒ ë³€ë™ì„± ê·¸ë˜í”„ ì˜¤ë¥˜:', err);
      }

      try {
        // 4. ë¦¬ìŠ¤í¬ ë¶„ì„ í…ìŠ¤íŠ¸ ë Œë”ë§
        console.log('4ï¸âƒ£ ë¦¬ìŠ¤í¬ ë¶„ì„ ë Œë”ë§...');
        renderRiskAnalysis(stats, thresholds, volStats, risk);
        console.log('âœ… ë¦¬ìŠ¤í¬ ë¶„ì„ ì™„ë£Œ');
      } catch (err) {
        console.error('âŒ ë¦¬ìŠ¤í¬ ë¶„ì„ ì˜¤ë¥˜:', err);
      }
      
      console.log('ğŸ‰ renderMarketDataDashboard ì „ì²´ ì™„ë£Œ!');
    }

    // 1. ì§€í‘œ ì •ë³´ ìš”ì•½ ë Œë”ë§
    function renderIndicatorSummary(name, stats, risk, volStats) {
      console.log('ğŸ“Š renderIndicatorSummary í˜¸ì¶œ:', { name, stats, risk, volStats });
      
      const nameEl = document.getElementById('indicator-name');
      const statsEl = document.getElementById('indicator-stats');
      
      if (!nameEl) {
        console.error('âŒ indicator-name ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      if (!statsEl) {
        console.error('âŒ indicator-stats ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      nameEl.textContent = name;
      nameEl.style.color = risk.color;

      const changeSign = stats.change >= 0 ? '+' : '';
      const changeColor = stats.change >= 0 ? '#27ae60' : '#e74c3c';

      statsEl.innerHTML = `
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">í˜„ì¬ ê°’</div>
          <div style="font-size: 20px; font-weight: bold; color: ${risk.color};">${stats.current.toFixed(4)}</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">ì „ì¼ ëŒ€ë¹„</div>
          <div style="font-size: 16px; font-weight: bold; color: ${changeColor};">
            ${changeSign}${stats.change.toFixed(4)} (${changeSign}${stats.changePercent.toFixed(2)}%)
          </div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">í‰ê· </div>
          <div style="font-size: 16px; font-weight: bold;">${stats.mean.toFixed(4)}</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">52ì£¼ ìœ„ì¹˜</div>
          <div style="font-size: 16px; font-weight: bold;">${stats.pos52w.toFixed(1)}%</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">ë¦¬ìŠ¤í¬ ë ˆë²¨</div>
          <div style="font-size: 16px; font-weight: bold; color: ${risk.color};">${risk.level}</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">í˜„ì¬ ë³€ë™ì„± (20ì¼)</div>
          <div style="font-size: 16px; font-weight: bold;">${volStats ? volStats.current.toFixed(2) + '%' : 'N/A'}</div>
        </div>
      `;
    }

    // 2. ì‹œê³„ì—´ ê·¸ë˜í”„ + ì„ê³„ì¹˜ ë Œë”ë§
    function renderTimeseriesWithThresholds(data, name, thresholds, risk, textColor, gridColor, backgroundColor) {
      console.log('ğŸ“ˆ renderTimeseriesWithThresholds ì‹œì‘:', { dataLength: data?.length, name, thresholds });
      
      const canvas = document.getElementById('timeseries-chart');
      if (!canvas) {
        console.error('âŒ ì‹œê³„ì—´ ì°¨íŠ¸ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const ctx = canvas.getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
      if (timeseriesChartInstance) {
        timeseriesChartInstance.destroy();
      }

      // ìµœê·¼ 6ê°œì›” ë°ì´í„°ë§Œ í‘œì‹œ (ì•½ 126 ê±°ë˜ì¼)
      const recentData = data.slice(-126);

      // ë‚ ì§œ ë ˆì´ë¸”
      const labels = recentData.map(d => {
        try {
          const date = new Date(d.date);
          if (isNaN(date.getTime())) return d.date;
          return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        } catch (e) {
          return d.date;
        }
      });

      const values = recentData.map(d => d.value);

      // ë°°ê²½ìƒ‰ í”ŒëŸ¬ê·¸ì¸
      const backgroundColorPlugin = {
        id: 'backgroundColorPlugin',
        beforeDraw: (chart) => {
          const ctx = chart.canvas.getContext('2d');
          ctx.save();
          ctx.globalCompositeOperation = 'destination-over';
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, chart.width, chart.height);
          ctx.restore();
        }
      };

      // ë°ì´í„°ì…‹ êµ¬ì„±
      const datasets = [
        {
          label: name,
          data: values,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 4,
          order: 1
        }
      ];

      // ì„ê³„ì¹˜ ì„  ì¶”ê°€
      const thresholdLines = [
        { value: thresholds.yellow, color: '#f39c12', label: 'ì£¼ì˜' },
        { value: thresholds.orange, color: '#e67e22', label: 'ê²½ê³ ' },
        { value: thresholds.red, color: '#e74c3c', label: 'ì‹¬ê°' }
      ];

      thresholdLines.forEach((threshold, idx) => {
        datasets.push({
          label: `ì„ê³„ì¹˜ (${threshold.label})`,
          data: new Array(labels.length).fill(threshold.value),
          borderColor: threshold.color,
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          pointRadius: 0,
          order: 2 + idx
        });
      });

      // ì°¨íŠ¸ ìƒì„±
      timeseriesChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        plugins: [backgroundColorPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            title: { display: false },
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: textColor,
                font: { size: 11 },
                usePointStyle: true,
                padding: 10
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#555',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'ë‚ ì§œ',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                maxTicksLimit: 8,
                font: { size: 10 }
              },
              grid: { color: gridColor }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ê°’',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                font: { size: 10 }
              },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    // 3. ë³€ë™ì„± ê·¸ë˜í”„ ë Œë”ë§
    function renderVolatilityChart(vol20, vol60, textColor, gridColor, backgroundColor) {
      console.log('ğŸ“ˆ renderVolatilityChart ì‹œì‘:', { vol20Length: vol20?.length, vol60Length: vol60?.length });
      
      const canvas = document.getElementById('volatility-chart');
      if (!canvas) {
        console.error('âŒ ë³€ë™ì„± ì°¨íŠ¸ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const ctx = canvas.getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ
      if (volatilityChartInstance) {
        volatilityChartInstance.destroy();
      }

      // ë°ì´í„° ê²€ì¦
      if (!vol20 || vol20.length === 0) {
        console.warn('âš ï¸ 20ì¼ ë³€ë™ì„± ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // ìµœê·¼ 6ê°œì›” ë°ì´í„°
      const recentVol20 = vol20.slice(-126);
      const recentVol60 = vol60 && vol60.length > 0 ? vol60.slice(-126) : [];

      const labels = recentVol20.map(v => {
        try {
          const date = new Date(v.date);
          if (isNaN(date.getTime())) return v.date;
          return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        } catch (e) {
          return v.date;
        }
      });

      const vol20Values = recentVol20.map(v => v.vol);
      const vol60Values = recentVol60.length > 0 ? recentVol60.map(v => v.vol) : [];
      
      console.log('ğŸ“Š ë³€ë™ì„± ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ:', { labelsCount: labels.length, vol20Count: vol20Values.length, vol60Count: vol60Values.length });

      // ë°°ê²½ìƒ‰ í”ŒëŸ¬ê·¸ì¸
      const backgroundColorPlugin = {
        id: 'backgroundColorPlugin2',
        beforeDraw: (chart) => {
          const ctx = chart.canvas.getContext('2d');
          ctx.save();
          ctx.globalCompositeOperation = 'destination-over';
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, chart.width, chart.height);
          ctx.restore();
        }
      };

      // ë°ì´í„°ì…‹ êµ¬ì„±
      const datasets = [
        {
          label: '20ì¼ ë³€ë™ì„±',
          data: vol20Values,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231, 76, 60, 0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4
        }
      ];

      // 60ì¼ ë³€ë™ì„± ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€
      if (vol60Values.length > 0) {
        datasets.push({
          label: '60ì¼ ë³€ë™ì„±',
          data: vol60Values,
          borderColor: '#9b59b6',
          backgroundColor: 'rgba(155, 89, 182, 0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4
        });
      }

      // ì°¨íŠ¸ ìƒì„±
      volatilityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets
        },
        plugins: [backgroundColorPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            title: { display: false },
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: textColor,
                font: { size: 11 },
                usePointStyle: true,
                padding: 10
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#555',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'ë‚ ì§œ',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                maxTicksLimit: 8,
                font: { size: 10 }
              },
              grid: { color: gridColor }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ì—°ìœ¨í™” ë³€ë™ì„± (%)',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                font: { size: 10 },
                callback: function(value) {
                  return value.toFixed(1) + '%';
                }
              },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    // 4. ë¦¬ìŠ¤í¬ ë¶„ì„ í…ìŠ¤íŠ¸ ë Œë”ë§
    function renderRiskAnalysis(stats, thresholds, volStats, risk) {
      console.log('ğŸ“ renderRiskAnalysis ì‹œì‘:', { stats, thresholds, volStats, risk });
      
      const contentEl = document.getElementById('risk-content');
      if (!contentEl) {
        console.error('âŒ risk-content ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const pos52wStatus = stats.pos52w > 80 ? 'ìƒë‹¨' : 
                          stats.pos52w > 60 ? 'ìƒë‹¨ ê·¼ì ‘' :
                          stats.pos52w > 40 ? 'ì¤‘ê°„' :
                          stats.pos52w > 20 ? 'í•˜ë‹¨ ê·¼ì ‘' : 'í•˜ë‹¨';

      const volComparison = volStats ? 
        (volStats.current > volStats.mean * 1.5 ? 'í¬ê²Œ í™•ëŒ€' :
         volStats.current > volStats.mean * 1.2 ? 'í™•ëŒ€' :
         volStats.current < volStats.mean * 0.8 ? 'ì¶•ì†Œ' : 'í‰ê·  ìˆ˜ì¤€') : 'N/A';

      const trendDirection = stats.change > 0 ? 'ìƒìŠ¹' : 
                             stats.change < 0 ? 'í•˜ë½' : 'ë³´í•©';

      contentEl.innerHTML = `
        <div style="margin-bottom: 15px;">
          <strong style="font-size: 15px; color: ${risk.color};">ğŸ¯ í˜„ì¬ ë¦¬ìŠ¤í¬ ë ˆë²¨: ${risk.level}</strong>
        </div>
        
        <div style="margin-bottom: 12px;">
          <strong>ğŸ“Š í˜„ì¬ ìˆ˜ì¤€ vs ì„ê³„ì¹˜</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>í˜„ì¬ ê°’: <strong>${stats.current.toFixed(4)}</strong></li>
            <li>ì£¼ì˜ ì„ê³„ì¹˜: ${thresholds.yellow.toFixed(4)} ${stats.current >= thresholds.yellow ? 'âœ… ë„ë‹¬' : ''}</li>
            <li>ê²½ê³  ì„ê³„ì¹˜: ${thresholds.orange.toFixed(4)} ${stats.current >= thresholds.orange ? 'âš ï¸ ë„ë‹¬' : ''}</li>
            <li>ì‹¬ê° ì„ê³„ì¹˜: ${thresholds.red.toFixed(4)} ${stats.current >= thresholds.red ? 'ğŸš¨ ë„ë‹¬' : ''}</li>
          </ul>
        </div>

        <div style="margin-bottom: 12px;">
          <strong>ğŸ“ˆ ë³€ë™ì„± ë¶„ì„</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>í˜„ì¬ 20ì¼ ë³€ë™ì„±: <strong>${volStats ? volStats.current.toFixed(2) + '%' : 'N/A'}</strong></li>
            <li>í‰ê·  ë³€ë™ì„±: ${volStats ? volStats.mean.toFixed(2) + '%' : 'N/A'}</li>
            <li>ë³€ë™ì„± ìƒíƒœ: <strong>${volComparison}</strong></li>
            ${volStats && volStats.current > volStats.mean * 1.5 ? '<li style="color: #e74c3c;">âš ï¸ ë³€ë™ì„± ê¸‰ë“± - ì£¼ì˜ í•„ìš”</li>' : ''}
          </ul>
        </div>

        <div style="margin-bottom: 12px;">
          <strong>ğŸ“ ì‹œì¥ í¬ì§€ì…˜</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>52ì£¼ ë‚´ ìœ„ì¹˜: <strong>${stats.pos52w.toFixed(1)}%</strong> (${pos52wStatus})</li>
            <li>52ì£¼ ìµœê³ : ${stats.high52w.toFixed(4)}</li>
            <li>52ì£¼ ìµœì €: ${stats.low52w.toFixed(4)}</li>
            <li>ìµœê·¼ ì¶”ì„¸: <strong>${trendDirection}</strong></li>
          </ul>
        </div>

        <div style="padding: 12px; background: ${risk.color}22; border-left: 4px solid ${risk.color}; border-radius: 4px;">
          <strong>ğŸ’¡ ì¢…í•© ì˜ê²¬</strong><br>
          ${risk.comment}
          ${stats.pos52w > 80 && volStats && volStats.current > volStats.mean * 1.3 ? 
            '<br>52ì£¼ ìƒë‹¨ ê·¼ì ‘ + ë³€ë™ì„± í™•ëŒ€ â†’ ì¡°ì • ê°€ëŠ¥ì„±ì— ëŒ€ë¹„í•˜ì„¸ìš”.' : ''}
          ${stats.pos52w < 20 && volStats && volStats.current > volStats.mean * 1.3 ? 
            '<br>52ì£¼ í•˜ë‹¨ ê·¼ì ‘ + ë³€ë™ì„± í™•ëŒ€ â†’ ë°˜ë“± ë˜ëŠ” ì¶”ê°€ í•˜ë½ ê°€ëŠ¥ì„± ëª¨ë‘ ì—´ë ¤ìˆìŠµë‹ˆë‹¤.' : ''}
        </div>
      `;
    }

    function closeChartModal() {
      const modal = document.getElementById('chart-modal');
      
      // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      modal.classList.remove('show');
      
      // ì°¨íŠ¸ ì‚­ì œ (ë©”ëª¨ë¦¬ ì ˆì•½)
      if (timeseriesChartInstance) {
        timeseriesChartInstance.destroy();
        timeseriesChartInstance = null;
      }
      if (volatilityChartInstance) {
        volatilityChartInstance.destroy();
        volatilityChartInstance = null;
      }
      
      // ESC í‚¤ ì´ë²¤íŠ¸ ì œê±°
      document.removeEventListener('keydown', handleEscKeyChart);
    }
    
    function handleEscKeyChart(event) {
      if (event.key === 'Escape') {
        closeChartModal();
      }
    }

    // ====== GPT1 í†µí•© ê´€ë ¨ ìœ í‹¸ ======
    function buildGptMessageFromScenario(scenarioNumber) {
      const data = scenarioData[scenarioNumber];
      if (!data) return '';
      const overview = data.overview || {};
      const scenarioId = overview.Scenario_ID || `Scenario_${scenarioNumber}`;
      const scenarioName = overview.Scenario_Name || `ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}`;

      // indicators ìš°ì„ , ì—†ìœ¼ë©´ links ì‚¬ìš©
      let baseItems = [];
      let isFromIndicators = false;
      if (data.indicators && data.indicators.length > 0) {
        isFromIndicators = true;
        baseItems = data.indicators.map(ind => ({
          Indicator_ID: ind.Indicator_ID,
          Weight: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Weight,
          Correlation_Coeff: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Correlation_Coeff
        }));
      } else if (data.links && data.links.length > 0) {
        baseItems = data.links.map(l => ({
          Indicator_ID: l.Indicator_ID,
          Weight: l.Weight,
          Correlation_Coeff: l.Correlation_Coeff
        }));
      }

      const connected = baseItems
        .map(item => {
          const ticker = indicatorIdToNameMap.get(item.Indicator_ID);
          return ticker ? {
            id: item.Indicator_ID,
            ticker,
            weight: item.Weight,
            corr: item.Correlation_Coeff
          } : null;
        })
        .filter(Boolean);

      const header = `ì‹œë‚˜ë¦¬ì˜¤: ${scenarioName} (${scenarioId})`;
      const detail = overview.Description || overview.Summary || overview.Overview || '';
      const fromSheet = isFromIndicators ? 'INDICATOR ì‹œíŠ¸' : 'LINKS ì‹œíŠ¸';

      const list = connected.map(c => `- ${c.id} | ${c.ticker}` +
        (c.weight !== undefined ? ` | Weight: ${c.weight}` : '') +
        (c.corr !== undefined ? ` | Corr: ${c.corr}` : '')).join('\n');

      return [
        header,
        detail ? `ê°œìš”: ${detail}` : '',
        `ì—°ê²° ì¶œì²˜: ${fromSheet}`,
        'ì—°ê²°ëœ ì‹œì¥ë°ì´í„°:',
        list || '- ì—†ìŒ'
      ].filter(Boolean).join('\n');
    }

    function onClickScenarioToGptLink(scenarioNumber) {
      selectedScenarioForGPT = scenarioNumber;
      const data = scenarioData[scenarioNumber];
      const name = data?.overview?.Scenario_Name || `ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}`;
      document.getElementById('selected-scenario-name').textContent = name;

      // ì—°ê²°ëœ ì§€í‘œ êµ¬ì„± (ìƒˆë¡œìš´ ë§¤í•‘ ë°©ì‹ ìš°ì„ )
      let connected = [];
      
      if (scenarioToIndicatorsMap.has(scenarioNumber)) {
        // ìƒˆë¡œìš´ ë§¤í•‘ ë°©ì‹: indicator.xlsxì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì§€í‘œ ê°€ì ¸ì˜¤ê¸°
        const indicators = scenarioToIndicatorsMap.get(scenarioNumber);
        connected = indicators.map(item => ({
          id: item.indicatorName || item.indicatorId || '',
          name: item.indicatorName || '',
          ticker: item.bloombergTicker || '',
          weight: 'N/A', // indicator.xlsxì—ëŠ” weight ì •ë³´ê°€ ì—†ìŒ
          corr: 'N/A'    // indicator.xlsxì—ëŠ” correlation ì •ë³´ê°€ ì—†ìŒ
        }));
        console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}ì˜ ìƒˆë¡œìš´ ë§¤í•‘ì—ì„œ ${connected.length}ê°œ ì§€í‘œ ì°¾ìŒ`);
      } else {
        // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
      let baseItems = [];
      if (data?.indicators?.length) {
        baseItems = data.indicators.map(ind => ({
          Indicator_ID: ind.Indicator_ID,
          Weight: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Weight,
          Correlation_Coeff: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Correlation_Coeff
        }));
      } else if (data?.links?.length) {
        baseItems = data.links.map(l => ({
          Indicator_ID: l.Indicator_ID,
          Weight: l.Weight,
          Correlation_Coeff: l.Correlation_Coeff
        }));
      }

        connected = baseItems
        .map(item => {
          const ticker = indicatorIdToNameMap.get(item.Indicator_ID);
          return ticker ? {
            id: item.Indicator_ID,
            ticker,
            weight: item.Weight,
            corr: item.Correlation_Coeff
          } : null;
        })
        .filter(Boolean);
        console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ${scenarioNumber}ì˜ ìƒˆë¡œìš´ ë§¤í•‘ì´ ì—†ì–´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©: ${connected.length}ê°œ ì§€í‘œ`);
      }

      const listEl = document.getElementById('selected-indicators-list');
      listEl.innerHTML = '';
      if (connected.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'ì—°ê²°ëœ ì§€í‘œ ì—†ìŒ';
        listEl.appendChild(li);
      } else {
        connected.forEach(c => {
          const li = document.createElement('li');
          // ìƒˆë¡œìš´ ë§¤í•‘ ë°©ì‹ì— ë§ì¶˜ í‘œì‹œ
          if (scenarioToIndicatorsMap.has(scenarioNumber)) {
            // ìƒˆë¡œìš´ ë§¤í•‘: ì´ë¦„ê³¼ í‹°ì»¤ ìš°ì„  í‘œì‹œ
            const displayName = c.name || c.ticker || c.id;
            const tickerInfo = c.ticker ? ` | ${c.ticker}` : '';
            li.textContent = `${displayName}${tickerInfo} | ID: ${c.id}`;
          } else {
            // ê¸°ì¡´ ë°©ì‹: IDì™€ í‹°ì»¤ í‘œì‹œ
          li.textContent = `${c.id} | ${c.ticker}` +
            (c.weight !== undefined ? ` | W:${c.weight}` : '') +
            (c.corr !== undefined ? ` | Corr:${c.corr}` : '');
          }
          listEl.appendChild(li);
        });
      }

      document.getElementById('gpt1-message').value = buildGptMessageFromScenario(scenarioNumber);
      document.getElementById('send-status').textContent = 'ë¶„ì„ì¤€ë¹„ì™„ë£Œ.';

      // ì—ì´ì „íŠ¸ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ (ì•ˆë‚´ë¬¸ì€ ê³ ì • UI ìœ ì§€)
      try {
        initializeCardGuidance();
        document.getElementById('card-gpt1')?.classList.add('active');
        document.getElementById('card-gpt2')?.classList.add('active');
        document.getElementById('card-gpt3')?.classList.add('active');
        document.getElementById('card-gpt4')?.classList.add('active');
      } catch (e) { console.warn(e); }

      // GPT1 ë²„ë¸”ì„ ì‹œë‚˜ë¦¬ì˜¤â†’GPT1 ì—°ê²°ì„  í´ë¦­ ìœ„ì¹˜ ê·¼ì²˜ì— ì—´ì–´ì¤Œ
      // ë²„ë¸” í‘œì‹œ ì œê±°
    }

    function copyMessageToClipboard() {
      const ta = document.getElementById('gpt1-message');
      ta.select();
      ta.setSelectionRange(0, 99999);
      const ok = document.execCommand('copy');
      document.getElementById('send-status').textContent = ok ? 'í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ë¨' : 'ë³µì‚¬ ì‹¤íŒ¨';
    }

    function copyText(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.select?.();
      el.setSelectionRange?.(0, 999999);
      const ok = document.execCommand('copy');
      document.getElementById('send-status').textContent = ok ? `${id} ë³µì‚¬ë¨` : 'ë³µì‚¬ ì‹¤íŒ¨';
    }

    // GPT3 ì „ì²´ ì‹¤í–‰ (ì¹´ë“œ ìƒë‹¨ ë²„íŠ¼)
    async function runGpt3All(){
      console.log('ğŸš€ runGpt3All ì‹œì‘...');
      const status = document.getElementById('send-status');
      try{
        // API í‚¤ ì‚¬ì „ ê²€ì¦
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = 'âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = 'GPT3 ì „ì²´ ì‹¤í–‰ ì¤‘...';
        console.log('ğŸ“‹ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
        // GPT3 ì‹œì‘ ì‹œì ì—ë§Œ GPT3ë¡œ ì´ë™
        console.log('ğŸ”„ GPT3 ë‹¨ê³„ë¡œ ì´ë™...');
        gotoStep(PipelineStep.GPT3);
          
        // ì˜¤ë¥¸ìª½ íŒ¨ë„ì˜ GPT3 ì¹´ë“œë“¤ì—ë„ ì‹œê°ì  íš¨ê³¼ ì¶”ê°€
        console.log('ğŸ¨ ì‹œê°ì  íš¨ê³¼ ì¶”ê°€...');
        document.querySelectorAll('.gpt3-module-box').forEach(el => {
          el.classList.add('pipeline-executing');
        });
        
        console.log('ğŸ“š ì—­í•  ë¡œë”© ì¤‘...');
        const roles = await loadRiskAgentRoles();
        console.log('âœ… ì—­í•  ë¡œë”© ì™„ë£Œ:', Object.keys(roles));
        // ì‚¬ìš©ìê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ë®ì–´ì“°ê¸°
        const uiGpt1 = document.getElementById('gpt1-system')?.value?.trim();
        const uiGpt2 = document.getElementById('gpt2-system')?.value?.trim();
        if (uiGpt1) roles.gpt1 = uiGpt1;
        if (uiGpt2) roles.gpt2 = uiGpt2;
        // GPT1 ì¶œë ¥ ë³´ì¥ ê°€ë“œ ì ìš©
        console.log('ğŸ” GPT1 ì¶œë ¥ í™•ì¸ ì¤‘...');
        const gpt1Output = await ensureGpt1OutputReady();
        console.log('âœ… GPT1 ì¶œë ¥ ì¤€ë¹„ ì™„ë£Œ, ê¸¸ì´:', gpt1Output?.length || 0);
        
        // GPT2 ë„ë©”ì¸ë³„ ë¶„ì„ ìë£Œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        let gpt2DomainOutputs;
        const existingGpt2Output = document.getElementById('gpt2-output').value || '';
        if (!existingGpt2Output.includes('=== ê·¹í•œ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ì‚°ì¶œ) ===')) {
          status.textContent = 'ì›ì¥ë°ì´í„°ì…ìˆ˜ ë° ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ì¤‘...';
          gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
          
          // GPT2 ë„ë©”ì¸ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (GPT4ì—ì„œ ì°¸ì¡°ìš©)
          window.globalGpt2DomainOutputs = gpt2DomainOutputs;
          
          const gpt2Detail = `=== ê·¹í•œ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ì‚°ì¶œ) ===

[ì‹œì¥ë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.market || '(ìƒì„±ì‹¤íŒ¨)'}

[ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.credit || '(ìƒì„±ì‹¤íŒ¨)'}

[ALMíŒ€]
${gpt2DomainOutputs.alm || '(ìƒì„±ì‹¤íŒ¨)'}

[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.global || '(ìƒì„±ì‹¤íŒ¨)'}

[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€]
${gpt2DomainOutputs.creditpf || '(ìƒì„±ì‹¤íŒ¨)'}
`;
          
          document.getElementById('gpt2-output').value = gpt2Detail;
          autoGrow(['gpt2-output']);
          // ìŠ¤í¬ë¡¤ì„ GPT2 ì¹´ë“œë¡œ ì´ë™
          setTimeout(() => scrollToElement('card-gpt2'), 100);
        } else {
          // ê¸°ì¡´ GPT2 ë„ë©”ì¸ ì¶œë ¥ì´ ìˆë‹¤ë©´ ì¬ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ìƒˆë¡œ ìƒì„±í•´ì•¼ í•˜ì§€ë§Œ ë°ëª¨ìš©)
          status.textContent = 'GPT2 ë„ë©”ì¸ë³„ ë¶„ì„ ìë£Œ ì¬ìƒì„± ì¤‘...';
          gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
          // GPT2 ë„ë©”ì¸ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (GPT4ì—ì„œ ì°¸ì¡°ìš©)
          window.globalGpt2DomainOutputs = gpt2DomainOutputs;
        }
        
        status.textContent = 'GPT3 ë„ë©”ì¸ ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì¤‘.';
        // ğŸ”” GPT3 ì‹œì‘ ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜ (íš¨ê³¼ ì‹œì‘ íŠ¸ë¦¬ê±°)
        window.dispatchEvent(new CustomEvent('gpt3:start'));
        // ì¹´ë“œ/ë°•ìŠ¤ ì§„í–‰ ìƒíƒœ í‘œì‹œ
        const c3 = document.getElementById('card-gpt3');
        c3?.classList.add('running'); 
        c3?.classList.remove('done');
        document.querySelectorAll('.gpt3-module-box')
          .forEach(el => el.classList.add('pipeline-executing'));
        const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€ì´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
        console.log('ğŸš€ GPT3 API í˜¸ì¶œ ì¤€ë¹„...');
        console.log('GPT2 ë„ë©”ì¸ ì¶œë ¥ ê¸¸ì´:', {
          market: gpt2DomainOutputs.market?.length || 0,
          credit: gpt2DomainOutputs.credit?.length || 0,
          alm: gpt2DomainOutputs.alm?.length || 0,
          global: gpt2DomainOutputs.global?.length || 0,
          creditpf: gpt2DomainOutputs.creditpf?.length || 0
        });
        
        const g3Calls = [
          callOpenAIWithOptions(roles.gpt3_market, gpt2DomainOutputs.market + GL('market'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_credit, gpt2DomainOutputs.credit + GL('credit'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_alm, gpt2DomainOutputs.alm + GL('alm'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_global, gpt2DomainOutputs.global + GL('global'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_creditpf, gpt2DomainOutputs.creditpf + GL('creditpf'), { timeoutMs: 1200000 }),
        ];
        // â— ê±°ë¶€ ì¼€ì´ìŠ¤ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ë¡œ ë…¸ì¶œí•˜ì—¬ ë””ë²„ê¹… ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
        console.log('â³ GPT3 API í˜¸ì¶œ ëŒ€ê¸° ì¤‘...');
        const settled = await Promise.allSettled(g3Calls);
        console.log('âœ… GPT3 API í˜¸ì¶œ ì™„ë£Œ, ê²°ê³¼:', settled.map(r => r.status));
        
        const pick = (r) => r.status === 'fulfilled'
          ? (r.value || '')
          : (`ì˜¤ë¥˜: ${r.reason?.message || 'í”„ë¡ì‹œ í˜¸ì¶œ ì‹¤íŒ¨'}`);
        const [m,c,a,g,p] = settled.map(pick);
        
        console.log('ğŸ“Š GPT3 ê²°ê³¼ ê¸¸ì´:', {
          market: m?.length || 0,
          credit: c?.length || 0,
          alm: a?.length || 0,
          global: g?.length || 0,
          creditpf: p?.length || 0
        });
        
        // ğŸ”§ ì „ì—­ ë³‘í•© ì˜¤íƒ€ ìˆ˜ì • + DOM ì§ì ‘ ë°˜ì˜(í•­ìƒ ê°’ ê¸°ë¡)
        window.globalGpt3Outputs = {
          ...(window.globalGpt3Outputs || {}),
          market: (m || '').trim(),
          credit: (c || '').trim(),
          alm:    (a || '').trim(),
          global: (g || '').trim(),
          creditpf:(p || '').trim()
        };

        // DOMì— í•­ìƒ ê¸°ë¡(ë¹ˆ ë¬¸ìì—´ë„ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ì—¬ ì‹¤ì œ ìƒíƒœë¥¼ ëˆˆìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥)
        const writeG3 = (id, text, label) => {
          const el = document.getElementById(id);
          const v = (text || '').trim();
          // ë¹„ì–´ìˆìœ¼ë©´ "ê°€ì‹œì ì¸ ì•ˆë‚´ ë¬¸êµ¬"ë¥¼ ë„£ì–´ ì‚¬ìš©ìì—ê²Œ ìƒíƒœê°€ ë³´ì´ê²Œ í•œë‹¤.
          el.value = v || `âš ï¸ ${label} ê²°ê³¼ ì—†ìŒ(í”„ë¡ì‹œ ë¯¸ì‘ë‹µ/ë¹ˆ ì‘ë‹µ ê°€ëŠ¥).
- ìš°ì¸¡ ìƒë‹¨ ë”ë³´ê¸° > ì½˜ì†”ì—ì„œ testOpenAIProxy() ì‹¤í–‰ìœ¼ë¡œ í”„ë¡ì‹œ ìƒíƒœ ì ê²€
- ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ: localStorage.setItem('openai_api_key','sk-...') í›„ ìƒˆë¡œê³ ì¹¨`;
        };
        writeG3('gpt3-market',   m, 'ì‹œì¥ë¦¬ìŠ¤í¬');
        writeG3('gpt3-credit',   c, 'ì‹ ìš©ë¦¬ìŠ¤í¬');
        writeG3('gpt3-alm',      a, 'ALM');
        writeG3('gpt3-global',   g, 'ê¸€ë¡œë²Œë¦¬ìŠ¤í¬');
        writeG3('gpt3-creditpf', p, 'ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤');

        autoGrow(['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf']); 
        
        // GPT3 ëª¨ë“ˆë³„ ìˆœì°¨ ìŠ¤í¬ë¡¤ (ê° ëª¨ë“ˆ ì™„ë£Œ ì‹œ í•´ë‹¹ ëª¨ë“ˆë¡œ ìŠ¤í¬ë¡¤)
        setTimeout(() => {
          if (m) scrollToGpt3Module('market');
          setTimeout(() => { if (c) scrollToGpt3Module('credit'); }, 300);
          setTimeout(() => { if (a) scrollToGpt3Module('alm'); }, 600);
          setTimeout(() => { if (g) scrollToGpt3Module('global'); }, 900);
          setTimeout(() => { if (p) scrollToGpt3Module('creditpf'); }, 1200);
        }, 200);
        
        status.textContent = (m||c||a||g||p) ? 'GPT3 ì „ì²´ ì™„ë£Œ' : 'GPT3 ì‹¤íŒ¨(ì¶œë ¥ ì—†ìŒ)';
      } catch(e) { 
        status.textContent = `ì‹¤íŒ¨: ${e.message}`; 
      } finally {
        // âœ… ì–´ë–¤ ê²½ìš°ì—ë„ íš¨ê³¼ ì¢…ë£Œ + done ì´ë²¤íŠ¸ ë³´ì¥
        (function cleanupGpt3Effects(){
          const card = document.getElementById('card-gpt3');
          if (card) {
            card.classList.remove('progress-indicator','running');
            card.classList.add('done');
            const overlay = card.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          document.querySelectorAll('.gpt3-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
        })();
        window.dispatchEvent(new CustomEvent('gpt3:done'));
      }
    }

    // ====== GPT1 ì¶œë ¥ ë³´ì¥ ê°€ë“œ ======
    async function ensureGpt1OutputReady() {
      let gpt1Output = document.getElementById('gpt1-output').value?.trim() || '';
      
      // 1) gpt1-output ë¹„ì–´ ìˆìœ¼ë©´, ìš°ì„  GPT1ì„ ì‹¤í–‰í•´ ê°•ì œë¡œ ì±„ì›€
      if (!gpt1Output) {
        console.log('GPT1 ì¶œë ¥ì´ ë¹„ì–´ìˆì–´ GPT1ì„ ì‹¤í–‰í•©ë‹ˆë‹¤...');
        const gpt1Input = buildGpt1InputFromGpt0Outputs();
        const roles = await loadRiskAgentRoles();
        const gpt1Result = await callOpenAI(roles.gpt1, gpt1Input);
        document.getElementById('gpt1-output').value = gpt1Result || '';
        autoGrow(['gpt1-output']);
        // ìŠ¤í¬ë¡¤ì„ GPT1 ì¹´ë“œë¡œ ì´ë™
        setTimeout(() => scrollToElement('card-gpt1'), 100);
        gpt1Output = gpt1Result || '';
      }
      
      // 2) (ì¶”ê°€ ì•ˆì „ì¥ì¹˜) ê·¸ë˜ë„ ë¹„ì–´ ìˆìœ¼ë©´ ìˆ¨ì€ ìš”ì•½ì„ ìµœí›„ fallbackìœ¼ë¡œ ì‚¬ìš©
      if (!gpt1Output) {
        gpt1Output = document.getElementById('gpt1-generated-summary')?.value?.trim() || '';
        if (gpt1Output) {
          console.log('GPT1 ì¶œë ¥ì´ ì—¬ì „íˆ ë¹„ì–´ìˆì–´ gpt1-generated-summaryë¥¼ fallbackìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
          document.getElementById('gpt1-output').value = gpt1Output;
          autoGrow(['gpt1-output']);
          // ìŠ¤í¬ë¡¤ì„ GPT1 ì¹´ë“œë¡œ ì´ë™
          setTimeout(() => scrollToElement('card-gpt1'), 100);
        }
      }
      
      updateGpt2ButtonState(); // UI ìƒíƒœ ì—…ë°ì´íŠ¸
      return gpt1Output;
    }

    // ====== UI ìƒíƒœ ì—…ë°ì´íŠ¸ ======
    function updateGpt2ButtonState() {
      const gpt1Output = document.getElementById('gpt1-output').value?.trim();
      const gpt2Button = document.getElementById('gpt2-run-btn');
      
      if (gpt2Button) {
        if (!gpt1Output) {
          gpt2Button.disabled = true;
          gpt2Button.style.opacity = '0.5';
          gpt2Button.title = 'GPT1ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”';
        } else {
          gpt2Button.disabled = false;
          gpt2Button.style.opacity = '1';
          gpt2Button.title = 'GPT2 ì‹¤í–‰';
        }
      }
    }

    // ====== GPT2 ë„ë©”ì¸ë³„ ì¶œë ¥ ìƒì„± ======
    async function generateGpt2DomainOutputs(gpt1Output, roles) {
      try {
        // ë°©ì–´ ë¡œì§: gpt1Outputì´ ë¹„ì–´ìˆìœ¼ë©´ ëŒ€ì•ˆ ì°¾ê¸°
        if (!gpt1Output?.trim()) {
          console.log('generateGpt2DomainOutputs: gpt1Outputì´ ë¹„ì–´ìˆì–´ ëŒ€ì•ˆì„ ì°¾ìŠµë‹ˆë‹¤...');
          gpt1Output = document.getElementById('gpt1-output')?.value?.trim()
                    || document.getElementById('gpt1-generated-summary')?.value?.trim()
                    || '(ê²½ê³ : GPT1 ì¶œë ¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤)';
        }
        
        const basePrompt = `[GPT1 ì¢…í•© ì •ì œ ê²°ê³¼]
${gpt1Output}

[WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ìš”ì²­]
ë¨¼ì € ë‹¤ìŒ 4ê°œ ë¶„ì•¼ì˜ WORST ì‹œë‚˜ë¦¬ì˜¤ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ìƒì„±í•˜ë¼:
1) ê¸ˆë¦¬ WORST: ê¸‰ê²©í•œ ê¸ˆë¦¬ ìƒìŠ¹/í•˜ë½ ì‹œë‚˜ë¦¬ì˜¤ (êµ¬ì²´ì  ìˆ˜ì¹˜ í¬í•¨)
2) í™˜ìœ¨ WORST: ê·¹ë‹¨ì  í™˜ìœ¨ ë³€ë™ ì‹œë‚˜ë¦¬ì˜¤ (ì›/ë‹¬ëŸ¬, ì£¼ìš” í†µí™”)
3) ì‹ ìš©ìœ„í—˜ WORST: ëŒ€ê·œëª¨ ì‹ ìš©ê²½ìƒ‰ ë° ë¶€ë„ ê¸‰ì¦ ì‹œë‚˜ë¦¬ì˜¤
4) ì£¼ê°€ì§€ìˆ˜ WORST: ì£¼ì‹ì‹œì¥ í­ë½ ì‹œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤í”¼, ê¸€ë¡œë²Œ ì§€ìˆ˜)

[ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„±]
ìœ„ WORST ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í¬í•¨í•˜ì—¬ ë‹¤ìŒ ë„ë©”ì¸ì— íŠ¹í™”ëœ ë¶„ì„ ìë£Œë¥¼ ìƒì„±í•˜ë¼:`;

        // ê° ë„ë©”ì¸ë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
        const domainPrompts = {
          market: `${basePrompt}

[ì‹œì¥ë¦¬ìŠ¤í¬íŒ€ ì „ìš© ìë£Œ]
- ê¸ˆë¦¬/í™˜ìœ¨/ì£¼ê°€ WORST ì‹œë‚˜ë¦¬ì˜¤ì˜ ì‹œì¥ë¦¬ìŠ¤í¬ ê´€ì  ë¶„ì„
- VaR, ë¯¼ê°ë„, ë³€ë™ì„± ëª¨ë¸ë§ì„ ìœ„í•œ êµ¬ì²´ì  íŒŒë¼ë¯¸í„°
- ì‹œì¥ ì¶©ê²©ì´ í¬íŠ¸í´ë¦¬ì˜¤ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ì‹œë®¬ë ˆì´ì…˜ ìë£Œ
- í—¤ì§• ì „ëµ ë° ë¦¬ìŠ¤í¬ í•œë„ ê´€ë¦¬ ë°©ì•ˆ`,

          credit: `${basePrompt}

[ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€ ì „ìš© ìë£Œ]  
- ì‹ ìš©ìœ„í—˜ WORST ì‹œë‚˜ë¦¬ì˜¤ì˜ í¬íŠ¸í´ë¦¬ì˜¤ ì˜í–¥ ë¶„ì„
- ì„¹í„°ë³„/ë“±ê¸‰ë³„ ë¶€ë„í™•ë¥  ë° ì†ì‹¤ìœ¨ ì¶”ì • ìë£Œ
- ì‹ ìš©ìŠ¤í”„ë ˆë“œ í™•ëŒ€ ë° í”„ë¡œë¹„ì „ ì‚°ì • ê¸°ì¤€
- ì‹ ìš©ì§‘ì¤‘ë„ ë¦¬ìŠ¤í¬ ë° ëŒ€í˜•ì°¨ì£¼ ëª¨ë‹ˆí„°ë§ ì§€í‘œ`,

          alm: `${basePrompt}

[ALMíŒ€ ì „ìš© ìë£Œ]
- ê¸ˆë¦¬ WORST ì‹œë‚˜ë¦¬ì˜¤ì˜ ìì‚°ë¶€ì±„ ë“€ë ˆì´ì…˜ ë¶„ì„
- ìœ ë™ì„± ê°­ ë° ìê¸ˆì¡°ë‹¬ ë¹„ìš© ì˜í–¥ í‰ê°€ ìë£Œ  
- ê¸ˆë¦¬ë¯¼ê°ë„ ë° ìœ ë™ì„±ì»¤ë²„ë¦¬ì§€ ë³€í™” ì‹œë®¬ë ˆì´ì…˜
- ìì‚°ë°°ë¶„ ìµœì í™” ë° ALM ì „ëµ ì¡°ì • ë°©ì•ˆ`,

          global: `${basePrompt}

[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€ ì „ìš© ìë£Œ]
- í™˜ìœ¨ WORST ì‹œë‚˜ë¦¬ì˜¤ì˜ ê¸€ë¡œë²Œ í¬íŠ¸í´ë¦¬ì˜¤ ì˜í–¥
- êµ­ê°€ë³„/ì§€ì—­ë³„ ë¦¬ìŠ¤í¬ ì „íŒŒ ë©”ì»¤ë‹ˆì¦˜ ë¶„ì„
- ê¸€ë¡œë²Œ ê¸ˆìœµì‹œì¥ ì—°ì‡„ë°˜ì‘ ë° ì»¨í…Œì´ì ¼ ë¦¬ìŠ¤í¬
- í•´ì™¸ ìµìŠ¤í¬ì € í—¤ì§• ë° êµ­ê°€ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ`,

          creditpf: `${basePrompt}

[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€ ì „ìš© ìë£Œ]
- ì‹ ìš©ìœ„í—˜/ì£¼ê°€ WORST ì‹œë‚˜ë¦¬ì˜¤ì˜ í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ ë¶„ì„
- ì‚°ì—…ë³„/ì§€ì—­ë³„/ë§Œê¸°ë³„ ìµìŠ¤í¬ì € ë¶„ì‚° íš¨ê³¼ í‰ê°€
- í¬íŠ¸í´ë¦¬ì˜¤ ì¬êµ¬ì„± ë° ìµœì í™” ì‹œë®¬ë ˆì´ì…˜ ìë£Œ
- ëŒ€í˜•ì°¨ì£¼ ë° ì—°ê´€ê±°ë˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ`
        };

        // ê³ ì •ëœ GPT2 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
        const gpt2SystemPrompt = `ë‹¹ì‹ ì€ GPT1ì—ì„œ ì •ì œëœ í†µí•© ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê° GPT3 ëª¨ë“ˆë³„ ë§ì¶¤í˜• ë¶„ì„ ìë£Œë¥¼ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì—­í• :
- GPT1ì˜ í†µí•©ëœ ì‹œë‚˜ë¦¬ì˜¤ ë° ë§ˆì¼“ë°ì´í„°ë¥¼ ê° GPT3 ëª¨ë“ˆì˜ íŠ¹ì„±ì— ë§ê²Œ ë¶„ë°°
- ê° ë„ë©”ì¸ë³„ WORST ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì²´ì  ìƒì„± (ê¸ˆë¦¬, í™˜ìœ¨, ì‹ ìš©ìœ„í—˜, ì£¼ê°€ì§€ìˆ˜)
- GPT3 ëª¨ë“ˆë³„ ì „ë¬¸í™”ëœ ì…ë ¥ ë°ì´í„° êµ¬ì„±
- ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ê°€ì •ê³¼ ì‹œë‚˜ë¦¬ì˜¤ ì „ê°œ

ë„ë©”ì¸ë³„ ë¶„ì„ ìš”êµ¬ì‚¬í•­:

1. ì‹œì¥ë¦¬ìŠ¤í¬íŒ€ (GPT3_market)
   - ê¸ˆë¦¬ ë³€ë™ì„±, í™˜ìœ¨ ë³€ë™ì„±, ì£¼ê°€ ë³€ë™ì„± ê´€ë ¨ WORST ì‹œë‚˜ë¦¬ì˜¤
   - ì‹œì¥ ì¶©ê²©ì˜ ì „íŒŒ ê²½ë¡œì™€ ì˜í–¥ë„ ë¶„ì„
   - í—¤ì§€ ì „ëµ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ ì œì‹œ

2. ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€ (GPT3_credit)
   - ê¸°ì—… ì‹ ìš©ë„ í•˜ë½, ì±„ê¶Œ ìŠ¤í”„ë ˆë“œ í™•ëŒ€, ë¶€ë„ìœ¨ ìƒìŠ¹ WORST ì‹œë‚˜ë¦¬ì˜¤
   - ì‹ ìš© ìœ„í—˜ì˜ ì „íŒŒ ë©”ì»¤ë‹ˆì¦˜ê³¼ í¬íŠ¸í´ë¦¬ì˜¤ ì˜í–¥ë„
   - ì‹ ìš© ìœ„í—˜ ëª¨ë‹ˆí„°ë§ ë° ëŒ€ì‘ ë°©ì•ˆ

3. ALMíŒ€ (GPT3_alm)
   - ìì‚°ë¶€ì±„ ë§Œê¸° ë¶ˆì¼ì¹˜, ìœ ë™ì„± ìœ„í—˜, ì´ììœ¨ ë¦¬ìŠ¤í¬ WORST ì‹œë‚˜ë¦¬ì˜¤
   - ìê¸ˆ ì¡°ë‹¬ ë° ìš´ìš© ì „ëµì˜ ìœ„í—˜ ìš”ì†Œ
   - ALM ìœ„í—˜ ê´€ë¦¬ ë° ëŒ€ì‘ ë°©ì•ˆ

4. ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€ (GPT3_global)
   - êµ­ê°€ ë¦¬ìŠ¤í¬, ì •ì¹˜ì  ë¶ˆì•ˆì •ì„±, êµ­ì œ ê´€ê³„ ì•…í™” WORST ì‹œë‚˜ë¦¬ì˜¤
   - ê¸€ë¡œë²Œ ìœ„í—˜ì˜ êµ­ë‚´ ì „íŒŒ ê²½ë¡œì™€ ì˜í–¥ë„
   - ê¸€ë¡œë²Œ ë¦¬ìŠ¤í¬ ëŒ€ì‘ ë° í—¤ì§€ ì „ëµ

5. ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€ (GPT3_creditpf)
   - í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ ìœ„í—˜, ìƒê´€ê´€ê³„ ê¸‰ì¦, ë¶„ì‚° íš¨ê³¼ ìƒì‹¤ WORST ì‹œë‚˜ë¦¬ì˜¤
   - í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ì˜ ì§‘ì¤‘ê³¼ ì „íŒŒ
   - í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë° ìµœì í™” ë°©ì•ˆ

ì¶œë ¥ í˜•ì‹:
ê° ë„ë©”ì¸ë³„ë¡œ ë‹¤ìŒì„ í¬í•¨:
- WORST ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì²´ì  ìˆ˜ì¹˜ ë° ê°€ì •
- ì‹œë‚˜ë¦¬ì˜¤ ì „ê°œ ê²½ë¡œì™€ ì˜í–¥ë„ ë¶„ì„
- GPT3 ëª¨ë“ˆë³„ ë§ì¶¤í˜• ì…ë ¥ ë°ì´í„°
- ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ í•µì‹¬ ë³€ìˆ˜

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        // ê° ë„ë©”ì¸ë³„ ë³‘ë ¬ í˜¸ì¶œ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
        const domainCalls = [
          callOpenAI(gpt2SystemPrompt, domainPrompts.market).catch(e => {
            console.warn('âš ï¸ ì‹œì¥ë¦¬ìŠ¤í¬ ë„ë©”ì¸ 1ì°¨ ì‹¤íŒ¨, ì¬ì‹œë„...', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.market);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.credit).catch(e => {
            console.warn('âš ï¸ ì‹ ìš©ë¦¬ìŠ¤í¬ ë„ë©”ì¸ 1ì°¨ ì‹¤íŒ¨, ì¬ì‹œë„...', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.credit);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.alm).catch(e => {
            console.warn('âš ï¸ ALM ë„ë©”ì¸ 1ì°¨ ì‹¤íŒ¨, ì¬ì‹œë„...', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.alm);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.global).catch(e => {
            console.warn('âš ï¸ ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë„ë©”ì¸ 1ì°¨ ì‹¤íŒ¨, ì¬ì‹œë„...', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.global);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.creditpf).catch(e => {
            console.warn('âš ï¸ ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë„ë©”ì¸ 1ì°¨ ì‹¤íŒ¨, ì¬ì‹œë„...', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.creditpf);
          })
        ];

        const results = await Promise.allSettled(domainCalls);
        const [marketOutput, creditOutput, almOutput, globalOutput, creditpfOutput] = 
          results.map((r, index) => {
            if (r.status === 'fulfilled' && r.value) {
              return r.value;
            } else {
              const domainNames = ['ì‹œì¥ë¦¬ìŠ¤í¬', 'ì‹ ìš©ë¦¬ìŠ¤í¬', 'ALM', 'ê¸€ë¡œë²Œë¦¬ìŠ¤í¬', 'ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤'];
              const errorMsg = r.reason?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
              console.error(`âŒ GPT2 ${domainNames[index]} ë„ë©”ì¸ ìƒì„± ì‹¤íŒ¨:`, errorMsg);
              return `[${domainNames[index]}íŒ€] ë¶„ì„ ìë£Œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜ ë‚´ìš©: ${errorMsg}\n\nëŒ€ì•ˆ: GPT1 ì¶œë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ì„ ìˆ˜í–‰í•˜ê±°ë‚˜, ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
            }
          });

        return {
          market: marketOutput,
          credit: creditOutput,
          alm: almOutput,
          global: globalOutput,
          creditpf: creditpfOutput
        };

      } catch (error) {
        console.error('GPT2 ë„ë©”ì¸ë³„ ì¶œë ¥ ìƒì„± ì˜¤ë¥˜:', error);
        return {
          market: 'ì˜¤ë¥˜: ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ìë£Œ ìƒì„± ì‹¤íŒ¨',
          credit: 'ì˜¤ë¥˜: ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ìë£Œ ìƒì„± ì‹¤íŒ¨',
          alm: 'ì˜¤ë¥˜: ALM ë¶„ì„ ìë£Œ ìƒì„± ì‹¤íŒ¨',
          global: 'ì˜¤ë¥˜: ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ìë£Œ ìƒì„± ì‹¤íŒ¨',
          creditpf: 'ì˜¤ë¥˜: ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ìë£Œ ìƒì„± ì‹¤íŒ¨'
        };
      }
    }

    // ====== GPT0 ì¶œë ¥ì„ APIë¡œ ìš”ì•½í•˜ì—¬ GPT1ìš© A4 í•œ ì¥ ìƒì„± ======
    async function generateGpt1SummaryFromGpt0(roles) {
      try {
        console.log('ğŸ“‹ GPT0 â†’ GPT1 ìš”ì•½ ìƒì„± ì‹œì‘');
        
        // GPT0 ê° ëª¨ë“ˆ ì¶œë ¥ ìˆ˜ì§‘
        const gpt0MarketData = document.getElementById('gpt0-marketdata')?.value?.trim() || '';
        const gpt0News = document.getElementById('gpt0-news')?.value?.trim() || '';
        const gpt0ScenarioSummary = document.getElementById('gpt0-scenario-summary')?.value?.trim() || '';
        const gpt0MarketState = document.getElementById('gpt0-marketstate')?.value?.trim() || '';
        
        // ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë³¸ ì •ë³´
        const selectedScenario = selectedScenarioForGPT || scenarioList[0] || 1;
        const scenarioName = document.getElementById('selected-scenario-name')?.textContent?.trim() || `ì‹œë‚˜ë¦¬ì˜¤ ${selectedScenario}`;
        
        // GPT1ìš© A4 ìš”ì•½ ìƒì„± í”„ë¡¬í”„íŠ¸ (GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ìµœì í™”)
        const summaryPrompt = `ë‹¤ìŒ GPT0 ë¶„ì„ ê²°ê³¼ë“¤ì„ GPT1ì´ GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•´ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ A4 í•œ ì¥ ë¶„ëŸ‰(ì•½ 800-1000ì)ìœ¼ë¡œ ìš”ì•½í•˜ë¼:

=== ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ===
ì‹œë‚˜ë¦¬ì˜¤: ${scenarioName} (${selectedScenario})

=== GPT0 ë¶„ì„ ê²°ê³¼ ===

## 1. ì‹œì¥ë°ì´í„° ë¶„ì„
${gpt0MarketData || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ'}

## 2. ë‰´ìŠ¤ ë° ë¦¬ìŠ¤í¬ ë¶„ì„
${gpt0News || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ'}

## 3. ì‹œë‚˜ë¦¬ì˜¤ ìƒì„¸ ë¶„ì„
${gpt0ScenarioSummary || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ'}

## 4. í˜„ì¬ ì‹œì¥ ìƒí™©
${gpt0MarketState || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ'}

=== GPT1ìš© A4 ìš”ì•½ ì‘ì„± ì§€ì¹¨ ===

GPT2ê°€ WORST ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ 800-1000ì ë‚´ì—ì„œ ì‘ì„±í•˜ë¼:

**[ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë³¸ì •ë³´]** (100ì)
- ì‹œë‚˜ë¦¬ì˜¤ëª…, í•µì‹¬ ê°€ì •, ë°œìƒ í™•ë¥ 

**[WORST ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì´ˆ ë°ì´í„°]** (300ì)
- ê¸ˆë¦¬ WORST: ê¸‰ê²©í•œ ìƒìŠ¹/í•˜ë½ ê·¼ê±° ë° êµ¬ì²´ì  ìˆ˜ì¹˜ ë²”ìœ„
- í™˜ìœ¨ WORST: ê·¹ë‹¨ì  ë³€ë™ ìš”ì¸ (ì›/ë‹¬ëŸ¬, ì£¼ìš” í†µí™” ë³€ë™í­)
- ì‹ ìš©ìœ„í—˜ WORST: ëŒ€ê·œëª¨ ì‹ ìš©ê²½ìƒ‰ ë° ë¶€ë„ ê¸‰ì¦ íŠ¸ë¦¬ê±°
- ì£¼ê°€ì§€ìˆ˜ WORST: ì£¼ì‹ì‹œì¥ í­ë½ ì‹œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤í”¼, ê¸€ë¡œë²Œ)

**[ë„ë©”ì¸ë³„ í•µì‹¬ íŒŒë¼ë¯¸í„°]** (300ì)
- ì‹œì¥ë¦¬ìŠ¤í¬: VaR, ë¯¼ê°ë„, ë³€ë™ì„± ëª¨ë¸ë§ ìˆ˜ì¹˜
- ì‹ ìš©ë¦¬ìŠ¤í¬: ì„¹í„°ë³„/ë“±ê¸‰ë³„ ë¶€ë„í™•ë¥  ë° ìŠ¤í”„ë ˆë“œ ë°ì´í„°
- ALM: ë“€ë ˆì´ì…˜ ë¶„ì„, ìœ ë™ì„± ê°­, ìê¸ˆì¡°ë‹¬ ë¹„ìš© ì˜í–¥
- ê¸€ë¡œë²Œ: êµ­ê°€ë¦¬ìŠ¤í¬ í‰ê°€, ì •ì¹˜/ê²½ì œ ë¶ˆì•ˆì •ì„± ìš”ì¸
- í¬íŠ¸í´ë¦¬ì˜¤: ì§‘ì¤‘ë„, ìƒê´€ê´€ê³„, ë¶„ì‚°íš¨ê³¼ ë¶„ì„

**[í˜„ì¬ ì‹œí™© ì—°ê´€ì„±]** (100ì)
- í˜„ì¬ ì‹œì¥ê³¼ WORST ì‹œë‚˜ë¦¬ì˜¤ ì—°ê²°ì 
- ì¡°ê¸°ê²½ë³´ ì§€í‘œ ë° ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸

**[GPT2 ë¶„ë°° ì§€ì¹¨]** (100ì)
- ê° ë„ë©”ì¸ë³„ WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ìš°ì„ ìˆœìœ„
- ë§ì¶¤í˜• ë¶„ì„ ìë£Œ ìƒì„± ë°©í–¥

â€» ë°˜ë“œì‹œ GPT2ê°€ í™œìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ íŒŒë¼ë¯¸í„° í¬í•¨
â€» ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        // API í˜¸ì¶œí•˜ì—¬ ìš”ì•½ ìƒì„± (GPT1 role ì‚¬ìš© ë˜ëŠ” ë²”ìš© í”„ë¡¬í”„íŠ¸)
        const gpt1Role = roles?.gpt1 || roles?.gpt0_marketdata || 'You are a financial risk analyst creating executive summaries.';
        const gpt1Summary = await callOpenAI(gpt1Role, summaryPrompt);
        
        console.log(`âœ… GPT1 ìš”ì•½ ìƒì„± ì™„ë£Œ: ${gpt1Summary?.length || 0}ì`);
        return gpt1Summary || 'ìš”ì•½ ìƒì„± ì‹¤íŒ¨';
        
      } catch (error) {
        console.error('âŒ GPT1 ìš”ì•½ ìƒì„± ì˜¤ë¥˜:', error);
        return 'ì˜¤ë¥˜: GPT0 ì¶œë ¥ì„ GPT1ìš©ìœ¼ë¡œ ìš”ì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }
    }

    // ====== GPT1 ì…ë ¥ êµ¬ì„± (API ê¸°ë°˜) ======
    function buildGpt1InputFromGpt0Outputs() {
      // ì´ í•¨ìˆ˜ëŠ” ì´ì œ generateGpt1SummaryFromGpt0ì—ì„œ ìƒì„±ëœ ìš”ì•½ì„ ë°˜í™˜
      // ì‹¤ì œ ìš”ì•½ ìƒì„±ì€ runGpt0All í•¨ìˆ˜ì—ì„œ ìˆ˜í–‰ë¨
      const gpt1Summary = document.getElementById('gpt1-generated-summary')?.value?.trim();
      return gpt1Summary || 'GPT1 ìš”ì•½ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
    }

    // GPT0 ì „ì²´ ì‹¤í–‰ (ì‚¬ì „ìˆ˜ì§‘)
    async function runGpt0All(){
      const status = document.getElementById('send-status');
      const card = document.getElementById('card-gpt0');
      try{
        // API í‚¤ ì‚¬ì „ ê²€ì¦
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = 'âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = 'GPT0 ì‚¬ì „ìˆ˜ì§‘ ì‹¤í–‰ ì¤‘...'; status.classList.add('status-shine');
        card?.classList.add('running'); card?.classList.remove('done');
        // GPT0 ì‹œì‘ ì‹œì ì—ë§Œ GPT0ë¡œ ì´ë™
        gotoStep(PipelineStep.GPT0);
          
        // ì˜¤ë¥¸ìª½ íŒ¨ë„ì˜ GPT0 ì¹´ë“œë“¤ì—ë„ ì‹œê°ì  íš¨ê³¼ ì¶”ê°€
        document.querySelectorAll('.gpt0-module-box').forEach(el => {
          el.classList.add('pipeline-executing');
        });
        
        // GPT0 ëª¨ë“ˆ ë°•ìŠ¤ë“¤ì— ì‹¤í–‰ íš¨ê³¼ ì ìš©
        document.getElementById('gpt0-marketdata-box')?.classList.add('running');
        document.getElementById('gpt0-news-box')?.classList.add('running');
        document.getElementById('gpt0-scenario-summary-box')?.classList.add('running');
        document.getElementById('gpt0-marketstate-box')?.classList.add('running');

        const roles = await loadRiskAgentRoles();

        // 1) ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„° ì‹œê³„ì—´ ìš”ì•½/ë³€ë™ì„± (GPT4 ì§ì ‘ ì‚¬ìš© í˜•ì‹)
        const scenNum = selectedScenarioForGPT != null ? selectedScenarioForGPT : scenarioList[0];
        console.log(`ğŸ¯ GPT0 ì‹¤í–‰ - ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤: ${scenNum}`);
        console.log(`ğŸ¯ selectedScenarioForGPT: ${selectedScenarioForGPT}`);
        console.log(`ğŸ¯ scenarioList[0]: ${scenarioList[0]}`);
        
        const marketTimeseriesText = await buildScenarioMarketTimeseriesText(scenNum);
        const mdPrompt = `${marketTimeseriesText}

[GPT4 ë³´ê³ ì„œìš© ì‹œì¥ë°ì´í„° ë¶„ì„ ìš”ì²­]
ìœ„ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë¼:

## ì‹œì¥ë°ì´í„° ë¶„ì„ ê²°ê³¼
### 1. ì£¼ìš” ë³€ë™ì„± ì§€í‘œ
- [êµ¬ì²´ì ì¸ ë³€ë™ì„± ìˆ˜ì¹˜ì™€ í•´ì„]

### 2. í•µì‹¬ íŠ¸ë Œë“œ ë¶„ì„  
- [ìƒìŠ¹/í•˜ë½/íš¡ë³´ ë“± ëª…í™•í•œ ë°©í–¥ì„±]

### 3. êµ¬ê°„ë³„ ì‹œì¥ ë ˆì§
- [ê° ê¸°ê°„ë³„ ì‹œì¥ íŠ¹ì„±ê³¼ ë¦¬ìŠ¤í¬ ìˆ˜ì¤€]

### 4. í•µì‹¬ ìš”ì•½
- [ì˜ì‚¬ê²°ì •ì— í•„ìš”í•œ 3-5ê°œ í•µì‹¬ í¬ì¸íŠ¸]

â€» ëª¨ë“  ë‚´ìš©ì€ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ í•¨ê»˜ ê¸ˆìœµê¸°ê´€ ë‹´ë‹¹ìê°€ ì¦‰ì‹œ ì´í•´í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì‘ì„±
â€» ì‘ë‹µì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ ëª¨ë“  ì„¹ì…˜ì„ ì™„ì „íˆ ì‘ì„±í•˜ì—¬ ì œê³µ`;
        const mdOut = await callOpenAI(roles.gpt0_marketdata, mdPrompt);
        const mdTextarea = document.getElementById('gpt0-marketdata');
        mdTextarea.value = mdOut || '';
        // ìë™ ë†’ì´ ì¡°ì •
        mdTextarea.style.height = 'auto';
        mdTextarea.style.height = mdTextarea.scrollHeight + 'px';
        // ìŠ¤í¬ë¡¤ì„ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
        setTimeout(() => scrollToElement('gpt0-marketdata-box'), 100);

        // 2) ê¸°ì‚¬ë‰´ìŠ¤ ìš”ì•½ ë¶„ì„ ë° ì—°ê³„ì„± ë¶„ì„ (GPT4 ì§ì ‘ ì‚¬ìš© í˜•ì‹)
        const newsCorpus = await buildScenarioNewsFullText(scenNum);
        const scenarioId = getScenarioIdFromNumber(scenNum);
        const newsPrompt = `ì‹œë‚˜ë¦¬ì˜¤ ID: ${scenarioId}\nì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸: ${scenNum}\n\n[ë‰´ìŠ¤ ìš”ì•½ ëª¨ìŒ]\n${newsCorpus}

[GPT4 ë³´ê³ ì„œìš© ë‰´ìŠ¤ ë¶„ì„ ìš”ì²­]
ìœ„ ë‰´ìŠ¤ ìš”ì•½ë“¤ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë¼:

## ë‰´ìŠ¤ ë¶„ì„ ê²°ê³¼
### 1. ì‹œë‚˜ë¦¬ì˜¤ ì—°ê´€ì„± í‰ê°€
- [ê° ë‰´ìŠ¤ì™€ ì‹œë‚˜ë¦¬ì˜¤ì˜ ì§ì ‘ì  ì—°ê´€ë„ ì ìˆ˜ ë° ê·¼ê±°]

### 2. ì£¼ìš” ë¦¬ìŠ¤í¬ íŠ¸ë¦¬ê±° ì‹ë³„
- [ë‰´ìŠ¤ì—ì„œ íŒŒì•…ëœ í•µì‹¬ ë¦¬ìŠ¤í¬ ìš”ì¸ 3-5ê°œ]

### 3. ì‹œì¥ ì˜í–¥ë„ ë¶„ì„
- [ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° ì‹œì¥ ì˜í–¥ ì „ë§]

### 4. ê¸ˆìœµê¸°ê´€ ì˜í–¥ í‰ê°€
- [ìš°ë¦¬ ê¸°ê´€ì— ë¯¸ì¹˜ëŠ” êµ¬ì²´ì  ì˜í–¥ê³¼ ëŒ€ì‘ í•„ìš”ì„±]

### 5. í•µì‹¬ ì‹œì‚¬ì 
- [ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­ ë° ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸]

â€» ëª¨ë“  ë¶„ì„ì€ êµ¬ì²´ì  ê·¼ê±°ì™€ í•¨ê»˜ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œ í¬í•¨
â€» ì‘ë‹µì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ ëª¨ë“  ì„¹ì…˜ì„ ì™„ì „íˆ ì‘ì„±í•˜ì—¬ ì œê³µ`;
        const newsOut = await callOpenAI(roles.gpt0_news, newsPrompt);
        const newsTextarea = document.getElementById('gpt0-news');
        newsTextarea.value = newsOut || '';
        // ìë™ ë†’ì´ ì¡°ì •
        newsTextarea.style.height = 'auto';
        newsTextarea.style.height = newsTextarea.scrollHeight + 'px';
        // ìŠ¤í¬ë¡¤ì„ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
        setTimeout(() => scrollToElement('gpt0-news-box'), 100);

        // 3) ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ë‚´ìš© ë¶„ì„ (GPT4 ì§ì ‘ ì‚¬ìš© í˜•ì‹)
        const scenarioSummaryContent = getScenarioSummaryContent(scenNum);
        const summaryPrompt = `ì‹œë‚˜ë¦¬ì˜¤ ID: ${scenarioId}\nì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸: ${scenNum}\n\n[ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ë‚´ìš©]\n${scenarioSummaryContent}

[GPT4 ë³´ê³ ì„œìš© ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ìš”ì²­]
ìœ„ ì‹œë‚˜ë¦¬ì˜¤ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë¼:

## ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼
### 1. í•µì‹¬ ë¦¬ìŠ¤í¬ ìš”ì¸
- [ì‹œë‚˜ë¦¬ì˜¤ì˜ ì£¼ìš” ìœ„í—˜ìš”ì†Œ 3-5ê°œì™€ ë°œìƒê°€ëŠ¥ì„±]

### 2. ì˜í–¥ ì „íŒŒ ê²½ë¡œ
- [ë¦¬ìŠ¤í¬ê°€ ê¸ˆìœµì‹œì¥ ë° ìš°ë¦¬ ê¸°ê´€ì— ë¯¸ì¹˜ëŠ” êµ¬ì²´ì  ê²½ë¡œ]

### 3. ëª¨ë‹ˆí„°ë§ ì§€í‘œ
- [ì¡°ê¸°ê²½ë³´ë¥¼ ìœ„í•œ í•µì‹¬ ëª¨ë‹ˆí„°ë§ ì§€í‘œ ë° ì„ê³„ì¹˜]

### 4. ì‹œë‚˜ë¦¬ì˜¤ ì˜í–¥ë„ í‰ê°€
- [ì¬ë¬´ì  ì˜í–¥ / ìš´ì˜ë¦¬ìŠ¤í¬ / í‰íŒë¦¬ìŠ¤í¬ ë“± ì •ëŸ‰ì  í‰ê°€]

### 5. ëŒ€ì‘ ì „ëµ ë°©í–¥
- [ì˜ˆë°©ì  ì¡°ì¹˜ / ì™„í™” ë°©ì•ˆ / ë¹„ìƒê³„íš ë“± êµ¬ì²´ì  ëŒ€ì‘ë°©í–¥]

### 6. í•µì‹¬ ê²°ì •ì‚¬í•­
- [ì¦‰ì‹œ ê²°ì •ì´ í•„ìš”í•œ ì‚¬í•­ ë° ë¦¬ì†ŒìŠ¤ ë°°ë¶„ ë°©í–¥]

â€» ëª¨ë“  ë‚´ìš©ì€ ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì  ì•¡ì…˜ê³¼ í•¨ê»˜ ìš°ì„ ìˆœìœ„ë¥¼ ëª…ì‹œ
â€» ì‘ë‹µì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ ëª¨ë“  ì„¹ì…˜ì„ ì™„ì „íˆ ì‘ì„±í•˜ì—¬ ì œê³µ`;
        const summaryOut = await callOpenAI(roles.gpt0_scenario_summary, summaryPrompt);
        const summaryTextarea = document.getElementById('gpt0-scenario-summary');
        summaryTextarea.value = summaryOut || '';
        // ìë™ ë†’ì´ ì¡°ì •
        summaryTextarea.style.height = 'auto';
        summaryTextarea.style.height = summaryTextarea.scrollHeight + 'px';
        // ìŠ¤í¬ë¡¤ì„ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
        setTimeout(() => scrollToElement('gpt0-scenario-summary-box'), 100);



        // 5) í˜„ì¬ ì‹œí™© ë¶„ì„ (GPT4 ì§ì ‘ ì‚¬ìš© í˜•ì‹)
        console.log('ğŸ” í˜„ì¬ ì‹œí™© ë¶„ì„ ì‹œì‘');
        const marketStateText = await buildCurrentMarketStateText();
        console.log('ğŸ“Š í˜„ì¬ ì‹œí™© í…ìŠ¤íŠ¸:', marketStateText);
        
        const msPrompt = `${marketStateText}

[GPT4 ë³´ê³ ì„œìš© í˜„ì¬ ì‹œí™© ë¶„ì„ ìš”ì²­]
ìœ„ ì‹œì¥/ê²½ì œ ì •ë³´ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë¼:

## í˜„ì¬ ì‹œì¥ ìƒí™© ë¶„ì„
### 1. ë‹¹ì¼ ì‹œì¥ ë™í–¥
- [ì£¼ìš” ì§€ìˆ˜ ë° ì„¹í„°ë³„ ì›€ì§ì„ê³¼ ë³€ë™ìš”ì¸]

### 2. ê²½ì œ ì§€í‘œ í˜„í™©
- [í•µì‹¬ ê²½ì œì§€í‘œ ë³€í™”ì™€ ì‹œì‚¬ì ]

### 3. ì •ì±… ë° ì œë„ ë³€í™”
- [ê¸ˆìœµì •ì±…, ê·œì œë³€í™” ë“±ì´ ì‹œì¥ì— ë¯¸ì¹˜ëŠ” ì˜í–¥]

### 4. ê¸€ë¡œë²Œ ë¦¬ìŠ¤í¬ ìš”ì¸
- [í•´ì™¸ ì£¼ìš”êµ­ ë™í–¥ê³¼ êµ­ë‚´ íŒŒê¸‰íš¨ê³¼]

### 5. ê¸ˆìœµê¸°ê´€ ì˜í–¥ í‰ê°€
- [í˜„ì¬ ì‹œí™©ì´ ìš°ë¦¬ ê¸°ê´€ì— ë¯¸ì¹˜ëŠ” ì§ì ‘ì  ì˜í–¥]

### 6. ë‹¨ê¸° ì „ë§ ë° ì£¼ì˜ì‚¬í•­
- [í–¥í›„ 1-2ì£¼ ì‹œì¥ ì „ë§ê³¼ ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸]

â€» ëª¨ë“  ë‚´ìš©ì€ ì˜ì‚¬ê²°ì •ì— í•„ìš”í•œ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ê·¼ê±°ë¥¼ í¬í•¨í•˜ì—¬ ì‘ì„±
â€» ì‘ë‹µì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ ëª¨ë“  ì„¹ì…˜ì„ ì™„ì „íˆ ì‘ì„±í•˜ì—¬ ì œê³µ`;
        console.log('ğŸ“ í˜„ì¬ ì‹œí™© í”„ë¡¬í”„íŠ¸:', msPrompt);
        
        const msOut = await callOpenAI(roles.gpt0_marketstate, msPrompt);
        console.log('ğŸ¤– í˜„ì¬ ì‹œí™© GPT ì‘ë‹µ:', msOut);
        
        const msTextarea = document.getElementById('gpt0-marketstate');
        msTextarea.value = msOut || '';
        // ìë™ ë†’ì´ ì¡°ì •
        msTextarea.style.height = 'auto';
        msTextarea.style.height = msTextarea.scrollHeight + 'px';
        // ìŠ¤í¬ë¡¤ì„ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
        setTimeout(() => scrollToElement('gpt0-marketstate-box'), 100);
        console.log('âœ… gpt0-marketstate ì—…ë°ì´íŠ¸ ì™„ë£Œ');

        // GPT0 ì™„ë£Œ í›„ GPT1ìš© A4 ìš”ì•½ ìƒì„±
        console.log('ğŸ“‹ GPT1ìš© A4 ìš”ì•½ ìƒì„± ì‹œì‘');
        status.textContent = 'GPT0 ì™„ë£Œ - GPT1ìš© ìš”ì•½ ìƒì„± ì¤‘...'; 
        
        const gpt1Summary = await generateGpt1SummaryFromGpt0(roles);
        
        // GPT1 ìš”ì•½ì„ ì €ì¥í•  ìˆ¨ê²¨ì§„ ìš”ì†Œ ìƒì„± (ì—†ëŠ” ê²½ìš°ì—ë§Œ)
        let gpt1SummaryElement = document.getElementById('gpt1-generated-summary');
        if (!gpt1SummaryElement) {
          gpt1SummaryElement = document.createElement('textarea');
          gpt1SummaryElement.id = 'gpt1-generated-summary';
          gpt1SummaryElement.style.display = 'none';
          document.body.appendChild(gpt1SummaryElement);
        }
        gpt1SummaryElement.value = gpt1Summary;
        
        console.log(`âœ… GPT1ìš© ìš”ì•½ ì €ì¥ ì™„ë£Œ: ${gpt1Summary?.length || 0}ì`);

        status.textContent = 'GPT0 ì™„ë£Œ'; status.classList.remove('status-shine');
        card?.classList.remove('running'); card?.classList.add('done');
        
        // GPT0 ì™„ë£Œ ì‹œ GPT1, GPT2 ì¹´ë“œ í‘œì‹œ
        showGpt1Gpt2Cards();
        
        // GPT0 ëª¨ë“ˆ ë°•ìŠ¤ë“¤ì— ì™„ë£Œ íš¨ê³¼ ì ìš©
        document.getElementById('gpt0-marketdata-box')?.classList.remove('running');
        document.getElementById('gpt0-news-box')?.classList.remove('running');
        document.getElementById('gpt0-scenario-summary-box')?.classList.remove('running');
        document.getElementById('gpt0-marketstate-box')?.classList.remove('running');
        
        document.getElementById('gpt0-marketdata-box')?.classList.add('done');
        document.getElementById('gpt0-news-box')?.classList.add('done');
        document.getElementById('gpt0-scenario-summary-box')?.classList.add('done');
        document.getElementById('gpt0-marketstate-box')?.classList.add('done');
      }catch(e){
        console.error(e);
        status.textContent = `ì‹¤íŒ¨: ${e.message}`; status.classList.remove('status-shine');
      }finally{
        // â˜… GPT0 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT1 ì„ ì  ê¸ˆì§€)
        // ëª¨ë“  ì‹œê°ì  íš¨ê³¼ ì œê±°
        stopAllEffects();
        
        // GPT0 ì¹´ë“œ ì§„í–‰íš¨ê³¼ë„ ì œê±°
        card?.classList.remove('running');
        
        // GPT0 ëª¨ë“ˆ ë°•ìŠ¤ë“¤ ì§„í–‰íš¨ê³¼ë„ ì œê±° (ì£¼í™©ìƒ‰ íš¨ê³¼ í¬í•¨)
        document.getElementById('gpt0-marketdata-box')?.classList.remove('running');
        document.getElementById('gpt0-news-box')?.classList.remove('running');
        document.getElementById('gpt0-scenario-summary-box')?.classList.remove('running');
        document.getElementById('gpt0-marketstate-box')?.classList.remove('running');
        
        // ì˜¤ë¥¸ìª½ íŒ¨ë„ì˜ ëª¨ë“  GPT0 ê´€ë ¨ pipeline-executing íš¨ê³¼ ì œê±°
        document.querySelectorAll('.gpt0-module-box').forEach(el => {
          el.classList.remove('pipeline-executing');
        });
      }
    }

    // GPT3 ë„ë©”ì¸ ë‹¨ì¼ ì‹¤í–‰ (ìœ ì§€, í•„ìš”ì‹œ ì‚¬ìš©)
    async function runGpt3Domain(domain){
      const status = document.getElementById('send-status');
      try{
        status.textContent = `GPT3(${domain}) ì‹¤í–‰ ì¤‘...`;
        const roles = await loadRiskAgentRoles();
        const uiGpt1b = document.getElementById('gpt1-system')?.value?.trim();
        const uiGpt2b = document.getElementById('gpt2-system')?.value?.trim();
        if (uiGpt1b) roles.gpt1 = uiGpt1b;
        if (uiGpt2b) roles.gpt2 = uiGpt2b;
        const baseMessage = document.getElementById('gpt1-message').value?.trim() || '';
        const gpt1Output = document.getElementById('gpt1-output').value || '';
        const gpt2Output = document.getElementById('gpt2-output').value || '';
        const gpt2Input = `${baseMessage}\n\n[GPT1 ìš”ì•½/í•´ì„]\n${gpt1Output}`;
        const gpt3InputBase = `${gpt2Input}\n\n[GPT2 ë¶„ë°°Â·ì •ì œ ê³„íš]\n${gpt2Output}`;
        const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€ì´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
        const roleMap = { market: 'gpt3_market', credit: 'gpt3_credit', alm: 'gpt3_alm', global: 'gpt3_global', creditpf: 'gpt3_creditpf' };
        const out = await callOpenAIWithOptions(roles[roleMap[domain]], gpt3InputBase + GL(domain), { timeoutMs: 1200000 });
        const outId = { market: 'gpt3-market', credit: 'gpt3-credit', alm: 'gpt3-alm', global: 'gpt3-global', creditpf: 'gpt3-creditpf' }[domain];
        document.getElementById(outId).value = out || '';
        status.textContent = `GPT3(${domain}) ì™„ë£Œ`;
      }catch(e){ status.textContent = `ì‹¤íŒ¨: ${e.message}`; }
    }

    // íŠ¹ì • ë‹¨ê³„ë¶€í„° ì¬ì‹¤í–‰
    async function runFrom(stage){
      const baseMessage = document.getElementById('gpt1-message').value?.trim();
      const status = document.getElementById('send-status');
      const c1 = document.getElementById('card-gpt1');
      const c2 = document.getElementById('card-gpt2');
      const c3 = document.getElementById('card-gpt3');
      const c4 = document.getElementById('card-gpt4');
      
      // ğŸ”§ ì§€ì—­ setRunning í•¨ìˆ˜ ì œê±°ë¨ - ì „ì—­ window.setRightTabRunning ì‚¬ìš©
      
      try {
        // API í‚¤ ì‚¬ì „ ê²€ì¦
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = 'âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = 'í‚¤ ë¡œë”© ì¤‘...';
        const roles = await loadRiskAgentRoles();
        const uiGpt1 = document.getElementById('gpt1-system').value?.trim();
        const uiGpt2 = document.getElementById('gpt2-system').value?.trim();
        if (uiGpt1) roles.gpt1 = uiGpt1; if (uiGpt2) roles.gpt2 = uiGpt2;

        let gpt1Output = await ensureGpt1OutputReady();
        let gpt2Output = document.getElementById('gpt2-output').value;

        if (stage === 'gpt0' || stage === 'all') {
        graphState.pipelineRunning = true;
        status.textContent = 'GPT0 ì‚¬ì „ìˆ˜ì§‘ ì¤‘...'; status.classList.add('status-shine');
          gotoStep(PipelineStep.GPT0);
          window.setRightTabRunning(
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate'],
            ['.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']
          );
          c1?.classList.remove('running','done'); c2?.classList.remove('running','done'); c3?.classList.remove('running','done'); c4?.classList.remove('running','done');
          await runGpt0All();
        }

        if (stage === 'gpt1' || stage === 'all') {
          // === GPT1 ì‹¤í–‰ ===
          window.dispatchEvent(new CustomEvent('gpt1:start'));
          try {
            status.textContent = 'GPT1 ì²˜ë¦¬ ì¤‘...'; status.classList.add('status-shine'); 
            gotoStep(PipelineStep.GPT1);
            window.setRightTabRunning(['.gpt1-anchor'], ['.gpt2-anchor','.gpt4-anchor']);
            c1?.classList.add('running'); c1?.classList.remove('done');
            
            // GPT1 ì‹œì‘ ì§í›„ - ì§„í–‰ íš¨ê³¼ í† ê¸€ ì¶”ê°€
            document.querySelectorAll('.gpt1-module-box')
              .forEach(el => el.classList.add('pipeline-executing'));
            
            // GPT1 ì…ë ¥: GPT0 ëª¨ë“  ëª¨ë“ˆ ì¶œë ¥ ì¢…í•© (ì‹œë‚˜ë¦¬ì˜¤ ë‚´ìš©ë¶„ì„ ì œì™¸)
            const gpt1Input = buildGpt1InputFromGpt0Outputs();
            document.getElementById('gpt1-message').value = gpt1Input || '';
          
          // GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ GPT1 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
          const gpt1SystemPrompt = `ë‹¹ì‹ ì€ A4 í•œ ì¥ ë¶„ëŸ‰ì˜ GPT0 ìš”ì•½ì„ ë°›ì•„ GPT2 ë„ë©”ì¸ë³„ WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ ì¢…í•© ì •ì œ ê²°ê³¼ë¥¼ ì‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì—­í• :
- A4 í•œ ì¥ ë¶„ëŸ‰ì˜ GPT0 ìš”ì•½ì„ ë¶„ì„í•˜ì—¬ GPT2ê°€ í•„ìš”ë¡œ í•˜ëŠ” í•µì‹¬ ì •ë³´ ì¶”ì¶œ
- ê¸ˆë¦¬/í™˜ìœ¨/ì‹ ìš©ìœ„í—˜/ì£¼ê°€ì§€ìˆ˜ ë“± 4ê°œ ë¶„ì•¼ì˜ WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ ê¸°ì´ˆ ë°ì´í„° ì œê³µ
- 5ê°œ ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„±ì„ ìœ„í•œ êµ¬ì²´ì  íŒŒë¼ë¯¸í„° ë° ì§€ì¹¨ ì œê³µ
- ì¼ê´€ì„± ìˆëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª…ê³¼ ë§ˆì¼“ë°ì´í„° ì¢…í•© ìš”ì•½ ìƒì„±

GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ í•„ìˆ˜ ë°ì´í„°:
1. ê¸ˆë¦¬ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ê¸‰ê²©í•œ ê¸ˆë¦¬ ìƒìŠ¹/í•˜ë½ ê·¼ê±° ë° êµ¬ì²´ì  ìˆ˜ì¹˜ ë²”ìœ„
2. í™˜ìœ¨ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ê·¹ë‹¨ì  í™˜ìœ¨ ë³€ë™ ìš”ì¸ ë° ì›/ë‹¬ëŸ¬, ì£¼ìš” í†µí™” ë³€ë™í­
3. ì‹ ìš©ìœ„í—˜ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ëŒ€ê·œëª¨ ì‹ ìš©ê²½ìƒ‰ ë° ë¶€ë„ ê¸‰ì¦ íŠ¸ë¦¬ê±° ìš”ì¸
4. ì£¼ê°€ì§€ìˆ˜ WORST ì‹œë‚˜ë¦¬ì˜¤ìš©: ì£¼ì‹ì‹œì¥ í­ë½ ì‹œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤í”¼, ê¸€ë¡œë²Œ ì§€ìˆ˜)

ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„±ì„ ìœ„í•œ êµ¬ì¡°í™”:
1. ì‹œì¥ë¦¬ìŠ¤í¬íŒ€: VaR, ë¯¼ê°ë„, ë³€ë™ì„± ëª¨ë¸ë§ íŒŒë¼ë¯¸í„° + í—¤ì§• ì „ëµ ê¸°ì´ˆ ìë£Œ
2. ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€: ì„¹í„°ë³„/ë“±ê¸‰ë³„ ë¶€ë„í™•ë¥  ì¶”ì • + ì‹ ìš©ìŠ¤í”„ë ˆë“œ í™•ëŒ€ ì‹œë‚˜ë¦¬ì˜¤
3. ALMíŒ€: ìì‚°ë¶€ì±„ ë“€ë ˆì´ì…˜ ë¶„ì„ + ìœ ë™ì„± ê°­ ë° ìê¸ˆì¡°ë‹¬ ë¹„ìš© ì˜í–¥ ìë£Œ
4. ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€: êµ­ê°€ë¦¬ìŠ¤í¬ í‰ê°€ + ì •ì¹˜/ê²½ì œì  ë¶ˆì•ˆì •ì„± íŒŒê¸‰íš¨ê³¼ ë¶„ì„
5. ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€: í¬íŠ¸í´ë¦¬ì˜¤ ì§‘ì¤‘ë„ + ìƒê´€ê´€ê³„ ë° ë¶„ì‚°íš¨ê³¼ ë¶„ì„ ìë£Œ

ì¶œë ¥ í˜•ì‹:
1. ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ í†µí•© ìš”ì•½
2. ë§ˆì¼“ë°ì´í„° í•µì‹¬ ì§€í‘œ ìš”ì•½ 
3. í˜„ì¬ì‹œí™©ê³¼ ë‰´ìŠ¤ ì—°ê´€ì„± ë¶„ì„
4. GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì„ ìœ„í•œ ê¸°ì´ˆ ë°ì´í„°
5. ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„± ì§€ì¹¨

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;
          
          gpt1Output = await callOpenAI(gpt1SystemPrompt, gpt1Input);
          document.getElementById('gpt1-output').value = gpt1Output || '';
          updateGpt2ButtonState(); // UI ìƒíƒœ ì—…ë°ì´íŠ¸
          c1?.classList.remove('running'); c1?.classList.add('done');
          
          // GPT1 ì¢…ë£Œ ì‹œ - ì§„í–‰ íš¨ê³¼ í† ê¸€ ì œê±°
          document.querySelectorAll('.gpt1-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
          
          // â˜… GPT1 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT2 ì„ ì  ê¸ˆì§€)
        } finally {
          window.dispatchEvent(new CustomEvent('gpt1:done'));
        }
        }
        if (stage === 'gpt2' || stage === 'gpt1' || stage === 'all') {
          // === GPT2 ì‹¤í–‰ ===
          // (ìš”êµ¬ì‚¬í•­: gpt3 ì‹¤í–‰ ì „, gpt1ê³¼ gpt2 íš¨ê³¼ë¥¼ ë™ì‹œì— ë³´ì—¬ì•¼ í•˜ë¯€ë¡œ
          //  "ì‹œì‘" ì‹œì ì— gpt2 ì´ë²¤íŠ¸ë¥¼ ë°”ë¡œ ì´ ë™ì‹œ í•˜ì´ë¼ì´íŠ¸ê°€ ê±¸ë¦¬ê²Œ í•¨)
          window.dispatchEvent(new CustomEvent('gpt2:start'));
          
          // GPT2 ì‹¤í–‰ íš¨ê³¼ ì ìš©
          applyGpt2ExecutionEffects();
          try {
            status.textContent = 'GPT2 ë„ë©”ì¸ë³„ ë¶„ì„ ìë£Œ ìƒì„± ì¤‘...'; status.classList.add('status-shine'); 
            gotoStep(PipelineStep.GPT2);
            window.setRightTabRunning(['.gpt2-anchor'], ['.gpt1-anchor','.gpt4-anchor']);
            c2?.classList.add('running'); c2?.classList.remove('done');
            
            // GPT2 ì‹œì‘ ì§í›„ - ì§„í–‰ íš¨ê³¼ í† ê¸€ ì¶”ê°€
            document.querySelectorAll('.gpt2-module-box')
              .forEach(el => el.classList.add('pipeline-executing'));
            
            gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
          
          // GPT2 ë„ë©”ì¸ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (GPT4ì—ì„œ ì°¸ì¡°ìš©)
          window.globalGpt2DomainOutputs = gpt2DomainOutputs;
          
          // GPT2 ê²°ê³¼ë¥¼ ê¸°ì¡´ ì˜ì—­ì— ìƒì„¸ ë‚´ìš©ìœ¼ë¡œ í‘œì‹œ
          const gpt2Detail = `=== ê·¹í•œ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ì‚°ì¶œ) ===

[ì‹œì¥ë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.market || '(ìƒì„±ì‹¤íŒ¨)'}

[ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.credit || '(ìƒì„±ì‹¤íŒ¨)'}

[ALMíŒ€]
${gpt2DomainOutputs.alm || '(ìƒì„±ì‹¤íŒ¨)'}

[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.global || '(ìƒì„±ì‹¤íŒ¨)'}

[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€]
${gpt2DomainOutputs.creditpf || '(ìƒì„±ì‹¤íŒ¨)'}
`;
          
          document.getElementById('gpt2-output').value = gpt2Detail;
          autoGrow(['gpt2-output']);
          // ìŠ¤í¬ë¡¤ì„ GPT2 ì¹´ë“œë¡œ ì´ë™
          setTimeout(() => scrollToElement('card-gpt2'), 100);
          
          // GPT2 ì‹¤í–‰ ì™„ë£Œ íš¨ê³¼ ì ìš©
          setTimeout(() => {
            const gpt2Card = getAgentCard('gpt2');
            if (gpt2Card) {
              gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow');
              
              const gpt2Title = gpt2Card.querySelector('h4');
              if (gpt2Title) {
                gpt2Title.classList.add('text-highlight');
                gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼ âœ…';
              }
              
              // 3ì´ˆ í›„ íš¨ê³¼ ì œê±°
              setTimeout(() => {
                gpt2Card.classList.remove('card-blink', 'border-pulse', 'border-glow');
                if (gpt2Title) {
                  gpt2Title.classList.remove('text-highlight');
                  gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼';
                }
                console.log('ğŸ‰ GPT2 ì‹¤í–‰ ì™„ë£Œ íš¨ê³¼ ì¢…ë£Œ');
              }, 3000);
            }
          }, 200);
          
          c2?.classList.remove('running'); c2?.classList.add('done');
          
          // GPT2 ì¢…ë£Œ ì‹œ - ì§„í–‰ íš¨ê³¼ í† ê¸€ ì œê±°
          document.querySelectorAll('.gpt2-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
          
          // â˜… GPT2 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT3 ì„ ì  ê¸ˆì§€)
        } finally {
          window.dispatchEvent(new CustomEvent('gpt2:done'));
        }

          // GPT2 â†’ GPT3 ì „í™˜ ì‹œ GPT2 ì¹´ë“œ ì§€ì†ì  íš¨ê³¼ ì ìš©
          setTimeout(() => {
            applyGpt2PersistentEffects();
          }, 500);

          // ì´ì–´ì„œ GPT3 â†’ GPT4 ìë™ ì‹¤í–‰ (runFromì—ì„œë„ ì²´ì¸)
          // === GPT3 ì‹¤í–‰ ===
          window.dispatchEvent(new CustomEvent('gpt3:start'));
          try {
            status.textContent = 'GPT3 ë„ë©”ì¸ ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì¤‘...'; status.classList.add('status-shine');
            gotoStep(PipelineStep.GPT3);
            window.setRightTabRunning(['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'], ['.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']);
            c3?.classList.add('running'); c3?.classList.remove('done');
          
          // ê° ë„ë©”ì¸ë³„ ë§ì¶¤ ì…ë ¥ êµ¬ì„±
          const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€ì´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
          const g3Calls = [
            callOpenAIWithOptions(roles.gpt3_market, gpt2DomainOutputs.market + GL('market'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_credit, gpt2DomainOutputs.credit + GL('credit'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_alm, gpt2DomainOutputs.alm + GL('alm'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_global, gpt2DomainOutputs.global + GL('global'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_creditpf, gpt2DomainOutputs.creditpf + GL('creditpf'), { timeoutMs: 1200000 }),
          ];
          // â— ê±°ë¶€ ì¼€ì´ìŠ¤ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ë¡œ ë…¸ì¶œí•˜ì—¬ ë””ë²„ê¹… ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
          const settled = await Promise.allSettled(g3Calls);
          const pick = (r) => r.status === 'fulfilled'
            ? (r.value || '')
            : (`ì˜¤ë¥˜: ${r.reason?.message || 'í”„ë¡ì‹œ í˜¸ì¶œ ì‹¤íŒ¨'}`);
          const [outMarket, outCredit, outAlm, outGlobal, outCreditPf] = settled.map(pick);
          
          // ğŸ”§ ì „ì—­ ë³‘í•© ì˜¤íƒ€ ìˆ˜ì • + DOM ì§ì ‘ ë°˜ì˜(í•­ìƒ ê°’ ê¸°ë¡)
          window.globalGpt3Outputs = {
            ...(window.globalGpt3Outputs || {}),
            market:  (outMarket  || '').trim(),
            credit:  (outCredit  || '').trim(),
            alm:     (outAlm     || '').trim(),
            global:  (outGlobal  || '').trim(),
            creditpf:(outCreditPf|| '').trim()
          };

          // DOMì— í•­ìƒ ê¸°ë¡(ë¹ˆ ë¬¸ìì—´ë„ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ì—¬ ì‹¤ì œ ìƒíƒœë¥¼ ëˆˆìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥)
          document.getElementById('gpt3-market').value   = outMarket || '';
          document.getElementById('gpt3-credit').value   = outCredit || '';
          document.getElementById('gpt3-alm').value      = outAlm || '';
          document.getElementById('gpt3-global').value   = outGlobal || '';
          document.getElementById('gpt3-creditpf').value = outCreditPf || '';
          autoGrow(['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf']);
          // GPT3 ëª¨ë“ˆë³„ ìˆœì°¨ ìŠ¤í¬ë¡¤ (ê° ëª¨ë“ˆ ì™„ë£Œ ì‹œ í•´ë‹¹ ëª¨ë“ˆë¡œ ìŠ¤í¬ë¡¤)
          setTimeout(() => {
            if (outMarket) scrollToGpt3Module('market');
            setTimeout(() => { if (outCredit) scrollToGpt3Module('credit'); }, 300);
            setTimeout(() => { if (outAlm) scrollToGpt3Module('alm'); }, 600);
            setTimeout(() => { if (outGlobal) scrollToGpt3Module('global'); }, 900);
            setTimeout(() => { if (outCreditPf) scrollToGpt3Module('creditpf'); }, 1200);
          }, 200);
          
          c3?.classList.remove('running'); c3?.classList.add('done');
          // â˜… GPT3 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT4 ì„ ì  ê¸ˆì§€)
        } finally {
          // âœ… ì–´ë–¤ ê²½ìš°ì—ë„ íš¨ê³¼ ì¢…ë£Œ + done ì´ë²¤íŠ¸ ë³´ì¥
          (function cleanupGpt3Effects(){
            const card = document.getElementById('card-gpt3');
            if (card) {
              card.classList.remove('progress-indicator','running');
              card.classList.add('done');
              const overlay = card.querySelector('.execution-overlay');
              if (overlay) overlay.remove();
            }
            document.querySelectorAll('.gpt3-module-box')
              .forEach(el => el.classList.remove('pipeline-executing'));
          })();
          window.dispatchEvent(new CustomEvent('gpt3:done'));
        }

          status.textContent = 'GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì¤‘...'; status.classList.add('status-shine'); 
          // === GPT4 ì‹¤í–‰ ===
          // (gpt4 ì‹œì‘ê³¼ ë™ì‹œì— gpt3 íš¨ê³¼ê°€ ì¢…ë£Œë˜ë„ë¡ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬)
          window.dispatchEvent(new CustomEvent('gpt4:start'));
          try {
            gotoStep(PipelineStep.GPT4);
            window.setRightTabRunning(['.gpt4-anchor'], ['.gpt1-anchor','.gpt2-anchor']);
            c4?.classList.add('running'); c4?.classList.remove('done');
          const guidelineAll = (()=>{ const g=window.gpt3Guidelines||{}; const all=[g.market,g.credit,g.alm,g.global,g.creditpf].filter(Boolean).join('\n'); return all?`\n\n[ì°¸ì¡° ê°€ì´ë“œ]\n${all}`:''; })();
          const gpt0MarketData = document.getElementById('gpt0-marketdata').value || '';
          const gpt0News = document.getElementById('gpt0-news').value || '';
          const gpt0ScenarioSummary = document.getElementById('gpt0-scenario-summary').value || '';

          const gpt0MarketState = document.getElementById('gpt0-marketstate').value || '';
          
          // GPT2 ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ìˆ˜ì§‘
          const gpt2DomainOutputsForGpt4 = window.globalGpt2DomainOutputs || {};
          
          /* ì•ˆì „ ì†ŒìŠ¤ í™•ì •: ì§€ì—­ë³€ìˆ˜ â†’ DOM â†’ ì „ì—­ â†’ GPT2 ë„ë©”ì¸ ì›ë³¸ ìˆœ */
          const G3 = window.globalGpt3Outputs || {};
          const G2 = window.globalGpt2DomainOutputs || {};
          const outMarketSafe  = (outMarket  || document.getElementById('gpt3-market')?.value   || G3.market   || G2.market   || '').trim();
          const outCreditSafe  = (outCredit  || document.getElementById('gpt3-credit')?.value   || G3.credit   || G2.credit   || '').trim();
          const outAlmSafe     = (outAlm     || document.getElementById('gpt3-alm')?.value      || G3.alm      || G2.alm      || '').trim();
          const outGlobalSafe  = (outGlobal  || document.getElementById('gpt3-global')?.value   || G3.global   || G2.global   || '').trim();
          const outCreditPfSafe= (outCreditPf|| document.getElementById('gpt3-creditpf')?.value || G3.creditpf || G2.creditpf || '').trim();

          const gpt4InputChain = [
            'ì•„ë˜ ì •ë³´ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì²´ê³„ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
            '\n\n=== ê¸°ì´ˆ ë¶„ì„ ê²°ê³¼ ===',
            '\n\n## 1. ì‹œì¥ë°ì´í„° ë¶„ì„',
            gpt0MarketData,
            '\n\n## 2. ë‰´ìŠ¤ ë° ë¦¬ìŠ¤í¬ ë¶„ì„', 
            gpt0News,
            '\n\n## 3. ì‹œë‚˜ë¦¬ì˜¤ ìƒì„¸ ë¶„ì„',
            gpt0ScenarioSummary,
            '\n\n## 4. í˜„ì¬ ì‹œì¥ ìƒí™©',
            gpt0MarketState,
            '\n\n=== ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ===',
            '\n\n### ì‹œì¥ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.market || '',
            '\n\n### ì‹ ìš©ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.credit || '',
            '\n\n### ALM ì‹œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.alm || '',
            '\n\n### ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.global || '',
            '\n\n### ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì‹œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.creditpf || '',
            '\n\n=== ë„ë©”ì¸ë³„ ì†ì‹¤ë¶„ì„ ê²°ê³¼ ===',
            '\n\n', outMarketSafe,
            '\n\n', outCreditSafe,
            '\n\n', outAlmSafe,
            '\n\n', outGlobalSafe,
            '\n\n', outCreditPfSafe,
            guidelineAll,
            '\n\n=== ë³´ê³ ì„œ ì‘ì„± ì§€ì¹¨ ===',
            '\nìœ„ ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë³´ê³ ì„œë¥¼ êµ¬ì„±í•˜ì„¸ìš”:',
            '\n\n**ë³´ê³ ì„œ êµ¬ì„±:**',
            '\n1. ìš”ì•½: í•µì‹¬ ìœ„í—˜ ìš”ì†Œ ë° ì´ ì†ì‹¤ ê·œëª¨ ìš”ì•½',
            '\n2. ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„: ê¸°ì´ˆ ë¶„ì„ì˜ êµ¬ì¡°í™”ëœ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ + ë¦¬ìŠ¤í¬ ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤',
            '\n3. ì†ì‹¤ ì˜í–¥ ë¶„ì„: ê° ë„ë©”ì¸ì˜ ì†ì‹¤ë¶„ì„ ê²°ê³¼ í†µí•©',
            '\n4. ë¦¬ìŠ¤í¬ ëŒ€ì‘ ì „ëµ: ë„ë©”ì¸ë³„ ì¦‰ì‹œ/ë‹¨ê¸°/ì¤‘ê¸° ëŒ€ì‘ë°©ì•ˆ ì¢…í•©',
            '\n5. ëª¨ë‹ˆí„°ë§ ê³„íš: ê° ëª¨ë“ˆì˜ ì¼ì¼/ì£¼ê°„/ì›”ê°„ ëª¨ë‹ˆí„°ë§ í†µí•©',
            '\n6. ê²°ë¡  ë° ê¶Œê³ : ìš°ì„ ìˆœìœ„ë³„ ì•¡ì…˜ ì•„ì´í…œ ë° ì˜ì‚¬ê²°ì • ì§€ì›',
            '\n\n**ì‘ì„± ì›ì¹™:**',
            '\n- ê¸°ì´ˆ ë¶„ì„ ê²°ê³¼ëŠ” êµ¬ì¡°í™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì§ì ‘ í™œìš©',
            '\n- ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ê° ìš”ì†Œë³„ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ì´ìœ  í¬í•¨',
            '\n- ì†ì‹¤ë¶„ì„ì€ ë„ë©”ì¸ë³„ ì™„ê²°ëœ ë³´ê³ ì„œ í˜•íƒœë¡œ ì—°ê²°',
            '\n- ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼., í˜•ì‹: ì „ë¬¸ì  ë³´ê³ ì„œ'
          ].join('');
          // âš ï¸ ë ˆê±°ì‹œ ë¸”ë¡ - ì¤‘ë³µ ë³´ê³ ì„œ ìƒì„± ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬
          // í˜„ì¬ëŠ” generateStepByStepReport()ë¥¼ í†µí•´ í†µí•© ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ë¯€ë¡œ
          // ì´ ë¸”ë¡ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ìƒì„± ë° "ë³´ê³ ì„œ ì•ˆì— ë³´ê³ ì„œ" ë¬¸ì œ í•´ê²°)
          /*
          try {
            // GPT4 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
            document.getElementById('gpt4-system').value = roles.gpt4_final || '';
            
            // GPT4ëŠ” ê²°ë¡  ë¶€ë¶„ë§Œ ìƒì„±í•˜ê³ , ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ì™€ í•©ì¹˜ê¸°
            const conclusionOnlyPrompt = `${gpt4InputChain}

=== ê²°ë¡  ì„¹ì…˜ë§Œ ì‘ì„± ìš”ì²­ ===
ìœ„ ëª¨ë“  ë¶„ì„ ë‚´ìš©ì„ ê²€í† í•œ í›„, ì¦‰ì‹œ ì˜ì‚¬ê²°ì •í•  ìˆ˜ ìˆë„ë¡ ë‹¤ìŒ ê²°ë¡  ì„¹ì…˜ë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”:

## 6. ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­

### 6.1 í•µì‹¬ ë¦¬ìŠ¤í¬ ìš”ì•½
- ìµœìš°ì„  ê´€ë¦¬ ëŒ€ìƒ: [ê°€ì¥ ì‹¬ê°í•œ ë¦¬ìŠ¤í¬ 3ê°œ]
- ì´ ì˜ˆìƒ ì†ì‹¤ ê·œëª¨: [â—‹â—‹ì–µì›] (ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì¤€)
- ì¦‰ì‹œ ëŒ€ì‘ í•„ìš” ì˜ì—­: [ê¸´ê¸‰ë„ ìˆœ]

### 6.2 ìš°ì„ ìˆœìœ„ë³„ ì•¡ì…˜ ì•„ì´í…œ
**ì¦‰ì‹œ ì‹¤í–‰ (24ì‹œê°„ ë‚´):**
1. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]
2. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]
3. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]

**ë‹¨ê¸° ëŒ€ì‘ (1ì£¼ì¼ ë‚´):**
1. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]
2. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]

**ì¤‘ê¸° ì „ëµ (1ê°œì›” ë‚´):**
1. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]
2. [êµ¬ì²´ì  ì¡°ì¹˜ì‚¬í•­]

### 6.3 ì˜ì‚¬ê²°ì • ì§€ì› ì •ë³´
- ì´ì‚¬íšŒ ë³´ê³  í•„ìš” ì‚¬í•­: [í•µì‹¬ 3ê°œ í•­ëª©]
- ê·œì œê¸°ê´€ ë³´ê³  í•„ìš” ì—¬ë¶€: [Yes/No ë° ì‚¬ìœ ]
- ëŒ€ì™¸ ê³µì‹œ ê²€í†  ì‚¬í•­: [í•„ìš”ì‹œ]
- ì¶”ê°€ ìì› ì†Œìš”: [ì¸ë ¥/ì˜ˆì‚°/ì‹œìŠ¤í…œ]

ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

            const gpt4Conclusion = await callOpenAI(roles.gpt4_final, conclusionOnlyPrompt);
            
            // ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ë“¤ê³¼ GPT4 ê²°ë¡ ì„ í•©ì³ì„œ ì™„ì „í•œ ë³´ê³ ì„œ ìƒì„±
            const completeReport = [
              '# ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ',
              '',
              '## 1. ê¸°ì´ˆ ë¶„ì„ ê²°ê³¼',
              '',
              '### 1.1 ì‹œì¥ë°ì´í„° ë¶„ì„',
              gpt0MarketData || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ',
              '',
              '### 1.2 ë‰´ìŠ¤ ë° ë¦¬ìŠ¤í¬ ë¶„ì„', 
              gpt0News || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ',
              '',
              '### 1.3 ì‹œë‚˜ë¦¬ì˜¤ ìƒì„¸ ë¶„ì„',
              gpt0ScenarioSummary || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ',
              '',
              '### 1.4 í˜„ì¬ ì‹œì¥ ìƒí™©',
              gpt0MarketState || 'ë¶„ì„ ë°ì´í„° ì—†ìŒ',
              '',
              '## 2. ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´',
              '',
              '### 2.1 ì‹œì¥ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.market || 'ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ì—†ìŒ',
              '',
              '### 2.2 ì‹ ìš©ë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.credit || 'ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ì—†ìŒ',
              '',
              '### 2.3 ALM ì‹œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.alm || 'ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ì—†ìŒ',
              '',
              '### 2.4 ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì‹œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.global || 'ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ì—†ìŒ',
              '',
              '### 2.5 ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì‹œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.creditpf || 'ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ì—†ìŒ',
              '',
              '## 3. ë„ë©”ì¸ë³„ ì†ì‹¤ë¶„ì„ ê²°ê³¼',
              '',
              outMarket || '',
              '',
              outCredit || '',
              '',
              outAlm || '',
              '',
              outGlobal || '',
              '',
              outCreditPf || '',
              '',
              '## 4. ì¢…í•© ë¶„ì„',
              '',
              gpt4Conclusion || 'ê²°ë¡  ìƒì„± ì‹¤íŒ¨'
            ].join('\n');

            document.getElementById('gpt4-output').value = completeReport;
          } catch(e) {
            document.getElementById('gpt4-output').value = 'GPT4 ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ ì´ì „ ë‹¨ê³„ ê²°ê³¼ëŠ” ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.';
          }
          */
          c4?.classList.remove('running'); c4?.classList.add('done');
          // GPT4 ì™„ë£Œ í›„ PPT ì¶œë ¥ ì˜ì—­ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤ ë° CTA ê°•ì¡° í‘œì‹œ
          const panel = document.getElementById('gpt1-panel');
          const pptBtn = document.getElementById('btn-export-ppt');
          if (panel && pptBtn && !window.__userDraggingTab) {
            const pptHeader = document.getElementById('gpt4-header-row');
            const anchor = pptHeader || pptBtn;
            panel.scrollTo({ top: (anchor.offsetTop || pptBtn.offsetTop) - 40, behavior: 'smooth' });
            pptBtn.classList.add('ppt-cta');
            // ìˆ˜ ì´ˆ í›„ ìë™ìœ¼ë¡œ ê°•ì¡° í•´ì œ (ì§€ì† ë¶€ë‹´ ì¤„ì´ê¸°)
            setTimeout(()=> pptBtn.classList.remove('ppt-cta'), 6000);
          }
        } finally {
          window.dispatchEvent(new CustomEvent('gpt4:done'));
        }
        }
        if (stage === 'gpt4') {
          status.textContent = 'GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì¤‘...'; status.classList.add('status-shine'); setFlow('.to-gpt4'); setRunning(['.gpt4-anchor'], ['.gpt1-anchor','.gpt2-anchor']);
          c4?.classList.add('running'); c4?.classList.remove('done');
          
          // ====== ìƒˆë¡œìš´ GPT4 ì¡°ë¦½ ë¡œì§ ì ìš© (runFrom ê²½ë¡œ) ======
          console.log('ğŸš€ runFrom GPT4: ìƒˆë¡œìš´ ì¡°ë¦½ ë¡œì§ ì ìš©');
          
          // DOMì—ì„œ ë°ì´í„° ì½ê¸°
          const gpt0MarketDataRun = document.getElementById('gpt0-marketdata').value || '';
          const gpt0NewsRun = document.getElementById('gpt0-news').value || '';
          const gpt0ScenarioSummaryRun = document.getElementById('gpt0-scenario-summary').value || '';
          const gpt0MarketStateRun = document.getElementById('gpt0-marketstate').value || '';
          const gpt2OutputRun = document.getElementById('gpt2-output').value || '';
          
          // ì ì§„ì  GPT4 ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¹„ë™ê¸° í•¨ìˆ˜
          (async () => {
            try {
              console.log('ğŸš€ runFrom: ì ì§„ì  GPT4 ì²˜ë¦¬ ì‹œì‘');
              
              // GPT4 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
              document.getElementById('gpt4-system').value = roles.gpt4_final || '';
              
              // generateStepByStepReport í˜¸ì¶œ (ì´ë¯¸ ì ì§„ì  ì²˜ë¦¬ êµ¬í˜„ë¨)
              const gpt4Output = await generateStepByStepReport(roles.gpt4_final);
              
              console.log('âœ… runFrom: ì ì§„ì  GPT4 ì²˜ë¦¬ ì™„ë£Œ');
              
            } catch (error) {
              console.error('âŒ runFrom GPT4 ì˜¤ë¥˜:', error);
              document.getElementById('gpt4-output').value = `GPT4 ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            } finally {
              // ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
              c4?.classList.remove('running'); 
              c4?.classList.add('done');
              status.textContent = 'GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì™„ë£Œ';
              status.classList.remove('status-shine');
              
              // PPT ì¶œë ¥ ì˜ì—­ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤ ë° CTA ê°•ì¡° í‘œì‹œ
              const panel = document.getElementById('gpt1-panel');
              const pptBtn = document.getElementById('btn-export-ppt');
              if (panel && pptBtn && !window.__userDraggingTab) {
                const pptHeader = document.getElementById('gpt4-header-row');
                const anchor = pptHeader || pptBtn;
                panel.scrollTo({ top: (anchor.offsetTop || pptBtn.offsetTop) - 40, behavior: 'smooth' });
                pptBtn.classList.add('ppt-cta');
                setTimeout(() => pptBtn.classList.remove('ppt-cta'), 6000);
              }
            }
          })();
        }
        status.textContent = 'ì™„ë£Œ'; status.classList.remove('status-shine');
        graphState.pipelineRunning = false;
        stopAllEffects();
        setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        // âœ… runFrom ê²½ë¡œì—ì„œë„ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰ (í†µí•©ëœ ì™„ë£Œ ì²˜ë¦¬ ë³´ì¥)
        window.dispatchEvent(new CustomEvent('gpt4:done'));
      } catch(e) {
        status.textContent = `ì‹¤íŒ¨: ${e.message}`; status.classList.remove('status-shine');
        graphState.pipelineRunning = false;
        stopAllEffects();
        setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        // ì—ëŸ¬ ì‹œ GPT1ê³¼ GPT2ì˜ ì§„í–‰ íš¨ê³¼ ì œê±°
        document.querySelectorAll('.gpt1-module-box, .gpt2-module-box')
          .forEach(el => el.classList.remove('pipeline-executing'));
      }
    }

    // ====== GPT1â†’GPT2â†’GPT3 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ======
    async function runAgentPipeline() {
      const baseMessage = document.getElementById('gpt1-message').value?.trim();
      const status = document.getElementById('send-status');
      if (!baseMessage) {
        status.textContent = 'ë³´ë‚¼ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      try {
        // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œì‘ ì‹œ ì˜¤ë¥¸ìª½ íŒ¨ë„ë¡œ ìë™ ì´ë™
        const panel = document.getElementById('gpt1-panel');
        if (panel) {
          // (ê¶Œì¥) ì‚¬ìš©ìê°€ í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì´ë©´ ìë™ ìŠ¤í¬ë¡¤ ê°œì… ê¸ˆì§€
          if (window.__userDraggingTab) return;

          // âœ… GPT1 ~ GPT2 ë°•ìŠ¤ "ì¤‘ê°„" ì§€ì ìœ¼ë¡œ ìŠ¤í¬ë¡¤
          const pick = (sels) => sels.map(s => document.querySelector(s)).find(Boolean);
          // GPT1/GPT2 ì•µì»¤ í›„ë³´(ì¡´ì¬í•˜ëŠ” ì²« ìš”ì†Œ ì‚¬ìš©) â€” í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ë„‰ë„‰íˆ ì»¤ë²„
          const g1 = pick([
            '#card-gpt1', '#gpt1-output-box', '#gpt1-input-box', '#gpt1-output',
            '.gpt1-anchor', '[data-agent="gpt1"]'
          ]);
          const g2 = pick([
            '#card-gpt2', '#gpt2-output-box', '#gpt2-output',
            '.gpt2-anchor', '[data-agent="gpt2"]'
          ]);

          const off = (el) => (el && typeof el.offsetTop === 'number') ? el.offsetTop : null;
          const y1 = off(g1), y2 = off(g2);

          let targetY;
          if (y1 != null && y2 != null) {
            // ë‘ ë°•ìŠ¤ì˜ ì¤‘ì•™ê°’ - ìƒë‹¨ íŒ¨ë”©(40px)
            targetY = Math.max(0, ((y1 + y2) / 2) - 40);
          } else if (y1 != null) {
            // GPT1ë§Œ ìˆì„ ë•ŒëŠ” GPT1 ìƒë‹¨ìœ¼ë¡œ
            targetY = Math.max(0, y1 - 40);
          } else if (y2 != null) {
            // GPT2ë§Œ ìˆì„ ë•ŒëŠ” GPT2 ìƒë‹¨ìœ¼ë¡œ
            targetY = Math.max(0, y2 - 40);
          } else {
            // ìµœí›„ í´ë°±(ìš”ì†Œë¥¼ ëª» ì°¾ì€ ê²½ìš°ë§Œ)
            targetY = 0;
          }

          panel.scrollTo({ top: targetY, behavior: 'smooth' });
        }
        
        // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ìƒíƒœ ì„¤ì •
        graphState.pipelineRunning = true;
        
        // API í‚¤ ì‚¬ì „ ê²€ì¦
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = 'âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = 'í‚¤ ë¡œë”© ì¤‘...';
        // ğŸ”’ ë³´ì•ˆ: getOpenAIAuthHeaders ì œê±°ë¨ - callOpenAI í•¨ìˆ˜ ì‚¬ìš©

        // risk_engì—ì„œ ì—ì´ì „íŠ¸ ì—­í•  ìš”ê±´ ì¶”ì¶œ
        const roles = await loadRiskAgentRoles();
        // ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
        const uiGpt1 = document.getElementById('gpt1-system').value?.trim();
        const uiGpt2 = document.getElementById('gpt2-system').value?.trim();
        if (uiGpt1) roles.gpt1 = uiGpt1;
        if (uiGpt2) roles.gpt2 = uiGpt2;

        // ì§„í–‰ í‘œì‹œ ë„ìš°ë¯¸
        const setRunning = (onSelectors = [], offSelectors = []) => {
          offSelectors.forEach(sel => d3.selectAll(sel).classed('agent-running', false));
          onSelectors.forEach(sel => d3.selectAll(sel).classed('agent-running', true));
        };

        // GPT0 ë‹¨ê³„ (ì‚¬ì „ìˆ˜ì§‘) - ì•ˆì •ì„± ê°œì„ 
        status.textContent = 'GPT0 ì‚¬ì „ìˆ˜ì§‘ ì¤‘...';
        gotoStep(PipelineStep.GPT0);
        setRunning(['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate'], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        try {
          await runGpt0All();
          console.log('âœ… GPT0 ë‹¨ê³„ ì™„ë£Œ, GPT1 ë‹¨ê³„ë¡œ ì§„í–‰');
        } catch (e) {
          console.error('âŒ GPT0 ë‹¨ê³„ ì‹¤íŒ¨:', e);
          status.textContent = `GPT0 ë‹¨ê³„ ì‹¤íŒ¨: ${e.message}`;
          throw e; // íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨
        }

        // GPT1 ë‹¨ê³„
        status.textContent = 'GPT1 ì²˜ë¦¬ ì¤‘...';
        gotoStep(PipelineStep.GPT1);
        setRunning(['.gpt1-anchor'], ['.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        // GPT1 ì…ë ¥: GPT0 ëª¨ë“  ëª¨ë“ˆ ì¶œë ¥ ì¢…í•©
        const gpt1Input = buildGpt1InputFromGpt0Outputs();
        const gpt1Output = await callOpenAI(roles.gpt1, gpt1Input);
        document.getElementById('gpt1-output').value = gpt1Output || '';
        updateGpt2ButtonState(); // UI ìƒíƒœ ì—…ë°ì´íŠ¸

        // GPT2 ë‹¨ê³„ (ë„ë©”ì¸ë³„ ë§ì¶¤ ë¶„ì„ ìë£Œ ìƒì„±)
        status.textContent = 'GPT2 ë„ë©”ì¸ë³„ ë¶„ì„ ìë£Œ ìƒì„± ì¤‘...';
        gotoStep(PipelineStep.GPT2);
        setRunning(['.gpt2-anchor'], ['.gpt1-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        const gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
        
        // GPT2 ê²°ê³¼ë¥¼ ê¸°ì¡´ ì˜ì—­ì— ìƒì„¸ ë‚´ìš©ìœ¼ë¡œ í‘œì‹œ
        const gpt2Detail = `=== ê·¹í•œ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ì‚°ì¶œ) ===

[ì‹œì¥ë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.market || '(ìƒì„±ì‹¤íŒ¨)'}

[ì‹ ìš©ë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.credit || '(ìƒì„±ì‹¤íŒ¨)'}

[ALMíŒ€]
${gpt2DomainOutputs.alm || '(ìƒì„±ì‹¤íŒ¨)'}

[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬íŒ€]
${gpt2DomainOutputs.global || '(ìƒì„±ì‹¤íŒ¨)'}

[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤íŒ€]
${gpt2DomainOutputs.creditpf || '(ìƒì„±ì‹¤íŒ¨)'}
`;
        
        document.getElementById('gpt2-output').value = gpt2Detail;
        autoGrow(['gpt2-output']);

        // GPT2 ì¢…ë£Œ í›„ â†’ GPT3 ìë™ ì‹¤í–‰
        status.textContent = 'GPT3 ë„ë©”ì¸ ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì¤‘...'; status.classList.add('status-shine');
        setFlow('.to-gpt3');
        setRunning(['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'],
                   ['.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']);
        c3?.classList.add('running'); c3?.classList.remove('done');

        // ê° ë„ë©”ì¸ë³„ ë§ì¶¤ ì…ë ¥ êµ¬ì„± + ì‹¤í–‰
        const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€ì´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
        const g3Calls = [
          callOpenAIWithOptions(roles.gpt3_market, gpt2DomainOutputs.market + GL('market'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_credit, gpt2DomainOutputs.credit + GL('credit'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_alm,    gpt2DomainOutputs.alm    + GL('alm'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_global, gpt2DomainOutputs.global + GL('global'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_creditpf, gpt2DomainOutputs.creditpf + GL('creditpf'), { timeoutMs: 1200000 }),
        ];
        const [outMarket, outCredit, outAlm, outGlobal, outCreditPf] =
          (await Promise.allSettled(g3Calls)).map(r => r.status==='fulfilled' ? (r.value||'') : '');

        // âœ… GPT3 ì‚°ì¶œë¬¼ DOM ì €ì¥ (í›„ì† ë‹¨ê³„/ë³´ê³ ì„œì—ì„œ ì°¸ì¡°)
        document.getElementById('gpt3-market').value   = outMarket || '';
        document.getElementById('gpt3-credit').value   = outCredit || '';
        document.getElementById('gpt3-alm').value      = outAlm || '';
        document.getElementById('gpt3-global').value   = outGlobal || '';
        document.getElementById('gpt3-creditpf').value = outCreditPf || '';
        autoGrow(['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf']);

        // DOM ê¸°ë¡ ì§í›„ ì „ì—­ë„ ë™ì¼ ê°’ìœ¼ë¡œ ë™ê¸°í™”
        window.globalGpt3Outputs = {
          market: (outMarket || '').trim(),
          credit: (outCredit || '').trim(),
          alm:    (outAlm || '').trim(),
          global: (outGlobal || '').trim(),
          creditpf:(outCreditPf || '').trim()
        };

        c3?.classList.remove('running'); c3?.classList.add('done');
        document.getElementById('gpt1-panel')?.scrollTo({
          top: document.getElementById('card-gpt4')?.offsetTop - 20,
          behavior: 'smooth'
        });

        // GPT4 ìµœì¢… ì·¨í•©
        status.textContent = (outMarket||outCredit||outAlm||outGlobal||outCreditPf) ? 'GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì¤‘...' : 'GPT3 ì‹¤íŒ¨ í›„ GPT4 ì§„í–‰';
        console.log('ğŸš€ GPT4 ë‹¨ê³„ ì‹œì‘');
        
        // GPT4 ì‹œì‘ ì‹œì ì—ë§Œ GPT4ë¡œ ì´ë™
        gotoStep(PipelineStep.GPT4);
        setRunning(['.gpt4-anchor'], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf']);
        
        // âœ… GPT4 100ì´ˆ íƒ€ì´ë¨¸ ì„¤ì • - ì™„ë£Œ ì•ˆë˜ì–´ë„ ê°•ì œë¡œ ì „ì²´ í‘œì‹œ
        if (window.gpt4ForceCompleteTimer) clearTimeout(window.gpt4ForceCompleteTimer);
        window.gpt4ForceCompleteTimer = setTimeout(() => {
          console.log('â° GPT4 100ì´ˆ íƒ€ì´ë¨¸ ì™„ë£Œ - ê°•ì œë¡œ ì „ì²´ ë°•ìŠ¤ í‘œì‹œ');
          
          // ì „ì²´ ë°•ìŠ¤ í‘œì‹œ
          if (window.revealAllRightTabBoxes) {
            window.revealAllRightTabBoxes();
          }
          
          // ë³´ê³ ì„œ ì˜ì—­ í‘œì‹œ ë° ê°•ì¡°
          const reportActions = document.getElementById('report-actions');
          if (reportActions) {
            reportActions.style.display = 'flex';
            reportActions.classList.add('report-actions-cta');
            console.log('âœ… ë³´ê³ ì„œ ì‘ì—… ì˜ì—­ í‘œì‹œ ë° ê°•ì¡°');
            
            // 4ì´ˆ í›„ ê°•ì¡° íš¨ê³¼ ì œê±°
            setTimeout(() => {
              reportActions.classList.remove('report-actions-cta');
            }, 4000);
          }
          
          // íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì²˜ë¦¬
          document.body.classList.add('pipeline-complete');
          
          // ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
          try { 
            window.dispatchEvent(new Event('gpt4:complete')); 
            window.dispatchEvent(new Event('gpt4:done')); 
          } catch (e) {}
          
          console.log('âœ… GPT4 100ì´ˆ ê°•ì œ ì™„ë£Œ ì²˜ë¦¬ë¨');
        }, 100000); // 100ì´ˆ
        console.log('â±ï¸ GPT4 100ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘ë¨');
        
        // GPT0 ë°ì´í„° ìˆ˜ì§‘
        const gpt0MarketDataMain = document.getElementById('gpt0-marketdata').value || '';
        const gpt0NewsMain = document.getElementById('gpt0-news').value || '';
        const gpt0ScenarioSummaryMain = document.getElementById('gpt0-scenario-summary').value || '';
        const gpt0MarketStateMain = document.getElementById('gpt0-marketstate').value || '';
        
        // GPT1, GPT2 ë°ì´í„° ìˆ˜ì§‘ (ê¸°ì¡´ ë³€ìˆ˜ ì¬ì‚¬ìš©)
        const gpt1OutputValue = document.getElementById('gpt1-output').value || '';
        const gpt2OutputValue = document.getElementById('gpt2-output').value || '';
        
        // GPT4 ì…ë ¥ êµ¬ì„± ì „ ìƒì„¸ ë””ë²„ê¹… ë¡œê·¸
        console.log('ğŸ” GPT4 ì…ë ¥ êµ¬ì„± ì‹œì‘');
        console.log('ğŸ“Š GPT0 ë§ˆì¼“ë°ì´í„°:', gpt0MarketDataMain ? `ìˆìŒ (${gpt0MarketDataMain.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ“° GPT0 ë‰´ìŠ¤:', gpt0NewsMain ? `ìˆìŒ (${gpt0NewsMain.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ“‹ GPT0 ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½:', gpt0ScenarioSummaryMain ? `ìˆìŒ (${gpt0ScenarioSummaryMain.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸŒ GPT0 í˜„ì¬ ì‹œí™©:', gpt0MarketStateMain ? `ìˆìŒ (${gpt0MarketStateMain.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ§  GPT1 ì¶œë ¥:', gpt1OutputValue ? `ìˆìŒ (${gpt1OutputValue.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ”— GPT2 ì¶œë ¥:', gpt2OutputValue ? `ìˆìŒ (${gpt2OutputValue.length}ì)` : 'ì—†ìŒ');
        
        // âœ… ì•ˆì „í•œ DOM ì½ê¸°ë¡œ GPT3 ê²°ê³¼ í™•ì¸
        const g3M = (document.getElementById('gpt3-market').value || '').trim();
        const g3C = (document.getElementById('gpt3-credit').value || '').trim();
        const g3A = (document.getElementById('gpt3-alm').value || '').trim();
        const g3G = (document.getElementById('gpt3-global').value || '').trim();
        const g3P = (document.getElementById('gpt3-creditpf').value || '').trim();

        console.log('ğŸ¤– GPT3 ì‹œì¥ë¦¬ìŠ¤í¬:',      g3M ? `ìˆìŒ (${g3M.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ¤– GPT3 ì‹ ìš©ë¦¬ìŠ¤í¬:',      g3C ? `ìˆìŒ (${g3C.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ¤– GPT3 ALM:',            g3A ? `ìˆìŒ (${g3A.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ¤– GPT3 ê¸€ë¡œë²Œë¦¬ìŠ¤í¬:',     g3G ? `ìˆìŒ (${g3G.length}ì)` : 'ì—†ìŒ');
        console.log('ğŸ¤– GPT3 ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤:',   g3P ? `ìˆìŒ (${g3P.length}ì)` : 'ì—†ìŒ');
        
        const gpt4Input = [
          'ë‹¤ìŒ ì •ë³´ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì²´ê³„ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
          '\n\n=== GPT0 ì‚¬ì „ìˆ˜ì§‘ ë¶„ì„ ê²°ê³¼ ===',
          '\n[ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„° ë¶„ì„]\n', gpt0MarketDataMain,
          '\n\n[ê¸°ì‚¬ë‰´ìŠ¤ ë¶„ì„]\n', gpt0NewsMain, 
          '\n\n[ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ë¶„ì„]\n', gpt0ScenarioSummaryMain,

          '\n\n[í˜„ì¬ ì‹œí™©ë¶„ì„]\n', gpt0MarketStateMain,
          '\n\n=== GPT3 ë„ë©”ì¸ë³„ ì „ë¬¸ ë¶„ì„ ê²°ê³¼ ===',
          '\n[ì‹œì¥ë¦¬ìŠ¤í¬ íŒ€ ë¶„ì„]\n', outMarket || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ',
          '\n\n[ì‹ ìš©ë¦¬ìŠ¤í¬ íŒ€ ë¶„ì„]\n', outCredit || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ',
          '\n\n[ALM íŒ€ ë¶„ì„]\n', outAlm || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ',
          '\n\n[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ íŒ€ ë¶„ì„]\n', outGlobal || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ',
          '\n\n[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ íŒ€ ë¶„ì„]\n', outCreditPf || 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ',
          (()=>{ const g=window.gpt3Guidelines||{}; const all=[g.market,g.credit,g.alm,g.global,g.creditpf].filter(Boolean).join('\n'); return all?`\n\n[ì°¸ì¡° ê°€ì´ë“œ]\n${all}`:''; })(),
          '\n\n=== ì‘ì„± ìš”ì²­ ===',
          '\nìœ„ ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ 7ê°œ ì„¹ì…˜ìœ¼ë¡œ êµ¬ì„±ëœ ì²´ê³„ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.',
          '\nê° ì„¹ì…˜ì€ ëª…í™•í•œ ì†Œì£¼ì œì™€ í•¨ê»˜ êµ¬ì²´ì ì¸ ë°ì´í„°ì™€ ë¶„ì„ ë‚´ìš©ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.',
          '\n\n=== ì¤‘ìš” ìš”êµ¬ì‚¬í•­ ===',
          '\nì¶œë ¥ì–¸ì–´: í•œêµ­ì–´ (ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•˜ë¼)',
          '\në³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.',
          '\në³´ê³ ì„œ í˜•ì‹: ì²´ê³„ì ì´ê³  ì „ë¬¸ì ì¸ ë³´ê³ ì„œ',
          '\në‚´ìš©: êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë¶„ì„ ê²°ê³¼ì™€ ëŒ€ì‘ ë°©ì•ˆ'
        ].join('');
        
        // GPT4 ì…ë ¥ êµ¬ì„± ì™„ë£Œ í›„ ë¡œê·¸
        console.log('ğŸ“ GPT4 ì…ë ¥ êµ¬ì„± ì™„ë£Œ');
        console.log('ğŸ“ GPT4 ì…ë ¥ ì´ ê¸¸ì´:', gpt4Input.length);
        console.log('ğŸ” GPT4 ì…ë ¥ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 500ì):', gpt4Input.substring(0, 500));
        
        try {
          // GPT4 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
          document.getElementById('gpt4-system').value = roles.gpt4_final || '';
          
          console.log('ğŸš€ GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì‹œì‘ (runFrom)');
          const gpt4Output = await generateStepByStepReport(roles.gpt4_final);
          console.log('âœ… GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì™„ë£Œ (runFrom)');
          
          // âœ… GPT4 ì •ìƒ ì™„ë£Œ ì‹œ íƒ€ì´ë¨¸ ì·¨ì†Œ
          if (window.gpt4ForceCompleteTimer) {
            clearTimeout(window.gpt4ForceCompleteTimer);
            window.gpt4ForceCompleteTimer = null;
            console.log('â±ï¸ GPT4 ì •ìƒ ì™„ë£Œë¡œ 100ì´ˆ íƒ€ì´ë¨¸ ì·¨ì†Œë¨');
          }
          
          try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
          if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
          console.log('ğŸ“Š GPT4 ì¶œë ¥ ê¸¸ì´:', gpt4Output ? gpt4Output.length : 0);
          
          // ë³´ê³ ì„œ ì˜ì—­ í‘œì‹œ ë° ê°•ì¡°
          const reportActions = document.getElementById('report-actions');
          if (reportActions) {
            reportActions.style.display = 'flex';
            reportActions.classList.add('report-actions-cta');
            setTimeout(() => {
              reportActions.classList.remove('report-actions-cta');
            }, 4000);
          }
          
          // âœ… ì•ˆì „í•œ ì¶œë ¥ ì—…ë°ì´íŠ¸: ìœ íš¨í•œ ê²°ê³¼ê°€ ìˆì„ ë•Œë§Œ ì“°ê¸°
          if (gpt4Output && gpt4Output.trim().length > 0) {
            document.getElementById('gpt4-output').value = gpt4Output;
            console.log('ğŸ“ GPT4 ì¶œë ¥ ì—…ë°ì´íŠ¸ë¨ (runFrom)');
          } else {
            console.log('âš ï¸ GPT4 ì¶œë ¥ì´ ë¹„ì–´ìˆìŒ, ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€ (runFrom)');
            document.getElementById('gpt4-output').value = 'GPT4 ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          }
        } catch (e) {
          console.error('âŒ GPT4 OpenAI API í˜¸ì¶œ ì‹¤íŒ¨:', e);
          document.getElementById('gpt4-output').value = 'GPT4 ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ ì´ì „ ë‹¨ê³„ ê²°ê³¼ëŠ” ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.';
        } finally {
          // âœ… GPT3/4 ê´€ë ¨ ì‹¤í–‰ íš¨ê³¼ ì œê±° (ë°•ìŠ¤ íš¨ê³¼ê°€ ë‚¨ëŠ” ë¬¸ì œ ì˜ˆë°©)
          setFlow(null);
          d3.selectAll('.gpt3-anchor-market, .gpt3-anchor-credit, .gpt3-anchor-alm, .gpt3-anchor-global, .gpt3-anchor-creditpf, .gpt4-anchor')
            .classed('agent-running', false);
          document.querySelectorAll('.pipeline-executing').forEach(el => el.classList.remove('pipeline-executing'));
          document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
            .forEach(el => el.classList.remove('running'));
        }

      status.textContent = 'íŒŒì´í”„ë¼ì¸ ì™„ë£Œ';
      // ëª¨ë“  íš¨ê³¼ ì¢…ë£Œ
      stopAllEffects();
      setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        // íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ìƒíƒœ ì •ë¦¬
        graphState.pipelineRunning = false;
        graphState.lockedHighlight = null;
        
      } catch (e) {
        console.error('âŒ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', e);
        status.textContent = `íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨: ${e.message}`;
        
        // ì˜¤ë¥˜ ì‹œì—ë„ ìƒíƒœ ì •ë¦¬
        graphState.pipelineRunning = false;
        graphState.lockedHighlight = null;
        stopAllEffects();
        setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
      }
    }

    // ====== ì‚¬ìš©ì ë“œë˜ê·¸ ê°ì§€ ======
    // ì˜¤ë¥¸ìª½ íŒ¨ë„ ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ ê°ì§€
    function setupDragScrollDetection() {
      const rightPanel = document.getElementById('gpt1-panel');
      if (!rightPanel) return;
      
      let isDragging = false;
      let startY = 0;
      
      rightPanel.addEventListener('mousedown', (e) => {
        if (e.target.closest('textarea') || e.target.closest('button')) return;
        isDragging = true;
        startY = e.clientY;
        window.__userDraggingTab = true;
      });
      
      rightPanel.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaY = Math.abs(e.clientY - startY);
        if (deltaY > 5) { // 5px ì´ìƒ ì›€ì§ì˜€ì„ ë•Œë§Œ ë“œë˜ê·¸ë¡œ ì¸ì‹
          window.__userDraggingTab = true;
        }
      });
      
      rightPanel.addEventListener('mouseup', () => {
        isDragging = false;
        setTimeout(() => {
          window.__userDraggingTab = false;
        }, 100); // 100ms í›„ ìë™ ìŠ¤í¬ë¡¤ ì¬ê°œ
      });
      
      // í„°ì¹˜ ì´ë²¤íŠ¸ë„ ì§€ì›
      rightPanel.addEventListener('touchstart', (e) => {
        if (e.target.closest('textarea') || e.target.closest('button')) return;
        isDragging = true;
        startY = e.touches[0].clientY;
        window.__userDraggingTab = true;
      });
      
      rightPanel.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const deltaY = Math.abs(e.touches[0].clientY - startY);
        if (deltaY > 5) {
          window.__userDraggingTab = true;
        }
      });
      
      rightPanel.addEventListener('touchend', () => {
        isDragging = false;
        setTimeout(() => {
          window.__userDraggingTab = false;
        }, 100);
      });
    }

    // ====== ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°ì¡°ì • ======
    // ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°ì¡°ì • í•¨ìˆ˜ (ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆìš©)
    function resizeRightPanel(size) {
      const root = document.documentElement;
      const rightPanel = document.querySelector('.sidebar-right');
      
      switch(size) {
        case 'small':
          root.style.setProperty('--sidebar-width', '300px');
          if (rightPanel) rightPanel.style.width = '300px';
          updateTabSizeDisplay();
          adjustStylesForSize(300);
          console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°: ì‘ê²Œ (300px)');
          break;
        case 'medium':
          root.style.setProperty('--sidebar-width', '400px');
          if (rightPanel) rightPanel.style.width = '400px';
          updateTabSizeDisplay();
          adjustStylesForSize(400);
          console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°: ë³´í†µ (400px)');
          break;
        case 'large':
          root.style.setProperty('--sidebar-width', '500px');
          if (rightPanel) rightPanel.style.width = '500px';
          updateTabSizeDisplay();
          adjustStylesForSize(500);
          console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°: í¬ê²Œ (500px)');
          break;
        case 'auto':
          root.style.removeProperty('--sidebar-width');
          if (rightPanel) rightPanel.style.width = '400px';
          updateTabSizeDisplay();
          adjustStylesForSize(400);
          console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°: ìë™ (ê¸°ë³¸ê°’)');
          break;
        default:
          console.log('âŒ ì˜ëª»ëœ í¬ê¸° ì˜µì…˜:', size);
          return;
      }
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      localStorage.setItem('rightPanelSize', size);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í¬ê¸° ë³µì›
    function restoreRightPanelSize() {
      const savedSize = localStorage.getItem('rightPanelSize');
      const rightPanel = document.querySelector('.sidebar-right');
      
      if (savedSize) {
        if (savedSize === 'custom') {
          // ì»¤ìŠ¤í…€ í¬ê¸° ë³µì›
          const customWidth = localStorage.getItem('rightPanelCustomWidth');
          if (customWidth && rightPanel) {
            document.documentElement.style.setProperty('--sidebar-width', `${customWidth}px`);
            rightPanel.style.width = `${customWidth}px`;
            updateTabSizeDisplay();
            adjustStylesForSize(parseInt(customWidth));
            console.log(`ğŸ“ ì»¤ìŠ¤í…€ í¬ê¸° ë³µì›: ${customWidth}px`);
          } else {
            // ê¸°ë³¸ê°’ ì„¤ì •
            if (rightPanel) rightPanel.style.width = '400px';
            updateTabSizeDisplay();
            adjustStylesForSize(400);
            console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°: ê¸°ë³¸ê°’ (400px)');
          }
        } else {
          resizeRightPanel(savedSize);
        }
      } else {
        // ê¸°ë³¸ê°’ ì„¤ì •
        if (rightPanel) rightPanel.style.width = '400px';
        console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸°: ê¸°ë³¸ê°’ (400px)');
      }
    }

    // ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™” - ì œê±°ë¨
    function initializeDragResize() {
      // ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ì´ ì œê±°ë˜ì–´ ë¹ˆ í•¨ìˆ˜ë¡œ ìœ ì§€
      console.log('ğŸ”§ ë“œë˜ê·¸ ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    // í˜„ì¬ ë„ˆë¹„ì— ë§ëŠ” í¬ê¸° ì¸ì‹
    function updateButtonStateByWidth(width) {
      let size = 'custom';
      if (width <= 300) size = 'small';
      else if (width <= 400) size = 'medium';
      else if (width <= 500) size = 'large';
      
      console.log(`ğŸ“ í˜„ì¬ í¬ê¸° ì¸ì‹: ${size} (${width}px)`);
    }

          // ì´ˆê¸°í™” í•¨ìˆ˜
      function resetRightPanelSize() {
        // ì»¤ìŠ¤í…€ í¬ê¸° ì œê±°í•˜ê³  ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
        localStorage.removeItem('rightPanelCustomWidth');
        localStorage.removeItem('rightPanelSize');
        
        // ê¸°ë³¸ í¬ê¸°ë¡œ ì„¤ì •
        document.documentElement.style.removeProperty('--sidebar-width');
        const rightPanel = document.querySelector('.sidebar-right');
        if (rightPanel) rightPanel.style.width = '400px';
        updateTabSizeDisplay();
        adjustStylesForSize(400);
        
        console.log('ğŸ“ ì˜¤ë¥¸ìª½ íƒ­ í¬ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
      }

      // íƒ­ í¬ê¸° ì¡°ì • í•¨ìˆ˜ë“¤
      function increaseTabSize() {
        const rightPanel = document.querySelector('.sidebar-right');
        const sizeDisplay = document.getElementById('tab-size-display');
        
        if (rightPanel && sizeDisplay) {
          const currentWidth = parseInt(getComputedStyle(rightPanel).width) || 400;
          const newWidth = Math.min(800, currentWidth + 50);
          
          rightPanel.style.width = `${newWidth}px`;
          document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
          sizeDisplay.textContent = `${newWidth}px`;
          
          // ë™ì  ìŠ¤íƒ€ì¼ ì¡°ì •
          adjustStylesForSize(newWidth);
          
          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
          localStorage.setItem('rightPanelCustomWidth', newWidth);
          localStorage.setItem('rightPanelSize', 'custom');
          
          console.log(`ğŸ“ íƒ­ í¬ê¸° ì¦ê°€: ${currentWidth}px â†’ ${newWidth}px`);
        }
      }

      function decreaseTabSize() {
        const rightPanel = document.querySelector('.sidebar-right');
        const sizeDisplay = document.getElementById('tab-size-display');
        
        if (rightPanel && sizeDisplay) {
          const currentWidth = parseInt(getComputedStyle(rightPanel).width) || 400;
          const newWidth = Math.max(250, currentWidth - 50);
          
          rightPanel.style.width = `${newWidth}px`;
          document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
          sizeDisplay.textContent = `${newWidth}px`;
          
          // ë™ì  ìŠ¤íƒ€ì¼ ì¡°ì •
          adjustStylesForSize(newWidth);
          
          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
          localStorage.setItem('rightPanelCustomWidth', newWidth);
          localStorage.setItem('rightPanelSize', 'custom');
          
          console.log(`ğŸ“ íƒ­ í¬ê¸° ê°ì†Œ: ${currentWidth}px â†’ ${newWidth}px`);
        }
      }

      // íƒ­ í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateTabSizeDisplay() {
        const rightPanel = document.querySelector('.sidebar-right');
        const sizeDisplay = document.getElementById('tab-size-display');
        
        if (rightPanel && sizeDisplay) {
          const currentWidth = parseInt(getComputedStyle(rightPanel).width) || 400;
          sizeDisplay.textContent = `${currentWidth}px`;
        }
      }

      // íƒ­ í¬ê¸°ì— ë”°ë¥¸ ë™ì  ìŠ¤íƒ€ì¼ ì¡°ì • í•¨ìˆ˜
      function adjustStylesForSize(width) {
        const rightPanel = document.querySelector('.sidebar-right');
        if (!rightPanel) return;

        // ì œëª© í¬ê¸° ì¡°ì •
        const titles = rightPanel.querySelectorAll('h4');
        titles.forEach(title => {
          if (width >= 700) {
            title.style.fontSize = '20px';
          } else if (width >= 600) {
            title.style.fontSize = '18px';
          } else if (width >= 500) {
            title.style.fontSize = '16px';
          } else {
            title.style.fontSize = '14px';
          }
        });

        // ì¹´ë“œ íŒ¨ë”© ì¡°ì •
        const cards = rightPanel.querySelectorAll('.agent-card');
        cards.forEach(card => {
          if (width >= 700) {
            card.style.padding = '20px';
          } else if (width >= 600) {
            card.style.padding = '18px';
          } else if (width >= 500) {
            card.style.padding = '16px';
          } else {
            card.style.padding = '14px';
          }
        });

        // í…ìŠ¤íŠ¸ ì˜ì—­ í¬ê¸° ì¡°ì •
        const textareas = rightPanel.querySelectorAll('textarea');
        textareas.forEach(textarea => {
          if (width >= 700) {
            textarea.style.fontSize = '18px';
            textarea.style.padding = '10px';
          } else if (width >= 600) {
            textarea.style.fontSize = '16px';
            textarea.style.padding = '8px';
          } else if (width >= 500) {
            textarea.style.fontSize = '14px';
            textarea.style.padding = '6px';
          } else {
            textarea.style.fontSize = '13px';
            textarea.style.padding = '6px';
          }
        });

        // ë³µì‚¬ ë²„íŠ¼ í¬ê¸° ì¡°ì •
        const copyBtns = rightPanel.querySelectorAll('.copy-btn');
        copyBtns.forEach(btn => {
          if (width >= 700) {
            btn.style.fontSize = '14px';
            btn.style.padding = '8px 14px';
          } else if (width >= 600) {
            btn.style.fontSize = '13px';
            btn.style.padding = '7px 12px';
          } else if (width >= 500) {
            btn.style.fontSize = '12px';
            btn.style.padding = '6px 10px';
          } else {
            btn.style.fontSize = '11px';
            btn.style.padding = '5px 8px';
          }
        });

        // PPTìƒì„±, ë³´ê³ ì„œìƒì„± ë²„íŠ¼ í¬ê¸° ì¡°ì •
        const actionBtns = rightPanel.querySelectorAll('.action-btn');
        actionBtns.forEach(btn => {
          if (width >= 700) {
            btn.style.fontSize = '16px';
            btn.style.padding = '14px 20px';
          } else if (width >= 600) {
            btn.style.fontSize = '15px';
            btn.style.padding = '12px 18px';
          } else if (width >= 500) {
            btn.style.fontSize = '14px';
            btn.style.padding = '10px 16px';
          } else {
            btn.style.fontSize = '13px';
            btn.style.padding = '8px 14px';
          }
        });

        // í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì •
        const promptTexts = rightPanel.querySelectorAll('.prompt-text');
        promptTexts.forEach(text => {
          if (width >= 700) {
            text.style.fontSize = '15px';
          } else if (width >= 600) {
            text.style.fontSize = '14px';
          } else if (width >= 500) {
            text.style.fontSize = '13px';
          } else {
            text.style.fontSize = '12px';
          }
        });

        console.log(`ğŸ¨ ìŠ¤íƒ€ì¼ ì¡°ì • ì™„ë£Œ: ${width}px`);
      }

    // ====== ì‚¬í›„ ê²€ì¦ + ìë™ë³´ê°• í•¨ìˆ˜ ======
    function enforceEvidence(report, sources) {
      const need = [
        ['ì‹œì¥ ë¦¬ìŠ¤í¬','MARKET', sources.market],
        ['ì‹ ìš© ë¦¬ìŠ¤í¬','CREDIT', sources.credit],
        ['ALM','ALM', sources.alm],
        ['ê¸€ë¡œë²Œ ë¦¬ìŠ¤í¬','GLOBAL', sources.global],
        ['ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤','CREDITPF', sources.creditpf],
      ];
      let out = String(report||'');
      
      for(const [label, key, src] of need){
        const hasSec = new RegExp(`###\\s*${label}\\b`).test(out);
        if(!hasSec){
          out += `\n\n### ${label}\n${(src||'ìë£Œ ë¶€ì¡±').slice(0,1200)}`;
          continue;
        }
        
        // ì •ëŸ‰ì¹˜ 3ê°œ ë¯¸ë§Œì´ë©´ ì›ë¬¸ì—ì„œ ìˆ«ì 3ê°œë¥¼ ë¶ˆë¦¿ìœ¼ë¡œ ë³´ê°•
        const secRe = new RegExp(`(###\\s*${label}[\\s\\S]*?)(?=\\n###|$)`);
        const m = out.match(secRe);
        if(m){
          const body = m[1];
          const nNums = (body.match(/([+-]?[0-9][0-9.,]*\\s?(?:bp|%|ì¡°ì›|ì–µì›|ë°°|ì¼))/g)||[]).length;
          if(nNums<3){
            const picks = (String(src||'').match(/([+-]?[0-9][0-9.,]*\\s?(?:bp|%|ì¡°ì›|ì–µì›|ë°°|ì¼))/g)||[]).slice(0,3);
            if(picks.length){
              out = out.replace(secRe, `${body}\n\n- ë³´ê°• ìˆ˜ì¹˜: ${picks.join(', ')} [ê·¼ê±°: ì›ë¬¸]`);
            }
          }
        }
      }
      return out;
    }

    // ====== GPT4 ì ì§„ì  ë³´ê³ ì„œ ì‘ì„± (ìˆœì°¨ ì²˜ë¦¬) ======
    async function generateStepByStepReport(systemPrompt) {
      try {
        console.log('ğŸ“‹ GPT4 ì ì§„ì  ë³´ê³ ì„œ ì‘ì„± ì‹œì‘');
        
        // DOM ìš”ì†Œ í™•ì¸
        const gpt4OutputElement = document.getElementById('gpt4-output');
        if (!gpt4OutputElement) {
          throw new Error('GPT4 ì¶œë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        gpt4OutputElement.value = 'ğŸ“‹ GPT4 ë³´ê³ ì„œ ìƒì„± ì¤‘...\n\në‹¨ê³„ë³„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
        
        // ì…ë ¥ ìˆ˜ì§‘
        const gpt0ScenarioSummary = (document.getElementById('gpt0-scenario-summary').value || '').trim();
        const gpt0MarketData = (document.getElementById('gpt0-marketdata').value || '').trim();
        const gpt0News = (document.getElementById('gpt0-news').value || '').trim();
        const gpt0MarketState = (document.getElementById('gpt0-marketstate').value || '').trim();
        const gpt1Output = (document.getElementById('gpt1-output').value || '').trim();
        const gpt2Output = (document.getElementById('gpt2-output').value || '').trim();
        
        // âœ… GPT3 ì…ë ¥ í™•ì‹¤íˆ ìˆ˜ì§‘ (í›„ì† ë‹¨ê³„ì—ì„œ ë°˜ë“œì‹œ ì‚¬ìš©)
        /* DOM â†’ ì „ì—­ â†’ GPT2ì›ë³¸ ìˆœ í´ë°± */
        const G3 = window.globalGpt3Outputs || {};
        const G2 = window.globalGpt2DomainOutputs || {};

        const g3Market   = (document.getElementById('gpt3-market')?.value   || G3.market   || G2.market   || '').trim();
        const g3Credit   = (document.getElementById('gpt3-credit')?.value   || G3.credit   || G2.credit   || '').trim();
        const g3Alm      = (document.getElementById('gpt3-alm')?.value      || G3.alm      || G2.alm      || '').trim();
        const g3Global   = (document.getElementById('gpt3-global')?.value   || G3.global   || G2.global   || '').trim();
        const g3CreditPf = (document.getElementById('gpt3-creditpf')?.value || G3.creditpf || G2.creditpf || '').trim();

        /* GPT3 ì…ë ¥ì´ ëª¨ë‘ ë¹„ë©´ ìµœì†Œ ëŒ€ì²´ ìƒì„±(í•œ ë²ˆë§Œ) */
        if (![g3Market,g3Credit,g3Alm,g3Global,g3CreditPf].some(Boolean) && !window.__g3FallbackTried) {
          window.__g3FallbackTried = true;
          try {
            const roles = await loadRiskAgentRoles();
            const G2 = window.globalGpt2DomainOutputs || {};
            const [fm,fc,fa,fg,fp] = await Promise.all([
              callOpenAIWithOptions(roles.gpt3_market,   G2.market   || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_credit,   G2.credit   || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_alm,      G2.alm      || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_global,   G2.global   || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_creditpf, G2.creditpf || '', { timeoutMs: 1200000 })
            ]);
            window.globalGpt3Outputs = {
              market:(fm||'').trim(), credit:(fc||'').trim(), alm:(fa||'').trim(),
              global:(fg||'').trim(), creditpf:(fp||'').trim()
            };
          } catch(e){ console.warn('g3 ëŒ€ì²´ìƒì„± ì‹¤íŒ¨', e); }
        }

        // ====== ì ì§„ì  GPT4 ì¡°ë¦½ ë¡œì§ ì‹œì‘ ======
        console.log('ğŸš€ ì ì§„ì  GPT4 ì¡°ë¦½ ë¡œì§ ì ìš©');
        
        // 1ë‹¨ê³„: GPT0 ì„œë‘ ìš”ì•½ ìƒì„± ë° ì²« ë²ˆì§¸ GPT í˜¸ì¶œ
        console.log('ğŸ“ 1ë‹¨ê³„: GPT0 ì„œë‘ ìƒì„± ì¤‘...');
        gpt4OutputElement.value = 'ğŸ“ 1ë‹¨ê³„: ì‹œì¥ ìƒí™© ë° ì‹œë‚˜ë¦¬ì˜¤ ì„œë‘ ìƒì„± ì¤‘...\n\nâ€¢ GPT0 ë°ì´í„° ìš”ì•½ ì²˜ë¦¬ ì¤‘';
        
        const introText = await generateGpt4IntroSection({
          market: gpt0MarketData,
          scenario: gpt0ScenarioSummary, 
          news: gpt0News,
          state: gpt0MarketState
        });
        
        // 1ë‹¨ê³„ ê²°ê³¼ í‘œì‹œ
        gpt4OutputElement.value = `âœ… 1ë‹¨ê³„ ì™„ë£Œ: ì„œë‘ ìƒì„±\n\n${introText}\n\n` + 
                                  'ğŸ“ 2ë‹¨ê³„: ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ìƒì„± ì¤‘...';
        
        // 2ë‹¨ê³„: GPT2 ìš”ì†Œë³„ ì •ê·œí™” ë° ë‘ ë²ˆì§¸ GPT í˜¸ì¶œ
        console.log('ğŸ“ 2ë‹¨ê³„: GPT2 ìš”ì†Œë³„ ë¶„ì„ ì¤‘...');
        const gpt2ProcessedText = await generateGpt4ElementSection(gpt2Output);
        
        // 2ë‹¨ê³„ ê²°ê³¼ ì¶”ê°€
        gpt4OutputElement.value = `âœ… 1ë‹¨ê³„ ì™„ë£Œ: ì„œë‘\n\n${introText}\n\n` +
                                  `âœ… 2ë‹¨ê³„ ì™„ë£Œ: ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼\n\n${gpt2ProcessedText}\n\n` +
                                  'ğŸ“ 3ë‹¨ê³„: ë„ë©”ì¸ë³„ ì‹¬ì¸µ ë¶„ì„ ìƒì„± ì¤‘...';
        
        // 3ë‹¨ê³„: GPT3 ë”¥ë‹¤ì´ë¸Œ ë° ì„¸ ë²ˆì§¸ GPT í˜¸ì¶œ
        console.log('ğŸ“ 3ë‹¨ê³„: GPT3 ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ì¤‘...');
        const gpt3ProcessedText = await generateGpt4DeepDiveSection({
          market: g3Market,
          credit: g3Credit,
          alm: g3Alm,
          global: g3Global,
          creditpf: g3CreditPf
        });
        
        // âœ… 4ë‹¨ê³„(ì¬ìš”ì•½) ê±´ë„ˆëœ€: ìš”ì•½3ê¹Œì§€ë§Œ ê²°í•©í•´ì„œ ìµœì¢… ê²°ê³¼ë¡œ ì‚¬ìš©
        console.log('â­ï¸ GPT4 4ë‹¨ê³„(ì¬ìš”ì•½) ê±´ë„ˆëœ€ - ìš”ì•½3ê¹Œì§€ë§Œ ì‚¬ìš©');

        // 1~3ë‹¨ê³„ ê²°ê³¼ë¥¼ ì§ì ‘ ê²°í•©í•˜ì—¬ ìµœì¢… ê²°ê³¼ë¡œ ì‚¬ìš©
        const combined = [
          '=== 1. ì„œë‘ ===',
          introText || '',
          '',
          '=== 2. ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ===',
          gpt2ProcessedText || '',
          '',
          '=== 3. ë„ë©”ì¸ë³„ ì‹¬ì¸µ ë¶„ì„ ===',
          gpt3ProcessedText || ''
        ].join('\n');

        // ìµœì¢… ê²°ê³¼ í‘œì‹œ
        gpt4OutputElement.value = combined;
        
        console.log('âœ… GPT4 ì ì§„ì  ë³´ê³ ì„œ ì‘ì„± ì™„ë£Œ');
        try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
        if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
        return combined;
      } catch (error) {
        console.error('âŒ GPT4 í†µí•© ë³´ê³ ì„œ ì‘ì„± ì‹¤íŒ¨:', error);
        // âœ… ì˜¤ë¥˜ ì‹œì—ë„ ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  ì˜ë¯¸ìˆëŠ” ë©”ì‹œì§€ ë°˜í™˜
        return `GPT4 í†µí•© ë³´ê³ ì„œ ì‘ì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}\n\nì´ì „ ë‹¨ê³„ì˜ ë¶„ì„ ê²°ê³¼ëŠ” ê° íƒ­ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
      }
    }

    // ====== GPT3 ê²°ê³¼ ê¸¸ì´ í™•ì¸ ë””ë²„ê·¸ í•¨ìˆ˜ ======
    window.checkGpt3Results = function() {
      console.log('ğŸ” GPT3 ë„ë©”ì¸ë³„ ê²°ê³¼ ê¸¸ì´ í™•ì¸:');
      ['market','credit','alm','global','creditpf'].forEach(k=>{
        const v = (document.getElementById('gpt3-'+k).value||'').trim();
        const status = v.length < 50 ? 'âŒ ë„ˆë¬´ ì§§ìŒ' : v.length < 200 ? 'âš ï¸ ì§§ìŒ' : 'âœ… ì •ìƒ';
        console.log(`${k}: ${v.length}ì ${status}`);
        if (v.length < 50) {
          console.log(`  ë‚´ìš©: "${v.substring(0, 100)}..."`);
        }
      });
    };

    // ====== ìµœì¢… ë³´ê³ ì„œ ì„¹ì…˜ í™•ì¸ ë””ë²„ê·¸ í•¨ìˆ˜ ======
    window.checkFinalReportSections = function() {
      console.log('ğŸ” ìµœì¢… ë³´ê³ ì„œ ì„¹ì…˜ í™•ì¸:');
      const report = (document.getElementById('gpt4-output').value||'').trim();
      const sections = ['ì‹œì¥ë¦¬ìŠ¤í¬', 'ì‹ ìš©ë¦¬ìŠ¤í¬', 'ALM', 'ê¸€ë¡œë²Œë¦¬ìŠ¤í¬', 'ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤'];
      sections.forEach(section => {
        const regex = new RegExp(`###\\s*${section}\\b`, 'i');
        const found = regex.test(report);
        console.log(`${section}: ${found ? 'âœ… ì¡´ì¬' : 'âŒ ëˆ„ë½'}`);
      });
      console.log(`ì´ ë³´ê³ ì„œ ê¸¸ì´: ${report.length}ì`);
    };

    // 1ë‹¨ê³„: ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ë¶„ì„ ë³´ê³ ì„œ
    async function generateScenarioSection(systemPrompt) {
      try {
        const gpt0ScenarioSummary = document.getElementById('gpt0-scenario-summary').value || '';
        const gpt1Output = document.getElementById('gpt1-output').value || '';
        const gpt2Output = document.getElementById('gpt2-output').value || '';
        
        const prompt = `ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´]
- ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½: ${gpt0ScenarioSummary}
- GPT1 ì¢…í•© ë¶„ì„: ${gpt1Output}
- GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤: ${gpt2Output}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹œë‚˜ë¦¬ì˜¤ì˜ í•µì‹¬ ë‚´ìš©, ë¦¬ìŠ¤í¬ ìš”ì¸, ì „ê°œ ë°©í–¥ì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ì‹œë‚˜ë¦¬ì˜¤ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 2ë‹¨ê³„: ë§ˆì¼“ë°ì´í„° ë° ì‹œì¥ì •ë³´ ë¶„ì„ ë³´ê³ ì„œ
    async function generateMarketSection(systemPrompt) {
      try {
        const gpt0MarketData = document.getElementById('gpt0-marketdata').value || '';
        const gpt0MarketState = document.getElementById('gpt0-marketstate').value || '';
        
        const prompt = `ë§ˆì¼“ë°ì´í„° ë° ì‹œì¥ì •ë³´ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[í˜„ì¬ ì‹œì¥ìƒí™©]
- ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„°: ${gpt0MarketData}
- í˜„ì¬ ì‹œí™©ë¶„ì„: ${gpt0MarketState}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í˜„ì¬ ì‹œì¥ ìƒí™©, ì£¼ìš” ì§€í‘œ ë™í–¥, ì‹œì¥ ë¦¬ìŠ¤í¬ ìš”ì¸ì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ë§ˆì¼“ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ë§ˆì¼“ë°ì´í„° ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 3ë‹¨ê³„: ê´€ë ¨ë‰´ìŠ¤ ë¶„ì„ ë³´ê³ ì„œ
    async function generateNewsSection(systemPrompt) {
      try {
        const gpt0News = document.getElementById('gpt0-news').value || '';
        
        const prompt = `ê´€ë ¨ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ê´€ë ¨ë‰´ìŠ¤ ë¶„ì„]
- ê¸°ì‚¬ë‰´ìŠ¤ ìš”ì•½: ${gpt0News}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‰´ìŠ¤ì˜ í•µì‹¬ ë‚´ìš©, ì‹œë‚˜ë¦¬ì˜¤ì™€ì˜ ì—°ê´€ì„±, ë¦¬ìŠ¤í¬ íŠ¸ë¦¬ê±° ìš”ì¸ì„ ì •ë¦¬í•˜ì—¬ 2-3ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ë‰´ìŠ¤ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ë‰´ìŠ¤ ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 4ë‹¨ê³„: ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ
    async function generateMarketRiskSection(systemPrompt) {
      try {
        const gpt3Market = document.getElementById('gpt3-market').value || '';
        
        const prompt = `ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„]
- GPT3 ì‹œì¥ë¦¬ìŠ¤í¬ ê²°ê³¼: ${gpt3Market}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì€í–‰ í˜„í™©, ì‹œë‚˜ë¦¬ì˜¤ ì˜í–¥ë„, ëŒ€ì‘ì „ëµì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ì‹œì¥ë¦¬ìŠ¤í¬ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 5ë‹¨ê³„: ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ
    async function generateCreditRiskSection(systemPrompt) {
      try {
        const gpt3Credit = document.getElementById('gpt3-credit').value || '';
        
        const prompt = `ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„]
- GPT3 ì‹ ìš©ë¦¬ìŠ¤í¬ ê²°ê³¼: ${gpt3Credit}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì€í–‰ í˜„í™©, ì‹œë‚˜ë¦¬ì˜¤ ì˜í–¥ë„, ëŒ€ì‘ì „ëµì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ì‹ ìš©ë¦¬ìŠ¤í¬ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 6ë‹¨ê³„: ALM ë¶„ì„ ë³´ê³ ì„œ
    async function generateAlmSection(systemPrompt) {
      try {
        const gpt3Alm = document.getElementById('gpt3-alm').value || '';
        
        const prompt = `ALM ë¶„ì„ ê²°ê³¼ë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ALM ë¶„ì„]
- GPT3 ALM ê²°ê³¼: ${gpt3Alm}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì€í–‰ í˜„í™©, ì‹œë‚˜ë¦¬ì˜¤ ì˜í–¥ë„, ëŒ€ì‘ì „ëµì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ALM ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ALM ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 7ë‹¨ê³„: ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ
    async function generateGlobalRiskSection(systemPrompt) {
      try {
        const gpt3Global = document.getElementById('gpt3-global').value || '';
        
        const prompt = `ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„]
- GPT3 ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ê²°ê³¼: ${gpt3Global}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì€í–‰ í˜„í™©, ì‹œë‚˜ë¦¬ì˜¤ ì˜í–¥ë„, ëŒ€ì‘ì „ëµì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // 8ë‹¨ê³„: ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ë³´ê³ ì„œ
    async function generateCreditPortfolioSection(systemPrompt) {
      try {
        const gpt3CreditPf = document.getElementById('gpt3-creditpf').value || '';
        
        const prompt = `ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ë¥¼ ë‹¤ìŒ êµ¬ì¡°ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„]
- GPT3 ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ê²°ê³¼: ${gpt3CreditPf}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì€í–‰ í˜„í™©, ì‹œë‚˜ë¦¬ì˜¤ ì˜í–¥ë„, ëŒ€ì‘ì „ëµì„ ì •ë¦¬í•˜ì—¬ 3-4ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì„¹ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì‹¤íŒ¨';
      }
    }

    // ìµœì¢… í†µí•© ë³´ê³ ì„œ ì‘ì„±
    async function generateFinalIntegrationReport(systemPrompt, ...sectionReports) {
      try {
        const prompt = `ê° ë‹¨ê³„ë³„ë¡œ ì‘ì„±ëœ ë³´ê³ ì„œë“¤ì„ í†µí•©í•˜ì—¬ ìµœì¢… ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

[ë‹¨ê³„ë³„ ë¶„ì„ ê²°ê³¼]
1. ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´: ${sectionReports[0]}
2. ë§ˆì¼“ë°ì´í„° ë° ì‹œì¥ì •ë³´: ${sectionReports[1]}
3. ê´€ë ¨ë‰´ìŠ¤: ${sectionReports[2]}
4. ì‹œì¥ë¦¬ìŠ¤í¬: ${sectionReports[3]}
5. ì‹ ìš©ë¦¬ìŠ¤í¬: ${sectionReports[4]}
6. ALM: ${sectionReports[5]}
7. ê¸€ë¡œë²Œë¦¬ìŠ¤í¬: ${sectionReports[6]}
8. ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤: ${sectionReports[7]}

ìœ„ 8ê°œ ì„¹ì…˜ì„ ì¢…í•©í•˜ì—¬ ë‹¤ìŒ êµ¬ì¡°ì˜ ì²´ê³„ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

## ì†Œì£¼ì œë³„ êµ¬ì„±
1. [ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´] ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„, í˜„ì¬ìƒí™©, ìœ„ê¸°ìƒí™©ë¶„ì„ ì‹œë®¬ë ˆì´ì…˜ ê°€ì • (ì •ëŸ‰ì  ì¶©ê²© ì‹œë‚˜ë¦¬ì˜¤ ìˆ˜ì¹˜ í¬í•¨)
2. [í˜„ì¬ ì‹œì¥ìƒí™©] ë§ˆì¼“ë°ì´í„° ë° ì‹œí™© ë¶„ì„ ìš”ì•½
3. [ìœ„ê¸°ìƒí™© ë¶„ì„] WORST ì‹œë‚˜ë¦¬ì˜¤ ë° ì „ê°œë°©í–¥ (êµ¬ì²´ì  ë³€ë™ ìˆ˜ì¹˜ í¬í•¨)

## ë³¸ë¬¸ - ëª¨ë“ˆë³„ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜
4. [ì‹œì¥ë¦¬ìŠ¤í¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (VaR, P&L, ë¯¼ê°ë„) â†’ ëŒ€ì‘ëª©í‘œ
5. [ì‹ ìš©ë¦¬ìŠ¤í¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (ë¶€ë„ìœ¨, ì†ì‹¤ì•¡, ECL) â†’ ëŒ€ì‘ëª©í‘œ
6. [ìì‚°ë¶€ì±„ê´€ë¦¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (NIM, ìœ ë™ì„±ë¹„ìœ¨, BPë³€í™”) â†’ ëŒ€ì‘ëª©í‘œ
7. [ê¸€ë¡œë²Œë¦¬ìŠ¤í¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (í™˜ì†ìµ, ìµìŠ¤í¬ì €, CDS) â†’ ëŒ€ì‘ëª©í‘œ
8. [ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (ì†ì‹¤ì•¡, ì§‘ì¤‘ë„, HHI) â†’ ëŒ€ì‘ëª©í‘œ

## ìµœì¢… ì •ë¦¬
9. [ì¢…í•© ì˜í–¥ë„ í‰ê°€] ëª¨ë“  ëª¨ë“ˆì˜ ì •ëŸ‰ì  ì˜í–¥ë„ë¥¼ í†µí•© (ì´ ì†ì‹¤ì•¡, RWA ì¦ê°€, ìë³¸ë¹„ìœ¨ ë³€ë™ ì¶”ì •)
10. [í†µí•© ëŒ€ì‘ì „ëµ] ì „ì‚¬ ì°¨ì› ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ìš°ì„ ìˆœìœ„
11. [ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­] í•µì‹¬ ì •ëŸ‰ì§€í‘œ ë° ê²½ì˜ì§„ ì•¡ì…˜ì•„ì´í…œ

â€» ëª¨ë“  ì„¹ì…˜ì—ì„œ êµ¬ì²´ì  ìˆ˜ì¹˜, ê¸ˆì•¡, í¼ì„¼íŠ¸, BP ë“± ì •ëŸ‰ì  ë¶„ì„ê²°ê³¼ë¥¼ ëª…ì‹œí•˜ë¼.
ì¶œë ¥ì–¸ì–´: í•œêµ­ì–´. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. (ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•˜ë¼)
ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ìµœì¢… í†µí•© ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨:', error);
        return 'ìµœì¢… í†µí•© ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨';
      }
    }

    // ğŸ”’ ì•ˆì „í•œ OpenAI í”„ë¡ì‹œ í˜¸ì¶œ (Netlify Functions ì „ìš©) + ë¡œì»¬ ëŒ€ì²´ ê²½ë¡œ
    async function callOpenAI(systemPrompt, userContent = {}, retryCount = 0) {
      // í”„ë¡ì‹œë¥¼ í†µí•œ ì•ˆì „í•œ ìš”ì²­ (API í‚¤ëŠ” ì„œë²„ì—ì„œë§Œ ì‚¬ìš©)
      const body = {
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt || 'You are a helpful assistant.' },
          { role: 'user', content: userContent }
        ],
        max_tokens: 16000,  // ì¶©ë¶„í•œ í† í° í• ë‹¹ (GPT0 ê¸´ ì‘ë‹µ ëŒ€ì‘)
        temperature: 0.1
      };
      
      console.log('ğŸ”„ ì•ˆì „í•œ OpenAI í”„ë¡ì‹œ í˜¸ì¶œ ì‹œì‘...', retryCount > 0 ? `(ì¬ì‹œë„ ${retryCount}/3)` : '');
      
      // AbortControllerë¡œ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ (600ì´ˆ = 10ë¶„ìœ¼ë¡œ ì—°ì¥)
      const controller = new AbortController();
      const timeoutMs = 600000; // 10ë¶„ íƒ€ì„ì•„ì›ƒ (ê¸´ ì‘ë‹µ ëŒ€ì‘)
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
      
      let data;
      try {
        // 1) í”„ë¡ì‹œ ìš°ì„  ì‹œë„ (í˜„í–‰ ìœ ì§€)
        const resp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // Authorization í—¤ë” ì—†ìŒ - ì„œë²„ì—ì„œ í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
          },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({ error:'Unknown error' }));
          // 404, MISSING_API_KEY, ì„œë²„ì˜¤ë¥˜ ë“±ì€ "ëŒ€ì²´ ê²½ë¡œ"ë¡œ ë„˜ê¹€
          throw Object.assign(new Error(`proxy_error_${resp.status}`), { code: errData.code || 'PROXY_ERROR', status: resp.status });
        }
        data = await resp.json();
      } catch (proxyErr) {
        clearTimeout(timeoutId);
        console.warn('âš ï¸ í”„ë¡ì‹œ ì‹¤íŒ¨, ë¡œì»¬ ëŒ€ì²´ ê²½ë¡œ ì‹œë„:', proxyErr);

        // 2) ë¡œì»¬ ê°œë°œ ì „ìš©: localStorage í‚¤ê°€ ìˆìœ¼ë©´ OpenAI ì§ì ‘ í˜¸ì¶œ(í…ŒìŠ¤íŠ¸ìš©)
        try {
          const localKey = (localStorage && localStorage.getItem('openai_api_key')) || '';
          if (!localKey) throw new Error('NO_LOCAL_KEY');

          const direct = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                { role:'system', content: systemPrompt || 'You are a helpful assistant.' },
                { role:'user',   content: userContent }
              ],
              max_tokens: 16000,
              temperature: 0.1
            })
          });
          if (!direct.ok) throw new Error(`DIRECT_${direct.status}`);
          data = await direct.json();
        } catch (directErr) {
          console.error('âŒ í”„ë¡ì‹œ/ì§ì ‘ ëª¨ë‘ ì‹¤íŒ¨:', directErr);
          
          // ì¬ì‹œë„ ë¡œì§: ìµœëŒ€ 3íšŒê¹Œì§€ ì¬ì‹œë„
          if (retryCount < 3) {
            console.log(`ğŸ”„ ${retryCount + 1}ì´ˆ í›„ ì¬ì‹œë„... (${retryCount + 1}/3)`);
            await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 2000)); // ì ì§„ì  ëŒ€ê¸° (2ì´ˆ, 4ì´ˆ, 6ì´ˆ)
            return await callOpenAI(systemPrompt, userContent, retryCount + 1);
          }
          
          // ìµœì¢… ì‹¤íŒ¨ ì‹œ ìƒìœ„ì—ì„œ ë¹ˆ ì‘ë‹µ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
          console.error('âŒ ìµœì¢… ì‹¤íŒ¨: 3íšŒ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨');
          return '';
        }
      }

      // ê³µí†µ íŒŒì‹±
      const outputText =
        data?.choices?.[0]?.message?.content ||
        data?.output_text ||
        data?.response?.[0]?.content?.[0]?.text ||
        '';
      return (outputText || '').trim();
    }

    // ====== í”„ë¡ì‹œ ì ê²€ ìœ í‹¸ë¦¬í‹° ======
    
    // ê°„ë‹¨í•œ GPT3 í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
    async function testGpt3Simple() {
      console.log('ğŸ§ª GPT3 ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
      
      try {
        // 1. ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¡œ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸
        const testPrompt = "ì•ˆë…•í•˜ì„¸ìš”. ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. 'í…ŒìŠ¤íŠ¸ ì„±ê³µ'ì´ë¼ê³  ì‘ë‹µí•´ì£¼ì„¸ìš”.";
        const result = await callOpenAI("You are a helpful assistant.", testPrompt);
        
        console.log('âœ… GPT3 í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
        
        // 2. ê²°ê³¼ë¥¼ ì²« ë²ˆì§¸ GPT3 ë°•ìŠ¤ì— í‘œì‹œ
        const el = document.getElementById('gpt3-market');
        if (el) {
          el.value = result || 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ì‘ë‹µ ì—†ìŒ';
          console.log('âœ… GPT3 ë°•ìŠ¤ì— ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
        } else {
          console.error('âŒ gpt3-market ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        return result;
      } catch (error) {
        console.error('âŒ GPT3 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        return null;
      }
    }
    
    // OpenAI í”„ë¡ì‹œ ìƒíƒœ ì ê²€ í•¨ìˆ˜
    async function testOpenAIProxy() {
      console.log('ğŸ” OpenAI í”„ë¡ì‹œ ìƒíƒœ ì ê²€ ì‹œì‘...');
      
      try {
        const resp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'You are a helpful assistant.' },
              { role: 'user', content: 'Hello' }
            ],
            max_tokens: 10,
            temperature: 0.1
          })
        });
        
        if (resp.ok) {
          const data = await resp.json();
          console.log('âœ… í”„ë¡ì‹œ ì •ìƒ ì‘ë™:', data?.choices?.[0]?.message?.content || 'ì‘ë‹µ ì—†ìŒ');
          return true;
        } else {
          const errData = await resp.json().catch(() => ({ error: 'Unknown error' }));
          console.error('âŒ í”„ë¡ì‹œ ì˜¤ë¥˜:', resp.status, errData);
          
          if (resp.status === 404) {
            console.error('í”„ë¡ì‹œ í•¨ìˆ˜ê°€ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Netlify ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          } else if (errData.code === 'MISSING_API_KEY') {
            console.error('Netlify í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          }
          return false;
        }
      } catch (error) {
        console.error('âŒ í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨:', error.message);
        return false;
      }
    }

    // ====== GPT4ìš© ìƒˆ í—¬í¼ í•¨ìˆ˜ë“¤ ======
    
    // GPT0 ì„œë‘ ìš”ì•½ API í—¬í¼ í•¨ìˆ˜
    async function summarizeForGpt4FromGpt0({ market, scenario, news, state }) {
      try {
        console.log('ğŸ“‹ GPT0 ì„œë‘ ìš”ì•½ API í˜¸ì¶œ ì‹œì‘');
        
        const systemPrompt = "ë³´ê³ ì„œ ì„œë‘ ì „ìš© ìš”ì•½ê¸°. ì¤‘ë³µ ì œê±°, ìˆ˜ì¹˜Â·ë¦¬ìŠ¤í¬ í¬ì¸íŠ¸ ìš°ì„ , 10~12ì¤„, ë¶ˆë¦¿ ê¸ˆì§€, ì™„ì „ë¬¸ì¥.";
        
        const userContent = [
          market || '',
          scenario || '',
          state || '',
          news || ''
        ].filter(text => text.trim()).join('\n\n');
        
        if (!userContent.trim()) {
          return "ì‹œì¥ ë°ì´í„° ë° ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
        }
        
        const result = await callOpenAI(systemPrompt, userContent);
        console.log('âœ… GPT0 ì„œë‘ ìš”ì•½ ì™„ë£Œ');
        return result || "ì„œë‘ ìš”ì•½ ìƒì„± ì‹¤íŒ¨";
        
      } catch (error) {
        console.error('âŒ GPT0 ì„œë‘ ìš”ì•½ ì‹¤íŒ¨:', error);
        return `ì„œë‘ ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // GPT2 ìš”ì†Œë³„ ì •ê·œí™” API í—¬í¼ í•¨ìˆ˜
    async function normalizeGpt2ForGpt4(gpt2Raw) {
      try {
        console.log('ğŸ“‹ GPT2 ìš”ì†Œë³„ ì •ê·œí™” API í˜¸ì¶œ ì‹œì‘');
        
        if (!gpt2Raw || gpt2Raw.trim().length < 10) {
          const fallback = {
            market: "GPT2 ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
            credit: "GPT2 ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±", 
            alm: "GPT2 ALM ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
            global: "GPT2 ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
            creditpf: "GPT2 ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
            unifiedText: `=== ë¦¬ìŠ¤í¬ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼(GPT2) ===

## ì‹œì¥ë¦¬ìŠ¤í¬
GPT2 ì‹œì¥ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±

## ì‹ ìš©ë¦¬ìŠ¤í¬  
GPT2 ì‹ ìš©ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±

## ALM
GPT2 ALM ë¶„ì„ ê²°ê³¼ ë¶€ì¡±

## ê¸€ë¡œë²Œë¦¬ìŠ¤í¬
GPT2 ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±

## ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤
GPT2 ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ ë¶€ì¡±`
          };
          return fallback;
        }
        
        const systemPrompt = `GPT2 ì‚°ì¶œë¬¼ì„ ë„ë©”ì¸ë³„ë¡œ ê¹”ë”íˆ ë¶„í•´Â·ì •ë¦¬í•˜ëŠ” í¸ì§‘ê¸°. í‘œì œì–´ ê³ ì •, ì¤‘ë³µÂ·ì¥í™© ì œê±°, í•µì‹¬ ìˆ˜ì¹˜ ìœ ì§€.

ì¶œë ¥ í˜•ì‹:
{
  "market": "ì‹œì¥ë¦¬ìŠ¤í¬ ê´€ë ¨ ë‚´ìš©ë§Œ ì¶”ì¶œí•˜ì—¬ ì •ë¦¬",
  "credit": "ì‹ ìš©ë¦¬ìŠ¤í¬ ê´€ë ¨ ë‚´ìš©ë§Œ ì¶”ì¶œí•˜ì—¬ ì •ë¦¬", 
  "alm": "ALM ê´€ë ¨ ë‚´ìš©ë§Œ ì¶”ì¶œí•˜ì—¬ ì •ë¦¬",
  "global": "ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ê´€ë ¨ ë‚´ìš©ë§Œ ì¶”ì¶œí•˜ì—¬ ì •ë¦¬",
  "creditpf": "ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨ ë‚´ìš©ë§Œ ì¶”ì¶œí•˜ì—¬ ì •ë¦¬"
}

ê° ë„ë©”ì¸ë³„ë¡œ ê´€ë ¨ ë‚´ìš©ì„ ì¶”ì¶œí•˜ë˜, í•µì‹¬ ìˆ˜ì¹˜ì™€ ë¶„ì„ ê²°ê³¼ë¥¼ í¬í•¨í•˜ì—¬ 3-5ë¬¸ì¥ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.`;
        
        const result = await callOpenAI(systemPrompt, gpt2Raw);
        console.log('âœ… GPT2 ì •ê·œí™” ì›ì‹œ ê²°ê³¼ ìˆ˜ì‹ ');
        
        let parsed = {};
        try {
          // JSON íŒŒì‹± ì‹œë„
          parsed = JSON.parse(result);
        } catch (parseError) {
          console.warn('âš ï¸ GPT2 ì •ê·œí™” ê²°ê³¼ JSON íŒŒì‹± ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
          // íŒŒì‹± ì‹¤íŒ¨ì‹œ ì›ë¬¸ì„ ê° ë„ë©”ì¸ì— ë¶„ë°°
          const fallbackContent = result.slice(0, 200) + "...";
          parsed = {
            market: fallbackContent,
            credit: fallbackContent,
            alm: fallbackContent, 
            global: fallbackContent,
            creditpf: fallbackContent
          };
        }
        
        // unifiedText ìƒì„±
        const unifiedText = `=== ë¦¬ìŠ¤í¬ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼(GPT2) ===

## ì‹œì¥ë¦¬ìŠ¤í¬
${parsed.market || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±"}

## ì‹ ìš©ë¦¬ìŠ¤í¬
${parsed.credit || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±"}

## ALM
${parsed.alm || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±"}

## ê¸€ë¡œë²Œë¦¬ìŠ¤í¬
${parsed.global || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±"}

## ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤
${parsed.creditpf || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±"}`;
        
        const finalResult = {
          market: parsed.market || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
          credit: parsed.credit || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
          alm: parsed.alm || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±", 
          global: parsed.global || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
          creditpf: parsed.creditpf || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡±",
          unifiedText: unifiedText
        };
        
        console.log('âœ… GPT2 ìš”ì†Œë³„ ì •ê·œí™” ì™„ë£Œ');
        return finalResult;
        
      } catch (error) {
        console.error('âŒ GPT2 ìš”ì†Œë³„ ì •ê·œí™” ì‹¤íŒ¨:', error);
        const errorResult = {
          market: `ì •ê·œí™” ì‹¤íŒ¨: ${error.message}`,
          credit: `ì •ê·œí™” ì‹¤íŒ¨: ${error.message}`,
          alm: `ì •ê·œí™” ì‹¤íŒ¨: ${error.message}`,
          global: `ì •ê·œí™” ì‹¤íŒ¨: ${error.message}`,
          creditpf: `ì •ê·œí™” ì‹¤íŒ¨: ${error.message}`,
          unifiedText: `=== ë¦¬ìŠ¤í¬ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼(GPT2) ===

ì •ê·œí™” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`
        };
        return errorResult;
      }
    }

    // ====== GPT4 ë‹¨ê³„ë³„ ì²˜ë¦¬ í•¨ìˆ˜ë“¤ ======
    
    // 1ë‹¨ê³„: GPT0 ì„œë‘ ìƒì„± (GPT API ë¯¸ì‚¬ìš© - ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)
    async function generateGpt4IntroSection({ market, scenario, news, state }) {
      try {
        console.log('ğŸ“ GPT4 1ë‹¨ê³„: ì„œë‘ ìƒì„± ì‹œì‘ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        
        // GPT API í˜¸ì¶œ ì—†ì´ ê¸°ì¡´ ì¶œë ¥ëœ ë‚´ìš©ë“¤ì„ ì§ì ‘ ê²°í•©
        const sections = [];
        
        sections.push('## ì‹œì¥ ìƒí™© ë° ì‹œë‚˜ë¦¬ì˜¤ ê°œìš”\n');
        
        if (scenario && scenario.trim()) {
          sections.push('### ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„');
          sections.push(scenario.trim());
          sections.push('');
        }
        
        if (market && market.trim()) {
          sections.push('### ì‹œì¥ë°ì´í„° ë¶„ì„');
          sections.push(market.trim());
          sections.push('');
        }
        
        if (news && news.trim()) {
          sections.push('### ë‰´ìŠ¤ ë° ë¦¬ìŠ¤í¬ ë¶„ì„');
          sections.push(news.trim());
          sections.push('');
        }
        
        if (state && state.trim()) {
          sections.push('### í˜„ì¬ ì‹œì¥ ìƒí™©');
          sections.push(state.trim());
          sections.push('');
        }
        
        const result = sections.join('\n');
        console.log('âœ… GPT4 1ë‹¨ê³„: ì„œë‘ ìƒì„± ì™„ë£Œ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        return result || "ì„œë‘ ìƒì„± ì‹¤íŒ¨ - ë°ì´í„° ì—†ìŒ";
        
      } catch (error) {
        console.error('âŒ GPT4 1ë‹¨ê³„ ì„œë‘ ìƒì„± ì‹¤íŒ¨:', error);
        return `ì„œë‘ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // 2ë‹¨ê³„: GPT2 ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ìƒì„± (GPT API ë¯¸ì‚¬ìš© - ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)
    async function generateGpt4ElementSection(gpt2Raw) {
      try {
        console.log('ğŸ“ GPT4 2ë‹¨ê³„: ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì‹œì‘ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        
        // GPT API í˜¸ì¶œ ì—†ì´ GPT2 ì¶œë ¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const sections = [];
        
        sections.push('## ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼\n');
        
        if (gpt2Raw && gpt2Raw.trim()) {
          sections.push(gpt2Raw.trim());
        } else {
          sections.push('ë°ì´í„° ì—†ìŒ');
        }
        
        const result = sections.join('\n');
        console.log('âœ… GPT4 2ë‹¨ê³„: ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì™„ë£Œ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        return result || "ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ìƒì„± ì‹¤íŒ¨";
        
      } catch (error) {
        console.error('âŒ GPT4 2ë‹¨ê³„ ìš”ì†Œë³„ ë¶„ì„ ì‹¤íŒ¨:', error);
        return `ìš”ì†Œë³„ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // 3ë‹¨ê³„: GPT3 ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ìƒì„± (GPT API ë¯¸ì‚¬ìš© - ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)
    async function generateGpt4DeepDiveSection({ market, credit, alm, global, creditpf }) {
      try {
        console.log('ğŸ“ GPT4 3ë‹¨ê³„: ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ì‹œì‘ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        
        // GPT API í˜¸ì¶œ ì—†ì´ GPT3ì˜ ê° ë„ë©”ì¸ë³„ ì¶œë ¥ì„ ì§ì ‘ ê²°í•©
        const sections = [];
        
        sections.push('## ë„ë©”ì¸ë³„ ì‹¬ì¸µ ë¶„ì„\n');
        
        if (market && market.trim()) {
          sections.push('### ì‹œì¥ë¦¬ìŠ¤í¬ ì‹¬í™” ë¶„ì„');
          sections.push(market.trim());
          sections.push('');
        }
        
        if (credit && credit.trim()) {
          sections.push('### ì‹ ìš©ë¦¬ìŠ¤í¬ ì‹¬í™” ë¶„ì„');
          sections.push(credit.trim());
          sections.push('');
        }
        
        if (alm && alm.trim()) {
          sections.push('### ALM ì‹¬í™” ë¶„ì„');
          sections.push(alm.trim());
          sections.push('');
        }
        
        if (global && global.trim()) {
          sections.push('### ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ì‹¬í™” ë¶„ì„');
          sections.push(global.trim());
          sections.push('');
        }
        
        if (creditpf && creditpf.trim()) {
          sections.push('### ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ì‹¬í™” ë¶„ì„');
          sections.push(creditpf.trim());
          sections.push('');
        }
        
        const result = sections.join('\n');
        console.log('âœ… GPT4 3ë‹¨ê³„: ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ì™„ë£Œ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        return result || "ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ìƒì„± ì‹¤íŒ¨ - ë°ì´í„° ì—†ìŒ";
        
      } catch (error) {
        console.error('âŒ GPT4 3ë‹¨ê³„ ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ì‹¤íŒ¨:', error);
        return `ë”¥ë‹¤ì´ë¸Œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // âœ… 4ë‹¨ê³„: ìµœì¢… í†µí•© ë³´ê³ ì„œ ìƒì„± í•¨ìˆ˜ ì œê±°ë¨ (ì¬ìš”ì•½ ë°©ì§€)
    // ì´ì œ generateStepByStepReportì—ì„œ 1-3ë‹¨ê³„ ê²°ê³¼ë¥¼ ì§ì ‘ ê²°í•©í•˜ì—¬ ì‚¬ìš©

    // ğŸ”’ ì˜µì…˜ ì§€ì • ê°€ëŠ¥í•œ OpenAI í˜¸ì¶œ (í† í°/ì˜¨ë„/ëª¨ë¸ ì¡°ì ˆìš©)
    async function callOpenAIWithOptions(systemPrompt, userContent = {}, options = {}) {
      const body = {
        model: options.model || 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt || 'You are a helpful assistant.' },
          { role: 'user', content: userContent }
        ],
        max_tokens: typeof options.max_tokens === 'number' ? options.max_tokens : 3000,
        temperature: typeof options.temperature === 'number' ? options.temperature : 0.1
      };

      console.log('ğŸ”„ OpenAI í”„ë¡ì‹œ(ì˜µì…˜) í˜¸ì¶œ ì‹œì‘...', { max_tokens: body.max_tokens });
      const controller = new AbortController();
      const timeoutMs = typeof options.timeoutMs === 'number' ? options.timeoutMs : 600000; // ê¸°ë³¸ 10ë¶„
      const t = setTimeout(() => controller.abort(), timeoutMs);
      const resp = await fetch('/.netlify/functions/openai-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        signal: controller.signal
      }).finally(() => clearTimeout(t));

      if (!resp.ok) {
        const errData = await resp.json().catch(() => ({ error: 'Unknown error' }));
        console.error('âŒ OpenAI í”„ë¡ì‹œ ì˜¤ë¥˜(ì˜µì…˜):', resp.status, errData);
        if (resp.status === 404) {
          throw new Error('OpenAI í”„ë¡ì‹œ í•¨ìˆ˜ê°€ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Netlify ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else if (errData.code === 'MISSING_API_KEY') {
          throw new Error('Netlify í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Site settingsì—ì„œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê³  ì¬ë°°í¬í•´ì£¼ì„¸ìš”.');
        } else {
          throw new Error(`OpenAI í”„ë¡ì‹œ ì˜¤ë¥˜: ${resp.status} ${errData.error || 'Unknown error'}`);
        }
      }

      const data = await resp.json();
      console.log('âœ… OpenAI í”„ë¡ì‹œ(ì˜µì…˜) í˜¸ì¶œ ì„±ê³µ');
      return data?.choices?.[0]?.message?.content?.trim() || '';
    }

    // ğŸ“„ ë¡œì»¬ Fallback: GPT ì—†ì´ ê¸°ë³¸ HTML ë¬¸ì„œ ìƒì„±
    function buildBasicHTMLDocument(title, dateString, text) {
      // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ íŒŒì‹± (#, ##, ###)
      const lines = String(text || '').split(/\r?\n/);
      const parts = [];
      let para = [];
      const flushPara = () => {
        if (para.length) {
          const content = para.join(' ').trim();
          if (content) parts.push(`<p>${escapeHtml(content)}</p>`);
          para = [];
        }
      };
      const escapeHtml = (s) => s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      for (const line of lines) {
        if (/^\s*#\s+/.test(line)) { flushPara(); parts.push(`<h1>${escapeHtml(line.replace(/^\s*#\s+/, ''))}</h1>`); continue; }
        if (/^\s*##\s+/.test(line)) { flushPara(); parts.push(`<h2>${escapeHtml(line.replace(/^\s*##\s+/, ''))}</h2>`); continue; }
        if (/^\s*###\s+/.test(line)) { flushPara(); parts.push(`<h3>${escapeHtml(line.replace(/^\s*###\s+/, ''))}</h3>`); continue; }
        if (/^\s*$/.test(line)) { flushPara(); continue; }
        para.push(line.trim());
      }
      flushPara();

      const bodyHtml = parts.join('\n');
      return `<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${escapeHtml(title || 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ')}</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Noto Sans CJK KR','Apple SD Gothic Neo',sans-serif; line-height: 1.6; margin: 24px; color: #222; }
    h1,h2,h3 { margin: 24px 0 12px; line-height: 1.25; }
    h1 { font-size: 28px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    p { margin: 10px 0; }
    .meta { color: #666; font-size: 13px; margin-bottom: 16px; }
    @media print { body { margin: 12mm; } }
  </style>
  </head>
  <body>
  <div class="meta">ì‘ì„±ì¼: ${escapeHtml(dateString || '')}</div>
  <h1>${escapeHtml(title || 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ')}</h1>
  ${bodyHtml}
  </body>
  </html>`;
    }

    // ğŸ“„ ì „ì²´ HTML ë¬¸ì„œ í…œí”Œë¦¿(ì´ë¯¸ HTML ì¡°ê°ì´ ì¤€ë¹„ëœ ê²½ìš° ì‚¬ìš©)
    function buildFullHTMLDocument(title, dateString, innerHtml) {
      const safe = (s)=>String(s||'').replace(/[<>]/g, m=>({"<":"&lt;",">":"&gt;"}[m]));
      return `<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${safe(title || 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ')}</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Noto Sans CJK KR','Apple SD Gothic Neo',sans-serif; line-height: 1.6; margin: 24px; color: #222; }
    h1,h2,h3 { margin: 24px 0 12px; line-height: 1.25; }
    h1 { font-size: 28px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    p { margin: 10px 0; }
    .meta { color: #666; font-size: 13px; margin-bottom: 16px; }
    @media print { body { margin: 12mm; } }
  </style>
  </head>
  <body>
  <div class="meta">ì‘ì„±ì¼: ${safe(dateString || '')}</div>
  <h1>${safe(title || 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ')}</h1>
  ${innerHtml || ''}
  </body>
  </html>`;
    }

    // ğŸ”§ ì´ˆê²½ëŸ‰ ë§ˆí¬ë‹¤ìš´â†’HTML ë³€í™˜ê¸° (ì•ˆì „ì¥ì¹˜)
    function mdLite(src) {
      if (!src) return '';
      let s = src;

      // í—¤ë”©(##, ### â†’ h3/h4)
      s = s.replace(/^####\s?(.*)$/gm, '<h4>$1</h4>');
      s = s.replace(/^###\s?(.*)$/gm, '<h3>$1</h3>');
      s = s.replace(/^##\s?(.*)$/gm,  '<h3>$1</h3>');

      // êµµê²Œ/ê¸°ìš¸ì„ (**bold**, *em*)
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/(^|[^\*])\*(?!\*)([^*]+?)\*(?!\*)/g, '$1<em>$2</em>');

      // ìˆ«ì ë¦¬ìŠ¤íŠ¸ (1. ... ì—¬ëŸ¬ì¤„ â†’ <ol>)
      s = s.replace(/(?:^|\n)((?:\d+\.\s+.*(?:\n|$))+)/gm, (m, block) => {
        const items = block.trim().split(/\n/)
          .map(l => l.replace(/^\d+\.\s+/, '').trim())
          .filter(Boolean)
          .map(v => `<li>${v}</li>`).join('\n');
        return `\n<ol>\n${items}\n</ol>\n`;
      });

      // ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ (- ... ì—¬ëŸ¬ì¤„ â†’ <ul>)
      s = s.replace(/(?:^|\n)((?:-\s+.*(?:\n|$))+)/gm, (m, block) => {
        const items = block.trim().split(/\n/)
          .map(l => l.replace(/^-+\s+/, '').trim())
          .filter(Boolean)
          .map(v => `<li>${v}</li>`).join('\n');
        return `\n<ul>\n${items}\n</ul>\n`;
      });

      // ë‹¨ë½ ê°ì‹¸ê¸°(ì´ë¯¸ íƒœê·¸ë¡œ ì‹œì‘í•˜ëŠ” ì¤„ì€ ì œì™¸)
      const chunks = s.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
      return chunks.map(p => (/^<(h3|h4|ul|ol)\b/i.test(p) ? p : `<p>${p.replace(/\n/g, '<br>')}</p>`)).join('\n');
    }

    // ğŸ“¦ í…ìŠ¤íŠ¸ë¥¼ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ì¡°ê°ë‚´ê¸° (ë¬¸ë‹¨ ê²½ê³„ ìš°ì„ )
    function splitTextBySize(text, maxLen) {
      const chunks = [];
      const parts = String(text||'').split(/\n\n+/);
      let buf = '';
      for (const part of parts) {
        const block = (part + '\n\n');
        if ((buf + block).length > maxLen) {
          if (buf) chunks.push(buf);
          if (block.length > maxLen) {
            // ë„ˆë¬´ í° ë‹¨ì¼ ë¸”ë¡ì€ ê°•ì œë¡œ ë¶„í• 
            for (let i = 0; i < block.length; i += maxLen) {
              chunks.push(block.slice(i, i + maxLen));
            }
            buf = '';
          } else {
            buf = block;
          }
        } else {
          buf += block;
        }
      }
      if (buf) chunks.push(buf);
      return chunks;
    }

    // ğŸ¤– ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ â†’ (ì¡°ê°ë³„) HTML ë³¸ë¬¸ ì¡°ê° â†’ ìµœì¢… HTMLë¡œ í•©ì„±
    async function generateHtmlFromFinalReportChunked(finalReport, title, dateString) {
      const CHUNK_CHAR_LIMIT = 2600; // ì¡°ê°ë‹¹ ê¸¸ì´ ì¶•ì†Œ(ì¶œë ¥ 1:1 ë³€í™˜ ì—¬ìœ  í™•ë³´)
      const sections = splitTextBySize(finalReport, CHUNK_CHAR_LIMIT);
      console.log(`ğŸ§© ëŒ€ìš©ëŸ‰ ë³´ê³ ì„œ ë¶„í• : ${sections.length}ê°œ ì¡°ê°`);
      const system = [
        'ë„ˆëŠ” HTML ë§ˆí¬ì—… ì „ë¬¸ê°€ì´ë‹¤.',
        'ì•„ë˜ í…ìŠ¤íŠ¸ ì¡°ê°ì„ HTML ë³¸ë¬¸ ì¡°ê°ìœ¼ë¡œ ë³€í™˜í•˜ë¼.',
        'ë°˜ë“œì‹œ ë³¸ë¬¸ ì¡°ê°ë§Œ ì¶œë ¥í•˜ê³  <html>, <head>, <body>ëŠ” í¬í•¨í•˜ì§€ ë§ˆë¼.',
        'í—ˆìš© íƒœê·¸: <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>',
        'ë¬¸ì²´ëŠ” ì „ë¬¸ì ì´ê³  ì •ì¤‘í•œ "~ìŠµë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ ì‘ì„±.',
        'â˜… ì•„ì£¼ ì¤‘ìš”: ì…ë ¥ì´ ë§ˆí¬ë‹¤ìš´(##, **bold**, - bullet, 1. list)ì´ë¼ë©´ ëª¨ë“  ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ë¥¼ ì œê±°í•˜ê³  ë™ë“±í•œ HTML íƒœê·¸ë¡œ ë³€í™˜í•´ë¼.',
        'â˜… ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ë¥¼ ê·¸ëŒ€ë¡œ ë‚¨ê¸°ì§€ ë§ ê²ƒ. í…ìŠ¤íŠ¸ ë³´ì¡´, ìš”ì•½/ìƒëµ ê¸ˆì§€.',
        'ì•„ì£¼ ì¤‘ìš”: ì ˆëŒ€ ìš”ì•½í•˜ê±°ë‚˜ ìƒëµí•˜ì§€ ë§ ê²ƒ. ì…ë ¥ í…ìŠ¤íŠ¸ì˜ ëª¨ë“  ë¬¸ì¥ì„ ìˆœì„œëŒ€ë¡œ 1:1ë¡œ HTML íƒœê·¸ë§Œ ì…í˜€ì„œ ì¶œë ¥í•  ê²ƒ.'
      ].join(' ');

      const htmlParts = [];
      let idx = 0;
      const statusEl = document.getElementById('html-status');
      for (let sec of sections) {
        idx += 1;
        // ğŸ”§ ë§ˆí¬ë‹¤ìš´ì„ ë¯¸ë¦¬ HTMLë¡œ ì •ê·œí™”(LLMì´ ê·œì¹™ ì–´ê²¨ë„ ì•ˆì „)
        const processedSec = mdLite(sec);
        const user = `ë‹¤ìŒì€ ìµœì¢… ë³´ê³ ì„œì˜ ì¼ë¶€ë¶„(ì„¹ì…˜ ${idx}/${sections.length})ì´ë‹¤. ì´ë¥¼ HTML ë³¸ë¬¸ ì¡°ê°ìœ¼ë¡œ ë³€í™˜í•˜ë¼.\n\n${processedSec}`;
        try {
          statusEl && (statusEl.style.display = 'block', statusEl.textContent = `HTML ì¡°ê° ë³€í™˜ ì¤‘... (${idx}/${sections.length})`);
          const part = await callOpenAIWithOptions(system, user, {
            max_tokens: 2800,     // ì¡°ê°ë‹¹ ì¶œë ¥ ì—¬ìœ  â†‘
            temperature: 0.2,
            timeoutMs: 70000      // ê¸´ ì¡°ê° ë³€í™˜ íƒ€ì„ì•„ì›ƒ â†‘
          });
          // ì‹¤íŒ¨í•´ë„ mdLite HTMLì„ ë°±ì—…ìœ¼ë¡œ ì‚¬ìš©
          htmlParts.push(part ? part : processedSec);
        } catch (e) {
          console.warn(`âš ï¸ ì¡°ê° ${idx} ë³€í™˜ ì‹¤íŒ¨, mdLite ë°±ì—… ì‚¬ìš©:`, e.message);
          // ì‹¤íŒ¨ ì‹œ mdLite ë³€í™˜ ê²°ê³¼ë¥¼ ì¦‰ì‹œ ì‚¬ìš©
          htmlParts.push(processedSec);
        }
        // ì¡°ê°ê°„ ì§§ì€ ê°„ê²©ìœ¼ë¡œ ë°±ì—”ë“œ ë¶€í•˜ ì™„í™”
        await new Promise(r => setTimeout(r, 500));
      }
      const inner = htmlParts.join('\n\n');
      return buildFullHTMLDocument(title, dateString, inner);
    }

    // ====== GPT0 ë³´ì¡° ìœ í‹¸ ======
    async function buildScenarioMarketTimeseriesText(n){
      try{
        console.log(`ğŸ” buildScenarioMarketTimeseriesText í˜¸ì¶œ: ì‹œë‚˜ë¦¬ì˜¤ ${n}`);
        console.log('ğŸ“Š marketDataByScenario ìƒíƒœ:', Object.keys(marketDataByScenario).length, 'ê°œ ì§€í‘œ');
        
        const scen = scenarioData[n] || {};
        
        // ìƒˆë¡œìš´ ë§¤í•‘ ë°©ì‹: indicator.xlsxì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì§€í‘œ ê°€ì ¸ì˜¤ê¸°
        let pick = [];
        let links = [];
        let indicators = [];
        
        if (scenarioToIndicatorsMap.has(n)) {
          pick = scenarioToIndicatorsMap.get(n).slice(0, 8); // ìƒìœ„ 8ê°œë§Œ ìš”ì•½
          console.log(`âœ… ì‹œë‚˜ë¦¬ì˜¤ ${n}ì˜ ì§€í‘œ ë§¤í•‘ì—ì„œ ${pick.length}ê°œ ì§€í‘œ ì°¾ìŒ`);
        } else {
          // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ fallback
          links = Array.isArray(scen.links) ? scen.links : [];
          indicators = Array.isArray(scen.indicators) ? scen.indicators : [];
          pick = (links && links.length ? links : indicators).slice(0, 8);
          console.log(`âš ï¸ ì‹œë‚˜ë¦¬ì˜¤ ${n}ì˜ ì§€í‘œ ë§¤í•‘ì´ ì—†ì–´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©: ${pick.length}ê°œ ì§€í‘œ`);
        }
        
        console.log('ğŸ“‹ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°:', scen);
        console.log('ğŸ”— ì—°ê²°ëœ ì§€í‘œ (links):', links);
        console.log('ğŸ”— ì—°ê²°ëœ ì§€í‘œ (indicators):', indicators);
        console.log('ğŸ”— ì„ íƒëœ ì§€í‘œ (pick):', pick);
        
        // ë§ˆì¼“ë°ì´í„° ë§¤í•‘ ìƒíƒœ í™•ì¸
        console.log('ğŸ” ë§ˆì¼“ë°ì´í„° ë§¤í•‘ ìƒíƒœ:');
        pick.forEach((item, index) => {
          const itemId = item.id || item.ID || item.Id || item.indicator_id || item.indicatorId;
          const itemName = item.name || item.Name || item.NAME || item.indicator_name || item.indicatorName;
          console.log(`  ${index + 1}. ID: ${itemId}, Name: ${itemName}`);
          
          if (itemId) {
            const hasMarketData = marketDataByScenario[itemId] || 
                                (itemId.includes(':') && marketDataByScenario[itemId.split(':')[0]]) ||
                                (itemId.startsWith('IND') && marketDataByScenario['IND' + String(parseInt(itemId.replace('IND', ''))).padStart(3, '0')]);
            console.log(`     ë§ˆì¼“ë°ì´í„°: ${hasMarketData ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}`);
          }
        });
        
        // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° êµ¬ì¡° ìƒì„¸ ë¶„ì„
        if (scen.links && scen.links.length > 0) {
          console.log('ğŸ” ì²« ë²ˆì§¸ links í•­ëª© êµ¬ì¡°:', scen.links[0]);
          console.log('ğŸ” links ì»¬ëŸ¼ëª…ë“¤:', Object.keys(scen.links[0] || {}));
        }
        if (scen.indicators && scen.indicators.length > 0) {
          console.log('ğŸ” ì²« ë²ˆì§¸ indicators í•­ëª© êµ¬ì¡°:', scen.indicators[0]);
          console.log('ğŸ” indicators ì»¬ëŸ¼ëª…ë“¤:', Object.keys(scen.indicators[0] || {}));
        }
        
        const header = [`ì‹œë‚˜ë¦¬ì˜¤: ${n}`, `[ìš”ì•½ëŒ€ìƒ ì§€í‘œ ìˆ˜] ${pick.length}`, `[ì§€í‘œëª… ì¤‘ì‹¬ ë¶„ì„]`, ''];
        
        // ë§ˆì¼“ë°ì´í„° ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        const availableMarketData = Object.keys(marketDataByScenario);
        console.log('ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ë§ˆì¼“ë°ì´í„° í‚¤:', availableMarketData);
        console.log('ğŸ” ì‹œë‚˜ë¦¬ì˜¤ ì§€í‘œì™€ ë§ˆì¼“ë°ì´í„° ë§¤í•‘ ì‹œë„:');

        function formatMarketData(indicatorId, name, ticker, weight, corr) {
          console.log(`ğŸ” formatMarketData í˜¸ì¶œ: indicatorId=${indicatorId}, name=${name}, ticker=${ticker}`);
          console.log(`ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ë§ˆì¼“ë°ì´í„° í‚¤:`, Object.keys(marketDataByScenario));
          
          // IDë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ ë§ˆì¼“ë°ì´í„° ê²€ìƒ‰ (IND001:slope60 í˜•íƒœ)
          let marketData = marketDataByScenario[indicatorId];
          
          // IDê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ IDë¡œ ê²€ìƒ‰ ì‹œë„ (IND001)
          if (!marketData && indicatorId.includes(':')) {
            const baseId = indicatorId.split(':')[0];
            marketData = marketDataByScenario[baseId];
            if (marketData) {
              console.log(`âœ… ê¸°ë³¸ IDë¡œ ë§ˆì¼“ë°ì´í„° ì°¾ìŒ: ${indicatorId} -> ${baseId}`);
            }
          }
          
          // ì—¬ì „íˆ ì—†ìœ¼ë©´ IND001 í˜•íƒœë¡œ ê²€ìƒ‰
          if (!marketData && indicatorId.startsWith('IND')) {
            const num = indicatorId.replace('IND', '');
            const paddedId = 'IND' + String(parseInt(num)).padStart(3, '0');
            marketData = marketDataByScenario[paddedId];
            if (marketData) {
              console.log(`âœ… íŒ¨ë”©ëœ IDë¡œ ë§ˆì¼“ë°ì´í„° ì°¾ìŒ: ${indicatorId} -> ${paddedId}`);
            }
          }
          
          if (!marketData) {
            console.log(`âŒ ë§ˆì¼“ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${indicatorId}`);
            // ì´ë¦„ ì •ë³´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ í‘œì‹œí•˜ê³ , í‹°ì»¤ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ ì œê³µ
            const nameInfo = name ? `[ì´ë¦„: ${name}]` : '';
            const tickerInfo = ticker ? `[í‹°ì»¤: ${ticker}]` : '';
            const weightInfo = weight ? `[ê°€ì¤‘ì¹˜: ${weight}]` : '';
            const corrInfo = corr ? `[ìƒê´€ê³„ìˆ˜: ${corr}]` : '';
            
            return `ì´ë¦„: ${name || 'N/A'} ${tickerInfo} ${weightInfo} ${corrInfo}
âŒ ë§ˆì¼“ë°ì´í„° ì—†ìŒ - ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤: ${Object.keys(marketDataByScenario).slice(0, 5).join(', ')}...`;
          }

          // í‹°ì»¤ ì •ë³´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ í‘œì‹œí•˜ê³ , IDëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í‘œì‹œ
          const tickerInfo = ticker ? `[í‹°ì»¤: ${ticker}]` : '';
          const nameInfo = name ? `[ì´ë¦„: ${name}]` : '';
          const weightInfo = weight ? `[ê°€ì¤‘ì¹˜: ${weight}]` : '';
          const corrInfo = corr ? `[ìƒê´€ê³„ìˆ˜: ${corr}]` : '';
          
          // í‹°ì»¤ê°€ ìˆìœ¼ë©´ í‹°ì»¤ ì¤‘ì‹¬, ì—†ìœ¼ë©´ ì´ë¦„ ì¤‘ì‹¬ìœ¼ë¡œ í‘œì‹œ
          // ì´ë¦„ì„ ìš°ì„ ì ìœ¼ë¡œ í‘œì‹œí•˜ê³ , í‹°ì»¤ì™€ IDëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ í‘œì‹œ
          const primaryIdentifier = name || ticker || indicatorId;
          let output = [`${primaryIdentifier} ${tickerInfo} ${nameInfo} ${weightInfo} ${corrInfo} [ID: ${indicatorId}]`];
          
          // Returns ë°ì´í„° ì²˜ë¦¬
          if (marketData.returns) {
            const ret = marketData.returns;
            output.push(`  â–¶ ìˆ˜ìµë¥ : 20ì¼=${(ret['20d']*100).toFixed(2)}% (ì—°í™˜ì‚°=${(ret['20d_ann']*100).toFixed(1)}%), 60ì¼=${(ret['60d']*100).toFixed(2)}% (ì—°í™˜ì‚°=${(ret['60d_ann']*100).toFixed(1)}%), 120ì¼=${(ret['120d']*100).toFixed(2)}% (ì—°í™˜ì‚°=${(ret['120d_ann']*100).toFixed(1)}%)`);
          }
          
          // Volatility ë°ì´í„° ì²˜ë¦¬
          if (marketData.vol) {
            const vol = marketData.vol;
            output.push(`  â–¶ ë³€ë™ì„±(ì—°í™˜ì‚°): 20ì¼=${(vol['20d_vol_ann']*100).toFixed(1)}%, 60ì¼=${(vol['60d_vol_ann']*100).toFixed(1)}%, 120ì¼=${(vol['120d_vol_ann']*100).toFixed(1)}%`);
          }
          
          // MDD(Maximum Drawdown) ë°ì´í„° ì²˜ë¦¬
          if (marketData.mdd) {
            const mdd = marketData.mdd;
            const mdd6m = mdd['mdd_6m'] ? `6ê°œì›”MDD=${(mdd['mdd_6m']*100).toFixed(1)}%` : '';
            const dd6m = mdd['dd_6m'] ? `í˜„ì¬ì†ì‹¤=${(mdd['dd_6m']*100).toFixed(1)}%` : '';
            const mdd1y = mdd['mdd_1y'] ? `1ë…„MDD=${(mdd['mdd_1y']*100).toFixed(1)}%` : '';
            const mddText = [mdd6m, dd6m, mdd1y].filter(Boolean).join(', ');
            if (mddText) output.push(`  â–¶ ìµœëŒ€ì†ì‹¤: ${mddText}`);
          }
          
          // Trend ë°ì´í„° ì²˜ë¦¬
          if (marketData.trend) {
            const trend = marketData.trend;
            output.push(`  â–¶ ì¶”ì„¸ë¶„ì„: SMA20ëŒ€ë¹„=${(trend['gap_to_sma20']*100).toFixed(1)}%, SMA60ëŒ€ë¹„=${(trend['gap_to_sma60']*100).toFixed(1)}%, SMA120ëŒ€ë¹„=${(trend['gap_to_sma120']*100).toFixed(1)}%`);
            if (trend['cross_20_60'] && trend['cross_20_60'] !== 'none') {
              output.push(`    - 20ì¼/60ì¼ êµì°¨: ${trend['cross_20_60']}`);
            }
            if (trend['cross_60_120'] && trend['cross_60_120'] !== 'none') {
              output.push(`    - 60ì¼/120ì¼ êµì°¨: ${trend['cross_60_120']}`);
            }
          }
          
          // Slope ë°ì´í„° ì²˜ë¦¬
          if (marketData.slope60) {
            const slope = marketData.slope60;
            output.push(`  â–¶ 60ì¼ ê¸°ìš¸ê¸°: ${slope.slope.toFixed(2)} (tí†µê³„ëŸ‰=${slope.tstat.toFixed(2)})`);
          }
          
          // 52ì£¼ í¬ì§€ì…˜ ë°ì´í„° ì²˜ë¦¬
          if (marketData.pos_52w) {
            const pos = marketData.pos_52w;
            output.push(`  â–¶ 52ì£¼ í¬ì§€ì…˜: ${pos.pos_pct.toFixed(1)}% êµ¬ê°„ (0~1 ìŠ¤ì¼€ì¼: ${pos.pos_0to1.toFixed(3)})`);
          }
          
          return output.join('\n');
        }

        let out = header.slice();
        for (let i = 0; i < pick.length; i++) {
          const item = pick[i];
          console.log(`ğŸ” ì§€í‘œ ${i+1} ë°ì´í„°:`, item);
          
          // ìƒˆë¡œìš´ ë§¤í•‘ ë°©ì‹ì— ë§ì¶˜ ë°ì´í„° ì¶”ì¶œ
          let id, name, ticker, weight, corr;
          
          if (scenarioToIndicatorsMap.has(n)) {
            // ìƒˆë¡œìš´ ë§¤í•‘ ë°©ì‹: indicator.xlsxì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°
            id = item.indicatorId || '';
            name = item.indicatorName || '';
            ticker = item.bloombergTicker || '';
            weight = 0; // indicator.xlsxì—ëŠ” weight ì •ë³´ê°€ ì—†ìŒ
            corr = 0;   // indicator.xlsxì—ëŠ” correlation ì •ë³´ê°€ ì—†ìŒ
          } else {
            // ê¸°ì¡´ ë°©ì‹: ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°
            id = item.Indicator_ID || item.IndicatorID || item.indicator_id || item.indicatorID || item.id || item.ID || '';
            name = item.Indicator_Name || item.IndicatorName || item.indicator_name || item.indicatorName || item.name || item.Name || item.NAME || '';
            ticker = item.Bloomberg_Ticker || item.BloombergTicker || item.bloomberg_ticker || item.bloombergTicker || item.ticker || item.Ticker || item.TICKER || '';
            weight = item.Weight || item.weight || item.WEIGHT || 0;
            corr = item.Correlation_Coeff || item.CorrelationCoeff || item.correlation_coeff || item.correlationCoeff || item.corr || item.Corr || item.CORR || 0;
          }
          
          console.log(`ğŸ” íŒŒì‹±ëœ ì •ë³´: ID=${id}, Name=${name || 'N/A'}, Ticker=${ticker || 'N/A'}, Weight=${weight}, Corr=${corr}`);
          console.log(`ğŸ“Š í‘œì‹œ ìš°ì„ ìˆœìœ„: ì´ë¦„(${name || 'N/A'}) > í‹°ì»¤(${ticker || 'N/A'}) > ID(${id})`);
          
          if (!id) {
            console.log(`âŒ IDê°€ ì—†ëŠ” ì§€í‘œ ê±´ë„ˆëœ€:`, item);
            continue;
          }
          
          const marketDataText = formatMarketData(id, name, ticker, weight, corr);
          // ì´ë¦„ì„ ìš°ì„ ì ìœ¼ë¡œ í‘œì‹œí•˜ê³ , ì—†ìœ¼ë©´ í‹°ì»¤ ë˜ëŠ” IDë¡œ í‘œì‹œ
          const displayName = name ? `[${i+1}] ${name}` : (ticker ? `[${i+1}] ${ticker}` : `[${i+1}] ${id}`);
          out.push(`${displayName}`);
          out.push(marketDataText);
          out.push('');
        }
        
        return out.join('\n').trim();
      }catch(e){ 
        console.error('buildScenarioMarketTimeseriesText ì˜¤ë¥˜:', e);
        return `ì‹œë‚˜ë¦¬ì˜¤ ${n} ë§ˆì¼“ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`; 
      }
    }

    async function buildScenarioNewsFullText(n){
      try{
        // ìƒˆë¡œìš´ keyword_news.xlsx ë°ì´í„° ì‚¬ìš©
        const newsContent = getKeywordNewsContent(n);
        return newsContent || 'ê´€ë ¨ ë‰´ìŠ¤ ìš”ì•½ ì—†ìŒ';
      }catch(e){ 
        return `ë‰´ìŠ¤ ìš”ì•½ ìˆ˜ì§‘ ì‹¤íŒ¨: ${e.message}`; 
      }
    }

    async function fetchArticleAsText(url){
      // 1) ë¡œì»¬ í”„ë¡ì‹œ ì„œë²„ ì‹œë„: http://localhost:3000/api/fetch-article?url=...
      try{
        const proxyUrl = `http://localhost:3000/api/fetch-article?url=${encodeURIComponent(url)}`;
        const r = await fetch(proxyUrl, { cache: 'no-store' });
        if (r.ok) {
          const text = await r.text();
          if (text && text.length > 0) return text.slice(0, 12000);
        }
      }catch(_){ /* ignore and fallback */ }
      // 2) ì§ì ‘ ìš”ì²­ (ëŒ€ë¶€ë¶„ CORSë¡œ ì‹¤íŒ¨í•˜ë¯€ë¡œ ì‹¤íŒ¨ì‹œ ì•ˆë‚´)
      try{
        const resp = await fetch(url, { mode: 'no-cors' });
        if (!resp || resp.type === 'opaque') return `ì›ë¬¸ì€ CORSë¡œ ì§ì ‘ ìˆ˜ì§‘ ë¶ˆê°€. URLë§Œ ì œê³µ: ${url}`;
        const html = await resp.text();
        return stripHtmlToText(html).slice(0, 8000);
      }catch(_){
        return `ì›ë¬¸ ì ‘ê·¼ ì‹¤íŒ¨(CORS ê°€ëŠ¥ì„±). URLë§Œ ì œê³µ: ${url}`;
      }
    }

    function stripHtmlToText(html){
      try{
        const div = document.createElement('div');
        div.innerHTML = html;
        return (div.textContent || div.innerText || '').replace(/\s+/g,' ').trim();
      }catch(_){ return ''; }
    }



    async function buildCurrentMarketStateText(){
      try{
        console.log('ğŸ” buildCurrentMarketStateText í•¨ìˆ˜ ì‹œì‘');
        
        const a = await fetch('go_scen/data/market_data/market_index.txt').then(r=>r.ok?r.text():'').catch(()=> '');
        console.log('ğŸ“Š market_index.txt ë¡œë“œ ê²°ê³¼:', a ? 'ì„±ê³µ' : 'ì‹¤íŒ¨', 'ë‚´ìš© ê¸¸ì´:', a.length);
        
        const b = await fetch('go_scen/data/market_data/daily_market_recap.txt').then(r=>r.ok?r.text():'').catch(()=> '');
        console.log('ğŸ“Š daily_market_recap.txt ë¡œë“œ ê²°ê³¼:', b ? 'ì„±ê³µ' : 'ì‹¤íŒ¨', 'ë‚´ìš© ê¸¸ì´:', b.length);
        
        const result = `[ë§ˆì¼“ ì¸ë±ìŠ¤]\n${a}\n\n[ë°ì¼ë¦¬ ë¦¬ìº¡]\n${b}`.trim();
        console.log('ğŸ” ìµœì¢… ê²°í•© ê²°ê³¼:', result);
        
        return result;
      }catch(e){ 
        console.error('âŒ buildCurrentMarketStateText ì˜¤ë¥˜:', e);
        return `ì‹œí™© í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`; 
      }
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¥¼ ì‹œë‚˜ë¦¬ì˜¤ IDë¡œ ë³€í™˜ (n -> SC001, SC002 ë“±)
    function getScenarioIdFromNumber(n) {
      const result = `SC${String(n).padStart(3, '0')}`;
      console.log(`ğŸ” getScenarioIdFromNumber(${n}) â†’ "${result}"`);
      return result;
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    function getScenarioSummaryContent(n) {
      try {
        console.log(`ğŸ” getScenarioSummaryContent í˜¸ì¶œ: ì‹œë‚˜ë¦¬ì˜¤ ${n}`);
        console.log('ğŸ“‹ scenarioSummaryByScenarioId ìƒíƒœ:', Object.keys(scenarioSummaryByScenarioId).length, 'ê°œ ì‹œë‚˜ë¦¬ì˜¤');
        console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤ IDë“¤:', Object.keys(scenarioSummaryByScenarioId));
        
        const scenarioId = getScenarioIdFromNumber(n);
        console.log('ğŸ†” ë³€í™˜ëœ ì‹œë‚˜ë¦¬ì˜¤ ID:', scenarioId);
        
        const content = scenarioSummaryByScenarioId[scenarioId];
        console.log('ğŸ“„ í•´ë‹¹ ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½:', content);
        
        if (!content) {
          console.log(`âŒ ìš”ì•½ ë°ì´í„° ì—†ìŒ: ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId}`);
        }
        
        return content || `ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId} ìš”ì•½ ì •ë³´ ì—†ìŒ`;
      } catch(e) {
        return `ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;
      }
    }

    // í‚¤ì›Œë“œ ë‰´ìŠ¤ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    function getKeywordNewsContent(n) {
      try {
        console.log(`ğŸ” getKeywordNewsContent í˜¸ì¶œ: ì‹œë‚˜ë¦¬ì˜¤ ${n}`);
        console.log('ğŸ“° keywordNewsByScenarioId ìƒíƒœ:', Object.keys(keywordNewsByScenarioId).length, 'ê°œ ì‹œë‚˜ë¦¬ì˜¤');
        console.log('ğŸ“° ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤ IDë“¤:', Object.keys(keywordNewsByScenarioId));
        console.log('ğŸ“° keywordNewsByScenarioId ì „ì²´ ë‚´ìš©:', keywordNewsByScenarioId);
        
        const scenarioId = getScenarioIdFromNumber(n);
        console.log('ğŸ†” ë³€í™˜ëœ ì‹œë‚˜ë¦¬ì˜¤ ID:', scenarioId);
        
        // ì •í™•í•œ ë§¤ì¹­ í™•ì¸
        const exactMatch = keywordNewsByScenarioId[scenarioId];
        console.log('ğŸ” ì •í™•í•œ ë§¤ì¹­ ê²°ê³¼:', exactMatch);
        
        // SC004 íŠ¹ë³„ ë””ë²„ê¹…
        if (scenarioId === 'SC004') {
          console.log('ğŸ¯ SC004 íŠ¹ë³„ ë””ë²„ê¹…:');
          console.log('  - keywordNewsByScenarioId ì „ì²´ í‚¤ë“¤:', Object.keys(keywordNewsByScenarioId));
          console.log('  - SC004 ì§ì ‘ ì ‘ê·¼:', keywordNewsByScenarioId['SC004']);
          console.log('  - 4 í¬í•¨ í‚¤ë“¤:', Object.keys(keywordNewsByScenarioId).filter(key => key.includes('4')));
          console.log('  - 004 í¬í•¨ í‚¤ë“¤:', Object.keys(keywordNewsByScenarioId).filter(key => key.includes('004')));
        }
        
        // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„ (SC004 -> SC4, 4, 004 ë“±)
        let newsArray = exactMatch;
        if (!newsArray || newsArray.length === 0) {
          const partialMatches = Object.keys(keywordNewsByScenarioId).filter(key => 
            key.includes(scenarioId.replace('SC', '')) || 
            key.includes(scenarioId) ||
            scenarioId.includes(key.replace('SC', ''))
          );
          console.log('ğŸ” ë¶€ë¶„ ë§¤ì¹­ ì‹œë„ ê²°ê³¼:', partialMatches);
          
          if (partialMatches.length > 0) {
            newsArray = keywordNewsByScenarioId[partialMatches[0]];
            console.log(`âœ… ë¶€ë¶„ ë§¤ì¹­ìœ¼ë¡œ ë‰´ìŠ¤ ì°¾ìŒ: ${scenarioId} -> ${partialMatches[0]}`);
          }
        }
        
        console.log('ğŸ“‹ ìµœì¢… ë‰´ìŠ¤ ë°°ì—´:', newsArray);
        
        if (!newsArray || newsArray.length === 0) {
          console.log(`âŒ ë‰´ìŠ¤ ë°ì´í„° ì—†ìŒ: ì‹œë‚˜ë¦¬ì˜¤ ${scenarioId}`);
          return 'í•´ë‹¹ê¸°ì‚¬ ì—†ìŒ';
        }
        
        const newsContent = newsArray.map((item, index) => {
          let content = `[ê¸°ì‚¬ ${index + 1}]`;
          if (item.title) content += `\nì œëª©: ${item.title}`;
          if (item.press) content += `\nì–¸ë¡ ì‚¬: ${item.press}`;
          if (item.keyword) content += `\ní‚¤ì›Œë“œ: ${item.keyword}`;
          if (item.url) content += `\nURL: ${item.url}`;
          if (item.news && item.news !== 'ë‰´ìŠ¤ ë‚´ìš© ì—†ìŒ') {
            content += `\nìš”ì•½: ${item.news}`;
          } else {
            content += `\nìš”ì•½: ë‰´ìŠ¤ ë‚´ìš© ì—†ìŒ`;
          }
          return content;
        }).join('\n\n---\n\n');
        
        return newsContent;
      } catch(e) {
        return `í‚¤ì›Œë“œ ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;
      }
    }

    // risk_eng.ipynbì—ì„œ ì—ì´ì „íŠ¸ ì—­í•  í…ìŠ¤íŠ¸ ì¶”ì¶œ
    async function loadRiskAgentRoles() {
      // ê¸°ë³¸ê°’ (fallback)
      const defaults = {
        gpt0_marketdata: 'ì…ë ¥ëœ ì‹œê³„ì—´ í…ìŠ¤íŠ¸(ì—‘ì…€ ë³€í™˜ ìš”ì•½)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³€ë™ì„±, ì¶”ì„¸(ìƒ/í•˜/íš¡ë³´), êµ¬ê°„ë³„ ë ˆì§, ê°„ë‹¨í•œ ìƒê´€(ê°€ëŠ¥ì‹œ)ì„ ìš”ì•½í•˜ê³  í•µì‹¬ ìš”ì ì„ í‘œë¡œ ì •ë¦¬í•˜ë¼. ê³¼ë„í•œ ì¶”ì •ì€ í”¼í•˜ê³  ì…ë ¥ ë‚´ ê·¼ê±°ë¥¼ ëª…ì‹œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.',
        gpt0_news: 'ì…ë ¥ëœ ë‰´ìŠ¤ ìš”ì•½ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì‹œë‚˜ë¦¬ì˜¤ì™€ì˜ ì—°ê³„ì„±, ë¦¬ìŠ¤í¬ íŠ¸ë¦¬ê±°, ì‹œì¥ ì˜í–¥ë„ë¥¼ ë¶„ì„í•˜ë¼. ê° ê¸°ì‚¬ì˜ í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ì¢…í•©í•˜ì—¬ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í˜„ ê°€ëŠ¥ì„±, ì„ í–‰/ë™í–‰ ì‹ í˜¸, ê¸ˆìœµì‹œì¥ íŒŒê¸‰íš¨ê³¼ë¥¼ ë„ì¶œí•˜ê³  ì¢…í•©ì ì¸ ì‹œì‚¬ì ì„ ì œì‹œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.',
        gpt0_scenario_summary: 'ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸, ì˜í–¥ ì „íŒŒ ê²½ë¡œ, ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•˜ê³ , ê¸ˆìœµê¸°ê´€ ê´€ì ì—ì„œì˜ ì‹œì‚¬ì ê³¼ ëŒ€ì‘ ë°©ì•ˆì„ ë„ì¶œí•˜ë¼. ì‹œë‚˜ë¦¬ì˜¤ì˜ í•µì‹¬ ë™ì¸ê³¼ ì ì¬ì  ì˜í–¥ë„ë¥¼ ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì œì‹œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.',
        gpt0_scenpdf: 'ì‹œë‚˜ë¦¬ì˜¤ PDFì—ì„œ ì¶”ì¶œëœ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ë¼: 1) ì‹œë‚˜ë¦¬ì˜¤ ê°œìš” ë° í•µì‹¬ ë™ì¸, 2) ë‹¨ê³„ë³„ ì „ê°œ ê³¼ì •(ì´ë²¤íŠ¸â†’ì§€í‘œâ†’ì‹ í˜¸), 3) ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í˜„ ê°€ëŠ¥ì„± í‰ê°€, 4) ì£¼ìš” ëª¨ë‹ˆí„°ë§ í•­ëª©ê³¼ ì„ê³„ì¹˜, 5) ì¡°ê¸°ê²½ë³´ ì‹ í˜¸ ë° ë°ì´í„° ì†ŒìŠ¤. ì†Œì£¼ì œë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•˜ë¼.',
        gpt0_marketstate: 'ë§ˆì¼“ ì¸ë±ìŠ¤ ìš”ì•½ê³¼ ë°ì¼ë¦¬ ë¦¬ìº¡ í…ìŠ¤íŠ¸ë¥¼ ê²°í•©í•´ í˜„ì¬ ì‹œì¥Â·ê²½ì œ ìƒí™©ì„ 8ì¤„ ë‚´ì™¸ë¡œ ìš”ì•½í•˜ê³ , ë‹¹ì¼ í•µì‹¬ í¬ì¸íŠ¸ 5ê°€ì§€ë¥¼ ë¶ˆë¦¿ìœ¼ë¡œ ì •ë¦¬í•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.',
        gpt1: 'GPT0 ê° ëª¨ë“ˆì˜ ë¶„ì„ ê²°ê³¼(ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„°, ê¸°ì‚¬ë‰´ìŠ¤, ì‹œë‚˜ë¦¬ì˜¤ ìš”ì•½, PDF ë¶„ì„, í˜„ì¬ ì‹œí™©)ë¥¼ ì¢…í•©í•˜ì—¬ ì¼ê´€ì„± ìˆê²Œ ì •ì œí•˜ê³ , GPT2 ë¶„ë°° ì‘ì—…ì„ ìœ„í•œ í•µì‹¬ ìš”ì•½ê³¼ êµ¬ì¡°í™”ëœ ì •ë³´ë¥¼ ìƒì„±í•˜ë¼. ì¤‘ë³µ ì œê±°, ìƒí˜¸ ì—°ê´€ì„± ë¶„ì„, ìš°ì„ ìˆœìœ„ ë„ì¶œì„ í¬í•¨í•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ìš”ì•½ ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼.',
        gpt2: 'GPT1 ì¢…í•© ì •ì œ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ìˆ˜í–‰í•˜ë¼: 1) ê¸ˆë¦¬/í™˜ìœ¨/ì‹ ìš©ìœ„í—˜/ì£¼ê°€ì§€ìˆ˜ WORST ì‹œë‚˜ë¦¬ì˜¤ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ìƒì„±í•˜ê³ , 2) GPT3 ê° ë„ë©”ì¸(ì‹œì¥ë¦¬ìŠ¤í¬, ì‹ ìš©ë¦¬ìŠ¤í¬, ALM, ê¸€ë¡œë²Œë¦¬ìŠ¤í¬, ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤)ë³„ë¡œ ë§ì¶¤í˜• ë¶„ì„ ìë£Œì™€ ì§€ì‹œì‚¬í•­ì„ ê°œë³„ ìƒì„±í•˜ë¼. ê° ë„ë©”ì¸ì˜ ì „ë¬¸ì„±ê³¼ ë¶„ì„ ìš”êµ¬ì‚¬í•­ì„ ê³ ë ¤í•˜ì—¬ ì°¨ë³„í™”ëœ ë‚´ìš©ì„ ì œê³µí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ì‹œë‚˜ë¦¬ì˜¤ ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼. íŠ¹íˆ "5. ê²°ê³¼" ë˜ëŠ” "ê²°ê³¼" ë‹¨ë½ì€ ì™„ì „íˆ ì œì™¸í•˜ë¼.',
        gpt3_market: 'ì—…ë¡œë“œëœ ì‹œì¥ë¦¬ìŠ¤í¬ ê°€ì´ë“œëŠ” ë‹¹í–‰ì˜ í˜„ì¬ ì‹œì¥ë¦¬ìŠ¤í¬ í˜„í™©ìë£Œë‹¤. GPT2ì—ì„œ ì œê³µí•œ ì‹œë‚˜ë¦¬ì˜¤ì™€ WORST ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ë¼: 1) [ì€í–‰ í˜„í™©ë¶„ì„] ê°€ì´ë“œ ë‚´ ë‹¹í–‰ ì‹œì¥ë¦¬ìŠ¤í¬ í¬íŠ¸í´ë¦¬ì˜¤ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜(í¬ì§€ì…˜ ê·œëª¨, ë“€ë ˆì´ì…˜, ë¯¼ê°ë„), 2) [ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜] ì œì‹œëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‹¹í–‰ì— ë¯¸ì¹˜ëŠ” ì •ëŸ‰ì  ì˜í–¥ë„(VaR ë³€í™”ìœ¨ ë° ê¸ˆì•¡, P&L ì¶©ê²© ì¶”ì •ì¹˜, ê¸ˆë¦¬/í™˜ìœ¨ ë¯¼ê°ë„ ê³„ì‚° ê²°ê³¼, ì†ì‹¤ì•¡ ì¶”ì •), 3) [ëŒ€ì‘ì „ëµ] ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ì‹¤í–‰ë°©ì•ˆ. ë°˜ë“œì‹œ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ í¼ì„¼íŠ¸ ë³€í™”ìœ¨ì„ ì‚°ì¶œí•˜ë¼. ë‹¨, íŒŒìƒìƒí’ˆì˜ ê²½ìš° ê¸ˆì•¡ì€ ê³„ì•½ìƒ ê¸ˆì•¡ì´ë¯€ë¡œ ë¯¼ê°ë„ ë° ì†ì‹¤ê¸ˆì•¡ ë“± ìœ„ê¸°ìƒí™©ë¶„ì„ëŒ€ìƒì—ì„œ ì œì™¸í•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ì‹œì¥ë¦¬ìŠ¤í¬ ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼.',
        gpt3_credit: 'ì—…ë¡œë“œëœ ì‹ ìš©ë¦¬ìŠ¤í¬ ê°€ì´ë“œëŠ” ë‹¹í–‰ì˜ í˜„ì¬ ì‹ ìš©ë¦¬ìŠ¤í¬ í˜„í™©ìë£Œë‹¤. GPT2ì—ì„œ ì œê³µí•œ ì‹œë‚˜ë¦¬ì˜¤ì™€ WORST ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ë¼: 1) [ì€í–‰ í˜„í™©ë¶„ì„] ê°€ì´ë“œ ë‚´ ë‹¹í–‰ ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜(ì´ ìµìŠ¤í¬ì €, ë“±ê¸‰ë³„/ì—…ì¢…ë³„ êµ¬ì„±ë¹„, ì§‘ì¤‘ë„ ì§€í‘œ), 2) [ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜] ì œì‹œëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‹¹í–‰ì— ë¯¸ì¹˜ëŠ” ì •ëŸ‰ì  ì˜í–¥ë„(ë¶€ë„ìœ¨ ë³€í™”ìœ¨ ë° ì¶”ì • ë¶€ë„ì•¡, ì†ì‹¤ìœ¨ ì¦ê°€í­, í”„ë¡œë¹„ì „ ì¶”ê°€ ì ë¦½ í•„ìš”ì•¡, ECL ë³€ë™ì•¡), 3) [ëŒ€ì‘ì „ëµ] ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ì‹¤í–‰ë°©ì•ˆ. ë°˜ë“œì‹œ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ì‹ ìš©ë¦¬ìŠ¤í¬ ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼.',
        gpt3_alm: 'ì—…ë¡œë“œëœ ALM ê°€ì´ë“œëŠ” ë‹¹í–‰ì˜ í˜„ì¬ ìì‚°ë¶€ì±„ê´€ë¦¬ í˜„í™©ìë£Œë‹¤. GPT2ì—ì„œ ì œê³µí•œ ì‹œë‚˜ë¦¬ì˜¤ì™€ WORST ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ë¼: 1) [ì€í–‰ í˜„í™©ë¶„ì„] ê°€ì´ë“œ ë‚´ ë‹¹í–‰ ìì‚°ë¶€ì±„ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜(ì´ ìì‚°/ë¶€ì±„ ê·œëª¨, ë§Œê¸°ê°­, ê¸ˆë¦¬ê°­, ë“€ë ˆì´ì…˜), 2) [ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜] ì œì‹œëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‹¹í–‰ì— ë¯¸ì¹˜ëŠ” ì •ëŸ‰ì  ì˜í–¥ë„(NIM ë³€í™”ìœ¨ ë° ì´ìµ ê°ì†Œì•¡, ìœ ë™ì„±ë¹„ìœ¨ ë³€ë™í­, ë“€ë ˆì´ì…˜ ë¦¬ìŠ¤í¬ ê¸ˆì•¡, ë§Œê¸°ë¶ˆì¼ì¹˜ í™•ëŒ€ ê·œëª¨), 3) [ëŒ€ì‘ì „ëµ] ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ì‹¤í–‰ë°©ì•ˆ. ë°˜ë“œì‹œ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ BP(basis point) ë³€í™”ë¥¼ ì‚°ì¶œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ALM ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼.',
        gpt3_global: 'ì—…ë¡œë“œëœ ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ê°€ì´ë“œëŠ” ë‹¹í–‰ì˜ í˜„ì¬ í•´ì™¸ì‚¬ì—… í˜„í™©ìë£Œë‹¤. GPT2ì—ì„œ ì œê³µí•œ ì‹œë‚˜ë¦¬ì˜¤ì™€ WORST ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ë¼: 1) [ì€í–‰ í˜„í™©ë¶„ì„] ê°€ì´ë“œ ë‚´ ë‹¹í–‰ í•´ì™¸ì‚¬ì—…ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜(êµ­ê°€ë³„/ì§€ì—­ë³„ ìµìŠ¤í¬ì € ê¸ˆì•¡, í•´ì™¸ë²•ì¸ ìì‚° ê·œëª¨, ì™¸í™” í¬ì§€ì…˜), 2) [ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜] ì œì‹œëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‹¹í–‰ì— ë¯¸ì¹˜ëŠ” ì •ëŸ‰ì  ì˜í–¥ë„(í™˜ì†ìµ ì¶”ì •ì•¡, í•´ì™¸ë²•ì¸ ë‹¹ê¸°ìˆœì´ìµ ê°ì†Œí­, êµ­ê°€ë¦¬ìŠ¤í¬ ìµìŠ¤í¬ì € ì¦ê°€ì•¡, CDS í”„ë¦¬ë¯¸ì—„ ë³€ë™), 3) [ëŒ€ì‘ì „ëµ] ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ì‹¤í–‰ë°©ì•ˆ. ë°˜ë“œì‹œ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ê¸ˆì•¡ì„ ì‚°ì¶œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ê¸€ë¡œë²Œë¦¬ìŠ¤í¬ ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼.',
        gpt3_creditpf: 'ì—…ë¡œë“œëœ ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì´ë“œëŠ” ë‹¹í–‰ì˜ í˜„ì¬ ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©ìë£Œë‹¤. GPT2ì—ì„œ ì œê³µí•œ ì‹œë‚˜ë¦¬ì˜¤ì™€ WORST ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•˜ë¼: 1) [ì€í–‰ í˜„í™©ë¶„ì„] ê°€ì´ë“œ ë‚´ ë‹¹í–‰ ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ì˜ êµ¬ì²´ì  ìˆ˜ì¹˜(ì´ í¬íŠ¸í´ë¦¬ì˜¤ ê·œëª¨, ì‚°ì—…ë³„/ë“±ê¸‰ë³„/ì§€ì—­ë³„ ì§‘ì¤‘ë„ ë¹„ìœ¨, HHI ì§€ìˆ˜), 2) [ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜] ì œì‹œëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‹¹í–‰ì— ë¯¸ì¹˜ëŠ” ì •ëŸ‰ì  ì˜í–¥ë„(í¬íŠ¸í´ë¦¬ì˜¤ ì†ì‹¤ì•¡ ì¶”ì •, ì§‘ì¤‘ë„ ë¦¬ìŠ¤í¬ ì¦ê°€ë¶„, ìƒê´€ê´€ê³„ ê³„ìˆ˜ ë³€í™”, ì˜ˆìƒì†ì‹¤ë¥  ì¦ê°€í­), 3) [ëŒ€ì‘ì „ëµ] ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ì‹¤í–‰ë°©ì•ˆ. ë°˜ë“œì‹œ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ ì§‘ì¤‘ë„ ì§€í‘œë¥¼ ì‚°ì¶œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼. ë‹¨, "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤ ê²°ê³¼" ë“±ì˜ ë§ºìŒë§ì€ í¬í•¨í•˜ì§€ ë§ê³  ë¶„ì„ ë‚´ìš©ë§Œ ì œì‹œí•˜ë¼.',
        gpt4_final: 'GPT0~GPT3ì˜ ëª¨ë“  ë¶„ì„ì„ ì·¨í•©í•˜ì—¬ ë‹¤ìŒ êµ¬ì¡°ì˜ ì²´ê³„ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ë¼:\n\n## ì†Œì£¼ì œë³„ êµ¬ì„±\n1. [ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´] GPT0~GPT2ì˜ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„, í˜„ì¬ìƒí™©, ìœ„ê¸°ìƒí™©ë¶„ì„ ì‹œë®¬ë ˆì´ì…˜ ê°€ì • (ì •ëŸ‰ì  ì¶©ê²© ì‹œë‚˜ë¦¬ì˜¤ ìˆ˜ì¹˜ í¬í•¨)\n2. [í˜„ì¬ ì‹œì¥ìƒí™©] GPT0 ë§ˆì¼“ë°ì´í„° ë° ì‹œí™© ë¶„ì„ ìš”ì•½\n3. [ìœ„ê¸°ìƒí™© ë¶„ì„] GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ë° ì „ê°œë°©í–¥ (êµ¬ì²´ì  ë³€ë™ ìˆ˜ì¹˜ í¬í•¨)\n\n## ë³¸ë¬¸ - ëª¨ë“ˆë³„ ìœ„ê¸°ìƒí™© ì‹œë®¬ë ˆì´ì…˜ \n4. [ì‹œì¥ë¦¬ìŠ¤í¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (VaR, P&L, ë¯¼ê°ë„) â†’ ëŒ€ì‘ëª©í‘œ\n5. [ì‹ ìš©ë¦¬ìŠ¤í¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (ë¶€ë„ìœ¨, ì†ì‹¤ì•¡, ECL) â†’ ëŒ€ì‘ëª©í‘œ\n6. [ìì‚°ë¶€ì±„ê´€ë¦¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (NIM, ìœ ë™ì„±ë¹„ìœ¨, BPë³€í™”) â†’ ëŒ€ì‘ëª©í‘œ\n7. [ê¸€ë¡œë²Œë¦¬ìŠ¤í¬] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (í™˜ì†ìµ, ìµìŠ¤í¬ì €, CDS) â†’ ëŒ€ì‘ëª©í‘œ\n8. [ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤] í˜„í™© ìˆ˜ì¹˜ â†’ ì •ëŸ‰ì  ì˜í–¥ë„ (ì†ì‹¤ì•¡, ì§‘ì¤‘ë„, HHI) â†’ ëŒ€ì‘ëª©í‘œ\n\n## ìµœì¢… ì •ë¦¬\n9. [ì¢…í•© ì˜í–¥ë„ í‰ê°€] ëª¨ë“  ëª¨ë“ˆì˜ ì •ëŸ‰ì  ì˜í–¥ë„ë¥¼ í†µí•© (ì´ ì†ì‹¤ì•¡, RWA ì¦ê°€, ìë³¸ë¹„ìœ¨ ë³€ë™ ì¶”ì •)\n10. [í†µí•© ëŒ€ì‘ì „ëµ] ì „ì‚¬ ì°¨ì› ì •ëŸ‰ì  ëª©í‘œì¹˜ì™€ ìš°ì„ ìˆœìœ„\n11. [ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­] í•µì‹¬ ì •ëŸ‰ì§€í‘œ ë° ê²½ì˜ì§„ ì•¡ì…˜ì•„ì´í…œ\n\nâ€» ëª¨ë“  ì„¹ì…˜ì—ì„œ êµ¬ì²´ì  ìˆ˜ì¹˜, ê¸ˆì•¡, í¼ì„¼íŠ¸, BP ë“± ì •ëŸ‰ì  ë¶„ì„ê²°ê³¼ë¥¼ ëª…ì‹œí•˜ë¼. ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ì¤‘í•œ ì–´ì¡°(-ìŠµë‹ˆë‹¤, -ë©ë‹ˆë‹¤ ë“±)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ë¼.'
      };

      try {
        const resp = await fetch('risk_eng.ipynb');
        if (!resp.ok) return defaults;
        const nb = await resp.json();
        const cells = Array.isArray(nb?.cells) ? nb.cells : nb?.worksheets?.[0]?.cells || [];

        // ë‹¨ìˆœ ê·œì¹™: ë§ˆí¬ë‹¤ìš´ ë˜ëŠ” ì½”ë“œ ë‚´ì— "GPT1:", "GPT2:", "GPT3:" í”„ë¦¬í”½ìŠ¤ ì°¾ê¸°
        const roleTexts = { gpt1: '', gpt2: '', gpt3_market: '', gpt3_credit: '', gpt3_alm: '', gpt3_global: '', gpt3_creditpf: '', gpt4_final: '' };
        const extract = (text) => {
          const lines = text.split(/\r?\n/);
          for (const line of lines) {
            const m = line.match(/^\s*(GPT(?:1|2|3_(?:MARKET|CREDIT|ALM|GLOBAL|CREDITPF)|4_FINAL))\s*[:ï¼š]\s*(.+)$/i);
            if (m) {
              const key = m[1].toLowerCase();
              roleTexts[key] = (roleTexts[key] ? roleTexts[key] + ' ' : '') + m[2];
            }
          }
        };
        for (const cell of cells) {
          const srcArr = Array.isArray(cell?.source) ? cell.source : [cell?.source || ''];
          extract(srcArr.join(''));
        }

        const rolesFromRisk = {
          gpt1: roleTexts.gpt1 || defaults.gpt1,
          gpt2: roleTexts.gpt2 || defaults.gpt2,
          gpt3_market: roleTexts['gpt3_market'] || defaults.gpt3_market,
          gpt3_credit: roleTexts['gpt3_credit'] || defaults.gpt3_credit,
          gpt3_alm: roleTexts['gpt3_alm'] || defaults.gpt3_alm,
          gpt3_global: roleTexts['gpt3_global'] || defaults.gpt3_global,
          gpt3_creditpf: roleTexts['gpt3_creditpf'] || defaults.gpt3_creditpf,
          gpt4_final: roleTexts['gpt4_final'] || defaults.gpt4_final,
        };

        // UIì— ì—­í•  í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ ì±„ì›€(ìˆ˜ì • ê°€ëŠ¥)
        try {
          const setVal = (id, val) => { const el = document.getElementById(id); if (el && !el.value) el.value = val || ''; };
          setVal('gpt1-system', rolesFromRisk.gpt1);
          setVal('gpt2-system', rolesFromRisk.gpt2);
          setVal('gpt3-market-system', rolesFromRisk.gpt3_market);
          setVal('gpt3-credit-system', rolesFromRisk.gpt3_credit);
          setVal('gpt3-alm-system', rolesFromRisk.gpt3_alm);
          setVal('gpt3-global-system', rolesFromRisk.gpt3_global);
          setVal('gpt3-creditpf-system', rolesFromRisk.gpt3_creditpf);
        } catch(e) { console.warn('ì—­í•  í”„ë¡¬í”„íŠ¸ UI ì±„ìš°ê¸° ì‹¤íŒ¨', e); }

        return rolesFromRisk;
      } catch (e) {
        console.warn('risk_eng ì—­í•  íŒŒì‹± ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
        return defaults;
      }
    }

    // ====== ë²„ë¸” UI ì œê±° ======
    function buildBubbleContent(kind) {
      if (kind === 'gpt1') {
        const sys = document.getElementById('gpt1-system')?.value || '';
        const msg = document.getElementById('gpt1-message')?.value || '';
        return `ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸\n${sys}\n\në³´ë‚¼ ë©”ì‹œì§€\n${msg}`;
      }
      if (kind === 'gpt2') {
        const sys = document.getElementById('gpt2-system')?.value || '';
        const g1 = document.getElementById('gpt1-output')?.value || '';
        return `ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸\n${sys}\n\nì…ë ¥(ì´ì „ ë‹¨ê³„ ì¶œë ¥)\n${g1}`;
      }
      if (kind === 'gpt3') {
        const m = document.getElementById('gpt3-market-system')?.value || '';
        const c = document.getElementById('gpt3-credit-system')?.value || '';
        const a = document.getElementById('gpt3-alm-system')?.value || '';
        const g = document.getElementById('gpt3-global-system')?.value || '';
        const p = document.getElementById('gpt3-creditpf-system')?.value || '';
        return `ë„ë©”ì¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸\n[ì‹œì¥] ${m}\n[ì‹ ìš©] ${c}\n[ALM] ${a}\n[ê¸€ë¡œë²Œ] ${g}\n[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤] ${p}`;
      }
      if (kind === 'gpt4') {
        const o = {
          market: document.getElementById('gpt3-market')?.value || '',
          credit: document.getElementById('gpt3-credit')?.value || '',
          alm: document.getElementById('gpt3-alm')?.value || '',
          global: document.getElementById('gpt3-global')?.value || '',
          creditpf: document.getElementById('gpt3-creditpf')?.value || ''
        };
        return `ì·¨í•© ëŒ€ìƒ\n[ì‹œì¥]\n${o.market}\n\n[ì‹ ìš©]\n${o.credit}\n\n[ALM]\n${o.alm}\n\n[ê¸€ë¡œë²Œ]\n${o.global}\n\n[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤]\n${o.creditpf}`;
      }
      return '';
    }

    function openAgentBubbleAt() { /* removed */ }
    function closeAgentBubble() { /* removed */ }
    function copyBubbleContent() { /* removed */ }
    function runBubbleAgent() { /* removed */ }

    // ====== ì˜¤ë¥¸ìª½ íŒ¨ë„ ë“œë˜ê·¸ ìŠ¤í¬ë¡¤ ======
    (function enableRightDragScroll(){
      const panel = document.getElementById('gpt1-panel');
      if (!panel) return;
      let isDown = false; let startY = 0; let startScroll = 0;
      panel.addEventListener('mousedown', (e)=>{
        // ìŠ¤í¬ë¡¤ë°” ë“œë˜ê·¸ì™€ ì¶©ëŒ ë°©ì§€: ì¢Œí´ë¦­ë§Œ ì²˜ë¦¬
        if (e.button !== 0) return;
        // í…ìŠ¤íŠ¸ ì„ íƒ/í¬ì»¤ìŠ¤ ë°©ì§€
        e.preventDefault();
        isDown = true; startY = e.clientY; startScroll = panel.scrollTop; panel.classList.add('drag-scrolling');
      });
      window.addEventListener('mousemove', (e)=>{
        if (!isDown) return; const dy = e.clientY - startY; panel.scrollTop = startScroll - dy; 
      });
      window.addEventListener('mouseup', ()=>{ isDown = false; panel.classList.remove('drag-scrolling'); });
      // í„°ì¹˜ ì§€ì›
      panel.addEventListener('touchstart', (e)=>{ isDown = true; startY = e.touches[0].clientY; startScroll = panel.scrollTop; }, {passive:true});
      panel.addEventListener('touchmove', (e)=>{ if (!isDown) return; const dy = e.touches[0].clientY - startY; panel.scrollTop = startScroll - dy; }, {passive:true});
      panel.addEventListener('touchend', ()=>{ isDown = false; });
    })();
    // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œìŠ¤í…œ (ê°„ì†Œí™”ë¨)
    // ê¸°ì¡´ íŒŒì´í”„ë¼ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      const pipelineBtn = document.getElementById('pipeline-execute-btn');
      const panel = document.getElementById('gpt1-panel');
      const layout = document.querySelector('.layout');
      const gpt0Cards = document.querySelectorAll('.gpt0-module-box');
      
      console.log('íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
      
    // íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì • (ì™¸ë¶€ íŒŒì¼ë¡œ ì´ë™)
    // if (pipelineBtn && panel) {
    //   setupPipelineButton(pipelineBtn, panel, layout);
    // }
    
    console.log('íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ ì„¤ì •ì€ ì™¸ë¶€ íŒŒì¼ë¡œ ì´ë™ë¨');
    console.log('íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œ ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
    
    </script>
    
    <!-- íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ -->
    <!-- ì™¸ë¶€ pipeline_fix.js ì˜ì¡´ ì œê±°ë¨ - ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ë¡œ í†µí•© -->
    
    <script>
    // ì§„í–‰ ìƒíƒœ ì˜¤ë²„ë ˆì´ ìƒì„± í—¬í¼ í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜)
    window.createProgressOverlay = function createProgressOverlay(text) {
      const overlay = document.createElement('div');
      overlay.className = 'execution-overlay';
      overlay.innerHTML = `<div class="execution-text">${text}</div>`;
      return overlay;
    };
    
    // ğŸ”’ í”„ë¡ì‹œ ì „ìš© API ì—°ê²° í™•ì¸ (ë°°í¬ í™˜ê²½ ì „ìš©) - ì „ì—­ í•¨ìˆ˜
    window.checkAndPromptForApiKey = async function checkAndPromptForApiKey() {
      console.log('ğŸ”’ ì•ˆì „í•œ í”„ë¡ì‹œ íŒ¨í„´ ì „ìš© - í´ë¼ì´ì–¸íŠ¸ API í‚¤ ì‚¬ìš© ì•ˆí•¨');
      
      const status = document.getElementById('send-status');
      if (status) {
        status.textContent = 'ğŸ”„ OpenAI í”„ë¡ì‹œ ì—°ê²° í™•ì¸ ì¤‘...';
        status.style.color = '#3498db';
      }
      
      // í”„ë¡ì‹œ í•¨ìˆ˜ ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10ë¶„ íƒ€ì„ì•„ì›ƒ
        
        const testResp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: 'test connection' }],
            max_tokens: 5
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (testResp.ok) {
          console.log('âœ… OpenAI í”„ë¡ì‹œ ì—°ê²° ì„±ê³µ');
          if (status) {
            status.textContent = 'âœ… OpenAI í”„ë¡ì‹œ ì—°ê²° ì„±ê³µ';
            status.style.color = '#27ae60';
          }
        } else {
          throw new Error(`í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜: ${testResp.status}`);
        }
      } catch (error) {
        console.warn('âš ï¸ OpenAI í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨:', error.message);
        if (status) {
          status.textContent = `âš ï¸ í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
          status.style.color = '#e74c3c';
        }
      }

      // íŒŒì´í”„ë¼ì¸ ì™„ë£Œ (ìë™ ìŠ¤í¬ë¡¤ ì œê±°ë¨)

      // íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ì„ 'ë³´ê³ ì„œì‘ì„±' ë¹ ë¥¸ ì•¡ì…˜ìœ¼ë¡œ ì „í™˜
      try {
        const pipelineBtn = document.getElementById('pipeline-execute-btn');
        if (pipelineBtn) {
          pipelineBtn.textContent = 'ğŸ“„ GPT-4 ë³´ê³ ì„œì‘ì„±';
          pipelineBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
          pipelineBtn.style.width = '100%';
          pipelineBtn.style.padding = '8px 12px';
          pipelineBtn.style.color = 'white';
          pipelineBtn.style.fontWeight = '600';
          pipelineBtn.style.border = 'none';
          pipelineBtn.style.borderRadius = '6px';
          pipelineBtn.onclick = async () => {
            try { await handleReportAction(false); } catch(_) {}
          };
          pipelineBtn.title = 'íŒŒì´í”„ë¼ì¸ ì™„ë£Œë¨ - í´ë¦­í•˜ë©´ ë°”ë¡œ GPT-4 ê¸°ë°˜ ë³´ê³ ì„œ ì‘ì„±';
        }
      } catch(_) { /* ignore */ }
      
      return true; // ì—°ê²° í™•ì¸ ì™„ë£Œ
    };
    
    // ê¸°íƒ€ ì „ì—­ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤...
    
    // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ
    console.log('íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    
    // íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë³„ ì‹¤í–‰ - ì‹¤ì œ ì‘ì—… ìˆ˜í–‰ (ì „ì—­ í•¨ìˆ˜)
    window.executePipelineSteps = async function executePipelineSteps(progressCallback) {
        const status = document.getElementById('send-status');
        const baseMessage = document.getElementById('gpt1-message')?.value?.trim() || 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.';
        
        try {
          // íŒŒì´í”„ë¼ì¸ ì‹œì‘ ì‹œ GPT0ë¡œ ì´ˆê¸° í¬ì»¤ìŠ¤
          gotoStep(PipelineStep.GPT0);
          expandOutputFor('gpt0'); // â–¼ ì´ˆê¸° ì§„ì… ì‹œ ì¶œë ¥ ì¦‰ì‹œ í™•ì¥ ë³´ì¥
          
          // 1ë‹¨ê³„: GPT0 ì‚¬ì „ìˆ˜ì§‘ ì‹¤í–‰
          console.log('ğŸš€ 1ë‹¨ê³„: GPT0 ì‚¬ì „ìˆ˜ì§‘ ì‹¤í–‰');
          if (progressCallback) progressCallback(1, 'GPT0 ì‚¬ì „ìˆ˜ì§‘');
          status.textContent = 'GPT0 ì‚¬ì „ìˆ˜ì§‘ ì‹¤í–‰ ì¤‘...';
          
          const gpt0Element = document.querySelector('#gpt0-marketdata-box');
          if (gpt0Element) {
            gpt0Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT0 ë°ì´í„° ìˆ˜ì§‘ ì¤‘...');
            gpt0Element.appendChild(overlay);
          }
          
          await runGpt0All();
          
          if (gpt0Element) {
            gpt0Element.classList.remove('progress-indicator');
            const overlay = gpt0Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          console.log('âœ… GPT0 ì‚¬ì „ìˆ˜ì§‘ ì™„ë£Œ');
          
          // 2ë‹¨ê³„: GPT1 ì¢…í•© ë¶„ì„ ì‹¤í–‰
          console.log('ğŸš€ 2ë‹¨ê³„: GPT1 ì¢…í•© ë¶„ì„ ì‹¤í–‰');
          if (progressCallback) progressCallback(2, 'GPT1 ì¢…í•©ë¶„ì„');
          status.textContent = 'GPT1 ì¢…í•©ë¶„ì„ ì‹¤í–‰ ì¤‘.';
          
          // GPT1 ì‹œì‘ ì‹œì ì—ë§Œ GPT1ë¡œ ì´ë™ (GPT2 ì„ ì  ê¸ˆì§€)
          gotoStep(PipelineStep.GPT1);
          
          // â˜… GPT1 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt1-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
             '.gpt4-anchor']
          );
          
          const gpt1Element = document.querySelector('#card-gpt1');
          if (gpt1Element) {
            gpt1Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT1 ì¢…í•© ë¶„ì„ ì¤‘...');
            gpt1Element.appendChild(overlay);
          }
          
          // GPT1 ì‹¤í–‰ì„ ìœ„í•œ í—¤ë”ì™€ ì—­í•  ì •ë³´ ë¡œë“œ
          // ğŸ”’ ë³´ì•ˆ: getOpenAIAuthHeaders ì œê±°ë¨ - callOpenAI í•¨ìˆ˜ ì‚¬ìš©
          const roles = await loadRiskAgentRoles();
          
          // GPT0 ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ GPT1 ìš”ì•½ ìƒì„±
          const gpt0Summary = buildGpt1InputFromGpt0Outputs();
          const gpt1Input = `${baseMessage}\n\n[GPT0 ì‚¬ì „ìˆ˜ì§‘ ê²°ê³¼]\n${gpt0Summary}`;
          
          const gpt1Result = await callOpenAI(roles.gpt1, gpt1Input);
          document.getElementById('gpt1-output').value = gpt1Result || '';
          autoGrow(['gpt1-output']);
          updateGpt2ButtonState(); // UI ìƒíƒœ ì—…ë°ì´íŠ¸
          
          if (gpt1Element) {
            gpt1Element.classList.remove('progress-indicator');
            const overlay = gpt1Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          console.log('âœ… GPT1 ì¢…í•© ë¶„ì„ ì™„ë£Œ');
          // â˜… ì¤‘ìš”: GPT1 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT2 ì„ ì  ê¸ˆì§€)
          
          // 3ë‹¨ê³„: GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
          console.log('ğŸš€ 3ë‹¨ê³„: GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰');
          if (progressCallback) progressCallback(3, 'GPT2 ì‹œë‚˜ë¦¬ì˜¤');
          status.textContent = 'GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì¤‘.';
          // ğŸ”” GPT2 Worst ì§„ì… íŠ¸ë¦¬ê±° (íƒ­ì„ GPT1 ë°•ìŠ¤ë¡œ ì´ë™)
          window.dispatchEvent(new CustomEvent('gpt2worst:start'));
          
          // === GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘ ì‹œ í˜¸ì¶œ (íŠ¸ë¦¬ê±°) ===
          onGpt2WorstStartUI();
          
          // GPT2 ì‹œì‘ ì‹œì ì—ë§Œ GPT2ë¡œ ì´ë™
          gotoStep(PipelineStep.GPT2);
          
          // â˜… GPT2 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt2-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor',
             '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
             '.gpt4-anchor']
          );
          
          // ğŸ‘‰ ì˜¤ë¥¸ìª½ íƒ­ GPT2 ì¹´ë“œ ì„ íƒ
          const gpt2Element = document.querySelector('#card-gpt2');
          
          // ğŸ‘‰ GPT2 ì¹´ë“œ ì§„í–‰ì¤‘ ì‹œê° íš¨ê³¼ ON
          if (gpt2Element) {
            gpt2Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì¤‘.');
            gpt2Element.appendChild(overlay);
          }
          
          // ğŸ‘‰ GPT2 ë°•ìŠ¤ í•˜ì´ë¼ì´íŠ¸ ON
          document.querySelectorAll('.gpt2-module-box')
            .forEach(el => el.classList.add('pipeline-executing'));
          
          // (í•„ìš” ì‹œ) íŒ¨ë„ ìŠ¤í¬ë¡¤
          try {
            const panelEl = document.getElementById('gpt1-panel');
            if (panelEl && gpt2Element) {
              panelEl.scrollTo({
                top: Math.max(0, (gpt2Element.offsetTop || 0) - 40),
                behavior: 'smooth'
              });
            }
          } catch (_) { /* no-op */ }
          
          const gpt1Output = await ensureGpt1OutputReady();
          const gpt2Input = `${gpt1Output}\n\nìœ„ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ WORST CASE ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë„ì¶œí•˜ê³  ë¦¬ìŠ¤í¬ ëŒ€ì‘ë°©ì•ˆì„ ì œì‹œí•˜ì„¸ìš”.`;
          
          const gpt2Result = await callOpenAI(roles.gpt2, gpt2Input);
          document.getElementById('gpt2-output').value = gpt2Result || '';
          autoGrow(['gpt2-output']);
          // ìŠ¤í¬ë¡¤ì„ GPT2 ì¹´ë“œë¡œ ì´ë™
          setTimeout(() => scrollToElement('card-gpt2'), 100);
          
          // GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ íš¨ê³¼ ì ìš©
          setTimeout(() => {
            const gpt2Card = getAgentCard('gpt2');
            if (gpt2Card) {
              gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
              
              const gpt2Title = gpt2Card.querySelector('h4');
              if (gpt2Title) {
                gpt2Title.classList.add('text-highlight');
                gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼ ğŸ¯';
              }
              
              // 4ì´ˆ í›„ íš¨ê³¼ ì œê±°
              setTimeout(() => {
                gpt2Card.classList.remove('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
                if (gpt2Title) {
                  gpt2Title.classList.remove('text-highlight');
                  gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼';
                }
                console.log('ğŸ‰ GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ íš¨ê³¼ ì¢…ë£Œ');
              }, 4000);
            }
          }, 200);
          
          // ğŸ‘‰ GPT2 ë‹¨ê³„ ì¢…ë£Œ ì‹œ íš¨ê³¼ OFF
          if (gpt2Element) {
            gpt2Element.classList.remove('progress-indicator');
            const overlay = gpt2Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          // ğŸ‘‰ GPT2 ë°•ìŠ¤ í•˜ì´ë¼ì´íŠ¸ OFF
          document.querySelectorAll('.gpt2-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
          
          console.log('âœ… GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ');
          
          // === GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ ì‹œ í˜¸ì¶œ (ì„±ê³µ) ===
          onGpt2WorstDoneUI();
          
          // â˜… ì¤‘ìš”: GPT2 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT3 ì„ ì  ê¸ˆì§€)
          
          // GPT2 â†’ GPT3 ì „í™˜ ì‹œ GPT2 ì¹´ë“œ ì§€ì†ì  íš¨ê³¼ ì ìš©
          setTimeout(() => {
            applyGpt2PersistentEffects();
          }, 500);
          
          // 4ë‹¨ê³„: GPT3 ë¦¬ìŠ¤í¬ ë¶„ì„ ì‹¤í–‰
          console.log('ğŸš€ 4ë‹¨ê³„: GPT3 ë¦¬ìŠ¤í¬ ë¶„ì„ ì‹¤í–‰');
          if (progressCallback) progressCallback(4, 'GPT3 ë¦¬ìŠ¤í¬ë¶„ì„');
          status.textContent = 'GPT3 ë„ë©”ì¸ ì—ì´ì „íŠ¸ ì²˜ë¦¬ ì¤‘.';
          
          // GPT3 ì‹œì‘ ì‹œì ì—ë§Œ GPT3ë¡œ ì´ë™
          gotoStep(PipelineStep.GPT3);
          
          // â˜… GPT3 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']
          );
          
          const gpt3Element = document.querySelector('#card-gpt3');
          if (gpt3Element) {
            gpt3Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT3 ë„ë©”ì¸ë³„ ë¦¬ìŠ¤í¬ ë¶„ì„ ì¤‘...');
            gpt3Element.appendChild(overlay);
          }
          
          try {
            await runGpt3All();
            console.log('âœ… GPT3 ë¦¬ìŠ¤í¬ ë¶„ì„ ì™„ë£Œ');
          } catch (e) {
            console.error('âŒ GPT3 ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', e);
            status.textContent = `GPT3 ì‹¤íŒ¨: ${e.message}`;
          } finally {
            // âœ… ì–´ë–¤ ê²½ìš°ì—ë„ GPT3 ì§„í–‰ íš¨ê³¼ ì •ë¦¬
            if (gpt3Element) {
              gpt3Element.classList.remove('progress-indicator');
              const overlay = gpt3Element.querySelector('.execution-overlay');
              if (overlay) overlay.remove();
            }
            // GPT3 ëª¨ë“ˆ ë°•ìŠ¤ íš¨ê³¼ë„ ì •ë¦¬
            document.querySelectorAll('.gpt3-module-box')
              .forEach(el => el.classList.remove('pipeline-executing'));
          }
          // â˜… ì¤‘ìš”: GPT3 ì™„ë£Œ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€ (GPT4 ì„ ì  ê¸ˆì§€)
          
          // 4ë‹¨ê³„: GPT4 ìµœì¢… ë³´ê³ ì„œ ìƒì„±
          console.log('ğŸš€ 4ë‹¨ê³„: GPT4 ìµœì¢… ë³´ê³ ì„œ ìƒì„±');
          if (progressCallback) progressCallback(4, 'GPT4 ë³´ê³ ì„œ');
          console.log('ğŸš€ GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì‹œì‘ (executePipelineSteps)');
          status.textContent = 'GPT4 ìµœì¢… ë³´ê³ ì„œ ìƒì„± ì¤‘.';
          
          // GPT4 ì‹œì‘ ì‹œì ì—ë§Œ GPT4ë¡œ ì´ë™
          gotoStep(PipelineStep.GPT4);
          
          // âœ… GPT4 100ì´ˆ íƒ€ì´ë¨¸ ì„¤ì • - ì™„ë£Œ ì•ˆë˜ì–´ë„ ê°•ì œë¡œ ì „ì²´ í‘œì‹œ
          if (window.gpt4ForceCompleteTimer) clearTimeout(window.gpt4ForceCompleteTimer);
          window.gpt4ForceCompleteTimer = setTimeout(() => {
            console.log('â° GPT4 100ì´ˆ íƒ€ì´ë¨¸ ì™„ë£Œ - ê°•ì œë¡œ ì „ì²´ ë°•ìŠ¤ í‘œì‹œ');
            
            // ì „ì²´ ë°•ìŠ¤ í‘œì‹œ
            if (window.revealAllRightTabBoxes) {
              window.revealAllRightTabBoxes();
            }
            
            // ë³´ê³ ì„œ ì˜ì—­ í‘œì‹œ ë° ê°•ì¡°
            const reportActions = document.getElementById('report-actions');
            if (reportActions) {
              reportActions.style.display = 'flex';
              reportActions.classList.add('report-actions-cta');
              console.log('âœ… ë³´ê³ ì„œ ì‘ì—… ì˜ì—­ í‘œì‹œ ë° ê°•ì¡°');
              
              // 4ì´ˆ í›„ ê°•ì¡° íš¨ê³¼ ì œê±°
              setTimeout(() => {
                reportActions.classList.remove('report-actions-cta');
              }, 4000);
            }
            
            // íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì²˜ë¦¬
            document.body.classList.add('pipeline-complete');
            
            // ì™„ë£Œ ì´ë²¤íŠ¸ ë°œìƒ
            try { 
              window.dispatchEvent(new Event('gpt4:complete')); 
              window.dispatchEvent(new Event('gpt4:done')); 
            } catch (e) {}
            
            console.log('âœ… GPT4 100ì´ˆ ê°•ì œ ì™„ë£Œ ì²˜ë¦¬ë¨');
          }, 100000); // 100ì´ˆ
          console.log('â±ï¸ GPT4 100ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘ë¨');
          
          // âœ… GPT3 ì‹¤í–‰ ë°•ìŠ¤ íš¨ê³¼ í•´ì œ(ì”ë¥˜ ê³ ì • ë°©ì§€)
          document.querySelectorAll('.gpt3-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));

          // âœ… ìš°ì¸¡ íŒ¨ë„ ìŠ¤í¬ë¡¤ì„ GPT4 ì¹´ë“œ/ì•µì»¤ë¡œ ê°•ì œ
          window.scrollAnchorIntoView?.('.gpt4-anchor');
          
          // â˜… GPT4 íƒ­ ëŸ¬ë‹ í† ê¸€
          window.setRightTabRunning(
            ['.gpt4-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor',
             '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf']
          );
          
          const gpt4Element = document.querySelector('#card-gpt4');
          if (gpt4Element) {
            gpt4Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT4 ìµœì¢… ë³´ê³ ì„œ ìƒì„± ì¤‘...');
            gpt4Element.appendChild(overlay);
          }
          
          // âœ… GPT4 ìƒì„± ê²½ë¡œ ë‹¨ì¼í™”: generateStepByStepReportë§Œ ì‚¬ìš©
          console.log('ğŸš€ GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì‹œì‘ (executePipelineSteps)');
          const gpt4Output = await generateStepByStepReport(roles.gpt4_final);
          console.log('âœ… GPT4 ë‹¨ê³„ë³„ ë³´ê³ ì„œ ì‘ì„± ì™„ë£Œ (executePipelineSteps)');
          
          // âœ… GPT4 ì •ìƒ ì™„ë£Œ ì‹œ íƒ€ì´ë¨¸ ì·¨ì†Œ
          if (window.gpt4ForceCompleteTimer) {
            clearTimeout(window.gpt4ForceCompleteTimer);
            window.gpt4ForceCompleteTimer = null;
            console.log('â±ï¸ GPT4 ì •ìƒ ì™„ë£Œë¡œ 100ì´ˆ íƒ€ì´ë¨¸ ì·¨ì†Œë¨');
          }
          
          try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
          if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
          console.log('ğŸ“Š GPT4 ì¶œë ¥ ê¸¸ì´:', gpt4Output ? gpt4Output.length : 0);
          
          // ë³´ê³ ì„œ ì˜ì—­ í‘œì‹œ ë° ê°•ì¡°
          const reportActions = document.getElementById('report-actions');
          if (reportActions) {
            reportActions.style.display = 'flex';
            reportActions.classList.add('report-actions-cta');
            setTimeout(() => {
              reportActions.classList.remove('report-actions-cta');
            }, 4000);
          }
          
          // âœ… ì•ˆì „í•œ GPT4 ì¶œë ¥ ì—…ë°ì´íŠ¸ (ë¹ˆ ì‘ë‹µ ë®ì–´ì“°ê¸° ê¸ˆì§€)
          const currentOutput = document.getElementById('gpt4-output').value;
          if (!currentOutput || currentOutput.trim().length === 0 || currentOutput.includes('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì§€ë§Œ')) {
            document.getElementById('gpt4-output').value = (gpt4Output || '');
            console.log('ğŸ“ GPT4 ì¶œë ¥ ì—…ë°ì´íŠ¸ë¨ (executePipelineSteps)');
          } else {
            console.log('ğŸ“ GPT4 ì¶œë ¥ ì´ë¯¸ ì¡´ì¬í•¨, ë®ì–´ì“°ê¸° ë°©ì§€ (executePipelineSteps)');
          }
          
          if (gpt4Element) {
            gpt4Element.classList.remove('progress-indicator');
            const overlay = gpt4Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          console.log('âœ… GPT4 ìµœì¢… ë³´ê³ ì„œ ì™„ë£Œ');
          try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
          if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
          status.textContent = 'íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ!';
          
          // íŒŒì´í”„ë¼ì¸ ìƒíƒœ ì´ˆê¸°í™”
          graphState.pipelineRunning = false;
          if (graphState.lockedHighlight) {
            graphState.lockedHighlight = null;
          }
          
          // ëª¨ë“  íŒŒì´í”„ë¼ì¸ ì‹œê°ì  íš¨ê³¼ ì œê±°
          stopAllEffects();
          
          // â˜… íŒŒì´í”„ë¼ì¸ ìµœì¢… ì¢…ë£Œ ì‹œ ì „ì²´ í•´ì œ(í´ë¦°ì—…)
          try {
            window.setRightTabRunning([], [
              '.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
              '.gpt1-anchor','.gpt2-anchor',
              '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
              '.gpt4-anchor'
            ]);
            // í•„ìš”ì‹œ ë¼ì¸/ë°•ìŠ¤ íš¨ê³¼ ì „ì²´ í•´ì œ
            if (typeof setFlow === 'function') setFlow(null);
          } catch(_) {}
          
          // âœ… GPT3/4 ê´€ë ¨ ì‹¤í–‰ íš¨ê³¼ ì¢…ë£Œ (ë°•ìŠ¤ íš¨ê³¼ê°€ ë‚¨ëŠ” ë¬¸ì œ ì˜ˆë°©)
          setFlow(null);
          d3.selectAll('.gpt3-anchor-market, .gpt3-anchor-credit, .gpt3-anchor-alm, .gpt3-anchor-global, .gpt3-anchor-creditpf, .gpt4-anchor')
            .classed('agent-running', false);
          document.querySelectorAll('.pipeline-executing').forEach(el => el.classList.remove('pipeline-executing'));
          document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
            .forEach(el => el.classList.remove('running'));
          
          // ğŸ“Œ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ ë³´ê³ ì„œ ì˜ì—­ìœ¼ë¡œ ìë™ ì´ë™ + CTA ê°•ì¡°
          try {
            const panel = document.getElementById('gpt1-panel');
            const reportActions = document.getElementById('report-actions');
            if (panel && reportActions) {
              const y = Math.max(0, (reportActions.offsetTop || 0) - 40);
              panel.scrollTo({ top: y, behavior: 'smooth' });
              reportActions.classList.add('report-actions-cta');
              const btn = document.getElementById('btn-export-html');
              btn && btn.classList.add('report-cta');
              setTimeout(() => {
                reportActions.classList.remove('report-actions-cta');
                btn && btn.classList.remove('report-cta');
              }, 5000);
            }
          } catch (_) { /* ignore */ }
          
        } catch (error) {
          console.error('âŒ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
          status.textContent = `ì˜¤ë¥˜: ${error.message}`;
          
          // íŒŒì´í”„ë¼ì¸ ìƒíƒœ ì´ˆê¸°í™”
          graphState.pipelineRunning = false;
          if (graphState.lockedHighlight) {
            graphState.lockedHighlight = null;
          }
          
          // ëª¨ë“  íŒŒì´í”„ë¼ì¸ ì‹œê°ì  íš¨ê³¼ ì œê±°
          stopAllEffects();
          
          // âœ… GPT3/4 ê´€ë ¨ ì‹¤í–‰ íš¨ê³¼ ì¢…ë£Œ (ë°•ìŠ¤ íš¨ê³¼ê°€ ë‚¨ëŠ” ë¬¸ì œ ì˜ˆë°©)
          setFlow(null);
          d3.selectAll('.gpt3-anchor-market, .gpt3-anchor-credit, .gpt3-anchor-alm, .gpt3-anchor-global, .gpt3-anchor-creditpf, .gpt4-anchor')
            .classed('agent-running', false);
          document.querySelectorAll('.pipeline-executing').forEach(el => el.classList.remove('pipeline-executing'));
          document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
            .forEach(el => el.classList.remove('running'));
          
          // ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª¨ë“  ì§„í–‰ ìƒíƒœ ì •ë¦¬
          document.querySelectorAll('.progress-indicator').forEach(el => {
            el.classList.remove('progress-indicator');
          });
          document.querySelectorAll('.execution-overlay').forEach(el => {
            el.remove();
          });
          
          throw error;
        }
      }; // executePipelineSteps í•¨ìˆ˜ ì¢…ë£Œ
    
    console.log('íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œ ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
    
    </script>
    
    <!-- íŒŒì´í”„ë¼ì¸ ë²„íŠ¼ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ -->
    <!-- ì™¸ë¶€ pipeline_fix.js ì˜ì¡´ ì œê±°ë¨ - ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ë¡œ í†µí•© -->
    
    <script>
    // ì§„í–‰ ìƒíƒœ ì˜¤ë²„ë ˆì´ ìƒì„± í—¬í¼ í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜)
    window.createProgressOverlay = function createProgressOverlay(text) {
            const overlay = document.createElement('div');
            overlay.className = 'execution-overlay';
      overlay.innerHTML = `<div class="execution-text">${text}</div>`;
      return overlay;
    };
    
    // ğŸ”’ í”„ë¡ì‹œ ì „ìš© API ì—°ê²° í™•ì¸ (ë°°í¬ í™˜ê²½ ì „ìš©) - ì „ì—­ í•¨ìˆ˜
    window.checkAndPromptForApiKey = async function checkAndPromptForApiKey() {
      console.log('ğŸ”’ ì•ˆì „í•œ í”„ë¡ì‹œ íŒ¨í„´ ì „ìš© - í´ë¼ì´ì–¸íŠ¸ API í‚¤ ì‚¬ìš© ì•ˆí•¨');
      
      const status = document.getElementById('send-status');
      if (status) {
        status.textContent = 'ğŸ”„ OpenAI í”„ë¡ì‹œ ì—°ê²° í™•ì¸ ì¤‘...';
        status.style.color = '#3498db';
      }
      
      // í”„ë¡ì‹œ í•¨ìˆ˜ ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10ë¶„ íƒ€ì„ì•„ì›ƒ
        
        const testResp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: 'test connection' }],
            max_tokens: 5
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (testResp.ok) {
          console.log('âœ… OpenAI í”„ë¡ì‹œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
          if (status) {
            status.textContent = 'âœ… OpenAI í”„ë¡ì‹œ ì—°ê²° ì„±ê³µ';
            status.style.color = '#27ae60';
            setTimeout(() => {
              status.textContent = '';
              status.style.color = '';
            }, 3000);
          }
          return true;
        } else {
          const errData = await testResp.json().catch(() => ({}));
          console.error('âŒ OpenAI í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', testResp.status, errData);
          
          if (testResp.status === 404) {
            if (status) {
              status.textContent = 'âŒ í”„ë¡ì‹œ í•¨ìˆ˜ê°€ ë°°í¬ë˜ì§€ ì•ŠìŒ - Netlify ë°°í¬ í™•ì¸ í•„ìš”';
              status.style.color = '#e74c3c';
            }
          } else if (errData.code === 'MISSING_API_KEY') {
            if (status) {
              status.innerHTML = `
                <div style="text-align: left; font-size: 12px; color: #e74c3c;">
                  <strong>âŒ Netlify í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY ì„¤ì • í•„ìš”</strong><br>
                  1. Netlify ëŒ€ì‹œë³´ë“œ â†’ Site settings<br>
                  2. Environment variables â†’ Add variable<br>
                  3. Key: OPENAI_API_KEY, Value: sk-your-key<br>
                  4. Deploy â†’ Trigger deploy
                </div>
              `;
            }
          } else {
            if (status) {
              status.textContent = `âŒ í”„ë¡ì‹œ ì˜¤ë¥˜: ${errData.error || 'Unknown error'}`;
              status.style.color = '#e74c3c';
            }
          }
          return false;
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          console.error('âŒ OpenAI í”„ë¡ì‹œ ì—°ê²° íƒ€ì„ì•„ì›ƒ');
          if (status) {
            status.textContent = 'âŒ í”„ë¡ì‹œ ì—°ê²° íƒ€ì„ì•„ì›ƒ - ë„¤íŠ¸ì›Œí¬ í™•ì¸ í•„ìš”';
            status.style.color = '#e74c3c';
          }
        } else {
          console.error('âŒ OpenAI í”„ë¡ì‹œ ì—°ê²° ì˜¤ë¥˜:', e.message);
          if (status) {
            status.textContent = 'âŒ ë„¤í”Œë¦¬íŒŒì´ í•¨ìˆ˜ ë°°í¬ ìƒíƒœ í™•ì¸ í•„ìš”';
            status.style.color = '#e74c3c';
          }
        }
        return false;
      }
    };
    
    // ğŸ”’ ë³´ì•ˆ ê°œì„ ëœ íŒŒì´í”„ë¼ì¸ ê²€ì¦ (API í‚¤ í™•ì¸ ìƒëµ) - ì „ì—­ í•¨ìˆ˜
    window.validatePipelineRequirements = async function validatePipelineRequirements() {
      const issues = [];
      
      // OpenAI í”„ë¡ì‹œ ì—°ê²° í™•ì¸ (API í‚¤ í™•ì¸ ëŒ€ì‹ )
      if (!(await window.checkAndPromptForApiKey())) {
        issues.push('OpenAI í”„ë¡ì‹œ í•¨ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      
      // í•„ìˆ˜ DOM ìš”ì†Œ í™•ì¸
      const requiredElements = [
        '#send-status',
        '#gpt1-output',
        '#gpt2-output'
      ];
      
      requiredElements.forEach(selector => {
        if (!document.querySelector(selector)) {
          issues.push(`í•„ìˆ˜ ìš”ì†Œ ${selector}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }
      });
      
      return issues;
    };
    
    // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì„±ê³µ í›„ ê²°ê³¼ ìš”ì•½ (ì „ì—­ í•¨ìˆ˜)
    window.showPipelineResults = function showPipelineResults() {
      const results = [];
      
      const gpt1Output = document.getElementById('gpt1-output')?.value;
      const gpt2Output = document.getElementById('gpt2-output')?.value;
      const gpt3MarketOutput = document.getElementById('gpt3-market')?.value;
      const gpt4Output = document.getElementById('gpt4-output')?.value;
      
      if (gpt1Output) results.push('âœ… GPT1 ì¢…í•©ë¶„ì„ ì™„ë£Œ');
      if (gpt2Output) results.push('âœ… GPT2 WORST ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ');
      if (gpt3MarketOutput) results.push('âœ… GPT3 ë¦¬ìŠ¤í¬ë¶„ì„ ì™„ë£Œ');
      if (gpt4Output) results.push('âœ… GPT4 ë³´ê³ ì„œ(ìš”ì•½3) ì™„ë£Œ');
      
      const summary = `ğŸ‰ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ!

${results.join('\n')}

ì´ ${results.length}ê°œ ë¶„ì„ ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
ìš°ì¸¡ íŒ¨ë„ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;

      console.log(summary);
      return results.length;
    };
    
    // ë³´ê³ ì„œ ìƒì„± ë° í‘œì‹œ (ì „ì—­ í•¨ìˆ˜)
    window.generateAndShowReport = async function generateAndShowReport({ force = false } = {}) {
        console.log('ğŸ“„ ìµœì¢… ë³´ê³ ì„œ ìƒì„± ì¤‘...');
        
        // ê¸°ì¡´ ë³´ê³ ì„œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (ì¤‘ë³µ ê°€ë“œ ì ìš©)
        if (typeof generateHTMLReportDirect === 'function') {
          await generateHTMLReportDirect({ force });
        } else {
          console.log('ë³´ê³ ì„œ ìƒì„± í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    };
    
    // íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì‹œ ë³´ê³ ì„œì‘ì„± ì˜ì—­ìœ¼ë¡œ ìë™ ìŠ¤í¬ë¡¤
    function scrollToReportSection() {
      const panel = document.getElementById('gpt1-panel');
      if (!panel) return;

      // âœ… ë“œë˜ê·¸ ì¤‘ì´ë©´ ê°œì… ê¸ˆì§€
      if (window.__userDraggingTab) return;

      // âœ… ë¬´ì‘ìœ„ ì œê±°: í•­ìƒ ë³´ê³ ì„œ ì‘ì—… ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      const reportActions = document.getElementById('report-actions');
      if (reportActions) {
        const y = Math.max(0, (reportActions.offsetTop || 0) - 40);
        panel.scrollTo({ top: y, behavior: 'smooth' });

        // CTA ê°•ì¡° (ê¸°ì¡´ ìœ ì§€)
        reportActions.classList.add('report-actions-cta');
        const btn = document.getElementById('btn-export-html');
        btn && btn.classList.add('report-cta');
        setTimeout(() => {
          reportActions.classList.remove('report-actions-cta');
          btn && btn.classList.remove('report-cta');
        }, 4000);
      }
      
      console.log('âœ… íŒŒì´í”„ë¼ì¸ ì™„ë£Œ - ë³´ê³ ì„œ ì‘ì—… ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤');
    }
    
    // API í‚¤ ìƒíƒœ í™•ì¸ ë””ë²„ê·¸ í•¨ìˆ˜ (ê°œë°œì ë„êµ¬ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
    window.debugApiKeyStatus = async function() {
      console.log('ğŸ” === ë³´ì•ˆ ê°•í™”ëœ OpenAI í”„ë¡ì‹œ ìƒíƒœ ë””ë²„ê¹… ===');
      console.log('ğŸ”’ í´ë¼ì´ì–¸íŠ¸ API í‚¤ ì‚¬ìš© ê¸ˆì§€ - í”„ë¡ì‹œ ì „ìš© ëª¨ë“œ');
      console.log('ğŸ“ API í‚¤ ì •ë³´ëŠ” ë³´ì•ˆìƒ í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      
      console.log('\nğŸš« ë ˆê±°ì‹œ API í‚¤ í™•ì¸ í•¨ìˆ˜ëŠ” ë³´ì•ˆìƒ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      console.log('ğŸ’¡ í™˜ê²½ë³€ìˆ˜ ìƒíƒœëŠ” Netlify ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
      
      console.log('\nğŸ”’ OpenAI í”„ë¡ì‹œ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸:');
      try {
        console.log('  ğŸ”„ /.netlify/functions/openai-proxy í…ŒìŠ¤íŠ¸ ì¤‘...');
        const proxyResp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: 'test' }],
            max_tokens: 5
          })
        });
        
        console.log(`  ğŸ“¡ í”„ë¡ì‹œ ì‘ë‹µ: ${proxyResp.status} ${proxyResp.statusText}`);
        
        if (proxyResp.ok) {
          console.log('  âœ… í”„ë¡ì‹œ í•¨ìˆ˜: ì •ìƒ ì‘ë™ ì¤‘');
        } else if (proxyResp.status === 404) {
          console.log('  âŒ í”„ë¡ì‹œ í•¨ìˆ˜: ë°°í¬ë˜ì§€ ì•ŠìŒ (404)');
          console.log('  ğŸ’¡ í•´ê²°ë°©ë²•: í”„ë¡œì íŠ¸ë¥¼ Netlifyì— ì¬ë°°í¬ í•„ìš”');
        } else {
          const errorData = await proxyResp.json().catch(() => ({}));
          if (errorData.code === 'MISSING_API_KEY') {
            console.log('  âŒ í”„ë¡ì‹œ í•¨ìˆ˜: í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY ë¯¸ì„¤ì •');
            console.log('  ğŸ’¡ í•´ê²°ë°©ë²•: Netlify ëŒ€ì‹œë³´ë“œì—ì„œ í™˜ê²½ë³€ìˆ˜ ì„¤ì • í›„ ì¬ë°°í¬');
          } else {
            console.log(`  âš ï¸ í”„ë¡ì‹œ í•¨ìˆ˜: ì˜¤ë¥˜ ë°œìƒ (${errorData.error || 'Unknown'})`);
          }
        }
      } catch (e) {
        console.log(`  âŒ í”„ë¡ì‹œ í•¨ìˆ˜: ì—°ê²° ì‹¤íŒ¨ (${e.message})`);
        console.log('  ğŸ’¡ ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì´ê±°ë‚˜ ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” netlify dev í•„ìš”');
      }
      
      console.log('\nğŸ¯ Netlify í™˜ê²½ë³€ìˆ˜ ì„¤ì • ê°€ì´ë“œ:');
      console.log('1. Netlify ëŒ€ì‹œë³´ë“œ â†’ Site settings â†’ Environment variables');
      console.log('2. ìƒˆ ë³€ìˆ˜ ì¶”ê°€: OPENAI_API_KEY = sk-your-openai-api-key');
      console.log('3. ì‚¬ì´íŠ¸ ì¬ë°°í¬ (Deploy íƒ­ì—ì„œ Trigger deploy)');
      
      console.log('\nğŸ›  ë””ë²„ê·¸ ëª…ë ¹ì–´:');
      console.log('- debugApiKeyStatus(): ì´ í•¨ìˆ˜ ì‹¤í–‰');
      console.log('- testOpenAIProxy(): í”„ë¡ì‹œ í•¨ìˆ˜ ì§ì ‘ í…ŒìŠ¤íŠ¸');
      console.log('- checkDomainRouting(): ë„ë©”ì¸ ë¼ìš°íŒ… í™•ì¸');
    };
    
    // ğŸ“¡ OpenAI í”„ë¡ì‹œ ì§ì ‘ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    window.testOpenAIProxy = async function() {
      console.log('ğŸ” === OpenAI í”„ë¡ì‹œ ì§ì ‘ í…ŒìŠ¤íŠ¸ ===');
      
      const testUrls = [
        `${location.origin}/.netlify/functions/openai-proxy`,
        'https://chartupndown.com/.netlify/functions/openai-proxy'
      ];
      
      for (const url of testUrls) {
        console.log(`\nğŸ“¡ í…ŒìŠ¤íŠ¸ URL: ${url}`);
        
        try {
          // GET ìš”ì²­ìœ¼ë¡œ í•¨ìˆ˜ ìƒíƒœ í™•ì¸
          const getResp = await fetch(url, { method: 'GET' });
          console.log(`  GET ${getResp.status}: ${getResp.statusText}`);
          
          if (getResp.ok) {
            const data = await getResp.json();
            console.log('  ğŸ“¦ ì‘ë‹µ ë°ì´í„°:', data);
          } else {
            const errorText = await getResp.text().catch(() => 'Unknown error');
            console.log(`  âŒ ì˜¤ë¥˜: ${errorText}`);
          }
        } catch (e) {
          console.log(`  âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${e.message}`);
        }
      }
    };
    
    // ğŸŒ ë„ë©”ì¸ ë¼ìš°íŒ… í™•ì¸ í•¨ìˆ˜
    window.checkDomainRouting = async function() {
      console.log('ğŸ” === ë„ë©”ì¸ ë¼ìš°íŒ… ìƒíƒœ í™•ì¸ ===');
      console.log(`í˜„ì¬ ë„ë©”ì¸: ${location.hostname}`);
      console.log(`ì „ì²´ URL: ${location.href}`);
      
      // ì‘ë‹µ í—¤ë”ì—ì„œ Netlify í™•ì¸
      try {
        const resp = await fetch(location.origin);
        const headers = {};
        for (const [key, value] of resp.headers.entries()) {
          if (key.toLowerCase().includes('netlify') || key.toLowerCase().includes('nf')) {
            headers[key] = value;
          }
        }
        
        if (Object.keys(headers).length > 0) {
          console.log('âœ… Netlify í—¤ë” ê°ì§€:');
        } else {
          console.log('âš ï¸ Netlify í—¤ë” ì—†ìŒ - DNS ì„¤ì • í™•ì¸ í•„ìš”');
        }
      } catch (e) {
        console.log(`âŒ ë„ë©”ì¸ í™•ì¸ ì‹¤íŒ¨: ${e.message}`);
      }
    };
    
    console.log('ğŸ’¡ ë””ë²„ê·¸ ë„êµ¬: ê°œë°œì ë„êµ¬ì—ì„œ ë‹¤ìŒ í•¨ìˆ˜ë“¤ ì‹¤í–‰ ê°€ëŠ¥');
    console.log('- debugApiKeyStatus(): í”„ë¡ì‹œ ìƒíƒœ í™•ì¸');
    console.log('- testOpenAIProxy(): í”„ë¡ì‹œ í•¨ìˆ˜ ì§ì ‘ í…ŒìŠ¤íŠ¸');
    console.log('- checkDomainRouting(): ë„ë©”ì¸ ë¼ìš°íŒ… í™•ì¸');
    
    // ì‹œë‚˜ë¦¬ì˜¤ PDF ìƒˆì°½ ì—´ê¸° í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ë®ì–´ì“°ê¸°)
    window.openScenarioPDF = function(n, scenarioId) {
      // 01~09ê¹Œì§€ëŠ” ë‘ ìë¦¬ íŒ¨ë”©, 10 ì´ìƒì€ ê·¸ëŒ€ë¡œ
      const folderName = String(n).padStart(2, '0');
      const pdfPath = `go_scen/scen/${folderName}/scenario_${folderName}.pdf`;
      const pdfTitle = `ì‹œë‚˜ë¦¬ì˜¤ ${n}: ${scenarioId || 'ìƒì„¸ ë³´ê³ ì„œ'}`;
      
      console.log(`ğŸ“– ì‹œë‚˜ë¦¬ì˜¤ PDF ìƒˆì°½ ì—´ê¸°: ${pdfTitle}`);
      console.log(`ğŸ“‚ PDF ê²½ë¡œ: ${pdfPath}`);
      
      // ìƒˆ ì°½ì—ì„œ PDF ì§ì ‘ ì—´ê¸°
      try {
        const newWindow = window.open(pdfPath, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (newWindow) {
          newWindow.focus();
          console.log('âœ… PDF ìƒˆì°½ ì—´ê¸° ì„±ê³µ');
        } else {
          // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš° ëŒ€ì²´ ë°©ë²•
          console.warn('íŒì—…ì´ ì°¨ë‹¨ë¨, ì§ì ‘ ë§í¬ ì—´ê¸° ì‹œë„');
          const link = document.createElement('a');
          link.href = pdfPath;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      } catch (error) {
        console.error('PDF ì—´ê¸° ì‹¤íŒ¨:', error);
        alert(`ì‹œë‚˜ë¦¬ì˜¤ PDFë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
      }
    };
    // ìš°ì¸¡ íŒ¨ë„ì—ì„œ ì„¼í„°ë§/ì¤Œ ì œì–´
    function onCenterScenario() {
      const n = document.getElementById('center-input').value;
      if (!n) return;
      highlightScenario(n);
      centerOnScenario(n, 1.3);
    }
    function onZoomIn() { zoomDelta(1); }
    function onZoomOut() { zoomDelta(-1); }

    // ====== risk_eng ë‚´ìš© ë¡œë”© ======
    async function loadRiskEngContent() {
      try {
        // ë…¸íŠ¸ë¶ ì›ë³¸ì„ í…ìŠ¤íŠ¸ë¡œ ë¡œë“œ í›„, ìƒë‹¨ ë©”íƒ€/ë§ˆí¬ë‹¤ìš´ ì¼ë¶€ë§Œ ìš”ì•½ í‘œì‹œ
        const resp = await fetch('risk_eng.ipynb');
        if (!resp.ok) throw new Error('risk_eng.ipynb ë¡œë“œ ì‹¤íŒ¨');
        const nb = await resp.json();
        const cells = Array.isArray(nb?.cells) ? nb.cells : nb?.worksheets?.[0]?.cells || [];
        let preview = '';
        for (const cell of cells) {
          if (cell.cell_type === 'markdown' && Array.isArray(cell.source)) {
            preview += cell.source.join('');
          } else if (cell.cell_type === 'markdown' && typeof cell.source === 'string') {
            preview += cell.source;
          }
          if (preview.length > 1200) break;
        }
        if (!preview) preview = 'ë…¸íŠ¸ë¶ì— í‘œì‹œí•  ë§ˆí¬ë‹¤ìš´ ì…€ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì½”ë“œ/ê²°ê³¼ëŠ” ë…¸íŠ¸ë¶ì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
        document.getElementById('risk-eng-content').textContent = preview;
      } catch (e) {
        document.getElementById('risk-eng-content').textContent = 'risk_eng.ipynbë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
        console.error(e);
      }
    }

    // ====== GPT3 ê°€ì´ë“œ TXT ì—…ë¡œë“œ ì²˜ë¦¬ (ë„ë©”ì¸ë³„) ======
    (function setupGpt3Guideline(){
      const setup = (id, nameId, key) => {
        const input = document.getElementById(id);
        const nameEl = document.getElementById(nameId);
        if (!input) return;
        input.addEventListener('change', async (e)=>{
          const file = e.target.files?.[0];
          if (!file) return;
          nameEl.textContent = file.name;
          try {
            const text = await file.text();
            window.gpt3Guidelines = window.gpt3Guidelines || {};
            window.gpt3Guidelines[key] = text.slice(0, 200000);
          } catch(_) { /* ignore */ }
        });
      };
      setup('gpt3-market-guideline', 'gpt3-market-guideline-name', 'market');
      setup('gpt3-credit-guideline', 'gpt3-credit-guideline-name', 'credit');
      setup('gpt3-alm-guideline', 'gpt3-alm-guideline-name', 'alm');
      setup('gpt3-global-guideline', 'gpt3-global-guideline-name', 'global');
      setup('gpt3-creditpf-guideline', 'gpt3-creditpf-guideline-name', 'creditpf');
    })();

    // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ëŒ€ê¸° í•¨ìˆ˜
    function waitForLibraries() {
      return new Promise((resolve) => {
        const checkLibraries = () => {
          if (typeof Chart !== 'undefined' && typeof d3 !== 'undefined' && typeof XLSX !== 'undefined') {
            console.log('ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì™„ë£Œ');
            resolve();
          } else {
            console.log('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ëŒ€ê¸° ì¤‘...');
            setTimeout(checkLibraries, 100);
          }
        };
        checkLibraries();
      });
    }
    
    // ì•± ì‹œì‘
    async function startApp() {
      try {
        initializeTheme();
        await waitForLibraries();
        await initializeApp();
        // ê¸°ë³¸ ì—­í•  í”„ë¡¬í”„íŠ¸ë¥¼ UIì— ì±„ì›€ (ì‚¬ìš©ì ìˆ˜ì • ê°€ëŠ¥)
        try { await loadRiskAgentRoles(); } catch(_) {}
        renderScenarioList();
        // ì´ˆê¸° UI ìƒíƒœ ì„¤ì •
        updateGpt2ButtonState();
        // ì´ˆê¸° ë Œë” ì•ˆì •í™”: ë ˆì´ì•„ì›ƒ/í°íŠ¸ ë¡œë”© í›„ í•œ ë²ˆ ë” ê°•ì œ ë Œë”
        warmFirstRender();
      } catch (e) {
        console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
        // ì‹¤íŒ¨í•˜ë”ë¼ë„ ê¸°ë³¸ UIëŠ” ë³´ì´ë„ë¡ ì‹œë„
        try { initializeApp(); } catch(_) {}
        // ì‹¤íŒ¨ ì¼€ì´ìŠ¤ì—ì„œë„ ì´ˆê¸° ë Œë” ë³´ì • ì‹œë„
        try { warmFirstRender(); } catch(_) {}
      }
    }
    
    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        console.log('ğŸ–¥ï¸ ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ê°ì§€ - ë„¤íŠ¸ì›Œí¬ ë‹¤ì‹œ ë Œë”ë§');
        renderNetwork();
      }, 300); // 300ms ë””ë°”ìš´ìŠ¤
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹œì‘
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }
    // onload/page-show ì‹œì ì—ë„ í•œ ë²ˆ ë” ë Œë” ë³´ì • (BFCache ë³µê·€ í¬í•¨)
    window.addEventListener('load', () => { try { warmFirstRender(); } catch(_) {} });
    window.addEventListener('pageshow', () => { try { warmFirstRender(); } catch(_) {} });

    // âœ… ì´ˆê¸° ìƒíƒœ: ëª¨ë“  GPT ì¹´ë“œ ì´ˆê¸°í™” (ì´ˆë¡ìƒ‰ ì œê±°)
    function initializeGptCardsState() {
      console.log('ğŸ”„ GPT ì¹´ë“œ ì´ˆê¸° ìƒíƒœ ì„¤ì • ì‹œì‘');
      
      // ëª¨ë“  GPT ì¹´ë“œì—ì„œ running, done, active í´ë˜ìŠ¤ ì œê±°
      const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      allCards.forEach(idSuffix => {
        const card = getAgentCard(idSuffix);
        if (card) {
          card.classList.remove('running', 'done', 'active', 'expanded');
          console.log(`- ${idSuffix} ì¹´ë“œ ì´ˆê¸°í™” ì™„ë£Œ`);
        }
      });
      
      console.log('âœ… GPT ì¹´ë“œ ì´ˆê¸° ìƒíƒœ ì„¤ì • ì™„ë£Œ');
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì‹¤í–‰
    window.addEventListener('DOMContentLoaded', initializeGptCardsState);
    window.addEventListener('load', initializeGptCardsState);

    // ğŸ“± Wake Lock (í™”ë©´ êº¼ì§ ë°©ì§€) ê¸°ëŠ¥
    let wakeLock = null;
    
    // Wake Lock í™œì„±í™” í•¨ìˆ˜
    async function requestWakeLock() {
      try {
        // Wake Lock API ì§€ì› ì²´í¬
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('ğŸ”’ Wake Lock í™œì„±í™”: í™”ë©´ êº¼ì§ ë°©ì§€');
          
          // Wake Lock í•´ì œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          wakeLock.addEventListener('release', () => {
            console.log('ğŸ”“ Wake Lock í•´ì œë¨');
          });
          
          return true;
        } else {
          console.warn('âš ï¸ Wake Lock APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
          return false;
        }
      } catch (err) {
        console.error('âŒ Wake Lock í™œì„±í™” ì‹¤íŒ¨:', err.message);
        return false;
      }
    }
    
    // Wake Lock í•´ì œ í•¨ìˆ˜
    async function releaseWakeLock() {
      if (wakeLock !== null) {
        try {
          await wakeLock.release();
          wakeLock = null;
          console.log('âœ… Wake Lock ì •ìƒ í•´ì œ');
        } catch (err) {
          console.error('âŒ Wake Lock í•´ì œ ì‹¤íŒ¨:', err.message);
        }
      }
    }
    
    // í˜ì´ì§€ visibility ë³€ê²½ ì‹œ Wake Lock ì¬í™œì„±í™”
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && wakeLock !== null) {
        console.log('ğŸ“± í˜ì´ì§€ ë‹¤ì‹œ í™œì„±í™” - Wake Lock ì¬ìš”ì²­');
        await requestWakeLock();
      }
    });
    
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ Wake Lock ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (wakeLock !== null) {
        releaseWakeLock();
      }
    });

    // âœ… ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€ í•¨ìˆ˜
    function isMobileEnvironment() {
      return window.innerWidth <= 900; // ëª¨ë°”ì¼ ì„¸ë¡œ/ê°€ë¡œ ëª¨ë‘ í¬í•¨
    }

    // âœ… ëª¨ë°”ì¼ì—ì„œ GPT ì¹´ë“œ í‘œì‹œ ì œì–´ í•¨ìˆ˜
    function showOnlyGpt0CardMobile() {
      if (!isMobileEnvironment()) return false; // ëª¨ë°”ì¼ì´ ì•„ë‹ˆë©´ ê¸°ì¡´ ë™ì‘
      
      console.log('ğŸ“± ëª¨ë°”ì¼ í™˜ê²½ - GPT0 ì¹´ë“œë§Œ í‘œì‹œ');
      
      const panel = $rightPanel();
      if (panel) {
        panel.classList.add('mobile-initial-mode');
        panel.classList.remove('show-all', 'solo-mode');
      }
      
      // GPT0ë§Œ í‘œì‹œ, ë‚˜ë¨¸ì§€ëŠ” ìˆ¨ê¹€
      const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      allCards.forEach(idSuffix => {
        const card = getAgentCard(idSuffix);
        if (card) {
          if (idSuffix === 'gpt0') {
            card.style.display = 'block';
            card.style.visibility = 'visible';
            card.style.opacity = '1';
          } else {
            card.style.display = 'none';
            card.style.visibility = 'hidden';
            card.style.opacity = '0';
          }
        }
      });
      
      // GPT0 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        const gpt0Card = getAgentCard('gpt0');
        if (gpt0Card && panel) {
          panel.scrollTo({ top: gpt0Card.offsetTop - 12, behavior: 'smooth' });
        }
      }, 100);
      
      return true; // ëª¨ë°”ì¼ ëª¨ë“œ í™œì„±í™”ë¨
    }

    // âœ… ë¶„ì„ ì‹¤í–‰ ì‹œ ëª¨ë“  ì¹´ë“œ í‘œì‹œ (ëª¨ë°”ì¼)
    function showAllCardsOnPipelineStart() {
      if (!isMobileEnvironment()) return;
      
      console.log('ğŸ“± ëª¨ë°”ì¼ - ë¶„ì„ ì‹œì‘ìœ¼ë¡œ ëª¨ë“  ì¹´ë“œ í‘œì‹œ');
      
      const panel = $rightPanel();
      if (panel) {
        panel.classList.remove('mobile-initial-mode');
        panel.classList.add('show-all');
      }
      
      // ëª¨ë“  ì¹´ë“œ í‘œì‹œ
      const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      allCards.forEach(idSuffix => {
        const card = getAgentCard(idSuffix);
        if (card) {
          card.style.display = 'block';
          card.style.visibility = 'visible';
          card.style.opacity = '1';
        }
      });
    }

    // ====== ì™¼ìª½ ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ ======
    function renderScenarioList() {
      const el = document.getElementById('left-scenarios');
      if (!el) return;
      const scenList = Object.entries(scenarioData)
        .map(([n, d]) => `- ${n}. ${d?.overview?.Scenario_Name || 'ì‹œë‚˜ë¦¬ì˜¤ ' + n}`)
        .join('\n');
      el.textContent = `ì´ ${Object.keys(scenarioData).length}ê°œ:\n${scenList}\n\níŒ) ìš°ì¸¡ íŒ¨ë„ì˜ ì‹œë‚˜ë¦¬ì˜¤ë²ˆí˜¸ ì…ë ¥ í›„ ì„¼í„°ë§/ì¤Œì„ ì‚¬ìš©í•˜ì„¸ìš”.`;
    }

    // ì´ˆê¸° ë Œë” ë³´ì •: í°íŠ¸/ë ˆì´ì•„ì›ƒ ì¤€ë¹„ í›„ ê°•ì œ ë Œë” + í•„ìš” ì‹œ ëª‡ ì°¨ë¡€ ì¬ì‹œë„
    async function warmFirstRender() {
      try {
        // í°íŠ¸ ì¤€ë¹„ ëŒ€ê¸° (ì§€ì› ë¸Œë¼ìš°ì € í•œì •)
        if (document.fonts && document.fonts.ready) {
          await Promise.race([
            document.fonts.ready,
            new Promise(resolve => setTimeout(resolve, 300))
          ]);
        }
      } catch(_) {}

      // ë ˆì´ì•„ì›ƒì´ ì•ˆì •ëœ ë‹¤ìŒ í”„ë ˆì„ì— ë Œë”
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      try { renderNetwork(); } catch(_) {}

      // ì»¨í…Œì´ë„ˆ ì‚¬ì´ì¦ˆê°€ ì‘ì€ ê²½ìš°(ì´ˆê¸° 0 í­/ë†’ì´ ì´ìŠˆ) ëª‡ ì°¨ë¡€ ì¬ì‹œë„
      const container = document.getElementById('network-graph');
      if (!container) return;
      let tries = 0;
      const retry = () => {
        tries++;
        const rect = container.getBoundingClientRect();
        if (rect.width < 300 || rect.height < 300) {
          try { renderNetwork(); } catch(_) {}
          try { window.dispatchEvent(new Event('resize')); } catch(_) {}
          if (tries < 5) setTimeout(retry, 150);
        }
      };
      retry();
    }
    // =====================
    // PPT ì¶œë ¥: GPT í¬ë§·íŒ… â†’ PPTX ìƒì„±
    // =====================
    // ğŸ”Œ ì„¤ì •ê°’ (í•„ìš” ì‹œ ìˆ˜ì •)
    const OPENAI_API_URL = "https://api.openai.com/v1/responses"; // Responses API ì—”ë“œí¬ì¸íŠ¸
    const OPENAI_MODEL   = "gpt-4o-mini"; // ì‚¬ìš© ëª¨ë¸(ì˜ˆì‹œ). í•„ìš” ì‹œ ë³€ê²½
    // â€» ì‹¤ì œ í‚¤ëŠ” ì„œë²„ì—ì„œ ë³´ê´€í•˜ê³ , ì—¬ê¸´ í† í° ì—†ì´ í”„ë¡ì‹œë¡œ í˜¸ì¶œí•˜ëŠ” ê±¸ ê¶Œì¥í•©ë‹ˆë‹¤.
    let OPENAI_API_KEY   = ""; // ë°ëª¨/ë‚´ë¶€ í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ ì…ë ¥ë€. ìš´ì˜ì—ì„  ë¹„ìš°ì„¸ìš”.
    
    // ë¡œì»¬ í…ŒìŠ¤íŠ¸: localStorageì—ì„œ í‚¤ ì½ì–´ì˜¤ê¸° (í•˜ë“œì½”ë”©ëœ í‚¤ëŠ” ë³´ì•ˆìƒ ì œê±°ë¨)
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:') {
      // localStorageì—ì„œ ì½ì–´ì˜¤ê¸°
      const localKey = localStorage.getItem('openai_api_key');
      if (localKey) {
        OPENAI_API_KEY = localKey;
      }
    }

    // ğŸ§± í”„ë¡¬í”„íŠ¸ ë¹Œë”
    function buildSectionPrompt({ templateKey, sectionName, sourceText }) {
      const systemPrompt = `[ì—­í• ] ë‹¹ì‹ ì€ ê¸ˆìœµ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ë¬¸ê°€ì´ì ë³´ê³ ì„œ ì‘ì„± ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì²´ê³„ì ì´ê³  ì „ë¬¸ì ì¸ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ PPT ì½˜í…ì¸ ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
[ì¶œë ¥í˜•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œì‹œ HTMLë§Œ ì¶œë ¥í•©ë‹ˆë‹¤. í—ˆìš© íƒœê·¸: <h1>, <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ì¸ì‚¿ë§/ë¶ˆí•„ìš” ë¬¸êµ¬/AI ì¸ìš© ì½”ë“œ(contentReference, oaicite, index ë“±) ì ˆëŒ€ ê¸ˆì§€
- ë¶ˆë¦¿ì€ <ul><li>â€¦</li></ul>, ë²ˆí˜¸ëª©ë¡ì€ <ol><li>â€¦</li></ol>ë¡œ ì‘ì„±
- í‘œ, ì´ë¯¸ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì§€
- ì²´ê³„ì ì´ê³  ë…¼ë¦¬ì ì¸ êµ¬ì¡°ë¡œ ì‘ì„±í•˜ë˜, ê° ì„¹ì…˜ì€ ìƒì„¸í•˜ê³  êµ¬ì²´ì ì¸ ë‚´ìš© í¬í•¨
- ì „ë¬¸ì ì¸ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ì •ëŸ‰ì  ë¶„ì„ê³¼ ì •ì„±ì  ì¸ì‚¬ì´íŠ¸ë¥¼ ëª¨ë‘ í¬í•¨`;

      const userPrompt = `[ë¬¸ì„œ í…œí”Œë¦¿] ${templateKey}
[ì„¹ì…˜] ${sectionName}
[ì›ë¬¸] ì•„ë˜ ì›ë¬¸ì„ ì½ê³ , í•´ë‹¹ ì„¹ì…˜ì— ë§ì¶° ì²´ê³„ì ì´ê³  ì „ë¬¸ì ì¸ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ HTMLì„ ì‘ì„±í•˜ì„¸ìš”.

${sourceText}

[ì‘ì„± ì§€ì¹¨]
- ${sectionName}ì— ë§ëŠ” ëª…í™•í•œ ì†Œì œëª©(<h3>)ì„ 2~3ê°œ í¬í•¨í•˜ì—¬ ì²´ê³„ì ìœ¼ë¡œ êµ¬ì„±
- ê° ì†Œì œëª© í•˜ì— ìƒì„¸í•œ ë¶„ì„ ë‚´ìš©ì„ í¬í•¨
- ì¤‘ìš”í•œ ìš©ì–´ ë° í•µì‹¬ ìˆ˜ì¹˜ëŠ” <strong>ìœ¼ë¡œ ê°•ì¡°
- ì£¼ìš” í¬ì¸íŠ¸ëŠ” <ul><li>â€¦</li></ul> ë˜ëŠ” <ol><li>â€¦</li></ol> ì‚¬ìš©
- ìƒì„¸í•œ ì„¤ëª…ì€ <p>â€¦</p>ë¡œ ì‘ì„±í•˜ë˜, êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë‚´ìš© í¬í•¨
- ì •ëŸ‰ì  ë°ì´í„°ì™€ ì •ì„±ì  ë¶„ì„ì„ ê· í˜•ìˆê²Œ ì œì‹œ
- ë¬¸ì²´ëŠ” ì „ë¬¸ì ì´ê³  ì •ì¤‘í•œ "~ìŠµë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ í†µì¼
- í—ˆìš© íƒœê·¸ ì™¸ ì‚¬ìš© ê¸ˆì§€, ë¶ˆí•„ìš” ë¬¸êµ¬ ê¸ˆì§€`;

      return { systemPrompt, userPrompt };
    }

    // í‘œì§€ì— ë“¤ì–´ê°ˆ "ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ìš”ì•½)" ìƒì ì‘ì„±ìš© í”„ë¡¬í”„íŠ¸
    function buildCoverScenarioPrompt({ scenarioName, sourceText }) {
      const systemPrompt = `[ì—­í• ] ë‹¹ì‹ ì€ ê¸ˆìœµ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ë¬¸ê°€ë¡œì„œ 'ë³´ê³ ì„œ' í‘œì§€ í•˜ë‹¨ì— ë“¤ì–´ê°ˆ \"ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ìš”ì•½)\" ìƒì ë‚´ìš©ì„ ì²´ê³„ì ì¸ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
[ì¶œë ¥í˜•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œì‹œ HTMLë§Œ ì¶œë ¥í•©ë‹ˆë‹¤. í—ˆìš© íƒœê·¸: <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ì¸ì‚¿ë§/ë¶ˆí•„ìš” ë¬¸êµ¬/AI ì¸ìš© ì½”ë“œ(contentReference, oaicite, index ë“±) ì ˆëŒ€ ê¸ˆì§€
- ì „ë¬¸ì ì´ê³  ì²´ê³„ì ì¸ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±
- í¬í•¨: ì‹œë‚˜ë¦¬ì˜¤ ê°œìš”, í•µì‹¬ ë¶„ì„ í¬ì¸íŠ¸, ë¦¬ìŠ¤í¬ ìš”ì¸ ë° ëª¨ë‹ˆí„°ë§ ì§€í‘œ
- ë¬¸ì²´ëŠ” ì „ë¬¸ì ì´ê³  ì •ì¤‘í•œ "~ìŠµë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ í†µì¼
- í‘œ, ì´ë¯¸ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì§€`;

      const userPrompt = `[ì‹œë‚˜ë¦¬ì˜¤ëª…] ${scenarioName || ''}
[ì›ë¬¸] ì•„ë˜ í…ìŠ¤íŠ¸ëŠ” ì‹œë‚˜ë¦¬ì˜¤ PDFì—ì„œ ì¶”ì¶œëœ ë‚´ìš©ì…ë‹ˆë‹¤. í‘œì§€ í•˜ë‹¨ ìƒìì— ë“¤ì–´ê°ˆ ì²´ê³„ì ì´ê³  ì „ë¬¸ì ì¸ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.

${sourceText}

[ì‘ì„± ì§€ì¹¨]
- ë§¨ ìœ„ì— <h3>ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ìš”ì•½)</h3> ì œëª© í¬í•¨
- ì‹œë‚˜ë¦¬ì˜¤ ê°œìš”ë¥¼ <p>â€¦</p>ë¡œ ëª…í™•íˆ ì„¤ëª…
- í•µì‹¬ ë¶„ì„ í¬ì¸íŠ¸ëŠ” <ul><li>â€¦</li></ul>ë¡œ êµ¬ì²´ì ìœ¼ë¡œ 4~6ê°œ ì‘ì„±
- ë¦¬ìŠ¤í¬ ìš”ì¸ ë° ëª¨ë‹ˆí„°ë§ ì§€í‘œë„ <ul><li>â€¦</li></ul>ë¡œ 3~5ê°œ ì¶”ê°€
- ë¬¸ì²´ëŠ” ì „ë¬¸ì ì´ê³  ì •ì¤‘í•œ "~ìŠµë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ í†µì¼
- í—ˆìš© íƒœê·¸ ì™¸ ì‚¬ìš© ê¸ˆì§€, ë¶ˆí•„ìš” ë¬¸êµ¬ ê¸ˆì§€`;

      return { systemPrompt, userPrompt };
    }

    // GPT0 ë§ˆì¼“ë°ì´í„°/ì‹œí™© + ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„° ì—°ê³„ ë¶„ì„ ìŠ¬ë¼ì´ë“œìš© í”„ë¡¬í”„íŠ¸
    function buildGpt0MarketSlidePrompt({ scenarioName, scenMarketText, marketStateText }) {
      const systemPrompt = `[ì—­í• ] ë³´ê³ ì„œì˜ 'í˜„ì¬ ë§ˆì¼“/ì‹œí™© Â· ì‹œë‚˜ë¦¬ì˜¤ ì—°ê³„' ìŠ¬ë¼ì´ë“œ ì½˜í…ì¸ ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
[ì¶œë ¥í˜•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œì‹œ HTMLë§Œ ì¶œë ¥í•©ë‹ˆë‹¤. í—ˆìš© íƒœê·¸: <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ì¸ì‚¿ë§/ë¶ˆí•„ìš” ë¬¸êµ¬/AI ì¸ìš© ì½”ë“œ(contentReference, oaicite, index ë“±) ì ˆëŒ€ ê¸ˆì§€
- ê¸¸ì´ëŠ” 6~12ê°œì˜ ë¬¸ì¥/ë¶ˆë¦¿ ì•ˆì—ì„œ ê°„ê²°í•˜ê²Œ
- í¬í•¨: (1) í˜„ì¬ ë§ˆì¼“/ì‹œí™© í•µì‹¬ 3~5ê°œ, (2) ì‹œë‚˜ë¦¬ì˜¤ ì—°ê²° ë§ˆì¼“ë°ì´í„° í•µì‹¬ 3~5ê°œ, (3) ì‹œì‚¬ì /ë¦¬ìŠ¤í¬ íŠ¸ë¦¬ê±° 2~4ê°œ
- í‘œ, ì´ë¯¸ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì§€`;

      const userPrompt = `[ì‹œë‚˜ë¦¬ì˜¤ëª…] ${scenarioName || ''}
[GPT0-í˜„ì¬ ì‹œí™© ë¶„ì„]
${marketStateText || ''}

[GPT0-ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„° ë¶„ì„]
${scenMarketText || ''}

[ì‘ì„± ì§€ì¹¨]
- ë§¨ ìœ„ì— <h3>í˜„ì¬ ë§ˆì¼“/ì‹œí™© ë° ì‹œë‚˜ë¦¬ì˜¤ ì—°ê³„ ë¶„ì„</h3> ì œëª© í¬í•¨
- ê° ë¸”ë¡ì€ ì†Œì œëª©(<h3>)ê³¼ ë¶ˆë¦¿(<ul><li>) í˜•íƒœë¡œ ê°„ê²° ìš”ì•½
- í—ˆìš© íƒœê·¸ ì™¸ ì‚¬ìš© ê¸ˆì§€, ë¶ˆí•„ìš” ë¬¸êµ¬ ê¸ˆì§€`;

      return { systemPrompt, userPrompt };
    }

    // GPT3 ë„ë©”ì¸(ì‹œì¥/ì‹ ìš©/ALM/ê¸€ë¡œë²Œ/ì‹ ìš©PF) ë¶„ì„ ìš”ì•½ ìŠ¬ë¼ì´ë“œìš© í”„ë¡¬í”„íŠ¸
    function buildGpt3DomainsSlidePrompt({ outMarket, outCredit, outAlm, outGlobal, outCreditPf }) {
      const systemPrompt = `[ì—­í• ] ë³´ê³ ì„œì˜ 'GPT3 ë„ë©”ì¸ ë¶„ì„ ìš”ì•½' ìŠ¬ë¼ì´ë“œ ì½˜í…ì¸ ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
[ì¶œë ¥í˜•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œì‹œ HTMLë§Œ ì¶œë ¥í•©ë‹ˆë‹¤. í—ˆìš© íƒœê·¸: <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ì¸ì‚¿ë§/ë¶ˆí•„ìš” ë¬¸êµ¬/AI ì¸ìš© ì½”ë“œ(contentReference, oaicite, index ë“±) ì ˆëŒ€ ê¸ˆì§€
- ê° ë„ë©”ì¸(ì‹œì¥/ì‹ ìš©/ALM/ê¸€ë¡œë²Œ/ì‹ ìš©PF)ë³„ë¡œ ì†Œì œëª©(<h3>)ì„ ë§Œë“¤ê³ , í•µì‹¬ í¬ì¸íŠ¸ 3~6ê°œë¥¼ <ul><li>â€¦</li></ul>ë¡œ ê°„ê²°íˆ ìš”ì•½
- í‘œ, ì´ë¯¸ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì§€`;

      const userPrompt = `ì•„ë˜ëŠ” GPT3 ê° ë„ë©”ì¸ ì—ì´ì „íŠ¸ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. ê° ë„ë©”ì¸ë³„ë¡œ ì†Œì£¼ì œì™€ í•µì‹¬ í¬ì¸íŠ¸ë¥¼ ìš”ì•½í•˜ì—¬ í•œ ì¥ì§œë¦¬ ìŠ¬ë¼ì´ë“œë¥¼ ë§Œë“œì„¸ìš”.

[ì‹œì¥ë¦¬ìŠ¤í¬]
${outMarket || ''}

[ì‹ ìš©ë¦¬ìŠ¤í¬]
${outCredit || ''}

[ALM]
${outAlm || ''}

[ê¸€ë¡œë²Œë¦¬ìŠ¤í¬]
${outGlobal || ''}

[ì‹ ìš©í¬íŠ¸í´ë¦¬ì˜¤]
${outCreditPf || ''}

[ì‘ì„± ì§€ì¹¨]
- ì½˜í…ì¸ ê°€ ì—†ëŠ” ë„ë©”ì¸ì€ ìƒëµ
- ê° ë„ë©”ì¸ì˜ í•µì‹¬ í¬ì¸íŠ¸ëŠ” 3~6ê°œ ìˆ˜ì¤€ìœ¼ë¡œ ê°„ê²°íˆ ì •ë¦¬`;

      return { systemPrompt, userPrompt };
    }

    // ğŸ”’ í—¤ë” í—¬í¼ (í˜¸í™˜ìš© ë”ë¯¸) â€” í”„ë¡ì‹œ ëª¨ë“œì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    async function getOpenAIAuthHeaders() {
      // í”„ë¡ì‹œ ì „ìš© ëª¨ë“œ: í´ë¼ì´ì–¸íŠ¸ í—¤ë”ëŠ” í•„ìš” ì—†ìŒ. (í˜¸í™˜ì„± ìœ ì§€ìš©ìœ¼ë¡œ ë¹ˆ í—¤ë” ë°˜í™˜)
      // ë¡œì»¬ ê°œë°œ í¸ì˜: localhost/file://ì—ì„œ localStorage í‚¤ê°€ ìˆìœ¼ë©´ í…ŒìŠ¤íŠ¸ í—ˆìš©
      try {
        const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:';
        if (isLocal) {
          const k = localStorage.getItem('openai_api_key');
          if (k) {
            console.warn('âš ï¸ ë¡œì»¬ ê°œë°œ ëª¨ë“œ: ì„ì‹œ Authorization í—¤ë” ì‚¬ìš©');
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${k}` };
          }
        }
      } catch(_) { /* ignore */ }
      console.log('ğŸ”’ í”„ë¡ì‹œ ì „ìš© ëª¨ë“œ: í´ë¼ì´ì–¸íŠ¸ Authorization í—¤ë” ë¯¸ì‚¬ìš©');
      return { 'Content-Type': 'application/json' };
    }

    // ğŸ”’ PPTìš© ì•ˆì „í•œ OpenAI í”„ë¡ì‹œ í˜¸ì¶œ (Netlify Functions ì „ìš©)
    async function callOpenAIForPPT({ systemPrompt, userPrompt }) {
      console.log('ğŸ”„ PPTìš© OpenAI í”„ë¡ì‹œ í˜¸ì¶œ ì‹œì‘...');

      const body = {
        model: OPENAI_MODEL || 'gpt-4o-mini',
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        max_tokens: 16000,
        temperature: 0.1
      };

      const res = await fetch('/.netlify/functions/openai-proxy', {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({ error: 'Unknown error' }));
        console.error('âŒ PPT OpenAI í”„ë¡ì‹œ ì˜¤ë¥˜:', res.status, errData);
        
        // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê³µ
        if (res.status === 404) {
          throw new Error('PPT OpenAI í”„ë¡ì‹œ í•¨ìˆ˜ê°€ ë°°í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Netlify ë°°í¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else if (errData.code === 'MISSING_API_KEY') {
          throw new Error('PPTìš© Netlify í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Site settingsì—ì„œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê³  ì¬ë°°í¬í•´ì£¼ì„¸ìš”.');
        } else {
          throw new Error(`PPT OpenAI í”„ë¡ì‹œ ì˜¤ë¥˜: ${res.status} ${errData.error || 'Unknown error'}`);
        }
      }

      const data = await res.json();
      console.log('âœ… PPT OpenAI í”„ë¡ì‹œ í˜¸ì¶œ ì„±ê³µ');
      
      const outputText =
        data.choices?.[0]?.message?.content ||
        data.output_text ||
        data.response?.[0]?.content?.[0]?.text ||
        JSON.stringify(data);

      return (outputText || "").trim();
    }

    // HTML â†’ í…ìŠ¤íŠ¸ ëŸ° ë³€í™˜ (PptxGenJSìš©)
    const PPT_FONT = 'NanumSquare';
    function htmlToTextRunsForPptx(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const runs = [];
      const body = doc.body;
      const walk = (node) => {
        if (!node) return;
        node.childNodes.forEach((child) => {
          if (child.nodeType === 1) {
            const tag = child.tagName.toLowerCase();
            if (tag === 'p') {
              const text = child.textContent.trim();
              if (text) runs.push({ text, options: { fontSize: 14, fontFace: PPT_FONT, lineSpacing: 24, paraSpaceAfter: 6 } });
            } else if (tag === 'ul' || tag === 'ol') {
              // ê¸€ë¨¸ë¦¬ê¸°í˜¸ë¥¼ ì œê±°í•˜ê³  ì¼ë°˜ ë¬¸ë‹¨ìœ¼ë¡œ ë³€í™˜
              child.querySelectorAll(':scope > li').forEach((li) => {
                const text = li.textContent.trim();
                if (text) runs.push({ text: `- ${text}`, options: { fontSize: 14, fontFace: PPT_FONT, lineSpacing: 24, paraSpaceAfter: 4 } });
              });
            } else {
              walk(child);
            }
          }
        });
      };
      walk(body);
      return runs.length ? runs : [{ text: body.textContent.trim(), options: { fontSize: 14, fontFace: PPT_FONT } }];
    }

    function extractFirstHeading(html, fallback) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const h = doc.querySelector('h3, h2, h1');
      return (h?.textContent || fallback || 'ì œëª© ì—†ìŒ').trim();
    }

    async function generatePPTFromFinalReport() {
      try {
        const pptBtn = document.getElementById('btn-export-ppt');
        pptBtn?.classList.add('ppt-progress');
        pptBtn?.classList.add('blink-text');
        pptBtn && (pptBtn.disabled = true);
        const textarea = document.getElementById('gpt4-output');
        const sourceText = (textarea?.value || '').trim();
        if (!sourceText) {
          if (typeof showToast === 'function') showToast('GPT4 ìµœì¢… ë³´ê³ ì„œ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.', 'error');
          else alert('GPT4 ìµœì¢… ë³´ê³ ì„œ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
          return;
        }

        const sendEl = document.getElementById('send-status');
        if (sendEl) sendEl.textContent = 'PPT ì‘ì„±ìš© ì„¹ì…˜ ìƒì„± ì¤‘...';

        // ì œëª© ë° ì„¹ì…˜ 3ê°œ ìƒì„± (ìš”ì•½ / í•µì‹¬ ë‚´ìš© / ê²°ë¡ ) + í‘œì§€ í•˜ë‹¨ ìƒììš© ì‹œë‚˜ë¦¬ì˜¤ PDF ìš”ì•½
        const templateKey = 'background-content-conclusion';
        const { systemPrompt: sys1, userPrompt: usr1 } = buildSectionPrompt({ templateKey, sectionName: 'ìš”ì•½', sourceText });
        const summaryHtml = await callOpenAIForPPT({ systemPrompt: sys1, userPrompt: usr1 });

        const { systemPrompt: sys2, userPrompt: usr2 } = buildSectionPrompt({ templateKey, sectionName: 'í•µì‹¬ ë‚´ìš©', sourceText });
        const contentHtml = await callOpenAIForPPT({ systemPrompt: sys2, userPrompt: usr2 });

        const { systemPrompt: sys3, userPrompt: usr3 } = buildSectionPrompt({ templateKey, sectionName: 'ê²°ë¡  ë° ê¶Œê³ ', sourceText });
        const conclusionHtml = await callOpenAIForPPT({ systemPrompt: sys3, userPrompt: usr3 });

        // gpt0 ì‹œë‚˜ë¦¬ì˜¤ PDF ìš”ì•½ í…ìŠ¤íŠ¸ë¥¼ í‘œì§€ í•˜ë‹¨ ìƒììš©ìœ¼ë¡œ ë³€í™˜
        const scenPdfText = (document.getElementById('gpt0-scenpdf')?.value || '').trim();
        let coverScenarioHtml = '';
        if (scenPdfText) {
          const scenarioName = (document.getElementById('selected-scenario-name')?.textContent || '').trim();
          const { systemPrompt: sysC, userPrompt: usrC } = buildCoverScenarioPrompt({ scenarioName, sourceText: scenPdfText });
          coverScenarioHtml = await callOpenAIForPPT({ systemPrompt: sysC, userPrompt: usrC });
        }

        if (sendEl) sendEl.textContent = 'PPT íŒŒì¼ ìƒì„± ì¤‘...';

        const Pptx = window.PptxGenJS || window.pptxgen || window.pptxgenjs || window.PptxGen; // UMD ë³€ìˆ˜ í˜¸í™˜
        if (typeof Pptx === 'undefined') {
          throw new Error('PptxGenJS ë¡œë”© ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” CDN ì°¨ë‹¨ì„ í™•ì¸í•˜ì„¸ìš”.');
        }

        const pptx = new Pptx();
        // ë ˆì´ì•„ì›ƒ: ì„¸ë¡œí˜• A4 (ì‚¬ìš©ì ë ˆì´ì•„ì›ƒ ë“±ë¡ í›„ ì´ë¦„ìœ¼ë¡œ ì§€ì •)
        const LAYOUT_W = 8.27;  // A4 portrait í­(in)
        const LAYOUT_H = 11.69; // A4 portrait ë†’ì´(in)
        const MARGIN_X = 0.8;
        const MARGIN_Y = 0.9;
        pptx.defineLayout({ name: 'A4_P', width: LAYOUT_W, height: LAYOUT_H });
        pptx.layout = 'A4_P';
        const title = extractFirstHeading(`<h1>${(document.getElementById('selected-scenario-name')?.textContent || '').trim()}</h1>`, 'AI ìë™ ìƒì„± ë³´ê³ ì„œ');

        // í‘œì§€ ìŠ¬ë¼ì´ë“œ (ìƒë‹¨ ë°°ë„ˆ + í•˜ë‹¨ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„ ìƒì)
        let slide = pptx.addSlide();
        slide.addShape(pptx.ShapeType.rect, {
          x: 0, y: 0, w: LAYOUT_W, h: MARGIN_Y + 1.2,
          fill: { color: '2C7BE5' }, line: { color: '2C7BE5' }
        });
        slide.addText(title || 'AI ìë™ ìƒì„± ë³´ê³ ì„œ', {
          x: MARGIN_X, y: MARGIN_Y + 0.1, w: LAYOUT_W - MARGIN_X * 2, h: 0.9,
          align: 'center', fontSize: 38, bold: true, color: 'FFFFFF', fontFace: PPT_FONT
        });
        slide.addText(new Date().toLocaleString(), {
          x: MARGIN_X, y: MARGIN_Y + 1.4, w: LAYOUT_W - MARGIN_X * 2, h: 0.4,
          align: 'center', fontSize: 13, color: '666666', fontFace: PPT_FONT
        });

        // í•˜ë‹¨ ìƒì: ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ìš”ì•½) - í‘œì§€ ë‚´ë¶€ì— ë°°ì¹˜
        if (coverScenarioHtml) {
          const boxX = MARGIN_X;
          const boxW = LAYOUT_W - MARGIN_X * 2;
          const boxY = MARGIN_Y + 2.0; // ì œëª©/ì¼ì ì•„ë˜ ê³µë°± ë‘ê³  ì‹œì‘
          const boxH = LAYOUT_H - boxY - MARGIN_Y; // í•˜ë‹¨ ì—¬ë°±ê¹Œì§€ ì±„ì›€
          // ë°°ê²½ ë°•ìŠ¤
          slide.addShape(pptx.ShapeType.roundRect, {
            x: boxX, y: boxY, w: boxW, h: boxH,
            fill: { color: 'F9FBFF' }, line: { color: 'D6E4FF' }, rectRadius: 0.15
          });
          // ì œëª©
          slide.addText('ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ìš”ì•½)', {
            x: boxX + 0.2, y: boxY + 0.2, w: boxW - 0.4, h: 0.5,
            fontSize: 18, bold: true, color: '2C7BE5', fontFace: PPT_FONT
          });
          // ë‚´ìš©
          const runsC = htmlToTextRunsForPptx(coverScenarioHtml);
          slide.addText(runsC.map(r => ({ text: r.text + '\n', options: r.options })), {
            x: boxX + 0.2, y: boxY + 0.8, w: boxW - 0.4, h: boxH - 1.0
          });
        }

        // ë‘ ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ: GPT0 í˜„ì¬ ë§ˆì¼“/ì‹œí™© + ì‹œë‚˜ë¦¬ì˜¤ ë§ˆì¼“ë°ì´í„° ì—°ê³„ ë¶„ì„
        try {
          const scenName = (document.getElementById('selected-scenario-name')?.textContent || '').trim();
          const scenMarketText = (document.getElementById('gpt0-marketdata')?.value || '').trim();
          const marketStateText = (document.getElementById('gpt0-marketstate')?.value || '').trim();
          if (scenMarketText || marketStateText) {
            const { systemPrompt: sysM, userPrompt: usrM } = buildGpt0MarketSlidePrompt({ scenarioName: scenName, scenMarketText, marketStateText });
            const marketSlideHtml = await callOpenAIForPPT({ systemPrompt: sysM, userPrompt: usrM });
            const s2 = pptx.addSlide();
            // ì„¹ì…˜ ë°°ë„ˆ
            s2.addShape(pptx.ShapeType.rect, {
              x: MARGIN_X, y: MARGIN_Y, w: LAYOUT_W - MARGIN_X * 2, h: 0.55,
              fill: { color: 'F0F5FF' }, line: { color: 'F0F5FF' }
            });
            s2.addText('í˜„ì¬ ë§ˆì¼“/ì‹œí™© ë° ì‹œë‚˜ë¦¬ì˜¤ ì—°ê³„ ë¶„ì„', { x: MARGIN_X + 0.1, y: MARGIN_Y + 0.05, w: LAYOUT_W - (MARGIN_X + 0.1) * 2, h: 0.45, fontSize: 24, bold: true, fontFace: PPT_FONT, color: '2C7BE5' });
            const runs2 = htmlToTextRunsForPptx(marketSlideHtml);
            const cY2 = MARGIN_Y + 0.8; const cH2 = LAYOUT_H - cY2 - MARGIN_Y;
            s2.addText(runs2.map(r => ({ text: r.text + '\n', options: r.options })), { x: MARGIN_X, y: cY2, w: LAYOUT_W - MARGIN_X * 2, h: cH2 });
            s2.addText('2', { x: LAYOUT_W / 2 - 0.15, y: LAYOUT_H - MARGIN_Y + 0.1, w: 0.3, h: 0.3, fontSize: 10, color: '888888', align: 'center' });
          }
        } catch(_) { /* ignore */ }

        // ì„¸ ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ: GPT3 ê° ë„ë©”ì¸ ë¶„ì„ ìš”ì•½(ì†Œì£¼ì œë³„ ë³¸ë¬¸)
        try {
          const outMarket = (document.getElementById('gpt3-market')?.value || '').trim();
          const outCredit = (document.getElementById('gpt3-credit')?.value || '').trim();
          const outAlm    = (document.getElementById('gpt3-alm')?.value || '').trim();
          const outGlobal = (document.getElementById('gpt3-global')?.value || '').trim();
          const outCreditPf = (document.getElementById('gpt3-creditpf')?.value || '').trim();
          if (outMarket || outCredit || outAlm || outGlobal || outCreditPf) {
            const { systemPrompt: sysD, userPrompt: usrD } = buildGpt3DomainsSlidePrompt({ outMarket, outCredit, outAlm, outGlobal, outCreditPf });
            const domSlideHtml = await callOpenAIForPPT({ systemPrompt: sysD, userPrompt: usrD });
            const s3 = pptx.addSlide();
            s3.addShape(pptx.ShapeType.rect, {
              x: MARGIN_X, y: MARGIN_Y, w: LAYOUT_W - MARGIN_X * 2, h: 0.55,
              fill: { color: 'F0F5FF' }, line: { color: 'F0F5FF' }
            });
            s3.addText('GPT3 ë„ë©”ì¸ ë¶„ì„ ìš”ì•½', { x: MARGIN_X + 0.1, y: MARGIN_Y + 0.05, w: LAYOUT_W - (MARGIN_X + 0.1) * 2, h: 0.45, fontSize: 24, bold: true, fontFace: PPT_FONT, color: '2C7BE5' });
            const runs3 = htmlToTextRunsForPptx(domSlideHtml);
            const cY3 = MARGIN_Y + 0.8; const cH3 = LAYOUT_H - cY3 - MARGIN_Y;
            s3.addText(runs3.map(r => ({ text: r.text + '\n', options: r.options })), { x: MARGIN_X, y: cY3, w: LAYOUT_W - MARGIN_X * 2, h: cH3 });
            s3.addText('3', { x: LAYOUT_W / 2 - 0.15, y: LAYOUT_H - MARGIN_Y + 0.1, w: 0.3, h: 0.3, fontSize: 10, color: '888888', align: 'center' });
          }
        } catch(_) { /* ignore */ }

        // ì„¹ì…˜ ìŠ¬ë¼ì´ë“œë“¤ (ìš”ì•½/í•µì‹¬/ê²°ë¡ )
        const sections = [
          { name: 'ìš”ì•½', html: summaryHtml },
          { name: 'í•µì‹¬ ë‚´ìš©', html: contentHtml },
          { name: 'ê²°ë¡  ë° ê¶Œê³ ', html: conclusionHtml },
        ];

        sections.forEach(({ name, html }, idx) => {
          const s = pptx.addSlide();
          const heading = extractFirstHeading(html, name);
          // ì„¹ì…˜ ë°°ë„ˆ ë°”
          s.addShape(pptx.ShapeType.rect, {
            x: MARGIN_X, y: MARGIN_Y, w: LAYOUT_W - MARGIN_X * 2, h: 0.55,
            fill: { color: 'F0F5FF' }, line: { color: 'F0F5FF' }
          });
          s.addText(heading, { x: MARGIN_X + 0.1, y: MARGIN_Y + 0.05, w: LAYOUT_W - (MARGIN_X + 0.1) * 2, h: 0.45, fontSize: 24, bold: true, fontFace: PPT_FONT, color: '2C7BE5' });
          const runs = htmlToTextRunsForPptx(html);
          const contentY = MARGIN_Y + 0.8;
          const contentH = LAYOUT_H - contentY - MARGIN_Y;
          s.addText(runs.map(r => ({ text: r.text + '\n', options: r.options })), { x: MARGIN_X, y: contentY, w: LAYOUT_W - MARGIN_X * 2, h: contentH });
          // í˜ì´ì§€ ë²ˆí˜¸(ì†Œë°•í•˜ê²Œ í•˜ë‹¨ ì¤‘ì•™)
          s.addText(String(idx + 1), { x: LAYOUT_W / 2 - 0.15, y: LAYOUT_H - MARGIN_Y + 0.1, w: 0.3, h: 0.3, fontSize: 10, color: '888888', align: 'center' });
        });

        await pptx.writeFile({ fileName: `ìµœì¢…ë³´ê³ ì„œ_${Date.now()}.pptx` });
        if (sendEl) sendEl.textContent = '';
        if (typeof showToast === 'function') showToast('PPT íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      } catch (err) {
        console.error(err);
        const sendEl = document.getElementById('send-status');
        if (sendEl) sendEl.textContent = '';
        if (typeof showToast === 'function') showToast(`PPT ìƒì„± ì‹¤íŒ¨: ${err.message}`, 'error');
        else alert(`PPT ìƒì„± ì‹¤íŒ¨: ${err.message}`);
      } finally {
        const pptBtn = document.getElementById('btn-export-ppt');
        pptBtn?.classList.remove('ppt-progress');
        pptBtn?.classList.remove('blink-text');
        pptBtn && (pptBtn.disabled = false);
      }
    }

    // ====== HTML ë³´ê³ ì„œ ìƒì„± ê¸°ëŠ¥ ======
    let generatedHTMLCode = '';

    ;(function restoreOnReady(){
  const run = () => {
    const savedHTML = localStorage.getItem('generatedHTMLCode');
    const savedState = JSON.parse(localStorage.getItem('reportState') || '{}');
    if (savedHTML && savedState?.isGenerated) {
      window.generatedHTMLCode = savedHTML;
      window.reportState = { ...(window.reportState||{}), isGenerated: true, htmlContent: savedHTML };
      const htmlBtn = document.getElementById('btn-export-html');
      if (htmlBtn) {
        htmlBtn.textContent = 'ë³´ê³ ì„œë³´ê¸°';
        htmlBtn.disabled = false;
      }
    }
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }
})();


        // íŒŒì´í”„ë¼ì¸ ì‹œê°ì  íš¨ê³¼ í† ê¸€ í•¨ìˆ˜
    function setPipelineVisuals(active) {
      console.log(`[viz] ${active ? 'on' : 'off'}`);
      // ì‹œë‚˜ë¦¬ì˜¤ ë…¸ë“œë“¤ì— ì‹¤í–‰ ì¤‘ íš¨ê³¼
      d3.selectAll('.scenario-group').classed('agent-running', active);
      d3.selectAll('.scenario-node').classed('agent-running', active);
      // ì—°ê²°ì„ ë“¤ì— ê¹œë°•ì„ íš¨ê³¼
      d3.selectAll('.connection-line').classed('blink-y-all', active);
      // íŒŒì´í”„ë¼ì¸ ì„ ë“¤ì— íë¦„ ì• ë‹ˆë©”ì´ì…˜
      d3.selectAll('.pipeline-line').classed('flow', active);
    }

        // íŒŒì´í”„ë¼ì¸ + ë³´ê³ ì„œ í†µí•© í•¸ë“¤ëŸ¬ (ìƒë‹¨ ë²„íŠ¼ìš©)
    async function handlePipelineAndReport() {
      const topBtn = document.getElementById('top-pipeline-btn');
      const status = document.getElementById('send-status');
      const reportBtnsContainer = document.getElementById('report-buttons-container');
      
      try {
        console.log('ğŸš€ íŒŒì´í”„ë¼ì¸ + ë³´ê³ ì„œ í†µí•© ì‹¤í–‰ ì‹œì‘');
        
        // ğŸ“± Wake Lock í™œì„±í™” (í™”ë©´ êº¼ì§ ë°©ì§€)
        const wakeLockEnabled = await requestWakeLock();
        
        // ğŸ“± ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ëª¨ë“  ì¹´ë“œ í‘œì‹œ
        if (typeof showAllCardsOnPipelineStart === 'function') {
          showAllCardsOnPipelineStart();
        }
        
        // íŒŒì´í”„ë¼ì¸ ì‹œê°ì  íš¨ê³¼ ì‹œì‘
        setPipelineVisuals(true);
        
        // íŒŒì´í”„ë¼ì¸ ì‹œì‘ ì‹œ ë³´ê³ ì„œë³´ê¸° & ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ ìˆ¨ê¹€
        if (reportBtnsContainer) {
          reportBtnsContainer.style.display = 'none';
        }
        
        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ - íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘
        if (topBtn) {
          topBtn.style.display = 'inline-block'; // âœ… ì‹œì‘ ì‹œ ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ í‘œì‹œ
          topBtn.disabled = true;
          topBtn.textContent = 'âš¡ ë¶„ì„ì¤‘...';
          topBtn.classList.add('blink-text');
          topBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
        }
        
        if (status) {
          const wakeLockMsg = wakeLockEnabled ? ' ğŸ”’' : '';
          status.textContent = `ğŸš€ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘...${wakeLockMsg}`;
          status.style.color = '#3498db';
          status.classList.add('status-shine');
        }
        
        // 1ë‹¨ê³„: íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
        await window.executePipelineSteps((step, description) => {
          if (status) {
            status.textContent = `ğŸ“Š ${step}/5ë‹¨ê³„: ${description}`;
          }
          if (topBtn) {
            topBtn.textContent = `âš¡ ${step}/5ë‹¨ê³„`;
          }
        });
        
        // 2ë‹¨ê³„: íŒŒì´í”„ë¼ì¸ ì™„ë£Œ í›„ ìë™ ë³´ê³ ì„œ ìƒì„±
        if (status) {
          status.textContent = 'ğŸ“„ ë³´ê³ ì„œ ìƒì„± ì¤‘...';
          status.style.color = '#2ecc71';
        }
        if (topBtn) {
          topBtn.textContent = 'ğŸ“„ ë³´ê³ ì„œ ìƒì„±ì¤‘...';
          topBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
        }
        
        // ë³´ê³ ì„œ ìë™ ìƒì„± (ì¤‘ë³µ ê°€ë“œ ì ìš©ë¨)
        await generateHTMLReportDirect();
        
        // ì™„ë£Œ ìƒíƒœ - ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ ìˆ¨ê¸°ê¸°, ë³´ê³ ì„œë³´ê¸° & ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ í‘œì‹œ
        if (topBtn) {
          topBtn.disabled = false;
          topBtn.classList.remove('blink-text');
          topBtn.style.display = 'none'; // âœ… ì™„ë£Œ ì‹œ ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ ìˆ¨ê¹€
        }
        
        // ì™„ë£Œ ì‹œ ë³´ê³ ì„œë³´ê¸° & ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
        if (reportBtnsContainer) {
          reportBtnsContainer.style.display = 'flex';
        }
        
        if (status) {
          status.textContent = 'ğŸ‰ ë¶„ì„ ë° ë³´ê³ ì„œ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
          status.style.color = '#27ae60';
          status.classList.remove('status-shine');
        }
        
        // íŒŒì´í”„ë¼ì¸ ì‹œê°ì  íš¨ê³¼ ì¢…ë£Œ
        setPipelineVisuals(false);
        
        // ğŸ“± Wake Lock í•´ì œ (í™”ë©´ êº¼ì§ ë°©ì§€ í•´ì œ)
        await releaseWakeLock();
        
        console.log('âœ… íŒŒì´í”„ë¼ì¸ + ë³´ê³ ì„œ í†µí•© ì‹¤í–‰ ì™„ë£Œ');
        
      } catch (error) {
        console.error('âŒ íŒŒì´í”„ë¼ì¸ + ë³´ê³ ì„œ í†µí•© ì‹¤í–‰ ì‹¤íŒ¨:', error);
        
        // íŒŒì´í”„ë¼ì¸ ì‹œê°ì  íš¨ê³¼ ì¢…ë£Œ
        setPipelineVisuals(false);
        
        // ğŸ“± Wake Lock í•´ì œ (ì˜¤ë¥˜ ì‹œ)
        await releaseWakeLock();
        
        // ì˜¤ë¥˜ ìƒíƒœ ë³µì›
        if (topBtn) {
          topBtn.style.display = 'inline-block'; // âœ… ì˜¤ë¥˜ ì‹œ ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ í‘œì‹œ
          topBtn.disabled = false;
          topBtn.textContent = 'ë¶„ì„ì‹¤í–‰';
          topBtn.classList.remove('blink-text');
          topBtn.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
        }
        
        // ì˜¤ë¥˜ ì‹œ ë³´ê³ ì„œë³´ê¸° & ë‹¤ì‹œì‹¤í–‰ ë²„íŠ¼ ìˆ¨ê¹€
        if (reportBtnsContainer) {
          reportBtnsContainer.style.display = 'none';
        }
        
        if (status) {
          status.textContent = `âŒ ì‹¤í–‰ ì‹¤íŒ¨: ${error.message}`;
          status.style.color = '#e74c3c';
          status.classList.remove('status-shine');
        }
        
        alert(`ì‹¤í–‰ ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ë³´ê³ ì„œ ì•¡ì…˜ í•¸ë“¤ëŸ¬ (ì‘ì„±/ë³´ê¸° í† ê¸€)
    async function handleReportAction(forceRegenerate = false) {
      try {
        console.log('ğŸ“„ ë³´ê³ ì„œ ì•¡ì…˜ í•¸ë“¤ëŸ¬ í˜¸ì¶œë¨');
        
        // í•˜ë‹¨ ë²„íŠ¼ ê¹œë°•ì„/ê°•ì¡°
        const btn = document.getElementById('btn-export-html');
        const reportActions = document.getElementById('report-actions');
        btn && btn.classList.add('report-cta');
        reportActions && reportActions.classList.add('report-actions-cta');
        setTimeout(()=>{ btn && btn.classList.remove('report-cta'); }, 1800);
        setTimeout(()=>{ reportActions && reportActions.classList.remove('report-actions-cta'); }, 2200);



      if (window.reportState.isGenerated && !forceRegenerate) {
        previewHTML();

      } else {
        await generateHTMLReportDirect({ force: forceRegenerate });
        // ë³´ê³ ì„œ ìƒì„± í›„ ë°”ë¡œ ìƒˆì°½ì—ì„œ ë³´ê¸°
        if (window.reportState.isGenerated && window.reportState.htmlContent) {
          previewHTMLDirect(window.reportState.htmlContent);
        }
        }
      } catch(error) {
        console.error('âŒ ë³´ê³ ì„œ ì•¡ì…˜ í•¸ë“¤ëŸ¬ ì˜¤ë¥˜:', error);
        

        
        if (window.reportState.isGenerated && !forceRegenerate) {
          previewHTML();
        } else {
          await generateHTMLReportDirect({ force: forceRegenerate });
        }
      }
    }



    // ì „ì—­ ë³´ê³ ì„œ ìƒíƒœ ì´ˆê¸°í™” (ì¤‘ë³µ ìƒì„± ë°©ì§€ìš©)
    window.reportState = window.reportState || { isGenerated: false, generating: false, htmlContent: '' };

    // íŒì—… ì—†ì´ ë°”ë¡œ HTML ë³´ê³ ì„œ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
    async function generateHTMLReportDirect({ force = false } = {}) {
      // ì¤‘ë³µ ìƒì„± ê°€ë“œ
      if (window.reportState.generating && !force) {
        console.warn('[report] ì´ë¯¸ ìƒì„± ì¤‘ - ì¤‘ë³µ ì‹¤í–‰ ì°¨ë‹¨');
        return;
      }
      if (window.reportState.isGenerated && !force) {
        console.log('[report] ì´ë¯¸ ìƒì„±ë¨ - ì¤‘ë³µ ì‹¤í–‰ ì°¨ë‹¨');
        return;
      }

      window.reportState.generating = true;
      
      try {
        // í•˜ë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = true;
          htmlBtn.textContent = 'ë³´ê³ ì„œ ìƒì„±ì¤‘...';
          htmlBtn.classList.add('report-progress');
          htmlBtn.classList.add('blink-text');
        }
        


        // GPT4 ìµœì¢… ë³´ê³ ì„œ ë‚´ìš©ì„ ìš°ì„ ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        let finalReport = document.getElementById('gpt4-output')?.value?.trim() || '';
        
        // GPT4 ì¶œë ¥ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ ë‹¤ë¥¸ ì†ŒìŠ¤ë¥¼ ê³ ë ¤
        if (!finalReport) {
          console.warn('âš ï¸ GPT4 ì¶œë ¥ì´ ë¹„ì–´ìˆìŒ - ë‹¤ë¥¸ ì†ŒìŠ¤ í™•ì¸');
          
          // âœ… ë°±ì—… ì†ŒìŠ¤ì— GPT3 ê²°ê³¼ë¥¼ ìš°ì„  í¬í•¨ (ì •ìƒë™ì‘í•˜ëŠ” ë²„ì „ì˜ ë°±ì—… ì†ŒìŠ¤ íŒ¨í„´)
          const backupSources = [
            document.getElementById('gpt3-market')?.value,
            document.getElementById('gpt3-credit')?.value,
            document.getElementById('gpt3-alm')?.value,
            document.getElementById('gpt3-global')?.value,
            document.getElementById('gpt3-creditpf')?.value,
            document.getElementById('gpt1-output')?.value,
            document.getElementById('gpt0-marketdata')?.value
          ].filter(v => v && v.trim());

          if (backupSources.length > 0) {
            finalReport = backupSources.join('\n\n---\n\n');
            console.log('ğŸ“ ë°±ì—… ì†ŒìŠ¤ë¡œ ë³´ê³ ì„œ ìƒì„±');
          } else {
            throw new Error('GPT4 ìµœì¢… ë³´ê³ ì„œ ë° ëª¨ë“  ë°±ì—… ì†ŒìŠ¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
          }
        } else {
          console.log('âœ… GPT4 ì¶œë ¥ì„ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ HTML ë³´ê³ ì„œ ìƒì„±');
        }

        // í˜„ì¬ ë‚ ì§œ ìƒì„±
        const today = new Date();
        const dateString = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');

        // HTML ìƒì„± í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ê°„ì†Œí™”)
        const title = 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ';
        const htmlPrompt = 
          'ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ì™„ì „í•œ HTML5 ë¬¸ì„œë¡œ ë³€í™˜í•˜ì„¸ìš”.\n' +
          'ì œëª©: ' + title + '\n' +
          'ì‘ì„±ì¼: ' + dateString + '\n' +
          'ì‘ì„±ì: ë¦¬ìŠ¤í¬ê´€ë¦¬íŒ€\n\n' +
          'ì›ë¬¸:\n' + finalReport + '\n\n' +
          'ìš”êµ¬ì‚¬í•­:\n' +
          '1) ì™„ì „í•œ HTML5 ë¬¸ì„œ í˜•íƒœë¡œ ì¶œë ¥\n' +
          '2) headì— CSS ìŠ¤íƒ€ì¼ í¬í•¨\n' +
          '3) ì œëª©, ëª©ì°¨, ë³¸ë¬¸ ì„¹ì…˜ìœ¼ë¡œ êµ¬ì„±\n' +
          '4) í•œêµ­ì–´ ì›¹ í‘œì¤€ ì¤€ìˆ˜\n' +
          '5) ì¸ì‡„ ê°€ëŠ¥í•œ í˜•íƒœ\n' +
          '6) ë¬¸ì²´ëŠ” ì „ë¬¸ì ì´ê³  ì •ì¤‘í•œ "~ìŠµë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ í†µì¼\n\n' +
          'ì˜¤ì§ HTML ì½”ë“œë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.';

        // OpenAI API í˜¸ì¶œ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€ - gpt-4o-mini ì‚¬ìš©)
        // ğŸ”’ ë³´ì•ˆ: getOpenAIAuthHeaders ì œê±°ë¨ - callOpenAI í•¨ìˆ˜ ì‚¬ìš©

        // ğŸ”§ ì²˜ìŒë¶€í„° ë¶„í•  ë³€í™˜ìœ¼ë¡œ ì²˜ë¦¬ (ëŒ€ìš©ëŸ‰ ì•ˆì •í™”)
        console.log('ğŸ§© ëŒ€ìš©ëŸ‰ ë³´ê³ ì„œ: ë¶„í•  ìƒì„± ì‹œì‘');
        let htmlCode = '';
        try {
          htmlCode = await generateHtmlFromFinalReportChunked(finalReport, title, dateString);
        } catch (eChunk) {
          console.warn('âš ï¸ ë¶„í•  ìƒì„± ì‹¤íŒ¨, ìµœì¢… ë¡œì»¬ Fallback ì‚¬ìš©:', eChunk.message);
          htmlCode = buildBasicHTMLDocument(title, dateString, finalReport);
        }
        
        // ê¸°ì¡´ fetch ì½”ë“œ ì œê±°ë¨
        /*const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: 'ë„ˆëŠ” HTML ë§ˆí¬ì—… ì „ë¬¸ê°€ì´ë‹¤. ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ë¥¼ ì™„ì „í•œ HTML5 ë¬¸ì„œë¡œ ë³€í™˜í•œë‹¤. ì˜¤ì§ HTML ì½”ë“œë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ ì¼ì ˆ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.'
              },
              {
                role: 'user',
                content: htmlPrompt
              }
            ],
            max_tokens: 16000,
            temperature: 0.1
          })
        });*/

        // ê¸°ì¡´ ì‘ë‹µ ì²˜ë¦¬ ì½”ë“œ ì œê±°ë¨ - callOpenAIê°€ ì²˜ë¦¬
        /*if (!response.ok) {
          throw new Error(`OpenAI API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const htmlCode = data.choices[0]?.message?.content?.trim();*/

        if (!htmlCode) {
          throw new Error('HTML ìƒì„± ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        }

        // ìƒì„±ëœ HTML ì €ì¥ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        generatedHTMLCode = htmlCode;
        window.reportState.isGenerated = true;
        window.reportState.htmlContent = htmlCode;

                // ğŸ”¸ ì¶”ê°€: ìƒíƒœ ì˜ì†í™”
        try {
          localStorage.setItem('generatedHTMLCode', htmlCode);
          localStorage.setItem('reportState', JSON.stringify({ isGenerated: true }));
        } catch (e) {
          console.warn('ë³´ê³ ì„œ ì €ì¥ ìƒëµ(ìš©ëŸ‰ ì´ˆê³¼):', e);
        }
        
        // í•˜ë‹¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (htmlBtn) {
          htmlBtn.textContent = 'ë³´ê³ ì„œë³´ê¸°';
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          // ë°•ìŠ¤ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
          htmlBtn.style.width = '100%';
          htmlBtn.style.padding = '8px 12px';
          htmlBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
          htmlBtn.style.color = 'white';
          htmlBtn.style.fontWeight = '600';
          htmlBtn.style.border = 'none';
          htmlBtn.style.borderRadius = '6px';
        }



        // ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ ì•Œë¦¼ (ìë™ ìƒˆì°½ ì—´ê¸° ì œê±°)
        console.log('âœ… ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ - ì‚¬ìš©ìê°€ "ë³´ê³ ì„œë³´ê¸°" í´ë¦­ ì‹œ ìƒˆì°½ ì—´ë¦¼');
         
         try {
           const reportActions = document.getElementById('report-actions');
           const htmlBtnRef = document.getElementById('btn-export-html');
           reportActions && reportActions.classList.add('report-actions-cta');
           htmlBtnRef && htmlBtnRef.classList.add('report-cta');
           setTimeout(() => {
             reportActions && reportActions.classList.remove('report-actions-cta');
             htmlBtnRef && htmlBtnRef.classList.remove('report-cta');
           }, 2500);
         } catch(_) { /* ignore */ }
        
      } catch (error) {
        console.error('HTML ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨:', error);
        
        // í•˜ë‹¨ ë²„íŠ¼ ìƒíƒœ ë³µì›
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          
          // ì‹¤íŒ¨ ì‹œì—ë§Œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
          if (!window.reportState.isGenerated) {
            htmlBtn.textContent = 'ë³´ê³ ì„œì‘ì„±';
            // ë°•ìŠ¤ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
            htmlBtn.style.width = '100%';
            htmlBtn.style.padding = '8px 12px';
            htmlBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            htmlBtn.style.color = 'white';
            htmlBtn.style.fontWeight = '600';
            htmlBtn.style.border = 'none';
            htmlBtn.style.borderRadius = '6px';
            // ì‹¤íŒ¨ ì‹œì—ë„ CTA íš¨ê³¼ë¡œ ì‚¬ìš©ì ìœ ë„
            try {
              const reportActions = document.getElementById('report-actions');
              reportActions && reportActions.classList.add('report-actions-cta');
              htmlBtn && htmlBtn.classList.add('report-cta');
              setTimeout(() => {
                reportActions && reportActions.classList.remove('report-actions-cta');
                htmlBtn && htmlBtn.classList.remove('report-cta');
              }, 3000);
            } catch(_) { /* ignore */ }
          }
        }
        

        
        alert(`ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
      } finally {
        // ìƒì„± ìƒíƒœ í•´ì œ
        window.reportState.generating = false;
      }
    }

    async function generateHTMLReport() {
      try {
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = true;
          htmlBtn.textContent = 'ë³´ê³ ì„œ ìƒì„±ì¤‘...';
          htmlBtn.classList.add('report-progress');
          htmlBtn.classList.add('blink-text');
        }

        // ëª¨ë‹¬ ì—´ê¸°
        const modal = document.getElementById('html-modal');
        const statusDiv = document.getElementById('html-status');
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'HTML ë³´ê³ ì„œ ìƒì„± ì¤‘...';
        modal.classList.add('show');

        // GPT4 ìµœì¢… ë³´ê³ ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const finalReport = document.getElementById('gpt4-output').value || '';
        if (!finalReport.trim()) {
          throw new Error('GPT4 ìµœì¢… ë³´ê³ ì„œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        }

        // í˜„ì¬ ë‚ ì§œ ìƒì„±
        const today = new Date();
        const dateString = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');

        // HTML ìƒì„± í”„ë¡¬í”„íŠ¸ êµ¬ì„± (ê°„ì†Œí™”)
        const title = 'ì‹œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ';
        const htmlPrompt = 
          'ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ì™„ì „í•œ HTML5 ë¬¸ì„œë¡œ ë³€í™˜í•˜ì„¸ìš”.\n' +
          'ì œëª©: ' + title + '\n' +
          'ì‘ì„±ì¼: ' + dateString + '\n' +
          'ì‘ì„±ì: ë¦¬ìŠ¤í¬ê´€ë¦¬íŒ€\n\n' +
          'ì›ë¬¸:\n' + finalReport + '\n\n' +
          'ìš”êµ¬ì‚¬í•­:\n' +
          '1) ì™„ì „í•œ HTML5 ë¬¸ì„œ í˜•íƒœë¡œ ì¶œë ¥\n' +
          '2) headì— CSS ìŠ¤íƒ€ì¼ í¬í•¨\n' +
          '3) ì œëª©, ëª©ì°¨, ë³¸ë¬¸ ì„¹ì…˜ìœ¼ë¡œ êµ¬ì„±\n' +
          '4) í•œêµ­ì–´ ì›¹ í‘œì¤€ ì¤€ìˆ˜\n' +
          '5) ì¸ì‡„ ê°€ëŠ¥í•œ í˜•íƒœ\n' +
          '6) ë¬¸ì²´ëŠ” ì „ë¬¸ì ì´ê³  ì •ì¤‘í•œ "~ìŠµë‹ˆë‹¤" í˜•ì‹ìœ¼ë¡œ í†µì¼\n\n' +
          'ì˜¤ì§ HTML ì½”ë“œë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.';

        // OpenAI API í˜¸ì¶œ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€ - gpt-4o-mini ì‚¬ìš©)
        // ğŸ”’ ë³´ì•ˆ: getOpenAIAuthHeaders ì œê±°ë¨ - callOpenAI í•¨ìˆ˜ ì‚¬ìš©

        // ğŸ”’ ì•ˆì „í•œ OpenAI í”„ë¡ì‹œ í˜¸ì¶œë¡œ ë³€ê²½ë¨
        const systemPrompt = 'ë„ˆëŠ” HTML ë§ˆí¬ì—… ì „ë¬¸ê°€ì´ë‹¤. ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ë¥¼ ì™„ì „í•œ HTML5 ë¬¸ì„œë¡œ ë³€í™˜í•œë‹¤. ì˜¤ì§ HTML ì½”ë“œë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ ì¼ì ˆ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.';
        const htmlCode = await callOpenAI(systemPrompt, htmlPrompt);
        
        // ê¸°ì¡´ fetch ì½”ë“œ ì œê±°ë¨
        /*const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: 'ë„ˆëŠ” HTML ë§ˆí¬ì—… ì „ë¬¸ê°€ì´ë‹¤. ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ë¥¼ ì™„ì „í•œ HTML5 ë¬¸ì„œë¡œ ë³€í™˜í•œë‹¤. ì˜¤ì§ HTML ì½”ë“œë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ ì¼ì ˆ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.'
              },
              {
                role: 'user',
                content: htmlPrompt
              }
            ],
            max_tokens: 16000,
            temperature: 0.1
          })
        });*/

        // ê¸°ì¡´ ì‘ë‹µ ì²˜ë¦¬ ì½”ë“œ ì œê±°ë¨ - callOpenAIê°€ ì²˜ë¦¬
        /*if (!response.ok) {
          throw new Error(`OpenAI API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const htmlCode = data.choices[0]?.message?.content?.trim();*/

        if (!htmlCode) {
          throw new Error('HTML ìƒì„± ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        }

        // ìƒì„±ëœ HTML ì €ì¥ ë° í‘œì‹œ
        generatedHTMLCode = htmlCode;
        window.reportState.isGenerated = true;
        window.reportState.htmlContent = htmlCode;

                // ğŸ”¸ ì¶”ê°€: ìƒíƒœ ì˜ì†í™”
        try {
          localStorage.setItem('generatedHTMLCode', htmlCode);
          localStorage.setItem('reportState', JSON.stringify({ isGenerated: true }));
        } catch (e) {
          console.warn('ë³´ê³ ì„œ ì €ì¥ ìƒëµ(ìš©ëŸ‰ ì´ˆê³¼):', e);
        }
        
        const previewDiv = document.getElementById('html-preview');
        previewDiv.textContent = htmlCode;

        statusDiv.textContent = 'HTML ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ!';
        statusDiv.style.backgroundColor = '#d4edda';
        
        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        if (htmlBtn) {
          htmlBtn.textContent = 'ë³´ê³ ì„œë³´ê¸°';
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          // ë°•ìŠ¤ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
          htmlBtn.style.width = '100%';
          htmlBtn.style.padding = '8px 12px';
          htmlBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
          htmlBtn.style.color = 'white';
          htmlBtn.style.fontWeight = '600';
          htmlBtn.style.border = 'none';
          htmlBtn.style.borderRadius = '6px';
        }
        statusDiv.style.color = '#155724';

        // 5ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);

      } catch (error) {
        console.error('HTML ìƒì„± ì˜¤ë¥˜:', error);
        const statusDiv = document.getElementById('html-status');
        statusDiv.textContent = `HTML ìƒì„± ì‹¤íŒ¨: ${error.message}`;
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
        
        if (typeof showToast === 'function') {
          showToast(`HTML ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
        } else {
          alert(`HTML ìƒì„± ì‹¤íŒ¨: ${error.message}`);
        }
      } finally {
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          // ìƒíƒœì— ë”°ë¼ í…ìŠ¤íŠ¸ ì„¤ì •
          if (!window.reportState.isGenerated) {
            htmlBtn.textContent = 'ë³´ê³ ì„œì‘ì„±';
            // ë°•ìŠ¤ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
            htmlBtn.style.width = '100%';
            htmlBtn.style.padding = '8px 12px';
            htmlBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            htmlBtn.style.color = 'white';
            htmlBtn.style.fontWeight = '600';
            htmlBtn.style.border = 'none';
            htmlBtn.style.borderRadius = '6px';
          }
        }
      }
    }

    function getCurrentScenarioTitle() {
      // í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¡œë¶€í„° ì œëª© ìƒì„±
      const scenario = document.getElementById('scenario-number')?.value || '1';
      return `ì‹œë‚˜ë¦¬ì˜¤ ${scenario} ë¦¬ìŠ¤í¬ ë¶„ì„ ë³´ê³ ì„œ`;
    }

    function closeHTMLModal() {
      const modal = document.getElementById('html-modal');
      modal?.classList.remove('show');
    }

    // íŒì—… ì—†ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
    function downloadHTMLDirect(htmlCode, title, dateString) {
      try {
        const blob = new Blob([htmlCode], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ì‹œë‚˜ë¦¬ì˜¤_${getCurrentScenarioNumber()}_ë¦¬ìŠ¤í¬ë¶„ì„ë³´ê³ ì„œ_${getCurrentDateString()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        if (typeof showToast === 'function') {
          showToast('HTML ë³´ê³ ì„œê°€ ìƒì„±ë˜ê³  ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
          alert('HTML ë³´ê³ ì„œê°€ ìƒì„±ë˜ê³  ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('HTML ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('HTML ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    function downloadHTML() {
      if (!generatedHTMLCode) {
        alert('ë¨¼ì € HTMLì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
      }

      const blob = new Blob([generatedHTMLCode], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ì‹œë‚˜ë¦¬ì˜¤_${getCurrentScenarioNumber()}_ë¦¬ìŠ¤í¬ë¶„ì„ë³´ê³ ì„œ_${getCurrentDateString()}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      if (typeof showToast === 'function') {
        showToast('HTML íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }
    }

    function copyHTMLCode() {
      if (!generatedHTMLCode) {
        alert('ë¨¼ì € HTMLì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
      }

      navigator.clipboard.writeText(generatedHTMLCode).then(() => {
        if (typeof showToast === 'function') {
          showToast('HTML ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
          alert('HTML ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }).catch(err => {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
        // í´ë°±: í…ìŠ¤íŠ¸ ì„ íƒ
        const previewDiv = document.getElementById('html-preview');
        const range = document.createRange();
        range.selectNodeContents(previewDiv);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        alert('HTML ì½”ë“œë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. Ctrl+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.');
      });
    }

    function previewHTML() {
      if (!generatedHTMLCode) {
        alert('ë¨¼ì € HTMLì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ìƒˆ ì°½ì—ì„œ HTML ë¯¸ë¦¬ë³´ê¸°
      const previewWindow = window.open('', '_blank');
      previewWindow.document.open();
      previewWindow.document.write(generatedHTMLCode);
      previewWindow.document.close();
    }

    // ìƒì„±ê³¼ ë™ì‹œì— ìƒˆì°½ì—ì„œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
    function previewHTMLDirect(htmlCode) {
      try {
        // ìƒˆ ì°½ì—ì„œ HTML ë°”ë¡œ ë³´ê¸°
        const previewWindow = window.open('', '_blank');
        if (previewWindow) {
          previewWindow.document.open();
          previewWindow.document.write(htmlCode);
          previewWindow.document.close();
          
          if (typeof showToast === 'function') {
            showToast('ë³´ê³ ì„œê°€ ìƒˆì°½ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
          } else {
            alert('ë³´ê³ ì„œê°€ ìƒˆì°½ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤.');
          }
        } else {
          // íŒì—…ì´ ì°¨ë‹¨ëœ ê²½ìš° ëŒ€ì²´ ë°©ë²•
          if (typeof showToast === 'function') {
            showToast('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.', 'warning');
          } else {
            alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.');
          }
        }
      } catch (error) {
        console.error('HTML ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨:', error);
        alert('HTML ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ' + error.message);
      }
    }

    function getCurrentScenarioNumber() {
      return document.getElementById('scenario-number')?.value || '1';
    }

    function getCurrentDateString() {
      const today = new Date();
      return today.getFullYear() + 
             String(today.getMonth() + 1).padStart(2, '0') + 
             String(today.getDate()).padStart(2, '0');
    }

    // HTML ëª¨ë‹¬ í´ë¦­ ì´ë²¤íŠ¸ (ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ì‹œ ë‹«ê¸°)
    document.addEventListener('DOMContentLoaded', function() {
      const htmlModal = document.getElementById('html-modal');
      if (htmlModal) {
        htmlModal.addEventListener('click', function(event) {
          if (event.target === htmlModal) {
            closeHTMLModal();
          }
        });
      }
      
      // í˜ì´ì§€ ì´ˆê¸°í™”
      initializePage();
    });

  </script>
  
  <!-- ìˆ˜ì •ëœ ì „ì—­ í•¨ìˆ˜ë“¤ -->
  <script src="fixed_functions.js"></script>
  
  <!-- íŒŒì´í”„ë¼ì¸ ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
  <script id="pipeline-inline">
// ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ <script id="pipeline-inline">â€¦</script> ì•ˆì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°

(function () {
  'use strict';

  /* ===== ì‹¤í–‰ ë²„íŠ¼ íƒìƒ‰ ===== */
  let _topRunBtn = null;
  function getTopRunBtn() {
    if (_topRunBtn && document.body.contains(_topRunBtn)) return _topRunBtn;
    _topRunBtn =
      document.querySelector('#top-pipeline-btn') ||
      document.querySelector('#run-pipeline-btn') ||
      document.querySelector('#analyze-start-btn') ||
      document.querySelector('button[data-action="run-pipeline"]') ||
      document.querySelector('button#analyze-start') ||
      document.querySelector('button.top-run');
    return _topRunBtn;
  }
  function setTopButtonState(state, label) {
    const btn = getTopRunBtn();
    if (!btn) return;
    const txt = String(label || '').trim();
    if (state === 'idle') {
      btn.disabled = false; btn.removeAttribute('aria-busy'); if (txt) btn.textContent = txt;
    } else if (state === 'running') {
      btn.disabled = true; btn.setAttribute('aria-busy','true'); if (txt) btn.textContent = txt;
    } else if (state === 'report') {
      btn.disabled = false; btn.removeAttribute('aria-busy'); btn.textContent = 'ë³´ê³ ì„œ ì‘ì„±';
    } else if (state === 'retry') {
      btn.disabled = false; btn.removeAttribute('aria-busy'); btn.textContent = 'ë‹¤ì‹œ ì‹¤í–‰';
    }
  }
  function showStatus(message) {
    // ê¸°ì¡´ showStatusê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    if (typeof window.showStatus === 'function') return window.showStatus(message);
    const el = document.querySelector('#send-status') || document.querySelector('.status');
    if (el) el.textContent = String(message || '');
  }

  /* ===== ê³µìš© ì…€ë ‰í„° ìœ í‹¸ ===== */
  function getCardEl(id) {
    return (
      document.querySelector(`#card-${id}`) ||
      document.querySelector(`[data-card="${id}"]`) ||
      document.querySelector(`.${id}-module-box`) ||
      null
    );
  }
  function getLineEl(id) {
    return (
      document.querySelector(`.pipeline-line.to-${id}`) ||
      document.querySelector(`[data-to="${id}"]`) ||
      null
    );
  }

  /* ===== íš¨ê³¼ íƒ€ì„ë¼ì¸: ì„ (flow)+ë°•ìŠ¤(active) 1ë¶„ì”© ìˆœì°¨ ===== */
  const Effects = {
    order: ['gpt0','gpt1','gpt2','gpt3','gpt4'],
    durMs: 60000, // 1ë¶„
    timers: [],
    running: false,

    start({ order, durationMs } = {}) {
      this.stop();
      if (Array.isArray(order) && order.length) this.order = order.slice();
      if (typeof durationMs === 'number' && durationMs > 0) this.durMs = durationMs;

      this.running = true;
      let acc = 0;

      this.order.forEach((id, idx) => {
        const tStart = setTimeout(() => {
          if (!this.running) return;
          if (idx > 0) this._stopOne(this.order[idx-1]);
          this._startOne(id);
        }, acc);
        this.timers.push(tStart);
        acc += this.durMs;

        const tEnd = setTimeout(() => {
          if (!this.running) return;
          this._stopOne(id);
        }, acc);
        this.timers.push(tEnd);
      });

      const tAllEnd = setTimeout(() => this.stop(), acc + 10);
      this.timers.push(tAllEnd);
    },

    stop() {
      this.running = false;
      this.timers.forEach(t => clearTimeout(t));
      this.timers = [];
      this._stopAll();
    },

    _startOne(id) {
      const card = getCardEl(id);
      if (card) card.classList.add('active');

      // D3ê°€ ìˆìœ¼ë©´ D3ë¡œ, ì—†ìœ¼ë©´ DOM classë¡œ í´ë°±
      const line = getLineEl(id);
      if (window.d3 && typeof d3.selectAll === 'function') {
        try {
          d3.selectAll('.pipeline-line').classed('flow', false);
          if (line) d3.select(line).classed('flow', true);
        } catch(e) { if (line) line.classList.add('flow'); }
      } else {
        // ì•„ì§ ì„ ì´ ë™ì ìœ¼ë¡œ ìƒì„± ì•ˆëì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¬ì‹œë„ ë£¨í”„(ìµœëŒ€ 3ì´ˆ)
        if (line) {
          line.classList.add('flow');
        } else {
          let tries = 0;
          const interval = setInterval(() => {
            const l = getLineEl(id);
            if (l) { l.classList.add('flow'); clearInterval(interval); }
            if (++tries > 30) clearInterval(interval);
          }, 100);
        }
      }
    },

    _stopOne(id) {
      const card = getCardEl(id);
      if (card) card.classList.remove('active');
      const line = getLineEl(id);
      if (window.d3 && typeof d3.selectAll === 'function') {
        try { d3.selectAll('.pipeline-line').classed('flow', false); }
        catch(e) { if (line) line.classList.remove('flow'); }
      } else {
        if (line) line.classList.remove('flow');
      }
    },

    _stopAll() {
      ['gpt0','gpt1','gpt2','gpt3','gpt4'].forEach(id => this._stopOne(id));
    }
  };

  /* ===== íŒŒì´í”„ë¼ì¸ ì‹¤í–‰(íš¨ê³¼ì™€ ì™„ì „ ë¶„ë¦¬) ===== */
  async function startPipelineWithEffects() {
    Effects.start({ durationMs: 60000 }); // í•„ìš” ì‹œ 60000 â†’ 20000 ë“±ìœ¼ë¡œ ì¡°ì ˆ

    try {
      setTopButtonState('running','1/4ë‹¨ê³„: gpt0 ì‹¤í–‰');

      if (typeof window.executePipelineSteps === 'function') {
        await window.executePipelineSteps((step, desc) => {
          showStatus(`ğŸ“Š ${step}/4ë‹¨ê³„: ${desc}`);
          setTopButtonState('running', `${step}/4ë‹¨ê³„: ${desc}`);
        });
      } else {
        // í´ë°±(ì‹¤í–‰ê¸° ì—†ì„ ë•Œ ê°„ë‹¨ íƒ€ì„ë¼ì¸ë§Œ ì§„í–‰)
        showStatus('ğŸ“Š 2/4ë‹¨ê³„: gpt1 ì‹¤í–‰'); await new Promise(r=>setTimeout(r,1200));
        showStatus('ğŸ“Š 3/4ë‹¨ê³„: gpt2 ì‹¤í–‰'); await new Promise(r=>setTimeout(r,1200));
        showStatus('ğŸ“Š 4/4ë‹¨ê³„: gpt3 ì‹¤í–‰'); await new Promise(r=>setTimeout(r,1200));
      }

      setTopButtonState('report');
      showStatus('ğŸ‰ ë¶„ì„ ì™„ë£Œ! "ë³´ê³ ì„œ ì‘ì„±" ë²„íŠ¼ìœ¼ë¡œ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì„¸ìš”.');
    } catch (err) {
      console.error('âŒ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì˜¤ë¥˜:', err);
      setTopButtonState('retry');
      showStatus(`âŒ ì˜¤ë¥˜: ${err.message || err}`);
    } finally {
      Effects.stop();
    }
  }

  /* ===== ì´ˆê¸° ë°”ì¸ë”© ===== */
  document.addEventListener('DOMContentLoaded', () => {
    setTopButtonState('idle','ë¶„ì„ ì‹œì‘');
    const btn = getTopRunBtn();
    if (btn) {
      btn.removeAttribute('onclick');
      btn.addEventListener('click', () => startPipelineWithEffects());
    }
    // ì™¸ë¶€ì—ì„œ ì œì–´í•  ìˆ˜ ìˆë„ë¡ ë…¸ì¶œ
    window.startPipelineWithEffects = startPipelineWithEffects;
    window.pipelineEffects = Effects;
  });
})();
  </script>
  
  <!-- [PATCH] GPT4 ì™„ë£Œ ì‹œ ì˜¤ë¥¸ìª½ íƒ­ ì „ì²´ ë°•ìŠ¤ ì „ê°œ ìœ í‹¸ -->
  <!-- [PATCH] ì™„ë£Œ í†µí•© í•¸ë“¤ëŸ¬: ê¹œë°•ì„ ì™„ì „ ì¢…ë£Œ + ì „ì²´ ë°•ìŠ¤ ì „ê°œ -->
  <script id="patch-unified-done-handler">
(function(){
  /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ë£¨íŠ¸ íƒìƒ‰(ëˆ„ë½ ë°©ì§€: #gpt1-panel í¬í•¨) */
  function getRightPanelRoot() {
    return (
      document.querySelector('.right-tab-panel') ||
      document.querySelector('#gpt1-panel') ||
      document.querySelector('#gpt-right-panel') ||
      document.querySelector('.right-tab') ||
      document.querySelector('[data-panel="right"]') ||
      document.querySelector('#gpt-panels') ||
      (document.querySelector('#gpt3-panel') && document.querySelector('#gpt3-panel').closest('.tab-content')) ||
      document.body
    );
  }

  /* 1) ëª¨ë“  ì§„í–‰/ê¹œë°•ì„/ì˜¤ë²„ë ˆì´ ì œê±° */
  function stopAllPipelineEffects() {
    const removeClasses = ['running','active','done','blink','shimmer','loading','animate-pulse','status-shine'];
    document.querySelectorAll('.running, .active, .done, .blink, .shimmer, .loading, .animate-pulse, .status-shine')
      .forEach(el => removeClasses.forEach(c => el.classList.remove(c)));
    document.querySelectorAll('.progress-indicator, .execution-overlay, .progress, .progress-bar, .skeleton, .spinner')
      .forEach(el => { try { el.remove(); } catch(e) { el.style.display = 'none'; } });

    // GPT3 ëª¨ë“ˆë³„ ë°•ìŠ¤ íš¨ê³¼ ì™„ì „ ì œê±°
    document.querySelectorAll('.gpt3-module-box.running, .gpt0-module-box.running, .gpt1-module-box.running, .gpt2-module-box.running, .gpt4-module-box.running')
      .forEach(el => el.classList.remove('running'));

    // ì¸ë¼ì¸ ì• ë‹ˆë©”ì´ì…˜ë„ ê°•ì œ ì¢…ë£Œ
    document.querySelectorAll('*').forEach(el => {
      if (el.style && (el.style.animation || el.style.webkitAnimation)) {
        el.style.animation = 'none';
        el.style.webkitAnimation = 'none';
      }
    });

    // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜ì§ì„ í•´ì œ
    const status = document.querySelector('#send-status, .send-status, [data-role="status"]');
    if (status) status.classList.remove('status-shine');
  }

  /* 2) ì˜¤ë¥¸ìª½ íƒ­ ì „ì²´ ë°•ìŠ¤ ì „ê°œ */
  function showAllRightBoxes() {
    const root = getRightPanelRoot();
    if (root) root.classList.add('show-all');

    // ìš°ì¸¡ íŒ¨ë„ í›„ë³´ë“¤ì„ ëª¨ë‘ ëŒ€ìƒìœ¼ë¡œ ë™ì‹œ ë³´ê°•
    const panels = [
      document.querySelector('#gpt1-panel'),
      document.querySelector('.right-tab-panel'),
      document.querySelector('#gpt-right-panel'),
      document.querySelector('#right-tab'),
      document.querySelector('aside#right-panel'),
      document.querySelector('[data-panel="right"]')
    ].filter(Boolean);

    panels.forEach(p => { p.classList.remove('solo-mode','gpt2worst-mode'); p.classList.add('show-all'); });

    const selectors = [
      '.gpt-box','.agent-card','.panel-box','.module-card','[data-role="box"]'
    ].join(',');

    // ìˆ¨ê¹€/ì ‘í˜/íˆ¬ëª… ì œê±°
    document.querySelectorAll(selectors).forEach(el => {
      el.classList.remove('hidden','collapse','collapsed','invisible','opacity-0');
      el.style.display = '';
      el.style.opacity = '';
      el.style.visibility = '';
      el.style.maxHeight = '';
      el.style.height = '';
      el.setAttribute('aria-hidden','false');
    });

    // GPT0~GPT4ê¹Œì§€ ëª¨ë“  ì¹´ë“œ ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œ
    const cardIds = [
      'card-gpt0-marketdata', 'card-gpt0-news', 'card-gpt0-scenario-summary', 'card-gpt0-marketstate',
      'card-gpt1', 'card-gpt2', 
      'card-gpt3-market', 'card-gpt3-credit', 'card-gpt3-alm', 'card-gpt3-global', 'card-gpt3-creditpf',
      'card-gpt4'
    ];
    
    cardIds.forEach(id => {
      const card = document.getElementById(id);
      if (card) {
        card.style.display = 'block';
        card.classList.remove('hidden', 'collapse', 'collapsed', 'invisible');
        card.setAttribute('aria-hidden', 'false');
        console.log(`âœ… ì™„ë£Œ í›„ ${id} í‘œì‹œë¨`);
      }
    });

    // ì•„ì½”ë””ì–¸/í† ê¸€ ì „ê°œ
    document.querySelectorAll('details').forEach(d => d.open = true);
    document.querySelectorAll('[aria-expanded="false"]').forEach(t => t.setAttribute('aria-expanded','true'));

    // ìŠ¤í¬ë¡¤ ìƒë‹¨ìœ¼ë¡œ
    const scroller = root.querySelector('.scrollable, .tab-scroll, #gpt4-panel, #gpt3-panel, #gpt2-panel, #gpt1-panel') || root;
    if (scroller && typeof scroller.scrollTo === 'function') {
      scroller.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  /* 3) ì™„ë£Œ ì‹œ ê³µí†µ ì²˜ë¦¬ (ë©±ë“±) */
  function onPipelineDone() {
    // ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš°ì—ë„ ì”ì—¬ íš¨ê³¼/í´ë˜ìŠ¤ ì •ë¦¬ë¥¼ 1íšŒ ë” ìˆ˜í–‰
    stopAllPipelineEffects();

    // ìš°ì¸¡ íŒ¨ë„ í›„ë³´ ì „ë¶€ì— ëŒ€í•´ solo-mode í•´ì œ + show-all ë¶€ì—¬(ë ˆì´ìŠ¤ ë°©ì§€)
    const panels = [
      document.querySelector('#gpt1-panel'),
      document.querySelector('.right-tab-panel'),
      document.querySelector('#gpt-right-panel'),
      document.querySelector('#right-tab'),
      document.querySelector('aside#right-panel'),
      document.querySelector('[data-panel="right"]')
    ].filter(Boolean);

    panels.forEach(p => { p.classList.remove('solo-mode','gpt2worst-mode'); p.classList.add('show-all'); });

    // ì”ì—¬ ì˜¤ë²„ë ˆì´/ì‹¤í–‰ í´ë˜ìŠ¤ ì œê±°(ë³´ìˆ˜ì  ì¤‘ë³µ ìˆ˜í–‰)
    document.querySelectorAll('.execution-overlay').forEach(el => el.remove());
    document.querySelectorAll('.agent-card.running, .agent-card.active')
      .forEach(el => el.classList.remove('running','active'));

    document.body.classList.add('pipeline-complete');
    showAllRightBoxes();

    // í•„ìš” ì‹œ GPT4 ì•µì»¤ë¡œ ìŠ¤í¬ë¡¤ ìœ ì§€
    window.scrollAnchorIntoView?.('.gpt4-anchor');

    // GPT3 í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í™•ì¥
    ['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf'].forEach(id => {
      const ta = document.getElementById(id);
      if (ta) { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; }
    });
  }

  /* 4) ì´ë²¤íŠ¸ ë°”ì¸ë”©: ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ë‹¨ì¼ ì²˜ë¦¬ë¡œ í†µí•© */
  // ì™„ë£Œ ì´ë²¤íŠ¸ëŠ” ëª¨ë‘ ê°™ì€ í•¸ë“¤ëŸ¬ë¡œ ì²˜ë¦¬(ì¤‘ë³µ ì•ˆì „)
  ['gpt4:done','gpt4:complete','pipeline:done'].forEach(evt => {
    window.addEventListener(evt, onPipelineDone, { once: false });
  });

  // gpt4:completeë§Œ ë‚˜ì˜¤ëŠ” í™˜ê²½ì„ ìœ„í•´ done ë¸Œë¦¿ì§€ ë³´ì¥
  window.addEventListener('gpt4:complete', () => {
    try { window.dispatchEvent(new Event('gpt4:done')); } catch(e) {}
  });

  /* 6) í´ë°±: ë³´ê³ ì„œ DOM ìƒì„± ê°ì§€ ì‹œì—ë„ ì™„ë£Œ ì²˜ë¦¬ 1íšŒ ê°•ì œ */
  function isReportReady() {
    return !!document.querySelector('#final-report, [data-role="report"], #gpt4-report');
  }
  const mo = new MutationObserver(() => {
    if (isReportReady()) {
      onPipelineDone();
      mo.disconnect();
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
    mo.observe(document.body, { childList: true, subtree: true });
    if (isReportReady()) { onPipelineDone(); mo.disconnect(); }
  });

  /* 7) ì™¸ë¶€ì—ì„œ ìˆ˜ë™ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ(ë””ë²„ê·¸/ìˆ˜ë™ íŠ¸ë¦¬ê±°ìš©) */
  window.__forcePipelineDone = onPipelineDone;
  
  /* 8) revealAllRightTabBoxes í•¨ìˆ˜ë¥¼ windowì— ë…¸ì¶œ (í˜¸í™˜ì„±) */
  window.revealAllRightTabBoxes = function() {
    console.log('ğŸ”“ revealAllRightTabBoxes í˜¸ì¶œë¨ - GPT0~GPT4 ì „ì²´ ë°•ìŠ¤ í‘œì‹œ');
    
    // solo-mode ì œê±° ë° show-all ì¶”ê°€
    const panels = [
      document.querySelector('#gpt1-panel'),
      document.querySelector('.right-tab-panel'),
      document.querySelector('#gpt-right-panel'),
      document.querySelector('#right-tab'),
      document.querySelector('aside#right-panel'),
      document.querySelector('[data-panel="right"]')
    ].filter(Boolean);
    
    panels.forEach(p => {
      p.classList.remove('solo-mode','gpt2worst-mode');
      p.classList.add('show-all');
    });
    
    // ëª¨ë“  agent-cardì™€ ê´€ë ¨ ë°•ìŠ¤ í‘œì‹œ
    const allCards = document.querySelectorAll('.agent-card, .gpt-box, .panel-box, .module-card, [data-role="box"]');
    allCards.forEach(card => {
      card.style.display = '';
      card.classList.remove('hidden', 'collapse', 'collapsed', 'invisible');
      card.setAttribute('aria-hidden', 'false');
    });
    
    // GPT0~GPT4ê¹Œì§€ ëª¨ë“  ì¹´ë“œ ëª…ì‹œì ìœ¼ë¡œ í‘œì‹œ
    const cardIds = [
      'card-gpt0-marketdata', 'card-gpt0-news', 'card-gpt0-scenario-summary', 'card-gpt0-marketstate',
      'card-gpt1', 'card-gpt2', 
      'card-gpt3-market', 'card-gpt3-credit', 'card-gpt3-alm', 'card-gpt3-global', 'card-gpt3-creditpf',
      'card-gpt4'
    ];
    
    cardIds.forEach(id => {
      const card = document.getElementById(id);
      if (card) {
        card.style.display = 'block';
        card.classList.remove('hidden');
        console.log(`âœ… ${id} í‘œì‹œë¨`);
      }
    });
    
    document.body.classList.add('pipeline-complete');
    
    console.log('âœ… ì „ì²´ ë°•ìŠ¤ í‘œì‹œ ì™„ë£Œ');
  };
})();

  // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function convertMarkdownToHtml(markdown) {
    if (!markdown) return '';
    
    let html = markdown;
    
    // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ (ë¨¼ì € ì²˜ë¦¬)
    html = html.replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;');
    
    // ì œëª© ë³€í™˜ (####, ###, ##, # ìˆœì„œë¡œ ì²˜ë¦¬)
    html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // êµµê²Œ + ì´íƒ¤ë¦­: ***í…ìŠ¤íŠ¸*** ë˜ëŠ” ___í…ìŠ¤íŠ¸___
    html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\_\_\_(.*?)\_\_\_/g, '<strong><em>$1</em></strong>');
    
    // êµµê²Œ: **í…ìŠ¤íŠ¸** ë˜ëŠ” __í…ìŠ¤íŠ¸__
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\_\_(.*?)\_\_/g, '<strong>$1</strong>');
    
    // ì´íƒ¤ë¦­: *í…ìŠ¤íŠ¸* ë˜ëŠ” _í…ìŠ¤íŠ¸_
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/\_(.*?)\_/g, '<em>$1</em>');
    
    // ì½”ë“œ ë¸”ë¡: ```ì½”ë“œ```
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    
    // ì¸ë¼ì¸ ì½”ë“œ: `ì½”ë“œ`
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // ë§í¬: [í…ìŠ¤íŠ¸](URL)
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // ì´ë¯¸ì§€: ![alt](URL)
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">');
    
    // ìˆ˜í‰ì„ : --- ë˜ëŠ” ***
    html = html.replace(/^---$/gim, '<hr>');
    html = html.replace(/^\*\*\*$/gim, '<hr>');
    
    // ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (ê°œì„ ëœ ë²„ì „)
    const lines = html.split('\n');
    const result = [];
    let inList = false;
    let listType = null;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const unorderedMatch = line.match(/^[\s]*[-*+]\s+(.+)$/);
      const orderedMatch = line.match(/^[\s]*\d+\.\s+(.+)$/);
      
      if (unorderedMatch) {
        if (!inList || listType !== 'ul') {
          if (inList) result.push(`</${listType}>`);
          result.push('<ul>');
          listType = 'ul';
          inList = true;
        }
        result.push(`<li>${unorderedMatch[1]}</li>`);
      } else if (orderedMatch) {
        if (!inList || listType !== 'ol') {
          if (inList) result.push(`</${listType}>`);
          result.push('<ol>');
          listType = 'ol';
          inList = true;
        }
        result.push(`<li>${orderedMatch[1]}</li>`);
      } else {
        if (inList) {
          result.push(`</${listType}>`);
          inList = false;
          listType = null;
        }
        result.push(line);
      }
    }
    
    if (inList) {
      result.push(`</${listType}>`);
    }
    
    html = result.join('\n');
    
    // ì¤„ë°”ê¿ˆ ì²˜ë¦¬: ë‘ ê°œ ì´ìƒì˜ ì¤„ë°”ê¿ˆì€ ë‹¨ë½ìœ¼ë¡œ, í•˜ë‚˜ëŠ” <br>ë¡œ
    html = html.replace(/\n\n+/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    html = '<p>' + html + '</p>';
    
    // ë¹ˆ ë‹¨ë½ ì œê±°
    html = html.replace(/<p><\/p>/g, '');
    html = html.replace(/<p><br><\/p>/g, '');
    
    return html;
  }

  // ë³´ê³ ì„œì‘ì„± ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  function showHtmlReport() {
    // gpt4 ì¶œë ¥ ë‚´ìš© ê°€ì ¸ì˜¤ê¸° (textareaì´ë¯€ë¡œ value ì‚¬ìš©)
    let gpt4Content = document.querySelector("#gpt4-output")?.value || "";
    
    // ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ placeholderë§Œ ìˆëŠ” ê²½ìš° ì²˜ë¦¬
    if (!gpt4Content.trim() || gpt4Content.includes("GPT4 ìµœì¢… ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤")) {
      gpt4Content = "âš ï¸ ë³´ê³ ì„œ ë‚´ìš©ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n" +
                   "ë‹¤ìŒ ë‹¨ê³„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”:\n" +
                   "1. íŒŒì´í”„ë¼ì¸ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸\n" +
                   "2. GPT4 ë‹¨ê³„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸\n" +
                   "3. GPT4 ì¶œë ¥ ê²°ê³¼ì— ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸\n\n" +
                   "ë¬¸ì œê°€ ì§€ì†ë˜ë©´ íŒŒì´í”„ë¼ì¸ì„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.";
    }

    // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
    const htmlContent = convertMarkdownToHtml(gpt4Content);

    // HTML í¬ë§· êµ¬ì„±
    const htmlReport = `
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <title>GPT4 ë³´ê³ ì„œ</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; 
            padding: 15px; 
            line-height: 1.5; 
            max-width: 1200px; 
            margin: 0 auto;
            background-color: #f8f9fa;
            color: #333;
          }
          .report-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }
          h1 { 
            color: #2c3e50; 
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            line-height: 1.3;
          }
          h2 { 
            color: #34495e; 
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #ecf0f1;
            font-size: 1.4em;
            line-height: 1.3;
          }
          h3 { 
            color: #34495e; 
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.2em;
            line-height: 1.3;
          }
          h4 { 
            color: #34495e; 
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 1.1em;
            line-height: 1.3;
          }
          p { 
            margin-top: 0;
            margin-bottom: 8px; 
            line-height: 1.6;
          }
          .content {
            font-family: inherit;
            line-height: 1.6;
          }
          strong {
            font-weight: 700;
            color: #2c3e50;
          }
          em {
            font-style: italic;
            color: #7f8c8d;
          }
          code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #c7254e;
          }
          pre {
            background-color: #f4f4f4;
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
            margin: 10px 0;
          }
          pre code {
            background: none;
            padding: 0;
            color: #333;
          }
          ul, ol {
            margin: 10px 0;
            padding-left: 25px;
          }
          li {
            margin: 4px 0;
            line-height: 1.5;
          }
          hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 20px 0;
          }
          a {
            color: #3498db;
            text-decoration: none;
          }
          a:hover {
            text-decoration: underline;
          }
          .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
          }
          .metric {
            font-weight: bold;
            color: #e74c3c;
          }
          .positive { color: #27ae60; }
          .negative { color: #e74c3c; }
          
          /* ğŸ”¥ ëª¨ë°”ì¼ ìµœì í™”: í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
          @media (max-width: 768px) {
            body {
              padding: 8px;
              font-size: 12px; /* 14px â†’ 12px */
            }
            .report-container {
              padding: 12px; /* 15px â†’ 12px */
              border-radius: 4px;
            }
            h1 {
              font-size: 1.3em; /* 1.5em â†’ 1.3em */
              margin-bottom: 10px;
              padding-bottom: 5px;
            }
            h2 {
              font-size: 1.15em; /* 1.3em â†’ 1.15em */
              margin-top: 12px;
              margin-bottom: 6px;
              padding-bottom: 3px;
            }
            h3 {
              font-size: 1.05em; /* 1.15em â†’ 1.05em */
              margin-top: 10px;
              margin-bottom: 5px;
            }
            h4 {
              font-size: 1em; /* 1.05em â†’ 1em */
              margin-top: 8px;
              margin-bottom: 4px;
            }
            p {
              margin-bottom: 5px;
              line-height: 1.4; /* 1.5 â†’ 1.4 */
              font-size: 0.95em; /* ì¶”ê°€: ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì¶•ì†Œ */
            }
            ul, ol {
              margin: 6px 0;
              padding-left: 18px;
              font-size: 0.95em; /* ì¶”ê°€: ë¦¬ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ì¶•ì†Œ */
            }
            li {
              margin: 2px 0;
              line-height: 1.4;
            }
            pre {
              padding: 10px;
              margin: 8px 0;
              font-size: 0.85em;
            }
            hr {
              margin: 15px 0;
            }
          }
          
          /* ğŸ”¥ ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ ìµœì í™” */
          @media (orientation: landscape) and (max-height: 600px) {
            body {
              padding: 6px;
              font-size: 11px;
            }
            .report-container {
              padding: 10px;
            }
            h1 { font-size: 1.2em; margin-bottom: 8px; }
            h2 { font-size: 1.1em; margin-top: 10px; margin-bottom: 5px; }
            h3 { font-size: 1em; margin-top: 8px; margin-bottom: 4px; }
            h4 { font-size: 0.95em; margin-top: 6px; margin-bottom: 3px; }
            p { font-size: 0.9em; margin-bottom: 4px; line-height: 1.3; }
            ul, ol { font-size: 0.9em; margin: 5px 0; padding-left: 15px; }
            li { margin: 1px 0; line-height: 1.3; }
          }
          
          /* ë§¤ìš° ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ */
          @media (max-width: 480px) {
            body {
              padding: 6px;
              font-size: 11px; /* 13px â†’ 11px */
            }
            .report-container {
              padding: 12px;
            }
            h1 {
              font-size: 1.4em;
              margin-bottom: 10px;
            }
            h2 {
              font-size: 1.2em;
              margin-top: 12px;
              margin-bottom: 6px;
            }
            h3 {
              font-size: 1.1em;
              margin-top: 10px;
              margin-bottom: 5px;
            }
            h4 {
              font-size: 1.05em;
              margin-top: 8px;
              margin-bottom: 4px;
            }
          }
        </style>
      </head>
      <body>
        <div class="report-container">
          <h1>ğŸ“Š GPT4 ìµœì¢… ë¶„ì„ ë³´ê³ ì„œ</h1>
          <div class="content">${htmlContent}</div>
        </div>
      </body>
      </html>
    `;

    // iframeì— ì¶œë ¥
    const reportFrame = document.getElementById("html-report-frame");
    reportFrame.srcdoc = htmlReport;

    // ëª¨ë‹¬ ì—´ê¸°
    document.getElementById("html-report-modal").classList.add("show");
  }

  // ë³´ê³ ì„œ ë‹«ê¸° í•¨ìˆ˜
  function closeHtmlReport() {
    document.getElementById("html-report-modal").classList.remove("show");
  }

  // íŒŒì´í”„ë¼ì¸ ì¬ì‹œì‘ í•¨ìˆ˜
  function restartPipeline() {
    console.log('ğŸ”„ íŒŒì´í”„ë¼ì¸ ì¬ì‹œì‘ ìš”ì²­');
    
    // ë³´ê³ ì„œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
    const reportBtnsContainer = document.getElementById('report-buttons-container');
    if (reportBtnsContainer) {
      reportBtnsContainer.style.display = 'none';
    }
    
    // ë¶„ì„ì‹¤í–‰ ë²„íŠ¼ í‘œì‹œ
    const topBtn = document.getElementById('top-pipeline-btn');
    if (topBtn) {
      topBtn.style.display = 'inline-block';
      topBtn.textContent = 'ğŸš€ ë¶„ì„ì‹¤í–‰';
      topBtn.disabled = false;
      topBtn.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
    }
    
    // íŒŒì´í”„ë¼ì¸ ì¬ì‹œì‘
    handlePipelineAndReport();
  }

  // ==== A. ìš°ì¸¡ íƒ­ ì œì–´ í•¨ìˆ˜ ë³´ê°• ====
  // ìš°ì¸¡ íƒ­ ì—˜ë¦¬ë¨¼íŠ¸ ìºì‹œ
  const $rightPanel = () => document.querySelector('aside.sidebar-right');

  // ì¹´ë“œ í—¬í¼: idëŠ” gpt1, gpt2, gpt3, gpt4 ë“± "ì ‘ë¯¸"ë§Œ ë„£ìœ¼ë©´ ë¨
  function getAgentCard(idSuffix) {
    // ìš°ì„ ìˆœìœ„: #card-gpt1, [data-agent="gpt1"], .gpt1-module-box
    return document.querySelector(`#card-${idSuffix}`)
        || document.querySelector(`[data-agent="${idSuffix}"]`)
        || document.querySelector(`.${idSuffix}-module-box`);
  }

  // ì¹´ë“œ ìƒíƒœ í† ê¸€
  function setAgentState(idSuffix, { running=false, done=false, expanded=true, active=true } = {}) {
    const card = getAgentCard(idSuffix);
    if (!card) return;

    // ì‹¤í–‰/ì™„ë£Œ ìƒíƒœ
    card.classList.toggle('running', !!running);
    card.classList.toggle('done', !!done);
    card.classList.toggle('active', !!active);

    // ë‚´ìš© í™•ì¥ (details ì§€ì› & ì¼ë°˜ div ì§€ì›)
    card.classList.toggle('expanded', !!expanded);
    if (card.tagName?.toLowerCase() === 'details') {
      if (expanded) card.setAttribute('open', '');
      else card.removeAttribute('open');
    }
  }

  // íƒ­ ë‹¨ë…í‘œì‹œ í•´ì œ (ì—¬ëŸ¬ ì¹´ë“œ ë™ì‹œ ë…¸ì¶œì„ ìœ„í•´ ë°˜ë“œì‹œ í˜¸ì¶œ)
  function disableSoloMode() {
    const panel = $rightPanel();
    if (panel) panel.classList.remove('solo-mode');
  }

  // ì•ˆì „ ìŠ¤í¬ë¡¤ (ì¹´ë“œê°€ ì‹¤ì œë¡œ ë³´ì—¬ì§€ê²Œ ë³´ì •)
  function scrollToAgent(idSuffix) {
    const panel = $rightPanel();
    const card  = getAgentCard(idSuffix);
    if (!panel || !card) return;
    try {
      const top = card.offsetTop - 12; // ì•½ê°„ ìœ„ ì—¬ìœ 
      panel.scrollTo({ top, behavior: 'smooth' });
    } catch(_) {}
  }

  // ==== B. GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘ ì‹œ ë™ì‹œ ë…¸ì¶œ íŠ¸ë¦¬ê±° ====
  function onGpt2WorstStartUI() {
    console.log('ğŸš€ onGpt2WorstStartUI ì‹¤í–‰ ì‹œì‘');
    
    // 1) ëª¨ë“  íŒ¨ë„ í´ë˜ìŠ¤ ì •ë¦¬
    const panel = $rightPanel();
    if (panel) {
      console.log('ğŸ“‹ íŒ¨ë„ í´ë˜ìŠ¤ ì •ë¦¬ ì¤‘...');
      panel.classList.remove('solo-mode', 'show-all');
      panel.classList.add('gpt2worst-mode');
      console.log('âœ… íŒ¨ë„ í´ë˜ìŠ¤ ì„¤ì • ì™„ë£Œ:', panel.className);
    }

    // 2) ëª¨ë“  ì¹´ë“œ ì´ˆê¸°í™” (ê°•ì œë¡œ ìˆ¨ê¹€)
    console.log('ğŸ” ëª¨ë“  ì¹´ë“œ ì´ˆê¸°í™” ì¤‘...');
    const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
    allCards.forEach(idSuffix => {
      const card = getAgentCard(idSuffix);
      if (card) {
        card.classList.remove('gpt2worst-visible', 'running', 'active');
        card.style.display = 'none';
        card.style.visibility = 'hidden';
        card.style.opacity = '0';
        console.log(`- ${idSuffix} ì¹´ë“œ ìˆ¨ê¹€ ì™„ë£Œ`);
      }
    });

    // 3) GPT1, GPT2 ì¹´ë“œë§Œ ë³´ì´ê¸°
    console.log('ğŸ‘ï¸ GPT1, GPT2 ì¹´ë“œ í‘œì‹œ ì¤‘...');
    setAgentState('gpt1', { running: true, done: false, expanded: true, active: true });
    setAgentState('gpt2', { running: true, done: false, expanded: true, active: true });
    
    const gpt1Card = getAgentCard('gpt1');
    const gpt2Card = getAgentCard('gpt2');
    
    if (gpt1Card) {
      gpt1Card.classList.add('gpt2worst-visible');
      gpt1Card.style.display = 'block';
      gpt1Card.style.visibility = 'visible';
      gpt1Card.style.opacity = '1';
      console.log('âœ… GPT1 ì¹´ë“œ í‘œì‹œ ì™„ë£Œ');
    }
    
    if (gpt2Card) {
      gpt2Card.classList.add('gpt2worst-visible');
      gpt2Card.style.display = 'block';
      gpt2Card.style.visibility = 'visible';
      gpt2Card.style.opacity = '1';
      console.log('âœ… GPT2 ì¹´ë“œ í‘œì‹œ ì™„ë£Œ');
    }

    // 4) ìŠ¤í¬ë¡¤ì€ GPT1~GPT2 ì¤‘ê°„ì§€ì ìœ¼ë¡œ ë³´ì • (ë‘˜ ë‹¤ ë³´ì´ë„ë¡)
    if (panel && gpt1Card && gpt2Card) {
      const mid = (gpt1Card.offsetTop + gpt2Card.offsetTop) / 2 - 40;
      panel.scrollTo({ top: Math.max(mid, 0), behavior: 'smooth' });
      console.log('ğŸ“œ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì • ì™„ë£Œ');
    } else {
      // í´ë°±
      gpt2Card ? scrollToAgent('gpt2') : scrollToAgent('gpt1');
      console.log('ğŸ“œ í´ë°± ìŠ¤í¬ë¡¤ ì‹¤í–‰');
    }
    
    console.log('ğŸ‰ onGpt2WorstStartUI ì‹¤í–‰ ì™„ë£Œ');
  }

  // ==== C. GPT2 Worst ì‹œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ ì‹œ ìƒíƒœ ì •ë¦¬ ====
  function onGpt2WorstDoneUI() {
    console.log('ğŸ onGpt2WorstDoneUI ì‹¤í–‰ ì‹œì‘');
    
    // GPT1ì€ ì‹¤í–‰ í‘œì‹œ ìœ ì§€(í•„ìš”ì‹œ done), GPT2ëŠ” done ì²˜ë¦¬
    setAgentState('gpt1', { running: false, done: true, expanded: true, active: true });
    setAgentState('gpt2', { running: false, done: true, expanded: true, active: true });

    // GPT2 Worst ëª¨ë“œ í•´ì œ (ëª¨ë“  ì¹´ë“œ ë‹¤ì‹œ ë³´ì´ê¸°)
    const panel = $rightPanel();
    if (panel) {
      panel.classList.remove('gpt2worst-mode');
      console.log('âœ… gpt2worst-mode í´ë˜ìŠ¤ ì œê±° ì™„ë£Œ');
    }

    // ëª¨ë“  ì¹´ë“œ ë‹¤ì‹œ ë³´ì´ê¸°
    console.log('ğŸ‘ï¸ ëª¨ë“  ì¹´ë“œ ë³µì› ì¤‘...');
    const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
    allCards.forEach(idSuffix => {
      const card = getAgentCard(idSuffix);
      if (card) {
        card.classList.remove('gpt2worst-visible');
        card.style.display = '';
        card.style.visibility = '';
        card.style.opacity = '';
        console.log(`- ${idSuffix} ì¹´ë“œ ë³µì› ì™„ë£Œ`);
      }
    });
    
    console.log('ğŸ‰ onGpt2WorstDoneUI ì‹¤í–‰ ì™„ë£Œ');
  }

      // ==== D. ë””ë²„ê¹… ìœ í‹¸ë¦¬í‹° ====
    function debugGpt2WorstMode() {
      const panel = $rightPanel();
      console.log('ğŸ” GPT2 Worst ëª¨ë“œ ë””ë²„ê¹…:');
      console.log('- íŒ¨ë„:', panel);
      console.log('- gpt2worst-mode í´ë˜ìŠ¤:', panel?.classList.contains('gpt2worst-mode'));
      console.log('- solo-mode í´ë˜ìŠ¤:', panel?.classList.contains('solo-mode'));
      console.log('- show-all í´ë˜ìŠ¤:', panel?.classList.contains('show-all'));
      
      const cards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      cards.forEach(id => {
        const card = getAgentCard(id);
        console.log(`- ${id} ì¹´ë“œ:`, card);
        console.log(`  - í‘œì‹œ ìƒíƒœ:`, card?.style.display);
        console.log(`  - gpt2worst-visible í´ë˜ìŠ¤:`, card?.classList.contains('gpt2worst-visible'));
        console.log(`  - running í´ë˜ìŠ¤:`, card?.classList.contains('running'));
      });
    }

    // GPT2 Worst ëª¨ë“œ ê°•ì œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    function testGpt2WorstMode() {
      console.log('ğŸ§ª GPT2 Worst ëª¨ë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘');
      onGpt2WorstStartUI();
      
      // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì™„ë£Œ
      setTimeout(() => {
        console.log('â° 3ì´ˆ í›„ ìë™ ì™„ë£Œ');
        onGpt2WorstDoneUI();
      }, 3000);
    }

    // GPT1, GPT2 ì¹´ë“œ íš¨ê³¼ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    function testGpt1Gpt2Effects() {
      console.log('ğŸ§ª GPT1, GPT2 ì¹´ë“œ íš¨ê³¼ í…ŒìŠ¤íŠ¸ ì‹œì‘');
      showGpt1Gpt2Cards();
    }

    // GPT2 ì‹¤í–‰ íš¨ê³¼ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    function testGpt2ExecutionEffects() {
      console.log('ğŸ§ª GPT2 ì‹¤í–‰ íš¨ê³¼ í…ŒìŠ¤íŠ¸ ì‹œì‘');
      applyGpt2ExecutionEffects();
    }

    // GPT2 â†’ GPT3 ì „í™˜ ì‹œ ì§€ì†ì  íš¨ê³¼ ì ìš© í•¨ìˆ˜
    function applyGpt2PersistentEffects() {
      console.log('ğŸš€ GPT2 â†’ GPT3 ì „í™˜ ì‹œ ì§€ì†ì  íš¨ê³¼ ì ìš© ì‹œì‘');
      
      const gpt2Card = getAgentCard('gpt2');
      if (gpt2Card) {
        // GPT2 ì¹´ë“œì— í¬ê¸° ë³€í™” ì—†ëŠ” íš¨ê³¼ ì¶”ê°€
        gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
        
        // GPT2 ì œëª©ì— ê¸€ì”¨ íš¨ê³¼ ì¶”ê°€
        const gpt2Title = gpt2Card.querySelector('h4');
        if (gpt2Title) {
          gpt2Title.classList.add('text-highlight');
          gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼ âš¡';
        }
        
        // GPT2 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
        scrollToElement('card-gpt2');
        console.log('ğŸ“œ GPT2 â†’ GPT3 ì „í™˜ ì‹œ GPT2 ì¹´ë“œ ì§€ì† íš¨ê³¼ ì ìš© (í¬ê¸° ë³€í™” ì—†ìŒ)');
        
        // GPT3 ì‹œì‘ í›„ 10ì´ˆê¹Œì§€ íš¨ê³¼ ìœ ì§€
        window.gpt2PersistentEffects = {
          card: gpt2Card,
          title: gpt2Title,
          active: true
        };
      }
    }

    // GPT2 â†’ GPT3 ì „í™˜ íš¨ê³¼ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    function testGpt2ToGpt3Transition() {
      console.log('ğŸ§ª GPT2 â†’ GPT3 ì „í™˜ íš¨ê³¼ í…ŒìŠ¤íŠ¸ ì‹œì‘');
      applyGpt2PersistentEffects();
    }

    // ==== E. ìŠ¤í¬ë¡¤ ìœ í‹¸ë¦¬í‹° ====
    function scrollToElement(elementId, offset = -40) {
      // ğŸ”’ ìŠ¤ì½”í”„ ì ê¸ˆ: GPT3 êµ¬ê°„ì€ GPT3 ì¹´ë“œ/ëª¨ë“ˆë§Œ, GPT4 êµ¬ê°„ì€ GPT4 ì¹´ë“œë¡œ ê°•ì œ
      const scope = window.__RightFocusScope || null;
      if (scope === 'gpt3') {
        if (!(elementId === 'card-gpt3' || /^gpt3-/.test(elementId))) {
          elementId = 'card-gpt3';
        }
      } else if (scope === 'gpt4') {
        elementId = 'card-gpt4';
      }

      const element = document.getElementById(elementId);
      if (!element) {
        console.warn(`âš ï¸ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${elementId}`);
        return;
      }
      
      const panel = $rightPanel();
      if (panel) {
        const targetY = Math.max(0, (element.offsetTop || 0) + offset);
        panel.scrollTo({ top: targetY, behavior: 'smooth' });
        console.log(`ğŸ“œ ${elementId}ë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ`);
      } else {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        console.log(`ğŸ“œ ${elementId}ë¡œ ê¸°ë³¸ ìŠ¤í¬ë¡¤ ì™„ë£Œ`);
      }
    }

    // GPT0 ì™„ë£Œ ì‹œ GPT1, GPT2 ì¹´ë“œ í‘œì‹œ í•¨ìˆ˜
    function showGpt1Gpt2Cards() {
      console.log('ğŸš€ GPT0 ì™„ë£Œ - GPT1, GPT2 ì¹´ë“œ í‘œì‹œ ì‹œì‘');
      
      const panel = $rightPanel();
      if (panel) {
        // show-all í´ë˜ìŠ¤ ì¶”ê°€ë¡œ ëª¨ë“  ì¹´ë“œ í‘œì‹œ
        panel.classList.add('show-all');
        panel.classList.remove('solo-mode');
        console.log('âœ… show-all í´ë˜ìŠ¤ ì¶”ê°€ ì™„ë£Œ');
      }

      // GPT1, GPT2 ì¹´ë“œ ê°•ì œ í‘œì‹œ
      const gpt1Card = getAgentCard('gpt1');
      const gpt2Card = getAgentCard('gpt2');
      
      if (gpt1Card) {
        gpt1Card.style.display = 'block';
        gpt1Card.style.visibility = 'visible';
        gpt1Card.style.opacity = '1';
        console.log('âœ… GPT1 ì¹´ë“œ í‘œì‹œ ì™„ë£Œ');
      }
      
      if (gpt2Card) {
        gpt2Card.style.display = 'block';
        gpt2Card.style.visibility = 'visible';
        gpt2Card.style.opacity = '1';
        console.log('âœ… GPT2 ì¹´ë“œ í‘œì‹œ ì™„ë£Œ');
      }

      // GPT1 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        if (gpt1Card) {
          scrollToElement('card-gpt1');
          console.log('ğŸ“œ GPT1 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ');
          
          // GPT1 ì¹´ë“œ ê¹œë°•ì„ íš¨ê³¼ ì¶”ê°€
          gpt1Card.classList.add('card-blink', 'border-pulse', 'border-glow');
          
          // GPT1 ì œëª©ì— ê¸€ì”¨ íš¨ê³¼ ì¶”ê°€
          const gpt1Title = gpt1Card.querySelector('h4');
          if (gpt1Title) {
            gpt1Title.classList.add('text-highlight');
            gpt1Title.textContent = 'GPT1 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼ âœ¨';
          }
          
          // 2ë¶„ í›„ GPT2 ì¹´ë“œë¡œ ì´ë™í•˜ê³  íš¨ê³¼ ì¶”ê°€ (ì¡°ê¸° ë‹¨ê³„ ì§„ì… ì‹œ ì·¨ì†Œë¥¼ ìœ„í•œ íƒ€ì´ë¨¸ ë³´ê´€)
          window.__gpt1ToGpt2Timer && clearTimeout(window.__gpt1ToGpt2Timer);
          window.__gpt1ToGpt2Timer = setTimeout(() => {
            if (gpt2Card) {
              // GPT1 ì¹´ë“œ íš¨ê³¼ ì œê±°
              gpt1Card.classList.remove('card-blink', 'border-pulse', 'border-glow');
              if (gpt1Title) {
                gpt1Title.classList.remove('text-highlight');
                gpt1Title.textContent = 'GPT1 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼';
              }
              console.log('âœ… GPT1 ì¹´ë“œ íš¨ê³¼ ì œê±° ì™„ë£Œ');
              
              // GPT2 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
              scrollToElement('card-gpt2');
              console.log('ğŸ“œ GPT2 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ');
              
              // GPT2 ì¹´ë“œ ì§€ì† íš¨ê³¼ ì ìš©
              gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
              
              // GPT2 ì œëª©ì— ê¸€ì”¨ íš¨ê³¼ ì¶”ê°€
              const gpt2Title = gpt2Card.querySelector('h4');
              if (gpt2Title) {
                gpt2Title.classList.add('text-highlight');
                gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼ âœ¨';
              }
              console.log('âœ… GPT2 ì¹´ë“œ íš¨ê³¼ ì¶”ê°€ ì™„ë£Œ (í¬ê¸° ë³€í™” ì—†ìŒ)');
              
              // GPT3 ì‹œì‘ í›„ 4ë¶„ê¹Œì§€ íš¨ê³¼ ìœ ì§€ (GPT3 ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬)
              console.log('â° GPT2 ì¹´ë“œ íš¨ê³¼ ìœ ì§€ ì¤‘ (GPT3 ì‹œì‘ í›„ 4ë¶„ê¹Œì§€)');
            }
          }, 120000);
        }
      }, 200);
    }

    // GPT3 ëª¨ë“ˆë³„ ìˆœì°¨ ìŠ¤í¬ë¡¤ í•¨ìˆ˜
    function scrollToGpt3Module(moduleName) {
      const moduleMap = {
        'market': 'gpt3-market',
        'credit': 'gpt3-credit', 
        'alm': 'gpt3-alm',
        'global': 'gpt3-global',
        'creditpf': 'gpt3-creditpf'
      };
      
      const elementId = moduleMap[moduleName];
      if (elementId) {
        setTimeout(() => {
          scrollToElement(elementId);
          
          // í•´ë‹¹ ëª¨ë“ˆì— ê¹œë°•ì„ íš¨ê³¼ ì¶”ê°€
          const element = document.getElementById(elementId);
          if (element) {
            element.classList.add('card-blink', 'border-pulse', 'border-glow');
            
            // 2ì´ˆ í›„ íš¨ê³¼ ì œê±°
            setTimeout(() => {
              element.classList.remove('card-blink', 'border-pulse', 'border-glow');
            }, 2000);
          }
        }, 100);
        console.log(`ğŸ“œ GPT3 ${moduleName} ëª¨ë“ˆë¡œ ìŠ¤í¬ë¡¤ ë° íš¨ê³¼ ì ìš©`);
      }
    }

    // GPT3 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤í•˜ëŠ” í•¨ìˆ˜
    function scrollToGpt3Card() {
      setTimeout(() => {
        scrollToElement('card-gpt3');
        
        // GPT3 ì¹´ë“œì— ê¹œë°•ì„ íš¨ê³¼ ì¶”ê°€
        const gpt3Card = getAgentCard('gpt3');
        if (gpt3Card) {
          gpt3Card.classList.add('card-blink', 'border-pulse', 'border-glow');
          
          // GPT3 ì œëª©ì— ê¸€ì”¨ íš¨ê³¼ ì¶”ê°€
          const gpt3Title = gpt3Card.querySelector('h4');
          if (gpt3Title) {
            gpt3Title.classList.add('text-highlight');
            gpt3Title.textContent = 'GPT3 ë„ë©”ì¸ë³„ ë¦¬ìŠ¤í¬ ë¶„ì„ âœ¨';
          }
          
          // 3ì´ˆ í›„ íš¨ê³¼ ì œê±°
          setTimeout(() => {
            gpt3Card.classList.remove('card-blink', 'border-pulse', 'border-glow');
            if (gpt3Title) {
              gpt3Title.classList.remove('text-highlight');
              gpt3Title.textContent = 'GPT3 ë„ë©”ì¸ë³„ ë¦¬ìŠ¤í¬ ë¶„ì„';
            }
          }, 3000);
        }
      }, 100);
      console.log('ğŸ“œ GPT3 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤ ë° íš¨ê³¼ ì ìš©');
    }

    // GPT2 ì‹¤í–‰ ì‹œ íš¨ê³¼ ì ìš© í•¨ìˆ˜
    function applyGpt2ExecutionEffects() {
      console.log('ğŸš€ GPT2 ì‹¤í–‰ íš¨ê³¼ ì ìš© ì‹œì‘');
      
      const gpt2Card = getAgentCard('gpt2');
      if (gpt2Card) {
        // GPT2 ì¹´ë“œì— í¬ê¸° ë³€í™” ì—†ëŠ” ì‹¤í–‰ íš¨ê³¼ ì¶”ê°€
        gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
        
        // GPT2 ì œëª©ì— ê¸€ì”¨ íš¨ê³¼ ì¶”ê°€
        const gpt2Title = gpt2Card.querySelector('h4');
        if (gpt2Title) {
          gpt2Title.classList.add('text-highlight');
          gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼ ğŸš€';
        }
        
        // GPT2 ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
        setTimeout(() => {
          scrollToElement('card-gpt2');
          console.log('ğŸ“œ GPT2 ì‹¤í–‰ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤ ì™„ë£Œ');
        }, 500);
        
        // 4ì´ˆ í›„ íš¨ê³¼ ì œê±°
        setTimeout(() => {
          gpt2Card.classList.remove('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
          if (gpt2Title) {
            gpt2Title.classList.remove('text-highlight');
            gpt2Title.textContent = 'GPT2 í”„ë¡¬í”„íŠ¸ / ì¶œë ¥ë¬¼';
          }
          console.log('ğŸ‰ GPT2 ì‹¤í–‰ íš¨ê³¼ ì™„ë£Œ (í¬ê¸° ë³€í™” ì—†ìŒ)');
        }, 4000);
      }
    }

    // ==== F. textarea ìë™ ë†’ì´ í™•ì¥ ìœ í‹¸ ====
  function autoGrow(ids) {
    (ids || []).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight || 0) + 'px';
      if (!el.__autogrowBound) {
        el.addEventListener('input', () => {
          el.style.height = 'auto';
          el.style.height = (el.scrollHeight || 0) + 'px';
        });
        el.__autogrowBound = true;
      }
    });
  }
  
  // ì´ˆê¸° ëœë”ë§ ì‹œ í•œ ë²ˆ ì „ì²´ ì ìš©(ì‹¤í–‰/ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘)
  window.addEventListener('load', () => {
    autoGrow(['gpt1-output','gpt2-system','gpt2-output','gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf','gpt4-output']);  // ğŸ”¹ GPT4 ì¶œë ¥ textareaë„ ìë™ ë†’ì´ í™•ì¥
  });

  // === [ì¶”ê°€] Right íƒ­ ì „ì²´ ì¹´ë“œ ë…¸ì¶œ/í™•ì¥ ìœ í‹¸ ===
  function showAllRightCardsExpanded() {
    const panel = $rightPanel && $rightPanel();
    if (!panel) return;

    panel.classList.remove('solo-mode', 'gpt2worst-mode');
    panel.classList.add('show-all');

    ['gpt0','gpt1','gpt2','gpt3','gpt4'].forEach(id =>
      setAgentState(id, { expanded: true, active: true }) // expanded í´ë˜ìŠ¤ í† ê¸€
    );
  }
  </script>
</body>
</html>
