  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>?œì¥ì§€???¤íŠ¸?Œí¬ ?€?œë³´??/title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover" />
  <!-- Favicon 404 ?ëŸ¬ ë°©ì? -->
  <link rel="icon" href="data:,">
  <!-- ë¡œì»¬ ?¼ì´ë¸ŒëŸ¬ë¦??Œì¼ -->
  <script src="libs/chart.min.js" defer></script>
  <script src="libs/d3.v7.min.js" defer></script>
  <script src="libs/xlsx.full.min.js" defer></script>
  <!-- PDF.js (ë¸Œë¼?°ì? ??PDF ?ìŠ¤??ì¶”ì¶œ?? -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <!-- PPTX ?ì„± ?¼ì´ë¸ŒëŸ¬ë¦?(UMD ë¹Œë“œ) -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js" defer></script>
  <style>
    :root {
      --sidebar-width: 400px;
      --sidebar-bg: #f5f7fa;
      --main-bg: #fff;
      --main-text: #222;
      --accent: #4a90e2;
      --accent-hover: #0056b3;
      --border: #e0e0e0;
      --size-btn-bg: #4a90e2;
      --size-btn-hover: #0056b3;
      --size-display-bg: rgba(74, 144, 226, 0.1);
    }
    [data-theme="dark"] {
      --sidebar-bg: #23272f;
      --main-bg: #181a20;
      --main-text: #f5f5f5;
      --accent: #7ab7ff;
      --accent-hover: #5a9bff;
      --border: #333;
      --size-btn-bg: #7ab7ff;
      --size-btn-hover: #5a9bff;
      --size-display-bg: rgba(122, 183, 255, 0.1);
    }
    /* ?”¥ ìµœìƒ??ì»¨í…Œ?´ë„ˆ: viewportë¥?100% ì±„ìš°ê³??¬ë°± ?„ì „ ?œê±° */
    html { 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      height: 100vh; /* viewport ?’ì´ 100% */
      width: 100vw; /* viewport ?ˆë¹„ 100% */
      position: fixed; /* ?¤í¬ë¡??„ì „ ì°¨ë‹¨, ?”ë©´ ê³ ì • */
      box-sizing: border-box; /* padding/borderë¥?width/height???¬í•¨ */
    }
    body { 
      margin: 0; 
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: var(--main-bg); 
      color: var(--main-text); 
      transition: background 0.3s, color 0.3s; 
      overflow: hidden; 
      height: 100vh; /* viewport ?’ì´ 100% */
      width: 100vw; /* viewport ?ˆë¹„ 100% */
      position: fixed; /* ?¤í¬ë¡??„ì „ ì°¨ë‹¨ */
      box-sizing: border-box;
    }
    
    /* ëª¨ë“  ?”ì†Œ??box-sizing ?ìš©?˜ì—¬ ?¬ê¸° ê³„ì‚° ?¼ê????•ë³´ */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    /* ëª¨ë°”??ê°€ë¡œëª¨?œì—?œì˜ ê¸°ë³¸ ?°ì¹˜ ë°??¤í¬ë¡?ê°œì„  */
    @media screen and (orientation: landscape) and (max-height: 600px) {
      body { 
        -webkit-text-size-adjust: 100%; /* iOS Safari ?ìŠ¤???¬ê¸° ?ë™ ì¡°ì • ë°©ì? */
        -webkit-tap-highlight-color: transparent; /* ?°ì¹˜???˜ì´?¼ì´???œê±° */
      }
      
      .layout { 
        min-height: 100vh; 
        max-height: 100vh; /* ?”ë©´ ?’ì´ ?œí•œ */
      }
      
      /* ?¤íŠ¸?Œí¬ ê·¸ë˜???ì—­ ?°ì¹˜ ê°œì„  */
      #network-graph { 
        touch-action: manipulation; /* ?”ë¸”??ì¤?ë°©ì??˜ë©´?????ˆìš© */
      }
      
      #network-graph svg { 
        touch-action: none; /* SVG?ì„œ??ê¸°ë³¸ ?°ì¹˜ ?™ì‘ ì°¨ë‹¨?˜ê³  D3 ì¤Œì´ ì²˜ë¦¬ */
        pointer-events: all; /* ëª¨ë“  ?¬ì¸???´ë²¤???ˆìš© */
      }
    }
    
    /* ?“± ëª¨ë°”???¸ë¡œëª¨ë“œ: ??„ ?„ë˜ìª½ì— ë°°ì¹˜ */
    @media screen and (orientation: portrait) and (max-width: 900px) {
      .layout {
        flex-direction: column !important;
        height: 100vh !important;
        max-height: 100vh !important;
        overflow: hidden !important;
      }
      
      main { 
        order: 1 !important;
        flex: 1 !important;
        min-height: 0;
        overflow: hidden;
      }
      
      aside.sidebar-left { 
        display: none !important; /* ?¸ë¡œëª¨ë“œ?ì„œ???¼ìª½ ?¬ì´?œë°” ?¨ê? */
      }
      
      aside.sidebar-right { 
        order: 2 !important;
        width: 100vw !important;
        height: 70vh !important; /* ?”ë©´ ?’ì´??70% */
        max-height: 70vh !important;
        min-height: 320px !important;
        border-left: none !important;
        border-top: 2px solid var(--border) !important;
        position: relative !important;
        overflow-y: auto !important;
        flex-shrink: 0 !important;
      }
      
      /* ?¤íŠ¸?Œí¬ ê·¸ë˜???ì—­ ?•ì¥ */
      #network-graph { 
        width: 100% !important;
        height: 100% !important;
      }
      
      /* ???´ë? ?¨ë”© ì¡°ì • */
      aside.sidebar-right {
        padding: 8px 12px !important;
      }
      
      aside.sidebar-right h4 { 
        font-size: 14px !important; 
        margin: 6px 0 !important; 
      }
      
      aside.sidebar-right .agent-card { 
        padding: 8px !important; 
        margin-bottom: 8px !important; 
      }
      
      aside.sidebar-right textarea { 
        font-size: 12px !important; 
        min-height: 60px !important; 
      }
      
      /* ?“± ë¶„ì„?¤í–‰ ë²„íŠ¼ ?¬ê¸° ì¡°ì • (?¸ë¡œëª¨ë“œ??ê¸°ì¡´ ?¬ê¸° ? ì?) */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 12px 20px !important; /* ?½ê°„ ì¶•ì†Œ */
        font-size: 16px !important;
        font-weight: 700 !important;
        width: 85% !important;
        max-width: 100% !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(74,144,226,0.35) !important;
        line-height: 1.2 !important;
      }
      
      /* ?“± ë³´ê³ ?œë³´ê¸?ë²„íŠ¼ ?¬ê¸° ì¡°ì • (?„ë£Œ ???œì‹œ) */
      #btn-export-html {
        padding: 18px 30px !important;
        font-size: 18px !important;
        width: 85% !important;
        max-width: 100% !important;
      }
      
      /* ?“± ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?¬ê¸° ì¡°ì • */
      #btn-restart-pipeline {
        padding: 14px 28px !important;
        font-size: 15px !important;
        width: 75% !important;
        max-width: 100% !important;
      }
      
      /* ?“± ???¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡??„ì „???¨ê? (ê³µê°„ ì°¨ì? ?ˆí•¨) */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
      
      /* ?ë‹¨ ì»¨íŠ¸ë¡??ì—­ ?¬ë°± ?œê±° (ì»´íŒ©?¸í•˜ê²? */
      aside.sidebar-right > div:first-of-type {
        margin-bottom: 0 !important;
      }
      
      /* ë²„íŠ¼ ì»¨í…Œ?´ë„ˆ ?¬ë°± ?œê±° */
      aside.sidebar-right > div:first-of-type > div {
        margin-bottom: 0 !important;
      }
      
      /* ?íƒœ ë©”ì‹œì§€ ?¬ë°± ?œê±° */
      #send-status {
        margin-top: 4px !important;
        margin-bottom: 4px !important;
      }
    }
    
    /* ?°ìŠ¤?¬í†± ë°??œë¸”ë¦??¸ë¡œëª¨ë“œ (900px ì´ˆê³¼) */
    @media screen and (orientation: portrait) and (min-width: 901px) {
      main { order: initial; min-width: 0; }
      aside.sidebar-left { 
        order: initial; 
        display: block; /* ?¸ë¡œëª¨ë“œ?ì„œ???¼ìª½ ?¬ì´?œë°” ?œì‹œ */
      }
      aside.sidebar-right { order: initial; }
    }
    /* ?”¥ ë©”ì¸ ?ˆì´?„ì›ƒ: flex ê¸°ë°˜?¼ë¡œ viewportë¥??•í™•??100% ì±„ì? (?¬ë°± ?†ìŒ) */
    .layout { 
      display: flex; 
      flex-direction: row; /* ê°€ë¡?ë°©í–¥: ?¤íŠ¸?Œí¬ ê·¸ë˜???¼ìª½) + ?¬ì´?œë°”(?¤ë¥¸ìª? */
      width: 100vw; /* viewport ?ˆë¹„ 100% */
      height: 100vh; /* viewport ?’ì´ 100% */
      max-width: 100vw; 
      max-height: 100vh;
      margin: 0; /* ì¤‘ì•™ ?•ë ¬ ??ë¶ˆí•„?”í•œ ?¬ë°± ?œê±° */
      padding: 0; 
      overflow: hidden; /* ?”ë©´ ë°–ìœ¼ë¡??˜ì¹˜??ì½˜í…ì¸??¨ê? */
      position: relative; /* ?ì‹ ?”ì†Œ ?„ì¹˜ ?œì–´ */
      box-sizing: border-box;
    }
    /* ?”¥ ?¬ì´?œë°” ê³µí†µ ?¤í???*/
    aside.sidebar-left, aside.sidebar-right { 
      background: var(--sidebar-bg); 
      padding: 16px; 
      box-sizing: border-box; 
      border-right: 1px solid var(--border); 
      transition: background 0.3s; 
    }
    
    /* ?¼ìª½ ?¬ì´?œë°” (?°ìŠ¤?¬í†±?ì„œë§??œì‹œ) */
    aside.sidebar-left { 
      width: 380px; 
      min-width: 320px; 
    }
    
    /* ?”¥ ?¤ë¥¸ìª??¬ì´?œë°” (ê¸°ë³¸ ?¤í???- ?°ìŠ¤?¬í†±) */
    aside.sidebar-right { 
      flex: 0 0 auto; 
      width: var(--sidebar-width, 400px); 
      min-width: 250px;
      max-width: 800px;
      margin: 0;
      border-right: none; 
      border-left: 1px solid var(--border); 
      overflow-y: auto; 
      overflow-x: hidden; 
      overscroll-behavior: contain; 
      -webkit-overflow-scrolling: touch; 
      height: 100vh; 
      position: relative; 
      transition: width 0.2s ease;
      box-sizing: border-box;
      order: 2; /* flex order: ?¤ë¥¸ìª½ì— ?„ì¹˜ */
      display: flex;
      flex-direction: column;
    }

    /* ??ì¶”ê?: ?¤í–‰ì¤??˜ì´?¼ì´???Œì´?„ë¼???¨ê³„ ?œì„± ????ê°•ì¡°) */
    aside.sidebar-right .agent-card.running {
      outline: 2px solid var(--accent, #4FC3F7);
      box-shadow: 0 0 10px rgba(79,195,247,.7);
      transition: box-shadow .2s ease, outline-color .2s ease;
    }

    /* (ì°¸ê³ ) active?€ running??ë³‘í–‰ ?¬ìš©??ê²½ìš° ?œê° ê²¹ì¹¨ ë°©ì? */
    aside.sidebar-right .agent-card.active.running {
      outline-width: 3px;
    }

    /* ???°ì¸¡ ?¨ë„ "?¨ë… ?œì‹œ" ëª¨ë“œ: ?¤í–‰ì¤?ì¹´ë“œë§?ë³´ì´ê¸?*/
    .right-tab-panel.solo-mode .agent-card { 
      display: none !important;
    }
    .right-tab-panel.solo-mode .agent-card.running { 
      display: block !important;
    }



    /* ?ë‹¨ ì»¨íŠ¸ë¡??íƒœ/? íƒ ?•ë³´ ?±ì? ê³„ì† ?œì‹œ */
    .right-tab-panel.solo-mode .agent-controls,
    .right-tab-panel.solo-mode #send-status,
    .right-tab-panel.solo-mode [data-keep-visible="true"] {
      display: revert !important;
    }

    /* ???„ë£Œ ???„ì²´ ?„ê°œ(show-all) ?íƒœ?ì„œ??solo-mode ê°•ì œ ?¨ê???ë¬´ì‹œ */
    .right-tab-panel.show-all .agent-card {
      display: block !important;
    }

    /* GPT2 Worst ëª¨ë“œê°€ ?œì„±?”ë˜ë©?ëª¨ë“  ?¤ë¥¸ ëª¨ë“œë³´ë‹¤ ?°ì„  */
    .right-tab-panel.gpt2worst-mode .agent-card {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    .right-tab-panel.gpt2worst-mode .agent-card.gpt2worst-visible {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* GPT2 Worst ëª¨ë“œ?ì„œ show-all, solo-mode ??ëª¨ë“  ?¤ë¥¸ ?´ë˜??ë¬´ì‹œ */
    .right-tab-panel.gpt2worst-mode.show-all .agent-card:not(.gpt2worst-visible),
    .right-tab-panel.gpt2worst-mode.solo-mode .agent-card:not(.gpt2worst-visible) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* GPT1, GPT2 ì¹´ë“œ ê¹œë°•???¨ê³¼ */
    @keyframes cardBlink {
      0%, 100% { 
        opacity: 1; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid transparent;
      }
      50% { 
        opacity: 0.8; 
        box-shadow: 0 4px 16px rgba(122, 183, 255, 0.3);
        border: 2px solid var(--accent);
      }
    }

    .agent-card.card-blink {
      animation: cardBlink 1.5s ease-in-out infinite;
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }

    /* ?Œë????Œë‘ë¦??„ìŠ¤ ?¨ê³¼ */
    @keyframes borderPulse {
      0%, 100% {
        border: 2px solid transparent;
        box-shadow: 0 0 0 0 rgba(122, 183, 255, 0.7);
      }
      50% {
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 8px rgba(122, 183, 255, 0.3);
      }
    }

    .agent-card.border-pulse {
      animation: borderPulse 2s ease-in-out infinite;
      border-radius: 8px;
    }

    /* ê°•í•œ ?Œë????Œë‘ë¦?ê¸€ë¡œìš° ?¨ê³¼ */
    @keyframes borderGlow {
      0%, 100% {
        border: 3px solid transparent;
        box-shadow: 
          0 0 0 0 rgba(122, 183, 255, 0),
          inset 0 0 0 0 rgba(122, 183, 255, 0);
      }
      50% {
        border: 3px solid var(--accent);
        box-shadow: 
          0 0 20px rgba(122, 183, 255, 0.6),
          inset 0 0 10px rgba(122, 183, 255, 0.1);
      }
    }

    .agent-card.border-glow {
      animation: borderGlow 1.5s ease-in-out infinite;
      border-radius: 8px;
      position: relative;
    }

    /* ?Œë‘ë¦?ê·¸ë¼?°ì´???¨ê³¼ */
    @keyframes borderGradient {
      0% {
        border-image: linear-gradient(45deg, transparent, var(--accent), transparent) 1;
        border-width: 3px;
      }
      50% {
        border-image: linear-gradient(45deg, var(--accent), transparent, var(--accent)) 1;
        border-width: 3px;
      }
      100% {
        border-image: linear-gradient(45deg, transparent, var(--accent), transparent) 1;
        border-width: 3px;
      }
    }

    .agent-card.border-gradient {
      animation: borderGradient 3s ease-in-out infinite;
      border-radius: 8px;
    }

    /* GPT2 ì¹´ë“œ ?„í™˜ ?¨ê³¼ */
    @keyframes gpt2Transition {
      0% {
        opacity: 1;
        border: 3px solid transparent;
      }
      25% {
        opacity: 0.9;
        border: 3px solid var(--accent);
      }
      50% {
        opacity: 1;
        border: 3px solid var(--accent);
        box-shadow: 0 0 30px rgba(122, 183, 255, 0.8);
      }
      75% {
        opacity: 0.9;
        border: 3px solid var(--accent);
      }
      100% {
        opacity: 1;
        border: 3px solid transparent;
      }
    }

    .agent-card.gpt2-transition {
      animation: gpt2Transition 2s ease-in-out;
      border-radius: 8px;
    }

    /* ê¸€???€?´í•‘ ?¨ê³¼ */
    @keyframes typewriter {
      from { width: 0; }
      to { width: 100%; }
    }

    .typewriter-text {
      overflow: hidden;
      white-space: nowrap;
      animation: typewriter 2s steps(40, end);
      border-right: 2px solid var(--accent);
    }

    /* ê¸€???˜ì´?¼ì´???¨ê³¼ */
    @keyframes textHighlight {
      0% { 
        background: linear-gradient(90deg, transparent, rgba(122, 183, 255, 0.2), transparent);
        background-size: 200% 100%;
        background-position: -200% 0;
      }
      100% { 
        background: linear-gradient(90deg, transparent, rgba(122, 183, 255, 0.2), transparent);
        background-size: 200% 100%;
        background-position: 200% 0;
      }
    }

    .text-highlight {
      animation: textHighlight 2s ease-in-out infinite;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* ???„ë£Œ ???¤ë²„?ˆì´/ë¸”ë§??ê°•ì œ ?œê±°(?¹ì‹œ ?¨ì•„?ˆì„ ê²½ìš° ?œê° ??„ ë°©ì?) */
    .right-tab-panel.show-all .execution-overlay,
    .pipeline-complete .execution-overlay,
    .pipeline-complete .bordered-blinking,
    .pipeline-complete .bordered-blinking-edge {
      display: none !important;
    }

    /* ?Œì´?„ë¼???„ë£Œ ??ëª¨ë“  ?¤í–‰ ì¤??¨ê³¼ ê°•ì œ ì¢…ë£Œ */
    body.pipeline-complete .gpt3-module-box.running,
    body.pipeline-complete .gpt0-module-box.running,
    body.pipeline-complete .gpt1-module-box.running,
    body.pipeline-complete .gpt2-module-box.running,
    body.pipeline-complete .gpt4-module-box.running {
      animation: none !important;
      border-color: #2fc06e !important;
      box-shadow: 0 0 0 2px rgba(47, 192, 110, 0.25) !important;
    }

    /* ?Œì´?„ë¼???„ë£Œ ???¤í–‰ ì¤??¤ë²„?ˆì´ ê°•ì œ ?œê±° */
    body.pipeline-complete .execution-overlay {
      display: none !important;
    }

    /* ?Œì´?„ë¼???„ë£Œ ??ì§„í–‰ ?œì‹œ ?¨ê³¼ ê°•ì œ ?œê±° */
    body.pipeline-complete .progress-indicator {
      animation: none !important;
    }

    /* ?Œì´?„ë¼???„ë£Œ ??GPT3 ëª¨ë“ˆ ë°•ìŠ¤ ?¤í–‰ ì¤??¨ê³¼ ?„ì „ ?œê±° */
    body.pipeline-complete .gpt3-module-box {
      animation: none !important;
    }

    body.pipeline-complete .gpt3-module-box::before {
      animation: none !important;
      opacity: 1 !important;
      background: linear-gradient(90deg, #2fc06e, #27ae60) !important;
    }

    /* ì¹´ë“œ ?ˆì´?„ì›ƒ ê²¹ì¹¨/?´ë¦¬??ë°©ì? ë³´ê°• */
    .agent-card {
      position: relative;
      z-index: 0;
      margin-bottom: 12px;
      overflow: visible;        /* ???´ë? ?”ì†Œê°€ ?˜ë¦¬ì§€ ?Šë„ë¡?*/
      isolation: isolate;       /* ??ê°?ì¹´ë“œë³??¤íƒ ì»¨í…?¤íŠ¸ ë¶„ë¦¬ë¡??œê° ê²¹ì¹¨ ë°©ì? */
    }
    .agent-card + .agent-card {
      margin-top: 12px;
    }

    /* ?„ë£Œ ??show-all)?ëŠ” ?´ë–¤ ?¨ê? ê·œì¹™ë³´ë‹¤ ?°ì„  ?œì‹œ ë³´ì¥ */
    #gpt1-panel.show-all .agent-card,
    .right-tab-panel.show-all .agent-card { display: block !important; }

    /* ???µì»¤ ?ì²´???ˆì´?„ì›ƒ ?í–¥ ?œê±° */
    .gpt3-anchor, .gpt4-anchor {
      display: block;
      height: 0;
      margin: 0;
      padding: 0;
    }

    /* ???¬ê¸°???°ë¥¸ ë°˜ì‘???ìŠ¤???¬ê¸° */
    @media (min-width: 500px) {
      aside.sidebar-right h4 { font-size: 16px; }
      aside.sidebar-right .agent-card { padding: 16px; }
      aside.sidebar-right textarea { font-size: 14px; }
      aside.sidebar-right .copy-btn { font-size: 12px; padding: 6px 10px; }
      aside.sidebar-right .action-btn { font-size: 14px; padding: 10px 16px; }
      aside.sidebar-right .prompt-text { font-size: 13px; }
    }

    @media (min-width: 600px) {
      aside.sidebar-right h4 { font-size: 18px; }
      aside.sidebar-right .agent-card { padding: 18px; }
      aside.sidebar-right textarea { font-size: 16px; }
      aside.sidebar-right .copy-btn { font-size: 13px; padding: 7px 12px; }
      aside.sidebar-right .action-btn { font-size: 15px; padding: 12px 18px; }
      aside.sidebar-right .prompt-text { font-size: 14px; }
    }

    @media (min-width: 700px) {
      aside.sidebar-right h4 { font-size: 20px; }
      aside.sidebar-right .agent-card { padding: 20px; }
      aside.sidebar-right textarea { font-size: 18px; }
      aside.sidebar-right .copy-btn { font-size: 14px; padding: 8px 14px; }
      aside.sidebar-right .action-btn { font-size: 16px; padding: 14px 20px; }
      aside.sidebar-right .prompt-text { font-size: 15px; }
    }

    /* ?”¥ ëª¨ë°”??ê°€ë¡œëª¨??(600px ?´í•˜): 7:3 ë¹„ìœ¨ (ë©”ì¸ 70% / ?¬ì´?œë°” 30%) */
    @media screen and (orientation: landscape) and (max-width: 900px) and (max-height: 600px) {
      :root {
        --sidebar-width: 30vw; /* ?¬ì´?œë°” 30% ê³ ì • */
      }
      
      /* ?ˆì´?„ì›ƒ: viewportë¥??•í™•??100% ì±„ì? (?¬ë°± 0) */
      .layout {
        flex-direction: row !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        position: fixed !important; /* ?”ë©´ ê³ ì •?¼ë¡œ ?¤í¬ë¡??„ì „ ì°¨ë‹¨ */
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* ?¼ìª½ ?¬ì´?œë°” ?¨ê? */
      aside.sidebar-left { 
        display: none !important;
      }
      
      /* ?”¥ ë©”ì¸ ?ì—­: 70vw ê³ ì • (7:3 ë¹„ìœ¨??7) */
      main {
        order: 1 !important;
        flex: 0 0 70vw !important; /* flex-shrink: 0, flex-basis: 70vw (ê³ ì •) */
        width: 70vw !important; /* ?„ì²´ ?ˆë¹„??70% */
        max-width: 70vw !important;
        min-width: 0 !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ?”¥ ?¤ë¥¸ìª??¬ì´?œë°”: 30vw ê³ ì • (7:3 ë¹„ìœ¨??3) */
      aside.sidebar-right {
        order: 2 !important;
        flex: 0 0 30vw !important; /* flex-shrink: 0, flex-basis: 30vw (ê³ ì •) */
        width: 30vw !important; /* ?„ì²´ ?ˆë¹„??30% */
        max-width: 30vw !important;
        min-width: 0 !important; /* ?ˆë? ?¬ê¸°(px) ?œê±° */
        height: 100vh !important;
        margin: 0 !important;
        padding: 8px 12px !important;
        transform: translateX(0) !important;
        position: relative !important;
        z-index: 10 !important;
        display: flex !important;
        visibility: visible !important;
        border-left: 1px solid var(--border) !important;
        border-top: none !important;
        border-right: none !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ê°€ë¡œëª¨?œì—?œë„ ?¨ë„ ?¨ê?/?œì‹œ ?•ìƒ ?‘ë™ */
      aside.sidebar-right.hidden {
        transform: translateX(0) !important;
        pointer-events: auto !important;
        visibility: visible !important;
      }
      
      /* ???´ë? ?¨ë”© ì¡°ì • */
      aside.sidebar-right { 
        padding: 8px 12px !important;
        box-sizing: border-box;
      }
      
      /* ë²„íŠ¼ê³?ì»¨íŠ¸ë¡??¬ê¸° ì¡°ì • */
      .darkmode-toggle, .size-control-btn { 
        padding: 4px 8px; 
        font-size: 12px; 
        min-height: 32px; /* ?°ì¹˜?˜ê¸° ?ë‹¹???’ì´ */
      }
      
      /* ?°íŠ¸ ?¬ê¸° ì¡°ì • */
      aside.sidebar-right h4 { font-size: 14px; margin: 8px 0; }
      aside.sidebar-right .agent-card { padding: 8px; margin-bottom: 8px; }
      aside.sidebar-right textarea { font-size: 12px; min-height: 60px; }
      aside.sidebar-right .copy-btn { font-size: 10px; padding: 4px 6px; }
      aside.sidebar-right .action-btn { font-size: 12px; padding: 6px 10px; }
      aside.sidebar-right .prompt-text { font-size: 11px; line-height: 1.3; }
      
      /* ?”¥ ?¤íŠ¸?Œí¬ ê·¸ë˜?? ?¬ë°± ?„ì „ ?œê±°, ë¶€ëª¨ë? 100% ì±„ì? */
      #network-graph { 
        margin: 0 !important; /* ?¬ë°± ?„ì „ ?œê±° */
        padding: 0 !important;
        width: 100% !important; /* ë¶€ëª?main)???ˆë¹„ 100% */
        height: 100% !important; /* ë¶€ëª?main)???’ì´ 100% */
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important; /* border-radius ?œê±°ë¡?ê³µê°„ ?ˆì•½ */
        box-shadow: none !important; /* ê·¸ë¦¼???œê±° */
      }
      
      /* ?”¥ ?¤íŠ¸?Œí¬ ê·¸ë˜???´ë? SVG: transform ?œê±°, 100% ì±„ì? */
      #network-graph svg {
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        max-height: none !important;
        transform: none !important; /* transform scale ?œê±° */
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
      }
      
      /* ?”¥ ?ë‹¨ë°? ?¨ë”© ìµœì†Œ?”ë¡œ ê³µê°„ ?ˆì•½ */
      .topbar { 
        padding: 2px 6px !important;
        gap: 4px !important;
        min-height: 30px !important;
      }
      
      /* ?”¥ ëª¨ë°”??ê°€ë¡œëª¨?? ë¶„ì„?¤í–‰ ë²„íŠ¼ ?’ì´ 60%ë¡?ì¶•ì†Œ */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 9px 15px !important; /* 15px * 0.6 = 9px */
        font-size: 14px !important; /* ?‘ê²Œ ì¡°ì • */
        height: auto !important;
        min-height: 36px !important; /* ?°ì¹˜ ?ì—­ ?•ë³´ */
        line-height: 1.2 !important;
      }
      
      /* ?”¥ ???¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡??„ì „???¨ê? (ê°€ë¡œëª¨?? */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
      
      /* ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ ëª¨ë°”??ìµœì ??*/
      .scenario-node {
        stroke-width: 2px !important;
      }
      
      .scenario-group text {
        font-size: 14px !important;
        font-weight: 600 !important;
      }
      
      .keyword-node rect {
        stroke-width: 1.5px !important;
      }
      
      .keyword-node text {
        font-size: 11px !important;
        font-weight: 500 !important;
      }
      
      /* ?ë‹¨ ì»¨íŠ¸ë¡??ì—­ ?•ì¶• */
      .topbar { padding: 6px 12px; }
      
      /* ???¬ê¸° ì»¨íŠ¸ë¡??ì—­ ì¡°ì • */
      #tab-size-display { font-size: 12px; min-width: 50px; }
      
      /* ?¤í¬ë¡¤ë°” ?¤í??¼ë§ (ëª¨ë°”?¼ì—?????‡ê²Œ) */
      aside.sidebar-right::-webkit-scrollbar { width: 6px; }
      aside.sidebar-right::-webkit-scrollbar-track { background: transparent; }
      aside.sidebar-right::-webkit-scrollbar-thumb { 
        background: rgba(0,0,0,0.2); 
        border-radius: 3px; 
      }
    }

    /* ?”¥ ë§¤ìš° ?‘ì? ?”ë©´ ê°€ë¡œëª¨??(500px ?´í•˜): 7:3 ë¹„ìœ¨ ? ì? (ë©”ì¸ 70% / ?¬ì´?œë°” 30%) */
    @media screen and (orientation: landscape) and (max-width: 900px) and (max-height: 500px) {
      :root {
        --sidebar-width: 30vw; /* ?¬ì´?œë°” 30% ê³ ì • (7:3 ë¹„ìœ¨) */
      }
      
      /* ?”¥ ë©”ì¸ ?ì—­: 70vw ê³ ì • (7:3 ë¹„ìœ¨??7) */
      main {
        flex: 0 0 70vw !important; /* flex-shrink: 0, flex-basis: 70vw (ê³ ì •) */
        width: 70vw !important; /* ?„ì²´ ?ˆë¹„??70% */
        max-width: 70vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ?”¥ ?¬ì´?œë°”: 30vw ê³ ì • (7:3 ë¹„ìœ¨??3) */
      aside.sidebar-right { 
        flex: 0 0 30vw !important; /* flex-shrink: 0, flex-basis: 30vw (ê³ ì •) */
        width: 30vw !important; /* ?„ì²´ ?ˆë¹„??30% */
        max-width: 30vw !important;
        min-width: 0 !important; /* ?ˆë? ?¬ê¸°(px) ?œê±° */
        padding: 4px 6px !important;
        margin: 0 !important;
        height: 100vh !important;
        box-sizing: border-box !important;
      }
      
      /* ???‘ì? ?°íŠ¸?€ ê°„ê²© */
      aside.sidebar-right h4 { font-size: 12px; margin: 6px 0; }
      aside.sidebar-right .agent-card { padding: 6px; margin-bottom: 6px; }
      aside.sidebar-right textarea { font-size: 11px; min-height: 50px; }
      .darkmode-toggle, .size-control-btn { 
        padding: 3px 6px; 
        font-size: 11px; 
        min-height: 28px; 
      }
      
      /* ë¦¬ìŠ¤?¸ì? ?ìŠ¤??ê°„ê²© ì¤„ì„ */
      #selected-indicators-list { font-size: 10px; margin: 0; padding-left: 12px; }
      .prompt-text { font-size: 10px; line-height: 1.2; }
      
      /* ë²„íŠ¼ ê·¸ë£¹ ê°„ê²© ì¤„ì„ */
      div[style*="display:flex"] { gap: 4px !important; }
      
      /* ?”¥ ?¤íŠ¸?Œí¬ ê·¸ë˜?? ?¬ë°± ?„ì „ ?œê±° */
      #network-graph { 
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
      }
      
      /* ?”¥ ?ë‹¨ë°? ?¨ë”© ìµœì†Œ??*/
      .topbar { 
        padding: 2px 4px !important;
        gap: 3px !important;
        min-height: 26px !important;
      }
      
      /* ?”¥ ëª¨ë°”??ê°€ë¡œëª¨??(?‘ì? ?”ë©´): ë¶„ì„?¤í–‰ ë²„íŠ¼ ?’ì´ 60%ë¡?ì¶•ì†Œ */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 8px 12px !important; /* ???‘ê²Œ */
        font-size: 13px !important;
        height: auto !important;
        min-height: 32px !important;
        line-height: 1.2 !important;
      }
      
      /* ?”¥ ???¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡??„ì „???¨ê? */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
      
      /* ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ ?‘ì? ?”ë©´ ìµœì ??*/
      .scenario-node {
        stroke-width: 2.5px !important;
      }
      
      .scenario-group text {
        font-size: 13px !important;
        font-weight: 700 !important;
      }
      
      .keyword-node rect {
        stroke-width: 2px !important;
      }
      
      .keyword-node text {
        font-size: 10px !important;
        font-weight: 600 !important;
      }
      
      /* ?°ì¹˜ ìµœì ??- ëª¨ë“  ?´ë¦­ ê°€?¥í•œ ?”ì†Œ??ì¶©ë¶„???°ì¹˜ ?ì—­ ?•ë³´ */
      button, select, input, textarea { 
        min-height: 28px; 
        touch-action: manipulation; /* ?”ë¸”??ì¤?ë°©ì? */
      }
      
      /* ëª¨ë°”?¼ì—???¤í¬ë¡??±ëŠ¥ ?¥ìƒ */
      aside.sidebar-right { 
        -webkit-overflow-scrolling: touch; 
        scroll-behavior: smooth; 
        touch-action: pan-y; /* ?¸ë¡œ ?¤í¬ë¡¤ë§Œ ?ˆìš© */
      }
      
      /* ?ìŠ¤??? íƒ ìµœì ??*/
      .prompt-text, textarea { 
        -webkit-user-select: text; 
        user-select: text; 
      }
      
      /* ?¬ì´?œë°” ?¨ê?/ë³´ì„ ? ê????„í•œ ëª¨ë°”??ìµœì ??*/
      .sidebar-hidden aside.sidebar-right { 
        transform: translateX(100%); 
        transition: transform 0.3s ease; 
      }
      
      .sidebar-hidden main { 
        margin-right: 0; 
      }
      
      /* ëª¨ë°”?¼ì—???¤ë²„?Œë¡œ???¤í¬ë¡?ê°œì„  */
      aside.sidebar-right { 
        overflow-x: hidden; 
        overflow-y: auto; 
        overscroll-behavior-y: contain; /* ?¤í¬ë¡?ë°”ìš´??ë°©ì? */
      }
    }

    /* ?”¥ ???”ë©´ ê°€ë¡œëª¨??(?œë¸”ë¦? 900px ?´ìƒ): 7:3 ë¹„ìœ¨ (ë©”ì¸ 70% / ?¬ì´?œë°” 30%) */
    @media screen and (orientation: landscape) and (min-width: 900px) and (max-height: 600px) {
      :root {
        --sidebar-width: 30vw; /* ?¬ì´?œë°” 30% ê³ ì • (7:3 ë¹„ìœ¨) */
      }
      
      /* ?ˆì´?„ì›ƒ: viewportë¥?100% ì±„ì? */
      .layout {
        flex-direction: row !important;
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
      }
      
      /* ?¼ìª½ ?¬ì´?œë°” ?¨ê? */
      aside.sidebar-left { 
        display: none !important;
      }
      
      /* ?”¥ ë©”ì¸ ?ì—­: 70vw ê³ ì • (7:3 ë¹„ìœ¨??7) */
      main {
        order: 1 !important;
        flex: 0 0 70vw !important; /* flex-shrink: 0, flex-basis: 70vw (ê³ ì •) */
        width: 70vw !important; /* ?„ì²´ ?ˆë¹„??70% */
        max-width: 70vw !important;
        min-width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ?”¥ ?¤ë¥¸ìª??¬ì´?œë°”: 30vw ê³ ì • (7:3 ë¹„ìœ¨??3) */
      aside.sidebar-right {
        order: 2 !important;
        flex: 0 0 30vw !important; /* flex-shrink: 0, flex-basis: 30vw (ê³ ì •) */
        width: 30vw !important; /* ?„ì²´ ?ˆë¹„??30% */
        max-width: 30vw !important;
        min-width: 0 !important; /* ?ˆë? ?¬ê¸°(px) ?œê±° */
        height: 100vh !important;
        margin: 0 !important;
        padding: 12px 16px !important;
        transform: translateX(0) !important;
        position: relative !important;
        z-index: 10 !important;
        display: flex !important;
        visibility: visible !important;
        border-left: 1px solid var(--border) !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      /* ?¨ë„ ?¨ê? ?íƒœ */
      aside.sidebar-right.hidden {
        transform: translateX(100%) !important;
        pointer-events: none !important;
      }
      
      /* ?œë¸”ë¦¿ì—?œëŠ” ?°íŠ¸ë¥?ì¡°ê¸ˆ ???¬ê²Œ */
      aside.sidebar-right h4 { font-size: 16px; }
      aside.sidebar-right .agent-card { padding: 12px; }
      aside.sidebar-right textarea { font-size: 14px; }
      .darkmode-toggle, .size-control-btn { 
        padding: 6px 12px; 
        font-size: 13px; 
        min-height: 36px; 
      }
      
      /* ?”¥ ?œë¸”ë¦?ê°€ë¡œëª¨?? ë¶„ì„?¤í–‰ ë²„íŠ¼ ?¬ê¸° ì¡°ì • */
      #top-pipeline-btn,
      .analysis-start-btn {
        padding: 10px 18px !important;
        font-size: 15px !important;
        min-height: 40px !important;
        line-height: 1.2 !important;
      }
      
      /* ?”¥ ???¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡??¨ê? */
      #tab-size-control-container {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        position: absolute !important;
        left: -9999px !important;
      }
      
      #tab-size-control-container * {
        display: none !important;
      }
    }

    /* +/- ë²„íŠ¼ ?„ìš© ?¤í???*/
    .size-control-btn {
      background: var(--size-btn-bg);
      color: white;
      border: 2px solid var(--size-btn-bg);
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .size-control-btn:hover {
      background: var(--size-btn-hover);
      border-color: var(--size-btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .size-control-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .size-display {
      background: var(--size-display-bg);
      border: 1px solid var(--accent);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: 'Courier New', monospace;
    }
    
    /* ?”¥ ë³µì‚¬ ë²„íŠ¼ ê¸°ë³¸ ?¤í???(?¤í¬ëª¨ë“œ ?í–¥ ë°›ì? ?ŠìŒ) */
    .copy-btn {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      padding: 4px 8px;
      font-size: 11px;
    }
    
    .copy-btn:hover {
      background: linear-gradient(135deg, #357abd, #2c5d9f);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(74,144,226,0.3);
    }
    
    .copy-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(74,144,226,0.2);
    }
    
    /* ?”¥ ë¶„ì„?¤í–‰ ë²„íŠ¼ ê¸°ë³¸ ?¤í???(?°ìŠ¤?¬í†±) */
    #top-pipeline-btn,
    .analysis-start-btn {
      padding: 15px 25px;
      font-size: 16px;
    }
    /* ?”¥ ë©”ì¸ ?ì—­: ?¨ì? ê³µê°„??ëª¨ë‘ ì°¨ì??˜ë„ë¡?flex: 1 ?¤ì • (?¬ë°± 0) */
    main { 
      flex: 1 1 0; /* flex-grow: 1, flex-shrink: 1, flex-basis: 0 - ?¨ì? ê³µê°„ ëª¨ë‘ ì°¨ì? */
      display: flex; 
      flex-direction: column; 
      background: var(--main-bg); 
      min-width: 0; /* flex ?„ì´?œì´ ì»¨í…ì¸??¬ê¸°ë³´ë‹¤ ?‘ì•„ì§????ˆë„ë¡?*/
      overflow: hidden; 
      order: 1; /* flex order: ë©”ì¸??ë¨¼ì? */
      margin: 0; /* ?¬ë°± ?„ì „ ?œê±° */
      padding: 0;
      height: 100%; /* ë¶€ëª?.layout)???’ì´ 100% ?¬ìš© */
      box-sizing: border-box;
    }
    
    .topbar { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 6px 12px; 
      border-bottom: 1px solid var(--border); 
      background: var(--sidebar-bg); 
      flex-shrink: 0; /* topbar??ê³ ì • ?’ì´ ? ì? */
    }
    .topbar select { margin-left: 12px; }
    .darkmode-toggle { background: none; color: var(--accent); border: 1px solid var(--accent); border-radius: 4px; padding: 6px 14px; cursor: pointer; }
    
    /* ?”¥ ?¤íŠ¸?Œí¬ ê·¸ë˜??ì»¨í…Œ?´ë„ˆ: ë¶€ëª?main)ë¥??„ì „??ì±„ì? (?¬ë°± ìµœì†Œ?? */
    #network-graph { 
      flex: 1 1 0; /* ?¨ì? ê³µê°„??ëª¨ë‘ ì°¨ì? */
      background: var(--main-bg); 
      border-radius: 0; /* ëª¨ë°”?¼ì—??border-radius ?œê±°ë¡?ê³µê°„ ?ˆì•½ */
      margin: 0; /* ?¬ë°± ?„ì „ ?œê±° */
      padding: 0;
      box-shadow: none; /* ê·¸ë¦¼???œê±°ë¡?ê³µê°„ ?ˆì•½ */
      position: relative; 
      overflow: hidden; 
      width: 100%; /* ë¶€ëª¨ì˜ ?ˆë¹„ 100% */
      height: 100%; /* ë¶€ëª¨ì˜ ?’ì´ 100% */
      max-width: none; /* ìµœë? ?¬ê¸° ?œí•œ ?œê±° */
      max-height: none;
      box-sizing: border-box;
    }
    
    /* ?”¥ ?¤íŠ¸?Œí¬ ê·¸ë˜???´ë? SVG: ì»¨í…Œ?´ë„ˆë¥??„ì „??ì±„ì? */
    #network-graph svg {
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    /* ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?¸ë²„ ?¨ê³¼ */
    .scenario-node {
      transition: all 0.3s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    .scenario-node:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2));
    }
    
    /* ?œë‚˜ë¦¬ì˜¤?´ìš© ë²„íŠ¼ ?¸ë²„ ?¨ê³¼ */
    .scenario-doc-btn rect {
      transition: all 0.2s ease;
    }
    .scenario-doc-btn:hover rect {
      opacity: 1 !important;
      filter: brightness(1.1);
    }

    /* ?“± ëª¨ë°”??ì´ˆê¸° ëª¨ë“œ: GPT0ë§??œì‹œ (?¸ë¡œ/ê°€ë¡?ê³µí†µ) */
    @media screen and (max-width: 900px) {
      aside.sidebar-right.mobile-initial-mode .agent-card {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }
      
      aside.sidebar-right.mobile-initial-mode .agent-card#card-gpt0 {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* ë¶„ì„ ?œì‘ ??ëª¨ë“  ì¹´ë“œ ?œì‹œ */
      aside.sidebar-right.show-all .agent-card {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* ?¸ë¡œ ëª¨ë“œ ì¶”ê? ?¤í???*/
      @media (orientation: portrait) {
        /* ??´ ?„ë˜ìª½ì— ?ˆì„ ???¤í¬ë¡¤ë°” ?¤í???*/
        aside.sidebar-right::-webkit-scrollbar { 
          width: 4px; 
          height: 4px; 
        }
        aside.sidebar-right::-webkit-scrollbar-thumb { 
          background: rgba(0,0,0,0.3); 
          border-radius: 2px; 
        }
      }
      
      /* ê°€ë¡?ëª¨ë“œ ì¶”ê? ?¤í???*/
      @media (orientation: landscape) {
        /* ??´ ?¤ë¥¸ìª½ì— ?ˆì„ ???¤í¬ë¡¤ë°” ?¤í???*/
        aside.sidebar-right::-webkit-scrollbar { 
          width: 6px; 
        }
        aside.sidebar-right::-webkit-scrollbar-thumb { 
          background: rgba(0,0,0,0.3); 
          border-radius: 3px; 
        }
      }
    }
      /* ?¤ì›Œ???¸ë“œ ?¤í???*/
      .keyword-node rect { fill: #3a3d44; stroke: #c3c8d0; stroke-width: 1.6; rx: 9; ry: 9; }
      .keyword-node:hover rect { filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); }
      .keyword-node rect:hover { filter: drop-shadow(0 4px 10px rgba(0,0,0,0.3)); }
      /* Phase ê¹œë°•???¨ê³¼ (ë°•ìŠ¤ ?´ë???ê°•ì¡°) */
      .keyword-node.kw-blink-yellow rect { stroke: #FFD54F; animation: kwBlinkYellow 1.4s ease-in-out infinite; }
      .keyword-node.kw-blink-yellow text { fill: #FFE082; }
      .keyword-node.kw-blink-red rect { stroke: #E53935; animation: kwBlinkRed 1.4s ease-in-out infinite; }
      .keyword-node.kw-blink-red text { fill: #FF8A80; }
      @keyframes kwBlinkYellow { 0%, 100% { filter: drop-shadow(0 0 0 rgba(255, 235, 59, 0)); fill: #3a3d44; } 50% { filter: drop-shadow(0 0 10px rgba(255, 235, 59, 0.95)); fill: rgba(255, 235, 59, 0.18); } }
      @keyframes kwBlinkRed { 0%, 100% { filter: drop-shadow(0 0 0 rgba(229, 57, 53, 0)); fill: #3a3d44; } 50% { filter: drop-shadow(0 0 10px rgba(229, 57, 53, 0.95)); fill: rgba(229, 57, 53, 0.18); } }
      .keyword-node text { fill: var(--main-text); font-size: 13px; pointer-events: none; text-anchor: middle; dominant-baseline: middle; }
      /* ?¤ì›Œ???°ê²°??? ë‹ˆë©”ì´??(?ì„  ?´ë™ ?¨ê³¼) */
      .kw-animated { stroke-dasharray: 6 6; animation: kw-dash-move 2.5s linear infinite; }
      @keyframes kw-dash-move { to { stroke-dashoffset: -60; } }
    
    /* ?°ê²°???¸ë²„ ?¨ê³¼ */
    .connection-line {
      transition: all 0.2s ease;
    }
    .connection-line:hover {
      stroke-width: 12 !important;
      stroke-opacity: 1 !important;
    }
    
    /* PDF ëª¨ë‹¬ ?¤í???*/
    .pdf-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    
    .pdf-modal.show {
      display: flex;
    }
    
    .pdf-container {
      width: 90%;
      height: 90%;
      max-width: 1200px;
      max-height: 800px;
      background: var(--main-bg);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      transform: scale(0.7) translateY(50px);
      animation: modalSlideIn 0.4s ease forwards;
    }
    /* ?´ìŠ¤ ëª¨ë‹¬?€ 80% ë¹„ìœ¨ ?ìš© */
    #news-modal .pdf-container { width: 80%; height: 80%; }
    
    .pdf-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: var(--sidebar-bg);
      border-radius: 12px 12px 0 0;
    }
    
    .pdf-title {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--main-text);
    }
    
    .pdf-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--main-text);
      padding: 5px 10px;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .pdf-close:hover {
      background: var(--border);
    }
    
    .pdf-frame {
      width: 100%;
      height: calc(100% - 80px);
      border: none;
      border-radius: 0 0 12px 12px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes modalSlideIn {
      to {
        transform: scale(1) translateY(0);
      }
    }
    /* ?¤ì›Œ???´íŒ */
    .kw-tooltip {
      position: fixed;
      z-index: 2000;
      background: rgba(32, 32, 32, 0.95);
      color: #fff;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 6px;
      pointer-events: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      max-width: 420px;
      line-height: 1.4;
      display: none;
    }
    .indicator-cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      justify-items: center;
      align-content: center;
      min-height: 60vh;
    }
    .indicator-card {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      margin: 8px auto;
    }
    .indicator-card.selected, .indicator-card:hover {
      border: 2px solid var(--accent);
      transform: scale(1.2);
      box-shadow: 0 2px 8px rgba(74,144,226,0.3);
    }
    .indicator-tooltip {
      position: absolute;
      bottom: 35px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--main-text);
      color: var(--main-bg);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    .indicator-card:hover .indicator-tooltip {
      opacity: 1;
    }
    .impact-box {
      width: 120px;
      height: 60px;
      padding: 10px 0;
      text-align: center;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: border 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .impact-box.selected {
      border: 2px solid var(--accent);
    }
    @media (max-width: 1024px) { .layout { flex-direction: column; } aside.sidebar-left, aside.sidebar-right { width: 100%; border: none; } main { min-width: 100vw; } .topbar { flex-direction: column; align-items: stretch; } }
    @media (max-width: 700px) { .layout { flex-direction: column; } aside.sidebar-left, aside.sidebar-right { width: 100%; } #network-graph { min-height: 250px; } }

    /* ?ì´?„íŠ¸ ì¹´ë“œ & ?„ë¡¬?„íŠ¸ ?œì•ˆ ?¤í???- ?µì¼???”ì??*/
    .agent-card { 
      border: 2px solid var(--border); 
      border-radius: 12px; 
      padding: 16px; 
      margin-bottom: 16px; 
      transition: all 0.3s ease; 
      background: var(--main-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      overflow: visible;
    }
    
    /* ì¹´ë“œ ?ë‹¨ ê·¸ë¼?°ì´??ë°?*/
    .agent-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .agent-card.active { 
      border-color: var(--accent); 
      box-shadow: 0 8px 32px rgba(74,144,226,0.2), 0 0 0 1px rgba(74,144,226,0.1); 
      transform: translateY(-2px);
    }
    .agent-card.active::before {
      opacity: 1;
    }
    
    .agent-card h4 { 
      margin: 0 0 12px 0; 
      font-size: 16px; 
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ì¹´ë“œ ì§„í–‰ ?íƒœ ?¨ê³¼ - ?µì¼???¤í???*/
    .agent-card.running { 
      border-color: var(--accent); 
      box-shadow: 0 0 0 3px rgba(122,183,255,0.2), 0 8px 32px rgba(122,183,255,0.15); 
      animation: borderPulseBlue 1.5s ease-in-out infinite;
      transform: translateY(-1px);
    }
    .agent-card.running::before {
      opacity: 1;
      animation: topBarPulse 1.5s ease-in-out infinite;
    }
    
    .agent-card.done { 
      border-color: #2fc06e; 
      box-shadow: 0 0 0 3px rgba(47,192,110,0.2), 0 8px 32px rgba(47,192,110,0.15); 
      transform: translateY(-1px);
    }
    .agent-card.done::before {
      opacity: 1;
      background: linear-gradient(90deg, #2fc06e, #27ae60);
    }

    @keyframes borderPulseBlue {
      0% { box-shadow: 0 0 0 0 rgba(122,183,255,0.65), 0 10px 26px rgba(122,183,255,0.18); }
      70% { box-shadow: 0 0 0 8px rgba(122,183,255,0), 0 6px 18px rgba(122,183,255,0.10); }
      100% { box-shadow: 0 0 0 0 rgba(122,183,255,0), 0 10px 26px rgba(122,183,255,0.18); }
    }
    
    @keyframes topBarPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ì§„í–‰ ì¤?ì¹´ë“œ ?€?´í? ?¤ì´???¨ê³¼ */
    .agent-card.running h4 {
      background: linear-gradient(90deg, #888 0%, #fff 50%, #888 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: titleShine 1.2s linear infinite;
    }
    @keyframes titleShine { 0% { background-position: 200% 0; } 100% { background-position: 0 0; } }

    /* ì§„í–‰ ë¬¸êµ¬(?°ì¸¡ ?ë‹¨) ?˜ì???ë¹??´ë™ ?¨ê³¼ */
    #gpt1-panel #send-status.status-shine {
      background: linear-gradient(90deg, var(--main-text) 0%, #ffffff 50%, var(--main-text) 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: statusShine 1.2s linear infinite;
      font-weight: 600;
    }
    @keyframes statusShine { 0% { background-position: 200% 0; } 100% { background-position: 0 0; } }

    /* ?°ì¸¡ ?¨ë„ ?ë™ ?¤í¬ë¡?ë¶€?œëŸ½ê²?*/
    #gpt1-panel { scroll-behavior: smooth; }

    /* ?¤ë¥¸ìª???ë¦¬ì‚¬?´ì¦ˆ ?¸ë“¤ ?¤í???- ?œê±°??*/
    /* ?œë˜ê·?ë¦¬ì‚¬?´ì¦ˆ ê¸°ëŠ¥???œê±°?˜ì–´ ê´€???¤í??¼ë„ ?œê±° */

    /* PPT ì¶œë ¥ CTA ê°•ì¡° */
    #btn-export-ppt.ppt-cta {
      position: relative;
      animation: ctaPulse 1.2s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(44,123,229,0.45);
      border-color: #2C7BE5 !important;
      color: #fff !important;
      background: #2C7BE5 !important;
    }
    #btn-export-ppt.ppt-cta::after {
      content: ' ???¬ê¸°??PPT ?‘ì„±';
      position: absolute; right: 100%; top: 50%; transform: translateY(-50%);
      color: var(--accent); font-size: 12px; white-space: nowrap; margin-right: 8px;
    }
    @keyframes ctaPulse {
      0% { box-shadow: 0 0 0 0 rgba(44,123,229,0.45); }
      70% { box-shadow: 0 0 0 10px rgba(44,123,229,0); }
      100% { box-shadow: 0 0 0 0 rgba(44,123,229,0); }
    }
    .prompt-suggestion { display:none; border: 1px dashed var(--accent); background: rgba(122,183,255,0.08); padding: 8px; border-radius: 8px; font-size: 12px; line-height: 1.5; margin-bottom: 10px; }
    .prompt-suggestion.show { display:block; animation: fadeIn 0.25s ease; }

    /* ë§í’??ë²„ë¸” ?œê±° */

    /* ??ì¶”ê?: ëª¨ë“  ?¨ê³„ ê³µí†µ ?•ì¥ ?´ë˜??*/
    .output-panel.expanded {
      max-height: none !important;
      height: auto !important;
      overflow: visible !important;
    }

    /* (? íƒ) details/summary ê¸°ë°˜?´ë©´ open ?ì„±???€??ë³´ì • */
    details.output-panel[open] {
      max-height: none !important;
    }

    /* ?¬ì´???¨ë„ ?œë˜ê·??¤í¬ë¡?UX */
    #gpt1-panel { cursor: default; overflow-x: hidden; }
    #gpt1-panel.drag-scroll { cursor: grab; }
    #gpt1-panel.drag-scrolling { cursor: grabbing; user-select: none; }
    
    /* ?°ì¸¡ ?¨ë„ ?¨ê?/?œì‹œ ?„í™˜ ? ë‹ˆë©”ì´??*/
    .sidebar-right { 
      transition: transform 0.25s ease; 
      position: relative;
      transform: translateX(0); /* ê¸°ë³¸ ?íƒœ?ì„œ???”ë©´???œì‹œ */
    }
    
    .sidebar-right.hidden { 
      transform: translateX(100%); 
      pointer-events: none;
    }
    
    /* ?°ì¸¡ ?¨ë„???¨ê²¨ì¡Œì„ ??ë©”ì¸ ?ì—­ ?„ì²´ ?¬ìš© */
    .layout.panel-hidden main {
      flex: 1;
      margin-right: 0;
    }

    /* ?Œì´?„ë¼???¼ì¸ ? ë‹ˆë©”ì´??(ë°©í–¥ê°?+ ì§„í–‰ ?œì‹œ) */
    .pipeline-line { 
      stroke-linecap: round; 
      stroke-dasharray: 8 8; /* ? ë‹ˆë©”ì´?˜ì„ ?„í•œ ê¸°ë³¸ dasharray ì¶”ê? */
    }
    @keyframes dash-move { to { stroke-dashoffset: -20; } }
    .pipeline-line.flow { animation: dash-move 0.8s linear infinite; filter: drop-shadow(0 0 6px rgba(122,183,255,0.8)); stroke-width: 7 !important; }

    /* GPT0 ëª¨ë“ˆ ë°•ìŠ¤ ?¤í???- ?µì¼???”ì??*/
    .gpt0-module-box {
      background: var(--main-bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .gpt0-module-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .gpt0-module-box:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px rgba(74, 144, 226, 0.2), 0 0 0 1px rgba(74, 144, 226, 0.1);
      transform: translateY(-2px);
    }

    .gpt0-module-box:hover::before {
      opacity: 1;
    }

    /* GPT0 ëª¨ë“ˆ ?¤í–‰ ì¤??¨ê³¼ */
    .gpt0-module-box.running {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25), 0 8px 32px rgba(74, 144, 226, 0.15);
      animation: gpt0Running 1.5s ease-in-out infinite;
      transform: translateY(-1px);
    }

    .gpt0-module-box.running::before {
      opacity: 1;
      animation: gpt0TopBar 1.5s ease-in-out infinite;
    }

    @keyframes gpt0Running {
      0%, 100% { 
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.25), 0 4px 12px rgba(74, 144, 226, 0.15);
      }
      50% { 
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.4), 0 6px 16px rgba(74, 144, 226, 0.25);
      }
    }

    @keyframes gpt0TopBar {
      0%, 100% { 
        background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      }
      50% { 
        background: linear-gradient(90deg, var(--accent-hover), var(--accent));
      }
    }

    /* ëª¨ë“ˆ ë°•ìŠ¤ ?„ë£Œ(ê³µí†µ) */
    .gpt0-module-box.done,
    .gpt1-module-box.done,
    .gpt2-module-box.done,
    .gpt3-module-box.done,
    .gpt4-module-box.done {
      border-color: #2fc06e;
      box-shadow: 0 0 0 2px rgba(47, 192, 110, 0.25);
    }

    .gpt0-module-box.done::before,
    .gpt1-module-box.done::before,
    .gpt2-module-box.done::before,
    .gpt3-module-box.done::before,
    .gpt4-module-box.done::before {
      opacity: 1;
      background: linear-gradient(90deg, #2fc06e, #27ae60);
    }

    /* GPT1~4 ëª¨ë“ˆ ë°•ìŠ¤ ê¸°ë³¸ ?¤í???- ?µì¼???”ì??*/
    .gpt1-module-box,
    .gpt2-module-box,
    .gpt3-module-box,
    .gpt4-module-box {
      background: var(--main-bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .gpt1-module-box::before,
    .gpt2-module-box::before,
    .gpt3-module-box::before,
    .gpt4-module-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .gpt1-module-box:hover,
    .gpt2-module-box:hover,
    .gpt3-module-box:hover,
    .gpt4-module-box:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 32px rgba(74, 144, 226, 0.2), 0 0 0 1px rgba(74, 144, 226, 0.1);
      transform: translateY(-2px);
    }

    .gpt1-module-box:hover::before,
    .gpt2-module-box:hover::before,
    .gpt3-module-box:hover::before,
    .gpt4-module-box:hover::before {
      opacity: 1;
    }

    /* GPT1~4 ëª¨ë“ˆ ?¤í–‰ ì¤??¨ê³¼ */
    .gpt1-module-box.running,
    .gpt2-module-box.running,
    .gpt3-module-box.running,
    .gpt4-module-box.running {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25), 0 8px 32px rgba(74, 144, 226, 0.15);
      animation: gpt0Running 1.5s ease-in-out infinite;
      transform: translateY(-1px);
    }

    .gpt1-module-box.running::before,
    .gpt2-module-box.running::before,
    .gpt3-module-box.running::before,
    .gpt4-module-box.running::before {
      opacity: 1;
      animation: gpt0TopBar 1.5s ease-in-out infinite;
    }

    /* ?¤í–‰ ì¤??ì´?„íŠ¸ ë°•ìŠ¤ ë°˜ì§???¨ê³¼ */
    @keyframes pulse-green {
      0% { stroke: #2fc06e; fill: rgba(40, 160, 90, 0.18); }
      100% { stroke: #5fe08f; fill: rgba(40, 160, 90, 0.36); }
    }
    .agent-running rect {
      stroke: #2fc06e !important;
      animation: pulse-green 0.8s ease-in-out infinite alternate;
      filter: drop-shadow(0 0 6px rgba(47,192,110,0.6));
    }
    .agent-running text { fill: #d9ffe6 !important; }
    /* ?˜ì´?¼ì´???”ë° ?¨ê³¼ */
    .dimmed { opacity: 0.15; filter: grayscale(60%); transition: opacity 150ms ease, filter 150ms ease; }
    .highlighted { opacity: 1 !important; filter: none !important; }
    .highlight-label { font: 12px/1.2 'Segoe UI', Arial, sans-serif; fill: var(--main-text); pointer-events: none; paint-order: stroke; stroke: var(--main-bg); stroke-width: 3px; }
    /* ?„ë? Y?????°ê²°??ê¹œë°•??*/
    @keyframes blinkLine {
      0%, 100% { stroke-opacity: 0.9; filter: drop-shadow(0 0 0 rgba(229,57,53,0)); }
      50% { stroke-opacity: 0.35; filter: drop-shadow(0 0 6px rgba(229,57,53,0.6)); }
    }
    .blink-y-all { animation: blinkLine 1.1s ease-in-out infinite; }
    /* PPT ì§„í–‰ ë²„íŠ¼ ?¨ê³¼ (?ë¦¬ê²? ë²„íŠ¼ ?´ë?ë§?ê¹œë°•) */
    .ppt-progress { background: #2ecc71 !important; color: #fff !important; border-color: #27ae60 !important; }
    .ppt-progress { animation: pulsePptInner 2.2s ease-in-out infinite; }
    /* 'PPTì¶œë ¥' ë²„íŠ¼ë§?ê¹œë°•??(ë°•ìŠ¤ ?„ì²´ ?„ë‹˜) */
    #btn-export-ppt.ppt-progress { position: relative; overflow: hidden; }
    #btn-export-ppt.ppt-progress::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 4px;
      box-shadow: inset 0 0 12px rgba(255,255,255,0.25);
      animation: pulseBtn 2.2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes pulseBtn { 0%,100% { opacity: 0.2; } 50% { opacity: 1; } }
    
    /* ë³´ê³ ??ë²„íŠ¼ ê¹œë°•???¨ê³¼ */
    #btn-export-html.report-progress { 
      position: relative; 
      overflow: hidden;
      background: #2ecc71 !important; 
      color: #fff !important; 
      border-color: #27ae60 !important;
      animation: pulsePptInner 2.2s ease-in-out infinite;
    }
    #btn-export-html.report-progress::after {
      content: '';
      position: absolute;
      inset: 2px;
      border-radius: 4px;
      box-shadow: inset 0 0 12px rgba(255,255,255,0.25);
      animation: pulseBtn 2.2s ease-in-out infinite;
      pointer-events: none;
    }
    
         /* ë³´ê³ ???ì—­ CTA(ê°•ì¡°) ?¨ê³¼ */
     @keyframes reportBoxGlow {
       0%, 100% { box-shadow: 0 0 0 rgba(46,204,113,0); }
       50% { box-shadow: 0 0 18px rgba(46,204,113,0.6); }
     }
     #report-actions.report-actions-cta { animation: reportBoxGlow 1.6s ease-in-out 4; }
     #btn-export-html.report-cta { animation: pulseBtn 1.2s ease-in-out 6; }
     
     /* ?Œì´?„ë¼???„ë£Œ ??ë²„íŠ¼ ê°•ì¡° ? ë‹ˆë©”ì´??*/
     @keyframes pulseSuccess {
       0%, 100% { transform: scale(1); }
       50% { transform: scale(1.05); }
     }
     
          /* ?ë‹¨ ?Œì´?„ë¼??ë²„íŠ¼ ?¨ê³¼ */
     #top-pipeline-btn:hover:not(:disabled) {
       background: linear-gradient(135deg, #357abd, #2c5d9f) !important;
       box-shadow: 0 6px 20px rgba(74,144,226,0.5) !important;
       transform: translateY(-2px) scale(1.02);
     }
     
     /* ë³´ê³ ?œë³´ê¸?ë²„íŠ¼ ?¨ê³¼ */
     #btn-export-html:hover:not(:disabled) {
       background: linear-gradient(135deg, #e67e22, #d35400) !important;
       box-shadow: 0 5px 18px rgba(243,156,18,0.5) !important;
       transform: translateY(-2px) scale(1.02);
     }
     
     /* ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?¨ê³¼ */
     #btn-restart-pipeline:hover:not(:disabled) {
       background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
       box-shadow: 0 4px 15px rgba(39,174,96,0.45) !important;
       transform: translateY(-2px) scale(1.02);
     }
     
     #top-pipeline-btn:active:not(:disabled) {
       transform: translateY(0) scale(0.98);
       box-shadow: 0 2px 8px rgba(74,144,226,0.3) !important;
     }
     
     #btn-export-html:active:not(:disabled) {
       transform: translateY(0) scale(0.98);
       box-shadow: 0 2px 8px rgba(243,156,18,0.3) !important;
     }
     
     #btn-restart-pipeline:active:not(:disabled) {
       transform: translateY(0) scale(0.98);
       box-shadow: 0 2px 6px rgba(39,174,96,0.25) !important;
     }
     
     #top-pipeline-btn:disabled {
       opacity: 0.6;
       cursor: not-allowed;
       transform: none !important;
     }
     
     #top-pipeline-btn.blink-text {
       animation: blinkText 0.9s linear infinite;
     }
     
     /* ?ë‹¨ ì»¨íŠ¸ë¡?ë°˜ì‘???”ì??*/
     @media (max-width: 500px) {
       .sidebar-right .size-control-btn {
         padding: 3px 6px !important;
         font-size: 12px !important;
         min-width: 24px !important;
       }
       
       .sidebar-right #tab-size-display {
         font-size: 10px !important;
         min-width: 40px !important;
       }
       
       .sidebar-right .darkmode-toggle {
         padding: 4px 8px !important;
         font-size: 10px !important;
         min-width: 60px !important;
       }
     }
     
     @media (max-width: 400px) {
       .sidebar-right > div:first-child {
         gap: 2px !important;
       }
       
       .sidebar-right .darkmode-toggle {
         padding: 3px 6px !important;
         font-size: 9px !important;
         min-width: 50px !important;
       }
    }
    
    /* ?ìŠ¤??ê¹œë°•??(ì§„í–‰ ?œì‹œ?? */
    .blink-text { animation: blinkText 0.9s linear infinite; }
    @keyframes blinkText { 0%, 49% { opacity: 0.35; } 50%, 100% { opacity: 1; } }
    
    /* ?Œì´?„ë¼???¤í–‰ ì¤?? ë‹ˆë©”ì´??- ì£¼í™©???¨ê³¼ ?œê±°??*/
    .pipeline-executing {
      /* ì£¼í™©???¬ê¸° ?¨ê³¼ ?œê±° - ?¬ìš©???”ì²­?¼ë¡œ ë¹??´ë˜??? ì? */
      opacity: 1; /* ë¹?ê·œì¹™ ë°©ì???*/
    }
    
    /* ?Œì´?„ë¼??ì§„í–‰ ?íƒœ ?œì‹œ */
    .progress-indicator {
      position: relative;
      border: 2px solid #4a90e2 !important;
      background: rgba(74, 144, 226, 0.05) !important;
      animation: progressGlow 2s infinite;
    }
    
    @keyframes progressGlow {
      0%, 100% { 
        box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
      }
      50% { 
        box-shadow: 0 0 20px rgba(74, 144, 226, 0.6);
      }
    }
    
    .execution-overlay {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: rgba(74, 144, 226, 0.1) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 1000 !important;
      border-radius: 8px !important;
      backdrop-filter: blur(1px) !important;
    }
    
    .execution-text {
      background: rgba(74, 144, 226, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      animation: fadeInOut 2s infinite;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    
    @keyframes pipelinePulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 20px rgba(255, 107, 53, 0.5); 
      }
      50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 30px rgba(255, 107, 53, 0.8); 
      }
    }
    
    /* ë°•ìŠ¤ ?´ë? ì§„í–‰ ?í™© ?œì‹œ */
    .progress-indicator {
      position: relative;
      overflow: hidden;
    }
    
    .progress-indicator::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(74, 144, 226, 0.3), transparent);
      animation: progressSweep 2s ease-in-out infinite;
    }
    
    @keyframes progressSweep {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    /* ?¤í–‰ ì¤??ìŠ¤???¤ë²„?ˆì´ */
    .execution-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(74, 144, 226, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      border-radius: 12px;
      backdrop-filter: blur(2px);
    }
    
    .execution-text {
      color: white;
      font-weight: 700;
      font-size: 16px;
      text-align: center;
      animation: executeTextPulse 1.5s ease-in-out infinite;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    @keyframes executeTextPulse {
      0%, 100% { 
        opacity: 0.8;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.05);
      }
    }
    @keyframes pulsePptInner {
      0%, 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.00); }
      50%      { box-shadow: inset 0 0 18px 0 rgba(255,255,255,0.20); }
    }

    /* ë¡œë”© ? ë‹ˆë©”ì´??*/
    @keyframes loading-pulse {
      0%, 100% { 
        opacity: 0.7;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.02);
      }
    }

    @keyframes loading-fade {
      0%, 100% { 
        opacity: 0.5;
      }
      50% { 
        opacity: 1;
      }
    }

    /* ì¹´ë“œ ë³¸ë¬¸ ê°€?…ì„± ?¥ìƒ */
    .report-card h3 { 
      margin: 0.6rem 0 0.4rem; 
      font-weight: 700; 
      color: var(--main-text);
    }
    .report-card p { 
      margin: 0.4rem 0; 
      line-height: 1.6; 
    }
    .report-card ul, .report-card ol { 
      margin: 0.2rem 0 0.8rem 1.2rem; 
    }

    /* ë©”íŠ¸ë¦?ëª©ë¡???ë ·?˜ê²Œ */
    .report-card ul li strong { 
      font-weight: 700; 
    }
    .report-card ul li { 
      padding-left: 2px; 
    }

    /* ?«ì ê°•ì¡°(???? ??ê°„ë‹¨ ë§¤ì¹­ */
    .metric-pos { 
      color: #11875d; 
      font-weight: 700; 
    }
    .metric-neg { 
      color: #c4302b; 
      font-weight: 700; 
    }

    /* ?¤í¬ ?Œë§ˆ?ì„œ??ë©”íŠ¸ë¦??‰ìƒ ì¡°ì • */
    [data-theme="dark"] .metric-pos { 
      color: #22c55e; 
    }
    [data-theme="dark"] .metric-neg { 
      color: #ef4444; 
    }
    
    /* GPT1 ë°•ìŠ¤ ì§§ì? ?¬ì»¤???˜ì´?¼ì´??(?„ìš” ??ì¡°ì •) */
    .pipeline-focus {
      outline: 2px solid rgba(0, 160, 255, .75);
      box-shadow: 0 0 0 4px rgba(0, 160, 255, .15);
      transition: box-shadow .3s ease;
    }

    /* ??GPT4 ?„ë£Œ ???„ì²´ ?¸ì¶œ ë³´ì¥ */
    #gpt1-panel.show-all .agent-card {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    #gpt1-panel.show-all .agent-card.collapsed {
      display: block !important;
    }

    /* === [ì¶”ê?] Right ?? ì¹´ë“œ ?•ì¥ ?™ì‘ ë³´ê°• === */

    /* ê¸°ë³¸(ì¶•ì•½) ?’ì´: ?¤í¬ë¡??ˆìš© */
    aside.sidebar-right .agent-card .card-body,
    aside.sidebar-right .agent-card .content,
    aside.sidebar-right .agent-card .output-box,
    aside.sidebar-right .agent-card .result-box {
      max-height: 14rem;      /* ?„ìš”??12~16remë¡?ì¡°ì • */
      overflow: auto;
    }

    /* expanded ?? ?’ì´ ?œí•œ ?´ì œ */
    aside.sidebar-right .agent-card.expanded .card-body,
    aside.sidebar-right .agent-card.expanded .content,
    aside.sidebar-right .agent-card.expanded .output-box,
    aside.sidebar-right .agent-card.expanded .result-box {
      max-height: none !important;
      height: auto !important;
      overflow: visible;
    }

    /* ?ìŠ¤???ì—­ ê°€?…ì„±(ìµœì†Œ ?’ì´ ?•ë³´) */
    aside.sidebar-right .agent-card textarea,
    aside.sidebar-right .agent-card pre {
      min-height: 12rem;      /* ?„ìš”??10~14rem ì¡°ì • */
      resize: vertical;       /* ?¬ìš©?ê? ?˜ë™ ë¦¬ì‚¬?´ì¦ˆ ê°€??*/
    }

    /* show-all ëª¨ë“œ?ì„œ ê°•ì œ ?œì‹œ(?¤ë¥¸ ëª¨ë“œ ?”ì—¬ ?¤í????ì‡„) */
    aside.sidebar-right.show-all .agent-card {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* Right ???•ì¥ ??textarea??ìµœë??’ì´ ?´ì œ */
    aside.sidebar-right .agent-card:not(.expanded) textarea {
      max-height: 14rem;
      overflow: auto;
    }
    aside.sidebar-right .agent-card.expanded textarea {
      max-height: none;
    }
  </style>
  
  <!-- [PATCH] ?„ë£Œ ???„ì²´ ?¸ì¶œ/?¨ê³¼ ?•ì? ?¤í???-->
  <style id="patch-output-autogrow">
    /* GPT0~4 ì¶œë ¥ ?ìŠ¤??ë°•ìŠ¤???’ì´ 200px ê³ ì • ë°??¤í¬ë¡?ê°€??*/
    #card-gpt0 textarea,
    #card-gpt1 textarea,
    #card-gpt2 textarea,
    #card-gpt3 textarea,
    #card-gpt4 textarea {
      height: 200px !important;
      overflow: auto !important;
      resize: vertical !important;
    }
    
    /* GPT0 ëª¨ë“ˆë³?ì¶œë ¥ë°•ìŠ¤ ?¤í¬ë¡??¤í???*/
    #gpt0-marketdata,
    #gpt0-news,
    #gpt0-scenario-summary,
    #gpt0-marketstate {
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    
    /* ?¹í‚· ë¸Œë¼?°ì????¤í¬ë¡¤ë°” ?¤í???*/
    #gpt0-marketdata::-webkit-scrollbar,
    #gpt0-news::-webkit-scrollbar,
    #gpt0-scenario-summary::-webkit-scrollbar,
    #gpt0-marketstate::-webkit-scrollbar {
      width: 8px;
    }
    
    #gpt0-marketdata::-webkit-scrollbar-track,
    #gpt0-news::-webkit-scrollbar-track,
    #gpt0-scenario-summary::-webkit-scrollbar-track,
    #gpt0-marketstate::-webkit-scrollbar-track {
      background: transparent;
    }
    
    #gpt0-marketdata::-webkit-scrollbar-thumb,
    #gpt0-news::-webkit-scrollbar-thumb,
    #gpt0-scenario-summary::-webkit-scrollbar-thumb,
    #gpt0-marketstate::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }
    
    #gpt0-marketdata::-webkit-scrollbar-thumb:hover,
    #gpt0-news::-webkit-scrollbar-thumb:hover,
    #gpt0-scenario-summary::-webkit-scrollbar-thumb:hover,
    #gpt0-marketstate::-webkit-scrollbar-thumb:hover {
      background: var(--accent-hover);
    }
  </style>
  <style id="patch-pipeline-complete-visibility">
    /* ?„ë£Œ ?Œë˜ê·¸ê? ë¶™ìœ¼ë©??¤ë¥¸ìª???ë°?ì£¼ìš” ?¨ë„)??ëª¨ë“  ë°•ìŠ¤ë¥?ê°•ì œ ?¸ì¶œ */
    body.pipeline-complete .right-tab .gpt-box,
    body.pipeline-complete [data-panel="right"] .gpt-box,
    body.pipeline-complete #gpt1-panel .gpt-box,
    body.pipeline-complete #gpt2-panel .gpt-box,
    body.pipeline-complete #gpt3-panel .gpt-box,
    body.pipeline-complete #gpt4-panel .gpt-box,
    body.pipeline-complete #gpt-panels .gpt-box,
    body.pipeline-complete .right-tab [data-role="box"],
    body.pipeline-complete [data-panel="right"] [data-role="box"],
    body.pipeline-complete #gpt-panels [data-role="box"],
    body.pipeline-complete .agent-card,
    body.pipeline-complete .module-card,
    body.pipeline-complete .panel-box {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
      height: auto !important;
      max-height: none !important;
    }

    /* ?„ì½”?”ì–¸/?”í…Œ??ê°•ì œ ?¼ì¹¨ */
    body.pipeline-complete .right-tab details,
    body.pipeline-complete [data-panel="right"] details,
    body.pipeline-complete #gpt-panels details {
      overflow: visible !important;
    }

    /* ?„ë£Œ ???”ì—¬ ? ë‹ˆë©”ì´???¤ì¼ˆ?ˆí†¤/?¤í”¼??ë¹„í™œ??*/
    body.pipeline-complete .animate-pulse,
    body.pipeline-complete .blink,
    body.pipeline-complete .shimmer,
    body.pipeline-complete .loading,
    body.pipeline-complete .skeleton,
    body.pipeline-complete .status-shine,
    body.pipeline-complete .progress,
    body.pipeline-complete .progress-bar {
      animation: none !important;
    }
    body.pipeline-complete .execution-overlay,
    body.pipeline-complete .progress-indicator,
    body.pipeline-complete .spinner {
      display: none !important;
    }
  </style>
  <style id="patch-gpt23-header-safe">
    /* GPT2/GPT3 ì¹´ë“œ ?œëª©???ˆì´?„ì›ƒ???„ë¥´ì§€ ?Šë„ë¡??ˆì „ ì²˜ë¦¬ */
    #card-gpt2 h4, #card-gpt3 h4 {
      display: block;
      margin: 0 0 8px;
      padding: 6px 10px;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="layout">
    <!-- ì¤‘ì•™: ?¤íŠ¸?Œí¬ ê·¸ë˜??-->
    <main id="main-content">
      <section id="network-graph"></section>
    </main>

    <!-- ?¤ë¥¸ìª? GPT ?¨ë„ (?”ì•½/ê²°ê³¼ ë³´ê?) + ë²„ë¸” UI ?¤ë²„?ˆì´ -->
    <aside class="sidebar-right right-tab-panel" id="gpt1-panel">

      
      <!-- ?ë‹¨ ì»¨íŠ¸ë¡??ì—­ -->
      <div style="margin-bottom:6px;">
        
        <!-- 1ì¤? ë¶„ì„?œì‘ ë²„íŠ¼ -->
        <div style="display:flex;justify-content:center;margin-bottom:6px;">
          <button class="darkmode-toggle analysis-start-btn" id="top-pipeline-btn" style="width:70%; max-width:280px; background:linear-gradient(135deg, #4a90e2, #357abd); color:white; font-weight:700;border-radius:10px;box-shadow:0 3px 10px rgba(74,144,226,0.3);transition:all 0.3s ease;" onclick="handlePipelineAndReport()">ë¶„ì„?¤í–‰</button>
        </div>
        
        <!-- 2ì¤? ë³´ê³ ?œë³´ê¸?ë²„íŠ¼ (?„ë£Œ ???œì‹œ) -->
        <div id="report-buttons-container" style="display:none;flex-direction:column;gap:8px;margin-bottom:6px;">
          <button class="darkmode-toggle" id="btn-export-html" style="padding:16px 30px; width:70%; max-width:280px; background:linear-gradient(135deg, #f39c12, #e67e22); color:white; font-weight:700;font-size:16px;border-radius:10px;box-shadow:0 3px 10px rgba(243,156,18,0.3);transition:all 0.3s ease;margin:0 auto;display:block;" onclick="showHtmlReport()">?“Š ë³´ê³ ?œë³´ê¸?/button>
          <!-- ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?¨ê? -->
          <button class="darkmode-toggle" id="btn-restart-pipeline" style="padding:10px 24px; width:60%; max-width:240px; background:linear-gradient(135deg, #27ae60, #2ecc71); color:white; font-weight:600;font-size:14px;border-radius:8px;box-shadow:0 2px 8px rgba(39,174,96,0.25);transition:all 0.3s ease;margin:0 auto;display:none;" onclick="restartPipeline()">?”„ ?¤ì‹œ?¤í–‰</button>
        </div>
        
        <!-- 3ì¤? ???¬ê¸° ì¡°ì • ì»¨íŠ¸ë¡?(ë§ˆì?ë§?ì¤? -->
        <div id="tab-size-control-container" style="display:flex;align-items:center;gap:6px;justify-content:center;">
          <button class="size-control-btn" style="padding:4px 8px;font-size:14px;min-width:28px;font-weight:bold;border-radius:4px;" onclick="increaseTabSize()">+</button>
          <span id="tab-size-display" class="size-display" style="font-size:12px;font-weight:600;min-width:50px;text-align:center;">400px</span>
          <button class="size-control-btn" style="padding:4px 8px;font-size:14px;min-width:28px;font-weight:bold;border-radius:4px;" onclick="decreaseTabSize()">??/button>
        </div>
        
      </div>
      <div id="send-status" style="margin:2px 0 8px;font-size:12px;color:#888;text-align:center;"></div>
      
        <script>
    // ==== GPT3 ê²°ê³¼ ?€??ê³µí†µ ? í‹¸ ====
    function setIfNonEmpty(id, text){
      const el = document.getElementById(id);
      const t  = (text || '').trim();
      if (el && t) el.value = t;               // ??ë¹?ë¬¸ì?´ì´ë©???–´?°ì? ?ŠìŒ
    }

    // ==== [C] ?´ë°±: ?íƒœ ?¼ë²¨ ê´€ì°????´ë²¤???ë™ ë°œí–‰ ====
        (function(){
          const statusEl = document.querySelector('#send-status, .pipeline-status, .status-text');
          if (!statusEl) return;
          let last = '';

          const map = [
            { re: /GPT\s*0|GPT0|?¬ì „?˜ì§‘|?œí™©/i,      evt: 'gpt0:start' }, // ??ì¶”ê?
            { re: /GPT\s*1|GPT1|ì¢…í•©ë¶„ì„|?”ì•½ ?ì„±/i, evt: 'gpt1:start' },
            { re: /GPT\s*2|GPT2|?œë‚˜ë¦¬ì˜¤/i,          evt: 'gpt2:start' },
            { re: /GPT\s*3|GPT3|?„ë©”???¥ë‹¤?´ë¸Œ/i,    evt: 'gpt3:start' },
            { re: /GPT\s*4|GPT4|ìµœì¢…|ë³´ê³ ??i,        evt: 'gpt4:start' },
            { re: /?„ë£Œ|ë³´ê³ ??s*?‘ì„±\s*?„ë£Œ|ë³´ê³ ??s*?ì„±\s*?„ë£Œ|?Œì´?„ë¼??s*?„ë£Œ|ì¢…ë£Œ/i, evt: 'pipeline:done' }
          ];

          // ì¹´ë“œ ì°¸ì¡° ìºì‹œ ?„ì—­ ?•ë³´
          const c0 = document.getElementById('card-gpt0');
          const c1 = document.getElementById('card-gpt1');
          const c2 = document.getElementById('card-gpt2');
          const c3 = document.getElementById('card-gpt3');
          const c4 = document.getElementById('card-gpt4');
          function clearRunning(){ [c0,c1,c2,c3,c4].forEach(el => el?.classList.remove('running')); }

          new MutationObserver(() => {
            const text = statusEl.textContent || '';
            if (text === last) return;
            last = text;
            for (const {re, evt} of map) {
              if (re.test(text)) {
                window.dispatchEvent(new CustomEvent(evt));
                break;
              }
            }
          }).observe(statusEl, { childList: true, subtree: true, characterData: true });
        })();

        // ==== [D] "ì´ˆê¸° ?„ì²´?’ì´???¨ë…?œì‹œ" ? ê? ?¸ë“¤??====
        (function applySoloViewMode(){
          const panel = document.getElementById('gpt1-panel'); // ?°ì¸¡ ?¨ë„ ì»¨í…Œ?´ë„ˆ
          if (!panel) return;

          // ê¸°ë³¸ ?•ì±…: ??ƒ ?„ì²´ ?œì‹œ
          function exitSolo() { panel.classList.remove('solo-mode'); }
          function enterSolo() { /* no-op: ?¨ë…?œì‹œ ë¯¸ì‚¬??*/ }

          // ì´ˆê¸° ì§„ì… ???„ì²´?œì‹œ ê°•ì œ
          panel.classList.add('show-all');
          panel.classList.remove('solo-mode');

          // ê³µí†µ ? í‹¸(ë¡œì»¬ ?¤ì½”?„ì—???ì²´ ì²˜ë¦¬, ?„ì—­ ?˜ì¡´ ?œê±°)
          function removeRunningInRightPanel() {
            document.querySelectorAll('.right-tab-panel .agent-card.running')
              .forEach(el => el.classList.remove('running'));
          }
          function markRunningById(id) {
            const card = document.getElementById(id);
            if (card) card.classList.add('running');
          }
          function scrollToAnchorOrCard(anchorSel, cardId) {
            // ?”’ ?¤ì½”??? ê¸ˆ ?ìš©
            const scope = window.__RightFocusScope || null;
            if (scope === 'gpt3') {
              anchorSel = '.gpt3-anchor';
              cardId    = 'card-gpt3';
            } else if (scope === 'gpt4') {
              anchorSel = '.gpt4-anchor';
              cardId    = 'card-gpt4';
            }

            // 1) ?µì»¤ê°€ ?ˆìœ¼ë©??µì»¤ ê¸°ì? ?¤í¬ë¡?
            const anchor = document.querySelector(anchorSel);
            const panel  = document.querySelector('.right-tab-panel');
            if (panel && anchor) {
              panel.scrollTo({ top: Math.max(0,(anchor.offsetTop||0) - 40), behavior: 'smooth' });
              return;
            }
            // 2) ?´ë°±: ì¹´ë“œ ID ê¸°ì? ?¤í¬ë¡?
            const card = document.getElementById(cardId);
            if (panel && card) {
              panel.scrollTo({ top: Math.max(0,(card.offsetTop||0) - 40), behavior: 'smooth' });
            }
          }

          // ?™ï¸ ?•ì±…:
          // - gpt0 ?œì‘: ?„ì²´ ?œì‹œ ? ì? + ê°•ì¡°ë§?
          // - gpt1~gpt4 ?œì‘: ?„ì²´ ?œì‹œ ? ì? + ê°•ì¡°ë§?
          window.addEventListener('gpt0:start', () => {
            panel.classList.add('show-all');
            exitSolo();
          });
          window.addEventListener('gpt1:start', () => {
            panel.classList.add('show-all');
            exitSolo();
          });
      // GPT2/3/4ê°€ ë¨¼ì? ?œì‘?˜ë©´ GPT1?’GPT2 ì§€???€?´ë¨¸ ì·¨ì†Œ(?ˆì´??ê°€??
      ;['gpt2:start','gpt3:start','gpt4:start'].forEach(evt => {
        window.addEventListener(evt, () => {
          if (window.__gpt1ToGpt2Timer) {
            clearTimeout(window.__gpt1ToGpt2Timer);
            window.__gpt1ToGpt2Timer = null;
          }
        });
      });
          // ?°ì¸¡ ?¨ë„ ?ë™ ?¤í¬ë¡??¬ì»¤???¤ì½”?? null | 'gpt3' | 'gpt4'
          window.__RightFocusScope = window.__RightFocusScope || null;
          window.addEventListener('gpt3:start', () => { window.__RightFocusScope = 'gpt3'; });
          window.addEventListener('gpt4:start', () => { window.__RightFocusScope = 'gpt4'; });
          window.addEventListener('pipeline:done', () => { window.__RightFocusScope = null; });
          window.addEventListener('gpt4:done', () => { window.__RightFocusScope = null; });

      // GPT2 êµ¬ê°„: ?ë‹¨ ?íƒœ ?¼ë²¨??ì§„í–‰ì¤??¨ê³¼ ?ìš©
      window.addEventListener('gpt2:start', () => {
        const s = document.getElementById('send-status');
        if (!s) return;
        s.classList.add('progress-indicator','status-shine');
        s.setAttribute('aria-busy','true');
      });
      // GPT3 ?œì‘ ???ëŠ” ?Œì´?„ë¼???„ë£Œ ???¨ê³¼ ?´ì œ
      window.addEventListener('gpt3:start', () => {
        const s = document.getElementById('send-status');
        if (!s) return;
        s.classList.remove('progress-indicator','status-shine');
        s.removeAttribute('aria-busy');
      });
      window.addEventListener('pipeline:done', () => {
        const s = document.getElementById('send-status');
        if (!s) return;
        s.classList.remove('progress-indicator','status-shine');
        s.removeAttribute('aria-busy');
      });
          window.addEventListener('gpt2:start', () => {
            // ë³´ì¡° ê°€?? GPT2 Worst ?œë‚˜ë¦¬ì˜¤ êµ¬ê°„?ì„œ??solo-mode ?´ì œ
            if (typeof disableSoloMode === 'function') disableSoloMode();
            panel.classList.add('show-all');
            exitSolo();
          });
          window.addEventListener('gpt3:start', () => {
            const panel = document.querySelector('.right-tab-panel');
            panel?.classList.add('show-all');  // ???„ì²´?œì‹œ ? ì?(ë³€ê²?
            exitSolo();                        // ???¨ë…?œì‹œ ?´ì œ(ë³€ê²?
            removeRunningInRightPanel();
            markRunningById('card-gpt3');
            scrollToAnchorOrCard('.gpt3-anchor', 'card-gpt3');
          });
          window.addEventListener('gpt4:start', () => {
            const panel = document.querySelector('.right-tab-panel');
            panel?.classList.add('show-all');  // ???„ì²´?œì‹œ ? ì?(ë³€ê²?
            exitSolo();                        // ???¨ë…?œì‹œ ?´ì œ(ë³€ê²?
            removeRunningInRightPanel();
            markRunningById('card-gpt4');                 // ??ë°˜ë“œ??running ë¶€??
            scrollToAnchorOrCard('.gpt4-anchor', 'card-gpt4'); // ???µì»¤ ?†ìœ¼ë©?ì¹´ë“œë¡??´ë°±
          });
        })();

        // ?„ë£Œ ?´ë²¤??ë¦¬ìŠ¤??ì¶”ê?: solo-mode ?´ì œ ë°??œì‹œ ?íƒœ ?•ë¦¬
        window.addEventListener('pipeline:done', () => {
          console.log('?‰ ?Œì´?„ë¼???„ë£Œ - ëª¨ë“  ?¨ê³¼ ë°??€?´ë¨¸ ?•ë¦¬');
          
          // GPT3 ì§€???¨ê³¼ ?€?´ë¨¸ ?•ë¦¬ (?¹ì‹œ ?¨ì•„?ˆì„ ê²½ìš°)
          if (window.gpt3DelayedEffectTimer) {
            clearTimeout(window.gpt3DelayedEffectTimer);
            window.gpt3DelayedEffectTimer = null;
            console.log('??GPT3 ì§€???¨ê³¼ ?€?´ë¨¸ ?•ë¦¬ ?„ë£Œ');
          }
          
          // solo-mode ì§ì ‘ ?´ì œ
          document.querySelector('.right-tab-panel')?.classList.remove('solo-mode','gpt2worst-mode');

          // running/?¤í–‰ ?œì‹œ ?•ë¦¬
          document.querySelectorAll('.right-tab-panel .agent-card.running')
            .forEach(el => el.classList.remove('running'));

          // GPT3 ëª¨ë“ˆë³?ë°•ìŠ¤ ?¨ê³¼ ?„ì „ ì¢…ë£Œ
          document.querySelectorAll('.gpt3-module-box.running')
            .forEach(el => el.classList.remove('running'));

          // ëª¨ë“  ëª¨ë“ˆ ë°•ìŠ¤??done ?´ë˜??ì¶”ê?
          document.querySelectorAll(
            '.gpt0-module-box,.gpt1-module-box,.gpt2-module-box,.gpt3-module-box,.gpt4-module-box'
          ).forEach(el => el.classList.add('done'));

          // ?¤í–‰ ì¤??¤ë²„?ˆì´ ?œê±°
          document.querySelectorAll('.execution-overlay')
            .forEach(el => el.remove());

          // ì§„í–‰ ?œì‹œ ?¨ê³¼ ?œê±°
          document.querySelectorAll('.progress-indicator')
            .forEach(el => el.classList.remove('progress-indicator'));

          // ?Œì´?„ë¼???„ë£Œ ?Œë˜ê·?ì¶”ê? (CSS ?¨ê³¼ ê°•ì œ ì¢…ë£Œ??
          document.body.classList.add('pipeline-complete');
        });

        // ??GPT2 WORST ì§„í–‰ ??GPT1Â·GPT2 ë°•ìŠ¤ ê°•ì œ ?¸ì¶œ ë°?GPT4 ?„ë£Œ ??ëª¨ë“  ë°•ìŠ¤ ?¸ì¶œ
        (function initRightTabShowPolicy(){
          if (window.__initRightTabShowPolicy) return;
          window.__initRightTabShowPolicy = true;

          function getPanel() {
            return document.querySelector('.right-tab-panel, #gpt1-panel, #gpt-right-panel, #right-tab, aside#right-panel, [data-panel="right"]');
          }
          function markVisible(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.remove('hidden','collapsed');
            card.style.display = ''; // display:none ê°•ì œ ?´ì œ(?ˆì„ ê²½ìš°)
            card.classList.add('running'); // solo-mode?ì„œ???œì‹œ?˜ë„ë¡?
          }
          function addExecuting(selector) {
            document.querySelectorAll(selector).forEach(el => el.classList.add('pipeline-executing'));
          }
          function removeExecuting(selector) {
            document.querySelectorAll(selector).forEach(el => el.classList.remove('pipeline-executing'));
          }
          function scrollBetween(id1, id2) {
            const panel = getPanel();
            const a = document.getElementById(id1);
            const b = document.getElementById(id2);
            if (!(panel && a && b)) return;
            setTimeout(() => {
              try {
                const mid = (a.offsetTop + b.offsetTop) / 2;
                panel.scrollTo({ top: Math.max(0, mid - 80), behavior: 'smooth' });
              } catch(_) {}
            }, 60);
          }

          // ??GPT2 WORST ?œì‘ ???µí•© ì²˜ë¦¬ (onGpt2WorstStartUI ?¨ìˆ˜ ?¬ìš©)
          window.addEventListener('gpt2worst:start', () => {
            console.log('?”” GPT2 Worst ?´ë²¤???˜ì‹  - ?µí•© ì²˜ë¦¬');
            onGpt2WorstStartUI();
          });

          // ??GPT3/GPT4 ?œì‘ ?œì—??show-all??? ì?(?„ì²´?œì‹œ ?•ì±…)
          window.addEventListener('gpt3:start', () => {
            const panel = getPanel();
            panel?.classList.add('show-all');    // ???„ì²´?œì‹œ ? ì?
          });
          window.addEventListener('gpt4:start', () => {
            const panel = getPanel();
            panel?.classList.add('show-all');    // ???„ì²´?œì‹œ ? ì?
          });

          // ???µí•©???„ë£Œ ì²˜ë¦¬ ?¨ìˆ˜ (ì¤‘ë³µ ?œê±°)
          function handlePipelineCompletion() {
            const panel = getPanel();
            if (!panel) return;
          panel.classList.remove('solo-mode','gpt2worst-mode');
          panel.classList.add('show-all'); // CSSë¡??„ì²´ ?œì‹œ ë³´ì¥
            // ?¤í–‰ ì¤??œì‹œ ?•ë¦¬
            removeExecuting('.pipeline-executing');
            // ?„ìš” ??running ?œê±°, ?„ë£Œ ?œì‹œ??? ì?
            document.querySelectorAll('#gpt1-panel .agent-card.running')
              .forEach(el => el.classList.remove('running'));
          }
          // gpt4:done?€ ë³„ë„ ?¸ë“¤?¬ì—??ì²˜ë¦¬?˜ë?ë¡??¬ê¸°?œëŠ” pipeline:doneë§?ì²˜ë¦¬
          window.addEventListener('pipeline:done', handlePipelineCompletion);
        })();
      </script>

      <div style="border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;background:linear-gradient(135deg, rgba(74,144,226,0.05), rgba(122,183,255,0.02));box-shadow:0 2px 8px rgba(0,0,0,0.04);">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <div style="width:4px;height:20px;background:linear-gradient(180deg, var(--accent), var(--accent-hover));border-radius:2px;"></div>
          <div style="font-weight:700;font-size:14px;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;">?“Š ? íƒ???œë‚˜ë¦¬ì˜¤</div>
        </div>
        <div id="selected-scenario-name" style="font-size:13px;color:var(--main-text);margin-bottom:10px;padding:8px;background:rgba(74,144,226,0.08);border-radius:6px;border-left:3px solid var(--accent);">? íƒ????ª© ?†ìŒ</div>
        <div style="display:flex;align-items:center;gap:8px;margin:12px 0 8px;">
          <div style="width:4px;height:16px;background:linear-gradient(180deg, #2fc06e, #27ae60);border-radius:2px;"></div>
          <div style="font-weight:700;font-size:14px;color:#2fc06e;text-transform:uppercase;letter-spacing:0.5px;">?”— ?°ê²°???œì¥?°ì´??/div>
        </div>
        <ul id="selected-indicators-list" style="margin:0;padding-left:20px;font-size:12px;list-style:none;">
          <li style="padding:4px 0;color:var(--main-text);opacity:0.8;">?°ì´??ë¡œë”© ì¤?..</li>
        </ul>
      </div>

      <!-- ?ì´?„íŠ¸ ì¹´ë“œ??UI -->
      <div class="agent-card" id="card-gpt0" data-card="gpt0">
        <h4>GPT0 ëª¨ë“ˆë³??„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?/h4>

        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <div class="gpt0-module-box" id="gpt0-marketdata-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´??ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">?„ë¡¬?„íŠ¸: ?œê³„???°ì´??ë¶„ì„ ë°?ë³€?™ì„±/ì¶”ì„¸/?ê?ê´€ê³??”ì•½</div>
            <textarea id="gpt0-marketdata" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ë§ˆì¼“?°ì´??ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="copy-btn" onclick="copyText('gpt0-marketdata')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>
          <div class="gpt0-module-box" id="gpt0-news-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">ê¸°ì‚¬?´ìŠ¤ ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">?„ë¡¬?„íŠ¸: ê¸°ì‚¬ ?”ì•½ ë°??œë‚˜ë¦¬ì˜¤ ?°ê³„?? ë¦¬ìŠ¤???¸ë¦¬ê±?ë¶„ì„</div>
            <textarea id="gpt0-news" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ê¸°ì‚¬?´ìŠ¤ ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="copy-btn" onclick="copyText('gpt0-news')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>
          <div class="gpt0-module-box" id="gpt0-scenario-summary-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">?œë‚˜ë¦¬ì˜¤ ?”ì•½ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">?„ë¡¬?„íŠ¸: ?œë‚˜ë¦¬ì˜¤ ?µì‹¬ ?´ìš© ë¶„ì„ ë°?ë¦¬ìŠ¤???”ì¸, ?í–¥ ê²½ë¡œ ?„ì¶œ</div>
            <textarea id="gpt0-scenario-summary" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ?œë‚˜ë¦¬ì˜¤ ?”ì•½ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt0-scenario-summary')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>

          <div class="gpt0-module-box" id="gpt0-marketstate-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-weight:600;font-size:12px;">?„ì¬ ?œí™©ë¶„ì„</div>
            </div>
            <div style="font-size:11px;color:#888;margin-bottom:4px;">?„ë¡¬?„íŠ¸: ?„ì¬ ?œì¥/ê²½ì œ ?í™© ?”ì•½ ë°??¹ì¼ ?µì‹¬ ?¬ì¸??5ê°€ì§€</div>
            <textarea id="gpt0-marketstate" style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;" placeholder="GPT0 ?„ì¬ ?œí™©ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
            <div style="display:flex;justify-content:flex-end;margin-top:4px;">
              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt0-marketstate')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
          </div>
        </div>
      </div>
      <div class="agent-card gpt1-module-box" id="card-gpt1" data-card="gpt1">
        <h4>GPT1 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?/h4>
        <div id="gpt1-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 4px;">
                      <div class="prompt-text" style="font-weight:600;font-size:12px;">GPT1 ?œìŠ¤???„ë¡¬?„íŠ¸</div>
          <div style="display:flex;gap:6px;">
                            <button class="darkmode-toggle copy-btn" onclick="copyText('gpt1-system')">ë³µì‚¬</button>
            <button class="darkmode-toggle" onclick="runFrom('gpt1')">?¬ê¸°???¤í–‰</button>
          </div>
        </div>
        <textarea id="gpt1-system" style="width:100%;height:120px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ A4 ????ë¶„ëŸ‰??GPT0 ?”ì•½??ë°›ì•„ GPT2 ?„ë©”?¸ë³„ WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ì¢…í•© ?•ì œ ê²°ê³¼ë¥??‘ì„±?˜ëŠ” ?„ë¬¸ê°€?…ë‹ˆ??

??• :
- A4 ????ë¶„ëŸ‰??GPT0 ?”ì•½??ë¶„ì„?˜ì—¬ GPT2ê°€ ?„ìš”ë¡??˜ëŠ” ?µì‹¬ ?•ë³´ ì¶”ì¶œ
- ê¸ˆë¦¬/?˜ìœ¨/? ìš©?„í—˜/ì£¼ê?ì§€????4ê°?ë¶„ì•¼??WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ê¸°ì´ˆ ?°ì´???œê³µ
- 5ê°??„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„±???„í•œ êµ¬ì²´???Œë¼ë¯¸í„° ë°?ì§€ì¹??œê³µ
- ?¼ê????ˆëŠ” ?œë‚˜ë¦¬ì˜¤ ?¤ëª…ê³?ë§ˆì¼“?°ì´??ì¢…í•© ?”ì•½ ?ì„±

GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ?„ìˆ˜ ?°ì´??
1. ê¸ˆë¦¬ WORST ?œë‚˜ë¦¬ì˜¤?? ê¸‰ê²©??ê¸ˆë¦¬ ?ìŠ¹/?˜ë½ ê·¼ê±° ë°?êµ¬ì²´???˜ì¹˜ ë²”ìœ„
2. ?˜ìœ¨ WORST ?œë‚˜ë¦¬ì˜¤?? ê·¹ë‹¨???˜ìœ¨ ë³€???”ì¸ ë°????¬ëŸ¬, ì£¼ìš” ?µí™” ë³€?™í­
3. ? ìš©?„í—˜ WORST ?œë‚˜ë¦¬ì˜¤?? ?€ê·œëª¨ ? ìš©ê²½ìƒ‰ ë°?ë¶€??ê¸‰ì¦ ?¸ë¦¬ê±??”ì¸
4. ì£¼ê?ì§€??WORST ?œë‚˜ë¦¬ì˜¤?? ì£¼ì‹?œì¥ ??½ ?œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤?? ê¸€ë¡œë²Œ ì§€??

?„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„±???„í•œ êµ¬ì¡°??
1. ?œì¥ë¦¬ìŠ¤?¬í?: VaR, ë¯¼ê°?? ë³€?™ì„± ëª¨ë¸ë§??Œë¼ë¯¸í„° + ?¤ì§• ?„ëµ ê¸°ì´ˆ ?ë£Œ
2. ? ìš©ë¦¬ìŠ¤?¬í?: ?¹í„°ë³??±ê¸‰ë³?ë¶€?„í™•ë¥?ì¶”ì • + ? ìš©?¤í”„?ˆë“œ ?•ë? ?œë‚˜ë¦¬ì˜¤
3. ALM?€: ?ì‚°ë¶€ì±??€?ˆì´??ë¶„ì„ + ? ë™??ê°?ë°??ê¸ˆì¡°ë‹¬ ë¹„ìš© ?í–¥ ?ë£Œ
4. ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í?: êµ??ë¦¬ìŠ¤???‰ê? + ?•ì¹˜/ê²½ì œ??ë¶ˆì•ˆ?•ì„± ?Œê¸‰?¨ê³¼ ë¶„ì„
5. ? ìš©?¬íŠ¸?´ë¦¬?¤í?: ?¬íŠ¸?´ë¦¬??ì§‘ì¤‘??+ ?ê?ê´€ê³?ë°?ë¶„ì‚°?¨ê³¼ ë¶„ì„ ?ë£Œ

ì¶œë ¥ ?•ì‹:
1. ?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?µí•© ?”ì•½
2. ë§ˆì¼“?°ì´???µì‹¬ ì§€???”ì•½ 
3. ?„ì¬?œí™©ê³??´ìŠ¤ ?°ê???ë¶„ì„
4. GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ê¸°ì´ˆ ?°ì´??
5. ?„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„± ì§€ì¹?

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">?…ë ¥?°ì´??/div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt1-message')">ë³µì‚¬</button>
        </div>
        <textarea id="gpt1-message" style="width:100%;height:120px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:8px;box-sizing:border-box;resize:vertical;"></textarea>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">GPT1 ì¶œë ¥ ê²°ê³¼</div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt1-output')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
        </div>
        <textarea id="gpt1-output"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="GPT1 ì¢…í•© ?•ì œ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
      </div>

      <div class="agent-card gpt2-module-box" id="card-gpt2" data-card="gpt2">
        <h4>GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?/h4>
        <div id="gpt2-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 4px;">
                      <div class="prompt-text" style="font-weight:600;font-size:12px;">GPT2 ?œìŠ¤???„ë¡¬?„íŠ¸</div>
          <div style="display:flex;gap:6px;">
                            <button class="darkmode-toggle copy-btn" onclick="copyText('gpt2-system')">ë³µì‚¬</button>
            <button id="gpt2-run-btn" class="darkmode-toggle" onclick="runFrom('gpt2')">?¬ê¸°???¤í–‰</button>
          </div>
        </div>
        <textarea id="gpt2-system"
  style="width:100%;min-height:200px;height:auto;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';" readonly>?¹ì‹ ?€ GPT1 ì¢…í•© ?•ì œ ê²°ê³¼ë¥?ë°”íƒ•?¼ë¡œ GPT3ê°€ ?€???„í™©?ë£Œ?€ ?°ê³„?˜ì—¬ ?„ê¸°?í™© ?œë??ˆì´?˜ì„ ?˜í–‰?????ˆëŠ” ë§ì¶¤???œë‚˜ë¦¬ì˜¤ ?•ë³´ë¥??ì„±?˜ëŠ” ?„ë¬¸ê°€?…ë‹ˆ??

??• :
- GPT1??WORST ?œë‚˜ë¦¬ì˜¤ ê¸°ì´ˆ ?°ì´?°ë? êµ¬ì²´?ì¸ ?„ê¸°?í™© ?œë‚˜ë¦¬ì˜¤ë¡?ë°œì „
- ê°?GPT3 ?„ë©”?¸ì´ ?€???„í™©?ë£Œ(ê°€?´ë“œ ?Œì¼)?€ ê²°í•©?˜ì—¬ ë¶„ì„?????ˆëŠ” ?œë‚˜ë¦¬ì˜¤ ?œê³µ
- ?„ê¸°?í™© ?œë??ˆì´?˜ì„ ?„í•œ êµ¬ì²´???˜ì¹˜, ê°€?? ?„ê°œ ê²½ë¡œ ?ì„±
- ?€?‰ì˜ ?„ì¬ ?íƒœ?ì„œ WORST ?œë‚˜ë¦¬ì˜¤ ë°œìƒ ???ˆìƒ?˜ëŠ” ?í–¥???œë??ˆì´???€ ?œê³µ

?µì‹¬ ?œì¥ ë³€?˜ë³„ WORST ?œë‚˜ë¦¬ì˜¤ ?ì„± ê¸°ì? (ëª¨ë“  ?„ë©”??ê³µí†µ):

?ì‹œ?˜ë¦¬???ì„± ë°©ë²•ë¡ ã€?
GPT1?ì„œ ?œê³µ??A4 ????ë¶„ëŸ‰???”ì•½ ?•ë³´ë¥?ë©´ë???ë¶„ì„?˜ì—¬, ?„ë˜ ë³€?˜ë³„ ìµœí•˜??ìµœìƒ??ê¸°ì? ?´ì—???œë‚˜ë¦¬ì˜¤???í•©??êµ¬ì²´???˜ì¹˜ë¥??„ì¶œ?˜ë¼.

?ê¸ˆë¦??œë‚˜ë¦¬ì˜¤ ?ì„± ê¸°ì???
- ê¸°ì?ê¸ˆë¦¬ ë³€??ë²”ìœ„: ìµœì†Œ Â±100bp ~ ìµœë? Â±500bp (A4 ?”ì•½??ê¸ˆë¦¬ ë¦¬ìŠ¤???˜ì????°ë¼ ê²°ì •)
- ?˜ìµë¥?ê³¡ì„  ë³€?? ìµœì†Œ Â±50bp ~ ìµœë? Â±300bp ?¤í”„?ˆë“œ ë³€??
- ?Œì‚¬ì±??¤í”„?ˆë“œ: ìµœì†Œ +50bp ~ ìµœë? +600bp (? ìš©?±ê¸‰ë³?ì°¨ë“± ?ìš©)

?í™˜???œë‚˜ë¦¬ì˜¤ ?ì„± ê¸°ì???
- ì£¼ìš” ?µí™” ë³€??ë²”ìœ„: ìµœì†Œ Â±10% ~ ìµœë? Â±50% (A4 ?”ì•½??ê¸€ë¡œë²Œ ë¦¬ìŠ¤?¬ì— ?°ë¼)
- ?˜ìœ¨ ë³€?™ì„± ì¦ê?: ìµœì†Œ 200% ~ ìµœë? 500% ?‰ìƒ???€ë¹?ì¦ê?
- ?µí™”ë³?ì°¨ë“± ?ìš©: ?¬ëŸ¬>? ë¡œ>???„ì•ˆ ?œìœ¼ë¡??í–¥??ì°¨ë³„??

?ì£¼ê°€ ?œë‚˜ë¦¬ì˜¤ ?ì„± ê¸°ì???
- ì¢…í•©ì§€??ë³€?? ìµœì†Œ -20% ~ ìµœë? -70% ?˜ë½ ?ëŠ” +20% ~ +100% ê¸‰ë“±
- ?¹í„°ë³?ì°¨ë³„?? ìµœì†Œ Â±10% ~ ìµœë? Â±80% (?…ì¢…ë³??œë‚˜ë¦¬ì˜¤ ?°ê??±ì— ?°ë¼)
- ì£¼ê? ë³€?™ì„±: ìµœì†Œ 200% ~ ìµœë? 400% ?‰ìƒ???€ë¹?ì¦ê?

?ë??™ì„± ?œë‚˜ë¦¬ì˜¤ ?ì„± ê¸°ì???
- ?¼ì¼ ë³€?™ì„± ì¦ê?: ìµœì†Œ 300% ~ ìµœë? 1000% ?‰ìƒ???€ë¹?
- ?ê?ê´€ê³?ë³€?? ìµœì†Œ 0.6 ~ ìµœë? 0.95 (?„ê¸° ?í™© ?¬ê°?„ì— ?°ë¼)
- ë³€?™ì„± êµ°ì§‘?? ?°ì† 3??~ 30??ì§€??ê¸°ê°„ ?¤ì •

?ë??™ì‚° ?œë‚˜ë¦¬ì˜¤ ?ì„± ê¸°ì???
- ê°€ê²??˜ë½ ë²”ìœ„: ìµœì†Œ -10% ~ ìµœë? -60% (ì§€??³„/? í˜•ë³?ì°¨ë“±)
- ê±°ë˜??ê°ì†Œ: ìµœì†Œ -30% ~ ìµœë? -90%
- PF ë¶€?¤ë¥ : ìµœì†Œ +5%p ~ ìµœë? +50%p ì¦ê?

?ì‹œ?˜ë¦¬??êµ¬ì²´???”êµ¬?¬í•­??
A4 ?”ì•½ ?•ë³´?ì„œ ?¤ìŒ ?”ì†Œ?¤ì„ ì¶”ì¶œ?˜ì—¬ ??ê¸°ì? ë²”ìœ„ ?´ì—???•í™•???˜ì¹˜ë¥??°ì •?˜ë¼:
1. ?œë‚˜ë¦¬ì˜¤???¬ê°??ë°?ë°œìƒ ê°€?¥ì„±
2. ?„ì¬ ?œì¥ ?í™©ê³¼ì˜ ?°ê???
3. ?´ìŠ¤/?´ë²¤?¸ì˜ ?œì¥ ì¶©ê²© ê°•ë„
4. ë§ˆì¼“?°ì´?°ì—???˜í???ì·¨ì•½??ì§€??
5. ê¸°ì¡´ ë¦¬ìŠ¤???”ì¸?¤ì˜ ?í˜¸ ì¦í­ ?¨ê³¼

?„ë©”?¸ë³„ ?œë‚˜ë¦¬ì˜¤ ?ì„± ë°©ë²•ë¡?

ê°??„ë©”?¸ì? GPT1??A4 ?”ì•½ ?•ë³´ë¥?ê¸°ë°˜?¼ë¡œ ??ê¸°ì? ë²”ìœ„ ?´ì—???„ë©”?¸ë³„ ?¹í™” ?œë‚˜ë¦¬ì˜¤ë¥?êµ¬ì²´?”í•˜??

1. ?œì¥ë¦¬ìŠ¤?¬í? (GPT3_market) - ?œì¥ë¦¬ìŠ¤??txt ?°ê³„
   [A4 ?”ì•½ ë¶„ì„ ?”êµ¬?¬í•­]
   - A4 ?”ì•½??ë§ˆì¼“?°ì´???¹ì…˜?ì„œ ê¸ˆë¦¬/?˜ìœ¨/ì£¼ê? ì·¨ì•½??ì§€??ì¶”ì¶œ
   - ?„ì¬ ?œí™© ?¹ì…˜?ì„œ ?œì¥ ë³€?™ì„± ?•ë? ì¡°ì§ ?Œì•…
   - ?´ìŠ¤ ë¦¬ìŠ¤???¹ì…˜?ì„œ ?œì¥ ì¶©ê²© ?¸ë¦¬ê±??”ì¸ ?ë³„
   
   [êµ¬ì²´???œë‚˜ë¦¬ì˜¤ ?ì„±]
   - ??ë¶„ì„??ë°”íƒ•?¼ë¡œ ê¸ˆë¦¬/?˜ìœ¨/ì£¼ê?/ë³€?™ì„± ê¸°ì? ë²”ìœ„ ?´ì—???•í™•???˜ì¹˜ ?°ì •
   - VaR ëª¨ë¸ ?Œë¼ë¯¸í„° ì¡°ì •???„í•œ êµ¬ì²´??ë³€?™ë¥  ?œì‹œ
   - ?€???¸ë ˆ?´ë”© ?¬ì??˜ë³„ ?ìµ ê³„ì‚°???„í•œ ?œë‚˜ë¦¬ì˜¤ë³?ê°€ê²?ë³€????
   - ?¤ì? ?¬ì????¨ê³¼???€???•ë„ ë°?ì¶”ê? ?¤ì? ?„ìš” ê·œëª¨

2. ? ìš©ë¦¬ìŠ¤?¬í? (GPT3_credit) - ?„ì¬ ? ìš© ?„í™© ?°ê³„  
   [A4 ?”ì•½ ë¶„ì„ ?”êµ¬?¬í•­]
   - A4 ?”ì•½???œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤???¹ì…˜?ì„œ ? ìš© ê´€???„í—˜ ?”ì†Œ ì¶”ì¶œ
   - WORST ?œë‚˜ë¦¬ì˜¤ ê¸°ì´ˆ ?°ì´?°ì—??? ìš©ê²½ìƒ‰ ?¸ë¦¬ê±??”ì¸ ?Œì•…
   - ë¶€?™ì‚° ?œë‚˜ë¦¬ì˜¤?€ ?°ê³„???´ë³´ ê°€ì¹??˜ë½ ?í–¥ ë¶„ì„
   
   [êµ¬ì²´???œë‚˜ë¦¬ì˜¤ ?ì„±]
   - ?…ì¢…ë³??±ê¸‰ë³?ë¶€?„í™•ë¥?ë³€?”ìœ¨ (ê¸°ì? ë²”ìœ„ ?´ì—??ì°¨ë“± ?ìš©)
   - ë¶€?™ì‚° ?´ë³´ ê°€ì¹??˜ë½??LTV??ë¯¸ì¹˜??êµ¬ì²´???í–¥??
   - ? ìš©?¤í”„?ˆë“œ ?•ë? ??ë°??¬íŠ¸?´ë¦¬??? ìš©ë¹„ìš© ì¦ê? ê·œëª¨
   - ?€?•ì°¨ì£?ì§‘ì¤‘?…ì¢…ë³?ë¦¬ìŠ¤???¸ì¶œ??ë°??ì‹¤ ì¶”ì •

3. ALM?€ (GPT3_alm) - ALM.txt ?°ê³„
   [A4 ?”ì•½ ë¶„ì„ ?”êµ¬?¬í•­]
   - A4 ?”ì•½??ê¸ˆë¦¬ ê´€??WORST ?œë‚˜ë¦¬ì˜¤?ì„œ ALM ?í–¥ ?”ì†Œ ì¶”ì¶œ
   - ?„ì¬ ?œí™©?ì„œ ? ë™??ê´€??ì¡°ê¸°ê²½ë³´ ? í˜¸ ?Œì•…
   - ?ê¸ˆì¡°ë‹¬ ë¹„ìš© ?ìŠ¹ ?•ë ¥ ë°?ë§Œê¸° êµ¬ì¡° ì·¨ì•½??ë¶„ì„
   
   [êµ¬ì²´???œë‚˜ë¦¬ì˜¤ ?ì„±]
   - ê¸ˆë¦¬ ê¸‰ë?????ë°??€?ˆì´??ê°??í–¥???•ëŸ‰??
   - ?ˆê¸ˆ/ì°¨ì… ê¸ˆë¦¬ ?ìŠ¹ ??(ê¸°ì? ë²”ìœ„ ?´ì—??êµ¬ì²´??bp ?°ì •)
   - LCR/NSFR ë³€???•ë„ ë°?ê·œì œ ì¤€???„í—˜??
   - ?ì‚°ë°°ë¶„ ?¬ì¡°???„ìš” ê·œëª¨ ë°?ë¹„ìš©

4. ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í? (GPT3_global) - ê¸€ë¡œë²Œë¦¬ìŠ¤??txt ?°ê³„
   [A4 ?”ì•½ ë¶„ì„ ?”êµ¬?¬í•­]
   - A4 ?”ì•½??ê¸€ë¡œë²Œ ë¦¬ìŠ¤???”ì†Œ?ì„œ êµ??ë³?ì§€??³„ ?„í—˜??ì¶”ì¶œ
   - ?˜ìœ¨ ë³€???¸ë¦¬ê±?ë°?êµ? œ ?•ì¹˜/ê²½ì œ ë¶ˆì•ˆ?•ì„± ?”ì¸ ?Œì•…
   - ?´ì™¸ ?¬ì/?µìŠ¤?¬ì? ê´€??ì·¨ì•½??ì§€??ë¶„ì„
   
   [êµ¬ì²´???œë‚˜ë¦¬ì˜¤ ?ì„±]
   - ?µí™”ë³??˜ìœ¨ ë³€????(?¬ëŸ¬/? ë¡œ/???„ì•ˆë³?ì°¨ë“± ?ìš©)
   - ì£¼ìš”êµ?ê¸°ì?ê¸ˆë¦¬ ë³€???œë‚˜ë¦¬ì˜¤ ë°?êµ?‚´ ?Œê¸‰?¨ê³¼
   - ?´ì™¸ ?¬ì ?¬ì??˜ë³„ ?ì‹¤ ê·œëª¨ ë°??˜í—¤ì§€ ë¹„ìš© ì¦ê?
   - êµ?? ? ìš©?±ê¸‰ ë³€?????ê¸ˆì¡°ë‹¬ ?œì•½ ë°?ë¹„ìš© ?ìŠ¹ ??

5. ? ìš©?¬íŠ¸?´ë¦¬?¤í? (GPT3_creditpf) - ?¬íŠ¸?´ë¦¬??ì§‘ì¤‘???„í™© ?°ê³„
   [A4 ?”ì•½ ë¶„ì„ ?”êµ¬?¬í•­]
   - A4 ?”ì•½???¬íŠ¸?´ë¦¬??ê´€??ì§‘ì¤‘???„í—˜ ë°??ê?ê´€ê³??•ë³´ ì¶”ì¶œ
   - ?œë‚˜ë¦¬ì˜¤ë³??¹í„°/ì§€??ì§‘ì¤‘ ë¶€ë¬¸ì˜ ?™ë°˜ ë¶€??ê°€?¥ì„± ë¶„ì„
   - ë¶„ì‚°?¬ì ?¨ê³¼ ?ì‹¤ ?•ë„ ë°?ì§‘ì¤‘ë¦¬ìŠ¤???•ì‚° ê²½ë¡œ ?Œì•…
   
   [êµ¬ì²´???œë‚˜ë¦¬ì˜¤ ?ì„±]
   - ì§‘ì¤‘ ?¹í„°/ì§€??³„ ë¶€?¤ë¥  ì¦ê? ??(ì°¨ë³„???œë‚˜ë¦¬ì˜¤ ?ìš©)
   - ?€?•ì°¨ì£??™ë°˜ ë¶€???œë‚˜ë¦¬ì˜¤ (êµ¬ì²´??ì°¨ì£¼ ??ë°??ì‹¤ ê·œëª¨)
   - ?¬íŠ¸?´ë¦¬???ê?ê´€ê³?ë³€??(0.6~0.95 ë²”ìœ„ ??êµ¬ì²´???˜ì¹˜)
   - ë¦¬ìŠ¤??ë¶„ì‚° ?„ëµ ?¨ê³¼???€???•ë„ ë°??¬êµ¬???„ìš” ê·œëª¨

ì¶œë ¥ ?•ì‹ (ê°??„ë©”?¸ë³„):
1. WORST ?œë‚˜ë¦¬ì˜¤ êµ¬ì²´???˜ì¹˜ ë°?ë°œìƒ ê°€??
2. ?€???„í™©?ë£Œ?€ ?°ê³„???í–¥??ê³„ì‚° ë°©ë²•ë¡?
3. ?„ê¸°?í™© ?„ê°œ ê²½ë¡œ ë°??¨ê³„ë³??í–¥ ?œë??ˆì´???€
4. ëª¨ë‹ˆ?°ë§ ì§€??ë°?ì¡°ê¸°ê²½ë³´ ?œìŠ¤??êµ¬ì¶• ë°©í–¥
5. ?€???„ëµ ?˜ë¦½???„í•œ ?µì‹¬ ë³€??ë°??œë‚˜ë¦¬ì˜¤ ë¶„ì„ ?„ë ˆ?„ì›Œ??

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
        
        <div id="gpt2-output-box" class="gpt2-module-box" style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">GPT2 ì¶œë ¥ ê²°ê³¼</div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt2-output')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
        </div>
        <textarea id="gpt2-output"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="GPT2 ?„ë©”?¸ë³„ ë¶„ì„ ?ë£Œê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
      </div>

      <div class="agent-card gpt3-module-box" id="card-gpt3" data-card="gpt3">
        <h4>GPT3 ëª¨ë“ˆë³??„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?/h4>
        <div id="gpt3-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:flex-end;gap:6px;margin:6px 0 10px;">
          <button class="darkmode-toggle" style="padding:4px 10px;font-size:12px;" onclick="runGpt3All()">?¬ê¸°???¤í–‰</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-market-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-market-guideline').click()">ê°€?´ë“œ ë³€ê²?/button>
                <span id="gpt3-market-guideline-name" style="font-size:11px;color:#888;">?œì¥ë¦¬ìŠ¤??txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-market-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-market-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ ?œì¥ë¦¬ìŠ¤???„ë¬¸ê°€?…ë‹ˆ?? GPT2???œë‚˜ë¦¬ì˜¤?€ ?”ì†Œë³??•ë³´ë¥??œìš©?˜ì—¬ ?€???ì‹¤ê¸ˆì•¡???°ì¶œ?˜ê³  GPT4?ì„œ ë°”ë¡œ ?¬ìš© ê°€?¥í•œ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?©ë‹ˆ??

?µì‹¬ ?„ë¬´:
1. GPT2 ?œë‚˜ë¦¬ì˜¤ ?•ë³´?€ ?€???„í™©?ë£Œ(ê°€?´ë“œ ?Œì¼)ë¥?ê²°í•©???•í™•???ì‹¤ê¸ˆì•¡ ?°ì¶œ
2. ê¸ˆë¦¬/?˜ìœ¨/ì£¼ê?/ë³€?™ì„±ë³?êµ¬ì²´???í–¥??ê³„ì‚° ë°??•ëŸ‰??
3. GPT4 ë³´ê³ ?œì— ì§ì ‘ ?½ì… ê°€?¥í•œ ?„ê²°??ë¶„ì„ ë³´ê³ ???‘ì„±

ì¶œë ¥ ?•ì‹ (GPT4 ì§ì ‘ ?¬ìš©??:
## ?œì¥ë¦¬ìŠ¤?¬í? ?„ê¸°?í™© ?œë??ˆì´??ê²°ê³¼

### 1. ?œë‚˜ë¦¬ì˜¤ ?ìš© ê²°ê³¼
- ?ìš© ?œë‚˜ë¦¬ì˜¤: [GPT2?ì„œ ?œì‹œ??êµ¬ì²´???œë‚˜ë¦¬ì˜¤]
- ê¸ˆë¦¬ ë³€?? [Â±?‹â—‹bp] ???ì‹¤ ?í–¥: [?‹â—‹?µì›]
- ?˜ìœ¨ ë³€?? [Â±?‹â—‹%] ???ì‹¤ ?í–¥: [?‹â—‹?µì›]  
- ì£¼ê? ë³€?? [Â±?‹â—‹%] ???ì‹¤ ?í–¥: [?‹â—‹?µì›]
- ë³€?™ì„± ì¦ê?: [?‹â—‹%] ???¤ì?ë¹„ìš© ì¦ê?: [?‹â—‹?µì›]

### 2. ?¬íŠ¸?´ë¦¬?¤ë³„ ?ì‹¤ ë¶„ì„
- ì±„ê¶Œ ?¬íŠ¸?´ë¦¬???ì‹¤: [?‹â—‹?µì›] (?‰ê??ì‹¤ + ? ìš©?ì‹¤)
- ì£¼ì‹ ?¬ì ?ì‹¤: [?‹â—‹?µì›] (?œê?ì´ì•¡ ê¸°ì?)
- ?Œìƒ?í’ˆ ?ì‹¤: [?‹â—‹?µì›] (ë¯¸ì‹¤?„ì†???¬í•¨)
- ?¸í™˜ ?¬ì????ì‹¤: [?‹â—‹?µì›] (?˜ìœ¨ë³€???í–¥)
- **ì´??œì¥ë¦¬ìŠ¤???ì‹¤**: [?‹â—‹?µì›]

### 3. ë¦¬ìŠ¤??ì§€??ë³€??
- VaR (99%, 1??: [?„ì¬ ?‹â—‹?µì›] ??[?„ê¸°???‹â—‹?µì›]
- ?¤íŠ¸?ˆìŠ¤ VaR: [?‹â—‹?µì›] (?‹â—‹% ì¦ê?)
- ê¸ˆë¦¬ë¯¼ê°?? [BP01 ?‹â—‹ë°±ë§Œ?? ??[?‹â—‹ë°±ë§Œ??
- ?˜ìœ¨ë¯¼ê°?? [1% ë³€?™ì‹œ ?‹â—‹?µì› ?í–¥]

### 4. ê¸´ê¸‰ ?€??ë°©ì•ˆ
- ì¦‰ì‹œ ?¤í–‰: [êµ¬ì²´???¤ì? ?„ëµ ë°?ê·œëª¨]
- ?¨ê¸° ì¡°ì¹˜: [?¬ì???ì¶•ì†Œ/?¬ì¡°??ê³„íš]
- ì¤‘ê¸° ?„ëµ: [ë¦¬ìŠ¤???œë„ ?¬ì„¤??ë°©í–¥]

### 5. ëª¨ë‹ˆ?°ë§ ê³„íš
- ?¼ì¼ ?ê?: [?µì‹¬ ì§€??3-5ê°?
- ì£¼ê°„ ë³´ê³ : [ê²½ì˜ì§?ë³´ê³  ??ª©]
- ì¡°ê¸°ê²½ë³´: [?„ê³„ì¹?ë°??€???ˆì°¨]

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">?œì¥ë¦¬ìŠ¤??ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-market')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-market"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="?œì¥ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-credit-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-credit-guideline').click()">ê°€?´ë“œ ë³€ê²?/button>
                <span id="gpt3-credit-guideline-name" style="font-size:11px;color:#888;">? ìš©ë¦¬ìŠ¤??txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-credit-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-credit-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ ? ìš©ë¦¬ìŠ¤???„ë¬¸ê°€?…ë‹ˆ?? GPT2???œë‚˜ë¦¬ì˜¤?€ ?”ì†Œë³??•ë³´ë¥??œìš©?˜ì—¬ ?€??? ìš© ?ì‹¤ê¸ˆì•¡???°ì¶œ?˜ê³  GPT4?ì„œ ë°”ë¡œ ?¬ìš© ê°€?¥í•œ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?©ë‹ˆ??

?µì‹¬ ?„ë¬´:
1. GPT2 ? ìš© ?œë‚˜ë¦¬ì˜¤?€ ?€??? ìš© ?„í™©?ë£Œë¥?ê²°í•©???•í™•??? ìš©?ì‹¤ ?°ì¶œ
2. ?…ì¢…ë³??±ê¸‰ë³??´ë³´ë³?êµ¬ì²´??ë¶€?„ìœ¨ ë³€??ë°??ì‹¤ ê³„ì‚°
3. GPT4 ë³´ê³ ?œì— ì§ì ‘ ?½ì… ê°€?¥í•œ ?„ê²°??? ìš©ë¶„ì„ ë³´ê³ ???‘ì„±

ì¶œë ¥ ?•ì‹ (GPT4 ì§ì ‘ ?¬ìš©??:
## ? ìš©ë¦¬ìŠ¤?¬í? ?„ê¸°?í™© ?œë??ˆì´??ê²°ê³¼

### 1. ?œë‚˜ë¦¬ì˜¤ ?ìš© ê²°ê³¼
- ?ìš© ?œë‚˜ë¦¬ì˜¤: [GPT2?ì„œ ?œì‹œ??? ìš© ê´€??êµ¬ì²´???œë‚˜ë¦¬ì˜¤]
- ë¶€?„ìœ¨ ì¦ê?: [?…ì¢…ë³?+?‹â—‹%p] ???ˆìƒ?ì‹¤: [?‹â—‹?µì›]
- ? ìš©?¤í”„?ˆë“œ ?•ë?: [?±ê¸‰ë³?+?‹â—‹bp] ???‰ê??ì‹¤: [?‹â—‹?µì›]
- ë¶€?™ì‚° ?´ë³´ê°€ì¹??˜ë½: [-?‹â—‹%] ???´ë³´ë¶€ì¡? [?‹â—‹?µì›]
- ?€?•ì°¨ì£?ë¶€?? [?‹ê°œ ?…ì²´] ??ì§ì ‘?ì‹¤: [?‹â—‹?µì›]

### 2. ?¬íŠ¸?´ë¦¬?¤ë³„ ? ìš©?ì‹¤ ë¶„ì„
- ê¸°ì—…?€ì¶??ì‹¤: [?‹â—‹?µì›] (?¼ë°˜ê¸°ì—… ?‹â—‹?µì›, ì¤‘ì†Œê¸°ì—… ?‹â—‹?µì›)
- ë¶€?™ì‚°PF ?ì‹¤: [?‹â—‹?µì›] (?´ë³´ ë¶€ì¡±ë¶„ ?¬í•¨)
- ê°œì¸? ìš© ?ì‹¤: [?‹â—‹?µì›] (ì£¼íƒ?´ë³´ ?‹â—‹?µì›, ? ìš©?€ì¶??‹â—‹?µì›)
- ?Œì‚¬ì±??¬ì ?ì‹¤: [?‹â—‹?µì›] (? ìš©?ì‹¤ + ?‰ê??ì‹¤)
- **ì´?? ìš©ë¦¬ìŠ¤???ì‹¤**: [?‹â—‹?µì›]

### 3. ? ìš©ë¦¬ìŠ¤??ì§€??ë³€??
- ? ìš© VaR (99%, 1??: [?„ì¬ ?‹â—‹?µì›] ??[?„ê¸°???‹â—‹?µì›]
- ?ˆìƒ?ì‹¤ë¥?EL): [?„ì¬ ?‹â—‹%] ??[?„ê¸°???‹â—‹%]
- ë¹„ì •?ì—¬? ë¹„?? [?„ì¬ ?‹â—‹%] ??[?„ê¸°???‹â—‹%]
- ì¶©ë‹¹ê¸??ë¦½ë¥? [?„ì¬ ?‹â—‹%] ??[?„ìš” ?‹â—‹%]

### 4. ë¶€ë¬¸ë³„ ?€??ë°©ì•ˆ
- ì¦‰ì‹œ ì¡°ì¹˜: [? ìš©?œë„ ì¶•ì†Œ, ?´ë³´ ì¶”ê? ?•ë³´ ??
- ?¨ê¸° ?€?? [ë¶€?¤ì±„ê¶??•ë¦¬, ?„ë¡œë¹„ì „ ?•ë?]
- ì¤‘ê¸° ?„ëµ: [?¬íŠ¸?´ë¦¬???¬êµ¬?? ?…ì¢… ?¤ê°??

### 5. ? ìš© ëª¨ë‹ˆ?°ë§ ê°•í™” ê³„íš
- ?¼ì¼ ?ê?: [?€?•ì°¨ì£??‹â—‹ê°œì‚¬, ë¶€?™ì‚°PF ?‹â—‹ê±?
- ì£¼ê°„ ë¶„ì„: [?…ì¢…ë³?? ìš©??ë³€?? ?°ì²´??ì¶”ì´]
- ì¡°ê¸°ê²½ë³´: [? ìš©?±ê¸‰ ?˜ë½ ?„ê³„ì¹?ë°??€??ë§¤ë‰´??

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">? ìš©ë¦¬ìŠ¤??ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-credit')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-credit"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="? ìš©ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-alm-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-alm-guideline').click()">ê°€?´ë“œ ë³€ê²?/button>
                <span id="gpt3-alm-guideline-name" style="font-size:11px;color:#888;">ALM.txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-alm-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-alm-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ ALM(?ì‚°ë¶€ì±„ê?ë¦? ?„ë¬¸ê°€?…ë‹ˆ?? GPT2???œë‚˜ë¦¬ì˜¤?€ ?”ì†Œë³??•ë³´ë¥??œìš©?˜ì—¬ ?€??ALM ?ì‹¤ê¸ˆì•¡???°ì¶œ?˜ê³  GPT4?ì„œ ë°”ë¡œ ?¬ìš© ê°€?¥í•œ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?©ë‹ˆ??

?µì‹¬ ?„ë¬´:
1. GPT2 ALM ?œë‚˜ë¦¬ì˜¤?€ ?€???ì‚°ë¶€ì±??„í™©?ë£Œë¥?ê²°í•©???•í™•??ALM ?ì‹¤ ?°ì¶œ
2. ê¸ˆë¦¬/? ë™???€?ˆì´?˜ë³„ êµ¬ì²´???í–¥??ê³„ì‚° ë°??•ëŸ‰??
3. GPT4 ë³´ê³ ?œì— ì§ì ‘ ?½ì… ê°€?¥í•œ ?„ê²°??ALM ë¶„ì„ ë³´ê³ ???‘ì„±

ì¶œë ¥ ?•ì‹ (GPT4 ì§ì ‘ ?¬ìš©??:
## ALM?€ ?„ê¸°?í™© ?œë??ˆì´??ê²°ê³¼

### 1. ?œë‚˜ë¦¬ì˜¤ ?ìš© ê²°ê³¼
- ?ìš© ?œë‚˜ë¦¬ì˜¤: [GPT2?ì„œ ?œì‹œ??ALM ê´€??êµ¬ì²´???œë‚˜ë¦¬ì˜¤]
- ê¸ˆë¦¬ ë³€?? [Â±?‹â—‹bp] ???œì´?ì´???í–¥: [?‹â—‹?µì›]
- ?€?ˆì´??ê°? [?‹â—‹?? ???ê¸°?ë³¸ ?í–¥: [?‹â—‹?µì›]
- ?ê¸ˆì¡°ë‹¬ ë¹„ìš©: [+?‹â—‹bp] ??ì¶”ê? ë¹„ìš©: [?°ê°„ ?‹â—‹?µì›]
- ? ë™??ë¶€ì¡? [LCR ?‹â—‹%] ??ì¡°ë‹¬ ?„ìš”: [?‹â—‹?µì›]

### 2. ?ì‚°ë¶€ì±„ë³„ ?í–¥ ë¶„ì„
- ?€ì¶??¬íŠ¸?´ë¦¬?? [ê¸ˆë¦¬ ?¬ì‚°???í–¥ ?‹â—‹?µì›]
- ? ê?ì¦ê¶Œ ?¬íŠ¸?´ë¦¬?? [?€?ˆì´???„í—˜ ?‹â—‹?µì›]
- ?ˆê¸ˆ ë¶€ì±? [ê¸ˆë¦¬ ?ìŠ¹ ë¹„ìš© ?‹â—‹?µì›]
- ì°¨ì… ë¶€ì±? [?¬ì¡°???„í—˜ ?‹â—‹?µì›]
- **ì´?ALM ?ì‹¤/?í–¥**: [?‹â—‹?µì›]

### 3. ALM ë¦¬ìŠ¤??ì§€??ë³€??
- ?€?ˆì´??ê°? [?„ì¬ ?‹â—‹?? ??[?„ê¸°???‹â—‹??
- ê¸ˆë¦¬ ë¯¼ê°?? [100bp ë³€?™ì‹œ ?‹â—‹?µì› ?í–¥]
- LCR: [?„ì¬ ?‹â—‹%] ??[?„ê¸°???‹â—‹%]
- NSFR: [?„ì¬ ?‹â—‹%] ??[?„ê¸°???‹â—‹%]

### 4. ALM ?€???„ëµ
- ì¦‰ì‹œ ì¡°ì¹˜: [?€?ˆì´??ê°?ì¡°ì •, ? ë™???•ë³´]
- ?¨ê¸° ?€?? [?ì‚°ë°°ë¶„ ?¬ì¡°?? ë¶€ì±?ë§Œê¸° ?°ì¥]
- ì¤‘ê¸° ?„ëµ: [ALM ?œë„ ?¬ì„¤?? ?¤ì? ?„ëµ ê°•í™”]

### 5. ? ë™??ê´€ë¦?ê³„íš
- ?¼ì¼ ëª¨ë‹ˆ?°ë§: [?„ê¸ˆ?ë¦„, ?€??ë§Œê¸°?„ë˜ ?„í™©]
- ì£¼ê°„ ?ê?: [LCR/NSFR ì¶”ì´, ?ê¸ˆì¡°ë‹¬ ê³„íš]
- ë¹„ìƒ ?€?? [Central Bank ì§€?? ?ì‚° ? ë™??ë°©ì•ˆ]

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ALM ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-alm')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-alm"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ALM ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-global-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-global-guideline').click()">ê°€?´ë“œ ë³€ê²?/button>
                <span id="gpt3-global-guideline-name" style="font-size:11px;color:#888;">ê¸€ë¡œë²Œë¦¬ìŠ¤??txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-global-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-global-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ ê¸€ë¡œë²Œë¦¬ìŠ¤???„ë¬¸ê°€?…ë‹ˆ?? GPT2???œë‚˜ë¦¬ì˜¤?€ ?”ì†Œë³??•ë³´ë¥??œìš©?˜ì—¬ ?€??ê¸€ë¡œë²Œ ?ì‹¤ê¸ˆì•¡???°ì¶œ?˜ê³  GPT4?ì„œ ë°”ë¡œ ?¬ìš© ê°€?¥í•œ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?©ë‹ˆ??

?µì‹¬ ?„ë¬´:
1. GPT2 ê¸€ë¡œë²Œ ?œë‚˜ë¦¬ì˜¤?€ ?€???´ì™¸ ?µìŠ¤?¬ì? ?„í™©?ë£Œë¥?ê²°í•©???•í™•??ê¸€ë¡œë²Œ ?ì‹¤ ?°ì¶œ
2. êµ??ë³??µí™”ë³?ì§€??³„ êµ¬ì²´???í–¥??ê³„ì‚° ë°??•ëŸ‰??
3. GPT4 ë³´ê³ ?œì— ì§ì ‘ ?½ì… ê°€?¥í•œ ?„ê²°??ê¸€ë¡œë²Œ ë¶„ì„ ë³´ê³ ???‘ì„±

ì¶œë ¥ ?•ì‹ (GPT4 ì§ì ‘ ?¬ìš©??:
## ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í? ?„ê¸°?í™© ?œë??ˆì´??ê²°ê³¼

### 1. ?œë‚˜ë¦¬ì˜¤ ?ìš© ê²°ê³¼
- ?ìš© ?œë‚˜ë¦¬ì˜¤: [GPT2?ì„œ ?œì‹œ??ê¸€ë¡œë²Œ ê´€??êµ¬ì²´???œë‚˜ë¦¬ì˜¤]
- ?˜ìœ¨ ë³€?? [?µí™”ë³?Â±?‹â—‹%] ???˜ì°¨?ì‹¤: [?‹â—‹?µì›]
- êµ?? ? ìš©?±ê¸‰ ?˜ë½: [?‹ê°œêµ??‹ë“±ê¸? ???‰ê??ì‹¤: [?‹â—‹?µì›]
- ?•ì¹˜??ë¶ˆì•ˆ?? [ì§€??³„ ?„í—˜?? ???„ë¦¬ë¯¸ì—„ ì¦ê?: [?‹â—‹?µì›]
- ?´ì™¸ ?ì‚° ?ì‹¤: [êµ??ë³??µìŠ¤?¬ì?] ??ì§ì ‘?ì‹¤: [?‹â—‹?µì›]

### 2. ì§€??³„/êµ??ë³??ì‹¤ ë¶„ì„
- ë¯¸êµ­ ?µìŠ¤?¬ì?: [?‹â—‹?µì›] ???ˆìƒ?ì‹¤: [?‹â—‹?µì›]
- ? ëŸ½ ?µìŠ¤?¬ì?: [?‹â—‹?µì›] ???ˆìƒ?ì‹¤: [?‹â—‹?µì›]
- ì¤‘êµ­ ?µìŠ¤?¬ì?: [?‹â—‹?µì›] ???ˆìƒ?ì‹¤: [?‹â—‹?µì›]
- ê¸°í? ? í¥êµ? [?‹â—‹?µì›] ???ˆìƒ?ì‹¤: [?‹â—‹?µì›]
- **ì´?ê¸€ë¡œë²Œë¦¬ìŠ¤???ì‹¤**: [?‹â—‹?µì›]

### 3. ê¸€ë¡œë²Œë¦¬ìŠ¤??ì§€??ë³€??
- êµ??ë¦¬ìŠ¤??VaR: [?„ì¬ ?‹â—‹?µì›] ??[?„ê¸°???‹â—‹?µì›]
- ?˜ìœ¨ VaR: [?„ì¬ ?‹â—‹?µì›] ??[?„ê¸°???‹â—‹?µì›]
- ?´ì™¸ ?µìŠ¤?¬ì? ë¹„ìœ¨: [ì´ì???€ë¹??‹â—‹%]
- ?˜í—¤ì§€ ë¹„ìœ¨: [?„ì¬ ?‹â—‹%] ??[ëª©í‘œ ?‹â—‹%]

### 4. ê¸€ë¡œë²Œ ?€???„ëµ
- ì¦‰ì‹œ ì¡°ì¹˜: [?˜í—¤ì§€ ?•ë?, ê³ ìœ„?˜êµ­ ?µìŠ¤?¬ì? ì¶•ì†Œ]
- ?¨ê¸° ?€?? [êµ??ë³??œë„ ?¬ì¡°?? ? ìš©ë³´ê°• ?•ë?]
- ì¤‘ê¸° ?„ëµ: [ì§€???¤ê°?? ?ˆì „?ì‚° ë¹„ì¤‘ ?•ë?]

### 5. ê¸€ë¡œë²Œ ëª¨ë‹ˆ?°ë§ ê³„íš
- ?¼ì¼ ì¶”ì : [ì£¼ìš” ?µí™” ?˜ìœ¨, êµ??ë³?CDS ?¤í”„?ˆë“œ]
- ì£¼ê°„ ?ê?: [ì§€?•í•™??ë¦¬ìŠ¤?? ?•ì¹˜ ?´ë²¤???¬ë ¥]
- ?”ê°„ ?‰ê?: [êµ??ë³??µìŠ¤?¬ì? ?¬ê??? ?œë„ ì¡°ì •]

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">ê¸€ë¡œë²Œë¦¬ìŠ¤??ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-global')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-global"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="file" id="gpt3-creditpf-guideline" accept=".txt" style="display:none;" />
                <button class="darkmode-toggle" style="padding:4px 8px;font-size:12px;" onclick="document.getElementById('gpt3-creditpf-guideline').click()">ê°€?´ë“œ ë³€ê²?/button>
                <span id="gpt3-creditpf-guideline-name" style="font-size:11px;color:#888;">? ìš©?¬íŠ¸?´ë¦¬??txt</span>
              </div>
                              <button class="darkmode-toggle copy-btn" style="padding:4px 8px;font-size:12px;" onclick="copyText('gpt3-creditpf-system')">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-creditpf-system" style="width:100%;height:80px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ ? ìš©?¬íŠ¸?´ë¦¬???„ë¬¸ê°€?…ë‹ˆ?? GPT2???œë‚˜ë¦¬ì˜¤?€ ?”ì†Œë³??•ë³´ë¥??œìš©?˜ì—¬ ?€???¬íŠ¸?´ë¦¬???ì‹¤ê¸ˆì•¡???°ì¶œ?˜ê³  GPT4?ì„œ ë°”ë¡œ ?¬ìš© ê°€?¥í•œ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?©ë‹ˆ??

?µì‹¬ ?„ë¬´:
1. GPT2 ?¬íŠ¸?´ë¦¬???œë‚˜ë¦¬ì˜¤?€ ?€???¬íŠ¸?´ë¦¬??ì§‘ì¤‘???„í™©?ë£Œë¥?ê²°í•©???•í™•??ì§‘ì¤‘ë¦¬ìŠ¤???ì‹¤ ?°ì¶œ
2. ?…ì¢…ë³?ì§€??³„/ì°¨ì£¼ë³?êµ¬ì²´???í–¥??ê³„ì‚° ë°??•ëŸ‰??
3. GPT4 ë³´ê³ ?œì— ì§ì ‘ ?½ì… ê°€?¥í•œ ?„ê²°???¬íŠ¸?´ë¦¬??ë¶„ì„ ë³´ê³ ???‘ì„±

ì¶œë ¥ ?•ì‹ (GPT4 ì§ì ‘ ?¬ìš©??:
## ? ìš©?¬íŠ¸?´ë¦¬?¤í? ?„ê¸°?í™© ?œë??ˆì´??ê²°ê³¼

### 1. ?œë‚˜ë¦¬ì˜¤ ?ìš© ê²°ê³¼
- ?ìš© ?œë‚˜ë¦¬ì˜¤: [GPT2?ì„œ ?œì‹œ???¬íŠ¸?´ë¦¬??ê´€??êµ¬ì²´???œë‚˜ë¦¬ì˜¤]
- ì§‘ì¤‘ ?…ì¢… ë¶€?? [ê±´ì„¤/ë¶€?™ì‚° ?‹â—‹%] ???ì‹¤: [?‹â—‹?µì›]
- ?€?•ì°¨ì£?ë¶€?? [?ìœ„ ?‹ê°œ?? ???ì‹¤: [?‹â—‹?µì›]
- ì§€??ì§‘ì¤‘ ?ì‹¤: [?˜ë„ê¶??‹â—‹%] ???ì‹¤: [?‹â—‹?µì›]
- ?ê?ê´€ê³?ê¸‰ì¦: [0.?‹â†’0.?? ??ë¶„ì‚°?¨ê³¼ ?ì‹¤: [?‹â—‹?µì›]

### 2. ì§‘ì¤‘?„ë³„ ?ì‹¤ ë¶„ì„
- ?…ì¢… ì§‘ì¤‘???ì‹¤: [ê±´ì„¤ ?‹â—‹?µì›, ë¶€?™ì‚° ?‹â—‹?µì›, ?œì¡°???‹â—‹?µì›]
- ì§€??ì§‘ì¤‘???ì‹¤: [?œìš¸ ?‹â—‹?µì›, ê²½ê¸° ?‹â—‹?µì›, ì§€ë°??‹â—‹?µì›]
- ì°¨ì£¼ ì§‘ì¤‘???ì‹¤: [?€???‹â—‹?µì›, ì¤‘í˜• ?‹â—‹?µì›, ?Œí˜• ?‹â—‹?µì›]
- ?´ë³´ ì§‘ì¤‘???ì‹¤: [ë¶€?™ì‚°?´ë³´ ?‹â—‹?µì›, ë¬´ë‹´ë³??‹â—‹?µì›]
- **ì´??¬íŠ¸?´ë¦¬??ì§‘ì¤‘ë¦¬ìŠ¤???ì‹¤**: [?‹â—‹?µì›]

### 3. ?¬íŠ¸?´ë¦¬??ë¦¬ìŠ¤??ì§€??ë³€??
- ?¬íŠ¸?´ë¦¬??VaR: [?„ì¬ ?‹â—‹?µì›] ??[?„ê¸°???‹â—‹?µì›]
- ì§‘ì¤‘??ì§€??HHI): [?„ì¬ ?‹â—‹] ??[?„ê¸°???‹â—‹]
- ?ê?ê´€ê³??‰ê· : [?„ì¬ 0.?? ??[?„ê¸°??0.??
- ë¶„ì‚°?¬ì ?¨ê³¼: [?„ì¬ ?‹â—‹%] ??[?„ê¸°???‹â—‹%]

### 4. ?¬íŠ¸?´ë¦¬???¬êµ¬???„ëµ
- ì¦‰ì‹œ ì¡°ì¹˜: [ê³ ì§‘ì¤??¹í„° ? ê·œ ì¤‘ë‹¨, ê¸°ì¡´ ?µìŠ¤?¬ì? ì¶•ì†Œ]
- ?¨ê¸° ?€?? [?…ì¢…ë³??œë„ ?¬ë°°ë¶? ì§€???¤ê°??
- ì¤‘ê¸° ?„ëµ: [?¬íŠ¸?´ë¦¬??ìµœì ?? ? ê·œ ?œì¥ ê°œì²™]

### 5. ì§‘ì¤‘??ëª¨ë‹ˆ?°ë§ ê³„íš
- ?¼ì¼ ê´€ë¦? [?€?•ì°¨ì£??‹â—‹ê°œì‚¬ ? ìš©??ë³€??
- ì£¼ê°„ ë¶„ì„: [?…ì¢…ë³?ì§€??³„ ?µìŠ¤?¬ì? ë³€??ì¶”ì´]
- ?”ê°„ ?¬ê??? [ì§‘ì¤‘???œë„ ì¤€???„í™©, ?¬ë°°ë¶?ê³„íš]

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
                              <div class="prompt-text" style="font-weight:600;font-size:11px;">? ìš©?¬íŠ¸?´ë¦¬??ì¶œë ¥ ê²°ê³¼</div>
                              <button class="darkmode-toggle copy-btn" onclick="copyText('gpt3-creditpf')" style="padding:2px 6px;font-size:10px;">ë³µì‚¬</button>
            </div>
            <textarea id="gpt3-creditpf"
  style="width:100%;height:200px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;overflow:auto;"
  placeholder="? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
          </div>
        </div>
      </div>

      <!-- ???µì»¤ë¥?ì¹´ë“œ ë°”ê¹¥(ë°”ë¡œ ???¼ë¡œ ?´ë™?? ?´ì „ ì¹´ë“œ?€???œê°??ê²¹ì¹¨??ë°©ì? -->
      <div class="gpt4-anchor"></div>
      <div class="agent-card gpt4-module-box" id="card-gpt4" data-card="gpt4">
        <h4>GPT4 ëª¨ë“ˆë³??„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?/h4>
        <div id="gpt4-suggest" class="prompt-suggestion"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 4px;">
                      <div class="prompt-text" style="font-weight:600;font-size:12px;">GPT4 ?œìŠ¤???„ë¡¬?„íŠ¸</div>
          <div style="display:flex;gap:6px;">
                            <button class="darkmode-toggle copy-btn" onclick="copyText('gpt4-system')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            <button class="darkmode-toggle" onclick="runFrom('gpt4')" style="padding:4px 10px;font-size:12px;">?¬ê¸°???¤í–‰</button>
        </div>
      </div>
        <textarea id="gpt4-system" style="width:100%;height:360px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" readonly>?¹ì‹ ?€ ê¸ˆìœµ ë¦¬ìŠ¤??ê´€ë¦??„ë¬¸ê°€?´ì ë³´ê³ ???‘ì„± ?„ë¬¸ê°€?…ë‹ˆ?? GPT0ë¶€??GPT3ê¹Œì???ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥?ì¢…í•©?˜ì—¬ ì²´ê³„?ì¸ ?„ê¸°?í™© ë¶„ì„ ë³´ê³ ?œë? ?‘ì„±?©ë‹ˆ??

??• :
- ???¤ì´ë¸?ë¶„ì„ ?˜ì? ?‘ì„±???œë‚˜ë¦¬ì˜¤ ë°?ë§ˆì¼“?°ì´??ë¶„ì„ ê²°ê³¼ ì¢…í•©
- ?µí•© ?•ì œ ?°ì´???œìš©
- ?„ë©”?¸ë³„ WORST ?œë‚˜ë¦¬ì˜¤ ë°?ë§ì¶¤??ë¶„ì„ ?ë£Œ ?µí•©
- ê°?ëª¨ë“ˆë³??„ê¸°?í™© ?œë??ˆì´??ê²°ê³¼ ì¢…í•©
- ?€???„í™©ê³??„ê¸°?í™©???°ê³„??ì²´ê³„?ì¸ ë³´ê³ ???‘ì„±

ë³´ê³ ??êµ¬ì¡° ?”êµ¬?¬í•­:

1. ?œë‚˜ë¦¬ì˜¤ ?•ë³´ ë°??„ì¬ ?í™©
   - ? íƒ???œë‚˜ë¦¬ì˜¤ ê°œìš” ë°??µì‹¬ ê°€??
   - ?„ì¬ ?œì¥ ?í™© ë°?ê²½ì œ ?˜ê²½ ë¶„ì„
   - ?œë‚˜ë¦¬ì˜¤ ë°œìƒ ê°€?¥ì„± ë°??¸ë¦¬ê±??”ì¸

2. ?„ê¸°?í™© ?œë??ˆì´??ê°€??
   - GPT2?ì„œ ?ì„±??WORST ?œë‚˜ë¦¬ì˜¤ ?”ì•½
   - ê°??„ë©”?¸ë³„ ?„ê¸°?í™© ?œë‚˜ë¦¬ì˜¤ ?„ê°œ ê²½ë¡œ
   - ?œë‚˜ë¦¬ì˜¤ë³??í–¥??ë°??ì‹¤ ê·œëª¨ ì¶”ì •

3. ëª¨ë“ˆë³??„ê¸°?í™© ë¶„ì„ ê²°ê³¼
   - ?œì¥ë¦¬ìŠ¤?¬í?: ê¸ˆë¦¬/?˜ìœ¨/ì£¼ê? ë³€?™ì„± ?í–¥??
   - ? ìš©ë¦¬ìŠ¤?¬í?: ? ìš©???˜ë½ ë°?ë¶€???„í—˜ ?í–¥??
   - ALM?€: ?ì‚°ë¶€ì±?ë§Œê¸° ë¶ˆì¼ì¹?ë°?? ë™???„í—˜
   - ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í?: êµ?? ë¦¬ìŠ¤??ë°??•ì¹˜??ë¶ˆì•ˆ?•ì„±
   - ? ìš©?¬íŠ¸?´ë¦¬?¤í?: ?¬íŠ¸?´ë¦¬??ì§‘ì¤‘??ë°??ê?ê´€ê³??„í—˜

4. ì¢…í•© ?í–¥???‰ê?
   - ?„ì²´ ?¬íŠ¸?´ë¦¬?¤ì— ë¯¸ì¹˜??ì¢…í•©???í–¥
   - ë¦¬ìŠ¤???„íŒŒ ê²½ë¡œ ë°??°ì‡„ ?¨ê³¼ ë¶„ì„
   - ?€??ê±´ì „??ì§€??ë³€???ˆì¸¡

5. ?€???„ëµ ë°?ê¶Œê³ ?¬í•­
   - ì¦‰ì‹œ ?€?‘ì´ ?„ìš”??ê¸´ê¸‰ ì¡°ì¹˜?¬í•­
   - ?¨ê¸°/ì¤‘ê¸° ë¦¬ìŠ¤??ê´€ë¦?ë°©ì•ˆ
   - ?¬íŠ¸?´ë¦¬??ìµœì ??ë°??¤ì? ?„ëµ

ì¶œë ¥ ?•ì‹:
- ì²´ê³„?ì´ê³??¼ë¦¬?ì¸ êµ¬ì¡°
- ?•ëŸ‰??ë¶„ì„ ê²°ê³¼?€ ?•ì„±???¸ì‚¬?´íŠ¸ ë³‘í–‰
- ?˜ì‚¬ê²°ì •???œìš©?????ˆëŠ” ?¤ìš©???•ë³´
- ëª…í™•???¡ì…˜ ?„ì´?œê³¼ ?°ì„ ?œìœ„ ?œì‹œ

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.</textarea>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px;">
          <div style="font-weight:600;">GPT4 ìµœì¢… ë³´ê³ ??/div>
                          <button class="darkmode-toggle copy-btn" onclick="copyText('gpt4-output')" style="padding:2px 8px;font-size:11px;">ë³µì‚¬</button>
            </div>
        <textarea id="gpt4-output" style="width:100%;height:600px;background:var(--main-bg);color:var(--main-text);border:1px solid var(--border);border-radius:6px;padding:6px;box-sizing:border-box;resize:vertical;" placeholder="GPT4 ìµœì¢… ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??.."></textarea>
          </div>

      

      <!-- ë³´ê³ ??ê´€??ë²„íŠ¼ -->
      <div id="report-actions" style="display:flex; gap:6px; margin-top: 20px; justify-content: center; padding: 8px 0; border-top: 1px solid var(--border);">
        <button class="darkmode-toggle action-btn" id="btn-export-ppt" onclick="generatePPTFromFinalReport()" style="display: none;">PPTì¶œë ¥</button>
        <div style="border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px;background:var(--main-bg);flex:1;">
          <button class="darkmode-toggle action-btn" id="btn-view-report" onclick="showHtmlReport()" title="?ì„±??HTML ë³´ê³ ??ë³´ê¸°" style="width:100%;padding:8px 12px;background:linear-gradient(135deg, #4a90e2, #357abd); color:white; font-weight:600;border:none;border-radius:6px;cursor:pointer;">ë³´ê³ ?œë³´ê¸?/button>
        </div>
      </div>
    </aside>
    <button id="pipeline-execute-btn" class="darkmode-toggle" style="position:fixed;right:12px;top:64px;z-index:1500;display:none;padding:6px 10px;font-weight:600;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);background:linear-gradient(135deg, #4a90e2, #357abd);border:none;color:white;font-size:12px;cursor:pointer;transform: scale(0.7); transform-origin: top right;">?? ?Œì´?„ë¼??/button>
  </div>

  <!-- ?ì´?„íŠ¸ ë²„ë¸” ?¤ë²„?ˆì´ -->
  <!-- ë²„ë¸” UI ?œê±° -->
  
  <!-- PDF ëª¨ë‹¬ -->
  <div id="pdf-modal" class="pdf-modal">
    <div class="pdf-container">
      <div class="pdf-header">
        <div class="pdf-title" id="pdf-title">?œë‚˜ë¦¬ì˜¤ ?ì„¸ ë³´ê³ ??/div>
        <button class="pdf-close" onclick="closePdfModal()">&times;</button>
      </div>
      <iframe id="pdf-frame" class="pdf-frame" src=""></iframe>
    </div>
  </div>
  
  <!-- ?´ìŠ¤ ëª¨ë‹¬ (ê¸°ì‚¬ ?ì—…) -->
  <div id="news-modal" class="pdf-modal">
    <div class="pdf-container">
      <div class="pdf-header">
        <div class="pdf-title" id="news-title">ê´€??ê¸°ì‚¬</div>
        <button class="pdf-close" onclick="closeNewsModal()">&times;</button>
      </div>
      <iframe id="news-frame" class="pdf-frame" src=""></iframe>
    </div>
  </div>

  <!-- ì°¨íŠ¸ ëª¨ë‹¬ (?µí•© ?€?œë³´?? -->
  <div id="chart-modal" class="pdf-modal">
    <div class="pdf-container" style="max-width: 95%; max-height: 95%;">
      <div class="pdf-header">
        <div class="pdf-title" id="chart-title">?œê³„??ì°¨íŠ¸</div>
        <button class="pdf-close" onclick="closeChartModal()">&times;</button>
      </div>
      <div id="chart-dashboard" style="padding: 20px; height: calc(100% - 80px); overflow-y: auto; background: var(--main-bg);">
        
        <!-- ?ë‹¨: ì§€???•ë³´ ?”ì•½ -->
        <div id="indicator-summary" style="padding: 15px; background: var(--card-bg); border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
          <h3 id="indicator-name" style="margin: 0 0 10px 0; font-size: 18px; color: var(--main-text);"></h3>
          <div id="indicator-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <!-- ?™ì ?¼ë¡œ ?ì„±???µê³„ ?•ë³´ -->
          </div>
        </div>

        <!-- ì¤‘ë‹¨: ê·¸ë˜???ì—­ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          
          <!-- ì¢Œì¸¡: ?œê³„??ê·¸ë˜??+ ?„ê³„ì¹?-->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--main-text);">?œê³„??ì¶”ì´ & ?„ê³„ì¹?/h4>
            <div style="position: relative; height: 400px;">
              <canvas id="timeseries-chart"></canvas>
            </div>
          </div>

          <!-- ?°ì¸¡: ë³€?™ì„± ê·¸ë˜??-->
          <div style="background: var(--card-bg); border-radius: 8px; padding: 15px; border: 1px solid var(--border);">
            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--main-text);">ë³€?™ì„± ë¶„ì„</h4>
            <div style="position: relative; height: 400px;">
              <canvas id="volatility-chart"></canvas>
            </div>
          </div>

        </div>

        <!-- ?˜ë‹¨: ë¦¬ìŠ¤??ë¶„ì„ ?”ì•½ -->
        <div id="risk-analysis" style="padding: 15px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border);">
          <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--main-text);">ë¦¬ìŠ¤??ë¶„ì„ ?”ì•½</h4>
          <div id="risk-content" style="font-size: 14px; line-height: 1.8; color: var(--main-text);">
            <!-- ?™ì ?¼ë¡œ ?ì„±??ë¦¬ìŠ¤??ë¶„ì„ ?´ìš© -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- HTML ?ì„± ëª¨ë‹¬ -->
  <div id="html-modal" class="pdf-modal">
    <div class="pdf-container">
      <div style="padding:20px;background:#fff;border-radius:8px;max-width:90%;max-height:90%;overflow:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <h3>GPT-4 ê¸°ë°˜ HTML ë³´ê³ ???ì„±</h3>
          <button onclick="closeHTMLModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">Ã—</button>
        </div>
        <div id="html-status" style="margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:4px;display:none;">
          GPT-4 ê¸°ë°˜ HTML ë³´ê³ ???ì„± ì¤?..
        </div>
        <div id="html-preview" style="margin-bottom:15px;max-height:400px;overflow:auto;border:1px solid #ddd;padding:10px;background:#f9f9f9;font-family:monospace;font-size:12px;white-space:pre-wrap;">
          ?ì„±??HTML ì½”ë“œê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button class="darkmode-toggle" onclick="downloadHTML()">HTML ?¤ìš´ë¡œë“œ</button>
          <button class="darkmode-toggle" onclick="copyHTMLCode()">ì½”ë“œ ë³µì‚¬</button>
          <button class="darkmode-toggle" onclick="previewHTML()">ë¯¸ë¦¬ë³´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë³´ê³ ???œì‹œ ëª¨ë‹¬ -->
  <div id="html-report-modal" class="pdf-modal">
    <div class="pdf-container">
      <div class="pdf-header">
        <span class="pdf-title">GPT4 ë³´ê³ ??/span>
        <button class="pdf-close" onclick="closeHtmlReport()">Ã—</button>
      </div>
      <iframe id="html-report-frame" class="pdf-frame"></iframe>
    </div>
  </div>
  <script>
    // ==== [A] ê³µí†µ ?€?‰í„°/?¬í¼ ====
    window.__FX = {
      // ???¨ê³¼???°ëŠ” ?µì»¤?€ ë°•ìŠ¤(class/id???„ë¡œ?íŠ¸??ë§ì¶° ?´ë? ì¡´ì¬?˜ëŠ” ê°??¬ìš©)
      anchors: {
        gpt1: '.gpt1-anchor',
        gpt2: '.gpt2-anchor',
        gpt3: '.gpt3-anchor',        // ?¸ë? ?ŒíŠ¸ê°€ ?˜ë‰˜ë©?ê³µí†µ ?˜í¼ ?µì»¤ë¡??°ê²°
        gpt4: '.gpt4-anchor',
      },
      boxes: {
        gpt1: '.gpt1-module-box',
        gpt2: '.gpt2-module-box',
        gpt3: '.gpt3-module-box',
        gpt4: '.gpt4-module-box',
      }
    };

    // ?¤í¬ë¡?? í‹¸
    window.scrollAnchorIntoView = function(sel, offset = -20) {
      const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel'); // ?°ì¸¡ ?¨ë„ ? íƒ??ì¤?ê¸°ì¡´ ê²?
      const el = document.querySelector(sel);
      if (!panel || !el) return;
      const y = Math.max(0, (el.offsetTop || 0) + offset);
      panel.scrollTo({ top: y, behavior: 'smooth' });
    };

    window.scrollToBetween = function(aSel, bSel) {
      const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel');
      const a = document.querySelector(aSel);
      const b = document.querySelector(bSel);
      if (!panel || !a || !b) return;
      const mid = Math.max(0, ((a.offsetTop || 0) + (b.offsetTop || 0)) / 2 - 40);
      panel.scrollTo({ top: mid, behavior: 'smooth' });
    };

    // ????ë°•ìŠ¤ ?¨ê³¼ ? ê?(?„ë¡œ?íŠ¸???ˆëŠ” ê¸°ì¡´ ?¨ìˆ˜?€ ?°ê²°)
    window.setFx = {
      on(selList)  { document.querySelectorAll(selList.join(',')).forEach(el => el.classList.add('pipeline-executing')); },
      off(selList) { document.querySelectorAll(selList.join(',')).forEach(el => el.classList.remove('pipeline-executing')); }
    };
    // setRightTabRunning(ë³´ì´????ê°•ì¡°), setFlow(? íš¨ê³???ê¸°ì¡´ ?¨ìˆ˜ê°€ ?ˆë‹¤ê³?ê°€??

    // ==== [B] ?¨ê³¼ ë¦¬ìŠ¤??(?¸ë¦¬ê±?= CustomEvent) ====

    // gpt1Â·gpt2 ?™ì‹œ ê°•ì¡°(?”êµ¬?¬í•­: gpt3 ?¤í–‰ ??êµ¬ê°„)
    window.addEventListener('gpt1:start', () => {
      try {
        const A = window.__FX.anchors, B = window.__FX.boxes;
        window.setRightTabRunning?.([A.gpt1, A.gpt2], [A.gpt3, A.gpt4]);
        window.setFx.on([B.gpt1, B.gpt2]);
        
        // gpt1:start ????ê°•ì¡° ?´ë°± ì¶”ê?
        const line = document.querySelector('.pipeline-line.to-gpt1') ||
                     document.querySelector('[data-to="gpt1"]');
        if (line) {
          line.classList.add('flow');
        } else {
          // ?¼ì¸???¤ì œë¡??†ë‹¤ë©? gpt1 ?µì»¤ë¥?ê°•í•˜ê²??˜ì´?¼ì´??
          document.querySelectorAll('.gpt1-anchor').forEach(el => el.classList.add('agent-running'));
          setTimeout(()=> document.querySelectorAll('.gpt1-anchor')
            .forEach(el => el.classList.remove('agent-running')), 1800);
        }
        
        window.setFlow?.('.to-gpt1, .to-gpt2');
        window.scrollToBetween?.(A.gpt1, A.gpt2);
      } catch(_) {}
    });
    window.addEventListener('gpt2:start', () => {
      // ?¼ì¸: gpt2ë§??¨ì¼ ?œì„±??(ë¶ˆí•„???¼ì„  ?œê±°)
      if (window.setFlow) window.setFlow('.to-gpt2');
      else if (window.highlightEdge) window.highlightEdge('.to-gpt2');
      else {
        try {
          d3.selectAll('.pipeline-line').classed('flow', false);
          d3.selectAll('.to-gpt2').classed('flow', true);
        } catch(_) {}
      }

      // ?¤í¬ë¡? êµ¬ê°„ ?¬ì´ ???€???µì»¤ ì¤‘ì‹¬ ?•ë ¬
      if (window.scrollAnchorIntoView) window.scrollAnchorIntoView('.gpt2-anchor');
      else scrollIntoViewIfNeeded('#card-gpt2'); // ? í‹¸ êµì²´ë¡??¨ë„ ì¤‘ì•™ ?•ë ¬
    });

    // gpt3 ?œì‘ ?? GPT2 ?¨ê³¼ 4ë¶?? ì? ??GPT3 ?¨ê³¼ ?œì‘
    window.addEventListener('gpt3:start', () => {
      console.log('?? GPT3 ?œì‘ - GPT2 ?¨ê³¼ 4ë¶?? ì? ??GPT3 ?¨ê³¼ ?œì‘');
      
      // GPT4 ?´ìƒ ?¨ê³„?ì„œ??gpt3 ?´ë²¤??ë¬´ì‹œ (?ˆì´???œê±°)
      if (typeof currentStep !== 'undefined' && currentStep >= 4) return;

      const A = window.__FX.anchors, B = window.__FX.boxes;
      
      // GPT3 ì§€???¨ê³¼ë¥??„í•œ ?€?´ë¨¸ ID ?€??(GPT4?ì„œ ì·¨ì†Œ??
      window.gpt3DelayedEffectTimer = setTimeout(() => {
        // GPT2 ì§€???¨ê³¼ ?œê±°
        if (window.gpt2PersistentEffects && window.gpt2PersistentEffects.active) {
          const { card, title } = window.gpt2PersistentEffects;
          if (card) {
            card.classList.remove('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
          }
          if (title) {
            title.classList.remove('text-highlight');
            title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?;
          }
          window.gpt2PersistentEffects.active = false;
          console.log('?‰ GPT2 ì§€???¨ê³¼ ?œê±° ?„ë£Œ (GPT3 ?œì‘ ??4ë¶?');
        }
        
        // GPT3 ?¨ê³¼ ON
        window.setRightTabRunning?.([A.gpt3], [A.gpt4]);
        window.setFx.on([B.gpt3]);

        if (window.setFlow) window.setFlow('.to-gpt3');
        else if (window.highlightEdge) window.highlightEdge('.to-gpt3');
        else {
          try {
            d3.selectAll('.pipeline-line').classed('flow', false);
            d3.selectAll('.to-gpt3').classed('flow', true);
          } catch(_) {}
        }

        window.scrollAnchorIntoView?.(A.gpt3);
        console.log('??GPT3 ?¨ê³¼ ?œì‘ ?„ë£Œ');
      }, 240000); // 4ë¶?ì§€??
    });

    // gpt4 ?œì‘ ?? gpt3 ?¨ê³¼ ì¦‰ì‹œ ì¢…ë£Œ + gpt4 ?¬ì»¤??
    window.addEventListener('gpt4:start', () => {
      console.log('?? GPT4 ?œì‘ - GPT3 ì§€???¨ê³¼ ì·¨ì†Œ ë°?GPT4 ?¨ê³¼ ?œì‘');
      
      // GPT3 ì§€???¨ê³¼ ?€?´ë¨¸ ì¦‰ì‹œ ì·¨ì†Œ (ì¤‘ê°„??GPT3 ?¨ê³¼ê°€ ?˜í??˜ëŠ” ê²?ë°©ì?)
      if (window.gpt3DelayedEffectTimer) {
        clearTimeout(window.gpt3DelayedEffectTimer);
        window.gpt3DelayedEffectTimer = null;
        console.log('??GPT3 ì§€???¨ê³¼ ?€?´ë¨¸ ì·¨ì†Œ ?„ë£Œ');
      }
      
      const A = window.__FX.anchors, B = window.__FX.boxes;
      window.setFx.off([B.gpt1, B.gpt2, B.gpt3]); // ?„ì  ?¨ê³¼ ?•ë¦¬
      window.setRightTabRunning?.([A.gpt4], [A.gpt1, A.gpt2, A.gpt3]);
      window.setFx.on([B.gpt4]);

      // 1) ëª¨ë“  ?¼ì¸ ë¹„í™œ????2) gpt4 ?¼ì¸ë§??œì„±
      try {
        d3.selectAll('.pipeline-line').classed('flow', false);
        d3.selectAll('.to-gpt4').classed('flow', true);
      } catch(_) {
        if (window.setFlow) window.setFlow('.to-gpt4');
        else if (window.highlightEdge) window.highlightEdge('.to-gpt4');
      }

      window.scrollAnchorIntoView?.(A.gpt4);
      console.log('??GPT4 ?¨ê³¼ ?œì‘ ?„ë£Œ');
    });

    // (? íƒ) done ?´ë²¤?¸ë¡œ ?„ì²˜ë¦??„ìš” ???¬ê¸°??ì¶”ê?

    // GPT1~3 ?„ë£Œ ??done ?´ë˜??ë¶€??
    window.addEventListener('gpt1:done', () => {
      document.querySelectorAll('.gpt1-module-box')
        .forEach(el => {
          el.classList.remove('pipeline-executing');
          el.classList.add('done'); // ???„ë£Œ ê°•ì¡°
        });
    });

    window.addEventListener('gpt2:done', () => {
      document.querySelectorAll('.gpt2-module-box')
        .forEach(el => {
          el.classList.remove('pipeline-executing');
          el.classList.add('done');
        });
    });

    // gpt3 ì¢…ë£Œ ?? ì§„í–‰ ?¨ê³¼/???µì»¤ ëª¨ë‘ ?´ì œ
    window.addEventListener('gpt3:done', () => {
      console.log('?‰ GPT3 ?„ë£Œ - ëª¨ë“  ?¨ê³¼ ?•ë¦¬');
      
      // GPT3 ì§€???¨ê³¼ ?€?´ë¨¸ ?•ë¦¬
      if (window.gpt3DelayedEffectTimer) {
        clearTimeout(window.gpt3DelayedEffectTimer);
        window.gpt3DelayedEffectTimer = null;
        console.log('??GPT3 ì§€???¨ê³¼ ?€?´ë¨¸ ?•ë¦¬ ?„ë£Œ');
      }
      
      try {
        const A = window.__FX?.anchors, B = window.__FX?.boxes;
        // ë°•ìŠ¤ ?¨ê³¼ OFF (ì¡´ì¬ ??
        if (window.setFx && B?.gpt3) window.setFx.off([B.gpt3]);
        // ?¼ì¸/?µì»¤ ?´ì œ (?´ë°± ?¬í•¨)
        if (window.setFlow) window.setFlow(null);
        else {
          try {
            d3.selectAll('.pipeline-line').classed('flow', false);
          } catch(_) {}
        }
        document.querySelectorAll('.gpt3-anchor')
          .forEach(el => el.classList.remove('agent-running'));
        // ì¹´ë“œ/ë°•ìŠ¤ ìµœì¢… ?•ë¦¬ (ë³´í˜¸??ì¤‘ë³µ ?œê±°)
        const card = document.getElementById('card-gpt3');
        card?.classList.remove('progress-indicator','running');
        card?.classList.add('done');
        document.querySelector('#card-gpt3 .execution-overlay')?.remove();
        document.querySelectorAll('.gpt3-module-box')
          .forEach(el => el.classList.remove('pipeline-executing'));
        // ì¹´ë“œê°€ ?´ë˜???„ë½/ë¶ˆì¼ì¹˜ì—¬???ˆì „?˜ê²Œ ?•ë¦¬
        const g3Card = document.getElementById('card-gpt3');
        g3Card && g3Card.classList.remove('pipeline-executing');
      } catch(_) {}
    });

    // GPT4 ?„ë£Œ ??ëª¨ë“  ?¨ê³¼ ?•ë¦¬ + ìµœì¢… ë¦¬í¬??ë°•ìŠ¤ë§?ì´ˆë¡??ê³ ì •
    window.addEventListener('gpt4:done', () => {
      try {
        // 1) ëª¨ë“  ?¼ì¸/?¬ë‹/?¡í‹°ë¸??„ë£Œ ?¨ê³¼ ?œê±°
        document.querySelectorAll('.pipeline-line').forEach(el => el.classList.remove('flow'));
        document.querySelectorAll('.agent-card').forEach(el => el.classList.remove('running','active','done'));
        document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
          .forEach(el => el.classList.remove('pipeline-executing','running','done'));

        // 2) ê¹œë°•??ê´€???´ë˜???„ì „ ?•ë¦¬ (?„ë½??ë¶€ë¶?ì¶”ê?)
        document.querySelectorAll('.progress-indicator').forEach(el => el.classList.remove('progress-indicator'));
        document.querySelectorAll('.execution-overlay').forEach(el => el.remove());

        // 3) ?íƒœ ?¼ë²¨ ê¹œë°•???´ì œ (status-shine ?´ë˜???œê±°)
        const statusEl = document.querySelector('#send-status');
        if (statusEl) statusEl.classList.remove('status-shine');

        // 4) ìµœì¢… ë¦¬í¬??ì¹´ë“œë§?ì´ˆë¡??ê³ ì •
        document.getElementById('card-gpt4')?.classList.add('done');

        // 5) ?„ì²´ ë°•ìŠ¤ ?¸ì¶œ ë³´ì¥ (ë³´ìˆ˜??ì¤‘ë³µ)
        const panel = document.querySelector('#gpt1-panel, #gpt-right-panel, #right-tab, aside#right-panel, .right-tab-panel, [data-panel="right"]');
        if (panel) {
          panel.classList.add('show-all');
          document.body.classList.add('pipeline-complete');
        }

        // 6) ë³´ê³ ???‘ì—… ?ì—­?¼ë¡œ ?¤í¬ë¡??œë˜ê·?ì¤‘ì´ë©?ë¯¸ê°œ??
        const reportActions = document.getElementById('report-actions');
        if (panel && reportActions && !window.__userDraggingTab) {
          const y = Math.max(0, (reportActions.offsetTop || 0) - 40);
          panel.scrollTo({ top: y, behavior: 'smooth' });
          reportActions.classList.add('report-actions-cta');
          const btn = document.getElementById('btn-export-html');
          btn && btn.classList.add('report-cta');
          setTimeout(() => {
            reportActions.classList.remove('report-actions-cta');
            btn && btn.classList.remove('report-cta');
          }, 4000);
        }
      } catch(_) {}
    });

    // ====== ?”ë²„ê¹?ë¡œê·¸ ======
    console.log('Script loading started');
    
    // =========================
    // [ê³µìš©] ?¤ë¥¸ìª????¬ì»¤??? í‹¸
    // =========================
    (function initRightTabFocusHelpers(){
      if (window.__focusBoxInitialized) return;
      window.__focusBoxInitialized = true;

      // ?¤í¬ë¡?ì»¨í…Œ?´ë„ˆ ?ìƒ‰(?¤ë¥¸ìª????¨ë„)
      function getRightPanel() {
        return document.querySelector('#gpt1-panel, #gpt-right-panel, #right-tab, aside#right-panel, .right-tab-panel, [data-panel="right"]') || null;
      }

      // ?€???˜ë¦¬ë¨¼íŠ¸ ?ìƒ‰(GPT1 ë°•ìŠ¤ ?„ë³´ ?€?‰í„°??
      function getGpt1Box() {
        return document.querySelector(
          '#card-gpt1, [data-agent="gpt1"], .gpt1-box, .gpt1-anchor, #gpt1-panel'
        ) || null;
      }

      // ?¤í¬ë¡?ê°€??ì»¨í…Œ?´ë„ˆ ?¬ë? ì²´í¬
      function isScrollable(el) {
        if (!el) return false;
        const style = getComputedStyle(el);
        const oy = style.overflowY;
        return (oy === 'auto' || oy === 'scroll');
      }

      // ?¤í¬ë¡?ì»¨í…Œ?´ë„ˆ ?ìƒ‰(ê°€??ê°€ê¹Œìš´ ?¤í¬ë¡?ì¡°ìƒ ì°¾ê¸°)
      function findScrollableAncestor(el) {
        let cur = el?.parentElement;
        while (cur) {
          if (isScrollable(cur)) return cur;
          cur = cur.parentElement;
        }
        return null;
      }

      // ì§€???”ì†Œê°€ ë³´ì´?„ë¡ ?¤í¬ë¡?ê°€?´ë° ?•ë ¬ ?°ì„ , ?´ë°± ?¬í•¨)
      function scrollIntoCenter(target) {
        if (!target) return;
        // ?°ì„  ?¤ë¥¸ìª??¨ë„???œë„
        const panel = getRightPanel() || findScrollableAncestor(target);
        // ?½ê°„??ì§€?°ìœ¼ë¡??ˆì´?„ì›ƒ ?ˆì • ???¤í¬ë¡?
        setTimeout(() => {
          try {
            if (panel && panel.scrollTo) {
              const panelRect = panel.getBoundingClientRect();
              const targetRect = target.getBoundingClientRect();
              const current = panel.scrollTop;
              const offset = (targetRect.top - panelRect.top) + current - (panel.clientHeight/2) + (target.clientHeight/2);
              panel.scrollTo({ top: Math.max(0, offset), behavior: 'smooth' });
            } else {
              target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          } catch(_){}
        }, 50);
      }

      // ? ì‹œ ?˜ì´?¼ì´???¬ì»¤?? ?¨ê³¼
      function pulseFocus(el) {
        if (!el) return;
        el.classList.add('pipeline-focus');
        setTimeout(() => el.classList.remove('pipeline-focus'), 1500);
      }

      // ?”” GPT2 Worst ?¸ë¦¬ê±??˜ì‹  ???µí•© ì²˜ë¦¬ (onGpt2WorstStartUI ?¨ìˆ˜ ?¬ìš©)
      window.addEventListener('gpt2worst:start', () => {
        console.log('?”” GPT2 Worst ?´ë²¤???˜ì‹  - ?µí•© ì²˜ë¦¬');
        onGpt2WorstStartUI();
      });
    })();
    
    // ê¸°ë³¸ ?¨ìˆ˜?¤ì´ ?•ì˜?˜ì–´ ?ˆëŠ”ì§€ ?•ì¸
    window.addEventListener('load', function() {
      console.log('Page loaded, checking functions...');
      console.log('generateHTMLReport:', typeof generateHTMLReport);
      console.log('Document ready');
    });
    
    // ====== ?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë”© ?•ì¸ ======
    // ë¡œë”© ?íƒœ ë¡œê·¸ (?„ë¡œ?•ì…˜?ì„œ??ìµœì†Œ??
    // console.log('Chart.js ë¡œë”© ?íƒœ:', typeof Chart !== 'undefined' ? '?±ê³µ' : '?¤íŒ¨');
    // console.log('D3.js ë¡œë”© ?íƒœ:', typeof d3 !== 'undefined' ? '?±ê³µ' : '?¤íŒ¨');
    // console.log('XLSX ë¡œë”© ?íƒœ:', typeof XLSX !== 'undefined' ? '?±ê³µ' : '?¤íŒ¨');
    
    // XLSX ë¡œë”© ?¤íŒ¨ ??1?Œë§Œ ê²½ê³  (ì¤‘ë³µ ?œê±°)
    if (typeof XLSX === 'undefined') {
      console.error('XLSX ë¡œë”© ?¤íŒ¨. ?¤íŠ¸?Œí¬ ?ëŠ” ë³´ì•ˆ ?•ì±…???•ì¸?˜ì„¸??');
    }
    
    // ====== ?¤ì • ======
    const SCENARIO_COUNT = 34; // ?œë‚˜ë¦¬ì˜¤ ê°œìˆ˜ (?„ìš”???˜ì •)
    const scenarioList = Array.from({length: SCENARIO_COUNT}, (_,i)=>i+1);
    const DRAW_KEYWORD_LINKS = false; // ?¤ì›Œ???œë‚˜ë¦¬ì˜¤ ?°ê²°???œì‹œ ?¬ë? (?”ì²­: ë¹„í™œ?±í™”)
    // ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?¬ê¸° ë°??ˆì´?„ì›ƒ (?¤ì›Œ?œë? ?´ë????´ê¸° ?„í•´ ?•ë?)
    const SCENARIO_BOX_WIDTH = 380;
    const SCENARIO_BOX_HEIGHT = 160;
    const SCENARIO_HALF_WIDTH = SCENARIO_BOX_WIDTH / 2;
    const SCENARIO_HALF_HEIGHT = SCENARIO_BOX_HEIGHT / 2;
    const SCENARIO_ROW_GAP = 180; // ?œë‚˜ë¦¬ì˜¤ ?¸ë¡œ ê°„ê²©
    const SCENARIO_LABEL_AREA = 40; // ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?ë‹¨ ?¼ë²¨ ?ì—­ ?’ì´

    // ====== ?Œì´?„ë¼???íƒœ ê´€ë¦?======
    const PipelineStep = { GPT0: 0, GPT1: 1, GPT2: 2, GPT3: 3, GPT4: 4 };
    let currentStep = PipelineStep.GPT0;
    let __userDraggingTab = false; // ?¬ìš©???œë˜ê·?ì¤??Œë˜ê·?

    // ???„ì—­ ê³µìš© ? í‹¸: ?°ì¸¡ ???˜ì´?¼ì´???¬ì»¤??ê´€ë¦?
    window.setRightTabRunning = (on=[], off=[]) => {
      try {
        (off || []).forEach(s => d3.selectAll(s).classed('agent-running', false));
        (on  || []).forEach(s => d3.selectAll(s).classed('agent-running', true));
      } catch (_) {}
    };

    // ====== ?Œì´?„ë¼???¨ê³„ ?„í™˜ ?¬í¼ ?¨ìˆ˜ ======
    function gotoStep(step) {
      currentStep = step;
      stopAllEffects(); // ê¸°ì¡´ ëª¨ë“  ë°•ìŠ¤/???¨ê³¼ ì¢…ë£Œ
      
      console.log(`[UI] ?¨ê³„ ?„í™˜: ${Object.keys(PipelineStep)[step]} (${step})`);
      
      // ?“± ëª¨ë°”???˜ê²½?ì„œ ?´ë‹¹ ì¹´ë“œ ?œì‹œ ë°??¤í¬ë¡?
      if (typeof isMobileEnvironment === 'function' && isMobileEnvironment()) {
        const cardMap = {
          0: 'gpt0',
          1: 'gpt1',
          2: 'gpt2',
          3: 'gpt3',
          4: 'gpt4'
        };
        const cardId = cardMap[step];
        if (cardId) {
          const card = getAgentCard(cardId);
          const panel = $rightPanel();
          if (card && panel) {
            // ?´ë‹¹ ì¹´ë“œë§??œì‹œ?˜ê³  ?¬ì»¤??
            card.style.display = 'block';
            card.style.visibility = 'visible';
            card.style.opacity = '1';
            
            // ?¤í¬ë¡?
            setTimeout(() => {
              panel.scrollTo({ top: card.offsetTop - 12, behavior: 'smooth' });
            }, 100);
          }
        }
      }
      
      switch (step) {
        case PipelineStep.GPT0:
          // ë°•ìŠ¤ ?¨ê³¼: ?¤ìŒ ?¨ê³„ë¡??˜ì–´ê°??Œê¹Œì§€ ì§€??
          highlightCard('#card-gpt0');

          // ?”¹ ???£ì?) ?¨ê³¼ ì¶”ê?: GPT0 ?œì‘ ???ë¦„??? ì?
          //    - gpt0 ??gpt1ë¡??´ì–´ì§€???ë¦„???¨ê»˜ ì¼??°ì†??ê°•ì¡°)
          highlightEdge('.to-gpt0, .to-gpt1');

          setActiveRightTab('gpt0');
          highlightRightTab('gpt0');           // ??ì¶”ê?: ?¤í–‰ì¤???ê°•ì¡°
          
          // ??GPT0 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate'],
            ['.gpt1-anchor','.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf','.gpt4-anchor']
          );
          
          scrollIntoViewIfNeeded('#card-gpt0');
          expandOutputFor('gpt0');             // ??B ?ŒíŠ¸?ì„œ ?•ì˜ (ì¶œë ¥?ì—­ ?•ì¥)
          break;
        case PipelineStep.GPT1:
          highlightCard('#card-gpt1');
          // ??GPT2 ? ì  ê¸ˆì?: ?¬ê¸°??'.to-gpt2' ?¼ì¸/?¤í¬ë¡??¸ì¶œ?˜ì? ?ŠìŒ
          setActiveRightTab('gpt1');
          highlightRightTab('gpt1');           // ??ì¶”ê?
          
          // ??GPT1 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt1-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf','.gpt4-anchor']
          );
          
          scrollIntoViewIfNeeded('#card-gpt1');
          expandOutputFor('gpt1');             // ??ì¶”ê?
          break;
        case PipelineStep.GPT2:
          // GPT2 Worst ëª¨ë“œê°€ ?œì„±?”ë˜???ˆìœ¼ë©?gotoStep??ê¸°ë³¸ ?™ì‘??ê±´ë„ˆ?°ê¸°
          const panel = document.querySelector('#gpt1-panel, .right-tab-panel');
          if (panel && panel.classList.contains('gpt2worst-mode')) {
            console.log('? ï¸ GPT2 Worst ëª¨ë“œê°€ ?œì„±?”ë˜???ˆì–´ gotoStep ê¸°ë³¸ ?™ì‘??ê±´ë„ˆ?ë‹ˆ??);
            break;
          }
          
          highlightCard('#card-gpt2');
          highlightEdge('.to-gpt2'); // GPT2 ?œì‘ ?œì ?ë§Œ
          setActiveRightTab('gpt2');
          highlightRightTab('gpt2');           // ??ì¶”ê?
          
          // ??GPT2 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt2-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf','.gpt4-anchor']
          );
          
          scrollIntoViewIfNeeded('#card-gpt2');
          expandOutputFor('gpt2');             // ??ì¶”ê?
          break;
        case PipelineStep.GPT3:
          highlightCard('#card-gpt3');
          highlightEdge('.to-gpt3');
          setActiveRightTab('gpt3');
          highlightRightTab('gpt3');           // ??ì¶”ê?
          
          // ??GPT3 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']
          );
          
          // ì¹´ë“œ ?˜ì´?¼ì´??ë³´ê°•
          highlightCard('#card-gpt3');
          highlightEdge('.to-gpt3');
          
          scrollIntoViewIfNeeded('#card-gpt3');
          expandOutputFor('gpt3');             // ??ì¶”ê?
          break;
        case PipelineStep.GPT4:
          highlightCard('#card-gpt4');
          highlightEdge('.to-gpt4');
          setActiveRightTab('gpt4');
          highlightRightTab('gpt4');           // ??ì¶”ê?
          
          // ??GPT4 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt4-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf']
          );
          
          // ì¹´ë“œ ?˜ì´?¼ì´??ë³´ê°•
          highlightCard('#card-gpt4');
          highlightEdge('.to-gpt4');
          
          scrollIntoViewIfNeeded('#card-gpt4');
          expandOutputFor('gpt4');             // ??ì¶”ê?
          break;
      }
    }

    function scrollIntoViewIfNeeded(sel) {
      const el = document.querySelector(sel);
      if (!el) return;
      if (window.__userDraggingTab) return;

      const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel');
      if (panel && panel.contains(el)) {
        const targetY = Math.max(
          0,
          (el.offsetTop || 0) - (panel.clientHeight / 2) + (el.clientHeight / 2)
        );
        panel.scrollTo({ top: targetY, behavior: 'smooth' });
      } else {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function stopAllEffects() {
      // ëª¨ë“  ë°•ìŠ¤/???¨ê³¼ ì¢…ë£Œ
      d3.selectAll('.pipeline-line').classed('flow', false);
      
      // ???„ì—­ ?¨ìˆ˜ë¥??¬ìš©?˜ì—¬ ëª¨ë“  ???¨ê³¼ ?´ì œ
      window.setRightTabRunning([], [
        '.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
        '.gpt1-anchor','.gpt2-anchor',
        '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
        '.gpt4-anchor'
      ]);
      
      // ?”¹ ì¹´ë“œ ?¨ê³¼???¨ê»˜ ?•ë¦¬ (running ?´ë˜???œê±°)
      document.querySelectorAll('.agent-card').forEach(card => {
        card.classList.remove('running');
      });
      
      document.querySelectorAll('.progress-indicator').forEach(el => {
        el.classList.remove('progress-indicator');
      });
      document.querySelectorAll('.execution-overlay').forEach(el => {
        el.remove();
      });
    }

    function highlightCard(sel) {
      // ?´ë‹¹ ì¹´ë“œ(ë°•ìŠ¤) ?¨ê³¼ ?œì‘ - ì§€??? ì?(?¤ìŒ ?¨ê³„ ?„í™˜ ???´ì œ)
      const card = document.querySelector(sel);
      if (!card) return;

      // ê¸°ì¡´ 'active' ?¨ë°œ??2ì´? ?¨ê³¼ ?œê±° ??ì§€?í˜• ?´ë˜?¤ë¡œ ?„í™˜
      card.classList.remove('active');
      card.classList.add('running');  // ? ï¸ CSS??.running ?¤í??¼ì´ ?ìš©?˜ë„ë¡??„ë˜ ?ˆë‚´ ì°¸ê³ )
    }

    function highlightEdge(sel) {
      // ?´ë‹¹ ?¼ì¸(?£ì?) ?¨ê³¼ ?œì‘
      if (sel) {
        d3.selectAll('.pipeline-line').classed('flow', false);
        d3.selectAll(sel).classed('flow', true);
      }
    }

    function setActiveRightTab(key) {
      // ê¸°ë³¸ active ? ê? ?™ì‘ ? ì?
      try {
        const panel = document.querySelector('#gpt-right-panel, #gpt1-panel, .right-tab-panel');
        const card = document.getElementById(`card-${key}`);
        if (panel && card) {
          const y = Math.max(0, (card.offsetTop || 0) - 40);
          panel.scrollTo({ top: y, behavior: 'smooth' });
        }
      } catch (e) {
        console.warn('???œì„±??ì¤??¤ë¥˜:', e);
      }
    }

    /* ??? ê·œ ì¶”ê?: ?Œì´?„ë¼??"?¤í–‰ì¤? ?˜ì´?¼ì´???„ìš© */
    function highlightRightTab(tabKey) {
      // ëª¨ë“  ??—??running ?œê±°
      document.querySelectorAll('.agent-card.running').forEach(el => el.classList.remove('running'));

      // ?€????— running ë¶€??ì§€??ê°•ì¡°)
      const target = document.getElementById(`card-${tabKey}`);
      if (target) target.classList.add('running');
    }

    /* ??? ê·œ: ?¨ê³„ë³?ì¶œë ¥ ì»¨í…Œ?´ë„ˆ ?•ì¥ ? í‹¸ */
    function expandOutputFor(stepKey) {
      // 1) ì£??€?‰í„°: #gptN-output
      const sel1 = `#${stepKey}-output`;

      // 2) ?€???€?‰í„°(data-attr ê¸°ë°˜)
      const sel2 = `.output-panel[data-output="${stepKey}"]`;

      // 3) ?°ì„ ?œìœ„?€ë¡??ìƒ‰
      const panel =
        document.querySelector(sel1) ||
        document.querySelector(sel2);

      if (!panel) return;

      // details ?”ì†Œë©?open, ?¼ë°˜ divë©?expanded
      const isDetails = panel.tagName?.toLowerCase() === 'details';
      if (isDetails) {
        panel.setAttribute('open', '');
      }
      panel.classList.add('expanded');
    }

    // ====== ?ˆì „???«ì ?¬ë§¤??ê°€??======
    function safeToFixed(val, digits = 2) {
      const num = Number(val);
      if (!isFinite(num)) return '-';
      try { 
        return num.toFixed(digits); 
      } catch { 
        return '-'; 
      }
    }

    // ====== UI ?”ì†Œ ======
    const indicatorListUl = document.getElementById('indicator-list'); // This element is no longer used for the list
    const indicatorCardsDiv = document.getElementById('indicator-cards'); // New element for indicator cards
    const networkGraphDiv = document.getElementById('network-graph');

    // ====== ?íƒœ ======
    let scenarioData = {}; // {n: {overview, indicators, keywords, links, impacts}}
    let scenarioIdToNum = {}; // Scenario_ID -> n
    let indicatorIdToNameMap = new Map(); // ?„ì—­ ID-Name ë§?(ID -> Bloomberg Ticker)
    let indicatorIdToDisplayNameMap = new Map(); // ?„ì—­ ID-DisplayName ë§?(ID -> Indicator_Name)
    let indicatorMetaById = {}; // ?„ì—­ ID -> {id,name,ticker,thresholds,current_value}
    let selectedIndicators = new Set(); // New state for selected indicators
    let keywordNewsData = []; // keyword_news.xlsx ?„ì²´ ë¡œìš° ?€??
    let keywordBaseData = []; // keyword.xlsx ?„ì²´ ë¡œìš° ?€??
    const keywordByScenarioId = new Map(); // Scenario_ID -> [{text}]
    const keywordByScenarioNum = new Map(); // ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸(n) -> [{text}]
    const newsMetaByScenarioId = new Map(); // Scenario_ID -> Map(text -> {phase,title,press,url})
    const newsMetaByScenarioNum = new Map(); // ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ -> Map(text -> {phase,title,press,url})
    const normalizeScenarioId = (id)=> String(id||'').trim().toUpperCase();
    const scenarioIdToNumber = (id)=>{ const m = String(id||'').match(/\d{1,3}/); return m? parseInt(m[0],10): null; };
    const normalizeKeywordText = (text) => String(text || '')
      .normalize('NFKC')
      .replace(/[\u3000]/g, ' ')
      .replace(/[ï¼ˆï¼‰ï¼»ï¼½?ã€?/g, (m) => ({'ï¼?:'(', 'ï¼?:')', 'ï¼?:'[', 'ï¼?:']', '??:'[', '??:']'}[m] || m))
      .replace(/\s+/g, ' ')
      .trim();

    function simplifyForCompare(text) {
      return normalizeKeywordText(text)
        .toLowerCase()
        .replace(/[^\p{L}\p{N}]/gu, '');
    }

    function findNewsMeta(scenKey, scenNum, ktext) {
      const norm = normalizeKeywordText(ktext);
      const byNum = newsMetaByScenarioNum.get(scenNum);
      const byId = newsMetaByScenarioId.get(scenKey);
      let meta = (byNum && byNum.get(norm)) || (byId && byId.get(norm)) || null;
      if (meta) return meta;
      const targetSimple = simplifyForCompare(norm);
      const searchMap = (m) => {
        if (!m) return null;
        for (const [k, v] of m) {
          if (simplifyForCompare(k) === targetSimple) return v;
        }
        return null;
      };
      return searchMap(byNum) || searchMap(byId) || null;
    }
    
    // ë³´ê³ ???íƒœ ê´€ë¦?
    let reportState = {
      isGenerated: false,
      htmlContent: ''
    };
    
    // ê·¸ë˜???íƒœ(?¸ë? ?œì–´??
      let graphState = {
      g: null,
      svg: null,
      currentTransform: { x: 0, y: 0, scale: 1 },
      containerRect: null,
      width: 0,
      height: 0,
      posByScenarioNum: new Map(),
        gptAnchors: {},
        pipelineRunning: false,
        lockedHighlight: null,
        clearHighlight: null
    };

    // ====== ?¤í¬ëª¨ë“œ ======
    function toggleDarkMode() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      
      // ? ê? ë²„íŠ¼ ?„ì´ì½?ë³€ê²?(ë¶„ì„?¤í–‰, ë³´ê³ ?œë³´ê¸? ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?œì™¸)
      const toggleBtn = document.querySelector('.darkmode-toggle:not(#top-pipeline-btn):not(.analysis-start-btn):not(#btn-export-html):not(#btn-restart-pipeline)');
      if (toggleBtn) {
        toggleBtn.textContent = newTheme === 'dark' ? '?Œ™ ?¤í¬' : '?€ï¸??¼ì´??;
      }
      
      // ë¡œì»¬ ?¤í† ë¦¬ì????Œë§ˆ ?€??
      localStorage.setItem('theme', newTheme);
      
      console.log(`Theme changed to: ${newTheme}`);
    }
    
    // ?˜ì´ì§€ ë¡œë“œ ???€?¥ëœ ?Œë§ˆ ?ìš©
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark'; // ê¸°ë³¸ê°? dark
      document.body.setAttribute('data-theme', savedTheme);
      
      // ? ê? ë²„íŠ¼ ?„ì´ì½??¤ì • (ë¶„ì„?¤í–‰, ë³´ê³ ?œë³´ê¸? ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?œì™¸)
      const toggleBtn = document.querySelector('.darkmode-toggle:not(#top-pipeline-btn):not(.analysis-start-btn):not(#btn-export-html):not(#btn-restart-pipeline)');
      if (toggleBtn) {
        toggleBtn.textContent = savedTheme === 'dark' ? '?Œ™ ?¤í¬' : '?€ï¸??¼ì´??;
      }
    }

    // ?˜ì´ì§€ ë¡œë“œ ??ì´ˆê¸°??
    function initializePage() {
      initializeTheme();
      initializeCardGuidance();
      setupDragScrollDetection();
    }

    // ì¹´ë“œ ?ˆë‚´ ?ìŠ¤?¸ë? ì´ˆê¸° ê³ ì • ë¬¸êµ¬ë¡??¸íŒ…
    function initializeCardGuidance(){
      const g1 = document.getElementById('gpt1-suggest');
      if (g1) {
        g1.textContent = '??ëª©í‘œ: ?µì‹¬ ?”ì•½ ë°?ë©”ì‹œì§€ êµ¬ì„±\n???°ì´???¼ë? ë¯¸ë¦¬ë³´ê¸°): ?°ì¸¡ ?ë‹¨ ? íƒ ??ê°±ì‹ \n???°ì¶œ: ?µì‹¬ ?¬ì¸??3~5ê°œì? ê·¼ê±°';
        g1.classList.add('show');
      }
      const g2 = document.getElementById('gpt2-suggest');
      if (g2) {
        g2.textContent = '??ëª©í‘œ: ?„ë©”?¸ë³„ ?…ë ¥ ë¶„ë°°Â·?•ì œ(?œì¥/? ìš©/ALM/ê¸€ë¡œë²Œ/? ìš©PF)\n???…ë ¥: GPT1 ?°ì¶œ??ê¸°ë°˜?¼ë¡œ ê³„íš ?˜ë¦½\n???°ì¶œ: ?„ë©”?¸ë³„ ê³¼ì—…/?„ìš” ?°ì´??ì¶œë ¥ ?¬ë§·';
        g2.classList.add('show');
      }
      const g3 = document.getElementById('gpt3-suggest');
      if (g3) {
        g3.textContent = 'ê°??„ë©”???œì¥/? ìš©/ALM/ê¸€ë¡œë²Œ/? ìš©?¬íŠ¸?´ë¦¬?? ê´€?ì—???í–¥ ê²½ë¡œ?€ ë¦¬ìŠ¤??ì§€???„ì¶œ.';
        g3.classList.add('show');
      }
      const g4 = document.getElementById('gpt4-suggest');
      if (g4) {
        g4.textContent = '?„ë©”??ê²°ê³¼ë¥?ì·¨í•©?˜ì—¬ ë³´ê³ ??ìµœì¢… ë¦¬í¬???‘ì„±(?”ì•½/ê·¼ê±°/ê¶Œê³ ??.';
        g4.classList.add('show');
      }
    }
    // ====== Excel ?Œì¼ ë¡œë”© ======
    // ë©”ì¸ ì§€???Œì¼ ë¡œë”©
    async function loadMainIndicatorFile() {
      try {
        const url = 'go_scen/data/indicator.xlsx';
        console.log(`?” ì§€???Œì¼ ë¡œë“œ ?œë„: ${url}`);
        
        const resp = await fetch(url);
        if (!resp.ok) {
          console.error(`??ì§€???Œì¼ ë¡œë“œ ?¤íŒ¨: HTTP ${resp.status} ${resp.statusText}`);
          console.error(`?Œì¼ ê²½ë¡œë¥??•ì¸?˜ì„¸?? ${url}`);
          throw new Error(`Failed to load main indicator file: ${resp.status}`);
        }
        
        const arrayBuffer = await resp.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type:'array'});
        
        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
          console.error('??Excel ?Œì¼???œíŠ¸ê°€ ?†ìŠµ?ˆë‹¤');
          return [];
        }
        
        console.log(`?“Š Excel ?œíŠ¸ëª…ë“¤: ${workbook.SheetNames.join(', ')}`);
        
        // ì²?ë²ˆì§¸ ?œíŠ¸?ì„œ ì§€???•ë³´ ?½ê¸°
        const indicatorSheet = workbook.Sheets[workbook.SheetNames[0]];
        const indicators = indicatorSheet ? XLSX.utils.sheet_to_json(indicatorSheet, { defval: null }) : [];
        
        console.log(`??ë©”ì¸ ì§€???Œì¼ ë¡œë“œ ?„ë£Œ: ${indicators.length}ê°?ì§€??);
        if (indicators.length > 0) {
          console.log('?“‹ ì§€???°ì´???˜í”Œ (ì²?3ê°?:', indicators.slice(0, 3));
          console.log('?“‹ ì§€??ì»¬ëŸ¼??', Object.keys(indicators[0]));
        } else {
          console.warn('? ï¸ ì§€???°ì´?°ê? ë¹„ì–´?ˆìŠµ?ˆë‹¤. Excel ?Œì¼ êµ¬ì¡°ë¥??•ì¸?˜ì„¸??');
        }
        
        // ?”¹ ì§€??ë©”í? êµ¬ì„± (ID/?´ë¦„/?°ì»¤/?„ê³„ì¹?ìµœê·¼ê°?
        const indicatorList = [];
        const metaMap = {};
        indicators.forEach(row => {
          const id = row.Indicator_ID || row.ID || row.indicator_id || row.indicatorId || row['Indicator ID'] || row['indicator id'];
          if (!id) return;
          const name =
            row.Indicator_Name || row.IndicatorName || row.indicator_name || row.indicatorName ||
            row.Name || row.name || '';
          const ticker =
            row.Bloomberg_Ticker || row.BloombergTicker || row.bloomberg_ticker || row.bloombergTicker ||
            row.Ticker || row.ticker || '';
          const thresholdLow = row.Threshold_Low ?? row.threshold_low ?? row.ThresholdLow ?? row.Low ?? row.low ?? null;
          const thresholdHigh = row.Threshold_High ?? row.threshold_high ?? row.ThresholdHigh ?? row.High ?? row.high ?? null;
          const currentValue = row.Current_Value ?? row.current_value ?? row.CurrentValue ?? row.Value ?? row.value ?? null;

          const meta = {
            id: String(id).trim(),
            name: name ? String(name).trim() : '',
            ticker: ticker ? String(ticker).trim() : '',
            threshold_low: thresholdLow,
            threshold_high: thresholdHigh,
            current_value: currentValue
          };

          indicatorList.push(meta);
          metaMap[meta.id] = meta;
        });

        window.INDICATOR_LIST = indicatorList;
        window.INDICATOR_META = metaMap;
        window.SCENARIO_INDICATOR_IDS = indicatorList.map(ind => ind.id);
        indicatorMetaById = metaMap;
        console.log(`??INDICATOR_META ?ì„±: ${Object.keys(metaMap).length}ê°?(ID?’ë©”?€)`);
        
        return indicators;
      } catch(e) {
        console.error('??ë©”ì¸ ì§€???Œì¼ ë¡œë“œ ?¤ë¥˜:', e);
        console.error('?“ ?Œì¼ ê²½ë¡œë¥??•ì¸?˜ì„¸?? go_scen/data/indicator.xlsx');
        console.error('?”§ ?Œì¼??ì¡´ì¬?˜ê³  ?¬ë°”ë¥?Excel ?•ì‹?¸ì? ?•ì¸?˜ì„¸??');
        return [];
      }
    }

  // ë§ˆì¼“?°ì´???Œì¼ ë¡œë”© ?¨ìˆ˜
  async function loadMarketDataFile() {
    try {
      const url = 'go_scen/data/market_data/market_data.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load market_data.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²?ë²ˆì§¸ ?œíŠ¸?ì„œ ë§ˆì¼“?°ì´???½ê¸°
      const marketSheet = workbook.Sheets[workbook.SheetNames[0]];
      const marketData = marketSheet ? XLSX.utils.sheet_to_json(marketSheet) : [];
      
      console.log('?” ë§ˆì¼“?°ì´???ë³¸ ?°ì´??', marketData.slice(0, 3));
      console.log('?” ë§ˆì¼“?°ì´??ì»¬ëŸ¼ëª?', Object.keys(marketData[0] || {}));
      
      // ?œë‚˜ë¦¬ì˜¤ë³„ë¡œ ?°ì´???•ë¦¬
      marketDataByScenario = {};
      let marketProcessedCount = 0;
      let marketSkippedCount = 0;
      
      marketData.forEach((row, index) => {
        console.log(`?” ë§ˆì¼“?°ì´????${index + 1}:`, row);
        console.log(`?” ??${index + 1}??ëª¨ë“  ì»¬ëŸ¼ëª?`, Object.keys(row));
        
        // ?¤ì–‘??ì»¬ëŸ¼ëª??€??- ??ì²´ê³„?ìœ¼ë¡?ê²€??
        let id = null;
        let data = null;
        
        // id ì»¬ëŸ¼ ê²€??(?•í™•??ë§¤ì¹­ ?°ì„ )
        if (row.id) {
          id = row.id;
          console.log(`??id ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${id}"`);
        } else if (row.ID) {
          id = row.ID;
          console.log(`??ID ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${id}"`);
        } else if (row.Id) {
          id = row.Id;
          console.log(`??Id ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${id}"`);
        } else {
          // ë¶€ë¶?ë§¤ì¹­ ?œë„
          const idKeys = Object.keys(row).filter(key => 
            key.toLowerCase() === 'id'
          );
          if (idKeys.length > 0) {
            id = row[idKeys[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ id ì»¬ëŸ¼ ì°¾ìŒ: "${idKeys[0]}" = "${id}"`);
          }
        }
        
        // data ì»¬ëŸ¼ ê²€??
        if (row.data) {
          data = row.data;
          console.log(`??data ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${data}"`);
        } else if (row.Data) {
          data = row.Data;
          console.log(`??Data ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${data}"`);
        } else if (row.DATA) {
          data = row.DATA;
          console.log(`??DATA ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${data}"`);
        } else {
          // ë¶€ë¶?ë§¤ì¹­ ?œë„
          const dataKeys = Object.keys(row).filter(key => 
            key.toLowerCase() === 'data'
          );
          if (dataKeys.length > 0) {
            data = row[dataKeys[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ data ì»¬ëŸ¼ ì°¾ìŒ: "${dataKeys[0]}" = "${data}"`);
          }
        }
        
        console.log(`?” ìµœì¢… ?Œì‹±???•ë³´: id="${id}", data="${data}"`);
        
        if (id && data) {
          // id?ì„œ ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ ì¶”ì¶œ (?? "IND001:returns" -> "IND001")
          const parts = String(id).split(':');
          const indicatorId = parts[0];
          const dataType = parts[1];
          
          if (!marketDataByScenario[indicatorId]) {
            marketDataByScenario[indicatorId] = {};
          }
          
          try {
            // JSON ?Œì‹±
            const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
            marketDataByScenario[indicatorId][dataType] = parsedData;
            marketProcessedCount++;
            console.log(`??ë§ˆì¼“?°ì´??ì¶”ê?: ${indicatorId}.${dataType}`);
          } catch (e) {
            console.warn(`JSON ?Œì‹± ?¤íŒ¨: ${id}`, e);
            marketSkippedCount++;
          }
        } else {
          marketSkippedCount++;
          console.log(`??ê±´ë„ˆ??ë§ˆì¼“?°ì´????${index + 1}: id="${id}", data="${data}"`);
        }
      });
      
      console.log(`?“Š ë§ˆì¼“?°ì´??ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬??${marketProcessedCount}ê°? ê±´ë„ˆ??${marketSkippedCount}ê°?);
      
      // ?¬ìš© ê°€?¥í•œ ID ?¨í„´ ?ˆì‹œ ì¶œë ¥
      const availableIds = Object.keys(marketDataByScenario);
      if (availableIds.length > 0) {
        console.log('?“‹ ?¬ìš© ê°€?¥í•œ ID ?¨í„´ ?ˆì‹œ:');
        availableIds.slice(0, 5).forEach(id => {
          const dataTypes = Object.keys(marketDataByScenario[id]);
          console.log(`  ${id}: ${dataTypes.join(', ')}`);
        });
      }
      
      console.log(`??ë§ˆì¼“?°ì´???Œì¼ ë¡œë“œ ?„ë£Œ: ${Object.keys(marketDataByScenario).length}ê°?ì§€??);
      console.log('ë§ˆì¼“?°ì´???˜í”Œ:', Object.keys(marketDataByScenario).slice(0, 3));
      
      return marketDataByScenario;
    } catch(e) {
      console.error('Error loading market_data.xlsx:', e);
      marketDataByScenario = {};
      return {};
    }
  }

  // ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ?Œì¼ ë¡œë”© ?¨ìˆ˜
  async function loadIndicatorMappingFile() {
    try {
      const url = 'go_scen/data/indicator.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load indicator.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²?ë²ˆì§¸ ?œíŠ¸?ì„œ ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ?½ê¸°
      const indicatorSheet = workbook.Sheets[workbook.SheetNames[0]];
      const indicatorData = indicatorSheet ? XLSX.utils.sheet_to_json(indicatorSheet) : [];
      
      console.log('?” ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ?ë³¸ ?°ì´??', indicatorData.slice(0, 3));
      console.log('?” ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì»¬ëŸ¼ëª?', Object.keys(indicatorData[0] || {}));
      
      // ë§¤í•‘ ?°ì´???•ë¦¬
      indicatorToScenarioMap.clear();
      scenarioToIndicatorsMap.clear();
      let mappingProcessedCount = 0;
      let mappingSkippedCount = 0;
      
      indicatorData.forEach((row, index) => {
        console.log(`?” ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ??${index + 1}:`, row);
        
        // ?¤ì–‘??ì»¬ëŸ¼ëª??€??
        let indicatorId = null;
        let indicatorName = null;
        let bloombergTicker = null;
        let scenarioReport = null;
        
        // Indicator_ID ì»¬ëŸ¼ ê²€??
        if (row['Indicator_ID']) {
          indicatorId = row['Indicator_ID'];
        } else if (row['indicator_id']) {
          indicatorId = row['indicator_id'];
        } else if (row['IndicatorID']) {
          indicatorId = row['IndicatorID'];
        }
        
        // Indicator_Name ì»¬ëŸ¼ ê²€??
        if (row['Indicator_Name']) {
          indicatorName = row['Indicator_Name'];
        } else if (row['indicator_name']) {
          indicatorName = row['indicator_name'];
        } else if (row['IndicatorName']) {
          indicatorName = row['IndicatorName'];
        }
        
        // Bloomberg_Ticker ì»¬ëŸ¼ ê²€??
        if (row['Bloomberg_Ticker']) {
          bloombergTicker = row['Bloomberg_Ticker'];
        } else if (row['bloomberg_ticker']) {
          bloombergTicker = row['bloomberg_ticker'];
        } else if (row['BloombergTicker']) {
          bloombergTicker = row['BloombergTicker'];
        }
        
        // ?œë‚˜ë¦¬ì˜¤ ì»¬ëŸ¼ ê²€??
        if (row['?œë‚˜ë¦¬ì˜¤']) {
          scenarioReport = row['?œë‚˜ë¦¬ì˜¤'];
        } else if (row['scenario']) {
          scenarioReport = row['scenario'];
        } else if (row['Scenario']) {
          scenarioReport = row['Scenario'];
        }
        
        console.log(`?” ?Œì‹±???•ë³´: ID=${indicatorId}, Name=${indicatorName}, Ticker=${bloombergTicker}, Scenario=${scenarioReport}`);
        
        if (indicatorId && scenarioReport) {
          // ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ ì¶”ì¶œ (scenario_report_18 -> 18, scenario_report_04 -> 4)
          const scenarioMatch = String(scenarioReport).match(/scenario_report_(\d+)/);
          if (scenarioMatch) {
            const scenarioNumber = parseInt(scenarioMatch[1]);
            const fallbackMeta = (!indicatorName || !bloombergTicker)
              ? findIndicatorMetaFromScenario(indicatorId, scenarioNumber)
              : null;
            const finalIndicatorName = indicatorName || fallbackMeta?.name || '';
            const finalBloombergTicker = bloombergTicker || fallbackMeta?.ticker || '';
            
            // ë§¤í•‘ ?€??
            indicatorToScenarioMap.set(indicatorId, {
              scenarioNumber,
              indicatorName: finalIndicatorName,
              bloombergTicker: finalBloombergTicker,
              scenarioReport
            });
            
            if (!scenarioToIndicatorsMap.has(scenarioNumber)) {
              scenarioToIndicatorsMap.set(scenarioNumber, []);
            }
            scenarioToIndicatorsMap.get(scenarioNumber).push({
              indicatorId,
              indicatorName: finalIndicatorName,
              bloombergTicker: finalBloombergTicker,
              scenarioReport
            });
            
            mappingProcessedCount++;
            console.log(`??ë§¤í•‘ ì¶”ê?: ${indicatorId} -> ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}`);
          } else {
            mappingSkippedCount++;
            console.log(`???œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ ì¶”ì¶œ ?¤íŒ¨: ${scenarioReport}`);
          }
        } else {
          mappingSkippedCount++;
          console.log(`???„ìˆ˜ ?°ì´???„ë½: ID=${indicatorId}, Scenario=${scenarioReport}`);
        }
      });
      
      console.log(`?“Š ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬??${mappingProcessedCount}ê°? ê±´ë„ˆ??${mappingSkippedCount}ê°?);
      console.log('?“‹ ?œë‚˜ë¦¬ì˜¤ë³?ì§€??ë§¤í•‘ ?”ì•½:');
      scenarioToIndicatorsMap.forEach((indicators, scenarioNum) => {
        console.log(`  ?œë‚˜ë¦¬ì˜¤ ${scenarioNum}: ${indicators.map(i => i.indicatorId).join(', ')}`);
      });
      
      return { indicatorToScenarioMap, scenarioToIndicatorsMap };
    } catch (error) {
      console.error('??ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ?Œì¼ ë¡œë”© ?¤íŒ¨:', error);
      return { indicatorToScenarioMap: new Map(), scenarioToIndicatorsMap: new Map() };
    }
  }

  // ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?Œì¼ ë¡œë”© ?¨ìˆ˜
  async function loadScenarioSummaryFile() {
    try {
      const url = 'go_scen/data/market_data/scenario_summary.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load scenario_summary.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²?ë²ˆì§¸ ?œíŠ¸?ì„œ ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?½ê¸°
      const summarySheet = workbook.Sheets[workbook.SheetNames[0]];
      const summaryData = summarySheet ? XLSX.utils.sheet_to_json(summarySheet) : [];
      
      console.log('?” ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?ë³¸ ?°ì´??', summaryData.slice(0, 3));
      console.log('?” ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ì»¬ëŸ¼ëª?', Object.keys(summaryData[0] || {}));
      
      // ?œë‚˜ë¦¬ì˜¤IDë³„ë¡œ ?°ì´???•ë¦¬
      scenarioSummaryByScenarioId = {};
      let summaryProcessedCount = 0;
      let summarySkippedCount = 0;
      
      summaryData.forEach((row, index) => {
        console.log(`?” ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ??${index + 1}:`, row);
        console.log(`?” ??${index + 1}??ëª¨ë“  ì»¬ëŸ¼ëª?`, Object.keys(row));
        
        // ?¤ì–‘??ì»¬ëŸ¼ëª??€??- ??ì²´ê³„?ìœ¼ë¡?ê²€??
        let scenarioId = null;
        let content = null;
        
        // Scenario_ID ì»¬ëŸ¼ ê²€??(?•í™•??ë§¤ì¹­ ?°ì„ )
        if (row['Scenario_ID']) {
          scenarioId = row['Scenario_ID'];
          console.log(`??Scenario_ID ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['?œë‚˜ë¦¬ì˜¤ID']) {
          scenarioId = row['?œë‚˜ë¦¬ì˜¤ID'];
          console.log(`???œë‚˜ë¦¬ì˜¤ID ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['scenario_id']) {
          scenarioId = row['scenario_id'];
          console.log(`??scenario_id ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${scenarioId}"`);
        } else {
          // ë¶€ë¶?ë§¤ì¹­ ?œë„
          const scenarioKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('scenario') || 
            key.toLowerCase().includes('?œë‚˜ë¦¬ì˜¤')
          );
          if (scenarioKeys.length > 0) {
            scenarioId = row[scenarioKeys[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ ?œë‚˜ë¦¬ì˜¤ ì»¬ëŸ¼ ì°¾ìŒ: "${scenarioKeys[0]}" = "${scenarioId}"`);
          }
        }
        
        // ?´ìš© ì»¬ëŸ¼ ê²€??
        if (row['?´ìš©']) {
          content = row['?´ìš©'];
          console.log(`???´ìš© ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${content}"`);
        } else if (row['Content']) {
          content = row['Content'];
          console.log(`??Content ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${content}"`);
        } else {
          // ë¶€ë¶?ë§¤ì¹­ ?œë„
          const contentKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('content') || 
            key.toLowerCase().includes('?´ìš©') ||
            key.toLowerCase().includes('?”ì•½')
          );
          if (contentKeys.length > 0) {
            content = row[contentKeys[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ ?´ìš© ì»¬ëŸ¼ ì°¾ìŒ: "${contentKeys[0]}" = "${content}"`);
          }
        }
        
        console.log(`?” ìµœì¢… ?Œì‹±???•ë³´: scenarioId="${scenarioId}", content="${content}"`);
        
        if (scenarioId && content) {
          const cleanScenarioId = String(scenarioId).trim();
          const cleanContent = String(content).trim();
          scenarioSummaryByScenarioId[cleanScenarioId] = cleanContent;
          summaryProcessedCount++;
          console.log(`???œë‚˜ë¦¬ì˜¤ ?”ì•½ ì¶”ê?: ${cleanScenarioId}`);
        } else {
          summarySkippedCount++;
          console.log(`??ê±´ë„ˆ???œë‚˜ë¦¬ì˜¤ ?”ì•½ ??${index + 1}: scenarioId="${scenarioId}", content="${content}"`);
        }
      });
      
      console.log(`?“Š ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬??${summaryProcessedCount}ê°? ê±´ë„ˆ?€ ${summarySkippedCount}ê°?);
      
      console.log(`???œë‚˜ë¦¬ì˜¤ ?”ì•½ ?Œì¼ ë¡œë“œ ?„ë£Œ: ${Object.keys(scenarioSummaryByScenarioId).length}ê°??œë‚˜ë¦¬ì˜¤`);
      console.log('?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?˜í”Œ:', Object.keys(scenarioSummaryByScenarioId).slice(0, 3));
      console.log('?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?ì„¸ êµ¬ì¡°:', scenarioSummaryByScenarioId);
      
      // SC004, SC022 ?¹ë³„ ?•ì¸
      ['SC004', 'SC022'].forEach(scenarioId => {
        if (scenarioSummaryByScenarioId[scenarioId]) {
          console.log(`?¯ ${scenarioId} ?”ì•½ ?°ì´???•ì¸:`, scenarioSummaryByScenarioId[scenarioId]);
        } else {
          console.log(`??${scenarioId} ?”ì•½ ?°ì´???†ìŒ`);
          // ? ì‚¬????ì°¾ê¸°
          const scenarioNum = scenarioId.replace('SC', '');
          const similarKeys = Object.keys(scenarioSummaryByScenarioId).filter(key => 
            key.includes(scenarioNum) || 
            key.includes(scenarioId) || 
            key.includes(scenarioId.replace('SC', ''))
          );
          console.log(`?” ${scenarioId}?€ ? ì‚¬???¤ë“¤:`, similarKeys);
        }
      });
      
      return scenarioSummaryByScenarioId;
    } catch(e) {
      console.error('Error loading scenario_summary.xlsx:', e);
      scenarioSummaryByScenarioId = {};
      return {};
    }
  }

  // ?¤ì›Œ???´ìŠ¤ ?Œì¼ ë¡œë”© ?¨ìˆ˜
  async function loadKeywordNewsFile() {
    try {
      const url = 'go_scen/data/news/bigkinds/daily_news/keyword_news.xlsx';
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load keyword_news.xlsx');
      const arrayBuffer = await resp.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type:'array'});
      
      // ì²?ë²ˆì§¸ ?œíŠ¸?ì„œ ?¤ì›Œ???´ìŠ¤ ?½ê¸°
      const newsSheet = workbook.Sheets[workbook.SheetNames[0]];
      const newsData = newsSheet ? XLSX.utils.sheet_to_json(newsSheet) : [];
      
      console.log('?” ?´ìŠ¤?°ì´???ë³¸ ?°ì´??', newsData.slice(0, 3));
      console.log('?” ?´ìŠ¤?°ì´??ì»¬ëŸ¼ëª?', Object.keys(newsData[0] || {}));
      
      // ?œë‚˜ë¦¬ì˜¤IDë³„ë¡œ ?°ì´???•ë¦¬
      keywordNewsByScenarioId = {};
      let processedCount = 0;
      let skippedCount = 0;
      
      newsData.forEach((row, index) => {
        console.log(`?” ?´ìŠ¤ ?°ì´????${index + 1}:`, row);
        console.log(`?” ??${index + 1}??ëª¨ë“  ì»¬ëŸ¼ëª?`, Object.keys(row));
        
        // ?¤ì–‘??ì»¬ëŸ¼ëª??€??- ??ì²´ê³„?ìœ¼ë¡?ê²€??
        let scenarioId = null;
        let newsContent = null;
        let keyword = null;
        let url = null;
        let title = null;
        let press = null;
        
        // Scenario_ID ì»¬ëŸ¼ ê²€??(?•í™•??ë§¤ì¹­ ?°ì„ )
        if (row['Scenario_ID']) {
          scenarioId = row['Scenario_ID'];
          console.log(`??Scenario_ID ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['scenario_id']) {
          scenarioId = row['scenario_id'];
          console.log(`??scenario_id ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${scenarioId}"`);
        } else if (row['SCENARIO_ID']) {
          scenarioId = row['SCENARIO_ID'];
          console.log(`??SCENARIO_ID ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${scenarioId}"`);
        } else {
          // ë¶€ë¶?ë§¤ì¹­ ?œë„
          const scenarioKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('scenario') || 
            key.toLowerCase().includes('?œë‚˜ë¦¬ì˜¤')
          );
          if (scenarioKeys.length > 0) {
            scenarioId = row[scenarioKeys[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ ?œë‚˜ë¦¬ì˜¤ ì»¬ëŸ¼ ì°¾ìŒ: "${scenarioKeys[0]}" = "${scenarioId}"`);
          }
        }
        
        // news ì»¬ëŸ¼ ê²€??
        if (row['news']) {
          newsContent = row['news'];
          console.log(`??news ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${newsContent}"`);
        } else if (row['News']) {
          newsContent = row['News'];
          console.log(`??News ì»¬ëŸ¼?ì„œ ê°?ì°¾ìŒ: "${newsContent}"`);
        } else {
          // ë¶€ë¶?ë§¤ì¹­ ?œë„
          const newsKeys = Object.keys(row).filter(key => 
            key.toLowerCase().includes('news') || 
            key.toLowerCase().includes('?´ìŠ¤') ||
            key.toLowerCase().includes('?´ìš©')
          );
          if (newsKeys.length > 0) {
            newsContent = row[newsKeys[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ ?´ìŠ¤ ì»¬ëŸ¼ ì°¾ìŒ: "${newsKeys[0]}" = "${newsContent}"`);
          }
        }
        
        // ê¸°í? ì»¬ëŸ¼?¤ë„ ?™ì¼?˜ê²Œ ê²€??
        keyword = row['News_kor'] || row['news_kor'] || row['NEWS_KOR'] || row['?¤ì›Œ??] || row['ì£¼ì œ'] || '';
        url = row['URL'] || row['Url'] || row['url'] || row['ë§í¬'] || '';
        title = row['?œëª©'] || row['Title'] || row['title'] || row['TITLE'] || '';
        press = row['?¸ë¡ ??] || row['Press'] || row['press'] || row['ë§¤ì²´'] || '';
        
        console.log(`?” ìµœì¢… ?Œì‹±???•ë³´: scenarioId="${scenarioId}", newsContent="${newsContent}", keyword="${keyword}"`);
        
        // ì¡°ê±´ ê²€??ë°?ì²˜ë¦¬ - ??? ì—°??ì¡°ê±´
        if (scenarioId) {
          const cleanScenarioId = String(scenarioId).trim();
          
          // newsContentê°€ ë¹„ì–´?ˆì–´??ê¸°ë³¸ ?•ë³´???€??
          const hasNewsContent = newsContent && String(newsContent).trim().length > 0;
          
          // SC004 ?¹ë³„ ë¡œê¹…
          if (cleanScenarioId === 'SC004') {
            console.log(`?¯ SC004 ?°ì´??ì²˜ë¦¬ ì¤?`);
            console.log(`  - ?ë³¸ scenarioId: "${scenarioId}"`);
            console.log(`  - ?•ë¦¬??scenarioId: "${cleanScenarioId}"`);
            console.log(`  - newsContent: "${newsContent}"`);
            console.log(`  - hasNewsContent: ${hasNewsContent}`);
            console.log(`  - keyword: "${keyword}"`);
            console.log(`  - title: "${title}"`);
            console.log(`  - press: "${press}"`);
          }
          
          if (hasNewsContent) {
            console.log(`???„ì „???°ì´?? ?œë‚˜ë¦¬ì˜¤ ${cleanScenarioId}???´ìŠ¤ ì¶”ê?`);
          } else {
            console.log(`? ï¸ ë¶€ë¶??°ì´?? ?œë‚˜ë¦¬ì˜¤ ${cleanScenarioId}??ê¸°ë³¸ ?•ë³´ë§?ì¶”ê? (?´ìŠ¤ ?´ìš© ?†ìŒ)`);
          }
          
          if (!keywordNewsByScenarioId[cleanScenarioId]) {
            keywordNewsByScenarioId[cleanScenarioId] = [];
          }
          
          const newsItem = {
            keyword: keyword ? String(keyword).trim() : '',
            news: hasNewsContent ? String(newsContent).trim() : '?´ìŠ¤ ?´ìš© ?†ìŒ',
            url: url ? String(url).trim() : '',
            title: title ? String(title).trim() : '',
            press: press ? String(press).trim() : ''
          };
          
          keywordNewsByScenarioId[cleanScenarioId].push(newsItem);
          
          // SC004 ?¹ë³„ ë¡œê¹…
          if (cleanScenarioId === 'SC004') {
            console.log(`  - ì¶”ê????´ìŠ¤ ?„ì´??`, newsItem);
            console.log(`  - ?„ì¬ SC004 ë°°ì—´ ê¸¸ì´: ${keywordNewsByScenarioId[cleanScenarioId].length}`);
          }
          
          processedCount++;
        } else {
          console.log(`??ê±´ë„ˆ????${index + 1}: scenarioId="${scenarioId}", newsContent="${newsContent}"`);
          skippedCount++;
        }
      });
      
      console.log(`?“Š ì²˜ë¦¬ ê²°ê³¼: ì²˜ë¦¬??${processedCount}ê°? ê±´ë„ˆ?€ ${skippedCount}ê°?);
      
      console.log(`???¤ì›Œ???´ìŠ¤ ?Œì¼ ë¡œë“œ ?„ë£Œ: ${Object.keys(keywordNewsByScenarioId).length}ê°??œë‚˜ë¦¬ì˜¤`);
      console.log('?¤ì›Œ???´ìŠ¤ ?˜í”Œ:', Object.keys(keywordNewsByScenarioId).slice(0, 3));
      console.log('?¤ì›Œ???´ìŠ¤ ?ì„¸ êµ¬ì¡°:', keywordNewsByScenarioId);
      
      // SC004, SC022 ?¹ë³„ ?•ì¸
      ['SC004', 'SC022'].forEach(scenarioId => {
        if (keywordNewsByScenarioId[scenarioId]) {
          console.log(`?¯ ${scenarioId} ?´ìŠ¤ ?°ì´???•ì¸:`, keywordNewsByScenarioId[scenarioId]);
        } else {
          console.log(`??${scenarioId} ?´ìŠ¤ ?°ì´???†ìŒ`);
          // ? ì‚¬????ì°¾ê¸°
          const scenarioNum = scenarioId.replace('SC', '');
          const similarKeys = Object.keys(keywordNewsByScenarioId).filter(key => 
            key.includes(scenarioNum) || 
            key.includes(scenarioId) || 
            key.includes(scenarioId.replace('SC', ''))
          );
          console.log(`?” ${scenarioId}?€ ? ì‚¬???¤ë“¤:`, similarKeys);
        }
      });
      
      // ?„ì²´ ?°ì´??êµ¬ì¡° ?ì„¸ ë¶„ì„
      console.log('?” ?„ì²´ keywordNewsByScenarioId êµ¬ì¡°:');
      Object.keys(keywordNewsByScenarioId).forEach(key => {
        console.log(`  ${key}: ${keywordNewsByScenarioId[key].length}ê°??´ìŠ¤`);
        if (key.includes('4') || key.includes('004')) {
          console.log(`    ?“‹ ${key} ?ì„¸ ?´ìš©:`, keywordNewsByScenarioId[key]);
        }
      });
      
      return keywordNewsByScenarioId;
    } catch(e) {
      console.error('Error loading keyword_news.xlsx:', e);
      keywordNewsByScenarioId = {};
      return {};
    }
  }

  // ê¸°ë³¸ GPT3 ê°€?´ë“œ?¼ì¸ ?Œì¼??ë¡œë”© ?¨ìˆ˜
  async function loadDefaultGpt3Guidelines() {
    try {
      // ê¸°ë³¸ ê°€?´ë“œ?¼ì¸ ?Œì¼ ê²½ë¡œ ë§µí•‘
      const guidelineFiles = {
        'market': 'go_scen/data/bank/?œì¥ë¦¬ìŠ¤??txt',
        'credit': 'go_scen/data/bank/? ìš©ë¦¬ìŠ¤??txt', 
        'alm': 'go_scen/data/bank/ALM.txt',
        'global': 'go_scen/data/bank/ê¸€ë¡œë²Œë¦¬ìŠ¤??txt',
        'creditpf': 'go_scen/data/bank/? ìš©?¬íŠ¸?´ë¦¬??txt'
      };

      // window.gpt3Guidelines ê°ì²´ ì´ˆê¸°??
      if (!window.gpt3Guidelines) {
        window.gpt3Guidelines = {};
      }

      let loadedCount = 0;
      
      // ê°?ê°€?´ë“œ?¼ì¸ ?Œì¼ ë¡œë”©
      for (const [key, filePath] of Object.entries(guidelineFiles)) {
        try {
          const resp = await fetch(filePath);
          if (resp.ok) {
            const text = await resp.text();
            window.gpt3Guidelines[key] = text.slice(0, 200000); // ìµœë? 200KB ?œí•œ
            loadedCount++;
            
            // UI???Œì¼ëª??œì‹œ ?…ë°?´íŠ¸
            const nameElementId = `gpt3-${key}-guideline-name`;
            const nameElement = document.getElementById(nameElementId);
            if (nameElement) {
              const fileName = filePath.split('/').pop();
              nameElement.textContent = fileName;
            }
          } else {
            console.warn(`ê¸°ë³¸ ê°€?´ë“œ?¼ì¸ ?Œì¼ ë¡œë“œ ?¤íŒ¨: ${filePath}`);
          }
        } catch (e) {
          console.warn(`ê¸°ë³¸ ê°€?´ë“œ?¼ì¸ ?Œì¼ ë¡œë“œ ?¤ë¥˜ (${key}):`, e);
        }
      }

      console.log(`??ê¸°ë³¸ GPT3 ê°€?´ë“œ?¼ì¸ ë¡œë“œ ?„ë£Œ: ${loadedCount}/${Object.keys(guidelineFiles).length}ê°??Œì¼`);
      
      return window.gpt3Guidelines;
    } catch(e) {
      console.error('Error loading default GPT3 guidelines:', e);
      return {};
    }
  }

    async function loadScenarioExcel(n) {
      try {
        // 01~09ê¹Œì??????ë¦¬ ?¨ë”©, 10 ?´ìƒ?€ ê·¸ë?ë¡?
        const folderName = String(n).padStart(2, '0');
        const fileName = `scenario_report_${folderName}.xlsx`;
        
        const url = `go_scen/scen/${folderName}/${fileName}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Failed to load file for scenario ${n}`);
        const arrayBuffer = await resp.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type:'array'});

        // [0] ?œíŠ¸: ?œë‚˜ë¦¬ì˜¤ ê°œìš”
        const overviewSheet = workbook.Sheets[workbook.SheetNames[0]];
        const overview = XLSX.utils.sheet_to_json(overviewSheet)[0] || {};
        // [1] ?œíŠ¸: ?œì¥ì§€??(?¬ìš©?˜ì? ?ŠìŒ - ë©”ì¸ ?Œì¼ ?¬ìš©)
        const indicatorSheet = workbook.Sheets[workbook.SheetNames[1]];
        const indicators = indicatorSheet ? XLSX.utils.sheet_to_json(indicatorSheet) : [];
        // [2] ?œíŠ¸: ?´ìŠ¤ ?¤ì›Œ??
        const keywordSheet = workbook.Sheets[workbook.SheetNames[2]];
        const keywords = keywordSheet ? XLSX.utils.sheet_to_json(keywordSheet) : [];
        // [3] ?œíŠ¸: ?œë‚˜ë¦¬ì˜¤-ì§€???°ê³„
        const linkSheet = workbook.Sheets[workbook.SheetNames[3]];
        const links = linkSheet ? XLSX.utils.sheet_to_json(linkSheet) : [];
        // [4] ?œíŠ¸: ?í–¥ ë¶„ì„
        const impactSheet = workbook.Sheets[workbook.SheetNames[4]];
        const impacts = impactSheet ? XLSX.utils.sheet_to_json(impactSheet) : [];

        scenarioData[n] = { overview, indicators, keywords, links, impacts };
        if (overview && overview.Scenario_ID) scenarioIdToNum[overview.Scenario_ID] = n;
      } catch(e) {
        console.error(`Error loading scenario ${n}:`, e);
        scenarioData[n] = { overview: {}, indicators: [], keywords: [], links: [], impacts: [] };
      }
    }

    function findIndicatorMetaFromScenario(indicatorId, scenarioNumber) {
      if (!indicatorId || scenarioNumber == null) return null;
      const normalizeId = (value) => String(value || '').trim().toUpperCase();
      const scenarioEntry = scenarioData[scenarioNumber];
      if (!scenarioEntry) return null;
      const targetId = normalizeId(indicatorId);
      const candidates = [];
      if (Array.isArray(scenarioEntry.indicators)) candidates.push(...scenarioEntry.indicators);
      if (Array.isArray(scenarioEntry.links)) candidates.push(...scenarioEntry.links);
      for (const item of candidates) {
        const candidateId = normalizeId(
          item.Indicator_ID || item.indicator_id || item.IndicatorID || item.indicatorId || item.id || item.ID
        );
        if (!candidateId || candidateId !== targetId) continue;
        const name =
          item.Indicator_Name || item.indicator_name || item.IndicatorName ||
          item.indicatorName || item.name || item.Name || item.NAME || '';
        const ticker =
          item.Bloomberg_Ticker || item.bloomberg_ticker || item.BloombergTicker ||
          item.bloombergTicker || item.ticker || item.Ticker || item.TICKER || '';
        return { name, ticker };
      }
      return null;
    }

    // ====== GPT1 ?„ì†¡ ?íƒœ ======
    let selectedScenarioForGPT = null;
    
    // ====== ë§ˆì¼“?°ì´???€?¥ì†Œ ======
    // let marketDataByScenario = {}; // ?„ì—­ ë³€?˜ì? ì¤‘ë³µ ? ì–¸ ?œê±°
    
    // ====== ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?€?¥ì†Œ ======
    // let scenarioSummaryByScenarioId = {}; // ?„ì—­ ë³€?˜ì? ì¤‘ë³µ ? ì–¸ ?œê±°
    
    // ====== ?¤ì›Œ???´ìŠ¤ ?€?¥ì†Œ ======
    // let keywordNewsByScenarioId = {}; // ?„ì—­ ë³€?˜ì? ì¤‘ë³µ ? ì–¸ ?œê±°

    // ====== ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ?€?¥ì†Œ ======
    let indicatorToScenarioMap = new Map(); // Indicator_ID -> ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸
    let scenarioToIndicatorsMap = new Map(); // ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ -> Indicator_ID ë°°ì—´

    // ====== ì´ˆê¸°??ë°??„ì²´ ?Œë”ë§?ê´€ë¦?======
    async function initializeApp() {
      const graphEl = document.getElementById('network-graph');
      if (graphEl) graphEl.textContent = '';
      
      // 1?¨ê³„: ë©”ì¸ ì§€???Œì¼ ë¡œë“œ
      const mainIndicators = await loadMainIndicatorFile();
      
      // 2?¨ê³„: ëª¨ë“  ?œë‚˜ë¦¬ì˜¤ Excel ?Œì¼ ë¡œë“œ
      await Promise.all(scenarioList.map(n => loadScenarioExcel(n)));
      
      // 2.1?¨ê³„: ë§ˆì¼“?°ì´???Œì¼ ë¡œë“œ
      await loadMarketDataFile();
      
      // 2.2?¨ê³„: ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?Œì¼ ë¡œë“œ
      await loadScenarioSummaryFile();
      
      // 2.3?¨ê³„: ?¤ì›Œ???´ìŠ¤ ?Œì¼ ë¡œë“œ
      await loadKeywordNewsFile();
      
      // 2.4?¨ê³„: ê¸°ë³¸ GPT3 ê°€?´ë“œ?¼ì¸ ?Œì¼??ë¡œë“œ
      await loadDefaultGpt3Guidelines();

      // 2.5?¨ê³„: ì§€???œë‚˜ë¦¬ì˜¤ ë§¤í•‘ ?Œì¼ ë¡œë“œ (indicator.xlsx)
      await loadIndicatorMappingFile();

      // 2.5?¨ê³„: ?¤ì›Œ??ê¸°ë³¸ ?€ ë¡œë“œ (keyword.xlsx)
      try {
        const kwBaseUrl = 'go_scen/data/news/keyword.xlsx';
        const resp = await fetch(kwBaseUrl);
        if (!resp.ok) throw new Error('keyword.xlsx ë¡œë“œ ?¤íŒ¨');
        const arrayBuffer = await resp.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        keywordBaseData = XLSX.utils.sheet_to_json(sheet) || [];
        keywordByScenarioId.clear();
        keywordByScenarioNum.clear();
        keywordBaseData.forEach(row => {
          const scenId = row.Scenario_ID || row.scenario_id || row.SCENARIO_ID;
          const newsKorRaw = row.News_kor || row.News_Kor || row.news_kor || row.keyword || row.Keyword;
          if (!scenId || !newsKorRaw) return;
          const key = normalizeScenarioId(scenId);
          if (!keywordByScenarioId.has(key)) keywordByScenarioId.set(key, []);
          const newsKor = normalizeKeywordText(newsKorRaw);
          keywordByScenarioId.get(key).push({ text: newsKor });
          const n = scenarioIdToNumber(key);
          if (n != null) {
            if (!keywordByScenarioNum.has(n)) keywordByScenarioNum.set(n, []);
            keywordByScenarioNum.get(n).push({ text: newsKor });
          }
        });
        try { console.log('[KW-BASE] byId keys=', Array.from(keywordByScenarioId.keys())); console.log('[KW-BASE] byNum keys=', Array.from(keywordByScenarioNum.keys())); } catch(_) {}
      } catch (e) {
        console.error('?¤ì›Œ??ê¸°ë³¸ ?€ ë¡œë“œ ?¤ë¥˜:', e);
      }

      // 2.6?¨ê³„: ?´ìŠ¤ ë©”í?(phase/title/press/url) ë³‘í•© (keyword_news.xlsx)
      try {
        const kwNewsUrl = 'go_scen/data/news/bigkinds/daily_news/keyword_news.xlsx';
        const resp2 = await fetch(kwNewsUrl);
        if (!resp2.ok) throw new Error('keyword_news.xlsx ë¡œë“œ ?¤íŒ¨');
        const ab2 = await resp2.arrayBuffer();
        const wb2 = XLSX.read(ab2, { type: 'array' });
        const sheet2 = wb2.Sheets[wb2.SheetNames[0]];
        keywordNewsData = XLSX.utils.sheet_to_json(sheet2) || [];
        newsMetaByScenarioId.clear();
        newsMetaByScenarioNum.clear();
        keywordNewsData.forEach(row => {
          const scenId = row.Scenario_ID || row.scenario_id || row.SCENARIO_ID;
          const textRaw = row.News_kor || row.News_Kor || row.news_kor;
          if (!scenId || !textRaw) return;
          const phase = row.Phase || row.phase || row.PHASE;
          const url = row.URL || row.Url || row.url;
          const title = row['?œëª©'] || row.Title || row.title;
          const press = row['?¸ë¡ ??] || row['ë§¤ì²´'] || row.Press || row.press;
          const key = normalizeScenarioId(scenId);
          const ktext = normalizeKeywordText(textRaw);
          if (!newsMetaByScenarioId.has(key)) newsMetaByScenarioId.set(key, new Map());
          newsMetaByScenarioId.get(key).set(ktext, { phase: String(phase || '').trim(), url: url ? String(url) : '', title: title ? String(title) : '', press: press ? String(press) : '' });
          const n = scenarioIdToNumber(key);
          if (n != null) {
            if (!newsMetaByScenarioNum.has(n)) newsMetaByScenarioNum.set(n, new Map());
            newsMetaByScenarioNum.get(n).set(ktext, { phase: String(phase || '').trim(), url: url ? String(url) : '', title: title ? String(title) : '', press: press ? String(press) : '' });
          }
        });
      } catch (e) {
        console.error('?¤ì›Œ???´ìŠ¤ ë©”í? ë¡œë“œ ?¤ë¥˜:', e);
      }
      
      // 3?¨ê³„: ë©”ì¸ ì§€???Œì¼??ê¸°ë°˜?¼ë¡œ ?„ì—­ ì§€??ID-Name ë§??ì„±
      const tempIndicatorMap = new Map();
      const tempDisplayNameMap = new Map();
      
      // ë©”ì¸ ì§€???Œì¼?ì„œ ì§€???•ë³´ ?˜ì§‘
      console.log('?” ë©”ì¸ ì§€???Œì¼ ì»¬ëŸ¼ êµ¬ì¡° ë¶„ì„:');
      if (mainIndicators.length > 0) {
        console.log('ì²?ë²ˆì§¸ ì§€???°ì´?°ì˜ ?¤ë“¤:', Object.keys(mainIndicators[0]));
        console.log('ì²?ë²ˆì§¸ ì§€???°ì´???„ì²´:', mainIndicators[0]);
      }
      
      let foundInMainFile = 0;
      let missingNameCount = 0;
      
      mainIndicators.forEach((indicator, index) => {
        // ê°€?¥í•œ ì»¬ëŸ¼ëª…ë“¤???œë„ (?Œì¼ êµ¬ì¡°???°ë¼ ?¤ë? ???ˆìŒ)
        const indicatorId = indicator.Indicator_ID || indicator.ID || indicator.ì§€?œID || indicator.id;
        const bloombergTicker = indicator.Bloomberg_Ticker || indicator.Ticker || indicator.ticker || indicator.Bloomberg_Code;
        const indicatorName = indicator.Indicator_Name || indicator.Name || indicator.ì§€?œëª… || indicator.name;
        
        if (indicatorId && bloombergTicker) {
          tempIndicatorMap.set(indicatorId, bloombergTicker);
          // Indicator_Name???ˆìœ¼ë©??€?? ?†ìœ¼ë©?Bloomberg_Ticker ?¬ìš©
          tempDisplayNameMap.set(indicatorId, indicatorName || bloombergTicker);
          foundInMainFile++;
        } else {
          missingNameCount++;
          if (index < 5) { // ì²˜ìŒ 5ê°œë§Œ ë¡œê·¸
            console.log(`??ì§€???•ë³´ ë¶€ì¡?[${index}]:`, indicator);
            console.log(`  - ID: ${indicatorId}, Bloomberg_Ticker: ${bloombergTicker}, Indicator_Name: ${indicatorName}`);
          }
        }
        
        // IND004 ?¹ë³„ ?•ì¸
        if (indicatorId === 'IND004') {
          console.log('?” IND004 ?ì„¸ ?•ë³´:', indicator);
          console.log(`ID: ${indicatorId}, Bloomberg_Ticker: ${bloombergTicker}, Indicator_Name: ${indicatorName}`);
        }
      });
      
      console.log(`??ë©”ì¸ ?Œì¼?ì„œ ë§¤í•‘ ?±ê³µ: ${foundInMainFile}ê°?);
      console.log(`???´ë¦„ ?•ë³´ ë¶€ì¡? ${missingNameCount}ê°?);
      
      // 4?¨ê³„: ?œë‚˜ë¦¬ì˜¤ links?ì„œ ?„ë½??ì§€?œë“¤ ?•ì¸ (?ì„±?˜ì? ?Šê³  ë¡œê·¸ë§?
      const missingIndicators = new Set(); // ?„ë½??ì§€?œë“¤ ì¶”ì 
      
      Object.values(scenarioData).forEach(scenario => {
        if (scenario.links) {
          scenario.links.forEach(link => {
            if (link.Indicator_ID && !tempIndicatorMap.has(link.Indicator_ID)) {
              missingIndicators.add(link.Indicator_ID);
            }
          });
        }
      });
      
      if (missingIndicators.size > 0) {
        console.log(`? ï¸ indicator ?Œì¼???†ëŠ” ì§€??ID??(${missingIndicators.size}ê°?:`);
        Array.from(missingIndicators).slice(0, 20).forEach(id => {
          console.log(`  - ${id} (?œë‚˜ë¦¬ì˜¤?ì„œ ì°¸ì¡°?˜ì?ë§?indicator ?Œì¼???†ìŒ)`);
        });
      }
      
      // ë©”ì¸ ?Œì¼?ì„œ ì°¾ì? ì§€??ID???•ì¸
      console.log('?“Š indicator ?Œì¼?ì„œ ë¡œë“œ??ì§€?œë“¤ (ì²˜ìŒ 20ê°?:');
      let mainFileCount = 0;
      for (const [id, ticker] of tempIndicatorMap.entries()) {
        if (mainFileCount < 20) {
          console.log(`  - ${id} -> "${ticker}"`);
          mainFileCount++;
        }
      }

      
      // ìµœì¢… ë§µì— ë³µì‚¬ (ID -> Bloomberg Ticker, ID -> Indicator_Name)
      indicatorIdToNameMap = tempIndicatorMap;
      indicatorIdToDisplayNameMap = tempDisplayNameMap;
      
      // ì§€??ë§µì´ ë¹„ì–´?ˆëŠ” ê²½ìš° ê²½ê³ 
      if (indicatorIdToNameMap.size === 0) {
        console.error('?š¨ ?¬ê°??ë¬¸ì œ: ì§€??ë§µì´ ?„ì „??ë¹„ì–´?ˆìŠµ?ˆë‹¤!');
        console.error('?“‹ ê°€?¥í•œ ?ì¸:');
        console.error('  1. indicator.xlsx ?Œì¼??ì¡´ì¬?˜ì? ?ŠìŒ');
        console.error('  2. ?Œì¼ êµ¬ì¡°ê°€ ?ˆìƒê³??¤ë¦„ (Indicator_ID, Bloomberg_Ticker ì»¬ëŸ¼ ë¶€??');
        console.error('  3. ?¤íŠ¸?Œí¬ ?°ê²° ë¬¸ì œë¡??Œì¼ ë¡œë“œ ?¤íŒ¨');
        console.error('?”§ ?´ê²° ë°©ë²•: go_scen/data/indicator.xlsx ?Œì¼???•ì¸?˜ì„¸??');
      }
      
      console.log(`???œì‹œëª?ë§??ì„± ?„ë£Œ: ${indicatorIdToDisplayNameMap.size}ê°?ì§€??(ID -> Indicator_Name)`);
      if (indicatorIdToDisplayNameMap.size > 0) {
        console.log('?“‹ ?œì‹œëª??˜í”Œ (ì²˜ìŒ 5ê°?:');
        let count = 0;
        for (const [id, name] of indicatorIdToDisplayNameMap.entries()) {
          if (count < 5) {
            console.log(`  - ${id} -> "${name}"`);
            count++;
          }
        }
      }
      
      // ì¤‘ë³µ Bloomberg Ticker ?•ì¸
      const tickerCount = new Map();
      const duplicateTickers = [];
      
      for (const [id, ticker] of indicatorIdToNameMap.entries()) {
        if (tickerCount.has(ticker)) {
          tickerCount.set(ticker, tickerCount.get(ticker) + 1);
          if (!duplicateTickers.includes(ticker)) {
            duplicateTickers.push(ticker);
          }
        } else {
          tickerCount.set(ticker, 1);
        }
      }
      
      console.log(`??ì§€??ë§??ì„± ?„ë£Œ: ${indicatorIdToNameMap.size}ê°?ì§€??(ID -> Bloomberg Ticker)`);
      console.log(`?“Š indicator ?Œì¼: ${mainIndicators.length}ê°?ì§€??);
      
      if (duplicateTickers.length > 0) {
        console.log(`? ï¸ ì¤‘ë³µ??Bloomberg Ticker ë°œê²¬: ${duplicateTickers.length}ê°?);
        duplicateTickers.forEach(ticker => {
          const duplicateIds = [];
          for (const [id, mapTicker] of indicatorIdToNameMap.entries()) {
            if (mapTicker === ticker) {
              duplicateIds.push(id);
            }
          }
          console.log(`"${ticker}": [${duplicateIds.join(', ')}] (${duplicateIds.length}ê°?`);
        });
      } else {
        console.log(`??ì¤‘ë³µ Bloomberg Ticker ?†ìŒ`);
      }
      
      // ?¹ì • ì§€??IND111 ?”ë²„ê¹?
      console.log(`?” IND111 ?”ë²„ê¹?`);
      console.log(`IND111??ì§€??ë§µì— ì¡´ì¬: ${indicatorIdToNameMap.has('IND111')}`);
      console.log(`IND111 ë§¤í•‘ ?´ë¦„: ${indicatorIdToNameMap.get('IND111') || 'undefined'}`);
      
      // IND111???¬ìš©?˜ëŠ” ?œë‚˜ë¦¬ì˜¤ ?•ì¸
      const scenariosUsingIND111 = [];
      Object.entries(scenarioData).forEach(([scenarioNum, scenario]) => {
        if (scenario.links) {
          const hasIND111 = scenario.links.some(link => link.Indicator_ID === 'IND111');
          if (hasIND111) {
            scenariosUsingIND111.push(scenarioNum);
          }
        }
      });
      console.log(`IND111???¬ìš©?˜ëŠ” ?œë‚˜ë¦¬ì˜¤?? [${scenariosUsingIND111.join(', ')}]`);
      
      // ë©”ì¸ ì§€???Œì¼?ì„œ IND111 ?•ì¸
      const ind111InMain = mainIndicators.find(ind => 
        (ind.Indicator_ID || ind.ID || ind.ì§€?œID || ind.id) === 'IND111'
      );
      console.log(`ë©”ì¸ ì§€???Œì¼??IND111 ì¡´ì¬: ${!!ind111InMain}`);
      if (ind111InMain) {
        console.log(`ë©”ì¸ ?Œì¼??IND111 ?°ì´??`, ind111InMain);
      }
      
      // ?”ë²„ê¹? ì²˜ìŒ 10ê°?ì§€???•ì¸
      console.log('ì²˜ìŒ 10ê°?ì§€??ë§¤í•‘ (ID -> Bloomberg Ticker):');
      let debugCount = 0;
      for (const [id, ticker] of indicatorIdToNameMap.entries()) {
        if (debugCount < 10) {
          console.log(`${id}: ${ticker}`);
          debugCount++;
        } else {
          break;
        }
      }
      
      await loadRiskEngContent();
      renderNetwork();
      
      // ?¤ë¥¸ìª????¬ê¸°ì¡°ì • ì´ˆê¸°??
      restoreRightPanelSize();
      
      // ?œë˜ê·?ë¦¬ì‚¬?´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°??
      initializeDragResize();
      

    }

    // ====== ?¤íŠ¸?Œí¬ ê·¸ë˜???Œë”ë§?======
    function renderNetwork() {
      const container = document.getElementById('network-graph');
      container.innerHTML = '';
      
      // ?„ìˆ˜ ?°ì´??ì¤€ë¹??íƒœ ?•ì¸
      if (indicatorIdToNameMap.size === 0) {
        console.warn('? ï¸ ?¤íŠ¸?Œí¬ ?Œë”ë§?ì§€?? ì§€??ë§µì´ ?„ì§ ë¡œë“œ?˜ì? ?Šì•˜?µë‹ˆ??');
        container.innerHTML = `
          <div style="text-align:center; padding:40px; color:#666;">
            <div style="font-size:24px; margin-bottom:20px;">?“Š</div>
            <div style="font-size:16px; margin-bottom:10px; animation: loading-pulse 1.5s ease-in-out infinite;">?°ì´??ë¡œë”© ì¤?..</div>
            <div style="font-size:12px; animation: loading-fade 2s ease-in-out infinite;">ì§€???Œì¼???•ì¸?˜ê³  ?ˆìŠµ?ˆë‹¤.</div>
          </div>
        `;
        return;
      }
      
      // ë¸Œë¼?°ì? ?¸í™˜?±ì„ ?„í•œ ?ˆì „???¬ê¸° ê³„ì‚°
      const containerRect = container.getBoundingClientRect();
      const width = Math.max(containerRect.width, 1200) * 1.2; // ì»¨í…Œ?´ë„ˆ ê¸°ì??¼ë¡œ ê³„ì‚°, ìµœì†Œ ?¬ê¸° ë³´ì¥
      const height = Math.max(containerRect.height, 800) * 1.2; // ì»¨í…Œ?´ë„ˆ ê¸°ì??¼ë¡œ ê³„ì‚°, ìµœì†Œ ?¬ê¸° ë³´ì¥
      
      const svg = d3.select('#network-graph')
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', `0 0 ${width} ${height}`)
        .style('position', 'absolute')
        .style('top', '0')
        .style('left', '0');
      
      const g = svg.append('g');
      
      // ?ˆì´??ê·¸ë£¹ ?ì„±: ë§í¬(??ê°€ ë¨¼ì?, ?¸ë“œ(??ê°€ ?˜ì¤‘ ???¸ë“œê°€ ??ƒ ???„ì— ?œì‹œ??
      const linkLayer = g.append('g').attr('class', 'link-layer');
      const nodeLayer = g.append('g').attr('class', 'node-layer');

      // ì¤?ë°???ê¸°ëŠ¥ ì¶”ê? (?°ì¹˜ ìµœì ??
      const zoom = d3.zoom()
        .scaleExtent([0.1, 3]) // ì¤?ë²”ìœ„ ?¤ì •
        .filter((event) => {
          // ?°ì¹˜?€ ë§ˆìš°???´ë²¤??ëª¨ë‘ ?ˆìš©, ?”ë¸”?´ë¦­?€ ?œì™¸
          return !event.ctrlKey && event.type !== 'dblclick';
        })
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom)
        .on('dblclick.zoom', null); // ?”ë¸”?´ë¦­ ì¤?ë¹„í™œ?±í™” (?°ì¹˜ ?¥ì¹˜?ì„œ ?˜ë„ì¹??Šì? ì¤?ë°©ì?)

      // ê·¸ë˜???íƒœ ë³´ê?
      graphState.svg = svg;
      graphState.g = g;
      graphState.containerRect = containerRect;
      graphState.width = width;
      graphState.height = height;
      graphState.posByScenarioNum = new Map();
      graphState.midPointByScenarioNum = new Map(); // ?œë‚˜ë¦¬ì˜¤-ë§ˆì¼“?°ì´???¤ì„ ??ì¤‘ê°„???€??

      // ?„ì²´ ?ˆì´?„ì›ƒ??ì¤‘ê°„ ?„ì¹˜ ê³„ì‚°
      const layoutCenterY = height / 2;
      
      // ì§€??ë§µì„ ë°°ì—´ë¡?ë³€??(indicator.xlsx???¤ì œ ì¡´ì¬?˜ëŠ” ì§€?œë§Œ ?œì‹œ)
      const referencedIndicatorIds = new Set();
      Object.values(scenarioData).forEach(scen => {
        if (Array.isArray(scen.indicators)) scen.indicators.forEach(ind => ind?.Indicator_ID && referencedIndicatorIds.add(ind.Indicator_ID));
        if (Array.isArray(scen.links)) scen.links.forEach(l => l?.Indicator_ID && referencedIndicatorIds.add(l.Indicator_ID));
      });
      
      // indicator.xlsx???¤ì œ ì¡´ì¬?˜ëŠ” ì§€?œë§Œ ?˜ì§‘ (?? œ??ì§€?œëŠ” ?œì™¸)
      const allIndicatorEntries = Array.from(
        Array.from(indicatorIdToNameMap.entries()).filter(([id]) => isAllowedIndicatorId(id))
      );
      
      // ???œê±°?? indicator ?Œì¼???†ëŠ” IDë¥?ê°•ì œë¡?ì¶”ê??˜ë˜ ë¡œì§
      // ?´ì œ indicator.xlsx?ì„œ ?? œ??ì§€???? IND033)??UI???œì‹œ?˜ì? ?ŠìŒ
      // referencedIndicatorIds.forEach(id => {
      //   if (!isAllowedIndicatorId(id)) return;
      //   if (!indicatorIdToNameMap.has(id)) {
      //     allIndicatorEntries.push([id, id]);
      //   }
      // });
      
      // ID ?œìœ¼ë¡??•ë ¬
      const sortedIndicators = allIndicatorEntries.sort(([idA], [idB]) => idA.localeCompare(idB));
      
      // ?œì¥ì§€?œë? SVG??ì§ì ‘ ?Œë”ë§?(?¼ìª½) - ?œë‚˜ë¦¬ì˜¤?€ ê±°ë¦¬ ì¡°ì •
      const indicatorStartX = width / 2 - 1300; // ?œë‚˜ë¦¬ì˜¤?€ ?ì ˆ??ê±°ë¦¬ (ì¤‘ì•™?ì„œ ?¼ìª½?¼ë¡œ 1300px)
      // ?œì¥ì§€???„ì²´ ?’ì´ ê³„ì‚° (5??ê¸°ì?)
      const indicatorRows = Math.ceil(sortedIndicators.length / 5);
      const indicatorTotalHeight = (indicatorRows - 1) * 80; // ??ê°„ê²© ?•ë? (50 ??80)
      const indicatorStartY = layoutCenterY - indicatorTotalHeight / 2; // ì¤‘ê°„ ?„ì¹˜ ê¸°ì??¼ë¡œ ì¡°ì •
      const indicatorSpacing = 80; // ì§€??ê°„ê²© ?•ë? (50 ??80)
      const indicatorCols = 5;
      
      // ?œë‚˜ë¦¬ì˜¤ 30 ?”ë²„ê¹…ì„ ?„í•œ ?ˆì´?„ì›ƒ ?•ë³´ ì¶œë ¥
      console.log(`?“ === ì§€???ˆì´?„ì›ƒ ê³„ì‚° ?•ë³´ ===`);
      console.log(`- width: ${width}, height: ${height}`);
      console.log(`- layoutCenterY: ${layoutCenterY}`);
      console.log(`- indicatorStartX: ${indicatorStartX}, indicatorStartY: ${indicatorStartY}`);
      console.log(`- indicatorRows: ${indicatorRows}, indicatorCols: ${indicatorCols}`);
      console.log(`- indicatorSpacing: ${indicatorSpacing}`);
      console.log(`- ?„ì²´ ì§€???? ${sortedIndicators.length}`);
      console.log(`- indicatorTotalHeight: ${indicatorTotalHeight}`);
      
      const indicatorNodes = sortedIndicators.map(([indicatorId, indicatorName], index) => {
        const col = index % indicatorCols;
        const row = Math.floor(index / indicatorCols);
        const x = indicatorStartX + col * indicatorSpacing;
        const y = indicatorStartY + row * indicatorSpacing;
        
        // Indicator_Name (?œì‹œëª? ê°€?¸ì˜¤ê¸?
        const displayName = indicatorIdToDisplayNameMap.get(indicatorId) || indicatorName;
        
        // IND140~IND145 ì§€?œë“¤???„ì¹˜ ?”ë²„ê¹?
        if (indicatorId && indicatorId.match(/IND14[0-5]/)) {
          console.log(`?¯ ${indicatorId} (${indicatorName}) ?„ì¹˜ ê³„ì‚°:`);
          console.log(`   - index: ${index}, col: ${col}, row: ${row}`);
          console.log(`   - indicatorStartX: ${indicatorStartX}, indicatorStartY: ${indicatorStartY}`);
          console.log(`   - indicatorSpacing: ${indicatorSpacing}`);
          console.log(`   - ìµœì¢… ?„ì¹˜: (${x}, ${y})`);
        }
        
        // ?‰ìƒ ê²°ì • (?œë‚˜ë¦¬ì˜¤ indicators?ì„œ ì°¾ê¸°)
        let color = '#3498db';
        for (let scenario of Object.values(scenarioData)) {
          if (scenario.indicators) {
            const indicator = scenario.indicators.find(ind => 
              ind.Indicator_ID === indicatorId || ind.Indicator_Name === indicatorName
            );
            if (indicator) {
              color = getIndicatorColor(indicator);
              break;
            }
          }
        }
        
        return {
          id: indicatorName,
          name: indicatorName,
          displayName: displayName, // Indicator_Name ì¶”ê?
          indicatorId: indicatorId,
          x: x,
          y: y,
          color: color,
          type: 'indicator'
        };
      });
      
      // ?Œë”ë§ë˜??ì§€???¸ë“œ ì¤‘ë³µ ?•ì¸
      const renderedNames = indicatorNodes.map(node => node.name);
      const renderedNameSet = new Set(renderedNames);
      
      console.log(`?¨ ?Œë”ë§í•  ì§€???¸ë“œ: ${indicatorNodes.length}ê°?);
      console.log(`?¨ ê³ ìœ  ì§€???´ë¦„: ${renderedNameSet.size}ê°?);
      
      // IND140~IND145 ë²”ìœ„???¸ë“œ???•ì¸
      console.log(`?” === ?ì„±??IND140~IND145 ?¸ë“œ???•ì¸ ===`);
      const ind140Plus = indicatorNodes.filter(node => {
        if (node.indicatorId && node.indicatorId.startsWith('IND')) {
          const num = parseInt(node.indicatorId.substring(3));
          return num >= 140 && num <= 145;
        }
        return false;
      });
      
      if (ind140Plus.length > 0) {
        console.log(`IND140~IND145 ?¸ë“œ??(${ind140Plus.length}ê°?:`);
        ind140Plus.forEach(node => {
          console.log(`  - ${node.indicatorId}: "${node.name}" ?„ì¹˜(${node.x}, ${node.y})`);
        });
      } else {
        console.log(`??IND140~IND145 ë²”ìœ„???¸ë“œê°€ ?†ìŠµ?ˆë‹¤`);
      }
      
      // ë§ˆì?ë§?ëª?ê°?ì§€???¸ë“œ ?•ì¸ (?ìª½???ˆì–´????ì§€?œë“¤)
      console.log(`?“ === ë§ˆì?ë§?10ê°?ì§€???¸ë“œ??===`);
      indicatorNodes.slice(-10).forEach((node, index) => {
        const globalIndex = indicatorNodes.length - 10 + index;
        console.log(`  ${globalIndex + 1}. ${node.indicatorId}: "${node.name}" ?„ì¹˜(${node.x}, ${node.y})`);
      });
      
      if (renderedNames.length !== renderedNameSet.size) {
        console.log(`? ï¸ ?Œë”ë§???ì¤‘ë³µ??ì§€?œê? ?ˆìŠµ?ˆë‹¤!`);
        const duplicatesInRendering = [];
        renderedNames.forEach((name, index) => {
          const firstIndex = renderedNames.indexOf(name);
          if (firstIndex !== index && !duplicatesInRendering.includes(name)) {
            duplicatesInRendering.push(name);
          }
        });
        console.log(`ì¤‘ë³µ ?Œë”ë§ë˜??ì§€?œë“¤:`, duplicatesInRendering);
      }
      
      // ê°„ê²© ?ìˆ˜
      const GAP_X = 500;           // ?¨ê³„ ê°?ê¸°ë³¸ ê°„ê²© (ì¡°ì •??
      const GAP_GPT1_TO_GPT3 = GAP_X * 2; // gpt1?”gpt3 ê°„ê²©
      const GAP_GPT0_FROM_GPT1 = GAP_X;   // gpt1ë¡œë???gpt0ê¹Œì? ì¢Œì¸¡ ?¤í”„???œë‚˜ë¦¬ì˜¤ ìª½ìœ¼ë¡??¹ê?)
      const GAP_GPT1_TO_GPT2 = 300;       // gpt1?”gpt2 ê°„ê²©(?¹ìˆ˜ ì¡°ì •)
      const SCEN_GPT_PATH_RATIO = 0.15; // ?œë‚˜ë¦¬ì˜¤?’í—ˆë¸?ì¤‘ê°„??ë³´ê°„(??ì§§ê²Œ)
      // ?„ì²´ ê¸¸ì´ë¥??ˆë¸Œê¹Œì? 100% ?„ë‹¬?œí‚¤?? ?´ë??ì„œ ?¤ì„ /?ì„  ë¶„í• ë§??ìš©
      const SCEN_GPT_TOTAL_FRAC = 1; // ?ˆë¸Œê¹Œì? ?„ë‹¬ (ê¸¸ì´ ?½ìŠ¤?˜ì? ?ŠìŒ)
      const SCEN_GPT_SOLID_FRAC_IN_TOTAL = 0.6; // ì¶•ì†Œ??ê¸¸ì´ ì¤??¤ì„  ë¹„ìœ¨(60%)

      // gpt0(?¬ì „?˜ì§‘ ?˜ìœ„ ?ì´?„íŠ¸ ë¬¶ìŒ) ê¸°ì??¼ë¡œ ë°°ì¹˜???? gpt1???™ì¼ ê°„ê²©ë§Œí¼ ?¤ë¥¸ìª½ì— ë°°ì¹˜
      // gpt0ë¥?ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ???¤ë¥¸ìª½ìœ¼ë¡??´ë™?œí‚¨ ?ˆë? ?„ì¹˜
      const gpt0X = width / 2 + 1000 + 1000;
      // gpt1 ?µì»¤??gpt0 ê¸°ì? gpt3?€??ê±°ë¦¬ë§Œí¼ ?¤ë¥¸ìª½ìœ¼ë¡?
      const gptAnchorX = gpt0X + GAP_GPT1_TO_GPT3;
      const gptAnchorY = layoutCenterY;    // ì¤‘ì•™ ?•ë ¬

      // ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ???ì„±
      const scenarioNodes = Object.entries(scenarioData).map(([n, data]) => ({
        id: data.overview.Scenario_ID || `?œë‚˜ë¦¬ì˜¤${n}`,
        name: data.overview.Scenario_Name || `?œë‚˜ë¦¬ì˜¤ ${n}`,
        n: parseInt(n),
        type: 'scenario'
      }));

      // ?¤ì›Œ???¸ë“œ ì¤€ë¹?(ì¢Œí‘œ???œë‚˜ë¦¬ì˜¤ ê³ ì • ??ê³„ì‚°)
      const keywordNodes = [];
      const keywordMaxPerRow = 4;
      Object.entries(scenarioData).forEach(([n, data]) => {
        const scenId = data.overview.Scenario_ID || `?œë‚˜ë¦¬ì˜¤${n}`;
        const normId = normalizeScenarioId(scenId);
        const scenNum = Number(n);

        // 1) ê¸°ë³¸ ?¤ì›Œ???€: keyword.xlsx ê¸°ì?
        const baseByNum = keywordByScenarioNum.get(scenNum) || [];
        const baseById = keywordByScenarioId.get(normId) || [];
        const merged = [];
        const seen = new Set();
        [...baseByNum, ...baseById].forEach(it => {
          const key = normalizeKeywordText(it.text);
          if (!seen.has(key)) {
            seen.add(key);
            // ?´ìŠ¤ ë©”í? ë³‘í•©(?ˆìœ¼ë©?ì¶”ê?)
            const meta = (newsMetaByScenarioNum.get(scenNum)?.get(key)) || (newsMetaByScenarioId.get(normId)?.get(key)) || null;
            merged.push({ text: key, phase: meta?.phase || '', url: meta?.url || '', title: meta?.title || '', press: meta?.press || '' });
          }
        });

        if (!merged.length) { try { if (['SC004','SC009','SC022'].includes(normId)) console.log('[KW] ?†ìŒ:', scenId); } catch(_) {} return; }
        try { if (['SC004','SC009','SC022'].includes(normId)) console.log('[KW] ë¡œë”©:', scenId, merged.map(it=>it.text)); } catch(_) {}
        merged.forEach((k, idx) => {
          keywordNodes.push({
            id: `kw_${scenId}_${idx}`,
            label: k.text,
            phase: k.phase || '',
            url: (k.url || '').trim(),
            title: (k.title || '').trim(),
            press: (k.press || '').trim(),
            scenarioId: scenId,
            scenarioNum: scenNum,
            type: 'keyword',
            rowIndex: Math.floor(idx / keywordMaxPerRow),
            colIndex: idx % keywordMaxPerRow
          });
        });
      });

      const nodes = [...scenarioNodes, ...keywordNodes];
      // ?„ì—­ ?¤ì›Œ???œë²ˆ(?’ì´ ë°°ì¹˜?? ê³„ì‚°: ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸, ?¼ë²¨ ê¸°ì? ?•ë ¬
      const allKeywordNodes = nodes.filter(n => n.type === 'keyword');
      const globalKwRowById = new Map();
      allKeywordNodes
        .slice()
        .sort((a, b) => {
          const sn = (a.scenarioNum ?? 0) - (b.scenarioNum ?? 0);
          if (sn !== 0) return sn;
          return String(a.label || '').localeCompare(String(b.label || ''));
        })
        .forEach((k, i) => globalKwRowById.set(k.id, i));
      try { console.log('[KW] ì´??¤ì›Œ???¸ë“œ ??', keywordNodes.length); } catch(_) {}

      // ë§í¬ ?ì„±
      const rawLinks = [];
      
      // ?œë‚˜ë¦¬ì˜¤-ì§€??ë§í¬
      Object.entries(scenarioData).forEach(([n, data]) => {
        if (data.links) {
          data.links.forEach(link => {
            const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
            if (indicatorName) {
              rawLinks.push({
                source: indicatorName,
                target: data.overview.Scenario_ID || `?œë‚˜ë¦¬ì˜¤${n}`,
                weight: link.Weight || link.Correlation_Coeff || 1,
                type: 'indicator-scenario'
              });
            }
          });
        }
      });

      // ë§í¬ ?„í„°ë§?
      const allNodeIDs = new Set(nodes.map(n => n.id));
      
      const filteredLinks = rawLinks.filter(link => {
        // 1. source, target??ë¬¸ì?´ì¸ì§€ ?•ì¸
        if (typeof link.source !== 'string' || typeof link.target !== 'string') return false;
        
        // 2. source, target???¸ë“œ??ì¡´ì¬?˜ëŠ”ì§€ ?•ì¸
        if (!allNodeIDs.has(link.target)) return false; // ?œë‚˜ë¦¬ì˜¤ë§??•ì¸
        
        return true;
      });

      // D3 ?œë??ˆì´???¤ì •
      // ?¤ì›Œ???¸ë“œ???œë??ˆì´???€?ì—???œì™¸?˜ì—¬ ì´ˆê¸° ë°°ì¹˜ê°€ ë³€?˜ì? ?Šë„ë¡???
      const simulation = d3.forceSimulation(scenarioNodes)
        .force("link", d3.forceLink([]).id(d => d.id).distance(200).strength(0.3))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      // ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ ?„ì¹˜ ?¤ì • (2??ë°°ì¹˜) - ì¤‘ê°„ ?„ì¹˜ ê¸°ì?
      const cols = 2;
      const colGap = 400; // ì¢Œìš° ê°„ê²© ?ë‹¹??ì¡°ì • (350 ??400)
      // ?œë‚˜ë¦¬ì˜¤ ?„ì²´ ?’ì´ ê³„ì‚° (2??ê¸°ì?)
      const scenarioRows = Math.ceil(scenarioNodes.length / 2);
      const scenarioTotalHeight = (scenarioRows - 1) * SCENARIO_ROW_GAP;
      const startY = layoutCenterY - scenarioTotalHeight / 2; // ì¤‘ê°„ ?„ì¹˜ ê¸°ì?
      const colX = [width / 2 - colGap / 2, width / 2 + colGap / 2];

      scenarioNodes.forEach((node, i) => {
        const col = i % cols;
        const row = Math.floor(i / cols);
        const baseY = startY + row * SCENARIO_ROW_GAP;
        const offset = (i % 2 === 0) ? -10 : 10;
        
        node.fx = colX[col];
        node.fy = baseY + offset;
        // ?œë??ˆì´???œì‘ ?„ì— ê³ ì • ì¢Œí‘œë¡?ì´ˆê¸°?”í•˜??? ì´ ?•í™•???´ë‹¹ ?œë‚˜ë¦¬ì˜¤???°ê²°?˜ë„ë¡???
        node.x = node.fx;
        node.y = node.fy;

        // ?¸ë? ?œì–´???„ì¹˜ ?€??
        graphState.posByScenarioNum.set(node.n, { x: node.fx, y: node.fy });
      });

      // ?¤ì›Œ???´íŒ ?˜ë¦¬ë¨¼íŠ¸ ?ì„±(ìµœìƒ?? ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ë³´ë‹¤ ??
      let kwTooltip = document.getElementById('kw-tooltip');
      if (!kwTooltip) {
        kwTooltip = document.createElement('div');
        kwTooltip.id = 'kw-tooltip';
        kwTooltip.className = 'kw-tooltip';
        document.body.appendChild(kwTooltip);
      }

      // (?¤ì›Œ???´ë? ë°°ì¹˜???œë‚˜ë¦¬ì˜¤ ê·¸ë£¹ ?ì„± ?´í›„???˜í–‰)

      // ?œì¥ì§€???Œë”ë§?(???¬ê³  ?¸ë ¨???”ì?? - nodeLayer??ì¶”ê?
      const indicatorGroup = nodeLayer.selectAll(".indicator-group")
        .data(indicatorNodes)
        .enter().append("g")
        .attr("class", "indicator-group")
        .attr("transform", d => `translate(${d.x}, ${d.y})`)
        .style("cursor", "pointer")
        .on("click", function(event, d) {
          // ?ˆì „?¥ì¹˜: indicator.xlsx??ì¡´ì¬?˜ëŠ” ì§€?œë§Œ ?´ë¦­ ì²˜ë¦¬
          if (d.indicatorId && indicatorIdToNameMap.has(d.indicatorId)) {
            // IND500~IND532 ë²”ìœ„??ì§€?œëŠ” RISK_MONITOR.htmlë¡??´ë™
            const id = String(d.indicatorId);
            const num = parseInt(id.slice(3), 10);
            if (!Number.isNaN(num) && num >= 500 && num <= 532) {
              window.open('RISK_MONITOR.html', '_blank');
            } else {
              // ê¸°ì¡´ ì§€?œëŠ” ?œê³„??ì°¨íŠ¸ ?´ê¸° - displayName(Indicator_Name) ?¬ìš©
              openTimeseriesChart(d.indicatorId, d.displayName || d.name);
            }
          } else if (d.indicatorId && !indicatorIdToNameMap.has(d.indicatorId)) {
            // indicator.xlsx?ì„œ ?? œ??ì§€???´ë¦­ ???Œë¦¼
            console.warn(`? ï¸ ì§€??${d.indicatorId}??indicator.xlsx??ì¡´ì¬?˜ì? ?ŠìŠµ?ˆë‹¤.`);
            alert(`??ì§€??${d.indicatorId})?????´ìƒ ?¬ìš©?????†ìŠµ?ˆë‹¤.\nê´€ë¦¬ì?ê²Œ ë¬¸ì˜?˜ì„¸??`);
          }
        })
        .on("mouseenter", function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", d => `translate(${d.x}, ${d.y}) scale(1.2)`);
          
          d3.select(this).selectAll("circle")
            .transition()
            .duration(200)
            .style("filter", "drop-shadow(0 3px 8px rgba(0,0,0,0.3))");
        })
        .on("mouseleave", function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr("transform", d => `translate(${d.x}, ${d.y}) scale(1)`);
          
          d3.select(this).selectAll("circle")
            .transition()
            .duration(200)
            .style("filter", "none");
        });
      
      // ?¸ê³½ ?Œë‘ë¦?(ê·¸ë¦¼???¨ê³¼)
      indicatorGroup.append("circle")
        .attr("r", 18) // ?¸ê³½ ??
        .attr("fill", "rgba(0,0,0,0.2)")
        .attr("transform", "translate(2, 2)"); // ê·¸ë¦¼???¨ê³¼
      
      // ë©”ì¸ ?í˜•
      indicatorGroup.append("circle")
        .attr("class", "indicator-main")
        .attr("r", 16) // ?¬ê¸° ?•ë? (12 ??16)
        .attr("fill", d => d.color)
        .attr("stroke", d => {
          // d.indicatorId ?? "IND500" ?•ì‹ ê°€??ë¹„ì •???¬ë§·???ˆì „ ì²˜ë¦¬)
          const id = (d && d.indicatorId) ? String(d.indicatorId) : "";
          const num = parseInt(id.slice(3), 10); // "IND" ?´í›„ ?«ìë§??Œì‹±
          // ?ˆë¡œ ì¶”ê???êµ¬ê°„(IND500 ?´ìƒ)?€ ë¹¨ê°•???¸ê³½?? ?˜ë¨¸ì§€??ê¸°ì¡´(#fff)
          if (!Number.isNaN(num) && num >= 500) return "#E53935";
          return "#fff";
        })
        .attr("stroke-width", 3); // ?Œë‘ë¦??ê»˜ ? ì?
      
      // ?´ë? ?˜ì´?¼ì´??(ê´‘íƒ ?¨ê³¼)
      indicatorGroup.append("circle")
        .attr("r", 6)
        .attr("fill", "rgba(255,255,255,0.3)")
        .attr("transform", "translate(-3, -3)") // ?¼ìª½ ???˜ì´?¼ì´??
        .style("pointer-events", "none");
      
      // ???˜ì? ?´íŒ êµ¬í˜„
      indicatorGroup.append("title")
        .text(d => {
          if (d.indicatorId) {
            return `${d.name} (${d.indicatorId})`;
          }
          return d.name || 'Bloomberg Ticker ?•ë³´ ?†ìŒ';
        });
      
      // ?¸ë””ì¼€?´í„° ?‰ìƒ(C1 ?Œë˜ê·? ë¹„ë™ê¸?ë°˜ì˜
      (async () => {
        const nodes = indicatorGroup.nodes();
        for (const node of nodes) {
          try {
            const d = d3.select(node).datum();
            if (!d || !d.indicatorId) continue;
            const flag = await fetchIndicatorFlag(d.indicatorId);
            const fill = flag === 'Y' ? '#FF8A00' : '#B3E5FC';
            d3.select(node).select('.indicator-main').attr('fill', fill);
          } catch (_) { /* ignore */ }
        }
      })();

      // GPT1 ?µì»¤ ?œê°??- nodeLayer??ì¶”ê?
      const gptAnchorGroup = nodeLayer.append('g')
        .attr('class', 'gpt1-anchor')
        .attr('transform', `translate(${gptAnchorX}, ${gptAnchorY})`);

      gptAnchorGroup.append('rect')
        .attr('x', -110)
        .attr('y', -28)
        .attr('width', 220)
        .attr('height', 56)
        .attr('fill', '#2c2c2c')
        .attr('stroke', '#7ab7ff')
        .attr('stroke-width', 2)
        .attr('rx', 12)
        .attr('ry', 12);

      gptAnchorGroup.append('text')
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .attr('fill', '#fff')
        .attr('font-weight', 'bold')
        .attr('font-size', '1.2em')
        .text('?°ì´?°ì§‘ê³?);

      // GPT2, GPT3 ?µì»¤ ?œê°??(?°ì¸¡?¼ë¡œ ?Œì´?„ë¼???œì‹œ)
      // gpt2ë¶€???¤ë¥¸ìª½ìœ¼ë¡??´ë™ (gpt1?’gpt2ë§?300?¼ë¡œ ?¹ìˆ˜ ì¡°ì •)
      const gpt2AnchorX = gptAnchorX + GAP_GPT1_TO_GPT2;
      const gpt2AnchorY = gptAnchorY;
      const gpt3AnchorX = gpt2AnchorX + GAP_X;
      const gpt3AnchorY = gptAnchorY;
      const gpt4AnchorX = gpt3AnchorX + GAP_X;
      const gpt4AnchorY = gptAnchorY;

      const gpt2AnchorGroup = nodeLayer.append('g')
        .attr('class', 'gpt2-anchor')
        .attr('transform', `translate(${gpt2AnchorX}, ${gpt2AnchorY})`);
      gpt2AnchorGroup.append('rect')
        .attr('x', -110).attr('y', -28).attr('width', 220).attr('height', 56)
        .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
        .attr('rx', 12).attr('ry', 12);
      gpt2AnchorGroup.append('text')
        .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
        .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '1.2em')
        .text('ë¶„ì„ ì¤‘ê³„');

      // GPT3 ?„ë©”???ì´?„íŠ¸ 5ê°??µì»¤ (?¸ë¡œ ?¤íƒ)
      const gpt3Agents = [
        { id: 'market', label: '?œì¥ë¦¬ìŠ¤???ì´?„íŠ¸' },
        { id: 'credit', label: '? ìš©ë¦¬ìŠ¤???ì´?„íŠ¸' },
        { id: 'alm', label: 'ALM ?ì´?„íŠ¸' },
        { id: 'global', label: 'ê¸€ë¡œë²Œë¦¬ìŠ¤???ì´?„íŠ¸' },
        { id: 'creditpf', label: '? ìš©?¬íŠ¸?´ë¦¬???ì´?„íŠ¸' }
      ];

      const gpt3Groups = gpt3Agents.map((agent, idx) => {
        const gy = gpt3AnchorY + (idx - 2) * 80; // ?„ì•„?˜ë¡œ ë°°ì¹˜
        const grp = nodeLayer.append('g')
          .attr('class', `gpt3-anchor-${agent.id}`)
          .attr('transform', `translate(${gpt3AnchorX}, ${gy})`);
        grp.append('rect')
          .attr('x', -130).attr('y', -24).attr('width', 260).attr('height', 48)
          .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
          .attr('rx', 12).attr('ry', 12);
        grp.append('text')
          .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
          .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '0.95em')
          .text(agent.label);
        return { id: agent.id, x: gpt3AnchorX, y: gy };
      });

      // GPT0 ?œë¸Œ?ì´?„íŠ¸ (?¬ì „?˜ì§‘ ?˜ìœ„, ì¢Œì¸¡ ?¤íƒ)
      // gpt0ë¥??œë‚˜ë¦¬ì˜¤ ìª½ìœ¼ë¡??´ë™ (gpt1?ì„œ ??ì¹?GAP_X ë§Œí¼ ì¢Œì¸¡)
      const gpt0AnchorX2 = gptAnchorX - GAP_GPT0_FROM_GPT1;
      const gpt0Agents = [
        { id: 'marketdata', label: 'ë§ˆì¼“?°ì´??ë¶„ì„' },
        { id: 'news',       label: 'ê¸°ì‚¬?´ìŠ¤ ë¶„ì„' },
        { id: 'scenario-summary', label: '?œë‚˜ë¦¬ì˜¤ ?”ì•½ë¶„ì„' },
        { id: 'marketstate',label: '?„ì¬ ?œí™©ë¶„ì„' }
      ];
      const gpt0Groups = gpt0Agents.map((agent, idx) => {
        const gy = gptAnchorY + (idx - 1.5) * 80;
        const grp = nodeLayer.append('g')
          .attr('class', `gpt0-anchor-${agent.id}`)
          .attr('transform', `translate(${gpt0AnchorX2}, ${gy})`);
        grp.append('rect')
          .attr('x', -130).attr('y', -24).attr('width', 260).attr('height', 48)
          .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
          .attr('rx', 12).attr('ry', 12);
        grp.append('text')
          .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
          .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '0.95em')
          .text(agent.label);
        return { id: agent.id, x: gpt0AnchorX2, y: gy };
      });

      // GPT ?Œì´?„ë¼???¼ì¸ ?œì‹œ (GPT0 ??GPT1 ??GPT2 ??GPT3 ??GPT4)
      const pipelineColor = '#7ab7ff';
      const pipelineGroup = linkLayer.append('g').attr('class','pipeline');
      // GPT0 ?ˆë¸Œ ?„ì¹˜(?œë‚˜ë¦¬ì˜¤Â·?œë¸Œ?ì´?„íŠ¸ ? ì´ ëª¨ì´??ì§€??
      // ?œë‚˜ë¦¬ì˜¤ ê³µí†µ ê¼???ì? drawScenarioConnections?ì„œ ê³„ì‚°(commonHubX/Y)
      // ?¬ê¸°?œëŠ” gpt0 ??ê³µí†µ ?ˆë¸Œ, ê³µí†µ ?ˆë¸Œ ??gpt1 ?¼ì¸ë§?? ì?
      const gptHubX = gpt0AnchorX2 - 500; // ê³µí†µ ê¼???ê³¼ ?¼ì¹˜ (gpt0ê°€ ?´ë™?˜ë©´ ?ˆë¸Œ???¨ê»˜ ?´ë™)
      // ê³µí†µ ?ˆë¸Œ ??GPT0 ê°?ëª¨ë“ˆ ?ì„  (gpt3 ë¶„ê¸° ?¤í???
      gpt0Groups.forEach(({x, y}) => {
        const c1x = gptHubX + 320;   // ì¶œë°œ ì»¨íŠ¸ë¡??¬ì¸??
        const c2x = x - 320;         // ?„ì°© ì»¨íŠ¸ë¡??¬ì¸??
        pipelineGroup.append('path').lower()
          .attr('d', `M ${gptHubX},${gptAnchorY} C ${c1x},${gptAnchorY} ${c2x},${y} ${x - 140},${y}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0)
          .attr('class','pipeline-line to-gpt0')
          .attr('data-from','hub')
          .attr('data-to','gpt0')
          .style('cursor', 'default');
      });
      // GPT0 ê°?ëª¨ë“ˆ ??GPT1 ?ì„  (gpt3?’gpt4?€ ?™ì¼ ?¤í???
      gpt0Groups.forEach(({x, y}) => {
        const c1x = x + 320;
        const c2x = gptAnchorX - 320;
        pipelineGroup.append('path').lower()
          .attr('d', `M ${x + 140},${y} C ${c1x},${y} ${c2x},${gptAnchorY} ${gptAnchorX - 120},${gptAnchorY}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0)
          .attr('class','pipeline-line to-gpt1')
          .attr('data-from','gpt0')
          .attr('data-to','gpt1')
          .style('cursor', 'default');
      });

      pipelineGroup.append('line')
        .attr('x1', gptAnchorX + 120).attr('y1', gptAnchorY)
        .attr('x2', gpt2AnchorX - 120).attr('y2', gpt2AnchorY)
        .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
        .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0).attr('class','pipeline-line to-gpt2')
        .attr('data-from','gpt1')
        .attr('data-to','gpt2')
        .style('cursor', 'default');
      // GPT2 ??GPT3 ê°??„ë©”?¸ìœ¼ë¡?ë¶„ê¸°
      gpt3Groups.forEach(({x, y}) => {
        const c1x = gpt2AnchorX + 320; // ì¶œë°œ ìª?ì»¨íŠ¸ë¡??¬ì¸??ê±°ë¦¬ ?•ë?)
        const c2x = x - 320;           // ?„ì°© ìª?ì»¨íŠ¸ë¡??¬ì¸??ê±°ë¦¬ ?•ë?)
        pipelineGroup.append('path').lower()
          .attr('d', `M ${gpt2AnchorX + 120},${gpt2AnchorY} C ${c1x},${gpt2AnchorY} ${c2x},${y} ${x - 140},${y}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0).attr('class','pipeline-line to-gpt3')
          .attr('data-from','gpt2')
          .attr('data-to','gpt3')
          .style('cursor', 'default');
      });

      // GPT4 ?µì»¤ ?œê°??(GPT3 ?¤ë¥¸ìª?
      const gpt4AnchorGroup = g.append('g')
        .attr('class', 'gpt4-anchor')
        .attr('transform', `translate(${gpt4AnchorX}, ${gpt4AnchorY})`);
      gpt4AnchorGroup.append('rect')
        .attr('x', -110).attr('y', -28).attr('width', 220).attr('height', 56)
        .attr('fill', '#2c2c2c').attr('stroke', '#7ab7ff').attr('stroke-width', 2)
        .attr('rx', 12).attr('ry', 12);
      gpt4AnchorGroup.append('text')
        .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
        .attr('fill', '#fff').attr('font-weight', 'bold').attr('font-size', '1.2em')
        .text('ìµœì¢… ë¦¬í¬??);

      // GPT3 ??GPT4 ?Œì´?„ë¼???¼ì¸
      gpt3Groups.forEach(({x, y}) => {
        const c1x = x + 320;
        const c2x = gpt4AnchorX - 320;
        pipelineGroup.append('path').lower()
          .attr('d', `M ${x + 140},${y} C ${c1x},${y} ${c2x},${gpt4AnchorY} ${gpt4AnchorX - 120},${gpt4AnchorY}`)
          .attr('fill', 'none')
          .attr('stroke', pipelineColor).attr('stroke-width', 4).attr('stroke-opacity', 1)
          .attr('stroke-dasharray', '10,8').attr('stroke-dashoffset', 0).attr('class','pipeline-line to-gpt4')
          .attr('data-from','gpt3')
          .attr('data-to','gpt4')
          .style('cursor', 'default');
      });

      // ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ ?Œë”ë§?(ì§ì‚¬ê°í˜• ë°•ìŠ¤) - nodeLayer??ì¶”ê?
      const scenarioGroup = nodeLayer.selectAll(".scenario-group")
        .data(scenarioNodes)
        .enter().append("g")
        .attr("class", "scenario-group")
        .attr("data-scen", d => d.n);
      
      // ì§ì‚¬ê°í˜• ë°•ìŠ¤ - ?¤ì›Œ?œê? ?´ë????¤ì–´ê°????ˆë„ë¡??•ë????¬ê¸° ë°˜ì˜
      const scenarioNode = scenarioGroup.append("rect")
        .attr("class", "scenario-node")
        .attr("x", -SCENARIO_HALF_WIDTH)
        .attr("y", -SCENARIO_HALF_HEIGHT)
        .attr("width", SCENARIO_BOX_WIDTH)
        .attr("height", SCENARIO_BOX_HEIGHT)
        .attr("fill", "#f39c12")
        .attr("stroke", "#e67e22")
        .attr("stroke-width", 2)
        .attr("rx", 15) // ëª¨ì„œë¦??¥ê?ê²?
        .attr("ry", 15)
        .style("cursor", "pointer")
        .on("click", function(event, d) {
          // ? ï¸ ?¤ì›Œ??ë°•ìŠ¤ ?´ë¦­??ê²½ìš° ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?´ë¦­ ?´ë²¤??ë¬´ì‹œ
          const clickedElement = event.target;
          const isKeywordClick = clickedElement.closest('.keyword-node');
          if (isKeywordClick) {
            return; // ?¤ì›Œ???´ë¦­?´ë©´ ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?´ë²¤???¤í–‰ ????
          }
          
          // ??ë³€ê²? ë°•ìŠ¤ ?´ë¦­ ???œë‚˜ë¦¬ì˜¤ ? íƒ ë°??°ì´??ì¤€ë¹?
          const scenNum = d.n ?? d.number ?? d.scenarioNumber;
          const scenName = d.name ?? d.title ?? `?œë‚˜ë¦¬ì˜¤ ${scenNum}`;
          
          // ?°ê²°???œì¥?°ì´???•ë³´ ?œì‹œ (onClickScenarioToGptLink ?¨ìˆ˜ ?¸ì¶œ)
          if (typeof onClickScenarioToGptLink === 'function') {
            onClickScenarioToGptLink(scenNum);
          }
          
          // ?“± ëª¨ë°”???˜ê²½ ì²´í¬ ë°?GPT0 ì¹´ë“œë§??œì‹œ
          if (typeof showOnlyGpt0CardMobile === 'function') {
            showOnlyGpt0CardMobile();
          }
          
          // ?°ê²°???˜ì´?¼ì´??(?œê°???œì‹œë§?
          highlightConnection({ type: 'scenario-to-gpt', scenarioNumber: scenNum });
          
          // ? ï¸ gotoStep ?œê±°: ë¶„ì„?¤í–‰ ë²„íŠ¼???´ë¦­?´ì•¼ GPT0ë¶€???œì‘
          // ??ìµœìƒ??ë¶„ì„?œì‘ ë²„íŠ¼ ?„ì¹˜)?¼ë¡œ ?¤í¬ë¡?
          const panel = document.querySelector('.sidebar-right, aside.sidebar-right, #gpt1-panel');
          if (panel) {
            setTimeout(() => {
              try {
                panel.scrollTo({ top: 0, behavior: 'smooth' });
              } catch(_) {}
            }, 100);
          }
          
          // ?´ë¦­???¸ë“œ ?˜ì´?¼ì´??
          scenarioGroup.selectAll("rect").attr("stroke", "#e67e22").attr("stroke-width", 2);
          d3.select(this).attr("stroke", "#e74c3c").attr("stroke-width", 4);
        });

      // ?œë‚˜ë¦¬ì˜¤ ?¼ë²¨ (ì§ì‚¬ê°í˜• ë°•ìŠ¤ ?ˆì— ì§ì ‘ ë°°ì¹˜) - ?’ì´ ì¶•ì†Œ??ë§ì¶° ?ìŠ¤???„ì¹˜ ì¡°ì •
      scenarioGroup.each(function(d) {
        const group = d3.select(this);
        const words = d.name.split(' ');
        
        if (words.length > 2) { // ???ì? ?¨ì–´?˜ì—?œë„ ì¤„ë°”ê¿?
          // ê¸??ìŠ¤?¸ëŠ” ??ì¤„ë¡œ ë¶„í• 
          const midPoint = Math.ceil(words.length / 2);
          const firstLine = words.slice(0, midPoint).join(' ');
          const secondLine = words.slice(midPoint).join(' ');
          
          group.append("text")
            .attr("text-anchor", "middle")
            .attr("fill", "white")
            .attr("font-size", () => window.innerWidth <= 900 ? "1.4em" : "1.1em") // ëª¨ë°”?¼ì—???°íŠ¸ ?¬ê¸° ì¦ê?
            .attr("font-weight", "bold")
            .attr("y", -SCENARIO_HALF_HEIGHT + 20) // ?¼ë²¨ ì²?ì¤?
            .style("pointer-events", "none")
            .text(firstLine);
            
          group.append("text")
            .attr("text-anchor", "middle")
            .attr("fill", "white")
            .attr("font-size", () => window.innerWidth <= 900 ? "1.4em" : "1.1em") // ëª¨ë°”?¼ì—???°íŠ¸ ?¬ê¸° ì¦ê?
            .attr("font-weight", "bold")
            .attr("y", -SCENARIO_HALF_HEIGHT + 40) // ?¼ë²¨ ??ë²ˆì§¸ ì¤?
            .style("pointer-events", "none")
            .text(secondLine);
        } else {
          // ì§§ì? ?ìŠ¤?¸ëŠ” ??ì¤„ë¡œ
          group.append("text")
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .attr("fill", "white")
            .attr("font-size", () => window.innerWidth <= 900 ? "1.6em" : "1.3em") // ëª¨ë°”?¼ì—???°íŠ¸ ?¬ê¸° ì¦ê?
            .attr("font-weight", "bold")
            .attr("y", -SCENARIO_HALF_HEIGHT + 30)
            .style("pointer-events", "none")
            .text(d.name);
        }
      });

      // ?“Œ '?œë‚˜ë¦¬ì˜¤?´ìš©' ë²„íŠ¼ ì¶”ê? (PDF ?¤í”ˆ ?„ìš©) - ë°•ìŠ¤ ?´ë? ë§??„ë˜
      scenarioGroup.each(function(d) {
        const group = d3.select(this);
        
        // ë²„íŠ¼ ?¬ê¸° ?¤ì • (?’ì´ë¥?ë°˜ìœ¼ë¡?ì¤„ì„)
        const buttonWidth = 160;
        const buttonHeight = 12;
        
        // ë²„íŠ¼ ê·¸ë£¹ ?ì„± (ë°•ìŠ¤ ë§??„ë˜ ë°°ì¹˜)
        const docBtn = group.append('g')
          .attr('class', 'scenario-doc-btn')
          .attr('transform', `translate(${-buttonWidth / 2}, ${SCENARIO_HALF_HEIGHT - buttonHeight - 6})`)
          .style('cursor', 'pointer')
          .on('click', function(event, d) {
            // ë¶€ëª?ë°•ìŠ¤) ?´ë¦­(=ë¶„ì„ì¤€ë¹? ?„íŒŒ ë°©ì?
            event.stopPropagation();
            
            const scenNum = d.n ?? d.number ?? d.scenarioNumber;
            const scenName = d.name ?? d.title ?? `?œë‚˜ë¦¬ì˜¤ ${scenNum}`;
            
            // ê¸°ì¡´ PDF ?¤í”ˆ ?¨ìˆ˜ ?¸ì¶œ
            openScenarioPDF(scenNum, scenName);
          });
        
        // ë²„íŠ¼ ë°°ê²½
        docBtn.append('rect')
          .attr('rx', 8).attr('ry', 8)
          .attr('width', buttonWidth).attr('height', buttonHeight)
          .attr('fill', '#1e88e5')
          .attr('opacity', 0.9);
        
        // ë²„íŠ¼ ?ìŠ¤??(?‘ì? ?°íŠ¸ë¡?ì¡°ì •)
        docBtn.append('text')
          .attr('x', buttonWidth / 2).attr('y', buttonHeight / 2 + 1)
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .attr('fill', '#fff')
          .attr('font-size', 10)
          .attr('font-weight', 'bold')
          .style('pointer-events', 'none')
          .text('?œë‚˜ë¦¬ì˜¤?´ìš©');
      });

      // ?°ê²°? ì´ ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?„ë¡œ ?¬ë¼?¤ì? ?Šë„ë¡? ?œë‚˜ë¦¬ì˜¤ ê·¸ë£¹??ìµœìƒ?„ë¡œ ?¬ë¦¼
      scenarioGroup.raise();

      // === ?¤ì›Œ?œë? ê°??œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?´ë???ë°°ì¹˜ ===
      scenarioGroup.each(function(d){
        const group = d3.select(this);
        const scenNum = Number(d.n);
        const itemsAll = keywordNodes.filter(k => k.scenarioNum === scenNum);
        if (!itemsAll || !itemsAll.length) return;

        // 4??ë°°ì¹˜ (ê³ ì • ë°•ìŠ¤ ?’ì´ ?´ì—?œë§Œ ?œì‹œ)
        const cols = 4; // ?´ë? ì¹¼ëŸ¼ ??
        const boxW = 82, boxH = 22, hGap = 10, vGap = 8; // 4x3 ë°°ì¹˜??ë§ì¶° ê°€ë¡??•ì¥, ?½ê°„ ?’ì„
        const padX = 14; // ?‘ì˜† ?¬ë°± ?Œí­ ?•ë?
        const padTop = SCENARIO_LABEL_AREA + 10; // ?¼ë²¨ê³??¤ì›Œ??ê°„ê²© ì¡°ê¸ˆ ???•ë³´
        const startX = -SCENARIO_HALF_WIDTH + padX;
        const startY = -SCENARIO_HALF_HEIGHT + padTop;
        // ê³ ì • ë°•ìŠ¤ ?’ì´??ë§ëŠ” ìµœë? ???„ì´????ê³„ì‚°
        const usableHeight = SCENARIO_BOX_HEIGHT - padTop - 14;
        const maxRows = Math.max(1, Math.floor(usableHeight / (boxH + vGap)));
        const maxItems = cols * maxRows;
        const items = itemsAll.slice(0, maxItems);

        items.forEach((it, idx) => {
          const col = idx % cols;
          const row = Math.floor(idx / cols);
          it.kx = startX + col * (boxW + hGap);
          it.ky = startY + row * (boxH + vGap);
          it.width = boxW; it.height = boxH; it.kwidth = boxW; it.kheight = boxH;
        });

        const kw = group.selectAll('.keyword-node')
          .data(items, d => d.id)
          .enter().append('g')
          .attr('class', 'keyword-node')
          .attr('transform', d => `translate(${d.kx}, ${d.ky})`)
          .style('cursor', d => (d.title && d.title.trim()) ? 'pointer' : 'default')
          .on('click', function(event, d){
            // ?”¥ 1. ?ìœ„ ?´ë²¤???„íŒŒ ì°¨ë‹¨ (?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?´ë¦­ ë°©ì?)
            event.stopPropagation();
            event.preventDefault();
            
            const url = (d.url || '').trim();
            if (!url) return;
            
            // ?”¥ 2. ëª¨ë°”??ê°ì?
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                          || window.innerWidth <= 900;
            
            // ?”¥ 3. PC?€ ëª¨ë°”???™ì‘ ?µì¼: ì§ì ‘ ?´ìŠ¤ ?˜ì´ì§€ë¡??´ë™
            try {
              if (isMobile) {
                // ëª¨ë°”?? ì§ì ‘ ?´ìŠ¤ URLë¡???????ì°??´ê¸° (?ì—… ì°¨ë‹¨ ë°©ì?)
                window.open(url, '_blank', 'noopener,noreferrer');
              } else {
                // PC: ëª¨ë‹¬ ë°©ì‹ ?œë„, ?¤íŒ¨ ??ì§ì ‘ ë§í¬ë¡?
                try {
                  openNewsModal(d.label, url);
                } catch(modalErr) {
                  console.warn('ëª¨ë‹¬ ?´ê¸° ?¤íŒ¨, ì§ì ‘ ë§í¬ë¡??´ë™:', modalErr);
                  window.open(url, '_blank', 'noopener,noreferrer');
                }
              }
            } catch(err) {
              console.error('?´ìŠ¤ ë§í¬ ?´ê¸° ?¤íŒ¨:', err);
              // ìµœì¢… fallback: ?„ì¬ ??—???´ë™
              window.location.href = url;
            }
          });

        // Phase ?‰ìƒ???°ë¥¸ ê¹œë°•???¨ê³¼ ë°??‰ìƒ ì§€??(ëª¨ë“  ?¤ì›Œ???ì„±)
        kw.append('rect')
          .attr('width', d => d.width)
          .attr('height', d => d.height)
          .each(function(d){
            const phase = String(d.phase || '').toLowerCase();
            if (phase === 'yellow' || phase === 'y') d3.select(this.parentNode).classed('kw-blink-yellow', true);
            if (phase === 'red' || phase === 'r') d3.select(this.parentNode).classed('kw-blink-red', true);
          })
          .attr('stroke', function(d){
            const phase = String(d.phase || '').toLowerCase();
            if (phase === 'yellow' || phase === 'y') return '#FFD54F';
            if (phase === 'red' || phase === 'r') return '#E53935';
            return '#c3c8d0';
          });

        kw.each(function(d){
          const el = d3.select(this);
          el.append('text')
            .attr('x', d.width / 2)
            .attr('y', d.height / 2 + 0.5)
            .style('font-size', '11px')
            .text(d.label);
        })
        .on('mouseenter', function(event, d){
          const scenKey = normalizeScenarioId(d.scenarioId || '');
          const ktext = normalizeKeywordText(d.label || '');
          const meta = findNewsMeta(scenKey, d.scenarioNum, ktext);
          const effectiveTitle = (d.title && d.title.trim()) || meta?.title || '';
          const effectivePress = (d.press && d.press.trim()) || meta?.press || '';
          if (!effectiveTitle) return;
          const press = effectivePress ? ` [${effectivePress}]` : '';
          kwTooltip.textContent = effectiveTitle + press;
          kwTooltip.style.display = 'block';
          const pad = 12;
          kwTooltip.style.left = (event.clientX + pad) + 'px';
          kwTooltip.style.top = (event.clientY + pad) + 'px';
        })
        .on('mousemove', function(event, d){
          const scenKey = normalizeScenarioId(d.scenarioId || '');
          const ktext = normalizeKeywordText(d.label || '');
          const meta = findNewsMeta(scenKey, d.scenarioNum, ktext);
          const effectiveTitle = (d.title && d.title.trim()) || meta?.title || '';
          if (!effectiveTitle) return;
          const pad = 12;
          kwTooltip.style.left = (event.clientX + pad) + 'px';
          kwTooltip.style.top = (event.clientY + pad) + 'px';
        })
        .on('mouseleave', function(){
          kwTooltip.style.display = 'none';
        });
      });

      // ëª¨ë“  ?œë‚˜ë¦¬ì˜¤???€??ì§€???°ê²°??ê·¸ë¦¬ê¸?(ì§€?? + GPT1 ?°ê²°??(?œë‚˜ë¦¬ì˜¤?’GPT1)
      async function drawScenarioConnections(scenarioNumber) {
        // ?œë‚˜ë¦¬ì˜¤ë³??‰ìƒ ?•ì˜
        const colors = [
          '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
          '#e67e22', '#1abc9c', '#34495e', '#f1c40f', '#95a5a6',
          '#c0392b', '#2980b9', '#27ae60', '#d35400', '#8e44ad',
          '#16a085', '#2c3e50', '#f39c12', '#bdc3c7', '#7f8c8d',
          '#e8c547', '#5dade2', '#58d68d', '#ec7063', '#af7ac5',
          '#fad7a0', '#85c1e9', '#a9dfbf', '#f1948a', '#d7bde2',
          '#fdeaa7', '#a3d4f7', '#c8e6c9', '#ffcdd2', '#e1bee7'
        ];
        
        const color = colors[(scenarioNumber - 1) % colors.length];
        
        // ?´ë‹¹ ?œë‚˜ë¦¬ì˜¤??ê´€??ì§€?œë“¤ ê°€?¸ì˜¤ê¸?(ID?€ ?´ë¦„ ëª¨ë‘ ?¬í•¨)
        let scenarioIndicators = [];
        
        // ëª¨ë“  ?œë‚˜ë¦¬ì˜¤?ì„œ INDICATOR ?œíŠ¸ë¥??°ì„  ?¬ìš© (?°ì´??ë¶ˆì¼ì¹??´ê²°)
        if (scenarioData[scenarioNumber] && scenarioData[scenarioNumber].indicators && scenarioData[scenarioNumber].indicators.length > 0) {
          console.log(`?”§ ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: INDICATOR ?œíŠ¸ ?°ì„  ?¬ìš©`);
          
          scenarioIndicators = scenarioData[scenarioNumber].indicators.map(indicator => {
            const indicatorName = indicatorIdToNameMap.get(indicator.Indicator_ID);
            
            // ?¹ì • ?œë‚˜ë¦¬ì˜¤ ?”ë²„ê¹?
            if (indicator.Indicator_ID === 'IND111' || scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
              console.log(`?” ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber} (INDICATOR ?œíŠ¸): ${indicator.Indicator_ID} -> ${indicatorName || 'undefined'}`);
            }
            
            // LINKS ?œíŠ¸?ì„œ ?´ë‹¹ ì§€?œì˜ ê°€ì¤‘ì¹˜/?ê?ê³„ìˆ˜ ì°¾ê¸° (?ˆìœ¼ë©?
            const linkData = scenarioData[scenarioNumber].links?.find(link => link.Indicator_ID === indicator.Indicator_ID);
            
            return indicatorName ? {
              id: indicator.Indicator_ID,
              name: indicatorName,
              weight: linkData?.Weight || 1.0, // ê¸°ë³¸ ê°€ì¤‘ì¹˜
              correlation: linkData?.Correlation_Coeff || 0.0 // ê¸°ë³¸ ?ê?ê³„ìˆ˜
            } : null;
          }).filter(Boolean);
          
        } else if (scenarioData[scenarioNumber] && scenarioData[scenarioNumber].links) {
          // Fallback: INDICATOR ?œíŠ¸ê°€ ?†ê±°??ë¹„ì–´?ˆìœ¼ë©?LINKS ?œíŠ¸ ?¬ìš©
          console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: INDICATOR ?œíŠ¸ ?†ìŒ, LINKS ?œíŠ¸ ?¬ìš©`);
          
          scenarioIndicators = scenarioData[scenarioNumber].links.map(link => {
            const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
            
            // ?¹ì • ?œë‚˜ë¦¬ì˜¤ ?”ë²„ê¹?
            if (link.Indicator_ID === 'IND111' || scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
              console.log(`?” ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber} (LINKS ?œíŠ¸): ${link.Indicator_ID} -> ${indicatorName || 'undefined'}`);
            }
            
            return indicatorName ? {
              id: link.Indicator_ID,
              name: indicatorName,
              weight: link.Weight,
              correlation: link.Correlation_Coeff
            } : null;
          }).filter(Boolean);
        }
        
        // ?œë‚˜ë¦¬ì˜¤ 7, 13, 22, 30???€??ì¶”ê? ?”ë²„ê¹?
        if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
          console.log(`?” ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ?ì„¸ ?°ê²° ?•ë³´:`);
          console.log(`?ë³¸ links:`, scenarioData[scenarioNumber]?.links?.map(l => l.Indicator_ID));
          console.log(`ë§¤í•‘??ì§€?œë“¤:`, scenarioIndicators.map(s => `${s.id} -> "${s.name}"`));
          
                     // ?œë‚˜ë¦¬ì˜¤ë³??¹ë³„ ?ì„¸ ë¶„ì„
           if (scenarioNumber === 7) {
             console.log(`?“Š === ?œë‚˜ë¦¬ì˜¤ 07 ë§ˆì¼“?°ì´???°ê²° ?ì„¸ ë¶„ì„ ===`);
             const scenarioLinks = scenarioData[7]?.links || [];
             scenarioLinks.forEach((link, index) => {
               const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
               console.log(`${index + 1}. ${link.Indicator_ID} -> "${indicatorName}" ${indicatorName ? '?? : '??}`);
             });
             console.log(`ì´?${scenarioLinks.length}ê°œì˜ ì§€?œì? ?°ê²° ?œë„`);
             console.log(`?±ê³µ?ìœ¼ë¡?ë§¤í•‘??ì§€?? ${scenarioIndicators.length}ê°?);
             
             if (scenarioIndicators.length === 0) {
               console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ 7?ì„œ ?°ê²°? ì´ ê·¸ë ¤ì§€ì§€ ?ŠëŠ” ?´ìœ :`);
               console.log(`- ëª¨ë“  ì§€??IDê°€ indicatorIdToNameMap??ë§¤í•‘?˜ì? ?ŠìŒ`);
               console.log(`- ?ëŠ” links ?°ì´?°ê? ë¹„ì–´?ˆìŒ`);
             }
           }
           
           if (scenarioNumber === 13) {
             console.log(`?“Š === ?œë‚˜ë¦¬ì˜¤ 13 ë§ˆì¼“?°ì´???°ê²° ?ì„¸ ë¶„ì„ ===`);
             const scenarioLinks = scenarioData[13]?.links || [];
             scenarioLinks.forEach((link, index) => {
               const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
               console.log(`${index + 1}. ${link.Indicator_ID} -> "${indicatorName}" ${indicatorName ? '?? : '??}`);
             });
             console.log(`ì´?${scenarioLinks.length}ê°œì˜ ì§€?œì? ?°ê²° ?œë„`);
             console.log(`?±ê³µ?ìœ¼ë¡?ë§¤í•‘??ì§€?? ${scenarioIndicators.length}ê°?);
             
             if (scenarioIndicators.length === 0) {
               console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ 13?ì„œ ?°ê²°? ì´ ê·¸ë ¤ì§€ì§€ ?ŠëŠ” ?´ìœ :`);
               console.log(`- ëª¨ë“  ì§€??IDê°€ indicatorIdToNameMap??ë§¤í•‘?˜ì? ?ŠìŒ`);
               console.log(`- ?ëŠ” links ?°ì´?°ê? ë¹„ì–´?ˆìŒ`);
             }
           }
           
           if (scenarioNumber === 22) {
             console.log(`?“Š === ?œë‚˜ë¦¬ì˜¤ 22 ë§ˆì¼“?°ì´???°ê²° ?ì„¸ ë¶„ì„ ===`);
             const scenarioLinks = scenarioData[22]?.links || [];
             scenarioLinks.forEach((link, index) => {
               const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
               console.log(`${index + 1}. ${link.Indicator_ID} -> "${indicatorName}" ${indicatorName ? '?? : '??}`);
             });
             console.log(`ì´?${scenarioLinks.length}ê°œì˜ ì§€?œì? ?°ê²° ?œë„`);
             console.log(`?±ê³µ?ìœ¼ë¡?ë§¤í•‘??ì§€?? ${scenarioIndicators.length}ê°?);
             
             if (scenarioIndicators.length === 0) {
               console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ 22?ì„œ ?°ê²°? ì´ ê·¸ë ¤ì§€ì§€ ?ŠëŠ” ?´ìœ :`);
               console.log(`- ëª¨ë“  ì§€??IDê°€ indicatorIdToNameMap??ë§¤í•‘?˜ì? ?ŠìŒ`);
               console.log(`- ?ëŠ” links ?°ì´?°ê? ë¹„ì–´?ˆìŒ`);
             }
           }
           
                       if (scenarioNumber === 30) {
              console.log(`?“Š === ?œë‚˜ë¦¬ì˜¤ 30 ë§ˆì¼“?°ì´???°ê²° ?ì„¸ ë¶„ì„ ===`);
              const scenarioLinks = scenarioData[30]?.links || [];
              
              // ?„ì²´ ?œë‚˜ë¦¬ì˜¤ 30 ?°ì´???•ì¸
              console.log(`?œë‚˜ë¦¬ì˜¤ 30 ?„ì²´ ?°ì´??`, scenarioData[30]);
              console.log(`?œë‚˜ë¦¬ì˜¤ 30 ê°œìš”:`, scenarioData[30]?.overview);
              console.log(`?œë‚˜ë¦¬ì˜¤ 30 links ?ë³¸:`, scenarioData[30]?.links);
              
              // ?œë‚˜ë¦¬ì˜¤ 30 indicators ?œíŠ¸???•ì¸ (INDICATOR ?œíŠ¸ ?´ìš©)
              console.log(`?“‹ === ?œë‚˜ë¦¬ì˜¤ 30 INDICATOR ?œíŠ¸ ?´ìš© ===`);
              console.log(`?œë‚˜ë¦¬ì˜¤ 30 indicators:`, scenarioData[30]?.indicators);
              if (scenarioData[30]?.indicators) {
                scenarioData[30].indicators.forEach((ind, index) => {
                  console.log(`${index + 1}. ${ind.Indicator_ID}: "${ind.Indicator_Name}" -> ${ind.Bloomberg_Ticker || ind.Ticker || '?°ì»¤?†ìŒ'}`);
                });
              }
              
              // ?°ì´??ë¶ˆì¼ì¹??•ì¸
              const indicatorSheetIds = scenarioData[30]?.indicators?.map(ind => ind.Indicator_ID) || [];
              const linksSheetIds = scenarioData[30]?.links?.map(link => link.Indicator_ID) || [];
              
              console.log(`? ï¸ === ?°ì´??ë¶ˆì¼ì¹?ë¶„ì„ ===`);
              console.log(`INDICATOR ?œíŠ¸ ID?? [${indicatorSheetIds.join(', ')}]`);
              console.log(`LINKS ?œíŠ¸ ID?? [${linksSheetIds.join(', ')}]`);
              console.log(`?°ì´???¼ì¹˜ ?¬ë?: ${JSON.stringify(indicatorSheetIds) === JSON.stringify(linksSheetIds) ? '???¼ì¹˜' : '??ë¶ˆì¼ì¹?}`);
              
              if (JSON.stringify(indicatorSheetIds) !== JSON.stringify(linksSheetIds)) {
                console.log(`?” ë¶ˆì¼ì¹??ì„¸ ë¶„ì„:`);
                console.log(`- INDICATOR?ë§Œ ?ˆëŠ” ID?? [${indicatorSheetIds.filter(id => !linksSheetIds.includes(id)).join(', ')}]`);
                console.log(`- LINKS?ë§Œ ?ˆëŠ” ID?? [${linksSheetIds.filter(id => !indicatorSheetIds.includes(id)).join(', ')}]`);
              }
              
              // ê°?ë§í¬ë³??ì„¸ ë¶„ì„
              scenarioLinks.forEach((link, index) => {
                const indicatorName = indicatorIdToNameMap.get(link.Indicator_ID);
                console.log(`${index + 1}. ë§í¬ ?ì„¸:`);
                console.log(`   - Indicator_ID: ${link.Indicator_ID}`);
                console.log(`   - Weight: ${link.Weight || 'undefined'}`);
                console.log(`   - Correlation_Coeff: ${link.Correlation_Coeff || 'undefined'}`);
                console.log(`   - ë§¤í•‘??Bloomberg Ticker: "${indicatorName}" ${indicatorName ? '?? : '??}`);
                
                // ë§¤í•‘ ?¤íŒ¨??ê²½ìš° ì¶”ê? ?”ë²„ê¹?
                if (!indicatorName) {
                  console.log(`   ??ë§¤í•‘ ?¤íŒ¨ ?ì¸ ë¶„ì„:`);
                  console.log(`   - indicatorIdToNameMap??${link.Indicator_ID} ??ì¡´ì¬: ${indicatorIdToNameMap.has(link.Indicator_ID)}`);
                  console.log(`   - ?„ì¬ indicatorIdToNameMap ?¬ê¸°: ${indicatorIdToNameMap.size}`);
                }
              });
              
              // IND140~IND145 ?•ì¸
              console.log(`?” === IND140~IND145 ì§€??ë§¤í•‘ ?•ì¸ ===`);
              for (let i = 140; i <= 145; i++) {
                const indicatorId = `IND${String(i).padStart(3, '0')}`;
                const ticker = indicatorIdToNameMap.get(indicatorId);
                console.log(`${indicatorId}: ${ticker ? `"${ticker}" ?? : '??ë§¤í•‘ ?†ìŒ'}`);
              }
              
              // indicator ?Œì¼?ì„œ IND140~IND145 ë²”ìœ„ ?•ì¸
              console.log(`?” === indicator ?Œì¼?ì„œ IND140+ ì§€?œë“¤ ?•ì¸ ===`);
              const highNumberIndicators = [];
              for (const [id, ticker] of indicatorIdToNameMap.entries()) {
                if (id.startsWith('IND') && parseInt(id.substring(3)) >= 140) {
                  highNumberIndicators.push({id, ticker, num: parseInt(id.substring(3))});
                }
              }
              highNumberIndicators.sort((a, b) => a.num - b.num);
              console.log(`IND140 ?´ìƒ ì§€?œë“¤ (${highNumberIndicators.length}ê°?:`, 
                highNumberIndicators.map(item => `${item.id}: "${item.ticker}"`));
              
              console.log(`ì´?${scenarioLinks.length}ê°œì˜ ì§€?œì? ?°ê²° ?œë„`);
              console.log(`?±ê³µ?ìœ¼ë¡?ë§¤í•‘??ì§€?? ${scenarioIndicators.length}ê°?);
              
              if (scenarioIndicators.length === 0) {
                console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ 30?ì„œ ?°ê²°? ì´ ê·¸ë ¤ì§€ì§€ ?ŠëŠ” ?´ìœ :`);
                console.log(`- ëª¨ë“  ì§€??IDê°€ indicatorIdToNameMap??ë§¤í•‘?˜ì? ?ŠìŒ`);
                console.log(`- ?ëŠ” links ?°ì´?°ê? ë¹„ì–´?ˆìŒ`);
              } else if (scenarioIndicators.length !== scenarioLinks.length) {
                console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ 30 ë¶€ë¶?ë§¤í•‘ ë¬¸ì œ:`);
                console.log(`- ?„ì²´ ë§í¬: ${scenarioLinks.length}ê°?);
                console.log(`- ?±ê³µ ë§¤í•‘: ${scenarioIndicators.length}ê°?);
                console.log(`- ?¤íŒ¨ ë§¤í•‘: ${scenarioLinks.length - scenarioIndicators.length}ê°?);
                
                // ?¤íŒ¨??ì§€??ID??ì°¾ê¸°
                const failedIds = [];
                scenarioLinks.forEach(link => {
                  if (!indicatorIdToNameMap.get(link.Indicator_ID)) {
                    failedIds.push(link.Indicator_ID);
                  }
                });
                console.log(`- ?¤íŒ¨??ì§€??ID?? [${failedIds.join(', ')}]`);
              }
            }
        }
        
        // ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ ?„ì¹˜ ì°¾ê¸° (?¸ë“œ ?†ìœ¼ë©?ì¢…ë£Œ, ì§€??? ë¬´?€ ë¬´ê??˜ê²Œ GPT ?°ê²°? ì? ê·¸ë¦¼)
        const scenarioNodeData = nodes.find(n => n.n === scenarioNumber);
        if (!scenarioNodeData) {
          return;
        }
        
        // ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤???¼ìª½ ë©?ê³„ì‚°(?¤ì œ ?¸ë“œ??ê³ ì • ì¢Œí‘œ ?¬ìš©)
        const scenarioX = (scenarioNodeData.fx ?? scenarioNodeData.x) - SCENARIO_HALF_WIDTH;
        const scenarioY = (scenarioNodeData.fy ?? scenarioNodeData.y);
        // ê³µí†µ ì¤‘ê°„???¤ì›Œ???°ê²°?? ? ê³„?? ì§€??ì¡´ì¬ ?¬ë??€ ë¬´ê??˜ê²Œ ?€??
        const fallbackMidX = scenarioX + (indicatorStartX + 160 - scenarioX) * 0.6;
        graphState.midPointByScenarioNum.set(scenarioNumber, { x: fallbackMidX, y: scenarioY });
        try { console.log(`[KW] mid ?€?? scen=${scenarioNumber}, mid=(${fallbackMidX},${scenarioY})`); } catch(_) {}
        
        // ê´€??ì§€?œë“¤???„ì¹˜ ì°¾ê¸°
        const relatedIndicatorPositions = [];
        
        scenarioIndicators.forEach((indicatorData) => {
          // ?•í™•??Indicator_IDë¡??¸ë“œ ì°¾ê¸° (ì¤‘ë³µ Bloomberg Ticker ë¬¸ì œ ?´ê²°)
          let indicatorNode = indicatorNodes.find(node => node.indicatorId === indicatorData.id);
          if (!indicatorNode) {
            // fallback: ?´ë¦„?¼ë¡œ ì°¾ê¸°
            indicatorNode = indicatorNodes.find(node => node.name === indicatorData.name);
          }
          
          if (indicatorNode) {
            // ?œë‚˜ë¦¬ì˜¤ 30??ê²½ìš° ì§€???¸ë“œ ?•ë³´ ?ì„¸ ì¶œë ¥
            if (scenarioNumber === 30) {
              console.log(`?¯ ?œë‚˜ë¦¬ì˜¤ 30 ì§€???¸ë“œ ì°¾ìŒ:`);
              console.log(`   - ?ë˜ Indicator_ID: ${indicatorData.id}`);
              console.log(`   - Bloomberg Ticker: "${indicatorData.name}"`);
              console.log(`   - ì°¾ì? ì§€?œID: ${indicatorNode.indicatorId}`);
              console.log(`   - ?„ì¹˜: (${indicatorNode.x}, ${indicatorNode.y})`);
              console.log(`   - ID ë§¤ì¹­ ?¬ë?: ${indicatorData.id === indicatorNode.indicatorId ? '???•í™•' : '??ì¤‘ë³µ Tickerë¡??¸í•œ ?¤ë§¤ì¹?}`);
              console.log(`   - Weight: ${indicatorData.weight}, Correlation: ${indicatorData.correlation}`);
              console.log(`   - ?„ì²´ ?¸ë“œ ?•ë³´:`, indicatorNode);
            }
            
            relatedIndicatorPositions.push({
              x: indicatorNode.x,
              y: indicatorNode.y,
              name: indicatorData.name,
              node: indicatorNode,
              originalId: indicatorData.id
            });
          } else {
            // ì§€???¸ë“œë¥?ì°¾ì? ëª»í•œ ê²½ìš° ?”ë²„ê¹?
            if (indicatorData && (indicatorData.id === 'IND111' || scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30)) {
              console.log(`???œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: ì§€???¸ë“œë¥?ì°¾ì„ ???†ìŒ - ${indicatorData.id} (${indicatorData.name})`);
              console.log(`?¬ìš© ê°€?¥í•œ ì§€???¸ë“œ??(ì²˜ìŒ 20ê°?:`, indicatorNodes.map(n => `"${n.name}" (${n.indicatorId})`).slice(0, 20));
              
              // ?œë‚˜ë¦¬ì˜¤ 30??ê²½ìš° ì¶”ê? ë¶„ì„
              if (scenarioNumber === 30) {
                console.log(`?” ?œë‚˜ë¦¬ì˜¤ 30 ?¸ë“œ ì°¾ê¸° ?¤íŒ¨ ?ì„¸ ë¶„ì„:`);
                console.log(`   - ì°¾ê³ ???˜ëŠ” Indicator_ID: ${indicatorData.id}`);
                console.log(`   - ì°¾ê³ ???˜ëŠ” Bloomberg Ticker: "${indicatorData.name}"`);
                console.log(`   - ?„ì²´ ì§€???¸ë“œ ?? ${indicatorNodes.length}`);
                
                // ê°™ì? IDë¥?ê°€ì§??¸ë“œê°€ ?ˆëŠ”ì§€ ?•ì¸
                const sameIdNodes = indicatorNodes.filter(node => node.indicatorId === indicatorData.id);
                console.log(`   - ê°™ì? ID (${indicatorData.id})ë¥?ê°€ì§??¸ë“œ??`, sameIdNodes.map(n => `"${n.name}" (${n.indicatorId})`));
                
                // ë¹„ìŠ·???´ë¦„???¸ë“œ ì°¾ê¸°
                const similarNodes = indicatorNodes.filter(node => 
                  node.name.includes(indicatorData.name.split(' ')[0]) || 
                  indicatorData.name.includes(node.name.split(' ')[0])
                );
                console.log(`   - ? ì‚¬???´ë¦„???¸ë“œ??`, similarNodes.map(n => `"${n.name}" (${n.indicatorId})`));
              }
            }
          }
        });
        
        // ===== 1?¨ê³„: ?œë‚˜ë¦¬ì˜¤ ??ê³µí†µ ì¤‘ê°„??(?˜ë‚˜???¤ì„ ) - ??ƒ ê·¸ë¦¬ê¸?=====
        // ì§€??? ë¬´?€ ê´€ê³„ì—†???œë‚˜ë¦¬ì˜¤?ì„œ ê³µí†µ ì¤‘ê°„?ê¹Œì§€????ƒ ?¤ì„  ?œì‹œ
        const commonMidX = scenarioX + (indicatorStartX + 160 - scenarioX) * 0.6;
        const commonMidY = scenarioY;
        // ì¤‘ê°„???€??(?¤ì›Œ??ë°•ìŠ¤ ?°ê²°??
        graphState.midPointByScenarioNum.set(scenarioNumber, { x: commonMidX, y: commonMidY });
        
        // Y ì¹´ìš´??ê³„ì‚° (?‰ìƒ ê²°ì •??
        const { yCount, total } = await computeScenarioYRate(scenarioNumber);
        console.log(`[C1?‰ìƒ] ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: total=${total}, yCount=${yCount}`);
        
        // ???‰ìƒ ?•ì±…(ê°œì •): ?„ë? G=?Œë‘, Y(1~2)=?¸ë‘, Y(3+)=ë¹¨ê°• (?¥ì˜¤?Œì? ?œê±°)
        // ?°ê²°? ì? ?œë‚˜ë¦¬ì˜¤?’ì???êµ¬ê°„ ?´ë‚´ ?™ì¼ ??? ì?(3??ê³ ì •)
        const baseColor = getScenarioLinkColorByCount(yCount);
        const mdHasYellowOrOrange = (yCount >= 1 && yCount < 3); // ?¥ì˜¤?Œì? ?œê±°, 1~2ê°œëŠ” ?¸ë‘ ì·¨ê¸‰
        
        // ?œë‚˜ë¦¬ì˜¤ ??ê³µí†µ ì¤‘ê°„???¤ì„  (??ƒ ?œì‹œ)
        linkLayer.append("line")
          .attr("class", "connection-line")
          .attr("x1", scenarioX)
          .attr("y1", scenarioY)
          .attr("x2", commonMidX)
          .attr("y2", commonMidY)
          .attr("stroke", baseColor)
          .attr("stroke-width", 4)
          .attr("stroke-opacity", 0.85)
          .style("cursor", "pointer")
          .each(function(){ this.__meta = { kind: 'ind-scen-common', scenId: scenarioNodeData.id, scenNum: scenarioNumber }; })
          .on('click', ()=>{
            highlightConnection({ type: 'scenario-to-gpt', scenarioNumber });
          });

        // ê³µí†µ ì¤‘ê°„?ì— ?í˜• ë§ˆì»¤ (??ƒ ?œì‹œ, baseColor?€ ?¼ì¹˜)
        linkLayer.append("circle")
          .attr("cx", commonMidX)
          .attr("cy", commonMidY)
          .attr("r", 6)
          .attr("fill", baseColor)
          .attr("stroke", "#fff")
          .attr("stroke-width", 2);

        // ===== 2?¨ê³„: ê³µí†µ ì¤‘ê°„????ê°?ì§€?œë¡œ ?ì„  ë¶„ê¸° (ì§€?œê? ?ˆì„ ?Œë§Œ) =====
        // ???„ì²´ ì§€?œì˜ ?Œë˜ê·¸ë? ë¨¼ì? ?˜ì§‘?˜ì—¬ Y ê°œìˆ˜ ê³„ì‚° (GPT ???‰ìƒ ê²°ì •?ë„ ?¬ìš©)
        let indicatorYCount = 0;
        let indicatorTotal = 0;
        let indicatorHasRed = false;
        
        if (scenarioIndicators.length > 0 && relatedIndicatorPositions.length > 0) {
          // ?œë‚˜ë¦¬ì˜¤ 7, 13, 22, 30 ?°ê²°??ê·¸ë¦¬ê¸??œì‘ ë¡œê·¸
          if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
            console.log(`?¨ ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ?°ê²°??ê·¸ë¦¬ê¸??œì‘:`);
            console.log(`?°ê²°??ì§€???„ì¹˜??`, relatedIndicatorPositions.map(p => 
              `${p.originalId || '?'} -> "${p.name}" (${p.x}, ${p.y})`
            ));
            console.log(`?œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ?‰ìƒ: ${color}`);
          }

          indicatorTotal = relatedIndicatorPositions.length;
          for (const pos of relatedIndicatorPositions) {
            try {
              const f = await fetchIndicatorFlag(pos.originalId || '');
              if (f === 'Y') indicatorYCount++;
            } catch (_) {
              // ?¤íŒ¨ ??Gë¡?ê°„ì£¼
            }
          }

          // ì§€??ë¶„ê¸° ???‰ìƒ: ?œë‚˜ë¦¬ì˜¤?’ì????¼ì¸?€ ??ƒ ê°™ì? ??3??ì¤??˜ë‚˜)ë¡?ê³ ì •
          // baseColor?€ ?™ì¼?˜ê²Œ ?ìš© (?Œë‘/?¸ë‘/ë¹¨ê°•ë§??¬ìš©)
          const branchColor = baseColor;
          indicatorHasRed = (yCount >= 3); // Y 3ê°??´ìƒ???Œë§Œ RED

          console.log(`[ì§€?œìƒ‰?? ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: Y=${indicatorYCount}/${indicatorTotal}, ?‰ìƒ=${branchColor}, hasRed=${indicatorHasRed}`);

          // 2?¨ê³„: ê³µí†µ ì¤‘ê°„????ê°?ì§€?œë¡œ ?ì„  ë¶„ê¸°
          for (const [i, pos] of relatedIndicatorPositions.entries()) {
            if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
              console.log(`  ?“ ì§€??${i + 1}: ${pos.originalId || '?'} -> "${pos.name}" ?„ì¹˜ (${pos.x}, ${pos.y})`);
            }

            const segLine = linkLayer.append("line")
              .attr("class", "connection-line")
              .attr("x1", commonMidX)
              .attr("y1", commonMidY)
              .attr("x2", pos.x)
              .attr("y2", pos.y)
              .attr("stroke", branchColor) // baseColor ê·¸ë?ë¡?
              .attr("stroke-width", branchColor === '#E53935' ? 4 : (branchColor === '#FFD54F' ? 3 : 2))
              .attr("stroke-opacity", 0.85)
              .attr("stroke-dasharray", "8,4")
              .style("cursor", "pointer")
              .each(function(){ this.__meta = { kind: 'ind-scen', indId: pos.originalId || null, scenId: scenarioNodeData.id, scenNum: scenarioNumber }; })
              .on('click', ()=>{
                const indId = pos.originalId || null;
                highlightConnection({ type: 'indicator-scenario', indicatorId: indId, scenarioId: scenarioNodeData.id });
              });
            // ?”ë²„ê·?ë¡œê·¸: ê°??¸ê·¸ë¨¼íŠ¸??? íƒ???‰ìƒ ë¡œê·¸ ì¶œë ¥
            console.log(`[C1?‰ìƒ] ?¸ê·¸ë¨¼íŠ¸ ${pos.originalId} ?‰ìƒ=${branchColor}`);
            // "?„ë? Y?????°ê²°??ê¹œë°•?? ? ì? (yCount ê¸°ì??¼ë¡œ ?˜ì •)
            if (yCount === total && total > 0) {
              segLine.classed('blink-y-all', true);
            }

            linkLayer.append("circle")
              .attr("cx", pos.x)
              .attr("cy", pos.y)
              .attr("r", 3)
              .attr("fill", branchColor)
              .attr("stroke", "#fff")
              .attr("stroke-width", 1);
          }
          
          // ?œë‚˜ë¦¬ì˜¤ 7, 13, 22, 30 ?°ê²°??ê·¸ë¦¬ê¸??„ë£Œ ë¡œê·¸
          if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
            console.log(`???œë‚˜ë¦¬ì˜¤ ${scenarioNumber} ?°ê²°??ê·¸ë¦¬ê¸??„ë£Œ: ${relatedIndicatorPositions.length}ê°?ì§€?œì? ?°ê²°??);
          }
        } else {
          // ì§€???°ê²°???†ëŠ” ê²½ìš° (ê³µí†µ ?¤ì„ ?€ ?´ë? ê·¸ë ¤ì§?
          if (scenarioNumber === 7 || scenarioNumber === 13 || scenarioNumber === 22 || scenarioNumber === 30) {
            console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: ì§€??ë¶„ê¸°???†ìŒ (ê³µí†µ ?¤ì„ ë§??œì‹œ?? relatedIndicatorPositions.length = 0)`);
          }
        }

        // === ?¤ì›Œ??ë°•ìŠ¤ ???œë‚˜ë¦¬ì˜¤-ë§ˆì¼“?°ì´???¤ì„  ì¤‘ê°„???°ê²°??===
        try {
          const mid = graphState.midPointByScenarioNum.get(scenarioNumber);
          const scenIdForLink = scenarioNodeData.id;
          // ?™ì¼ ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸(n) ?¼ì¹˜ ?¤ì›Œ?œë§Œ ???°ê²° (ë²ˆí˜¸ ê¸°ì? ?°ì„ )
          const scenNumForLink = scenarioNumber;
          const keywordNodesForScenario = nodes.filter(n => n.type === 'keyword' && n.scenarioNum === scenNumForLink);
          try { console.log(`[KW] scen=${scenarioNumber}(${scenIdForLink}) keyword ?¸ë“œ ??`, keywordNodesForScenario.length, 'mid?', !!mid); } catch(_) {}
          if (DRAW_KEYWORD_LINKS && mid && keywordNodesForScenario.length) {
            // ?¤ì›Œ???°ê²°? ì? linkLayer???Œë”ë§?
            const kwLineGroup = linkLayer.append('g').attr('class','keyword-links');
            const kwTotal = keywordNodesForScenario.length;
            // ê°€ë¡?ë°°ì¹˜: ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?¼ìª½?ì„œ ?œì‘???°ì† ë°°ì¹˜ (?¤ì„  ?œì‘??ê¸°ì? ?¼ìª½)
            // ???„ì°© ì§€?ì? ?¤ì„ ??0%??0% êµ¬ê°„???œì„œ?€ë¡?ë°°ì¹˜
            const lineRatioStart = 0.7, lineRatioEnd = 0.4;
            const ratioOnLine = (i)=> {
              if (kwTotal <= 1) return lineRatioStart;
              const t = i / (kwTotal - 1);
              return lineRatioStart + (lineRatioEnd - lineRatioStart) * t;
            };
            const leftMargin = 10;
            const segmentEndX   = scenarioX - leftMargin; // ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ì¢Œì¸¡ ê°€?¥ìë¦¬ì—??ì¡°ê¸ˆ ?¼ìª½
            // ë¨¼ì? ?¤ì›Œ??ê°œìˆ˜ë§Œí¼ ê³ ì • ??ë°•ìŠ¤ë¥??ì„±?˜ì—¬ ì¢Œì¸¡?ì„œë¶€???•í™•??ë°€ì°?ë°°ì¹˜
            const fixedBoxW     = 160; // ê³ ì • ??
            const gapX          = 0;   // ?„ì „ ë°€ì°?
            const totalWidth    = fixedBoxW * Math.max(1, kwTotal) + gapX * Math.max(0, kwTotal - 1);
            const segmentStartX = segmentEndX - totalWidth;
            const dynBoxW       = fixedBoxW;
            const anchorX = segmentEndX - dynBoxW / 2; // ì²?ë°•ìŠ¤ ì¤‘ì•™(?¤ë¥¸ìª½ì—???¼ìª½?¼ë¡œ)
            const anchorY = mid.y;
            // ?„ì—­ ?ë‹¨ ?œê³„ ë°?ê¸°ë³¸ ê°„ê²© ?°ì •
            // ===== ?˜ë“œ ì½”ë”© ?¤íƒ ë°°ì¹˜ ê·œì¹™ =====
            // - ê°€???„ë˜(?œë‚˜ë¦¬ì˜¤??ê°€??ê°€ê¹Œìš´) ?¤ì›Œ?œëŠ”: minScenarioY - MARGIN - boxH
            // - ?¤ìŒ ?¤ì›Œ?œëŠ” ?„ë¡œ STEP???´ë™: minScenarioY - MARGIN - boxH - STEP * idx
            const MARGIN = 24; // @ (?”ì²­??ê¸°ì? ê°„ê²©)
            const STEP = 120;   // ê³ ì • ?¤í… ê°„ê²© (?”ì²­: 120)
            const baseBottomY = minScenarioY - MARGIN; // ?œë‚˜ë¦¬ì˜¤ ìµœìƒ?¨ë³´???½ê°„ ??
            // ?œë‚˜ë¦¬ì˜¤ê°?ì¶©ëŒ ?„í™”(?Œí­ ?¤í”„??
            const scenarioOrder = [...scenarioNodes].sort((a,b)=> (a.fy ?? a.y) - (b.fy ?? b.y));
            const orderIndex = scenarioOrder.findIndex(n => n.n === scenarioNumber);
            const scenarioStagger = Math.max(0, (orderIndex % 3)) * 6;
            
            keywordNodesForScenario.forEach((kn, idx) => {
              const phase = (kn.phase || '').toLowerCase();
              let strokeColor = '#9aa0a6';
              if (phase === 'yellow' || phase === 'y') strokeColor = '#FFD54F';
              if (phase === 'red' || phase === 'r') strokeColor = '#E53935';
              // ?¤ì›Œ??ë°•ìŠ¤ ê³ ì • ?¤í… ê¸°ë°˜ ?˜ì§ ë°°ì¹˜
              const boxW = kn.kwidth ?? kn.width ?? 240;
              const baseH = 38;
              const heightOffset = ((idx % 5) - 2) * 4; // -8, -4, 0, +4, +8
              const boxH = Math.max(34, Math.min(50, baseH + heightOffset));
              // ?°ì† ê°€ë¡?ë°°ì¹˜: ?°â†’ì¢Œë¡œ ?±ê°„ê²??œë‚˜ë¦¬ì˜¤ ?¼ìª½??ë¶™ì—¬ ?˜ì—´)
              const anchorXForIdx = segmentEndX - dynBoxW / 2 - idx * (dynBoxW + gapX);
              const kx = anchorXForIdx - dynBoxW / 2;
              // ?˜ë“œì½”ë”©: ê°€????? ?¤ì›Œ?œê? baseBottomY - boxH, ?¤ìŒ?€ STEP???„ë¡œ
              const kyCandidate = (baseBottomY - boxH) - (STEP * idx) - scenarioStagger;
              const ky = kyCandidate;
              kn.kx = kx; kn.ky = ky; kn.kwidth = dynBoxW; kn.kheight = boxH; kn.width = dynBoxW; kn.height = boxH; kn.fx = kx; kn.fy = ky;
              // DOM ?„ì¹˜ ë°??¬ê¸° ?…ë°?´íŠ¸ (?´ë‹¹ ?°ì´??ë°”ì¸?©ëœ ê·¸ë£¹ë§?
              // ?´ë? ë°°ì¹˜ë¡?ë³€ê²½ë¨: ?¸ë? ?„ì—­ keywordGroup ì°¸ì¡° ?œê±°
              const kgSel = g.selectAll('.keyword-node').filter(d => d === kn);
              kgSel.attr('transform', `translate(${kx}, ${ky})`);
              kgSel.select('rect').attr('width', dynBoxW).attr('height', boxH);
              kgSel.select('text').attr('x', dynBoxW / 2).attr('y', boxH / 2);
              // ì§ì„  ?°ê²°: ë°•ìŠ¤ ê°€?´ë° ?„ë˜ìª????„ì°©??anchor)
              const startX = anchorXForIdx;
              const startY = ky + boxH;
              kwLineGroup.append('line')
                .attr('class', 'connection-line')
                .attr('x1', startX)
                .attr('y1', startY)
                .attr('x2', scenarioX + (mid.x - scenarioX) * ratioOnLine(idx))
                .attr('y2', anchorY)
                .attr('stroke', strokeColor)
            .attr('stroke-width', 3)
                .attr('stroke-opacity', 0.95)
                .attr('stroke-linecap', 'round')
                .classed('kw-animated', true);
            });
          }
        } catch(_) {}

        // === ?œë‚˜ë¦¬ì˜¤ ??GPT1 ?°ê²°??(?´ë¦­ ê°€?? ===
        // ?œë‚˜ë¦¬ì˜¤ ë°•ìŠ¤ ?¤ë¥¸ìª?ë©´ì˜ ì¤‘ì•™???œì‘?ìœ¼ë¡??¤ì •
        const scenarioRightX = (scenarioNodeData.fx ?? scenarioNodeData.x) + SCENARIO_HALF_WIDTH;
        const scenarioRightY = (scenarioNodeData.fy ?? scenarioNodeData.y);

        // ëª¨ë“  ?œë‚˜ë¦¬ì˜¤ ? ë“¤???˜ë‚˜??ê³µí†µ ê¼???ìœ¼ë¡?ëª¨ì´?„ë¡ ê³ ì • ì¢Œí‘œ ?¬ìš©
        const commonHubX = gpt0AnchorX2 - 500; // gpt0 ?¼ìª½?ì„œ ???¼ìª½ ê³µí†µ??
        const commonHubY = gptAnchorY;       // ?˜í‰ ?•ë ¬
        // ?”ë²„ê¹…ìš©: ?„ì¬ ê¼?????½ì? ?„ì¹˜
        try { console.debug('[COMMON-HUB]', { x: commonHubX, y: commonHubY }); } catch(_) {}

        // ? ë“¤??ë¨¼ì? gpt0 ?ˆë¸Œë¡?ëª¨ì´?„ë¡ ì¤‘ê°„ ?ì„ gptHubX ê¸°ì??¼ë¡œ ì¡°ì •
        // gpt0?¤ì´ gpt1 ?„ì¹˜???ˆìœ¼ë¯€ë¡?ì¤‘ê°„?ë„ ?ˆë¸Œ??ê°€ê¹ê²Œ ?¹ê?
        // ê¸¸ì´ë¥??ˆë°˜?¼ë¡œ ì¤„ì—¬(ë³´ê°„ ë¹„ìœ¨ ??, gpt0 ?ˆë¸Œ ?„ì¹˜ë§??°ë¼ê°€?„ë¡ ??
        const gptMidX = scenarioRightX + (commonHubX - scenarioRightX) * SCEN_GPT_PATH_RATIO;
        const gptMidY = scenarioRightY;

        // ???‰ìƒ ì¡°ê±´
        // 1) ì§€?œìª½ ? ì´ red??ê²½ìš° (?„ì²´ ì§€?œê? Y)
        // 2) ?¤ì›Œ??redê°€ 3ê°??´ìƒ??ê²½ìš°
        // ????ì¡°ê±´ ì¤??˜ë‚˜?¼ë„ ë§Œì¡±?˜ë©´ ë¹¨ê°•, ?„ë‹ˆë©??¸ë‘???ˆìœ¼ë©??¸ë‘, ê·????Œë‘
        const kwNodesAll = (nodes || []).filter(n => n && n.type === 'keyword' && n.scenarioNum === scenarioNumber);
        const kwRedCount = kwNodesAll.filter(kn => {
          const ph = String(kn.phase || '').toLowerCase();
          return ph === 'red' || ph === 'r';
        }).length;
        const kwHasYellow = kwNodesAll.some(kn => {
          const ph = String(kn.phase || '').toLowerCase();
          return ph === 'yellow' || ph === 'y';
        });

        // ??ì¶”ê?: ?´ìŠ¤?¤ì›Œ??"ê²½ê³ " ê°œìˆ˜(?¸ë‘/ë¹¨ê°• ?©ê³„)
        const kwWarnCount = kwNodesAll.filter(kn => {
          const ph = String(kn.phase || '').toLowerCase();
          return ph === 'yellow' || ph === 'y' || ph === 'red' || ph === 'r';
        }).length;

        // GPT ê²½ë¡œ ?‰ìƒ ê²°ì • (ê°œì •: ì§€?œì„ ê³??´ìŠ¤ ì¡°í•©)
        let toGptColor = '#2196F3'; // ê¸°ë³¸ ?Œë‘
        const indicatorIsWarning = (yCount >= 1); // ì§€?œì„ ??yellow ?ëŠ” red
        const indicatorIsRed = (yCount >= 3);      // ??ì§€??RED ê¸°ì?(3ê°??´ìƒ)
        
        // RED: ì§€?œì„ ??yellow/red?´ë©´??AND red ?´ìŠ¤ê°€ 3ê°??´ìƒ
        if (indicatorIsWarning && kwRedCount >= 3) {
          toGptColor = '#E53935';
        } else if (indicatorIsRed || (kwWarnCount >= 3)) {
          // ??YELLOW: ì§€??ê²½ê³ ê°€ RED(3+)?´ê±°?? ?´ìŠ¤?¤ì›Œ??ê²½ê³ (?¸ë‘/ë¹¨ê°•) ?©ê³„ê°€ 3ê°??´ìƒ
          toGptColor = '#FFD54F';
        }
        // else: ?Œë‘ ? ì? (ì§€???•ìƒ + ?´ìŠ¤ ?†ìŒ)
        
        console.log(`[GPT?‰ìƒ] ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}: yCount=${yCount}, indicatorIsRed=${indicatorIsRed}, kwRedCount=${kwRedCount}, kwWarnCount=${kwWarnCount}, toGptColor=${toGptColor}`);

        // ?ˆë¸Œê¹Œì? ?„ë‹¬?˜ë˜, ?´ë??ì„œ???¤ì„ /?ì„  ë¹„ìœ¨ë§??ìš© (ì´?ê¸¸ì´???ˆë¸Œê¹Œì? 100%)
        const distX = (commonHubX - scenarioRightX);
        const solidFrac = Math.min(1, Math.max(0, SCEN_GPT_SOLID_FRAC_IN_TOTAL)); // 0~1
        const dashedFrac = Math.min(1, Math.max(0, 1 - solidFrac));
        const realEndX = scenarioRightX + distX * solidFrac;
        const realEndY = scenarioRightY; // ?˜í‰ ? ì?
        const gptPathData = [
          { x1: scenarioRightX, y1: scenarioRightY, x2: realEndX, y2: realEndY, w: 4, dash: null, a: 0.9 },
          { x1: realEndX, y1: realEndY, x2: commonHubX, y2: commonHubY, w: 3, dash: '6,4', a: 0.9 }
        ];

        gptPathData.forEach(seg => {
          const line = linkLayer.append('line')
            .attr('class', 'connection-line')
            .attr('x1', seg.x1)
            .attr('y1', seg.y1)
            .attr('x2', seg.x2)
            .attr('y2', seg.y2)
            .attr('stroke', toGptColor)
            .attr('stroke-width', (toGptColor==='#E53935'||toGptColor==='#FFD54F') ? seg.w*2 : seg.w)
            .attr('stroke-opacity', seg.a)
            .style('cursor', 'pointer');
          if (seg.dash) line.attr('stroke-dasharray', seg.dash);

          // ë©”í? ?°ì´???€??(?œë‚˜ë¦¬ì˜¤?’GPT ?¼ì¸)
          line.each(function(){ this.__meta = { kind: 'scen-gpt', scenNum: scenarioNumber }; });

          line.on('click', () => {
            onClickScenarioToGptLink(scenarioNumber);
            highlightConnection({ type: 'scenario-to-gpt', scenarioNumber });
          });
        });

        // GPT ?µì»¤ ìª??ì  ?œì‹œ
        linkLayer.append('circle')
          .attr('cx', commonHubX)
          .attr('cy', commonHubY)
          .attr('r', 5)
          .attr('fill', toGptColor)
          .attr('stroke', '#fff')
              .attr('stroke-width', 2)
          .style('cursor', 'pointer')
          .on('click', () => onClickScenarioToGptLink(scenarioNumber));
      }
      
      // ?°ê²° ?µê³„ ë¶„ì„
      console.log('?”— === ?œë‚˜ë¦¬ì˜¤ë³??°ê²° ?µê³„ ë¶„ì„ ===');
      let totalConnections = 0;
      let connectedScenarios = 0;
      let disconnectedScenarios = [];
      
      for (let i = 1; i <= SCENARIO_COUNT; i++) {
        if (scenarioData[i]) {
          let sourceData = [];
          let sourceType = '';
          
          // INDICATOR ?œíŠ¸ê°€ ?ˆê³  ë¹„ì–´?ˆì? ?Šìœ¼ë©??°ì„  ?¬ìš©
          if (scenarioData[i].indicators && scenarioData[i].indicators.length > 0) {
            sourceData = scenarioData[i].indicators;
            sourceType = 'INDICATOR ?œíŠ¸';
          } else if (scenarioData[i].links) {
            sourceData = scenarioData[i].links;
            sourceType = 'LINKS ?œíŠ¸';
          }
          
          if (sourceData.length > 0) {
            const connectedIndicators = sourceData.map(item => {
              const indicatorId = item.Indicator_ID;
              const indicatorName = indicatorIdToNameMap.get(indicatorId);
              return indicatorName ? {
                id: indicatorId,
                name: indicatorName
              } : null;
            }).filter(Boolean);
            
            if (connectedIndicators.length > 0) {
              connectedScenarios++;
              totalConnections += connectedIndicators.length;
            } else {
              disconnectedScenarios.push(i);
            }
            
            console.log(`?œë‚˜ë¦¬ì˜¤ ${i}: ${sourceData.length}ê°?ì§€??(${sourceType}) ??${connectedIndicators.length}ê°??°ê²°??);
          } else {
            disconnectedScenarios.push(i);
            console.log(`?œë‚˜ë¦¬ì˜¤ ${i}: ì§€???°ì´???†ìŒ`);
          }
        }
      }
      
      console.log(`?“Š ?°ê²° ?µê³„:`);
      console.log(`- ?°ê²°???œë‚˜ë¦¬ì˜¤: ${connectedScenarios}/${SCENARIO_COUNT}ê°?);
      console.log(`- ?°ê²° ?ˆëœ ?œë‚˜ë¦¬ì˜¤: [${disconnectedScenarios.join(', ')}]`);
      console.log(`- ì´??°ê²° ?? ${totalConnections}ê°?);
      
      // ëª¨ë“  ?œë‚˜ë¦¬ì˜¤???€???°ê²°??ê·¸ë¦¬ê¸?(ìµœë? 30ê°?
      (async () => {
        for (let i = 1; i <= SCENARIO_COUNT; i++) {
          await drawScenarioConnections(i);
        }
      })();

      // ?œë??ˆì´???…ë°?´íŠ¸ ?¸ë“¤??
      simulation.on("tick", () => {
        scenarioGroup.attr("transform", d => `translate(${d.x}, ${d.y})`);
        // ?¤ì›Œ???¸ë“œ??ê³ ì • ì¢Œí‘œ ? ì?
        g.selectAll('.keyword-node').attr('transform', function(d){ return `translate(${d.kx}, ${d.ky})`; });
      });

      // ?¤ì›Œ??ì¢Œí‘œ ?ˆë? ê³ ì • ? í‹¸ë¦¬í‹°
      function lockKeywordPositions(){
        const sel = g.selectAll('.keyword-node');
        sel.each(function(d){ if (!d) return; d.fx = d.kx; d.fy = d.ky; });
        sel.attr('transform', d => `translate(${d.kx}, ${d.ky})`);
      }
      // ?œë??ˆì´??ì¢…ë£Œ ?œì? ì´ˆê¸°????ë²???ê³ ì •
      simulation.on('end', lockKeywordPositions);
      try { setTimeout(lockKeywordPositions, 0); setTimeout(lockKeywordPositions, 600); } catch(_) {}

      // ====== ?°ê²° ?˜ì´?¼ì´??? í‹¸ ======
      function highlightConnection(payload){
        // ëª¨ë‘ ?”ë°
        g.selectAll('.indicator-group, .scenario-group, .connection-line').classed('dimmed', true).classed('highlighted', false);
        // ê¸°ì¡´ ?„ì‹œ ?¼ë²¨ ?œê±°
        g.selectAll('.highlight-temp-label').remove();

        if (payload.type === 'indicator-scenario' && payload.indicatorId && payload.scenarioId){
          // ?•í™• ë§¤ì¹­?˜ëŠ” ?”ì†Œë§?ê°•ì¡°
          g.selectAll('.indicator-group').filter(d=>d.indicatorId===payload.indicatorId).classed('dimmed', false).classed('highlighted', true);
          g.selectAll('.scenario-group').filter(d=>d.id===payload.scenarioId).classed('dimmed', false).classed('highlighted', true);
          g.selectAll('.connection-line').filter(function(){
            return this.__meta && this.__meta.kind==='ind-scen' && this.__meta.indId===payload.indicatorId && this.__meta.scenId===payload.scenarioId;
          }).classed('dimmed', false).classed('highlighted', true);
          // ?´ë¦„ ?¼ë²¨ (?€??ì§€?œë§Œ)
          const indNode = indicatorNodes.find(n=>n.indicatorId===payload.indicatorId);
          if (indNode){
            g.append('text')
              .attr('class','highlight-temp-label')
              .attr('x', indNode.x + 22)
              .attr('y', indNode.y + 4)
              .classed('highlight-label', true)
              .text(indNode.name);
          }
        }
        if (payload.type === 'scenario-to-gpt' && payload.scenarioNumber){
          // ?¤ì½”??ê°?ê³„ì‚°
          const scenarioNode = scenarioNodes.find(s=>s.n===payload.scenarioNumber);
          const scenId = scenarioNode?.id;
          // 1) ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ ê°•ì¡°
          g.selectAll('.scenario-group').filter(d=>d.n===payload.scenarioNumber).classed('dimmed', false).classed('highlighted', true);
          if (scenId) {
            // 2) ?œë‚˜ë¦¬ì˜¤?’ê³µ?µì¤‘ê°??¤ì„ (?¸ë ?? ê°•ì¡° (?´ë‹¹ ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¡??„ê²© ?„í„°)
            g.selectAll('.connection-line').filter(function(){ return this.__meta && this.__meta.kind==='ind-scen-common' && this.__meta.scenId===scenId && this.__meta.scenNum===payload.scenarioNumber; })
              .classed('dimmed', false).classed('highlighted', true);
          // 3) ?œë‚˜ë¦¬ì˜¤?’ì????ì„  ê°•ì¡° (?´ë‹¹ ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¡??„ê²© ?„í„°)
            const scenarioLines = g.selectAll('.connection-line').filter(function(){ return this.__meta && this.__meta.kind==='ind-scen' && this.__meta.scenId===scenId && this.__meta.scenNum===payload.scenarioNumber; })
              .classed('dimmed', false).classed('highlighted', true);
            // 4) ?°ê²°??ì§€???¸ë“œ ê°•ì¡° + ?¼ë²¨ ?œì‹œ (?¼ì¸ ë©”í? ê¸°ë°˜ - ?¤ì œ ?”ë©´??ê·¸ë ¤ì§??°ê²°ë§?
            const connectedIndIdSet = new Set();
            scenarioLines.each(function(){ const m=this.__meta; if (m && m.indId) connectedIndIdSet.add(m.indId); });
            // ê°•ì¡° ë°??¼ë²¨ ì¶”ê? (?•í™•??ë§¤ì¹­?˜ëŠ” ì§€?œë§Œ)
            g.selectAll('.indicator-group').filter(d=>connectedIndIdSet.has(d.indicatorId)).each(function(d){
              d3.select(this).classed('dimmed', false).classed('highlighted', true);
              g.append('text')
                .attr('class','highlight-temp-label')
                .attr('x', d.x + 22)
                .attr('y', d.y + 4)
                .classed('highlight-label', true)
                .text(d.name);
            });
          }
          // 5) ?œë‚˜ë¦¬ì˜¤?’GPT ??ê°•ì¡°
          g.selectAll('.connection-line').filter(function(){ return this.__meta && this.__meta.kind==='scen-gpt' && this.__meta.scenNum===payload.scenarioNumber; })
            .classed('dimmed', false).classed('highlighted', true);
        }

        // ?´ì œ ?¸ë“¤??(?Œì´?„ë¼???¤í–‰ ì¤‘ì—” ? ê¸ˆ ? ì?)
        const clear = ()=>{
          if (graphState.pipelineRunning && graphState.lockedHighlight) return; // ? ê¸ˆ ?íƒœ ? ì?
          g.selectAll('.indicator-group, .scenario-group, .connection-line').classed('dimmed', false).classed('highlighted', false);
          g.selectAll('.highlight-temp-label').remove();
          svg.on('dblclick', null);
          window.removeEventListener('keydown', escHandler);
          graphState.lockedHighlight = null;
        };
        const escHandler = (e)=>{ if (e.key==='Escape') clear(); };
        graphState.clearHighlight = clear;
        // ?”ë¸”?´ë¦­?¼ë¡œ ?´ì œ?˜ë„ë¡?ë³€ê²?(?”ë©´ ?´ë™ ?œì—???´ì œ?˜ì? ?ŠìŒ)
        setTimeout(()=>{ svg.on('dblclick', (ev)=>{ if (ev.target===svg.node()) clear(); }); window.addEventListener('keydown', escHandler); }, 0);
        // ?Œì´?„ë¼???¤í–‰ ì¤‘ì—” ? ê¸ˆ ? ì?
        if (graphState.pipelineRunning) {
          graphState.lockedHighlight = payload;
        }
      }

      // ë§ˆìš°???œë˜ê·¸ì? ì¤?ê¸°ëŠ¥
      let isDragging = false;
      let dragStart = { x: 0, y: 0 };
      let currentTransform = { x: 0, y: 0, scale: 1 };
      graphState.currentTransform = currentTransform;
      
      // ì´ˆê¸° ë·°ë? ì¤‘ì•™?¼ë¡œ ?¤ì •
      const initialX = (containerRect.width - width) / 2;
      const initialY = (containerRect.height - height) / 2;
      currentTransform.x = initialX;
      currentTransform.y = initialY;
      const applyTransform = () => {
        g.attr("transform", `translate(${currentTransform.x}, ${currentTransform.y}) scale(${currentTransform.scale})`);
      };
      graphState.applyTransform = applyTransform;
      applyTransform();

      svg.on("mousedown", function(event) {
        isDragging = true;
        dragStart = { 
          x: event.clientX - currentTransform.x, 
          y: event.clientY - currentTransform.y 
        };
        event.preventDefault();
      });

      svg.on("mousemove", function(event) {
        if (isDragging) {
          currentTransform.x = event.clientX - dragStart.x;
          currentTransform.y = event.clientY - dragStart.y;
          applyTransform();
        }
      });

      svg.on("mouseup", function() {
        isDragging = false;
      });

      svg.on("mouseleave", function() {
        isDragging = false;
      });
      
      // ë§ˆìš°????ì¤?ê¸°ëŠ¥
      svg.on("wheel", function(event) {
        event.preventDefault();
        
        const rect = container.getBoundingClientRect();
        const mouseX = event.clientX - rect.left;
        const mouseY = event.clientY - rect.top;
        
        const delta = event.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.1, Math.min(3, currentTransform.scale * delta));
        
        // ë§ˆìš°???„ì¹˜ë¥?ì¤‘ì‹¬?¼ë¡œ ì¤?
        const scaleDiff = newScale - currentTransform.scale;
        currentTransform.x -= (mouseX - currentTransform.x) * scaleDiff / currentTransform.scale;
        currentTransform.y -= (mouseY - currentTransform.y) * scaleDiff / currentTransform.scale;
        currentTransform.scale = newScale;
        
        applyTransform();
      });
    }

    // ì§€???„í—˜???‰ìƒ
    function getIndicatorColor(ind) {
      const curr = ind.Current_Value || 0;
      const high = ind.Threshold_High || 100;
      const low = ind.Threshold_Low || 0;
      if (curr > high) return '#e74c3c'; // ë¹¨ê°•
      if (curr > high * 0.95) return '#f1c40f'; // ?¸ë‘ (95% ?´ìƒ)
      return '#3498db'; // ?Œë‘
    }

    // ====== ?°ê²°???‰ìƒ ë³´ì • (C1 ?Œë˜ê·?ê¸°ë°˜) ======
    // ?ˆìš© ID ?¨í„´: 'IND' + ???ë¦¬ ?«ì (?? IND001 ~ IND999)
    const IND_ID_RE = /^IND\d{3}$/;
    // ?œì™¸ ?€?? IND101~IND105 ?œê±°
    const IND_EXCLUDE = new Set(['IND101','IND102','IND103','IND104','IND105']);
    const normalizeIndicatorId = (id) => String(id || '').trim().toUpperCase();
    const isAllowedIndicatorId = (id) => {
      const cleaned = normalizeIndicatorId(id);
      return IND_ID_RE.test(cleaned) && !IND_EXCLUDE.has(cleaned);
    };
    // ìºì‹œ: Indicator_ID -> 'Y' | 'G' | null
    const indicatorFlagCache = new Map();
    const USE_REMOTE_IND_FLAG = true; // ë³€?™ì„± ?Œë˜ê·??ê²© ì¡°íšŒ ?œì„±???‰ìƒ ë°˜ì˜). 404???´ë? ?´ë°± ì²˜ë¦¬

    async function fetchIndicatorFlag(indicatorId) {
      const cleaned = normalizeIndicatorId(indicatorId);
      if (!isAllowedIndicatorId(cleaned)) return 'G';
      // ìºì‹œ???ˆë”?¼ë„ G??ê²½ìš° ??ë²ˆì? ê°•ì œ ê°±ì‹  ?œë„ (ê³¼ê±° ?˜ëª» ?ì •??ê°?êµì •)
      const cached = indicatorFlagCache.get(cleaned);
      if (cached && cached !== 'G') return cached;
      if (!USE_REMOTE_IND_FLAG) {
        // ?ê²© ì¡°íšŒ ë¹„í™œ?±í™”: ê¸°ë³¸ 'G' ë°˜í™˜
        indicatorFlagCache.set(cleaned, 'G');
        return 'G';
      }
      try {
        const path = `go_scen/data/set/${cleaned}.xlsx?t=${Date.now()}`;
        const resp = await fetch(path, { cache: 'no-store' });
        if (!resp.ok) throw new Error('not ok');
        const ab = await resp.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets['Sheet1'] || wb.Sheets[wb.SheetNames[0]];
        const cell = ws ? ws['C1'] : null;
        const raw = (cell && (cell.v ?? cell.w ?? '')) + '';
        const flag = String(raw).trim().toUpperCase().includes('Y') ? 'Y' : 'G';
        indicatorFlagCache.set(cleaned, flag);
        return flag;
      } catch (_) {
        indicatorFlagCache.set(cleaned, 'G');
        return 'G';
      }
    }

    async function computeScenarioYRate(scenarioNumber) {
      const data = scenarioData[scenarioNumber] || {};
      let ids = [];
      if (Array.isArray(data.indicators) && data.indicators.length > 0) {
        ids = data.indicators.map(ind => normalizeIndicatorId(ind.Indicator_ID)).filter(isAllowedIndicatorId);
      } else if (Array.isArray(data.links)) {
        ids = data.links.map(l => normalizeIndicatorId(l.Indicator_ID)).filter(isAllowedIndicatorId);
      }
      if (ids.length === 0) return { yCount: 0, total: 0 };
      const flags = await Promise.all(ids.map(id => fetchIndicatorFlag(id)));
      const yCount = flags.filter(f => f === 'Y').length;
      return { yCount, total: ids.length };
    }

    function mixColorHex(hexA, hexB, t) {
      const a = {
        r: parseInt(hexA.slice(1, 3), 16),
        g: parseInt(hexA.slice(3, 5), 16),
        b: parseInt(hexA.slice(5, 7), 16)
      };
      const b = {
        r: parseInt(hexB.slice(1, 3), 16),
        g: parseInt(hexB.slice(3, 5), 16),
        b: parseInt(hexB.slice(5, 7), 16)
      };
      const clamp = (x) => Math.min(255, Math.max(0, Math.round(x)));
      const r = clamp(a.r + (b.r - a.r) * t);
      const g = clamp(a.g + (b.g - a.g) * t);
      const bb = clamp(a.b + (b.b - a.b) * t);
      const toHex = (n) => n.toString(16).padStart(2, '0');
      return `#${toHex(r)}${toHex(g)}${toHex(bb)}`;
    }

    function getLinkColorFromRate(rate) {
      const lightGreen = '#9BE7A8'; // ?°í•œ ê·¸ë¦°
      const deepOrange = '#FF6A00'; // ì§„í•œ ?¤ë Œì§€
      const t = Math.max(0, Math.min(1, rate || 0));
      return mixColorHex(lightGreen, deepOrange, t);
    }

    // ê°œìˆ˜ ê¸°ë°˜ ?°ê²°???‰ìƒ ?•ì±… (3?‰ë§Œ ?¬ìš©)
    function getScenarioLinkColorByCount(yCount) {
      if (yCount >= 3) return '#E53935'; // RED (ê²½ê³ )
      if (yCount >= 1) return '#FFD54F'; // YELLOW (ì£¼ì˜)
      return '#2196F3';                  // BLUE (?•ìƒ)
    }

    function openScenarioPDF(n, scenarioId) {
      // 01~09ê¹Œì??????ë¦¬ ?¨ë”©, 10 ?´ìƒ?€ ê·¸ë?ë¡?
      const folderName = String(n).padStart(2, '0');
      const pdfPath = `go_scen/scen/${folderName}/scenario_${folderName}.pdf`;
      const pdfTitle = `?œë‚˜ë¦¬ì˜¤ ${n}: ${scenarioId || '?ì„¸ ë³´ê³ ??}`;
      
      // ëª¨ë‹¬ ?”ì†Œ??ê°€?¸ì˜¤ê¸?
      const modal = document.getElementById('pdf-modal');
      const titleElement = document.getElementById('pdf-title');
      const frameElement = document.getElementById('pdf-frame');
      
      // ?œëª© ?¤ì •
      titleElement.textContent = pdfTitle;
      
      // PDF ë¡œë“œ
      frameElement.src = pdfPath;
      
      // ëª¨ë‹¬ ?œì‹œ
      modal.classList.add('show');
      
      // ESC ?¤ë¡œ ëª¨ë‹¬ ?«ê¸°
      document.addEventListener('keydown', handleEscKey);
      
      // ëª¨ë‹¬ ë°°ê²½ ?´ë¦­ ???«ê¸°
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          closePdfModal();
        }
      });
    }

    function openNewsModal(title, url) {
      try {
        // ?”¥ ëª¨ë°”??ê°ì?
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                      || window.innerWidth <= 900;
        
        // ?”¥ ëª¨ë°”?¼ì—?œëŠ” ì§ì ‘ ?´ìŠ¤ URLë¡??´ë™ (?ì—… ì°¨ë‹¨ ë°©ì?)
        if (isMobile) {
          window.open(url, '_blank', 'noopener,noreferrer');
          return;
        }
        
        // ?”¥ PC?ì„œ??iframe ëª¨ë‹¬ ë°©ì‹ ?¬ìš©
        // ????—???´ìŠ¤ ?´ê¸° - ë°ì? ë°°ê²½ê³?80% ê¸€ê¼??¬ê¸° ?ìš©
        const newsWindow = window.open('', '_blank', 'noopener,noreferrer');
        if (newsWindow) {
          newsWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${title || 'ê´€??ê¸°ì‚¬'}</title>
              <style>
                body {
                  margin: 0;
                  padding: 20px;
                  background-color: #ffffff;
                  color: #1a1a1a;
                  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                  font-size: 0.8em; /* 80% ê¸€ê¼??¬ê¸° */
                  line-height: 1.6;
                }
                iframe {
                  width: 100%;
                  height: calc(100vh - 40px);
                  border: none;
                  background-color: #ffffff;
                }
                h1 {
                  font-size: 1.5em;
                  margin-bottom: 20px;
                  color: #1a1a1a;
                  padding-bottom: 10px;
                  border-bottom: 2px solid #e0e0e0;
                }
              </style>
            </head>
            <body>
              <h1>${title || 'ê´€??ê¸°ì‚¬'}</h1>
              <iframe src="${url || ''}" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
            </body>
            </html>
          `);
          newsWindow.document.close();
        } else {
          // window.open??ì°¨ë‹¨??ê²½ìš° ì§ì ‘ ë§í¬ë¡??´ë™
          throw new Error('?ì—…??ì°¨ë‹¨?˜ì—ˆ?µë‹ˆ??');
        }
      } catch(e) { 
        console.error('openNewsModal ?¤íŒ¨:', e);
        // ?”¥ ?¤íŒ¨ ??ì§ì ‘ ?´ìŠ¤ URLë¡??´ë™ (fallback)
        try { 
          window.open(url, '_blank', 'noopener,noreferrer'); 
        } catch(__) {
          // ìµœì¢… fallback: ?„ì¬ ??—???´ë™
          window.location.href = url;
        }
      }
    }

    function closeNewsModal() {
      try {
        const modal = document.getElementById('news-modal');
        const frameElement = document.getElementById('news-frame');
        frameElement.src = '';
        modal.classList.remove('show');
      } catch(_) {}
    }

    // ?¸ë? ?œì–´: ?œë‚˜ë¦¬ì˜¤ ?˜ì´?¼ì´??ë°??¼í„°ë§?ì¤?
    function highlightScenario(n) {
      try {
        const sel = d3.selectAll(`.scenario-group`).select('rect');
        sel.attr('stroke', '#e67e22').attr('stroke-width', 2);
        d3.select(`.scenario-group[data-scen='${n}']`).select('rect').attr('stroke', '#e74c3c').attr('stroke-width', 4);
      } catch (e) { console.warn('highlightScenario ?¤íŒ¨', e); }
    }

    function centerOnScenario(n, scale = 1.3) {
      const pos = graphState.posByScenarioNum.get(Number(n));
      if (!pos || !graphState.g) return;
      const rect = graphState.containerRect || document.getElementById('network-graph').getBoundingClientRect();
      const ct = graphState.currentTransform;
      ct.scale = Math.max(0.1, Math.min(3, scale));
      ct.x = rect.width / 2 - ct.scale * pos.x;
      ct.y = rect.height / 2 - ct.scale * pos.y;
      graphState.applyTransform && graphState.applyTransform();
    }

    function zoomDelta(delta) {
      const ct = graphState.currentTransform;
      const rect = graphState.containerRect || document.getElementById('network-graph').getBoundingClientRect();
      // ?”ë©´ ì¤‘ì•™ ê¸°ì? ì¤?
      const mouseX = rect.width / 2;
      const mouseY = rect.height / 2;
      const newScale = Math.max(0.1, Math.min(3, ct.scale * (delta > 0 ? 1.1 : 0.9)));
      const scaleDiff = newScale - ct.scale;
      ct.x -= (mouseX - ct.x) * scaleDiff / ct.scale;
      ct.y -= (mouseY - ct.y) * scaleDiff / ct.scale;
      ct.scale = newScale;
      graphState.applyTransform && graphState.applyTransform();
    }
    
    function closePdfModal() {
      const modal = document.getElementById('pdf-modal');
      const frameElement = document.getElementById('pdf-frame');
      
      // ëª¨ë‹¬ ?¨ê¸°ê¸?
      modal.classList.remove('show');
      
      // PDF ?„ë ˆ??ì´ˆê¸°??(ë©”ëª¨ë¦??ˆì•½)
      frameElement.src = '';
      
      // ESC ???´ë²¤???œê±°
      document.removeEventListener('keydown', handleEscKey);
    }
    
    function handleEscKey(event) {
      if (event.key === 'Escape') {
        closePdfModal();
        closeChartModal();
      }
    }

    // ====== ë§ˆì¼“?°ì´???µê³„/ë³€?™ì„± ê³„ì‚° ? í‹¸ë¦¬í‹° ======
    
    // ë³€?™ì„± ê³„ì‚° (ë¡¤ë§ ?ˆë„??
    function calculateRollingVolatility(data, window = 20) {
      const volatility = [];
      for (let i = window - 1; i < data.length; i++) {
        const slice = data.slice(i - window + 1, i + 1);
        const returns = [];
        for (let j = 1; j < slice.length; j++) {
          const ret = (slice[j].value - slice[j-1].value) / slice[j-1].value;
          if (!isNaN(ret) && isFinite(ret)) returns.push(ret);
        }
        if (returns.length > 0) {
          const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
          const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
          volatility.push({
            date: slice[slice.length - 1].date,
            vol: Math.sqrt(variance) * Math.sqrt(252) * 100 // ?°ìœ¨??ë°?%ë¡?ë³€??
          });
        } else {
          volatility.push({ date: slice[slice.length - 1].date, vol: 0 });
        }
      }
      return volatility;
    }

    // ê¸°ë³¸ ?µê³„ ê³„ì‚°
    function calculateStatistics(data) {
      const values = data.map(d => parseFloat(d.value)).filter(v => !isNaN(v));
      if (values.length === 0) return null;
      
      const sorted = [...values].sort((a, b) => a - b);
      const min = sorted[0];
      const max = sorted[sorted.length - 1];
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      const current = values[values.length - 1];
      const prev = values[values.length - 2] || current;
      const change = current - prev;
      const changePercent = (change / prev) * 100;
      
      // ìµœê·¼ 3ê°œì›” (??63 ê±°ë˜?? ìµœê³ /ìµœì?
      const recent3M = values.slice(-63);
      const recent3MHigh = Math.max(...recent3M);
      const recent3MLow = Math.min(...recent3M);
      
      // 52ì£??„ì¹˜ ê³„ì‚° (??252 ê±°ë˜??
      const recent52w = values.slice(-252);
      if (recent52w.length > 0) {
        const high52w = Math.max(...recent52w);
        const low52w = Math.min(...recent52w);
        const pos52w = ((current - low52w) / (high52w - low52w)) * 100;
        
        return {
          current, min, max, mean, change, changePercent,
          recent3MHigh, recent3MLow,
          high52w, low52w, pos52w: isNaN(pos52w) ? 50 : pos52w
        };
      }
      
      return {
        current, min, max, mean, change, changePercent,
        recent3MHigh, recent3MLow,
        high52w: max, low52w: min, pos52w: 50
      };
    }

    // ?„ê³„ì¹??ì„± (?‰ê·  ê¸°ë°˜ ?ëŠ” ê³ ì •ê°?
    function generateThresholds(stats, indicatorId) {
      // ?¹ì • ì§€?œë³„ ê³ ì • ?„ê³„ì¹?
      const customThresholds = {
        // USD/KRW ?˜ìœ¨ (IND071)
        'IND071': { 
          yellow: 1400,  // ì£¼ì˜
          orange: 1600,  // ê²½ê³ 
          red: 1800      // ?¬ê°
        },
        // ?„ìš”??ì¶”ê? ì§€???¤ì • ê°€??
        // 'IND001': { yellow: 3.0, orange: 3.5, red: 4.0 }
        'IND077': { yellow: 16, orange: 22, red: 30 },
        'IND037': { yellow: 150, orange: 200, red: 250 },
      };
      
      // ê³ ì • ?„ê³„ì¹˜ê? ?ˆìœ¼ë©??°ì„  ?¬ìš©
      if (customThresholds[indicatorId]) {
        console.log(`?¯ ${indicatorId}: ê³ ì • ?„ê³„ì¹??¬ìš©`, customThresholds[indicatorId]);
        return customThresholds[indicatorId];
      }
      
      // ê¸°ë³¸ ?„ê³„ì¹?(?‰ê·  ê¸°ì?)
      const thresholds = {
        yellow: stats.mean + stats.mean * 0.1,  // ?‰ê·  + 10%
        orange: stats.mean + stats.mean * 0.2,  // ?‰ê·  + 20%
        red: stats.mean + stats.mean * 0.3,     // ?‰ê·  + 30%
      };
      
      console.log(`?¯ ${indicatorId}: ?ë™ ?„ê³„ì¹??¬ìš©`, thresholds);
      return thresholds;
    }

    // ë¦¬ìŠ¤???ˆë²¨ ?ë‹¨
    function assessRiskLevel(current, thresholds, stats, volStats) {
      let level = '?•ìƒ';
      let color = '#27ae60';
      let comment = '';
      
      // ?ˆë²¨ ?ë‹¨
      if (current >= thresholds.red) {
        level = '?¬ê°';
        color = '#e74c3c';
        comment = '?„ê³„ì¹˜ë? ?¬ê²Œ ì´ˆê³¼?˜ì—¬ ì¦‰ê°?ì¸ ëª¨ë‹ˆ?°ë§???„ìš”?©ë‹ˆ??';
      } else if (current >= thresholds.orange) {
        level = 'ê²½ê³ ';
        color = '#e67e22';
        comment = 'ì£¼ì˜ êµ¬ê°„??ì§„ì…?ˆìŠµ?ˆë‹¤. ë©´ë???ê´€ì°°ì´ ?„ìš”?©ë‹ˆ??';
      } else if (current >= thresholds.yellow) {
        level = 'ì£¼ì˜';
        color = '#f39c12';
        comment = '?‰ê·  ?˜ì????íšŒ?˜ê³  ?ˆìŠµ?ˆë‹¤.';
      } else {
        comment = '?•ìƒ ë²”ìœ„ ?´ì— ?ˆìŠµ?ˆë‹¤.';
      }
      
      // ë³€?™ì„± ë¶„ì„
      if (volStats) {
        const currentVol = volStats.current;
        const avgVol = volStats.mean;
        
        if (currentVol > avgVol * 1.5) {
          comment += ' ìµœê·¼ ë³€?™ì„±???¬ê²Œ ?•ë??˜ì—ˆ?µë‹ˆ??';
          if (level === '?•ìƒ') {
            level = 'ì£¼ì˜';
            color = '#f39c12';
          }
        } else if (currentVol < avgVol * 0.5) {
          comment += ' ë³€?™ì„±????? ?ˆì •?ì¸ ?íƒœ?…ë‹ˆ??';
        }
      }
      
      return { level, color, comment };
    }

    // ?µí•© ë§ˆì¼“?°ì´???€?œë³´??
    async function openTimeseriesChart(indicatorId, indicatorDisplayName) {
      try {
        console.log(`?? ë§ˆì¼“?°ì´???€?œë³´??ë¡œë”© ?œì‘: ${indicatorId} - ${indicatorDisplayName}`);
        
        // ?‘ì? ?Œì¼ ê²½ë¡œ
        const excelPath = `go_scen/data/set/${indicatorId}.xlsx`;
        console.log(`?“ ?Œì¼ ê²½ë¡œ: ${excelPath}`);
        
        // ?‘ì? ?Œì¼ ë¡œë“œ
        const response = await fetch(excelPath);
        if (!response.ok) {
          throw new Error(`?Œì¼??ì°¾ì„ ???†ìŠµ?ˆë‹¤: ${excelPath}`);
        }
        console.log(`???Œì¼ ë¡œë“œ ?±ê³µ`);
        
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, {type: 'array'});
        console.log(`?“Š ?Œí¬ë¶??œíŠ¸ ëª©ë¡:`, workbook.SheetNames);
        
        // Sheet1 ?°ì´??ê°€?¸ì˜¤ê¸?
        const worksheet = workbook.Sheets['Sheet1'] || workbook.Sheets[workbook.SheetNames[0]];
        if (!worksheet) {
          throw new Error('?Œí¬?œíŠ¸ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        }
        
        // A4ë¶€???°ì´???½ê¸°
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
          range: 'A4:B10000',
          header: ['date', 'value'],
          raw: false
        });
        console.log(`?“ ?ë³¸ ?°ì´?????? ${jsonData.length}`);
        
        // ë¹??°ì´???œê±° ë°?? íš¨???°ì´?°ë§Œ ?„í„°ë§?
        const validData = jsonData.filter(row => 
          row.date && row.value !== null && row.value !== undefined && row.value !== ''
        ).map(row => ({
          date: row.date,
          value: parseFloat(row.value)
        })).filter(row => !isNaN(row.value));
        
        if (validData.length === 0) {
          throw new Error('? íš¨???°ì´?°ê? ?†ìŠµ?ˆë‹¤.');
        }
        
        console.log(`??? íš¨ ?°ì´?? ${validData.length}ê°??ˆì½”??);
        console.log(`?“… ì²??°ì´??`, validData[0]);
        console.log(`?“… ë§ˆì?ë§??°ì´??`, validData[validData.length - 1]);
        
        // ?µê³„ ê³„ì‚°
        console.log(`?§® ?µê³„ ê³„ì‚° ?œì‘...`);
        const stats = calculateStatistics(validData);
        if (!stats) {
          throw new Error('?µê³„ ê³„ì‚° ?¤íŒ¨');
        }
        console.log(`???µê³„ ê³„ì‚° ?„ë£Œ:`, stats);
        
        const thresholds = generateThresholds(stats, indicatorId);
        console.log(`?¯ ?„ê³„ì¹??ì„± ?„ë£Œ:`, thresholds);
        
        // ë³€?™ì„± ê³„ì‚° (20?? 60??
        console.log(`?“ˆ ë³€?™ì„± ê³„ì‚° ?œì‘...`);
        const vol20 = calculateRollingVolatility(validData, 20);
        const vol60 = calculateRollingVolatility(validData, 60);
        console.log(`??ë³€?™ì„± ê³„ì‚° ?„ë£Œ: 20??${vol20.length}ê°? 60??${vol60.length}ê°?);
        
        // ë³€?™ì„± ?µê³„
        const volValues = vol20.map(v => v.vol);
        const volStats = volValues.length > 0 ? {
          current: volValues[volValues.length - 1] || 0,
          mean: volValues.reduce((a, b) => a + b, 0) / volValues.length,
          max: Math.max(...volValues),
          min: Math.min(...volValues)
        } : null;
        console.log(`?“Š ë³€?™ì„± ?µê³„:`, volStats);
        
        // ë¦¬ìŠ¤???‰ê?
        console.log(`? ï¸ ë¦¬ìŠ¤???‰ê? ?œì‘...`);
        const risk = assessRiskLevel(stats.current, thresholds, stats, volStats);
        console.log(`??ë¦¬ìŠ¤???‰ê? ?„ë£Œ:`, risk);
        
        // ëª¨ë‹¬ ?´ê¸°
        const modal = document.getElementById('chart-modal');
        if (!modal) {
          throw new Error('ì°¨íŠ¸ ëª¨ë‹¬??ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        }
        
        const titleElement = document.getElementById('chart-title');
        if (titleElement) {
          titleElement.textContent = `${indicatorDisplayName} (${indicatorId}) ë§ˆì¼“?°ì´??ë¶„ì„`;
        }
        
        console.log(`?–¼ï¸?ëª¨ë‹¬ ?´ê¸°...`);
        modal.classList.add('show');
        
        // ?€?œë³´???Œë”ë§?(ëª¨ë‹¬???œì‹œ????
        console.log(`?¨ ?€?œë³´???Œë”ë§??œì‘...`);
        setTimeout(() => {
          try {
            renderMarketDataDashboard({
              indicatorId,
              indicatorDisplayName,
              data: validData,
              stats,
              thresholds,
              vol20,
              vol60,
              volStats,
              risk
            });
            console.log(`???€?œë³´???Œë”ë§??„ë£Œ!`);
          } catch (renderError) {
            console.error('???Œë”ë§??¤ë¥˜:', renderError);
            alert(`?Œë”ë§??¤ë¥˜: ${renderError.message}`);
          }
        }, 100);
        
        // ESC ?¤ë¡œ ëª¨ë‹¬ ?«ê¸°
        document.addEventListener('keydown', handleEscKeyChart);
        
        // ëª¨ë‹¬ ë°°ê²½ ?´ë¦­ ???«ê¸°
        modal.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeChartModal();
          }
        });
        
      } catch (error) {
        console.error('??ë§ˆì¼“?°ì´???€?œë³´??ë¡œë”© ?¤ë¥˜:', error);
        console.error('?¤ë¥˜ ?¤íƒ:', error.stack);
        alert(`?€?œë³´?œë? ë¡œë“œ?????†ìŠµ?ˆë‹¤: ${error.message}`);
      }
    }

    // ====== ?µí•© ?€?œë³´???Œë”ë§?======
    let timeseriesChartInstance = null;
    let volatilityChartInstance = null;

    function renderMarketDataDashboard(dashboardData) {
      console.log('?¨ renderMarketDataDashboard ?œì‘:', dashboardData);
      
      const {
        indicatorId,
        indicatorDisplayName,
        data,
        stats,
        thresholds,
        vol20,
        vol60,
        volStats,
        risk
      } = dashboardData;

      // ?Œë§ˆ ?•ì¸
      const isDarkMode = document.body.getAttribute('data-theme') === 'dark';
      const textColor = isDarkMode ? '#f5f5f5' : '#333333';
      const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
      const backgroundColor = isDarkMode ? '#181a20' : '#ffffff';

      try {
        // 1. ?ë‹¨ ?”ì•½ ?•ë³´ ?Œë”ë§?
        console.log('1ï¸âƒ£ ?ë‹¨ ?”ì•½ ?Œë”ë§?..');
        renderIndicatorSummary(indicatorDisplayName, stats, risk, volStats);
        console.log('???ë‹¨ ?”ì•½ ?„ë£Œ');
      } catch (err) {
        console.error('???ë‹¨ ?”ì•½ ?¤ë¥˜:', err);
      }

      try {
        // 2. ?œê³„??ê·¸ë˜??+ ?„ê³„ì¹??Œë”ë§?
        console.log('2ï¸âƒ£ ?œê³„??ê·¸ë˜???Œë”ë§?..');
        renderTimeseriesWithThresholds(data, indicatorDisplayName, thresholds, risk, textColor, gridColor, backgroundColor);
        console.log('???œê³„??ê·¸ë˜???„ë£Œ');
      } catch (err) {
        console.error('???œê³„??ê·¸ë˜???¤ë¥˜:', err);
      }

      try {
        // 3. ë³€?™ì„± ê·¸ë˜???Œë”ë§?
        console.log('3ï¸âƒ£ ë³€?™ì„± ê·¸ë˜???Œë”ë§?..');
        renderVolatilityChart(vol20, vol60, textColor, gridColor, backgroundColor);
        console.log('??ë³€?™ì„± ê·¸ë˜???„ë£Œ');
      } catch (err) {
        console.error('??ë³€?™ì„± ê·¸ë˜???¤ë¥˜:', err);
      }

      try {
        // 4. ë¦¬ìŠ¤??ë¶„ì„ ?ìŠ¤???Œë”ë§?
        console.log('4ï¸âƒ£ ë¦¬ìŠ¤??ë¶„ì„ ?Œë”ë§?..');
        renderRiskAnalysis(stats, thresholds, volStats, risk);
        console.log('??ë¦¬ìŠ¤??ë¶„ì„ ?„ë£Œ');
      } catch (err) {
        console.error('??ë¦¬ìŠ¤??ë¶„ì„ ?¤ë¥˜:', err);
      }
      
      console.log('?‰ renderMarketDataDashboard ?„ì²´ ?„ë£Œ!');
    }

    // 1. ì§€???•ë³´ ?”ì•½ ?Œë”ë§?
    function renderIndicatorSummary(name, stats, risk, volStats) {
      console.log('?“Š renderIndicatorSummary ?¸ì¶œ:', { name, stats, risk, volStats });
      
      const nameEl = document.getElementById('indicator-name');
      const statsEl = document.getElementById('indicator-stats');
      
      if (!nameEl) {
        console.error('??indicator-name ?”ì†Œë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        return;
      }
      if (!statsEl) {
        console.error('??indicator-stats ?”ì†Œë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        return;
      }

      nameEl.textContent = name;
      nameEl.style.color = risk.color;

      const changeSign = stats.change >= 0 ? '+' : '';
      const changeColor = stats.change >= 0 ? '#27ae60' : '#e74c3c';

      statsEl.innerHTML = `
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">?„ì¬ ê°?/div>
          <div style="font-size: 20px; font-weight: bold; color: ${risk.color};">${stats.current.toFixed(4)}</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">?„ì¼ ?€ë¹?/div>
          <div style="font-size: 16px; font-weight: bold; color: ${changeColor};">
            ${changeSign}${stats.change.toFixed(4)} (${changeSign}${stats.changePercent.toFixed(2)}%)
          </div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">?‰ê· </div>
          <div style="font-size: 16px; font-weight: bold;">${stats.mean.toFixed(4)}</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">52ì£??„ì¹˜</div>
          <div style="font-size: 16px; font-weight: bold;">${stats.pos52w.toFixed(1)}%</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">ë¦¬ìŠ¤???ˆë²¨</div>
          <div style="font-size: 16px; font-weight: bold; color: ${risk.color};">${risk.level}</div>
        </div>
        <div style="padding: 10px; background: var(--main-bg); border-radius: 6px;">
          <div style="font-size: 12px; color: #888; margin-bottom: 4px;">?„ì¬ ë³€?™ì„± (20??</div>
          <div style="font-size: 16px; font-weight: bold;">${volStats ? volStats.current.toFixed(2) + '%' : 'N/A'}</div>
        </div>
      `;
    }

    // 2. ?œê³„??ê·¸ë˜??+ ?„ê³„ì¹??Œë”ë§?
    function renderTimeseriesWithThresholds(data, name, thresholds, risk, textColor, gridColor, backgroundColor) {
      console.log('?“ˆ renderTimeseriesWithThresholds ?œì‘:', { dataLength: data?.length, name, thresholds });
      
      const canvas = document.getElementById('timeseries-chart');
      if (!canvas) {
        console.error('???œê³„??ì°¨íŠ¸ ìº”ë²„?¤ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        return;
      }

      const ctx = canvas.getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ?? œ
      if (timeseriesChartInstance) {
        timeseriesChartInstance.destroy();
      }

      // ìµœê·¼ 6ê°œì›” ?°ì´?°ë§Œ ?œì‹œ (??126 ê±°ë˜??
      const recentData = data.slice(-126);

      // ? ì§œ ?ˆì´ë¸?
      const labels = recentData.map(d => {
        try {
          const date = new Date(d.date);
          if (isNaN(date.getTime())) return d.date;
          return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        } catch (e) {
          return d.date;
        }
      });

      const values = recentData.map(d => d.value);

      // ë°°ê²½???ŒëŸ¬ê·¸ì¸
      const backgroundColorPlugin = {
        id: 'backgroundColorPlugin',
        beforeDraw: (chart) => {
          const ctx = chart.canvas.getContext('2d');
          ctx.save();
          ctx.globalCompositeOperation = 'destination-over';
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, chart.width, chart.height);
          ctx.restore();
        }
      };

      // ?°ì´?°ì…‹ êµ¬ì„±
      const datasets = [
        {
          label: name,
          data: values,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 4,
          order: 1
        }
      ];

      // ?„ê³„ì¹???ì¶”ê?
      const thresholdLines = [
        { value: thresholds.yellow, color: '#f39c12', label: 'ì£¼ì˜' },
        { value: thresholds.orange, color: '#e67e22', label: 'ê²½ê³ ' },
        { value: thresholds.red, color: '#e74c3c', label: '?¬ê°' }
      ];

      thresholdLines.forEach((threshold, idx) => {
        datasets.push({
          label: `?„ê³„ì¹?(${threshold.label})`,
          data: new Array(labels.length).fill(threshold.value),
          borderColor: threshold.color,
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          pointRadius: 0,
          order: 2 + idx
        });
      });

      // ì°¨íŠ¸ ?ì„±
      timeseriesChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        plugins: [backgroundColorPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            title: { display: false },
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: textColor,
                font: { size: 11 },
                usePointStyle: true,
                padding: 10
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#555',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: '? ì§œ',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                maxTicksLimit: 8,
                font: { size: 10 }
              },
              grid: { color: gridColor }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ê°?,
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                font: { size: 10 }
              },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    // 3. ë³€?™ì„± ê·¸ë˜???Œë”ë§?
    function renderVolatilityChart(vol20, vol60, textColor, gridColor, backgroundColor) {
      console.log('?“ˆ renderVolatilityChart ?œì‘:', { vol20Length: vol20?.length, vol60Length: vol60?.length });
      
      const canvas = document.getElementById('volatility-chart');
      if (!canvas) {
        console.error('??ë³€?™ì„± ì°¨íŠ¸ ìº”ë²„?¤ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        return;
      }

      const ctx = canvas.getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ?? œ
      if (volatilityChartInstance) {
        volatilityChartInstance.destroy();
      }

      // ?°ì´??ê²€ì¦?
      if (!vol20 || vol20.length === 0) {
        console.warn('? ï¸ 20??ë³€?™ì„± ?°ì´?°ê? ?†ìŠµ?ˆë‹¤.');
        return;
      }

      // ìµœê·¼ 6ê°œì›” ?°ì´??
      const recentVol20 = vol20.slice(-126);
      const recentVol60 = vol60 && vol60.length > 0 ? vol60.slice(-126) : [];

      const labels = recentVol20.map(v => {
        try {
          const date = new Date(v.date);
          if (isNaN(date.getTime())) return v.date;
          return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        } catch (e) {
          return v.date;
        }
      });

      const vol20Values = recentVol20.map(v => v.vol);
      const vol60Values = recentVol60.length > 0 ? recentVol60.map(v => v.vol) : [];
      
      console.log('?“Š ë³€?™ì„± ?°ì´??ì¤€ë¹??„ë£Œ:', { labelsCount: labels.length, vol20Count: vol20Values.length, vol60Count: vol60Values.length });

      // ë°°ê²½???ŒëŸ¬ê·¸ì¸
      const backgroundColorPlugin = {
        id: 'backgroundColorPlugin2',
        beforeDraw: (chart) => {
          const ctx = chart.canvas.getContext('2d');
          ctx.save();
          ctx.globalCompositeOperation = 'destination-over';
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, chart.width, chart.height);
          ctx.restore();
        }
      };

      // ?°ì´?°ì…‹ êµ¬ì„±
      const datasets = [
        {
          label: '20??ë³€?™ì„±',
          data: vol20Values,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231, 76, 60, 0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4
        }
      ];

      // 60??ë³€?™ì„± ?°ì´?°ê? ?ˆìœ¼ë©?ì¶”ê?
      if (vol60Values.length > 0) {
        datasets.push({
          label: '60??ë³€?™ì„±',
          data: vol60Values,
          borderColor: '#9b59b6',
          backgroundColor: 'rgba(155, 89, 182, 0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          pointHoverRadius: 4
        });
      }

      // ì°¨íŠ¸ ?ì„±
      volatilityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets
        },
        plugins: [backgroundColorPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            title: { display: false },
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: textColor,
                font: { size: 11 },
                usePointStyle: true,
                padding: 10
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#555',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: '? ì§œ',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                maxTicksLimit: 8,
                font: { size: 10 }
              },
              grid: { color: gridColor }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: '?°ìœ¨??ë³€?™ì„± (%)',
                color: textColor,
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                color: textColor,
                font: { size: 10 },
                callback: function(value) {
                  return value.toFixed(1) + '%';
                }
              },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    // 4. ë¦¬ìŠ¤??ë¶„ì„ ?ìŠ¤???Œë”ë§?
    function renderRiskAnalysis(stats, thresholds, volStats, risk) {
      console.log('?“ renderRiskAnalysis ?œì‘:', { stats, thresholds, volStats, risk });
      
      const contentEl = document.getElementById('risk-content');
      if (!contentEl) {
        console.error('??risk-content ?”ì†Œë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤.');
        return;
      }
      
      const pos52wStatus = stats.pos52w > 80 ? '?ë‹¨' : 
                          stats.pos52w > 60 ? '?ë‹¨ ê·¼ì ‘' :
                          stats.pos52w > 40 ? 'ì¤‘ê°„' :
                          stats.pos52w > 20 ? '?˜ë‹¨ ê·¼ì ‘' : '?˜ë‹¨';

      const volComparison = volStats ? 
        (volStats.current > volStats.mean * 1.5 ? '?¬ê²Œ ?•ë?' :
         volStats.current > volStats.mean * 1.2 ? '?•ë?' :
         volStats.current < volStats.mean * 0.8 ? 'ì¶•ì†Œ' : '?‰ê·  ?˜ì?') : 'N/A';

      const trendDirection = stats.change > 0 ? '?ìŠ¹' : 
                             stats.change < 0 ? '?˜ë½' : 'ë³´í•©';

      contentEl.innerHTML = `
        <div style="margin-bottom: 15px;">
          <strong style="font-size: 15px; color: ${risk.color};">?¯ ?„ì¬ ë¦¬ìŠ¤???ˆë²¨: ${risk.level}</strong>
        </div>
        
        <div style="margin-bottom: 12px;">
          <strong>?“Š ?„ì¬ ?˜ì? vs ?„ê³„ì¹?/strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>?„ì¬ ê°? <strong>${stats.current.toFixed(4)}</strong></li>
            <li>ì£¼ì˜ ?„ê³„ì¹? ${thresholds.yellow.toFixed(4)} ${stats.current >= thresholds.yellow ? '???„ë‹¬' : ''}</li>
            <li>ê²½ê³  ?„ê³„ì¹? ${thresholds.orange.toFixed(4)} ${stats.current >= thresholds.orange ? '? ï¸ ?„ë‹¬' : ''}</li>
            <li>?¬ê° ?„ê³„ì¹? ${thresholds.red.toFixed(4)} ${stats.current >= thresholds.red ? '?š¨ ?„ë‹¬' : ''}</li>
          </ul>
        </div>

        <div style="margin-bottom: 12px;">
          <strong>?“ˆ ë³€?™ì„± ë¶„ì„</strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>?„ì¬ 20??ë³€?™ì„±: <strong>${volStats ? volStats.current.toFixed(2) + '%' : 'N/A'}</strong></li>
            <li>?‰ê·  ë³€?™ì„±: ${volStats ? volStats.mean.toFixed(2) + '%' : 'N/A'}</li>
            <li>ë³€?™ì„± ?íƒœ: <strong>${volComparison}</strong></li>
            ${volStats && volStats.current > volStats.mean * 1.5 ? '<li style="color: #e74c3c;">? ï¸ ë³€?™ì„± ê¸‰ë“± - ì£¼ì˜ ?„ìš”</li>' : ''}
          </ul>
        </div>

        <div style="margin-bottom: 12px;">
          <strong>?“ ?œì¥ ?¬ì???/strong>
          <ul style="margin: 8px 0; padding-left: 20px;">
            <li>52ì£????„ì¹˜: <strong>${stats.pos52w.toFixed(1)}%</strong> (${pos52wStatus})</li>
            <li>52ì£?ìµœê³ : ${stats.high52w.toFixed(4)}</li>
            <li>52ì£?ìµœì?: ${stats.low52w.toFixed(4)}</li>
            <li>ìµœê·¼ ì¶”ì„¸: <strong>${trendDirection}</strong></li>
          </ul>
        </div>

        <div style="padding: 12px; background: ${risk.color}22; border-left: 4px solid ${risk.color}; border-radius: 4px;">
          <strong>?’¡ ì¢…í•© ?˜ê²¬</strong><br>
          ${risk.comment}
          ${stats.pos52w > 80 && volStats && volStats.current > volStats.mean * 1.3 ? 
            '<br>52ì£??ë‹¨ ê·¼ì ‘ + ë³€?™ì„± ?•ë? ??ì¡°ì • ê°€?¥ì„±???€ë¹„í•˜?¸ìš”.' : ''}
          ${stats.pos52w < 20 && volStats && volStats.current > volStats.mean * 1.3 ? 
            '<br>52ì£??˜ë‹¨ ê·¼ì ‘ + ë³€?™ì„± ?•ë? ??ë°˜ë“± ?ëŠ” ì¶”ê? ?˜ë½ ê°€?¥ì„± ëª¨ë‘ ?´ë ¤?ˆìŠµ?ˆë‹¤.' : ''}
        </div>
      `;
    }

    function closeChartModal() {
      const modal = document.getElementById('chart-modal');
      
      // ëª¨ë‹¬ ?¨ê¸°ê¸?
      modal.classList.remove('show');
      
      // ì°¨íŠ¸ ?? œ (ë©”ëª¨ë¦??ˆì•½)
      if (timeseriesChartInstance) {
        timeseriesChartInstance.destroy();
        timeseriesChartInstance = null;
      }
      if (volatilityChartInstance) {
        volatilityChartInstance.destroy();
        volatilityChartInstance = null;
      }
      
      // ESC ???´ë²¤???œê±°
      document.removeEventListener('keydown', handleEscKeyChart);
    }
    
    function handleEscKeyChart(event) {
      if (event.key === 'Escape') {
        closeChartModal();
      }
    }

    // ====== GPT1 ?µí•© ê´€??? í‹¸ ======
    function buildGptMessageFromScenario(scenarioNumber) {
      const data = scenarioData[scenarioNumber];
      if (!data) return '';
      const overview = data.overview || {};
      const scenarioId = overview.Scenario_ID || `Scenario_${scenarioNumber}`;
      const scenarioName = overview.Scenario_Name || `?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}`;

      // indicators ?°ì„ , ?†ìœ¼ë©?links ?¬ìš©
      let baseItems = [];
      let isFromIndicators = false;
      if (data.indicators && data.indicators.length > 0) {
        isFromIndicators = true;
        baseItems = data.indicators.map(ind => ({
          Indicator_ID: ind.Indicator_ID,
          Weight: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Weight,
          Correlation_Coeff: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Correlation_Coeff
        }));
      } else if (data.links && data.links.length > 0) {
        baseItems = data.links.map(l => ({
          Indicator_ID: l.Indicator_ID,
          Weight: l.Weight,
          Correlation_Coeff: l.Correlation_Coeff
        }));
      }

      const connected = baseItems
        .map(item => {
          const ticker = indicatorIdToNameMap.get(item.Indicator_ID);
          return ticker ? {
            id: item.Indicator_ID,
            ticker,
            weight: item.Weight,
            corr: item.Correlation_Coeff
          } : null;
        })
        .filter(Boolean);

      const header = `?œë‚˜ë¦¬ì˜¤: ${scenarioName} (${scenarioId})`;
      const detail = overview.Description || overview.Summary || overview.Overview || '';
      const fromSheet = isFromIndicators ? 'INDICATOR ?œíŠ¸' : 'LINKS ?œíŠ¸';

      const list = connected.map(c => `- ${c.id} | ${c.ticker}` +
        (c.weight !== undefined ? ` | Weight: ${c.weight}` : '') +
        (c.corr !== undefined ? ` | Corr: ${c.corr}` : '')).join('\n');

      return [
        header,
        detail ? `ê°œìš”: ${detail}` : '',
        `?°ê²° ì¶œì²˜: ${fromSheet}`,
        '?°ê²°???œì¥?°ì´??',
        list || '- ?†ìŒ'
      ].filter(Boolean).join('\n');
    }

    function onClickScenarioToGptLink(scenarioNumber) {
      selectedScenarioForGPT = scenarioNumber;
      const data = scenarioData[scenarioNumber];
      const name = data?.overview?.Scenario_Name || `?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}`;
      document.getElementById('selected-scenario-name').textContent = name;

      // ?°ê²°??ì§€??êµ¬ì„± (?ˆë¡œ??ë§¤í•‘ ë°©ì‹ ?°ì„ )
      let connected = [];
      
      if (scenarioToIndicatorsMap.has(scenarioNumber)) {
        // ?ˆë¡œ??ë§¤í•‘ ë°©ì‹: indicator.xlsx?ì„œ ?œë‚˜ë¦¬ì˜¤ë³?ì§€??ê°€?¸ì˜¤ê¸?
        const indicators = scenarioToIndicatorsMap.get(scenarioNumber);
        connected = indicators.map(item => ({
          id: item.indicatorId,
          name: item.indicatorName,
          ticker: item.bloombergTicker,
          weight: 'N/A', // indicator.xlsx?ëŠ” weight ?•ë³´ê°€ ?†ìŒ
          corr: 'N/A'    // indicator.xlsx?ëŠ” correlation ?•ë³´ê°€ ?†ìŒ
        }));
        console.log(`???œë‚˜ë¦¬ì˜¤ ${scenarioNumber}???ˆë¡œ??ë§¤í•‘?ì„œ ${connected.length}ê°?ì§€??ì°¾ìŒ`);
      } else {
        // ê¸°ì¡´ ë°©ì‹?¼ë¡œ fallback
      let baseItems = [];
      if (data?.indicators?.length) {
        baseItems = data.indicators.map(ind => ({
          Indicator_ID: ind.Indicator_ID,
          Weight: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Weight,
          Correlation_Coeff: data.links?.find(l => l.Indicator_ID === ind.Indicator_ID)?.Correlation_Coeff
        }));
      } else if (data?.links?.length) {
        baseItems = data.links.map(l => ({
          Indicator_ID: l.Indicator_ID,
          Weight: l.Weight,
          Correlation_Coeff: l.Correlation_Coeff
        }));
      }

        connected = baseItems
        .map(item => {
          const ticker = indicatorIdToNameMap.get(item.Indicator_ID);
          return ticker ? {
            id: item.Indicator_ID,
            ticker,
            weight: item.Weight,
            corr: item.Correlation_Coeff
          } : null;
        })
        .filter(Boolean);
        console.log(`? ï¸ ?œë‚˜ë¦¬ì˜¤ ${scenarioNumber}???ˆë¡œ??ë§¤í•‘???†ì–´ ê¸°ì¡´ ë°©ì‹ ?¬ìš©: ${connected.length}ê°?ì§€??);
      }

      const listEl = document.getElementById('selected-indicators-list');
      listEl.innerHTML = '';
      if (connected.length === 0) {
        const li = document.createElement('li');
        li.textContent = '?°ê²°??ì§€???†ìŒ';
        listEl.appendChild(li);
      } else {
        connected.forEach(c => {
          const li = document.createElement('li');
          // ?ˆë¡œ??ë§¤í•‘ ë°©ì‹??ë§ì¶˜ ?œì‹œ
          if (scenarioToIndicatorsMap.has(scenarioNumber)) {
            // ?ˆë¡œ??ë§¤í•‘: ?´ë¦„ê³??°ì»¤ ?°ì„  ?œì‹œ
            const displayName = c.name || c.ticker || c.id;
            const tickerInfo = c.ticker ? ` | ${c.ticker}` : '';
            li.textContent = `${displayName}${tickerInfo} | ID: ${c.id}`;
          } else {
            // ê¸°ì¡´ ë°©ì‹: ID?€ ?°ì»¤ ?œì‹œ
          li.textContent = `${c.id} | ${c.ticker}` +
            (c.weight !== undefined ? ` | W:${c.weight}` : '') +
            (c.corr !== undefined ? ` | Corr:${c.corr}` : '');
          }
          listEl.appendChild(li);
        });
      }

      document.getElementById('gpt1-message').value = buildGptMessageFromScenario(scenarioNumber);
      document.getElementById('send-status').textContent = 'ë¶„ì„ì¤€ë¹„ì™„ë£?';

      // ?ì´?„íŠ¸ ì¹´ë“œ ?˜ì´?¼ì´??(?ˆë‚´ë¬¸ì? ê³ ì • UI ? ì?)
      try {
        initializeCardGuidance();
        document.getElementById('card-gpt1')?.classList.add('active');
        document.getElementById('card-gpt2')?.classList.add('active');
        document.getElementById('card-gpt3')?.classList.add('active');
        document.getElementById('card-gpt4')?.classList.add('active');
      } catch (e) { console.warn(e); }

      // GPT1 ë²„ë¸”???œë‚˜ë¦¬ì˜¤?’GPT1 ?°ê²°???´ë¦­ ?„ì¹˜ ê·¼ì²˜???´ì–´ì¤?
      // ë²„ë¸” ?œì‹œ ?œê±°
    }

    function copyMessageToClipboard() {
      const ta = document.getElementById('gpt1-message');
      ta.select();
      ta.setSelectionRange(0, 99999);
      const ok = document.execCommand('copy');
      document.getElementById('send-status').textContent = ok ? '?´ë¦½ë³´ë“œë¡?ë³µì‚¬?? : 'ë³µì‚¬ ?¤íŒ¨';
    }

    function copyText(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.select?.();
      el.setSelectionRange?.(0, 999999);
      const ok = document.execCommand('copy');
      document.getElementById('send-status').textContent = ok ? `${id} ë³µì‚¬?? : 'ë³µì‚¬ ?¤íŒ¨';
    }

    // GPT3 ?„ì²´ ?¤í–‰ (ì¹´ë“œ ?ë‹¨ ë²„íŠ¼)
    async function runGpt3All(){
      console.log('?? runGpt3All ?œì‘...');
      const status = document.getElementById('send-status');
      try{
        // API ???¬ì „ ê²€ì¦?
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = '??API ?¤ê? ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ??';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = 'GPT3 ?„ì²´ ?¤í–‰ ì¤?..';
        console.log('?“‹ ?íƒœ ?…ë°?´íŠ¸ ?„ë£Œ');
        
        // GPT3 ?œì‘ ?œì ?ë§Œ GPT3ë¡??´ë™
        console.log('?”„ GPT3 ?¨ê³„ë¡??´ë™...');
        gotoStep(PipelineStep.GPT3);
          
        // ?¤ë¥¸ìª??¨ë„??GPT3 ì¹´ë“œ?¤ì—???œê°???¨ê³¼ ì¶”ê?
        console.log('?¨ ?œê°???¨ê³¼ ì¶”ê?...');
        document.querySelectorAll('.gpt3-module-box').forEach(el => {
          el.classList.add('pipeline-executing');
        });
        
        console.log('?“š ??•  ë¡œë”© ì¤?..');
        const roles = await loadRiskAgentRoles();
        console.log('????•  ë¡œë”© ?„ë£Œ:', Object.keys(roles));
        // ?¬ìš©?ê? ?„ë¡¬?„íŠ¸ë¥??˜ì •?ˆë‹¤ë©??´ë‹¹ ê°’ìœ¼ë¡???–´?°ê¸°
        const uiGpt1 = document.getElementById('gpt1-system')?.value?.trim();
        const uiGpt2 = document.getElementById('gpt2-system')?.value?.trim();
        if (uiGpt1) roles.gpt1 = uiGpt1;
        if (uiGpt2) roles.gpt2 = uiGpt2;
        // GPT1 ì¶œë ¥ ë³´ì¥ ê°€???ìš©
        console.log('?” GPT1 ì¶œë ¥ ?•ì¸ ì¤?..');
        const gpt1Output = await ensureGpt1OutputReady();
        console.log('??GPT1 ì¶œë ¥ ì¤€ë¹??„ë£Œ, ê¸¸ì´:', gpt1Output?.length || 0);
        
        // GPT2 ?„ë©”?¸ë³„ ë¶„ì„ ?ë£Œê°€ ?†ìœ¼ë©??ˆë¡œ ?ì„±
        let gpt2DomainOutputs;
        const existingGpt2Output = document.getElementById('gpt2-output').value || '';
        if (!existingGpt2Output.includes('=== ê·¹í•œ ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ?°ì¶œ) ===')) {
          status.textContent = '?ì¥?°ì´?°ì…??ë°??œë‚˜ë¦¬ì˜¤ ë¶„ì„ì¤?..';
          gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
          
          // GPT2 ?„ë©”??ê²°ê³¼ë¥??„ì—­ ë³€?˜ë¡œ ?€??(GPT4?ì„œ ì°¸ì¡°??
          window.globalGpt2DomainOutputs = gpt2DomainOutputs;
          
          const gpt2Detail = `=== ê·¹í•œ ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ?°ì¶œ) ===

[?œì¥ë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.market || '(?ì„±?¤íŒ¨)'}

[? ìš©ë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.credit || '(?ì„±?¤íŒ¨)'}

[ALM?€]
${gpt2DomainOutputs.alm || '(?ì„±?¤íŒ¨)'}

[ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.global || '(?ì„±?¤íŒ¨)'}

[? ìš©?¬íŠ¸?´ë¦¬?¤í?]
${gpt2DomainOutputs.creditpf || '(?ì„±?¤íŒ¨)'}
`;
          
          document.getElementById('gpt2-output').value = gpt2Detail;
          autoGrow(['gpt2-output']);
          // ?¤í¬ë¡¤ì„ GPT2 ì¹´ë“œë¡??´ë™
          setTimeout(() => scrollToElement('card-gpt2'), 100);
        } else {
          // ê¸°ì¡´ GPT2 ?„ë©”??ì¶œë ¥???ˆë‹¤ë©??¬ì‚¬??(?¤ì œë¡œëŠ” ?ˆë¡œ ?ì„±?´ì•¼ ?˜ì?ë§??°ëª¨??
          status.textContent = 'GPT2 ?„ë©”?¸ë³„ ë¶„ì„ ?ë£Œ ?¬ìƒ??ì¤?..';
          gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
          // GPT2 ?„ë©”??ê²°ê³¼ë¥??„ì—­ ë³€?˜ë¡œ ?€??(GPT4?ì„œ ì°¸ì¡°??
          window.globalGpt2DomainOutputs = gpt2DomainOutputs;
        }
        
        status.textContent = 'GPT3 ?„ë©”???ì´?„íŠ¸ ì²˜ë¦¬ ì¤?';
        // ?”” GPT3 ?œì‘ ?´ë²¤???”ìŠ¤?¨ì¹˜ (?¨ê³¼ ?œì‘ ?¸ë¦¬ê±?
        window.dispatchEvent(new CustomEvent('gpt3:start'));
        // ì¹´ë“œ/ë°•ìŠ¤ ì§„í–‰ ?íƒœ ?œì‹œ
        const c3 = document.getElementById('card-gpt3');
        c3?.classList.add('running'); 
        c3?.classList.remove('done');
        document.querySelectorAll('.gpt3-module-box')
          .forEach(el => el.classList.add('pipeline-executing'));
        const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€?´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
        console.log('?? GPT3 API ?¸ì¶œ ì¤€ë¹?..');
        console.log('GPT2 ?„ë©”??ì¶œë ¥ ê¸¸ì´:', {
          market: gpt2DomainOutputs.market?.length || 0,
          credit: gpt2DomainOutputs.credit?.length || 0,
          alm: gpt2DomainOutputs.alm?.length || 0,
          global: gpt2DomainOutputs.global?.length || 0,
          creditpf: gpt2DomainOutputs.creditpf?.length || 0
        });
        
        const g3Calls = [
          callOpenAIWithOptions(roles.gpt3_market, gpt2DomainOutputs.market + GL('market'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_credit, gpt2DomainOutputs.credit + GL('credit'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_alm, gpt2DomainOutputs.alm + GL('alm'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_global, gpt2DomainOutputs.global + GL('global'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_creditpf, gpt2DomainOutputs.creditpf + GL('creditpf'), { timeoutMs: 1200000 }),
        ];
        // ??ê±°ë? ì¼€?´ìŠ¤???ëŸ¬ ë©”ì‹œì§€ë¡??¸ì¶œ?˜ì—¬ ?”ë²„ê¹?ê°€?¥í•˜ê²?ë³€ê²?
        console.log('??GPT3 API ?¸ì¶œ ?€ê¸?ì¤?..');
        const settled = await Promise.allSettled(g3Calls);
        console.log('??GPT3 API ?¸ì¶œ ?„ë£Œ, ê²°ê³¼:', settled.map(r => r.status));
        
        const pick = (r) => r.status === 'fulfilled'
          ? (r.value || '')
          : (`?¤ë¥˜: ${r.reason?.message || '?„ë¡???¸ì¶œ ?¤íŒ¨'}`);
        const [m,c,a,g,p] = settled.map(pick);
        
        console.log('?“Š GPT3 ê²°ê³¼ ê¸¸ì´:', {
          market: m?.length || 0,
          credit: c?.length || 0,
          alm: a?.length || 0,
          global: g?.length || 0,
          creditpf: p?.length || 0
        });
        
        // ?”§ ?„ì—­ ë³‘í•© ?¤í? ?˜ì • + DOM ì§ì ‘ ë°˜ì˜(??ƒ ê°?ê¸°ë¡)
        window.globalGpt3Outputs = {
          ...(window.globalGpt3Outputs || {}),
          market: (m || '').trim(),
          credit: (c || '').trim(),
          alm:    (a || '').trim(),
          global: (g || '').trim(),
          creditpf:(p || '').trim()
        };

        // DOM????ƒ ê¸°ë¡(ë¹?ë¬¸ì?´ë„ ê·¸ë?ë¡?ë°˜ì˜?˜ì—¬ ?¤ì œ ?íƒœë¥??ˆìœ¼ë¡??•ì¸ ê°€??
        const writeG3 = (id, text, label) => {
          const el = document.getElementById(id);
          const v = (text || '').trim();
          // ë¹„ì–´?ˆìœ¼ë©?"ê°€?œì ???ˆë‚´ ë¬¸êµ¬"ë¥??£ì–´ ?¬ìš©?ì—ê²??íƒœê°€ ë³´ì´ê²??œë‹¤.
          el.value = v || `? ï¸ ${label} ê²°ê³¼ ?†ìŒ(?„ë¡??ë¯¸ì‘??ë¹??‘ë‹µ ê°€??.
- ?°ì¸¡ ?ë‹¨ ?”ë³´ê¸?> ì½˜ì†”?ì„œ testOpenAIProxy() ?¤í–‰?¼ë¡œ ?„ë¡???íƒœ ?ê?
- ë¡œì»¬ ?ŒìŠ¤???? localStorage.setItem('openai_api_key','sk-...') ???ˆë¡œê³ ì¹¨`;
        };
        writeG3('gpt3-market',   m, '?œì¥ë¦¬ìŠ¤??);
        writeG3('gpt3-credit',   c, '? ìš©ë¦¬ìŠ¤??);
        writeG3('gpt3-alm',      a, 'ALM');
        writeG3('gpt3-global',   g, 'ê¸€ë¡œë²Œë¦¬ìŠ¤??);
        writeG3('gpt3-creditpf', p, '? ìš©?¬íŠ¸?´ë¦¬??);

        autoGrow(['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf']); 
        
        // GPT3 ëª¨ë“ˆë³??œì°¨ ?¤í¬ë¡?(ê°?ëª¨ë“ˆ ?„ë£Œ ???´ë‹¹ ëª¨ë“ˆë¡??¤í¬ë¡?
        setTimeout(() => {
          if (m) scrollToGpt3Module('market');
          setTimeout(() => { if (c) scrollToGpt3Module('credit'); }, 300);
          setTimeout(() => { if (a) scrollToGpt3Module('alm'); }, 600);
          setTimeout(() => { if (g) scrollToGpt3Module('global'); }, 900);
          setTimeout(() => { if (p) scrollToGpt3Module('creditpf'); }, 1200);
        }, 200);
        
        status.textContent = (m||c||a||g||p) ? 'GPT3 ?„ì²´ ?„ë£Œ' : 'GPT3 ?¤íŒ¨(ì¶œë ¥ ?†ìŒ)';
      } catch(e) { 
        status.textContent = `?¤íŒ¨: ${e.message}`; 
      } finally {
        // ???´ë–¤ ê²½ìš°?ë„ ?¨ê³¼ ì¢…ë£Œ + done ?´ë²¤??ë³´ì¥
        (function cleanupGpt3Effects(){
          const card = document.getElementById('card-gpt3');
          if (card) {
            card.classList.remove('progress-indicator','running');
            card.classList.add('done');
            const overlay = card.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          document.querySelectorAll('.gpt3-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
        })();
        window.dispatchEvent(new CustomEvent('gpt3:done'));
      }
    }

    // ====== GPT1 ì¶œë ¥ ë³´ì¥ ê°€??======
    async function ensureGpt1OutputReady() {
      let gpt1Output = document.getElementById('gpt1-output').value?.trim() || '';
      
      // 1) gpt1-output ë¹„ì–´ ?ˆìœ¼ë©? ?°ì„  GPT1???¤í–‰??ê°•ì œë¡?ì±„ì?
      if (!gpt1Output) {
        console.log('GPT1 ì¶œë ¥??ë¹„ì–´?ˆì–´ GPT1???¤í–‰?©ë‹ˆ??..');
        const gpt1Input = buildGpt1InputFromGpt0Outputs();
        const roles = await loadRiskAgentRoles();
        const gpt1Result = await callOpenAI(roles.gpt1, gpt1Input);
        document.getElementById('gpt1-output').value = gpt1Result || '';
        autoGrow(['gpt1-output']);
        // ?¤í¬ë¡¤ì„ GPT1 ì¹´ë“œë¡??´ë™
        setTimeout(() => scrollToElement('card-gpt1'), 100);
        gpt1Output = gpt1Result || '';
      }
      
      // 2) (ì¶”ê? ?ˆì „?¥ì¹˜) ê·¸ë˜??ë¹„ì–´ ?ˆìœ¼ë©??¨ì? ?”ì•½??ìµœí›„ fallback?¼ë¡œ ?¬ìš©
      if (!gpt1Output) {
        gpt1Output = document.getElementById('gpt1-generated-summary')?.value?.trim() || '';
        if (gpt1Output) {
          console.log('GPT1 ì¶œë ¥???¬ì „??ë¹„ì–´?ˆì–´ gpt1-generated-summaryë¥?fallback?¼ë¡œ ?¬ìš©?©ë‹ˆ??');
          document.getElementById('gpt1-output').value = gpt1Output;
          autoGrow(['gpt1-output']);
          // ?¤í¬ë¡¤ì„ GPT1 ì¹´ë“œë¡??´ë™
          setTimeout(() => scrollToElement('card-gpt1'), 100);
        }
      }
      
      updateGpt2ButtonState(); // UI ?íƒœ ?…ë°?´íŠ¸
      return gpt1Output;
    }

    // ====== UI ?íƒœ ?…ë°?´íŠ¸ ======
    function updateGpt2ButtonState() {
      const gpt1Output = document.getElementById('gpt1-output').value?.trim();
      const gpt2Button = document.getElementById('gpt2-run-btn');
      
      if (gpt2Button) {
        if (!gpt1Output) {
          gpt2Button.disabled = true;
          gpt2Button.style.opacity = '0.5';
          gpt2Button.title = 'GPT1??ë¨¼ì? ?¤í–‰?´ì£¼?¸ìš”';
        } else {
          gpt2Button.disabled = false;
          gpt2Button.style.opacity = '1';
          gpt2Button.title = 'GPT2 ?¤í–‰';
        }
      }
    }

    // ====== GPT2 ?„ë©”?¸ë³„ ì¶œë ¥ ?ì„± ======
    async function generateGpt2DomainOutputs(gpt1Output, roles) {
      try {
        // ë°©ì–´ ë¡œì§: gpt1Output??ë¹„ì–´?ˆìœ¼ë©??€??ì°¾ê¸°
        if (!gpt1Output?.trim()) {
          console.log('generateGpt2DomainOutputs: gpt1Output??ë¹„ì–´?ˆì–´ ?€?ˆì„ ì°¾ìŠµ?ˆë‹¤...');
          gpt1Output = document.getElementById('gpt1-output')?.value?.trim()
                    || document.getElementById('gpt1-generated-summary')?.value?.trim()
                    || '(ê²½ê³ : GPT1 ì¶œë ¥??ë¹„ì–´?ˆìŠµ?ˆë‹¤)';
        }
        
        const basePrompt = `[GPT1 ì¢…í•© ?•ì œ ê²°ê³¼]
${gpt1Output}

[WORST ?œë‚˜ë¦¬ì˜¤ ?ì„± ?”ì²­]
ë¨¼ì? ?¤ìŒ 4ê°?ë¶„ì•¼??WORST ?œë‚˜ë¦¬ì˜¤ë¥?êµ¬ì²´?ìœ¼ë¡??ì„±?˜ë¼:
1) ê¸ˆë¦¬ WORST: ê¸‰ê²©??ê¸ˆë¦¬ ?ìŠ¹/?˜ë½ ?œë‚˜ë¦¬ì˜¤ (êµ¬ì²´???˜ì¹˜ ?¬í•¨)
2) ?˜ìœ¨ WORST: ê·¹ë‹¨???˜ìœ¨ ë³€???œë‚˜ë¦¬ì˜¤ (???¬ëŸ¬, ì£¼ìš” ?µí™”)
3) ? ìš©?„í—˜ WORST: ?€ê·œëª¨ ? ìš©ê²½ìƒ‰ ë°?ë¶€??ê¸‰ì¦ ?œë‚˜ë¦¬ì˜¤
4) ì£¼ê?ì§€??WORST: ì£¼ì‹?œì¥ ??½ ?œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤?? ê¸€ë¡œë²Œ ì§€??

[?„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„±]
??WORST ?œë‚˜ë¦¬ì˜¤ë¥??¬í•¨?˜ì—¬ ?¤ìŒ ?„ë©”?¸ì— ?¹í™”??ë¶„ì„ ?ë£Œë¥??ì„±?˜ë¼:`;

        // ê°??„ë©”?¸ë³„ ?„ë¡¬?„íŠ¸ ?ì„±
        const domainPrompts = {
          market: `${basePrompt}

[?œì¥ë¦¬ìŠ¤?¬í? ?„ìš© ?ë£Œ]
- ê¸ˆë¦¬/?˜ìœ¨/ì£¼ê? WORST ?œë‚˜ë¦¬ì˜¤???œì¥ë¦¬ìŠ¤??ê´€??ë¶„ì„
- VaR, ë¯¼ê°?? ë³€?™ì„± ëª¨ë¸ë§ì„ ?„í•œ êµ¬ì²´???Œë¼ë¯¸í„°
- ?œì¥ ì¶©ê²©???¬íŠ¸?´ë¦¬?¤ì— ë¯¸ì¹˜???í–¥ ?œë??ˆì´???ë£Œ
- ?¤ì§• ?„ëµ ë°?ë¦¬ìŠ¤???œë„ ê´€ë¦?ë°©ì•ˆ`,

          credit: `${basePrompt}

[? ìš©ë¦¬ìŠ¤?¬í? ?„ìš© ?ë£Œ]  
- ? ìš©?„í—˜ WORST ?œë‚˜ë¦¬ì˜¤???¬íŠ¸?´ë¦¬???í–¥ ë¶„ì„
- ?¹í„°ë³??±ê¸‰ë³?ë¶€?„í™•ë¥?ë°??ì‹¤??ì¶”ì • ?ë£Œ
- ? ìš©?¤í”„?ˆë“œ ?•ë? ë°??„ë¡œë¹„ì „ ?°ì • ê¸°ì?
- ? ìš©ì§‘ì¤‘??ë¦¬ìŠ¤??ë°??€?•ì°¨ì£?ëª¨ë‹ˆ?°ë§ ì§€??,

          alm: `${basePrompt}

[ALM?€ ?„ìš© ?ë£Œ]
- ê¸ˆë¦¬ WORST ?œë‚˜ë¦¬ì˜¤???ì‚°ë¶€ì±??€?ˆì´??ë¶„ì„
- ? ë™??ê°?ë°??ê¸ˆì¡°ë‹¬ ë¹„ìš© ?í–¥ ?‰ê? ?ë£Œ  
- ê¸ˆë¦¬ë¯¼ê°??ë°?? ë™?±ì»¤ë²„ë¦¬ì§€ ë³€???œë??ˆì´??
- ?ì‚°ë°°ë¶„ ìµœì ??ë°?ALM ?„ëµ ì¡°ì • ë°©ì•ˆ`,

          global: `${basePrompt}

[ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í? ?„ìš© ?ë£Œ]
- ?˜ìœ¨ WORST ?œë‚˜ë¦¬ì˜¤??ê¸€ë¡œë²Œ ?¬íŠ¸?´ë¦¬???í–¥
- êµ??ë³?ì§€??³„ ë¦¬ìŠ¤???„íŒŒ ë©”ì»¤?ˆì¦˜ ë¶„ì„
- ê¸€ë¡œë²Œ ê¸ˆìœµ?œì¥ ?°ì‡„ë°˜ì‘ ë°?ì»¨í…Œ?´ì ¼ ë¦¬ìŠ¤??
- ?´ì™¸ ?µìŠ¤?¬ì? ?¤ì§• ë°?êµ??ë¦¬ìŠ¤??ê´€ë¦?ë°©ì•ˆ`,

          creditpf: `${basePrompt}

[? ìš©?¬íŠ¸?´ë¦¬?¤í? ?„ìš© ?ë£Œ]
- ? ìš©?„í—˜/ì£¼ê? WORST ?œë‚˜ë¦¬ì˜¤???¬íŠ¸?´ë¦¬??ì§‘ì¤‘??ë¶„ì„
- ?°ì—…ë³?ì§€??³„/ë§Œê¸°ë³??µìŠ¤?¬ì? ë¶„ì‚° ?¨ê³¼ ?‰ê?
- ?¬íŠ¸?´ë¦¬???¬êµ¬??ë°?ìµœì ???œë??ˆì´???ë£Œ
- ?€?•ì°¨ì£?ë°??°ê?ê±°ë˜ ë¦¬ìŠ¤??ê´€ë¦?ë°©ì•ˆ`
        };

        // ê³ ì •??GPT2 ?œìŠ¤???„ë¡¬?„íŠ¸ ?¬ìš©
        const gpt2SystemPrompt = `?¹ì‹ ?€ GPT1?ì„œ ?•ì œ???µí•© ?°ì´?°ë? ë°”íƒ•?¼ë¡œ ê°?GPT3 ëª¨ë“ˆë³?ë§ì¶¤??ë¶„ì„ ?ë£Œë¥??ì„±?˜ëŠ” ?„ë¬¸ê°€?…ë‹ˆ??

??• :
- GPT1???µí•©???œë‚˜ë¦¬ì˜¤ ë°?ë§ˆì¼“?°ì´?°ë? ê°?GPT3 ëª¨ë“ˆ???¹ì„±??ë§ê²Œ ë¶„ë°°
- ê°??„ë©”?¸ë³„ WORST ?œë‚˜ë¦¬ì˜¤ êµ¬ì²´???ì„± (ê¸ˆë¦¬, ?˜ìœ¨, ? ìš©?„í—˜, ì£¼ê?ì§€??
- GPT3 ëª¨ë“ˆë³??„ë¬¸?”ëœ ?…ë ¥ ?°ì´??êµ¬ì„±
- ?„ê¸°?í™© ?œë??ˆì´?˜ì„ ?„í•œ ê°€?•ê³¼ ?œë‚˜ë¦¬ì˜¤ ?„ê°œ

?„ë©”?¸ë³„ ë¶„ì„ ?”êµ¬?¬í•­:

1. ?œì¥ë¦¬ìŠ¤?¬í? (GPT3_market)
   - ê¸ˆë¦¬ ë³€?™ì„±, ?˜ìœ¨ ë³€?™ì„±, ì£¼ê? ë³€?™ì„± ê´€??WORST ?œë‚˜ë¦¬ì˜¤
   - ?œì¥ ì¶©ê²©???„íŒŒ ê²½ë¡œ?€ ?í–¥??ë¶„ì„
   - ?¤ì? ?„ëµ ë°?ë¦¬ìŠ¤??ê´€ë¦?ë°©ì•ˆ ?œì‹œ

2. ? ìš©ë¦¬ìŠ¤?¬í? (GPT3_credit)
   - ê¸°ì—… ? ìš©???˜ë½, ì±„ê¶Œ ?¤í”„?ˆë“œ ?•ë?, ë¶€?„ìœ¨ ?ìŠ¹ WORST ?œë‚˜ë¦¬ì˜¤
   - ? ìš© ?„í—˜???„íŒŒ ë©”ì»¤?ˆì¦˜ê³??¬íŠ¸?´ë¦¬???í–¥??
   - ? ìš© ?„í—˜ ëª¨ë‹ˆ?°ë§ ë°??€??ë°©ì•ˆ

3. ALM?€ (GPT3_alm)
   - ?ì‚°ë¶€ì±?ë§Œê¸° ë¶ˆì¼ì¹? ? ë™???„í—˜, ?´ì??ë¦¬ìŠ¤??WORST ?œë‚˜ë¦¬ì˜¤
   - ?ê¸ˆ ì¡°ë‹¬ ë°??´ìš© ?„ëµ???„í—˜ ?”ì†Œ
   - ALM ?„í—˜ ê´€ë¦?ë°??€??ë°©ì•ˆ

4. ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í? (GPT3_global)
   - êµ?? ë¦¬ìŠ¤?? ?•ì¹˜??ë¶ˆì•ˆ?•ì„±, êµ? œ ê´€ê³??…í™” WORST ?œë‚˜ë¦¬ì˜¤
   - ê¸€ë¡œë²Œ ?„í—˜??êµ?‚´ ?„íŒŒ ê²½ë¡œ?€ ?í–¥??
   - ê¸€ë¡œë²Œ ë¦¬ìŠ¤???€??ë°??¤ì? ?„ëµ

5. ? ìš©?¬íŠ¸?´ë¦¬?¤í? (GPT3_creditpf)
   - ?¬íŠ¸?´ë¦¬??ì§‘ì¤‘???„í—˜, ?ê?ê´€ê³?ê¸‰ì¦, ë¶„ì‚° ?¨ê³¼ ?ì‹¤ WORST ?œë‚˜ë¦¬ì˜¤
   - ?¬íŠ¸?´ë¦¬??ë¦¬ìŠ¤?¬ì˜ ì§‘ì¤‘ê³??„íŒŒ
   - ?¬íŠ¸?´ë¦¬??ë¦¬ìŠ¤??ê´€ë¦?ë°?ìµœì ??ë°©ì•ˆ

ì¶œë ¥ ?•ì‹:
ê°??„ë©”?¸ë³„ë¡??¤ìŒ???¬í•¨:
- WORST ?œë‚˜ë¦¬ì˜¤ êµ¬ì²´???˜ì¹˜ ë°?ê°€??
- ?œë‚˜ë¦¬ì˜¤ ?„ê°œ ê²½ë¡œ?€ ?í–¥??ë¶„ì„
- GPT3 ëª¨ë“ˆë³?ë§ì¶¤???…ë ¥ ?°ì´??
- ?„ê¸°?í™© ?œë??ˆì´?˜ì„ ?„í•œ ?µì‹¬ ë³€??

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        // ê°??„ë©”?¸ë³„ ë³‘ë ¬ ?¸ì¶œ (?¬ì‹œ??ë¡œì§ ?¬í•¨)
        const domainCalls = [
          callOpenAI(gpt2SystemPrompt, domainPrompts.market).catch(e => {
            console.warn('? ï¸ ?œì¥ë¦¬ìŠ¤???„ë©”??1ì°??¤íŒ¨, ?¬ì‹œ??..', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.market);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.credit).catch(e => {
            console.warn('? ï¸ ? ìš©ë¦¬ìŠ¤???„ë©”??1ì°??¤íŒ¨, ?¬ì‹œ??..', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.credit);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.alm).catch(e => {
            console.warn('? ï¸ ALM ?„ë©”??1ì°??¤íŒ¨, ?¬ì‹œ??..', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.alm);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.global).catch(e => {
            console.warn('? ï¸ ê¸€ë¡œë²Œë¦¬ìŠ¤???„ë©”??1ì°??¤íŒ¨, ?¬ì‹œ??..', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.global);
          }),
          callOpenAI(gpt2SystemPrompt, domainPrompts.creditpf).catch(e => {
            console.warn('? ï¸ ? ìš©?¬íŠ¸?´ë¦¬???„ë©”??1ì°??¤íŒ¨, ?¬ì‹œ??..', e.message);
            return callOpenAI(gpt2SystemPrompt, domainPrompts.creditpf);
          })
        ];

        const results = await Promise.allSettled(domainCalls);
        const [marketOutput, creditOutput, almOutput, globalOutput, creditpfOutput] = 
          results.map((r, index) => {
            if (r.status === 'fulfilled' && r.value) {
              return r.value;
            } else {
              const domainNames = ['?œì¥ë¦¬ìŠ¤??, '? ìš©ë¦¬ìŠ¤??, 'ALM', 'ê¸€ë¡œë²Œë¦¬ìŠ¤??, '? ìš©?¬íŠ¸?´ë¦¬??];
              const errorMsg = r.reason?.message || '?????†ëŠ” ?¤ë¥˜';
              console.error(`??GPT2 ${domainNames[index]} ?„ë©”???ì„± ?¤íŒ¨:`, errorMsg);
              return `[${domainNames[index]}?€] ë¶„ì„ ?ë£Œ ?ì„± ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.\n\n?¤ë¥˜ ?´ìš©: ${errorMsg}\n\n?€?? GPT1 ì¶œë ¥??ê¸°ë°˜?¼ë¡œ ê¸°ë³¸ ë¶„ì„???˜í–‰?˜ê±°?? ?¤íŠ¸?Œí¬ ?°ê²° ?íƒœë¥??•ì¸ ???¤ì‹œ ?œë„?´ì£¼?¸ìš”.`;
            }
          });

        return {
          market: marketOutput,
          credit: creditOutput,
          alm: almOutput,
          global: globalOutput,
          creditpf: creditpfOutput
        };

      } catch (error) {
        console.error('GPT2 ?„ë©”?¸ë³„ ì¶œë ¥ ?ì„± ?¤ë¥˜:', error);
        return {
          market: '?¤ë¥˜: ?œì¥ë¦¬ìŠ¤??ë¶„ì„ ?ë£Œ ?ì„± ?¤íŒ¨',
          credit: '?¤ë¥˜: ? ìš©ë¦¬ìŠ¤??ë¶„ì„ ?ë£Œ ?ì„± ?¤íŒ¨',
          alm: '?¤ë¥˜: ALM ë¶„ì„ ?ë£Œ ?ì„± ?¤íŒ¨',
          global: '?¤ë¥˜: ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ?ë£Œ ?ì„± ?¤íŒ¨',
          creditpf: '?¤ë¥˜: ? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ?ë£Œ ?ì„± ?¤íŒ¨'
        };
      }
    }

    // ====== GPT0 ì¶œë ¥??APIë¡??”ì•½?˜ì—¬ GPT1??A4 ?????ì„± ======
    async function generateGpt1SummaryFromGpt0(roles) {
      try {
        console.log('?“‹ GPT0 ??GPT1 ?”ì•½ ?ì„± ?œì‘');
        
        // GPT0 ê°?ëª¨ë“ˆ ì¶œë ¥ ?˜ì§‘
        const gpt0MarketData = document.getElementById('gpt0-marketdata')?.value?.trim() || '';
        const gpt0News = document.getElementById('gpt0-news')?.value?.trim() || '';
        const gpt0ScenarioSummary = document.getElementById('gpt0-scenario-summary')?.value?.trim() || '';
        const gpt0MarketState = document.getElementById('gpt0-marketstate')?.value?.trim() || '';
        
        // ?œë‚˜ë¦¬ì˜¤ ê¸°ë³¸ ?•ë³´
        const selectedScenario = selectedScenarioForGPT || scenarioList[0] || 1;
        const scenarioName = document.getElementById('selected-scenario-name')?.textContent?.trim() || `?œë‚˜ë¦¬ì˜¤ ${selectedScenario}`;
        
        // GPT1??A4 ?”ì•½ ?ì„± ?„ë¡¬?„íŠ¸ (GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„± ìµœì ??
        const summaryPrompt = `?¤ìŒ GPT0 ë¶„ì„ ê²°ê³¼?¤ì„ GPT1??GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•´ ì²˜ë¦¬?????ˆë„ë¡?A4 ????ë¶„ëŸ‰(??800-1000???¼ë¡œ ?”ì•½?˜ë¼:

=== ?œë‚˜ë¦¬ì˜¤ ?•ë³´ ===
?œë‚˜ë¦¬ì˜¤: ${scenarioName} (${selectedScenario})

=== GPT0 ë¶„ì„ ê²°ê³¼ ===

## 1. ?œì¥?°ì´??ë¶„ì„
${gpt0MarketData || 'ë¶„ì„ ?°ì´???†ìŒ'}

## 2. ?´ìŠ¤ ë°?ë¦¬ìŠ¤??ë¶„ì„
${gpt0News || 'ë¶„ì„ ?°ì´???†ìŒ'}

## 3. ?œë‚˜ë¦¬ì˜¤ ?ì„¸ ë¶„ì„
${gpt0ScenarioSummary || 'ë¶„ì„ ?°ì´???†ìŒ'}

## 4. ?„ì¬ ?œì¥ ?í™©
${gpt0MarketState || 'ë¶„ì„ ?°ì´???†ìŒ'}

=== GPT1??A4 ?”ì•½ ?‘ì„± ì§€ì¹?===

GPT2ê°€ WORST ?œë‚˜ë¦¬ì˜¤ë¥??ì„±?????ˆë„ë¡??¤ìŒ ?•ì‹?¼ë¡œ ?•í™•??800-1000???´ì—???‘ì„±?˜ë¼:

**[?œë‚˜ë¦¬ì˜¤ ê¸°ë³¸?•ë³´]** (100??
- ?œë‚˜ë¦¬ì˜¤ëª? ?µì‹¬ ê°€?? ë°œìƒ ?•ë¥ 

**[WORST ?œë‚˜ë¦¬ì˜¤ ê¸°ì´ˆ ?°ì´??** (300??
- ê¸ˆë¦¬ WORST: ê¸‰ê²©???ìŠ¹/?˜ë½ ê·¼ê±° ë°?êµ¬ì²´???˜ì¹˜ ë²”ìœ„
- ?˜ìœ¨ WORST: ê·¹ë‹¨??ë³€???”ì¸ (???¬ëŸ¬, ì£¼ìš” ?µí™” ë³€?™í­)
- ? ìš©?„í—˜ WORST: ?€ê·œëª¨ ? ìš©ê²½ìƒ‰ ë°?ë¶€??ê¸‰ì¦ ?¸ë¦¬ê±?
- ì£¼ê?ì§€??WORST: ì£¼ì‹?œì¥ ??½ ?œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤?? ê¸€ë¡œë²Œ)

**[?„ë©”?¸ë³„ ?µì‹¬ ?Œë¼ë¯¸í„°]** (300??
- ?œì¥ë¦¬ìŠ¤?? VaR, ë¯¼ê°?? ë³€?™ì„± ëª¨ë¸ë§??˜ì¹˜
- ? ìš©ë¦¬ìŠ¤?? ?¹í„°ë³??±ê¸‰ë³?ë¶€?„í™•ë¥?ë°??¤í”„?ˆë“œ ?°ì´??
- ALM: ?€?ˆì´??ë¶„ì„, ? ë™??ê°? ?ê¸ˆì¡°ë‹¬ ë¹„ìš© ?í–¥
- ê¸€ë¡œë²Œ: êµ??ë¦¬ìŠ¤???‰ê?, ?•ì¹˜/ê²½ì œ ë¶ˆì•ˆ?•ì„± ?”ì¸
- ?¬íŠ¸?´ë¦¬?? ì§‘ì¤‘?? ?ê?ê´€ê³? ë¶„ì‚°?¨ê³¼ ë¶„ì„

**[?„ì¬ ?œí™© ?°ê???** (100??
- ?„ì¬ ?œì¥ê³?WORST ?œë‚˜ë¦¬ì˜¤ ?°ê²°??
- ì¡°ê¸°ê²½ë³´ ì§€??ë°?ëª¨ë‹ˆ?°ë§ ?¬ì¸??

**[GPT2 ë¶„ë°° ì§€ì¹?** (100??
- ê°??„ë©”?¸ë³„ WORST ?œë‚˜ë¦¬ì˜¤ ?ì„± ?°ì„ ?œìœ„
- ë§ì¶¤??ë¶„ì„ ?ë£Œ ?ì„± ë°©í–¥

??ë°˜ë“œ??GPT2ê°€ ?œìš©?????ˆëŠ” êµ¬ì²´???˜ì¹˜?€ ?Œë¼ë¯¸í„° ?¬í•¨
??ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        // API ?¸ì¶œ?˜ì—¬ ?”ì•½ ?ì„± (GPT1 role ?¬ìš© ?ëŠ” ë²”ìš© ?„ë¡¬?„íŠ¸)
        const gpt1Role = roles?.gpt1 || roles?.gpt0_marketdata || 'You are a financial risk analyst creating executive summaries.';
        const gpt1Summary = await callOpenAI(gpt1Role, summaryPrompt);
        
        console.log(`??GPT1 ?”ì•½ ?ì„± ?„ë£Œ: ${gpt1Summary?.length || 0}??);
        return gpt1Summary || '?”ì•½ ?ì„± ?¤íŒ¨';
        
      } catch (error) {
        console.error('??GPT1 ?”ì•½ ?ì„± ?¤ë¥˜:', error);
        return '?¤ë¥˜: GPT0 ì¶œë ¥??GPT1?©ìœ¼ë¡??”ì•½?????†ìŠµ?ˆë‹¤.';
      }
    }

    // ====== GPT1 ?…ë ¥ êµ¬ì„± (API ê¸°ë°˜) ======
    function buildGpt1InputFromGpt0Outputs() {
      // ???¨ìˆ˜???´ì œ generateGpt1SummaryFromGpt0?ì„œ ?ì„±???”ì•½??ë°˜í™˜
      // ?¤ì œ ?”ì•½ ?ì„±?€ runGpt0All ?¨ìˆ˜?ì„œ ?˜í–‰??
      const gpt1Summary = document.getElementById('gpt1-generated-summary')?.value?.trim();
      return gpt1Summary || 'GPT1 ?”ì•½???„ì§ ?ì„±?˜ì? ?Šì•˜?µë‹ˆ??';
    }

    // GPT0 ?„ì²´ ?¤í–‰ (?¬ì „?˜ì§‘)
    async function runGpt0All(){
      const status = document.getElementById('send-status');
      const card = document.getElementById('card-gpt0');
      try{
        // API ???¬ì „ ê²€ì¦?
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = '??API ?¤ê? ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ??';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = 'GPT0 ?¬ì „?˜ì§‘ ?¤í–‰ ì¤?..'; status.classList.add('status-shine');
        card?.classList.add('running'); card?.classList.remove('done');
        // GPT0 ?œì‘ ?œì ?ë§Œ GPT0ë¡??´ë™
        gotoStep(PipelineStep.GPT0);
          
        // ?¤ë¥¸ìª??¨ë„??GPT0 ì¹´ë“œ?¤ì—???œê°???¨ê³¼ ì¶”ê?
        document.querySelectorAll('.gpt0-module-box').forEach(el => {
          el.classList.add('pipeline-executing');
        });
        
        // GPT0 ëª¨ë“ˆ ë°•ìŠ¤?¤ì— ?¤í–‰ ?¨ê³¼ ?ìš©
        document.getElementById('gpt0-marketdata-box')?.classList.add('running');
        document.getElementById('gpt0-news-box')?.classList.add('running');
        document.getElementById('gpt0-scenario-summary-box')?.classList.add('running');
        document.getElementById('gpt0-marketstate-box')?.classList.add('running');

        const roles = await loadRiskAgentRoles();

        // 1) ?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´???œê³„???”ì•½/ë³€?™ì„± (GPT4 ì§ì ‘ ?¬ìš© ?•ì‹)
        const scenNum = selectedScenarioForGPT != null ? selectedScenarioForGPT : scenarioList[0];
        console.log(`?¯ GPT0 ?¤í–‰ - ? íƒ???œë‚˜ë¦¬ì˜¤: ${scenNum}`);
        console.log(`?¯ selectedScenarioForGPT: ${selectedScenarioForGPT}`);
        console.log(`?¯ scenarioList[0]: ${scenarioList[0]}`);
        
        const marketTimeseriesText = await buildScenarioMarketTimeseriesText(scenNum);
        const mdPrompt = `${marketTimeseriesText}

[GPT4 ë³´ê³ ?œìš© ?œì¥?°ì´??ë¶„ì„ ?”ì²­]
???œê³„???°ì´?°ë? ë¶„ì„?˜ì—¬ ?¤ìŒ ?•ì‹?¼ë¡œ ?‘ì„±?˜ë¼:

## ?œì¥?°ì´??ë¶„ì„ ê²°ê³¼
### 1. ì£¼ìš” ë³€?™ì„± ì§€??
- [êµ¬ì²´?ì¸ ë³€?™ì„± ?˜ì¹˜?€ ?´ì„]

### 2. ?µì‹¬ ?¸ë Œ??ë¶„ì„  
- [?ìŠ¹/?˜ë½/?¡ë³´ ??ëª…í™•??ë°©í–¥??

### 3. êµ¬ê°„ë³??œì¥ ?ˆì§
- [ê°?ê¸°ê°„ë³??œì¥ ?¹ì„±ê³?ë¦¬ìŠ¤???˜ì?]

### 4. ?µì‹¬ ?”ì•½
- [?˜ì‚¬ê²°ì •???„ìš”??3-5ê°??µì‹¬ ?¬ì¸??

??ëª¨ë“  ?´ìš©?€ êµ¬ì²´???˜ì¹˜?€ ?¨ê»˜ ê¸ˆìœµê¸°ê? ?´ë‹¹?ê? ì¦‰ì‹œ ?´í•´?????ˆëŠ” ?•íƒœë¡??‘ì„±
???‘ë‹µ???˜ë¦¬ì§€ ?Šë„ë¡?ëª¨ë“  ?¹ì…˜???„ì „???‘ì„±?˜ì—¬ ?œê³µ`;
        const mdOut = await callOpenAI(roles.gpt0_marketdata, mdPrompt);
        const mdTextarea = document.getElementById('gpt0-marketdata');
        mdTextarea.value = mdOut || '';
        // ?ë™ ?’ì´ ì¡°ì •
        mdTextarea.style.height = 'auto';
        mdTextarea.style.height = mdTextarea.scrollHeight + 'px';
        // ?¤í¬ë¡¤ì„ ?´ë‹¹ ?„ì¹˜ë¡??´ë™
        setTimeout(() => scrollToElement('gpt0-marketdata-box'), 100);

        // 2) ê¸°ì‚¬?´ìŠ¤ ?”ì•½ ë¶„ì„ ë°??°ê³„??ë¶„ì„ (GPT4 ì§ì ‘ ?¬ìš© ?•ì‹)
        const newsCorpus = await buildScenarioNewsFullText(scenNum);
        const scenarioId = getScenarioIdFromNumber(scenNum);
        const newsPrompt = `?œë‚˜ë¦¬ì˜¤ ID: ${scenarioId}\n?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸: ${scenNum}\n\n[?´ìŠ¤ ?”ì•½ ëª¨ìŒ]\n${newsCorpus}

[GPT4 ë³´ê³ ?œìš© ?´ìŠ¤ ë¶„ì„ ?”ì²­]
???´ìŠ¤ ?”ì•½?¤ì„ ë¶„ì„?˜ì—¬ ?¤ìŒ ?•ì‹?¼ë¡œ ?‘ì„±?˜ë¼:

## ?´ìŠ¤ ë¶„ì„ ê²°ê³¼
### 1. ?œë‚˜ë¦¬ì˜¤ ?°ê????‰ê?
- [ê°??´ìŠ¤?€ ?œë‚˜ë¦¬ì˜¤??ì§ì ‘???°ê????ìˆ˜ ë°?ê·¼ê±°]

### 2. ì£¼ìš” ë¦¬ìŠ¤???¸ë¦¬ê±??ë³„
- [?´ìŠ¤?ì„œ ?Œì•…???µì‹¬ ë¦¬ìŠ¤???”ì¸ 3-5ê°?

### 3. ?œì¥ ?í–¥??ë¶„ì„
- [?¨ê¸°/ì¤‘ê¸°/?¥ê¸° ?œì¥ ?í–¥ ?„ë§]

### 4. ê¸ˆìœµê¸°ê? ?í–¥ ?‰ê?
- [?°ë¦¬ ê¸°ê???ë¯¸ì¹˜??êµ¬ì²´???í–¥ê³??€???„ìš”??

### 5. ?µì‹¬ ?œì‚¬??
- [?˜ì‚¬ê²°ì •???„í•œ ì¦‰ì‹œ ì¡°ì¹˜?¬í•­ ë°?ëª¨ë‹ˆ?°ë§ ?¬ì¸??

??ëª¨ë“  ë¶„ì„?€ êµ¬ì²´??ê·¼ê±°?€ ?¨ê»˜ ì¦‰ì‹œ ?¤í–‰ ê°€?¥í•œ ?¡ì…˜ ?„ì´???¬í•¨
???‘ë‹µ???˜ë¦¬ì§€ ?Šë„ë¡?ëª¨ë“  ?¹ì…˜???„ì „???‘ì„±?˜ì—¬ ?œê³µ`;
        const newsOut = await callOpenAI(roles.gpt0_news, newsPrompt);
        const newsTextarea = document.getElementById('gpt0-news');
        newsTextarea.value = newsOut || '';
        // ?ë™ ?’ì´ ì¡°ì •
        newsTextarea.style.height = 'auto';
        newsTextarea.style.height = newsTextarea.scrollHeight + 'px';
        // ?¤í¬ë¡¤ì„ ?´ë‹¹ ?„ì¹˜ë¡??´ë™
        setTimeout(() => scrollToElement('gpt0-news-box'), 100);

        // 3) ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?´ìš© ë¶„ì„ (GPT4 ì§ì ‘ ?¬ìš© ?•ì‹)
        const scenarioSummaryContent = getScenarioSummaryContent(scenNum);
        const summaryPrompt = `?œë‚˜ë¦¬ì˜¤ ID: ${scenarioId}\n?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸: ${scenNum}\n\n[?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?´ìš©]\n${scenarioSummaryContent}

[GPT4 ë³´ê³ ?œìš© ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ ?”ì²­]
???œë‚˜ë¦¬ì˜¤ ?´ìš©??ë¶„ì„?˜ì—¬ ?¤ìŒ ?•ì‹?¼ë¡œ ?‘ì„±?˜ë¼:

## ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼
### 1. ?µì‹¬ ë¦¬ìŠ¤???”ì¸
- [?œë‚˜ë¦¬ì˜¤??ì£¼ìš” ?„í—˜?”ì†Œ 3-5ê°œì? ë°œìƒê°€?¥ì„±]

### 2. ?í–¥ ?„íŒŒ ê²½ë¡œ
- [ë¦¬ìŠ¤?¬ê? ê¸ˆìœµ?œì¥ ë°??°ë¦¬ ê¸°ê???ë¯¸ì¹˜??êµ¬ì²´??ê²½ë¡œ]

### 3. ëª¨ë‹ˆ?°ë§ ì§€??
- [ì¡°ê¸°ê²½ë³´ë¥??„í•œ ?µì‹¬ ëª¨ë‹ˆ?°ë§ ì§€??ë°??„ê³„ì¹?

### 4. ?œë‚˜ë¦¬ì˜¤ ?í–¥???‰ê?
- [?¬ë¬´???í–¥ / ?´ì˜ë¦¬ìŠ¤??/ ?‰íŒë¦¬ìŠ¤?????•ëŸ‰???‰ê?]

### 5. ?€???„ëµ ë°©í–¥
- [?ˆë°©??ì¡°ì¹˜ / ?„í™” ë°©ì•ˆ / ë¹„ìƒê³„íš ??êµ¬ì²´???€?‘ë°©??

### 6. ?µì‹¬ ê²°ì •?¬í•­
- [ì¦‰ì‹œ ê²°ì •???„ìš”???¬í•­ ë°?ë¦¬ì†Œ??ë°°ë¶„ ë°©í–¥]

??ëª¨ë“  ?´ìš©?€ ?¤í–‰ ê°€?¥í•œ êµ¬ì²´???¡ì…˜ê³??¨ê»˜ ?°ì„ ?œìœ„ë¥?ëª…ì‹œ
???‘ë‹µ???˜ë¦¬ì§€ ?Šë„ë¡?ëª¨ë“  ?¹ì…˜???„ì „???‘ì„±?˜ì—¬ ?œê³µ`;
        const summaryOut = await callOpenAI(roles.gpt0_scenario_summary, summaryPrompt);
        const summaryTextarea = document.getElementById('gpt0-scenario-summary');
        summaryTextarea.value = summaryOut || '';
        // ?ë™ ?’ì´ ì¡°ì •
        summaryTextarea.style.height = 'auto';
        summaryTextarea.style.height = summaryTextarea.scrollHeight + 'px';
        // ?¤í¬ë¡¤ì„ ?´ë‹¹ ?„ì¹˜ë¡??´ë™
        setTimeout(() => scrollToElement('gpt0-scenario-summary-box'), 100);



        // 5) ?„ì¬ ?œí™© ë¶„ì„ (GPT4 ì§ì ‘ ?¬ìš© ?•ì‹)
        console.log('?” ?„ì¬ ?œí™© ë¶„ì„ ?œì‘');
        const marketStateText = await buildCurrentMarketStateText();
        console.log('?“Š ?„ì¬ ?œí™© ?ìŠ¤??', marketStateText);
        
        const msPrompt = `${marketStateText}

[GPT4 ë³´ê³ ?œìš© ?„ì¬ ?œí™© ë¶„ì„ ?”ì²­]
???œì¥/ê²½ì œ ?•ë³´ë¥?ë¶„ì„?˜ì—¬ ?¤ìŒ ?•ì‹?¼ë¡œ ?‘ì„±?˜ë¼:

## ?„ì¬ ?œì¥ ?í™© ë¶„ì„
### 1. ?¹ì¼ ?œì¥ ?™í–¥
- [ì£¼ìš” ì§€??ë°??¹í„°ë³??€ì§ì„ê³?ë³€?™ìš”??

### 2. ê²½ì œ ì§€???„í™©
- [?µì‹¬ ê²½ì œì§€??ë³€?”ì? ?œì‚¬??

### 3. ?•ì±… ë°??œë„ ë³€??
- [ê¸ˆìœµ?•ì±…, ê·œì œë³€???±ì´ ?œì¥??ë¯¸ì¹˜???í–¥]

### 4. ê¸€ë¡œë²Œ ë¦¬ìŠ¤???”ì¸
- [?´ì™¸ ì£¼ìš”êµ??™í–¥ê³?êµ?‚´ ?Œê¸‰?¨ê³¼]

### 5. ê¸ˆìœµê¸°ê? ?í–¥ ?‰ê?
- [?„ì¬ ?œí™©???°ë¦¬ ê¸°ê???ë¯¸ì¹˜??ì§ì ‘???í–¥]

### 6. ?¨ê¸° ?„ë§ ë°?ì£¼ì˜?¬í•­
- [?¥í›„ 1-2ì£??œì¥ ?„ë§ê³?ëª¨ë‹ˆ?°ë§ ?¬ì¸??

??ëª¨ë“  ?´ìš©?€ ?˜ì‚¬ê²°ì •???„ìš”??êµ¬ì²´???˜ì¹˜?€ ê·¼ê±°ë¥??¬í•¨?˜ì—¬ ?‘ì„±
???‘ë‹µ???˜ë¦¬ì§€ ?Šë„ë¡?ëª¨ë“  ?¹ì…˜???„ì „???‘ì„±?˜ì—¬ ?œê³µ`;
        console.log('?“ ?„ì¬ ?œí™© ?„ë¡¬?„íŠ¸:', msPrompt);
        
        const msOut = await callOpenAI(roles.gpt0_marketstate, msPrompt);
        console.log('?¤– ?„ì¬ ?œí™© GPT ?‘ë‹µ:', msOut);
        
        const msTextarea = document.getElementById('gpt0-marketstate');
        msTextarea.value = msOut || '';
        // ?ë™ ?’ì´ ì¡°ì •
        msTextarea.style.height = 'auto';
        msTextarea.style.height = msTextarea.scrollHeight + 'px';
        // ?¤í¬ë¡¤ì„ ?´ë‹¹ ?„ì¹˜ë¡??´ë™
        setTimeout(() => scrollToElement('gpt0-marketstate-box'), 100);
        console.log('??gpt0-marketstate ?…ë°?´íŠ¸ ?„ë£Œ');

        // GPT0 ?„ë£Œ ??GPT1??A4 ?”ì•½ ?ì„±
        console.log('?“‹ GPT1??A4 ?”ì•½ ?ì„± ?œì‘');
        status.textContent = 'GPT0 ?„ë£Œ - GPT1???”ì•½ ?ì„± ì¤?..'; 
        
        const gpt1Summary = await generateGpt1SummaryFromGpt0(roles);
        
        // GPT1 ?”ì•½???€?¥í•  ?¨ê²¨ì§??”ì†Œ ?ì„± (?†ëŠ” ê²½ìš°?ë§Œ)
        let gpt1SummaryElement = document.getElementById('gpt1-generated-summary');
        if (!gpt1SummaryElement) {
          gpt1SummaryElement = document.createElement('textarea');
          gpt1SummaryElement.id = 'gpt1-generated-summary';
          gpt1SummaryElement.style.display = 'none';
          document.body.appendChild(gpt1SummaryElement);
        }
        gpt1SummaryElement.value = gpt1Summary;
        
        console.log(`??GPT1???”ì•½ ?€???„ë£Œ: ${gpt1Summary?.length || 0}??);

        status.textContent = 'GPT0 ?„ë£Œ'; status.classList.remove('status-shine');
        card?.classList.remove('running'); card?.classList.add('done');
        
        // GPT0 ?„ë£Œ ??GPT1, GPT2 ì¹´ë“œ ?œì‹œ
        showGpt1Gpt2Cards();
        
        // GPT0 ëª¨ë“ˆ ë°•ìŠ¤?¤ì— ?„ë£Œ ?¨ê³¼ ?ìš©
        document.getElementById('gpt0-marketdata-box')?.classList.remove('running');
        document.getElementById('gpt0-news-box')?.classList.remove('running');
        document.getElementById('gpt0-scenario-summary-box')?.classList.remove('running');
        document.getElementById('gpt0-marketstate-box')?.classList.remove('running');
        
        document.getElementById('gpt0-marketdata-box')?.classList.add('done');
        document.getElementById('gpt0-news-box')?.classList.add('done');
        document.getElementById('gpt0-scenario-summary-box')?.classList.add('done');
        document.getElementById('gpt0-marketstate-box')?.classList.add('done');
      }catch(e){
        console.error(e);
        status.textContent = `?¤íŒ¨: ${e.message}`; status.classList.remove('status-shine');
      }finally{
        // ??GPT0 ?„ë£Œ ???¬ì»¤??? ì? (GPT1 ? ì  ê¸ˆì?)
        // ëª¨ë“  ?œê°???¨ê³¼ ?œê±°
        stopAllEffects();
        
        // GPT0 ì¹´ë“œ ì§„í–‰?¨ê³¼???œê±°
        card?.classList.remove('running');
        
        // GPT0 ëª¨ë“ˆ ë°•ìŠ¤??ì§„í–‰?¨ê³¼???œê±° (ì£¼í™©???¨ê³¼ ?¬í•¨)
        document.getElementById('gpt0-marketdata-box')?.classList.remove('running');
        document.getElementById('gpt0-news-box')?.classList.remove('running');
        document.getElementById('gpt0-scenario-summary-box')?.classList.remove('running');
        document.getElementById('gpt0-marketstate-box')?.classList.remove('running');
        
        // ?¤ë¥¸ìª??¨ë„??ëª¨ë“  GPT0 ê´€??pipeline-executing ?¨ê³¼ ?œê±°
        document.querySelectorAll('.gpt0-module-box').forEach(el => {
          el.classList.remove('pipeline-executing');
        });
      }
    }

    // GPT3 ?„ë©”???¨ì¼ ?¤í–‰ (? ì?, ?„ìš”???¬ìš©)
    async function runGpt3Domain(domain){
      const status = document.getElementById('send-status');
      try{
        status.textContent = `GPT3(${domain}) ?¤í–‰ ì¤?..`;
        const roles = await loadRiskAgentRoles();
        const uiGpt1b = document.getElementById('gpt1-system')?.value?.trim();
        const uiGpt2b = document.getElementById('gpt2-system')?.value?.trim();
        if (uiGpt1b) roles.gpt1 = uiGpt1b;
        if (uiGpt2b) roles.gpt2 = uiGpt2b;
        const baseMessage = document.getElementById('gpt1-message').value?.trim() || '';
        const gpt1Output = document.getElementById('gpt1-output').value || '';
        const gpt2Output = document.getElementById('gpt2-output').value || '';
        const gpt2Input = `${baseMessage}\n\n[GPT1 ?”ì•½/?´ì„]\n${gpt1Output}`;
        const gpt3InputBase = `${gpt2Input}\n\n[GPT2 ë¶„ë°°Â·?•ì œ ê³„íš]\n${gpt2Output}`;
        const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€?´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
        const roleMap = { market: 'gpt3_market', credit: 'gpt3_credit', alm: 'gpt3_alm', global: 'gpt3_global', creditpf: 'gpt3_creditpf' };
        const out = await callOpenAIWithOptions(roles[roleMap[domain]], gpt3InputBase + GL(domain), { timeoutMs: 1200000 });
        const outId = { market: 'gpt3-market', credit: 'gpt3-credit', alm: 'gpt3-alm', global: 'gpt3-global', creditpf: 'gpt3-creditpf' }[domain];
        document.getElementById(outId).value = out || '';
        status.textContent = `GPT3(${domain}) ?„ë£Œ`;
      }catch(e){ status.textContent = `?¤íŒ¨: ${e.message}`; }
    }

    // ?¹ì • ?¨ê³„ë¶€???¬ì‹¤??
    async function runFrom(stage){
      const baseMessage = document.getElementById('gpt1-message').value?.trim();
      const status = document.getElementById('send-status');
      const c1 = document.getElementById('card-gpt1');
      const c2 = document.getElementById('card-gpt2');
      const c3 = document.getElementById('card-gpt3');
      const c4 = document.getElementById('card-gpt4');
      
      // ?”§ ì§€??setRunning ?¨ìˆ˜ ?œê±°??- ?„ì—­ window.setRightTabRunning ?¬ìš©
      
      try {
        // API ???¬ì „ ê²€ì¦?
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = '??API ?¤ê? ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ??';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = '??ë¡œë”© ì¤?..';
        const roles = await loadRiskAgentRoles();
        const uiGpt1 = document.getElementById('gpt1-system').value?.trim();
        const uiGpt2 = document.getElementById('gpt2-system').value?.trim();
        if (uiGpt1) roles.gpt1 = uiGpt1; if (uiGpt2) roles.gpt2 = uiGpt2;

        let gpt1Output = await ensureGpt1OutputReady();
        let gpt2Output = document.getElementById('gpt2-output').value;

        if (stage === 'gpt0' || stage === 'all') {
        graphState.pipelineRunning = true;
        status.textContent = 'GPT0 ?¬ì „?˜ì§‘ ì¤?..'; status.classList.add('status-shine');
          gotoStep(PipelineStep.GPT0);
          window.setRightTabRunning(
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate'],
            ['.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']
          );
          c1?.classList.remove('running','done'); c2?.classList.remove('running','done'); c3?.classList.remove('running','done'); c4?.classList.remove('running','done');
          await runGpt0All();
        }

        if (stage === 'gpt1' || stage === 'all') {
          // === GPT1 ?¤í–‰ ===
          window.dispatchEvent(new CustomEvent('gpt1:start'));
          try {
            status.textContent = 'GPT1 ì²˜ë¦¬ ì¤?..'; status.classList.add('status-shine'); 
            gotoStep(PipelineStep.GPT1);
            window.setRightTabRunning(['.gpt1-anchor'], ['.gpt2-anchor','.gpt4-anchor']);
            c1?.classList.add('running'); c1?.classList.remove('done');
            
            // GPT1 ?œì‘ ì§í›„ - ì§„í–‰ ?¨ê³¼ ? ê? ì¶”ê?
            document.querySelectorAll('.gpt1-module-box')
              .forEach(el => el.classList.add('pipeline-executing'));
            
            // GPT1 ?…ë ¥: GPT0 ëª¨ë“  ëª¨ë“ˆ ì¶œë ¥ ì¢…í•© (?œë‚˜ë¦¬ì˜¤ ?´ìš©ë¶„ì„ ?œì™¸)
            const gpt1Input = buildGpt1InputFromGpt0Outputs();
            document.getElementById('gpt1-message').value = gpt1Input || '';
          
          // GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ GPT1 ?œìŠ¤???„ë¡¬?„íŠ¸
          const gpt1SystemPrompt = `?¹ì‹ ?€ A4 ????ë¶„ëŸ‰??GPT0 ?”ì•½??ë°›ì•„ GPT2 ?„ë©”?¸ë³„ WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ì¢…í•© ?•ì œ ê²°ê³¼ë¥??‘ì„±?˜ëŠ” ?„ë¬¸ê°€?…ë‹ˆ??

??• :
- A4 ????ë¶„ëŸ‰??GPT0 ?”ì•½??ë¶„ì„?˜ì—¬ GPT2ê°€ ?„ìš”ë¡??˜ëŠ” ?µì‹¬ ?•ë³´ ì¶”ì¶œ
- ê¸ˆë¦¬/?˜ìœ¨/? ìš©?„í—˜/ì£¼ê?ì§€????4ê°?ë¶„ì•¼??WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ê¸°ì´ˆ ?°ì´???œê³µ
- 5ê°??„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„±???„í•œ êµ¬ì²´???Œë¼ë¯¸í„° ë°?ì§€ì¹??œê³µ
- ?¼ê????ˆëŠ” ?œë‚˜ë¦¬ì˜¤ ?¤ëª…ê³?ë§ˆì¼“?°ì´??ì¢…í•© ?”ì•½ ?ì„±

GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ?„ìˆ˜ ?°ì´??
1. ê¸ˆë¦¬ WORST ?œë‚˜ë¦¬ì˜¤?? ê¸‰ê²©??ê¸ˆë¦¬ ?ìŠ¹/?˜ë½ ê·¼ê±° ë°?êµ¬ì²´???˜ì¹˜ ë²”ìœ„
2. ?˜ìœ¨ WORST ?œë‚˜ë¦¬ì˜¤?? ê·¹ë‹¨???˜ìœ¨ ë³€???”ì¸ ë°????¬ëŸ¬, ì£¼ìš” ?µí™” ë³€?™í­
3. ? ìš©?„í—˜ WORST ?œë‚˜ë¦¬ì˜¤?? ?€ê·œëª¨ ? ìš©ê²½ìƒ‰ ë°?ë¶€??ê¸‰ì¦ ?¸ë¦¬ê±??”ì¸
4. ì£¼ê?ì§€??WORST ?œë‚˜ë¦¬ì˜¤?? ì£¼ì‹?œì¥ ??½ ?œë‚˜ë¦¬ì˜¤ (ì½”ìŠ¤?? ê¸€ë¡œë²Œ ì§€??

?„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„±???„í•œ êµ¬ì¡°??
1. ?œì¥ë¦¬ìŠ¤?¬í?: VaR, ë¯¼ê°?? ë³€?™ì„± ëª¨ë¸ë§??Œë¼ë¯¸í„° + ?¤ì§• ?„ëµ ê¸°ì´ˆ ?ë£Œ
2. ? ìš©ë¦¬ìŠ¤?¬í?: ?¹í„°ë³??±ê¸‰ë³?ë¶€?„í™•ë¥?ì¶”ì • + ? ìš©?¤í”„?ˆë“œ ?•ë? ?œë‚˜ë¦¬ì˜¤
3. ALM?€: ?ì‚°ë¶€ì±??€?ˆì´??ë¶„ì„ + ? ë™??ê°?ë°??ê¸ˆì¡°ë‹¬ ë¹„ìš© ?í–¥ ?ë£Œ
4. ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í?: êµ??ë¦¬ìŠ¤???‰ê? + ?•ì¹˜/ê²½ì œ??ë¶ˆì•ˆ?•ì„± ?Œê¸‰?¨ê³¼ ë¶„ì„
5. ? ìš©?¬íŠ¸?´ë¦¬?¤í?: ?¬íŠ¸?´ë¦¬??ì§‘ì¤‘??+ ?ê?ê´€ê³?ë°?ë¶„ì‚°?¨ê³¼ ë¶„ì„ ?ë£Œ

ì¶œë ¥ ?•ì‹:
1. ?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?µí•© ?”ì•½
2. ë§ˆì¼“?°ì´???µì‹¬ ì§€???”ì•½ 
3. ?„ì¬?œí™©ê³??´ìŠ¤ ?°ê???ë¶„ì„
4. GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?ì„±???„í•œ ê¸°ì´ˆ ?°ì´??
5. ?„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„± ì§€ì¹?

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;
          
          gpt1Output = await callOpenAI(gpt1SystemPrompt, gpt1Input);
          document.getElementById('gpt1-output').value = gpt1Output || '';
          updateGpt2ButtonState(); // UI ?íƒœ ?…ë°?´íŠ¸
          c1?.classList.remove('running'); c1?.classList.add('done');
          
          // GPT1 ì¢…ë£Œ ??- ì§„í–‰ ?¨ê³¼ ? ê? ?œê±°
          document.querySelectorAll('.gpt1-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
          
          // ??GPT1 ?„ë£Œ ???¬ì»¤??? ì? (GPT2 ? ì  ê¸ˆì?)
        } finally {
          window.dispatchEvent(new CustomEvent('gpt1:done'));
        }
        }
        if (stage === 'gpt2' || stage === 'gpt1' || stage === 'all') {
          // === GPT2 ?¤í–‰ ===
          // (?”êµ¬?¬í•­: gpt3 ?¤í–‰ ?? gpt1ê³?gpt2 ?¨ê³¼ë¥??™ì‹œ??ë³´ì—¬???˜ë?ë¡?
          //  "?œì‘" ?œì ??gpt2 ?´ë²¤?¸ë? ë°”ë¡œ ???™ì‹œ ?˜ì´?¼ì´?¸ê? ê±¸ë¦¬ê²???
          window.dispatchEvent(new CustomEvent('gpt2:start'));
          
          // GPT2 ?¤í–‰ ?¨ê³¼ ?ìš©
          applyGpt2ExecutionEffects();
          try {
            status.textContent = 'GPT2 ?„ë©”?¸ë³„ ë¶„ì„ ?ë£Œ ?ì„± ì¤?..'; status.classList.add('status-shine'); 
            gotoStep(PipelineStep.GPT2);
            window.setRightTabRunning(['.gpt2-anchor'], ['.gpt1-anchor','.gpt4-anchor']);
            c2?.classList.add('running'); c2?.classList.remove('done');
            
            // GPT2 ?œì‘ ì§í›„ - ì§„í–‰ ?¨ê³¼ ? ê? ì¶”ê?
            document.querySelectorAll('.gpt2-module-box')
              .forEach(el => el.classList.add('pipeline-executing'));
            
            gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
          
          // GPT2 ?„ë©”??ê²°ê³¼ë¥??„ì—­ ë³€?˜ë¡œ ?€??(GPT4?ì„œ ì°¸ì¡°??
          window.globalGpt2DomainOutputs = gpt2DomainOutputs;
          
          // GPT2 ê²°ê³¼ë¥?ê¸°ì¡´ ?ì—­???ì„¸ ?´ìš©?¼ë¡œ ?œì‹œ
          const gpt2Detail = `=== ê·¹í•œ ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ?°ì¶œ) ===

[?œì¥ë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.market || '(?ì„±?¤íŒ¨)'}

[? ìš©ë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.credit || '(?ì„±?¤íŒ¨)'}

[ALM?€]
${gpt2DomainOutputs.alm || '(?ì„±?¤íŒ¨)'}

[ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.global || '(?ì„±?¤íŒ¨)'}

[? ìš©?¬íŠ¸?´ë¦¬?¤í?]
${gpt2DomainOutputs.creditpf || '(?ì„±?¤íŒ¨)'}
`;
          
          document.getElementById('gpt2-output').value = gpt2Detail;
          autoGrow(['gpt2-output']);
          // ?¤í¬ë¡¤ì„ GPT2 ì¹´ë“œë¡??´ë™
          setTimeout(() => scrollToElement('card-gpt2'), 100);
          
          // GPT2 ?¤í–‰ ?„ë£Œ ?¨ê³¼ ?ìš©
          setTimeout(() => {
            const gpt2Card = getAgentCard('gpt2');
            if (gpt2Card) {
              gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow');
              
              const gpt2Title = gpt2Card.querySelector('h4');
              if (gpt2Title) {
                gpt2Title.classList.add('text-highlight');
                gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬???;
              }
              
              // 3ì´????¨ê³¼ ?œê±°
              setTimeout(() => {
                gpt2Card.classList.remove('card-blink', 'border-pulse', 'border-glow');
                if (gpt2Title) {
                  gpt2Title.classList.remove('text-highlight');
                  gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?;
                }
                console.log('?‰ GPT2 ?¤í–‰ ?„ë£Œ ?¨ê³¼ ì¢…ë£Œ');
              }, 3000);
            }
          }, 200);
          
          c2?.classList.remove('running'); c2?.classList.add('done');
          
          // GPT2 ì¢…ë£Œ ??- ì§„í–‰ ?¨ê³¼ ? ê? ?œê±°
          document.querySelectorAll('.gpt2-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
          
          // ??GPT2 ?„ë£Œ ???¬ì»¤??? ì? (GPT3 ? ì  ê¸ˆì?)
        } finally {
          window.dispatchEvent(new CustomEvent('gpt2:done'));
        }

          // GPT2 ??GPT3 ?„í™˜ ??GPT2 ì¹´ë“œ ì§€?ì  ?¨ê³¼ ?ìš©
          setTimeout(() => {
            applyGpt2PersistentEffects();
          }, 500);

          // ?´ì–´??GPT3 ??GPT4 ?ë™ ?¤í–‰ (runFrom?ì„œ??ì²´ì¸)
          // === GPT3 ?¤í–‰ ===
          window.dispatchEvent(new CustomEvent('gpt3:start'));
          try {
            status.textContent = 'GPT3 ?„ë©”???ì´?„íŠ¸ ì²˜ë¦¬ ì¤?..'; status.classList.add('status-shine');
            gotoStep(PipelineStep.GPT3);
            window.setRightTabRunning(['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'], ['.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']);
            c3?.classList.add('running'); c3?.classList.remove('done');
          
          // ê°??„ë©”?¸ë³„ ë§ì¶¤ ?…ë ¥ êµ¬ì„±
          const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€?´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
          const g3Calls = [
            callOpenAIWithOptions(roles.gpt3_market, gpt2DomainOutputs.market + GL('market'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_credit, gpt2DomainOutputs.credit + GL('credit'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_alm, gpt2DomainOutputs.alm + GL('alm'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_global, gpt2DomainOutputs.global + GL('global'), { timeoutMs: 1200000 }),
            callOpenAIWithOptions(roles.gpt3_creditpf, gpt2DomainOutputs.creditpf + GL('creditpf'), { timeoutMs: 1200000 }),
          ];
          // ??ê±°ë? ì¼€?´ìŠ¤???ëŸ¬ ë©”ì‹œì§€ë¡??¸ì¶œ?˜ì—¬ ?”ë²„ê¹?ê°€?¥í•˜ê²?ë³€ê²?
          const settled = await Promise.allSettled(g3Calls);
          const pick = (r) => r.status === 'fulfilled'
            ? (r.value || '')
            : (`?¤ë¥˜: ${r.reason?.message || '?„ë¡???¸ì¶œ ?¤íŒ¨'}`);
          const [outMarket, outCredit, outAlm, outGlobal, outCreditPf] = settled.map(pick);
          
          // ?”§ ?„ì—­ ë³‘í•© ?¤í? ?˜ì • + DOM ì§ì ‘ ë°˜ì˜(??ƒ ê°?ê¸°ë¡)
          window.globalGpt3Outputs = {
            ...(window.globalGpt3Outputs || {}),
            market:  (outMarket  || '').trim(),
            credit:  (outCredit  || '').trim(),
            alm:     (outAlm     || '').trim(),
            global:  (outGlobal  || '').trim(),
            creditpf:(outCreditPf|| '').trim()
          };

          // DOM????ƒ ê¸°ë¡(ë¹?ë¬¸ì?´ë„ ê·¸ë?ë¡?ë°˜ì˜?˜ì—¬ ?¤ì œ ?íƒœë¥??ˆìœ¼ë¡??•ì¸ ê°€??
          document.getElementById('gpt3-market').value   = outMarket || '';
          document.getElementById('gpt3-credit').value   = outCredit || '';
          document.getElementById('gpt3-alm').value      = outAlm || '';
          document.getElementById('gpt3-global').value   = outGlobal || '';
          document.getElementById('gpt3-creditpf').value = outCreditPf || '';
          autoGrow(['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf']);
          // GPT3 ëª¨ë“ˆë³??œì°¨ ?¤í¬ë¡?(ê°?ëª¨ë“ˆ ?„ë£Œ ???´ë‹¹ ëª¨ë“ˆë¡??¤í¬ë¡?
          setTimeout(() => {
            if (outMarket) scrollToGpt3Module('market');
            setTimeout(() => { if (outCredit) scrollToGpt3Module('credit'); }, 300);
            setTimeout(() => { if (outAlm) scrollToGpt3Module('alm'); }, 600);
            setTimeout(() => { if (outGlobal) scrollToGpt3Module('global'); }, 900);
            setTimeout(() => { if (outCreditPf) scrollToGpt3Module('creditpf'); }, 1200);
          }, 200);
          
          c3?.classList.remove('running'); c3?.classList.add('done');
          // ??GPT3 ?„ë£Œ ???¬ì»¤??? ì? (GPT4 ? ì  ê¸ˆì?)
        } finally {
          // ???´ë–¤ ê²½ìš°?ë„ ?¨ê³¼ ì¢…ë£Œ + done ?´ë²¤??ë³´ì¥
          (function cleanupGpt3Effects(){
            const card = document.getElementById('card-gpt3');
            if (card) {
              card.classList.remove('progress-indicator','running');
              card.classList.add('done');
              const overlay = card.querySelector('.execution-overlay');
              if (overlay) overlay.remove();
            }
            document.querySelectorAll('.gpt3-module-box')
              .forEach(el => el.classList.remove('pipeline-executing'));
          })();
          window.dispatchEvent(new CustomEvent('gpt3:done'));
        }

          status.textContent = 'GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ì¤?..'; status.classList.add('status-shine'); 
          // === GPT4 ?¤í–‰ ===
          // (gpt4 ?œì‘ê³??™ì‹œ??gpt3 ?¨ê³¼ê°€ ì¢…ë£Œ?˜ë„ë¡?ë¦¬ìŠ¤?ˆì—??ì²˜ë¦¬)
          window.dispatchEvent(new CustomEvent('gpt4:start'));
          try {
            gotoStep(PipelineStep.GPT4);
            window.setRightTabRunning(['.gpt4-anchor'], ['.gpt1-anchor','.gpt2-anchor']);
            c4?.classList.add('running'); c4?.classList.remove('done');
          const guidelineAll = (()=>{ const g=window.gpt3Guidelines||{}; const all=[g.market,g.credit,g.alm,g.global,g.creditpf].filter(Boolean).join('\n'); return all?`\n\n[ì°¸ì¡° ê°€?´ë“œ]\n${all}`:''; })();
          const gpt0MarketData = document.getElementById('gpt0-marketdata').value || '';
          const gpt0News = document.getElementById('gpt0-news').value || '';
          const gpt0ScenarioSummary = document.getElementById('gpt0-scenario-summary').value || '';

          const gpt0MarketState = document.getElementById('gpt0-marketstate').value || '';
          
          // GPT2 ?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?˜ì§‘
          const gpt2DomainOutputsForGpt4 = window.globalGpt2DomainOutputs || {};
          
          /* ?ˆì „ ?ŒìŠ¤ ?•ì •: ì§€???????DOM ???„ì—­ ??GPT2 ?„ë©”???ë³¸ ??*/
          const G3 = window.globalGpt3Outputs || {};
          const G2 = window.globalGpt2DomainOutputs || {};
          const outMarketSafe  = (outMarket  || document.getElementById('gpt3-market')?.value   || G3.market   || G2.market   || '').trim();
          const outCreditSafe  = (outCredit  || document.getElementById('gpt3-credit')?.value   || G3.credit   || G2.credit   || '').trim();
          const outAlmSafe     = (outAlm     || document.getElementById('gpt3-alm')?.value      || G3.alm      || G2.alm      || '').trim();
          const outGlobalSafe  = (outGlobal  || document.getElementById('gpt3-global')?.value   || G3.global   || G2.global   || '').trim();
          const outCreditPfSafe= (outCreditPf|| document.getElementById('gpt3-creditpf')?.value || G3.creditpf || G2.creditpf || '').trim();

          const gpt4InputChain = [
            '?„ë˜ ?•ë³´?¤ì„ ë°”íƒ•?¼ë¡œ ì²´ê³„?ì¸ ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??',
            '\n\n=== ê¸°ì´ˆ ë¶„ì„ ê²°ê³¼ ===',
            '\n\n## 1. ?œì¥?°ì´??ë¶„ì„',
            gpt0MarketData,
            '\n\n## 2. ?´ìŠ¤ ë°?ë¦¬ìŠ¤??ë¶„ì„', 
            gpt0News,
            '\n\n## 3. ?œë‚˜ë¦¬ì˜¤ ?ì„¸ ë¶„ì„',
            gpt0ScenarioSummary,
            '\n\n## 4. ?„ì¬ ?œì¥ ?í™©',
            gpt0MarketState,
            '\n\n=== ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤ ?•ë³´ ===',
            '\n\n### ?œì¥ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.market || '',
            '\n\n### ? ìš©ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.credit || '',
            '\n\n### ALM ?œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.alm || '',
            '\n\n### ê¸€ë¡œë²Œë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.global || '',
            '\n\n### ? ìš©?¬íŠ¸?´ë¦¬???œë‚˜ë¦¬ì˜¤\n', gpt2DomainOutputsForGpt4.creditpf || '',
            '\n\n=== ?„ë©”?¸ë³„ ?ì‹¤ë¶„ì„ ê²°ê³¼ ===',
            '\n\n', outMarketSafe,
            '\n\n', outCreditSafe,
            '\n\n', outAlmSafe,
            '\n\n', outGlobalSafe,
            '\n\n', outCreditPfSafe,
            guidelineAll,
            '\n\n=== ë³´ê³ ???‘ì„± ì§€ì¹?===',
            '\n??ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥?ì¢…í•©?˜ì—¬ ?¤ìŒê³?ê°™ì´ ë³´ê³ ?œë? êµ¬ì„±?˜ì„¸??',
            '\n\n**ë³´ê³ ??êµ¬ì„±:**',
            '\n1. ?”ì•½: ?µì‹¬ ?„í—˜ ?”ì†Œ ë°?ì´??ì‹¤ ê·œëª¨ ?”ì•½',
            '\n2. ?œë‚˜ë¦¬ì˜¤ ë¶„ì„: ê¸°ì´ˆ ë¶„ì„??êµ¬ì¡°?”ëœ ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ + ë¦¬ìŠ¤???”ì†Œë³??œë‚˜ë¦¬ì˜¤',
            '\n3. ?ì‹¤ ?í–¥ ë¶„ì„: ê°??„ë©”?¸ì˜ ?ì‹¤ë¶„ì„ ê²°ê³¼ ?µí•©',
            '\n4. ë¦¬ìŠ¤???€???„ëµ: ?„ë©”?¸ë³„ ì¦‰ì‹œ/?¨ê¸°/ì¤‘ê¸° ?€?‘ë°©??ì¢…í•©',
            '\n5. ëª¨ë‹ˆ?°ë§ ê³„íš: ê°?ëª¨ë“ˆ???¼ì¼/ì£¼ê°„/?”ê°„ ëª¨ë‹ˆ?°ë§ ?µí•©',
            '\n6. ê²°ë¡  ë°?ê¶Œê³ : ?°ì„ ?œìœ„ë³??¡ì…˜ ?„ì´??ë°??˜ì‚¬ê²°ì • ì§€??,
            '\n\n**?‘ì„± ?ì¹™:**',
            '\n- ê¸°ì´ˆ ë¶„ì„ ê²°ê³¼??êµ¬ì¡°?”ë˜???ˆìœ¼ë¯€ë¡?ì§ì ‘ ?œìš©',
            '\n- ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤??ê°??”ì†Œë³?êµ¬ì²´???˜ì¹˜?€ ?´ìœ  ?¬í•¨',
            '\n- ?ì‹¤ë¶„ì„?€ ?„ë©”?¸ë³„ ?„ê²°??ë³´ê³ ???•íƒœë¡??°ê²°',
            '\n- ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼., ?•ì‹: ?„ë¬¸??ë³´ê³ ??
          ].join('');
          // ? ï¸ ?ˆê±°??ë¸”ë¡ - ì¤‘ë³µ ë³´ê³ ???ì„± ë°©ì?ë¥??„í•´ ì£¼ì„ ì²˜ë¦¬
          // ?„ì¬??generateStepByStepReport()ë¥??µí•´ ?µí•© ë³´ê³ ?œë? ?ì„±?˜ë?ë¡?
          // ??ë¸”ë¡?€ ?¬ìš©?˜ì? ?ŠìŒ (ì¤‘ë³µ ?ì„± ë°?"ë³´ê³ ???ˆì— ë³´ê³ ?? ë¬¸ì œ ?´ê²°)
          /*
          try {
            // GPT4 ?œìŠ¤???„ë¡¬?„íŠ¸ ?œì‹œ
            document.getElementById('gpt4-system').value = roles.gpt4_final || '';
            
            // GPT4??ê²°ë¡  ë¶€ë¶„ë§Œ ?ì„±?˜ê³ , ê¸°ì¡´ ë¶„ì„ ê²°ê³¼?€ ?©ì¹˜ê¸?
            const conclusionOnlyPrompt = `${gpt4InputChain}

=== ê²°ë¡  ?¹ì…˜ë§??‘ì„± ?”ì²­ ===
??ëª¨ë“  ë¶„ì„ ?´ìš©??ê²€? í•œ ?? ì¦‰ì‹œ ?˜ì‚¬ê²°ì •?????ˆë„ë¡??¤ìŒ ê²°ë¡  ?¹ì…˜ë§??‘ì„±?´ì£¼?¸ìš”:

## 6. ê²°ë¡  ë°?ê¶Œê³ ?¬í•­

### 6.1 ?µì‹¬ ë¦¬ìŠ¤???”ì•½
- ìµœìš°??ê´€ë¦??€?? [ê°€???¬ê°??ë¦¬ìŠ¤??3ê°?
- ì´??ˆìƒ ?ì‹¤ ê·œëª¨: [?‹â—‹?µì›] (?„ì²´ ?œë‚˜ë¦¬ì˜¤ ê¸°ì?)
- ì¦‰ì‹œ ?€???„ìš” ?ì—­: [ê¸´ê¸‰????

### 6.2 ?°ì„ ?œìœ„ë³??¡ì…˜ ?„ì´??
**ì¦‰ì‹œ ?¤í–‰ (24?œê°„ ??:**
1. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]
2. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]
3. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]

**?¨ê¸° ?€??(1ì£¼ì¼ ??:**
1. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]
2. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]

**ì¤‘ê¸° ?„ëµ (1ê°œì›” ??:**
1. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]
2. [êµ¬ì²´??ì¡°ì¹˜?¬í•­]

### 6.3 ?˜ì‚¬ê²°ì • ì§€???•ë³´
- ?´ì‚¬??ë³´ê³  ?„ìš” ?¬í•­: [?µì‹¬ 3ê°???ª©]
- ê·œì œê¸°ê? ë³´ê³  ?„ìš” ?¬ë?: [Yes/No ë°??¬ìœ ]
- ?€??ê³µì‹œ ê²€???¬í•­: [?„ìš”??
- ì¶”ê? ?ì› ?Œìš”: [?¸ë ¥/?ˆì‚°/?œìŠ¤??

ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

            const gpt4Conclusion = await callOpenAI(roles.gpt4_final, conclusionOnlyPrompt);
            
            // ê¸°ì¡´ ë¶„ì„ ê²°ê³¼?¤ê³¼ GPT4 ê²°ë¡ ???©ì³???„ì „??ë³´ê³ ???ì„±
            const completeReport = [
              '# ?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??,
              '',
              '## 1. ê¸°ì´ˆ ë¶„ì„ ê²°ê³¼',
              '',
              '### 1.1 ?œì¥?°ì´??ë¶„ì„',
              gpt0MarketData || 'ë¶„ì„ ?°ì´???†ìŒ',
              '',
              '### 1.2 ?´ìŠ¤ ë°?ë¦¬ìŠ¤??ë¶„ì„', 
              gpt0News || 'ë¶„ì„ ?°ì´???†ìŒ',
              '',
              '### 1.3 ?œë‚˜ë¦¬ì˜¤ ?ì„¸ ë¶„ì„',
              gpt0ScenarioSummary || 'ë¶„ì„ ?°ì´???†ìŒ',
              '',
              '### 1.4 ?„ì¬ ?œì¥ ?í™©',
              gpt0MarketState || 'ë¶„ì„ ?°ì´???†ìŒ',
              '',
              '## 2. ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤ ?•ë³´',
              '',
              '### 2.1 ?œì¥ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.market || '?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?†ìŒ',
              '',
              '### 2.2 ? ìš©ë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.credit || '?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?†ìŒ',
              '',
              '### 2.3 ALM ?œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.alm || '?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?†ìŒ',
              '',
              '### 2.4 ê¸€ë¡œë²Œë¦¬ìŠ¤???œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.global || '?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?†ìŒ',
              '',
              '### 2.5 ? ìš©?¬íŠ¸?´ë¦¬???œë‚˜ë¦¬ì˜¤',
              gpt2DomainOutputsForGpt4.creditpf || '?œë‚˜ë¦¬ì˜¤ ?•ë³´ ?†ìŒ',
              '',
              '## 3. ?„ë©”?¸ë³„ ?ì‹¤ë¶„ì„ ê²°ê³¼',
              '',
              outMarket || '',
              '',
              outCredit || '',
              '',
              outAlm || '',
              '',
              outGlobal || '',
              '',
              outCreditPf || '',
              '',
              '## 4. ì¢…í•© ë¶„ì„',
              '',
              gpt4Conclusion || 'ê²°ë¡  ?ì„± ?¤íŒ¨'
            ].join('\n');

            document.getElementById('gpt4-output').value = completeReport;
          } catch(e) {
            document.getElementById('gpt4-output').value = 'GPT4 ?¨ê³„?ì„œ ?¤ë¥˜ê°€ ë°œìƒ?ˆì?ë§??´ì „ ?¨ê³„ ê²°ê³¼??ì¤€ë¹„ë˜?ˆìŠµ?ˆë‹¤.';
          }
          */
          c4?.classList.remove('running'); c4?.classList.add('done');
          // GPT4 ?„ë£Œ ??PPT ì¶œë ¥ ?ì—­?¼ë¡œ ?ë™ ?¤í¬ë¡?ë°?CTA ê°•ì¡° ?œì‹œ
          const panel = document.getElementById('gpt1-panel');
          const pptBtn = document.getElementById('btn-export-ppt');
          if (panel && pptBtn && !window.__userDraggingTab) {
            const pptHeader = document.getElementById('gpt4-header-row');
            const anchor = pptHeader || pptBtn;
            panel.scrollTo({ top: (anchor.offsetTop || pptBtn.offsetTop) - 40, behavior: 'smooth' });
            pptBtn.classList.add('ppt-cta');
            // ??ì´????ë™?¼ë¡œ ê°•ì¡° ?´ì œ (ì§€??ë¶€??ì¤„ì´ê¸?
            setTimeout(()=> pptBtn.classList.remove('ppt-cta'), 6000);
          }
        } finally {
          window.dispatchEvent(new CustomEvent('gpt4:done'));
        }
        }
        if (stage === 'gpt4') {
          status.textContent = 'GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ì¤?..'; status.classList.add('status-shine'); setFlow('.to-gpt4'); setRunning(['.gpt4-anchor'], ['.gpt1-anchor','.gpt2-anchor']);
          c4?.classList.add('running'); c4?.classList.remove('done');
          
          // ====== ?ˆë¡œ??GPT4 ì¡°ë¦½ ë¡œì§ ?ìš© (runFrom ê²½ë¡œ) ======
          console.log('?? runFrom GPT4: ?ˆë¡œ??ì¡°ë¦½ ë¡œì§ ?ìš©');
          
          // DOM?ì„œ ?°ì´???½ê¸°
          const gpt0MarketDataRun = document.getElementById('gpt0-marketdata').value || '';
          const gpt0NewsRun = document.getElementById('gpt0-news').value || '';
          const gpt0ScenarioSummaryRun = document.getElementById('gpt0-scenario-summary').value || '';
          const gpt0MarketStateRun = document.getElementById('gpt0-marketstate').value || '';
          const gpt2OutputRun = document.getElementById('gpt2-output').value || '';
          
          // ?ì§„??GPT4 ì²˜ë¦¬ë¥??„í•œ ë¹„ë™ê¸??¨ìˆ˜
          (async () => {
            try {
              console.log('?? runFrom: ?ì§„??GPT4 ì²˜ë¦¬ ?œì‘');
              
              // GPT4 ?œìŠ¤???„ë¡¬?„íŠ¸ ?œì‹œ
              document.getElementById('gpt4-system').value = roles.gpt4_final || '';
              
              // generateStepByStepReport ?¸ì¶œ (?´ë? ?ì§„??ì²˜ë¦¬ êµ¬í˜„??
              const gpt4Output = await generateStepByStepReport(roles.gpt4_final);
              
              console.log('??runFrom: ?ì§„??GPT4 ì²˜ë¦¬ ?„ë£Œ');
              
            } catch (error) {
              console.error('??runFrom GPT4 ?¤ë¥˜:', error);
              document.getElementById('gpt4-output').value = `GPT4 ì²˜ë¦¬ ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`;
            } finally {
              // ?„ë£Œ ?íƒœ ?…ë°?´íŠ¸
              c4?.classList.remove('running'); 
              c4?.classList.add('done');
              status.textContent = 'GPT4 ?¨ê³„ë³?ë³´ê³ ???„ë£Œ';
              status.classList.remove('status-shine');
              
              // PPT ì¶œë ¥ ?ì—­?¼ë¡œ ?ë™ ?¤í¬ë¡?ë°?CTA ê°•ì¡° ?œì‹œ
              const panel = document.getElementById('gpt1-panel');
              const pptBtn = document.getElementById('btn-export-ppt');
              if (panel && pptBtn && !window.__userDraggingTab) {
                const pptHeader = document.getElementById('gpt4-header-row');
                const anchor = pptHeader || pptBtn;
                panel.scrollTo({ top: (anchor.offsetTop || pptBtn.offsetTop) - 40, behavior: 'smooth' });
                pptBtn.classList.add('ppt-cta');
                setTimeout(() => pptBtn.classList.remove('ppt-cta'), 6000);
              }
            }
          })();
        }
        status.textContent = '?„ë£Œ'; status.classList.remove('status-shine');
        graphState.pipelineRunning = false;
        stopAllEffects();
        setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        // ??runFrom ê²½ë¡œ?ì„œ???„ë£Œ ?´ë²¤??ë°œí–‰ (?µí•©???„ë£Œ ì²˜ë¦¬ ë³´ì¥)
        window.dispatchEvent(new CustomEvent('gpt4:done'));
      } catch(e) {
        status.textContent = `?¤íŒ¨: ${e.message}`; status.classList.remove('status-shine');
        graphState.pipelineRunning = false;
        stopAllEffects();
        setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        // ?ëŸ¬ ??GPT1ê³?GPT2??ì§„í–‰ ?¨ê³¼ ?œê±°
        document.querySelectorAll('.gpt1-module-box, .gpt2-module-box')
          .forEach(el => el.classList.remove('pipeline-executing'));
      }
    }

    // ====== GPT1?’GPT2?’GPT3 ?Œì´?„ë¼???¤í–‰ ======
    async function runAgentPipeline() {
      const baseMessage = document.getElementById('gpt1-message').value?.trim();
      const status = document.getElementById('send-status');
      if (!baseMessage) {
        status.textContent = 'ë³´ë‚¼ ë©”ì‹œì§€ê°€ ?†ìŠµ?ˆë‹¤.';
        return;
      }

      try {
        // ?Œì´?„ë¼???¤í–‰ ?œì‘ ???¤ë¥¸ìª??¨ë„ë¡??ë™ ?´ë™
        const panel = document.getElementById('gpt1-panel');
        if (panel) {
          // (ê¶Œì¥) ?¬ìš©?ê? ?„ì¬ ?œë˜ê·?ì¤‘ì´ë©??ë™ ?¤í¬ë¡?ê°œì… ê¸ˆì?
          if (window.__userDraggingTab) return;

          // ??GPT1 ~ GPT2 ë°•ìŠ¤ "ì¤‘ê°„" ì§€?ìœ¼ë¡??¤í¬ë¡?
          const pick = (sels) => sels.map(s => document.querySelector(s)).find(Boolean);
          // GPT1/GPT2 ?µì»¤ ?„ë³´(ì¡´ì¬?˜ëŠ” ì²??”ì†Œ ?¬ìš©) ???„ë¡œ?íŠ¸ êµ¬ì¡°??ë§ê²Œ ?‰ë„‰??ì»¤ë²„
          const g1 = pick([
            '#card-gpt1', '#gpt1-output-box', '#gpt1-input-box', '#gpt1-output',
            '.gpt1-anchor', '[data-agent="gpt1"]'
          ]);
          const g2 = pick([
            '#card-gpt2', '#gpt2-output-box', '#gpt2-output',
            '.gpt2-anchor', '[data-agent="gpt2"]'
          ]);

          const off = (el) => (el && typeof el.offsetTop === 'number') ? el.offsetTop : null;
          const y1 = off(g1), y2 = off(g2);

          let targetY;
          if (y1 != null && y2 != null) {
            // ??ë°•ìŠ¤??ì¤‘ì•™ê°?- ?ë‹¨ ?¨ë”©(40px)
            targetY = Math.max(0, ((y1 + y2) / 2) - 40);
          } else if (y1 != null) {
            // GPT1ë§??ˆì„ ?ŒëŠ” GPT1 ?ë‹¨?¼ë¡œ
            targetY = Math.max(0, y1 - 40);
          } else if (y2 != null) {
            // GPT2ë§??ˆì„ ?ŒëŠ” GPT2 ?ë‹¨?¼ë¡œ
            targetY = Math.max(0, y2 - 40);
          } else {
            // ìµœí›„ ?´ë°±(?”ì†Œë¥?ëª?ì°¾ì? ê²½ìš°ë§?
            targetY = 0;
          }

          panel.scrollTo({ top: targetY, behavior: 'smooth' });
        }
        
        // ?Œì´?„ë¼???¤í–‰ ?íƒœ ?¤ì •
        graphState.pipelineRunning = true;
        
        // API ???¬ì „ ê²€ì¦?
        if (!(await window.checkAndPromptForApiKey())) {
          status.textContent = '??API ?¤ê? ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ??';
          status.style.color = '#e74c3c';
          return;
        }
        
        status.textContent = '??ë¡œë”© ì¤?..';
        // ?”’ ë³´ì•ˆ: getOpenAIAuthHeaders ?œê±°??- callOpenAI ?¨ìˆ˜ ?¬ìš©

        // risk_eng?ì„œ ?ì´?„íŠ¸ ??•  ?”ê±´ ì¶”ì¶œ
        const roles = await loadRiskAgentRoles();
        // ?¬ìš©?ê? ?˜ì •???œìŠ¤???„ë¡¬?„íŠ¸ê°€ ?ˆìœ¼ë©???–´?°ê¸°
        const uiGpt1 = document.getElementById('gpt1-system').value?.trim();
        const uiGpt2 = document.getElementById('gpt2-system').value?.trim();
        if (uiGpt1) roles.gpt1 = uiGpt1;
        if (uiGpt2) roles.gpt2 = uiGpt2;

        // ì§„í–‰ ?œì‹œ ?„ìš°ë¯?
        const setRunning = (onSelectors = [], offSelectors = []) => {
          offSelectors.forEach(sel => d3.selectAll(sel).classed('agent-running', false));
          onSelectors.forEach(sel => d3.selectAll(sel).classed('agent-running', true));
        };

        // GPT0 ?¨ê³„ (?¬ì „?˜ì§‘) - ?ˆì •??ê°œì„ 
        status.textContent = 'GPT0 ?¬ì „?˜ì§‘ ì¤?..';
        gotoStep(PipelineStep.GPT0);
        setRunning(['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate'], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        try {
          await runGpt0All();
          console.log('??GPT0 ?¨ê³„ ?„ë£Œ, GPT1 ?¨ê³„ë¡?ì§„í–‰');
        } catch (e) {
          console.error('??GPT0 ?¨ê³„ ?¤íŒ¨:', e);
          status.textContent = `GPT0 ?¨ê³„ ?¤íŒ¨: ${e.message}`;
          throw e; // ?Œì´?„ë¼??ì¤‘ë‹¨
        }

        // GPT1 ?¨ê³„
        status.textContent = 'GPT1 ì²˜ë¦¬ ì¤?..';
        gotoStep(PipelineStep.GPT1);
        setRunning(['.gpt1-anchor'], ['.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        // GPT1 ?…ë ¥: GPT0 ëª¨ë“  ëª¨ë“ˆ ì¶œë ¥ ì¢…í•©
        const gpt1Input = buildGpt1InputFromGpt0Outputs();
        const gpt1Output = await callOpenAI(roles.gpt1, gpt1Input);
        document.getElementById('gpt1-output').value = gpt1Output || '';
        updateGpt2ButtonState(); // UI ?íƒœ ?…ë°?´íŠ¸

        // GPT2 ?¨ê³„ (?„ë©”?¸ë³„ ë§ì¶¤ ë¶„ì„ ?ë£Œ ?ì„±)
        status.textContent = 'GPT2 ?„ë©”?¸ë³„ ë¶„ì„ ?ë£Œ ?ì„± ì¤?..';
        gotoStep(PipelineStep.GPT2);
        setRunning(['.gpt2-anchor'], ['.gpt1-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        const gpt2DomainOutputs = await generateGpt2DomainOutputs(gpt1Output, roles);
        
        // GPT2 ê²°ê³¼ë¥?ê¸°ì¡´ ?ì—­???ì„¸ ?´ìš©?¼ë¡œ ?œì‹œ
        const gpt2Detail = `=== ê·¹í•œ ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ (GPT2 ?°ì¶œ) ===

[?œì¥ë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.market || '(?ì„±?¤íŒ¨)'}

[? ìš©ë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.credit || '(?ì„±?¤íŒ¨)'}

[ALM?€]
${gpt2DomainOutputs.alm || '(?ì„±?¤íŒ¨)'}

[ê¸€ë¡œë²Œë¦¬ìŠ¤?¬í?]
${gpt2DomainOutputs.global || '(?ì„±?¤íŒ¨)'}

[? ìš©?¬íŠ¸?´ë¦¬?¤í?]
${gpt2DomainOutputs.creditpf || '(?ì„±?¤íŒ¨)'}
`;
        
        document.getElementById('gpt2-output').value = gpt2Detail;
        autoGrow(['gpt2-output']);

        // GPT2 ì¢…ë£Œ ????GPT3 ?ë™ ?¤í–‰
        status.textContent = 'GPT3 ?„ë©”???ì´?„íŠ¸ ì²˜ë¦¬ ì¤?..'; status.classList.add('status-shine');
        setFlow('.to-gpt3');
        setRunning(['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'],
                   ['.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']);
        c3?.classList.add('running'); c3?.classList.remove('done');

        // ê°??„ë©”?¸ë³„ ë§ì¶¤ ?…ë ¥ êµ¬ì„± + ?¤í–‰
        const GL = (k)=> (window.gpt3Guidelines?.[k] ? `\n\n[ì°¸ì¡° ê°€?´ë“œ]\n${window.gpt3Guidelines[k]}` : '');
        const g3Calls = [
          callOpenAIWithOptions(roles.gpt3_market, gpt2DomainOutputs.market + GL('market'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_credit, gpt2DomainOutputs.credit + GL('credit'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_alm,    gpt2DomainOutputs.alm    + GL('alm'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_global, gpt2DomainOutputs.global + GL('global'), { timeoutMs: 1200000 }),
          callOpenAIWithOptions(roles.gpt3_creditpf, gpt2DomainOutputs.creditpf + GL('creditpf'), { timeoutMs: 1200000 }),
        ];
        const [outMarket, outCredit, outAlm, outGlobal, outCreditPf] =
          (await Promise.allSettled(g3Calls)).map(r => r.status==='fulfilled' ? (r.value||'') : '');

        // ??GPT3 ?°ì¶œë¬?DOM ?€??(?„ì† ?¨ê³„/ë³´ê³ ?œì—??ì°¸ì¡°)
        document.getElementById('gpt3-market').value   = outMarket || '';
        document.getElementById('gpt3-credit').value   = outCredit || '';
        document.getElementById('gpt3-alm').value      = outAlm || '';
        document.getElementById('gpt3-global').value   = outGlobal || '';
        document.getElementById('gpt3-creditpf').value = outCreditPf || '';
        autoGrow(['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf']);

        // DOM ê¸°ë¡ ì§í›„ ?„ì—­???™ì¼ ê°’ìœ¼ë¡??™ê¸°??
        window.globalGpt3Outputs = {
          market: (outMarket || '').trim(),
          credit: (outCredit || '').trim(),
          alm:    (outAlm || '').trim(),
          global: (outGlobal || '').trim(),
          creditpf:(outCreditPf || '').trim()
        };

        c3?.classList.remove('running'); c3?.classList.add('done');
        document.getElementById('gpt1-panel')?.scrollTo({
          top: document.getElementById('card-gpt4')?.offsetTop - 20,
          behavior: 'smooth'
        });

        // GPT4 ìµœì¢… ì·¨í•©
        status.textContent = (outMarket||outCredit||outAlm||outGlobal||outCreditPf) ? 'GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ì¤?..' : 'GPT3 ?¤íŒ¨ ??GPT4 ì§„í–‰';
        console.log('?? GPT4 ?¨ê³„ ?œì‘');
        
        // GPT4 ?œì‘ ?œì ?ë§Œ GPT4ë¡??´ë™
        gotoStep(PipelineStep.GPT4);
        setRunning(['.gpt4-anchor'], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf']);
        
        // ??GPT4 100ì´??€?´ë¨¸ ?¤ì • - ?„ë£Œ ?ˆë˜?´ë„ ê°•ì œë¡??„ì²´ ?œì‹œ
        if (window.gpt4ForceCompleteTimer) clearTimeout(window.gpt4ForceCompleteTimer);
        window.gpt4ForceCompleteTimer = setTimeout(() => {
          console.log('??GPT4 100ì´??€?´ë¨¸ ?„ë£Œ - ê°•ì œë¡??„ì²´ ë°•ìŠ¤ ?œì‹œ');
          
          // ?„ì²´ ë°•ìŠ¤ ?œì‹œ
          if (window.revealAllRightTabBoxes) {
            window.revealAllRightTabBoxes();
          }
          
          // ë³´ê³ ???ì—­ ?œì‹œ ë°?ê°•ì¡°
          const reportActions = document.getElementById('report-actions');
          if (reportActions) {
            reportActions.style.display = 'flex';
            reportActions.classList.add('report-actions-cta');
            console.log('??ë³´ê³ ???‘ì—… ?ì—­ ?œì‹œ ë°?ê°•ì¡°');
            
            // 4ì´???ê°•ì¡° ?¨ê³¼ ?œê±°
            setTimeout(() => {
              reportActions.classList.remove('report-actions-cta');
            }, 4000);
          }
          
          // ?Œì´?„ë¼???„ë£Œ ì²˜ë¦¬
          document.body.classList.add('pipeline-complete');
          
          // ?„ë£Œ ?´ë²¤??ë°œìƒ
          try { 
            window.dispatchEvent(new Event('gpt4:complete')); 
            window.dispatchEvent(new Event('gpt4:done')); 
          } catch (e) {}
          
          console.log('??GPT4 100ì´?ê°•ì œ ?„ë£Œ ì²˜ë¦¬??);
        }, 100000); // 100ì´?
        console.log('?±ï¸ GPT4 100ì´??€?´ë¨¸ ?œì‘??);
        
        // GPT0 ?°ì´???˜ì§‘
        const gpt0MarketDataMain = document.getElementById('gpt0-marketdata').value || '';
        const gpt0NewsMain = document.getElementById('gpt0-news').value || '';
        const gpt0ScenarioSummaryMain = document.getElementById('gpt0-scenario-summary').value || '';
        const gpt0MarketStateMain = document.getElementById('gpt0-marketstate').value || '';
        
        // GPT1, GPT2 ?°ì´???˜ì§‘ (ê¸°ì¡´ ë³€???¬ì‚¬??
        const gpt1OutputValue = document.getElementById('gpt1-output').value || '';
        const gpt2OutputValue = document.getElementById('gpt2-output').value || '';
        
        // GPT4 ?…ë ¥ êµ¬ì„± ???ì„¸ ?”ë²„ê¹?ë¡œê·¸
        console.log('?” GPT4 ?…ë ¥ êµ¬ì„± ?œì‘');
        console.log('?“Š GPT0 ë§ˆì¼“?°ì´??', gpt0MarketDataMain ? `?ˆìŒ (${gpt0MarketDataMain.length}??` : '?†ìŒ');
        console.log('?“° GPT0 ?´ìŠ¤:', gpt0NewsMain ? `?ˆìŒ (${gpt0NewsMain.length}??` : '?†ìŒ');
        console.log('?“‹ GPT0 ?œë‚˜ë¦¬ì˜¤ ?”ì•½:', gpt0ScenarioSummaryMain ? `?ˆìŒ (${gpt0ScenarioSummaryMain.length}??` : '?†ìŒ');
        console.log('?Œ GPT0 ?„ì¬ ?œí™©:', gpt0MarketStateMain ? `?ˆìŒ (${gpt0MarketStateMain.length}??` : '?†ìŒ');
        console.log('?§  GPT1 ì¶œë ¥:', gpt1OutputValue ? `?ˆìŒ (${gpt1OutputValue.length}??` : '?†ìŒ');
        console.log('?”— GPT2 ì¶œë ¥:', gpt2OutputValue ? `?ˆìŒ (${gpt2OutputValue.length}??` : '?†ìŒ');
        
        // ???ˆì „??DOM ?½ê¸°ë¡?GPT3 ê²°ê³¼ ?•ì¸
        const g3M = (document.getElementById('gpt3-market').value || '').trim();
        const g3C = (document.getElementById('gpt3-credit').value || '').trim();
        const g3A = (document.getElementById('gpt3-alm').value || '').trim();
        const g3G = (document.getElementById('gpt3-global').value || '').trim();
        const g3P = (document.getElementById('gpt3-creditpf').value || '').trim();

        console.log('?¤– GPT3 ?œì¥ë¦¬ìŠ¤??',      g3M ? `?ˆìŒ (${g3M.length}??` : '?†ìŒ');
        console.log('?¤– GPT3 ? ìš©ë¦¬ìŠ¤??',      g3C ? `?ˆìŒ (${g3C.length}??` : '?†ìŒ');
        console.log('?¤– GPT3 ALM:',            g3A ? `?ˆìŒ (${g3A.length}??` : '?†ìŒ');
        console.log('?¤– GPT3 ê¸€ë¡œë²Œë¦¬ìŠ¤??',     g3G ? `?ˆìŒ (${g3G.length}??` : '?†ìŒ');
        console.log('?¤– GPT3 ? ìš©?¬íŠ¸?´ë¦¬??',   g3P ? `?ˆìŒ (${g3P.length}??` : '?†ìŒ');
        
        const gpt4Input = [
          '?¤ìŒ ?•ë³´?¤ì„ ë°”íƒ•?¼ë¡œ ì²´ê³„?ì¸ ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??',
          '\n\n=== GPT0 ?¬ì „?˜ì§‘ ë¶„ì„ ê²°ê³¼ ===',
          '\n[?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´??ë¶„ì„]\n', gpt0MarketDataMain,
          '\n\n[ê¸°ì‚¬?´ìŠ¤ ë¶„ì„]\n', gpt0NewsMain, 
          '\n\n[?œë‚˜ë¦¬ì˜¤ ?”ì•½ë¶„ì„]\n', gpt0ScenarioSummaryMain,

          '\n\n[?„ì¬ ?œí™©ë¶„ì„]\n', gpt0MarketStateMain,
          '\n\n=== GPT3 ?„ë©”?¸ë³„ ?„ë¬¸ ë¶„ì„ ê²°ê³¼ ===',
          '\n[?œì¥ë¦¬ìŠ¤???€ ë¶„ì„]\n', outMarket || 'ë¶„ì„ ê²°ê³¼ ?†ìŒ',
          '\n\n[? ìš©ë¦¬ìŠ¤???€ ë¶„ì„]\n', outCredit || 'ë¶„ì„ ê²°ê³¼ ?†ìŒ',
          '\n\n[ALM ?€ ë¶„ì„]\n', outAlm || 'ë¶„ì„ ê²°ê³¼ ?†ìŒ',
          '\n\n[ê¸€ë¡œë²Œë¦¬ìŠ¤???€ ë¶„ì„]\n', outGlobal || 'ë¶„ì„ ê²°ê³¼ ?†ìŒ',
          '\n\n[? ìš©?¬íŠ¸?´ë¦¬???€ ë¶„ì„]\n', outCreditPf || 'ë¶„ì„ ê²°ê³¼ ?†ìŒ',
          (()=>{ const g=window.gpt3Guidelines||{}; const all=[g.market,g.credit,g.alm,g.global,g.creditpf].filter(Boolean).join('\n'); return all?`\n\n[ì°¸ì¡° ê°€?´ë“œ]\n${all}`:''; })(),
          '\n\n=== ?‘ì„± ?”ì²­ ===',
          '\n??ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥?ì¢…í•©?˜ì—¬ 7ê°??¹ì…˜?¼ë¡œ êµ¬ì„±??ì²´ê³„?ì¸ ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??',
          '\nê°??¹ì…˜?€ ëª…í™•???Œì£¼?œì? ?¨ê»˜ êµ¬ì²´?ì¸ ?°ì´?°ì? ë¶„ì„ ?´ìš©???¬í•¨?´ì•¼ ?©ë‹ˆ??',
          '\n\n=== ì¤‘ìš” ?”êµ¬?¬í•­ ===',
          '\nì¶œë ¥?¸ì–´: ?œêµ­??(ë°˜ë“œ???œêµ­?´ë¡œë§??‘ì„±?˜ë¼)',
          '\në³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.',
          '\në³´ê³ ???•ì‹: ì²´ê³„?ì´ê³??„ë¬¸?ì¸ ë³´ê³ ??,
          '\n?´ìš©: êµ¬ì²´?ì´ê³??¤ìš©?ì¸ ë¶„ì„ ê²°ê³¼?€ ?€??ë°©ì•ˆ'
        ].join('');
        
        // GPT4 ?…ë ¥ êµ¬ì„± ?„ë£Œ ??ë¡œê·¸
        console.log('?“ GPT4 ?…ë ¥ êµ¬ì„± ?„ë£Œ');
        console.log('?“ GPT4 ?…ë ¥ ì´?ê¸¸ì´:', gpt4Input.length);
        console.log('?” GPT4 ?…ë ¥ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 500??:', gpt4Input.substring(0, 500));
        
        try {
          // GPT4 ?œìŠ¤???„ë¡¬?„íŠ¸ ?œì‹œ
          document.getElementById('gpt4-system').value = roles.gpt4_final || '';
          
          console.log('?? GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ?œì‘ (runFrom)');
          const gpt4Output = await generateStepByStepReport(roles.gpt4_final);
          console.log('??GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ?„ë£Œ (runFrom)');
          
          // ??GPT4 ?•ìƒ ?„ë£Œ ???€?´ë¨¸ ì·¨ì†Œ
          if (window.gpt4ForceCompleteTimer) {
            clearTimeout(window.gpt4ForceCompleteTimer);
            window.gpt4ForceCompleteTimer = null;
            console.log('?±ï¸ GPT4 ?•ìƒ ?„ë£Œë¡?100ì´??€?´ë¨¸ ì·¨ì†Œ??);
          }
          
          try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
          if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
          console.log('?“Š GPT4 ì¶œë ¥ ê¸¸ì´:', gpt4Output ? gpt4Output.length : 0);
          
          // ë³´ê³ ???ì—­ ?œì‹œ ë°?ê°•ì¡°
          const reportActions = document.getElementById('report-actions');
          if (reportActions) {
            reportActions.style.display = 'flex';
            reportActions.classList.add('report-actions-cta');
            setTimeout(() => {
              reportActions.classList.remove('report-actions-cta');
            }, 4000);
          }
          
          // ???ˆì „??ì¶œë ¥ ?…ë°?´íŠ¸: ? íš¨??ê²°ê³¼ê°€ ?ˆì„ ?Œë§Œ ?°ê¸°
          if (gpt4Output && gpt4Output.trim().length > 0) {
            document.getElementById('gpt4-output').value = gpt4Output;
            console.log('?“ GPT4 ì¶œë ¥ ?…ë°?´íŠ¸??(runFrom)');
          } else {
            console.log('? ï¸ GPT4 ì¶œë ¥??ë¹„ì–´?ˆìŒ, ?…ë°?´íŠ¸ ê±´ë„ˆ?€ (runFrom)');
            document.getElementById('gpt4-output').value = 'GPT4 ê²°ê³¼ê°€ ë¹„ì–´?ˆìŠµ?ˆë‹¤. ?¤ì‹œ ?œë„?´ì£¼?¸ìš”.';
          }
        } catch (e) {
          console.error('??GPT4 OpenAI API ?¸ì¶œ ?¤íŒ¨:', e);
          document.getElementById('gpt4-output').value = 'GPT4 ?¨ê³„?ì„œ ?¤ë¥˜ê°€ ë°œìƒ?ˆì?ë§??´ì „ ?¨ê³„ ê²°ê³¼??ì¤€ë¹„ë˜?ˆìŠµ?ˆë‹¤.';
        } finally {
          // ??GPT3/4 ê´€???¤í–‰ ?¨ê³¼ ?œê±° (ë°•ìŠ¤ ?¨ê³¼ê°€ ?¨ëŠ” ë¬¸ì œ ?ˆë°©)
          setFlow(null);
          d3.selectAll('.gpt3-anchor-market, .gpt3-anchor-credit, .gpt3-anchor-alm, .gpt3-anchor-global, .gpt3-anchor-creditpf, .gpt4-anchor')
            .classed('agent-running', false);
          document.querySelectorAll('.pipeline-executing').forEach(el => el.classList.remove('pipeline-executing'));
          document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
            .forEach(el => el.classList.remove('running'));
        }

      status.textContent = '?Œì´?„ë¼???„ë£Œ';
      // ëª¨ë“  ?¨ê³¼ ì¢…ë£Œ
      stopAllEffects();
      setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
        
        // ?Œì´?„ë¼???„ë£Œ ?íƒœ ?•ë¦¬
        graphState.pipelineRunning = false;
        graphState.lockedHighlight = null;
        
      } catch (e) {
        console.error('???Œì´?„ë¼???¤í–‰ ì¤??¤ë¥˜:', e);
        status.textContent = `?Œì´?„ë¼???¤íŒ¨: ${e.message}`;
        
        // ?¤ë¥˜ ?œì—???íƒœ ?•ë¦¬
        graphState.pipelineRunning = false;
        graphState.lockedHighlight = null;
        stopAllEffects();
        setRunning([], ['.gpt1-anchor', '.gpt2-anchor', '.gpt3-anchor-market', '.gpt3-anchor-credit', '.gpt3-anchor-alm', '.gpt3-anchor-global', '.gpt3-anchor-creditpf', '.gpt4-anchor']);
      }
    }

    // ====== ?¬ìš©???œë˜ê·?ê°ì? ======
    // ?¤ë¥¸ìª??¨ë„ ?œë˜ê·??¤í¬ë¡?ê°ì?
    function setupDragScrollDetection() {
      const rightPanel = document.getElementById('gpt1-panel');
      if (!rightPanel) return;
      
      let isDragging = false;
      let startY = 0;
      
      rightPanel.addEventListener('mousedown', (e) => {
        if (e.target.closest('textarea') || e.target.closest('button')) return;
        isDragging = true;
        startY = e.clientY;
        window.__userDraggingTab = true;
      });
      
      rightPanel.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaY = Math.abs(e.clientY - startY);
        if (deltaY > 5) { // 5px ?´ìƒ ?€ì§ì????Œë§Œ ?œë˜ê·¸ë¡œ ?¸ì‹
          window.__userDraggingTab = true;
        }
      });
      
      rightPanel.addEventListener('mouseup', () => {
        isDragging = false;
        setTimeout(() => {
          window.__userDraggingTab = false;
        }, 100); // 100ms ???ë™ ?¤í¬ë¡??¬ê°œ
      });
      
      // ?°ì¹˜ ?´ë²¤?¸ë„ ì§€??
      rightPanel.addEventListener('touchstart', (e) => {
        if (e.target.closest('textarea') || e.target.closest('button')) return;
        isDragging = true;
        startY = e.touches[0].clientY;
        window.__userDraggingTab = true;
      });
      
      rightPanel.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const deltaY = Math.abs(e.touches[0].clientY - startY);
        if (deltaY > 5) {
          window.__userDraggingTab = true;
        }
      });
      
      rightPanel.addEventListener('touchend', () => {
        isDragging = false;
        setTimeout(() => {
          window.__userDraggingTab = false;
        }, 100);
      });
    }

    // ====== ?¤ë¥¸ìª????¬ê¸°ì¡°ì • ======
    // ?¤ë¥¸ìª????¬ê¸°ì¡°ì • ?¨ìˆ˜ (?œë˜ê·?ë¦¬ì‚¬?´ì¦ˆ??
    function resizeRightPanel(size) {
      const root = document.documentElement;
      const rightPanel = document.querySelector('.sidebar-right');
      
      switch(size) {
        case 'small':
          root.style.setProperty('--sidebar-width', '300px');
          if (rightPanel) rightPanel.style.width = '300px';
          updateTabSizeDisplay();
          adjustStylesForSize(300);
          console.log('?“ ?¤ë¥¸ìª????¬ê¸°: ?‘ê²Œ (300px)');
          break;
        case 'medium':
          root.style.setProperty('--sidebar-width', '400px');
          if (rightPanel) rightPanel.style.width = '400px';
          updateTabSizeDisplay();
          adjustStylesForSize(400);
          console.log('?“ ?¤ë¥¸ìª????¬ê¸°: ë³´í†µ (400px)');
          break;
        case 'large':
          root.style.setProperty('--sidebar-width', '500px');
          if (rightPanel) rightPanel.style.width = '500px';
          updateTabSizeDisplay();
          adjustStylesForSize(500);
          console.log('?“ ?¤ë¥¸ìª????¬ê¸°: ?¬ê²Œ (500px)');
          break;
        case 'auto':
          root.style.removeProperty('--sidebar-width');
          if (rightPanel) rightPanel.style.width = '400px';
          updateTabSizeDisplay();
          adjustStylesForSize(400);
          console.log('?“ ?¤ë¥¸ìª????¬ê¸°: ?ë™ (ê¸°ë³¸ê°?');
          break;
        default:
          console.log('???˜ëª»???¬ê¸° ?µì…˜:', size);
          return;
      }
      
      // ë¡œì»¬ ?¤í† ë¦¬ì????€??
      localStorage.setItem('rightPanelSize', size);
    }

    // ?˜ì´ì§€ ë¡œë“œ ???€?¥ëœ ?¬ê¸° ë³µì›
    function restoreRightPanelSize() {
      const savedSize = localStorage.getItem('rightPanelSize');
      const rightPanel = document.querySelector('.sidebar-right');
      
      if (savedSize) {
        if (savedSize === 'custom') {
          // ì»¤ìŠ¤?€ ?¬ê¸° ë³µì›
          const customWidth = localStorage.getItem('rightPanelCustomWidth');
          if (customWidth && rightPanel) {
            document.documentElement.style.setProperty('--sidebar-width', `${customWidth}px`);
            rightPanel.style.width = `${customWidth}px`;
            updateTabSizeDisplay();
            adjustStylesForSize(parseInt(customWidth));
            console.log(`?“ ì»¤ìŠ¤?€ ?¬ê¸° ë³µì›: ${customWidth}px`);
          } else {
            // ê¸°ë³¸ê°??¤ì •
            if (rightPanel) rightPanel.style.width = '400px';
            updateTabSizeDisplay();
            adjustStylesForSize(400);
            console.log('?“ ?¤ë¥¸ìª????¬ê¸°: ê¸°ë³¸ê°?(400px)');
          }
        } else {
          resizeRightPanel(savedSize);
        }
      } else {
        // ê¸°ë³¸ê°??¤ì •
        if (rightPanel) rightPanel.style.width = '400px';
        console.log('?“ ?¤ë¥¸ìª????¬ê¸°: ê¸°ë³¸ê°?(400px)');
      }
    }

    // ?œë˜ê·?ë¦¬ì‚¬?´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°??- ?œê±°??
    function initializeDragResize() {
      // ?œë˜ê·?ë¦¬ì‚¬?´ì¦ˆ ê¸°ëŠ¥???œê±°?˜ì–´ ë¹??¨ìˆ˜ë¡?? ì?
      console.log('?”§ ?œë˜ê·?ë¦¬ì‚¬?´ì¦ˆ ê¸°ëŠ¥???œê±°?˜ì—ˆ?µë‹ˆ??);
    }

    // ?„ì¬ ?ˆë¹„??ë§ëŠ” ?¬ê¸° ?¸ì‹
    function updateButtonStateByWidth(width) {
      let size = 'custom';
      if (width <= 300) size = 'small';
      else if (width <= 400) size = 'medium';
      else if (width <= 500) size = 'large';
      
      console.log(`?“ ?„ì¬ ?¬ê¸° ?¸ì‹: ${size} (${width}px)`);
    }

          // ì´ˆê¸°???¨ìˆ˜
      function resetRightPanelSize() {
        // ì»¤ìŠ¤?€ ?¬ê¸° ?œê±°?˜ê³  ê¸°ë³¸ê°’ìœ¼ë¡?ë³µì›
        localStorage.removeItem('rightPanelCustomWidth');
        localStorage.removeItem('rightPanelSize');
        
        // ê¸°ë³¸ ?¬ê¸°ë¡??¤ì •
        document.documentElement.style.removeProperty('--sidebar-width');
        const rightPanel = document.querySelector('.sidebar-right');
        if (rightPanel) rightPanel.style.width = '400px';
        updateTabSizeDisplay();
        adjustStylesForSize(400);
        
        console.log('?“ ?¤ë¥¸ìª????¬ê¸° ì´ˆê¸°???„ë£Œ');
      }

      // ???¬ê¸° ì¡°ì • ?¨ìˆ˜??
      function increaseTabSize() {
        const rightPanel = document.querySelector('.sidebar-right');
        const sizeDisplay = document.getElementById('tab-size-display');
        
        if (rightPanel && sizeDisplay) {
          const currentWidth = parseInt(getComputedStyle(rightPanel).width) || 400;
          const newWidth = Math.min(800, currentWidth + 50);
          
          rightPanel.style.width = `${newWidth}px`;
          document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
          sizeDisplay.textContent = `${newWidth}px`;
          
          // ?™ì  ?¤í???ì¡°ì •
          adjustStylesForSize(newWidth);
          
          // ë¡œì»¬ ?¤í† ë¦¬ì????€??
          localStorage.setItem('rightPanelCustomWidth', newWidth);
          localStorage.setItem('rightPanelSize', 'custom');
          
          console.log(`?“ ???¬ê¸° ì¦ê?: ${currentWidth}px ??${newWidth}px`);
        }
      }

      function decreaseTabSize() {
        const rightPanel = document.querySelector('.sidebar-right');
        const sizeDisplay = document.getElementById('tab-size-display');
        
        if (rightPanel && sizeDisplay) {
          const currentWidth = parseInt(getComputedStyle(rightPanel).width) || 400;
          const newWidth = Math.max(250, currentWidth - 50);
          
          rightPanel.style.width = `${newWidth}px`;
          document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
          sizeDisplay.textContent = `${newWidth}px`;
          
          // ?™ì  ?¤í???ì¡°ì •
          adjustStylesForSize(newWidth);
          
          // ë¡œì»¬ ?¤í† ë¦¬ì????€??
          localStorage.setItem('rightPanelCustomWidth', newWidth);
          localStorage.setItem('rightPanelSize', 'custom');
          
          console.log(`?“ ???¬ê¸° ê°ì†Œ: ${currentWidth}px ??${newWidth}px`);
        }
      }

      // ???¬ê¸° ?œì‹œ ?…ë°?´íŠ¸ ?¨ìˆ˜
      function updateTabSizeDisplay() {
        const rightPanel = document.querySelector('.sidebar-right');
        const sizeDisplay = document.getElementById('tab-size-display');
        
        if (rightPanel && sizeDisplay) {
          const currentWidth = parseInt(getComputedStyle(rightPanel).width) || 400;
          sizeDisplay.textContent = `${currentWidth}px`;
        }
      }

      // ???¬ê¸°???°ë¥¸ ?™ì  ?¤í???ì¡°ì • ?¨ìˆ˜
      function adjustStylesForSize(width) {
        const rightPanel = document.querySelector('.sidebar-right');
        if (!rightPanel) return;

        // ?œëª© ?¬ê¸° ì¡°ì •
        const titles = rightPanel.querySelectorAll('h4');
        titles.forEach(title => {
          if (width >= 700) {
            title.style.fontSize = '20px';
          } else if (width >= 600) {
            title.style.fontSize = '18px';
          } else if (width >= 500) {
            title.style.fontSize = '16px';
          } else {
            title.style.fontSize = '14px';
          }
        });

        // ì¹´ë“œ ?¨ë”© ì¡°ì •
        const cards = rightPanel.querySelectorAll('.agent-card');
        cards.forEach(card => {
          if (width >= 700) {
            card.style.padding = '20px';
          } else if (width >= 600) {
            card.style.padding = '18px';
          } else if (width >= 500) {
            card.style.padding = '16px';
          } else {
            card.style.padding = '14px';
          }
        });

        // ?ìŠ¤???ì—­ ?¬ê¸° ì¡°ì •
        const textareas = rightPanel.querySelectorAll('textarea');
        textareas.forEach(textarea => {
          if (width >= 700) {
            textarea.style.fontSize = '18px';
            textarea.style.padding = '10px';
          } else if (width >= 600) {
            textarea.style.fontSize = '16px';
            textarea.style.padding = '8px';
          } else if (width >= 500) {
            textarea.style.fontSize = '14px';
            textarea.style.padding = '6px';
          } else {
            textarea.style.fontSize = '13px';
            textarea.style.padding = '6px';
          }
        });

        // ë³µì‚¬ ë²„íŠ¼ ?¬ê¸° ì¡°ì •
        const copyBtns = rightPanel.querySelectorAll('.copy-btn');
        copyBtns.forEach(btn => {
          if (width >= 700) {
            btn.style.fontSize = '14px';
            btn.style.padding = '8px 14px';
          } else if (width >= 600) {
            btn.style.fontSize = '13px';
            btn.style.padding = '7px 12px';
          } else if (width >= 500) {
            btn.style.fontSize = '12px';
            btn.style.padding = '6px 10px';
          } else {
            btn.style.fontSize = '11px';
            btn.style.padding = '5px 8px';
          }
        });

        // PPT?ì„±, ë³´ê³ ?œìƒ??ë²„íŠ¼ ?¬ê¸° ì¡°ì •
        const actionBtns = rightPanel.querySelectorAll('.action-btn');
        actionBtns.forEach(btn => {
          if (width >= 700) {
            btn.style.fontSize = '16px';
            btn.style.padding = '14px 20px';
          } else if (width >= 600) {
            btn.style.fontSize = '15px';
            btn.style.padding = '12px 18px';
          } else if (width >= 500) {
            btn.style.fontSize = '14px';
            btn.style.padding = '10px 16px';
          } else {
            btn.style.fontSize = '13px';
            btn.style.padding = '8px 14px';
          }
        });

        // ?„ë¡¬?„íŠ¸ ?ìŠ¤???¬ê¸° ì¡°ì •
        const promptTexts = rightPanel.querySelectorAll('.prompt-text');
        promptTexts.forEach(text => {
          if (width >= 700) {
            text.style.fontSize = '15px';
          } else if (width >= 600) {
            text.style.fontSize = '14px';
          } else if (width >= 500) {
            text.style.fontSize = '13px';
          } else {
            text.style.fontSize = '12px';
          }
        });

        console.log(`?¨ ?¤í???ì¡°ì • ?„ë£Œ: ${width}px`);
      }

    // ====== ?¬í›„ ê²€ì¦?+ ?ë™ë³´ê°• ?¨ìˆ˜ ======
    function enforceEvidence(report, sources) {
      const need = [
        ['?œì¥ ë¦¬ìŠ¤??,'MARKET', sources.market],
        ['? ìš© ë¦¬ìŠ¤??,'CREDIT', sources.credit],
        ['ALM','ALM', sources.alm],
        ['ê¸€ë¡œë²Œ ë¦¬ìŠ¤??,'GLOBAL', sources.global],
        ['? ìš©?¬íŠ¸?´ë¦¬??,'CREDITPF', sources.creditpf],
      ];
      let out = String(report||'');
      
      for(const [label, key, src] of need){
        const hasSec = new RegExp(`###\\s*${label}\\b`).test(out);
        if(!hasSec){
          out += `\n\n### ${label}\n${(src||'?ë£Œ ë¶€ì¡?).slice(0,1200)}`;
          continue;
        }
        
        // ?•ëŸ‰ì¹?3ê°?ë¯¸ë§Œ?´ë©´ ?ë¬¸?ì„œ ?«ì 3ê°œë? ë¶ˆë¦¿?¼ë¡œ ë³´ê°•
        const secRe = new RegExp(`(###\\s*${label}[\\s\\S]*?)(?=\\n###|$)`);
        const m = out.match(secRe);
        if(m){
          const body = m[1];
          const nNums = (body.match(/([+-]?[0-9][0-9.,]*\\s?(?:bp|%|ì¡°ì›|?µì›|ë°???)/g)||[]).length;
          if(nNums<3){
            const picks = (String(src||'').match(/([+-]?[0-9][0-9.,]*\\s?(?:bp|%|ì¡°ì›|?µì›|ë°???)/g)||[]).slice(0,3);
            if(picks.length){
              out = out.replace(secRe, `${body}\n\n- ë³´ê°• ?˜ì¹˜: ${picks.join(', ')} [ê·¼ê±°: ?ë¬¸]`);
            }
          }
        }
      }
      return out;
    }

    // ====== GPT4 ?ì§„??ë³´ê³ ???‘ì„± (?œì°¨ ì²˜ë¦¬) ======
    async function generateStepByStepReport(systemPrompt) {
      try {
        console.log('?“‹ GPT4 ?ì§„??ë³´ê³ ???‘ì„± ?œì‘');
        
        // DOM ?”ì†Œ ?•ì¸
        const gpt4OutputElement = document.getElementById('gpt4-output');
        if (!gpt4OutputElement) {
          throw new Error('GPT4 ì¶œë ¥ ?”ì†Œë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤');
        }
        
        // ì´ˆê¸° ?íƒœ ?¤ì •
        gpt4OutputElement.value = '?“‹ GPT4 ë³´ê³ ???ì„± ì¤?..\n\n?¨ê³„ë³„ë¡œ ì§„í–‰?©ë‹ˆ?? ? ì‹œë§?ê¸°ë‹¤?¤ì£¼?¸ìš”.';
        
        // ?…ë ¥ ?˜ì§‘
        const gpt0ScenarioSummary = (document.getElementById('gpt0-scenario-summary').value || '').trim();
        const gpt0MarketData = (document.getElementById('gpt0-marketdata').value || '').trim();
        const gpt0News = (document.getElementById('gpt0-news').value || '').trim();
        const gpt0MarketState = (document.getElementById('gpt0-marketstate').value || '').trim();
        const gpt1Output = (document.getElementById('gpt1-output').value || '').trim();
        const gpt2Output = (document.getElementById('gpt2-output').value || '').trim();
        
        // ??GPT3 ?…ë ¥ ?•ì‹¤???˜ì§‘ (?„ì† ?¨ê³„?ì„œ ë°˜ë“œ???¬ìš©)
        /* DOM ???„ì—­ ??GPT2?ë³¸ ???´ë°± */
        const G3 = window.globalGpt3Outputs || {};
        const G2 = window.globalGpt2DomainOutputs || {};

        const g3Market   = (document.getElementById('gpt3-market')?.value   || G3.market   || G2.market   || '').trim();
        const g3Credit   = (document.getElementById('gpt3-credit')?.value   || G3.credit   || G2.credit   || '').trim();
        const g3Alm      = (document.getElementById('gpt3-alm')?.value      || G3.alm      || G2.alm      || '').trim();
        const g3Global   = (document.getElementById('gpt3-global')?.value   || G3.global   || G2.global   || '').trim();
        const g3CreditPf = (document.getElementById('gpt3-creditpf')?.value || G3.creditpf || G2.creditpf || '').trim();

        /* GPT3 ?…ë ¥??ëª¨ë‘ ë¹„ë©´ ìµœì†Œ ?€ì²??ì„±(??ë²ˆë§Œ) */
        if (![g3Market,g3Credit,g3Alm,g3Global,g3CreditPf].some(Boolean) && !window.__g3FallbackTried) {
          window.__g3FallbackTried = true;
          try {
            const roles = await loadRiskAgentRoles();
            const G2 = window.globalGpt2DomainOutputs || {};
            const [fm,fc,fa,fg,fp] = await Promise.all([
              callOpenAIWithOptions(roles.gpt3_market,   G2.market   || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_credit,   G2.credit   || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_alm,      G2.alm      || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_global,   G2.global   || '', { timeoutMs: 1200000 }),
              callOpenAIWithOptions(roles.gpt3_creditpf, G2.creditpf || '', { timeoutMs: 1200000 })
            ]);
            window.globalGpt3Outputs = {
              market:(fm||'').trim(), credit:(fc||'').trim(), alm:(fa||'').trim(),
              global:(fg||'').trim(), creditpf:(fp||'').trim()
            };
          } catch(e){ console.warn('g3 ?€ì²´ìƒ???¤íŒ¨', e); }
        }

        // ====== ?ì§„??GPT4 ì¡°ë¦½ ë¡œì§ ?œì‘ ======
        console.log('?? ?ì§„??GPT4 ì¡°ë¦½ ë¡œì§ ?ìš©');
        
        // 1?¨ê³„: GPT0 ?œë‘ ?”ì•½ ?ì„± ë°?ì²?ë²ˆì§¸ GPT ?¸ì¶œ
        console.log('?“ 1?¨ê³„: GPT0 ?œë‘ ?ì„± ì¤?..');
        gpt4OutputElement.value = '?“ 1?¨ê³„: ?œì¥ ?í™© ë°??œë‚˜ë¦¬ì˜¤ ?œë‘ ?ì„± ì¤?..\n\n??GPT0 ?°ì´???”ì•½ ì²˜ë¦¬ ì¤?;
        
        const introText = await generateGpt4IntroSection({
          market: gpt0MarketData,
          scenario: gpt0ScenarioSummary, 
          news: gpt0News,
          state: gpt0MarketState
        });
        
        // 1?¨ê³„ ê²°ê³¼ ?œì‹œ
        gpt4OutputElement.value = `??1?¨ê³„ ?„ë£Œ: ?œë‘ ?ì„±\n\n${introText}\n\n` + 
                                  '?“ 2?¨ê³„: ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ?ì„± ì¤?..';
        
        // 2?¨ê³„: GPT2 ?”ì†Œë³??•ê·œ??ë°???ë²ˆì§¸ GPT ?¸ì¶œ
        console.log('?“ 2?¨ê³„: GPT2 ?”ì†Œë³?ë¶„ì„ ì¤?..');
        const gpt2ProcessedText = await generateGpt4ElementSection(gpt2Output);
        
        // 2?¨ê³„ ê²°ê³¼ ì¶”ê?
        gpt4OutputElement.value = `??1?¨ê³„ ?„ë£Œ: ?œë‘\n\n${introText}\n\n` +
                                  `??2?¨ê³„ ?„ë£Œ: ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ê²°ê³¼\n\n${gpt2ProcessedText}\n\n` +
                                  '?“ 3?¨ê³„: ?„ë©”?¸ë³„ ?¬ì¸µ ë¶„ì„ ?ì„± ì¤?..';
        
        // 3?¨ê³„: GPT3 ?¥ë‹¤?´ë¸Œ ë°???ë²ˆì§¸ GPT ?¸ì¶œ
        console.log('?“ 3?¨ê³„: GPT3 ?¥ë‹¤?´ë¸Œ ë¶„ì„ ì¤?..');
        const gpt3ProcessedText = await generateGpt4DeepDiveSection({
          market: g3Market,
          credit: g3Credit,
          alm: g3Alm,
          global: g3Global,
          creditpf: g3CreditPf
        });
        
        // ??4?¨ê³„(?¬ìš”?? ê±´ë„ˆ?€: ?”ì•½3ê¹Œì?ë§?ê²°í•©?´ì„œ ìµœì¢… ê²°ê³¼ë¡??¬ìš©
        console.log('??¸ GPT4 4?¨ê³„(?¬ìš”?? ê±´ë„ˆ?€ - ?”ì•½3ê¹Œì?ë§??¬ìš©');

        // 1~3?¨ê³„ ê²°ê³¼ë¥?ì§ì ‘ ê²°í•©?˜ì—¬ ìµœì¢… ê²°ê³¼ë¡??¬ìš©
        const combined = [
          '=== 1. ?œë‘ ===',
          introText || '',
          '',
          '=== 2. ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ===',
          gpt2ProcessedText || '',
          '',
          '=== 3. ?„ë©”?¸ë³„ ?¬ì¸µ ë¶„ì„ ===',
          gpt3ProcessedText || ''
        ].join('\n');

        // ìµœì¢… ê²°ê³¼ ?œì‹œ
        gpt4OutputElement.value = combined;
        
        console.log('??GPT4 ?ì§„??ë³´ê³ ???‘ì„± ?„ë£Œ');
        try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
        if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
        return combined;
      } catch (error) {
        console.error('??GPT4 ?µí•© ë³´ê³ ???‘ì„± ?¤íŒ¨:', error);
        // ???¤ë¥˜ ?œì—??ë¹?ë¬¸ì???€???˜ë??ˆëŠ” ë©”ì‹œì§€ ë°˜í™˜
        return `GPT4 ?µí•© ë³´ê³ ???‘ì„± ì¤??¤ë¥˜ ë°œìƒ: ${error.message}\n\n?´ì „ ?¨ê³„??ë¶„ì„ ê²°ê³¼??ê°???—???•ì¸?˜ì‹¤ ???ˆìŠµ?ˆë‹¤.`;
      }
    }

    // ====== GPT3 ê²°ê³¼ ê¸¸ì´ ?•ì¸ ?”ë²„ê·??¨ìˆ˜ ======
    window.checkGpt3Results = function() {
      console.log('?” GPT3 ?„ë©”?¸ë³„ ê²°ê³¼ ê¸¸ì´ ?•ì¸:');
      ['market','credit','alm','global','creditpf'].forEach(k=>{
        const v = (document.getElementById('gpt3-'+k).value||'').trim();
        const status = v.length < 50 ? '???ˆë¬´ ì§§ìŒ' : v.length < 200 ? '? ï¸ ì§§ìŒ' : '???•ìƒ';
        console.log(`${k}: ${v.length}??${status}`);
        if (v.length < 50) {
          console.log(`  ?´ìš©: "${v.substring(0, 100)}..."`);
        }
      });
    };

    // ====== ìµœì¢… ë³´ê³ ???¹ì…˜ ?•ì¸ ?”ë²„ê·??¨ìˆ˜ ======
    window.checkFinalReportSections = function() {
      console.log('?” ìµœì¢… ë³´ê³ ???¹ì…˜ ?•ì¸:');
      const report = (document.getElementById('gpt4-output').value||'').trim();
      const sections = ['?œì¥ë¦¬ìŠ¤??, '? ìš©ë¦¬ìŠ¤??, 'ALM', 'ê¸€ë¡œë²Œë¦¬ìŠ¤??, '? ìš©?¬íŠ¸?´ë¦¬??];
      sections.forEach(section => {
        const regex = new RegExp(`###\\s*${section}\\b`, 'i');
        const found = regex.test(report);
        console.log(`${section}: ${found ? '??ì¡´ì¬' : '???„ë½'}`);
      });
      console.log(`ì´?ë³´ê³ ??ê¸¸ì´: ${report.length}??);
    };

    // 1?¨ê³„: ?œë‚˜ë¦¬ì˜¤ ?•ë³´ ë¶„ì„ ë³´ê³ ??
    async function generateScenarioSection(systemPrompt) {
      try {
        const gpt0ScenarioSummary = document.getElementById('gpt0-scenario-summary').value || '';
        const gpt1Output = document.getElementById('gpt1-output').value || '';
        const gpt2Output = document.getElementById('gpt2-output').value || '';
        
        const prompt = `?œë‚˜ë¦¬ì˜¤ ?•ë³´ë¥?ë¶„ì„?˜ì—¬ ?¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[?œë‚˜ë¦¬ì˜¤ ?•ë³´]
- ?œë‚˜ë¦¬ì˜¤ ?”ì•½: ${gpt0ScenarioSummary}
- GPT1 ì¢…í•© ë¶„ì„: ${gpt1Output}
- GPT2 WORST ?œë‚˜ë¦¬ì˜¤: ${gpt2Output}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?œë‚˜ë¦¬ì˜¤???µì‹¬ ?´ìš©, ë¦¬ìŠ¤???”ì¸, ?„ê°œ ë°©í–¥???•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('?œë‚˜ë¦¬ì˜¤ ?¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return '?œë‚˜ë¦¬ì˜¤ ?•ë³´ ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 2?¨ê³„: ë§ˆì¼“?°ì´??ë°??œì¥?•ë³´ ë¶„ì„ ë³´ê³ ??
    async function generateMarketSection(systemPrompt) {
      try {
        const gpt0MarketData = document.getElementById('gpt0-marketdata').value || '';
        const gpt0MarketState = document.getElementById('gpt0-marketstate').value || '';
        
        const prompt = `ë§ˆì¼“?°ì´??ë°??œì¥?•ë³´ë¥?ë¶„ì„?˜ì—¬ ?¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[?„ì¬ ?œì¥?í™©]
- ?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´?? ${gpt0MarketData}
- ?„ì¬ ?œí™©ë¶„ì„: ${gpt0MarketState}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?„ì¬ ?œì¥ ?í™©, ì£¼ìš” ì§€???™í–¥, ?œì¥ ë¦¬ìŠ¤???”ì¸???•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ë§ˆì¼“ ?¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return 'ë§ˆì¼“?°ì´??ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 3?¨ê³„: ê´€?¨ë‰´??ë¶„ì„ ë³´ê³ ??
    async function generateNewsSection(systemPrompt) {
      try {
        const gpt0News = document.getElementById('gpt0-news').value || '';
        
        const prompt = `ê´€?¨ë‰´?¤ë? ë¶„ì„?˜ì—¬ ?¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[ê´€?¨ë‰´??ë¶„ì„]
- ê¸°ì‚¬?´ìŠ¤ ?”ì•½: ${gpt0News}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?´ìŠ¤???µì‹¬ ?´ìš©, ?œë‚˜ë¦¬ì˜¤?€???°ê??? ë¦¬ìŠ¤???¸ë¦¬ê±??”ì¸???•ë¦¬?˜ì—¬ 2-3ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('?´ìŠ¤ ?¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return '?´ìŠ¤ ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 4?¨ê³„: ?œì¥ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??
    async function generateMarketRiskSection(systemPrompt) {
      try {
        const gpt3Market = document.getElementById('gpt3-market').value || '';
        
        const prompt = `?œì¥ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ë¥??¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[?œì¥ë¦¬ìŠ¤??ë¶„ì„]
- GPT3 ?œì¥ë¦¬ìŠ¤??ê²°ê³¼: ${gpt3Market}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?€???„í™©, ?œë‚˜ë¦¬ì˜¤ ?í–¥?? ?€?‘ì „?µì„ ?•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('?œì¥ë¦¬ìŠ¤???¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return '?œì¥ë¦¬ìŠ¤??ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 5?¨ê³„: ? ìš©ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??
    async function generateCreditRiskSection(systemPrompt) {
      try {
        const gpt3Credit = document.getElementById('gpt3-credit').value || '';
        
        const prompt = `? ìš©ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ë¥??¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[? ìš©ë¦¬ìŠ¤??ë¶„ì„]
- GPT3 ? ìš©ë¦¬ìŠ¤??ê²°ê³¼: ${gpt3Credit}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?€???„í™©, ?œë‚˜ë¦¬ì˜¤ ?í–¥?? ?€?‘ì „?µì„ ?•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('? ìš©ë¦¬ìŠ¤???¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return '? ìš©ë¦¬ìŠ¤??ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 6?¨ê³„: ALM ë¶„ì„ ë³´ê³ ??
    async function generateAlmSection(systemPrompt) {
      try {
        const gpt3Alm = document.getElementById('gpt3-alm').value || '';
        
        const prompt = `ALM ë¶„ì„ ê²°ê³¼ë¥??¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[ALM ë¶„ì„]
- GPT3 ALM ê²°ê³¼: ${gpt3Alm}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?€???„í™©, ?œë‚˜ë¦¬ì˜¤ ?í–¥?? ?€?‘ì „?µì„ ?•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ALM ?¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return 'ALM ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 7?¨ê³„: ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??
    async function generateGlobalRiskSection(systemPrompt) {
      try {
        const gpt3Global = document.getElementById('gpt3-global').value || '';
        
        const prompt = `ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ë¥??¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„]
- GPT3 ê¸€ë¡œë²Œë¦¬ìŠ¤??ê²°ê³¼: ${gpt3Global}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?€???„í™©, ?œë‚˜ë¦¬ì˜¤ ?í–¥?? ?€?‘ì „?µì„ ?•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ê¸€ë¡œë²Œë¦¬ìŠ¤???¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return 'ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ?¤íŒ¨';
      }
    }

    // 8?¨ê³„: ? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ë³´ê³ ??
    async function generateCreditPortfolioSection(systemPrompt) {
      try {
        const gpt3CreditPf = document.getElementById('gpt3-creditpf').value || '';
        
        const prompt = `? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ê²°ê³¼ë¥??¤ìŒ êµ¬ì¡°ë¡?ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„]
- GPT3 ? ìš©?¬íŠ¸?´ë¦¬??ê²°ê³¼: ${gpt3CreditPf}

???•ë³´ë¥?ë°”íƒ•?¼ë¡œ ?€???„í™©, ?œë‚˜ë¦¬ì˜¤ ?í–¥?? ?€?‘ì „?µì„ ?•ë¦¬?˜ì—¬ 3-4ë¬¸ë‹¨?¼ë¡œ ?‘ì„±?˜ì„¸??
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('? ìš©?¬íŠ¸?´ë¦¬???¹ì…˜ ?ì„± ?¤íŒ¨:', error);
        return '? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ?¤íŒ¨';
      }
    }

    // ìµœì¢… ?µí•© ë³´ê³ ???‘ì„±
    async function generateFinalIntegrationReport(systemPrompt, ...sectionReports) {
      try {
        const prompt = `ê°??¨ê³„ë³„ë¡œ ?‘ì„±??ë³´ê³ ?œë“¤???µí•©?˜ì—¬ ìµœì¢… ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

[?¨ê³„ë³?ë¶„ì„ ê²°ê³¼]
1. ?œë‚˜ë¦¬ì˜¤ ?•ë³´: ${sectionReports[0]}
2. ë§ˆì¼“?°ì´??ë°??œì¥?•ë³´: ${sectionReports[1]}
3. ê´€?¨ë‰´?? ${sectionReports[2]}
4. ?œì¥ë¦¬ìŠ¤?? ${sectionReports[3]}
5. ? ìš©ë¦¬ìŠ¤?? ${sectionReports[4]}
6. ALM: ${sectionReports[5]}
7. ê¸€ë¡œë²Œë¦¬ìŠ¤?? ${sectionReports[6]}
8. ? ìš©?¬íŠ¸?´ë¦¬?? ${sectionReports[7]}

??8ê°??¹ì…˜??ì¢…í•©?˜ì—¬ ?¤ìŒ êµ¬ì¡°??ì²´ê³„?ì¸ ë³´ê³ ?œë? ?‘ì„±?˜ì„¸??

## ?Œì£¼?œë³„ êµ¬ì„±
1. [?œë‚˜ë¦¬ì˜¤ ?•ë³´] ?œë‚˜ë¦¬ì˜¤ ë¶„ì„, ?„ì¬?í™©, ?„ê¸°?í™©ë¶„ì„ ?œë??ˆì´??ê°€??(?•ëŸ‰??ì¶©ê²© ?œë‚˜ë¦¬ì˜¤ ?˜ì¹˜ ?¬í•¨)
2. [?„ì¬ ?œì¥?í™©] ë§ˆì¼“?°ì´??ë°??œí™© ë¶„ì„ ?”ì•½
3. [?„ê¸°?í™© ë¶„ì„] WORST ?œë‚˜ë¦¬ì˜¤ ë°??„ê°œë°©í–¥ (êµ¬ì²´??ë³€???˜ì¹˜ ?¬í•¨)

## ë³¸ë¬¸ - ëª¨ë“ˆë³??„ê¸°?í™© ?œë??ˆì´??
4. [?œì¥ë¦¬ìŠ¤?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(VaR, P&L, ë¯¼ê°?? ???€?‘ëª©??
5. [? ìš©ë¦¬ìŠ¤?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(ë¶€?„ìœ¨, ?ì‹¤?? ECL) ???€?‘ëª©??
6. [?ì‚°ë¶€ì±„ê?ë¦? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(NIM, ? ë™?±ë¹„?? BPë³€?? ???€?‘ëª©??
7. [ê¸€ë¡œë²Œë¦¬ìŠ¤?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(?˜ì†?? ?µìŠ¤?¬ì?, CDS) ???€?‘ëª©??
8. [? ìš©?¬íŠ¸?´ë¦¬?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(?ì‹¤?? ì§‘ì¤‘?? HHI) ???€?‘ëª©??

## ìµœì¢… ?•ë¦¬
9. [ì¢…í•© ?í–¥???‰ê?] ëª¨ë“  ëª¨ë“ˆ???•ëŸ‰???í–¥?„ë? ?µí•© (ì´??ì‹¤?? RWA ì¦ê?, ?ë³¸ë¹„ìœ¨ ë³€??ì¶”ì •)
10. [?µí•© ?€?‘ì „?? ?„ì‚¬ ì°¨ì› ?•ëŸ‰??ëª©í‘œì¹˜ì? ?°ì„ ?œìœ„
11. [ê²°ë¡  ë°?ê¶Œê³ ?¬í•­] ?µì‹¬ ?•ëŸ‰ì§€??ë°?ê²½ì˜ì§??¡ì…˜?„ì´??

??ëª¨ë“  ?¹ì…˜?ì„œ êµ¬ì²´???˜ì¹˜, ê¸ˆì•¡, ?¼ì„¼?? BP ???•ëŸ‰??ë¶„ì„ê²°ê³¼ë¥?ëª…ì‹œ?˜ë¼.
ì¶œë ¥?¸ì–´: ?œêµ­?? ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. (ë°˜ë“œ???œêµ­?´ë¡œë§??‘ì„±?˜ë¼)
ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.`;

        const result = await callOpenAI(systemPrompt, prompt);
        return result;
      } catch (error) {
        console.error('ìµœì¢… ?µí•© ë³´ê³ ???ì„± ?¤íŒ¨:', error);
        return 'ìµœì¢… ?µí•© ë³´ê³ ???ì„± ?¤íŒ¨';
      }
    }

    // ?”’ ?ˆì „??OpenAI ?„ë¡???¸ì¶œ (Netlify Functions ?„ìš©) + ë¡œì»¬ ?€ì²?ê²½ë¡œ
    async function callOpenAI(systemPrompt, userContent = {}, retryCount = 0) {
      // ?„ë¡?œë? ?µí•œ ?ˆì „???”ì²­ (API ?¤ëŠ” ?œë²„?ì„œë§??¬ìš©)
      const body = {
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt || 'You are a helpful assistant.' },
          { role: 'user', content: userContent }
        ],
        max_tokens: 16000,  // ì¶©ë¶„??? í° ? ë‹¹ (GPT0 ê¸??‘ë‹µ ?€??
        temperature: 0.1
      };
      
      console.log('?”„ ?ˆì „??OpenAI ?„ë¡???¸ì¶œ ?œì‘...', retryCount > 0 ? `(?¬ì‹œ??${retryCount}/3)` : '');
      
      // AbortControllerë¡??€?„ì•„??ì²˜ë¦¬ (600ì´?= 10ë¶„ìœ¼ë¡??°ì¥)
      const controller = new AbortController();
      const timeoutMs = 600000; // 10ë¶??€?„ì•„??(ê¸??‘ë‹µ ?€??
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
      
      let data;
      try {
        // 1) ?„ë¡???°ì„  ?œë„ (?„í–‰ ? ì?)
        const resp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
            // Authorization ?¤ë” ?†ìŒ - ?œë²„?ì„œ ?˜ê²½ë³€???¬ìš©
          },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!resp.ok) {
          const errData = await resp.json().catch(() => ({ error:'Unknown error' }));
          // 404, MISSING_API_KEY, ?œë²„?¤ë¥˜ ?±ì? "?€ì²?ê²½ë¡œ"ë¡??˜ê?
          throw Object.assign(new Error(`proxy_error_${resp.status}`), { code: errData.code || 'PROXY_ERROR', status: resp.status });
        }
        data = await resp.json();
      } catch (proxyErr) {
        clearTimeout(timeoutId);
        console.warn('? ï¸ ?„ë¡???¤íŒ¨, ë¡œì»¬ ?€ì²?ê²½ë¡œ ?œë„:', proxyErr);

        // 2) ë¡œì»¬ ê°œë°œ ?„ìš©: localStorage ?¤ê? ?ˆìœ¼ë©?OpenAI ì§ì ‘ ?¸ì¶œ(?ŒìŠ¤?¸ìš©)
        try {
          const localKey = (localStorage && localStorage.getItem('openai_api_key')) || '';
          if (!localKey) throw new Error('NO_LOCAL_KEY');

          const direct = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                { role:'system', content: systemPrompt || 'You are a helpful assistant.' },
                { role:'user',   content: userContent }
              ],
              max_tokens: 16000,
              temperature: 0.1
            })
          });
          if (!direct.ok) throw new Error(`DIRECT_${direct.status}`);
          data = await direct.json();
        } catch (directErr) {
          console.error('???„ë¡??ì§ì ‘ ëª¨ë‘ ?¤íŒ¨:', directErr);
          
          // ?¬ì‹œ??ë¡œì§: ìµœë? 3?Œê¹Œì§€ ?¬ì‹œ??
          if (retryCount < 3) {
            console.log(`?”„ ${retryCount + 1}ì´????¬ì‹œ??.. (${retryCount + 1}/3)`);
            await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 2000)); // ?ì§„???€ê¸?(2ì´? 4ì´? 6ì´?
            return await callOpenAI(systemPrompt, userContent, retryCount + 1);
          }
          
          // ìµœì¢… ?¤íŒ¨ ???ìœ„?ì„œ ë¹??‘ë‹µ ì²˜ë¦¬ ê°€?¥í•˜?„ë¡ ë¹?ë¬¸ì??ë°˜í™˜
          console.error('??ìµœì¢… ?¤íŒ¨: 3???¬ì‹œ???„ì—???¤íŒ¨');
          return '';
        }
      }

      // ê³µí†µ ?Œì‹±
      const outputText =
        data?.choices?.[0]?.message?.content ||
        data?.output_text ||
        data?.response?.[0]?.content?.[0]?.text ||
        '';
      return (outputText || '').trim();
    }

    // ====== ?„ë¡???ê? ? í‹¸ë¦¬í‹° ======
    
    // ê°„ë‹¨??GPT3 ?ŒìŠ¤???¨ìˆ˜ (?”ë²„ê¹…ìš©)
    async function testGpt3Simple() {
      console.log('?§ª GPT3 ê°„ë‹¨ ?ŒìŠ¤???œì‘...');
      
      try {
        // 1. ê¸°ë³¸ ?„ë¡¬?„íŠ¸ë¡?ê°„ë‹¨???ŒìŠ¤??
        const testPrompt = "?ˆë…•?˜ì„¸?? ê°„ë‹¨???ŒìŠ¤?¸ì…?ˆë‹¤. '?ŒìŠ¤???±ê³µ'?´ë¼ê³??‘ë‹µ?´ì£¼?¸ìš”.";
        const result = await callOpenAI("You are a helpful assistant.", testPrompt);
        
        console.log('??GPT3 ?ŒìŠ¤??ê²°ê³¼:', result);
        
        // 2. ê²°ê³¼ë¥?ì²?ë²ˆì§¸ GPT3 ë°•ìŠ¤???œì‹œ
        const el = document.getElementById('gpt3-market');
        if (el) {
          el.value = result || '?ŒìŠ¤???¤íŒ¨: ?‘ë‹µ ?†ìŒ';
          console.log('??GPT3 ë°•ìŠ¤??ê²°ê³¼ ?œì‹œ ?„ë£Œ');
        } else {
          console.error('??gpt3-market ?”ì†Œë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤');
        }
        
        return result;
      } catch (error) {
        console.error('??GPT3 ?ŒìŠ¤???¤íŒ¨:', error);
        return null;
      }
    }
    
    // OpenAI ?„ë¡???íƒœ ?ê? ?¨ìˆ˜
    async function testOpenAIProxy() {
      console.log('?” OpenAI ?„ë¡???íƒœ ?ê? ?œì‘...');
      
      try {
        const resp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'You are a helpful assistant.' },
              { role: 'user', content: 'Hello' }
            ],
            max_tokens: 10,
            temperature: 0.1
          })
        });
        
        if (resp.ok) {
          const data = await resp.json();
          console.log('???„ë¡???•ìƒ ?‘ë™:', data?.choices?.[0]?.message?.content || '?‘ë‹µ ?†ìŒ');
          return true;
        } else {
          const errData = await resp.json().catch(() => ({ error: 'Unknown error' }));
          console.error('???„ë¡???¤ë¥˜:', resp.status, errData);
          
          if (resp.status === 404) {
            console.error('?„ë¡???¨ìˆ˜ê°€ ë°°í¬?˜ì? ?Šì•˜?µë‹ˆ?? Netlify ë°°í¬ ?íƒœë¥??•ì¸?´ì£¼?¸ìš”.');
          } else if (errData.code === 'MISSING_API_KEY') {
            console.error('Netlify ?˜ê²½ë³€??OPENAI_API_KEYê°€ ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ??');
          }
          return false;
        }
      } catch (error) {
        console.error('???„ë¡???°ê²° ?¤íŒ¨:', error.message);
        return false;
      }
    }

    // ====== GPT4?????¬í¼ ?¨ìˆ˜??======
    
    // GPT0 ?œë‘ ?”ì•½ API ?¬í¼ ?¨ìˆ˜
    async function summarizeForGpt4FromGpt0({ market, scenario, news, state }) {
      try {
        console.log('?“‹ GPT0 ?œë‘ ?”ì•½ API ?¸ì¶œ ?œì‘');
        
        const systemPrompt = "ë³´ê³ ???œë‘ ?„ìš© ?”ì•½ê¸? ì¤‘ë³µ ?œê±°, ?˜ì¹˜Â·ë¦¬ìŠ¤???¬ì¸???°ì„ , 10~12ì¤? ë¶ˆë¦¿ ê¸ˆì?, ?„ì „ë¬¸ì¥.";
        
        const userContent = [
          market || '',
          scenario || '',
          state || '',
          news || ''
        ].filter(text => text.trim()).join('\n\n');
        
        if (!userContent.trim()) {
          return "?œì¥ ?°ì´??ë°??œë‚˜ë¦¬ì˜¤ ë¶„ì„ ê²°ê³¼ê°€ ë¶€ì¡±í•©?ˆë‹¤.";
        }
        
        const result = await callOpenAI(systemPrompt, userContent);
        console.log('??GPT0 ?œë‘ ?”ì•½ ?„ë£Œ');
        return result || "?œë‘ ?”ì•½ ?ì„± ?¤íŒ¨";
        
      } catch (error) {
        console.error('??GPT0 ?œë‘ ?”ì•½ ?¤íŒ¨:', error);
        return `?œë‘ ?”ì•½ ?ì„± ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // GPT2 ?”ì†Œë³??•ê·œ??API ?¬í¼ ?¨ìˆ˜
    async function normalizeGpt2ForGpt4(gpt2Raw) {
      try {
        console.log('?“‹ GPT2 ?”ì†Œë³??•ê·œ??API ?¸ì¶œ ?œì‘');
        
        if (!gpt2Raw || gpt2Raw.trim().length < 10) {
          const fallback = {
            market: "GPT2 ?œì¥ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
            credit: "GPT2 ? ìš©ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?, 
            alm: "GPT2 ALM ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
            global: "GPT2 ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
            creditpf: "GPT2 ? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
            unifiedText: `=== ë¦¬ìŠ¤?¬ìš”?Œë³„ ?œë‚˜ë¦¬ì˜¤ ê²°ê³¼(GPT2) ===

## ?œì¥ë¦¬ìŠ¤??
GPT2 ?œì¥ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?

## ? ìš©ë¦¬ìŠ¤?? 
GPT2 ? ìš©ë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?

## ALM
GPT2 ALM ë¶„ì„ ê²°ê³¼ ë¶€ì¡?

## ê¸€ë¡œë²Œë¦¬ìŠ¤??
GPT2 ê¸€ë¡œë²Œë¦¬ìŠ¤??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?

## ? ìš©?¬íŠ¸?´ë¦¬??
GPT2 ? ìš©?¬íŠ¸?´ë¦¬??ë¶„ì„ ê²°ê³¼ ë¶€ì¡?
          };
          return fallback;
        }
        
        const systemPrompt = `GPT2 ?°ì¶œë¬¼ì„ ?„ë©”?¸ë³„ë¡?ê¹”ë”??ë¶„í•´Â·?•ë¦¬?˜ëŠ” ?¸ì§‘ê¸? ?œì œ??ê³ ì •, ì¤‘ë³µÂ·?¥í™© ?œê±°, ?µì‹¬ ?˜ì¹˜ ? ì?.

ì¶œë ¥ ?•ì‹:
{
  "market": "?œì¥ë¦¬ìŠ¤??ê´€???´ìš©ë§?ì¶”ì¶œ?˜ì—¬ ?•ë¦¬",
  "credit": "? ìš©ë¦¬ìŠ¤??ê´€???´ìš©ë§?ì¶”ì¶œ?˜ì—¬ ?•ë¦¬", 
  "alm": "ALM ê´€???´ìš©ë§?ì¶”ì¶œ?˜ì—¬ ?•ë¦¬",
  "global": "ê¸€ë¡œë²Œë¦¬ìŠ¤??ê´€???´ìš©ë§?ì¶”ì¶œ?˜ì—¬ ?•ë¦¬",
  "creditpf": "? ìš©?¬íŠ¸?´ë¦¬??ê´€???´ìš©ë§?ì¶”ì¶œ?˜ì—¬ ?•ë¦¬"
}

ê°??„ë©”?¸ë³„ë¡?ê´€???´ìš©??ì¶”ì¶œ?˜ë˜, ?µì‹¬ ?˜ì¹˜?€ ë¶„ì„ ê²°ê³¼ë¥??¬í•¨?˜ì—¬ 3-5ë¬¸ì¥?¼ë¡œ ?•ë¦¬?˜ì„¸??`;
        
        const result = await callOpenAI(systemPrompt, gpt2Raw);
        console.log('??GPT2 ?•ê·œ???ì‹œ ê²°ê³¼ ?˜ì‹ ');
        
        let parsed = {};
        try {
          // JSON ?Œì‹± ?œë„
          parsed = JSON.parse(result);
        } catch (parseError) {
          console.warn('? ï¸ GPT2 ?•ê·œ??ê²°ê³¼ JSON ?Œì‹± ?¤íŒ¨, ê¸°ë³¸ê°??¬ìš©');
          // ?Œì‹± ?¤íŒ¨???ë¬¸??ê°??„ë©”?¸ì— ë¶„ë°°
          const fallbackContent = result.slice(0, 200) + "...";
          parsed = {
            market: fallbackContent,
            credit: fallbackContent,
            alm: fallbackContent, 
            global: fallbackContent,
            creditpf: fallbackContent
          };
        }
        
        // unifiedText ?ì„±
        const unifiedText = `=== ë¦¬ìŠ¤?¬ìš”?Œë³„ ?œë‚˜ë¦¬ì˜¤ ê²°ê³¼(GPT2) ===

## ?œì¥ë¦¬ìŠ¤??
${parsed.market || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?}

## ? ìš©ë¦¬ìŠ¤??
${parsed.credit || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?}

## ALM
${parsed.alm || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?}

## ê¸€ë¡œë²Œë¦¬ìŠ¤??
${parsed.global || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?}

## ? ìš©?¬íŠ¸?´ë¦¬??
${parsed.creditpf || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?}`;
        
        const finalResult = {
          market: parsed.market || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
          credit: parsed.credit || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
          alm: parsed.alm || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?, 
          global: parsed.global || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
          creditpf: parsed.creditpf || "ë¶„ì„ ê²°ê³¼ ë¶€ì¡?,
          unifiedText: unifiedText
        };
        
        console.log('??GPT2 ?”ì†Œë³??•ê·œ???„ë£Œ');
        return finalResult;
        
      } catch (error) {
        console.error('??GPT2 ?”ì†Œë³??•ê·œ???¤íŒ¨:', error);
        const errorResult = {
          market: `?•ê·œ???¤íŒ¨: ${error.message}`,
          credit: `?•ê·œ???¤íŒ¨: ${error.message}`,
          alm: `?•ê·œ???¤íŒ¨: ${error.message}`,
          global: `?•ê·œ???¤íŒ¨: ${error.message}`,
          creditpf: `?•ê·œ???¤íŒ¨: ${error.message}`,
          unifiedText: `=== ë¦¬ìŠ¤?¬ìš”?Œë³„ ?œë‚˜ë¦¬ì˜¤ ê²°ê³¼(GPT2) ===

?•ê·œ??ì²˜ë¦¬ ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`
        };
        return errorResult;
      }
    }

    // ====== GPT4 ?¨ê³„ë³?ì²˜ë¦¬ ?¨ìˆ˜??======
    
    // 1?¨ê³„: GPT0 ?œë‘ ?ì„± (GPT API ë¯¸ì‚¬??- ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)
    async function generateGpt4IntroSection({ market, scenario, news, state }) {
      try {
        console.log('?“ GPT4 1?¨ê³„: ?œë‘ ?ì„± ?œì‘ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        
        // GPT API ?¸ì¶œ ?†ì´ ê¸°ì¡´ ì¶œë ¥???´ìš©?¤ì„ ì§ì ‘ ê²°í•©
        const sections = [];
        
        sections.push('## ?œì¥ ?í™© ë°??œë‚˜ë¦¬ì˜¤ ê°œìš”\n');
        
        if (scenario && scenario.trim()) {
          sections.push('### ?œë‚˜ë¦¬ì˜¤ ë¶„ì„');
          sections.push(scenario.trim());
          sections.push('');
        }
        
        if (market && market.trim()) {
          sections.push('### ?œì¥?°ì´??ë¶„ì„');
          sections.push(market.trim());
          sections.push('');
        }
        
        if (news && news.trim()) {
          sections.push('### ?´ìŠ¤ ë°?ë¦¬ìŠ¤??ë¶„ì„');
          sections.push(news.trim());
          sections.push('');
        }
        
        if (state && state.trim()) {
          sections.push('### ?„ì¬ ?œì¥ ?í™©');
          sections.push(state.trim());
          sections.push('');
        }
        
        const result = sections.join('\n');
        console.log('??GPT4 1?¨ê³„: ?œë‘ ?ì„± ?„ë£Œ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        return result || "?œë‘ ?ì„± ?¤íŒ¨ - ?°ì´???†ìŒ";
        
      } catch (error) {
        console.error('??GPT4 1?¨ê³„ ?œë‘ ?ì„± ?¤íŒ¨:', error);
        return `?œë‘ ?ì„± ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // 2?¨ê³„: GPT2 ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ê²°ê³¼ ?ì„± (GPT API ë¯¸ì‚¬??- ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)
    async function generateGpt4ElementSection(gpt2Raw) {
      try {
        console.log('?“ GPT4 2?¨ê³„: ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ë¶„ì„ ?œì‘ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        
        // GPT API ?¸ì¶œ ?†ì´ GPT2 ì¶œë ¥??ê·¸ë?ë¡??¬ìš©
        const sections = [];
        
        sections.push('## ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ê²°ê³¼\n');
        
        if (gpt2Raw && gpt2Raw.trim()) {
          sections.push(gpt2Raw.trim());
        } else {
          sections.push('?°ì´???†ìŒ');
        }
        
        const result = sections.join('\n');
        console.log('??GPT4 2?¨ê³„: ?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ë¶„ì„ ?„ë£Œ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        return result || "?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ë¶„ì„ ?ì„± ?¤íŒ¨";
        
      } catch (error) {
        console.error('??GPT4 2?¨ê³„ ?”ì†Œë³?ë¶„ì„ ?¤íŒ¨:', error);
        return `?”ì†Œë³??œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // 3?¨ê³„: GPT3 ?¥ë‹¤?´ë¸Œ ë¶„ì„ ?ì„± (GPT API ë¯¸ì‚¬??- ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)
    async function generateGpt4DeepDiveSection({ market, credit, alm, global, creditpf }) {
      try {
        console.log('?“ GPT4 3?¨ê³„: ?¥ë‹¤?´ë¸Œ ë¶„ì„ ?œì‘ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        
        // GPT API ?¸ì¶œ ?†ì´ GPT3??ê°??„ë©”?¸ë³„ ì¶œë ¥??ì§ì ‘ ê²°í•©
        const sections = [];
        
        sections.push('## ?„ë©”?¸ë³„ ?¬ì¸µ ë¶„ì„\n');
        
        if (market && market.trim()) {
          sections.push('### ?œì¥ë¦¬ìŠ¤???¬í™” ë¶„ì„');
          sections.push(market.trim());
          sections.push('');
        }
        
        if (credit && credit.trim()) {
          sections.push('### ? ìš©ë¦¬ìŠ¤???¬í™” ë¶„ì„');
          sections.push(credit.trim());
          sections.push('');
        }
        
        if (alm && alm.trim()) {
          sections.push('### ALM ?¬í™” ë¶„ì„');
          sections.push(alm.trim());
          sections.push('');
        }
        
        if (global && global.trim()) {
          sections.push('### ê¸€ë¡œë²Œë¦¬ìŠ¤???¬í™” ë¶„ì„');
          sections.push(global.trim());
          sections.push('');
        }
        
        if (creditpf && creditpf.trim()) {
          sections.push('### ? ìš©?¬íŠ¸?´ë¦¬???¬í™” ë¶„ì„');
          sections.push(creditpf.trim());
          sections.push('');
        }
        
        const result = sections.join('\n');
        console.log('??GPT4 3?¨ê³„: ?¥ë‹¤?´ë¸Œ ë¶„ì„ ?„ë£Œ (ê¸°ì¡´ ì¶œë ¥ ì·¨í•©)');
        return result || "?¥ë‹¤?´ë¸Œ ë¶„ì„ ?ì„± ?¤íŒ¨ - ?°ì´???†ìŒ";
        
      } catch (error) {
        console.error('??GPT4 3?¨ê³„ ?¥ë‹¤?´ë¸Œ ë¶„ì„ ?¤íŒ¨:', error);
        return `?¥ë‹¤?´ë¸Œ ë¶„ì„ ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`;
      }
    }
    
    // ??4?¨ê³„: ìµœì¢… ?µí•© ë³´ê³ ???ì„± ?¨ìˆ˜ ?œê±°??(?¬ìš”??ë°©ì?)
    // ?´ì œ generateStepByStepReport?ì„œ 1-3?¨ê³„ ê²°ê³¼ë¥?ì§ì ‘ ê²°í•©?˜ì—¬ ?¬ìš©

    // ?”’ ?µì…˜ ì§€??ê°€?¥í•œ OpenAI ?¸ì¶œ (? í°/?¨ë„/ëª¨ë¸ ì¡°ì ˆ??
    async function callOpenAIWithOptions(systemPrompt, userContent = {}, options = {}) {
      const body = {
        model: options.model || 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt || 'You are a helpful assistant.' },
          { role: 'user', content: userContent }
        ],
        max_tokens: typeof options.max_tokens === 'number' ? options.max_tokens : 3000,
        temperature: typeof options.temperature === 'number' ? options.temperature : 0.1
      };

      console.log('?”„ OpenAI ?„ë¡???µì…˜) ?¸ì¶œ ?œì‘...', { max_tokens: body.max_tokens });
      const controller = new AbortController();
      const timeoutMs = typeof options.timeoutMs === 'number' ? options.timeoutMs : 600000; // ê¸°ë³¸ 10ë¶?
      const t = setTimeout(() => controller.abort(), timeoutMs);
      const resp = await fetch('/.netlify/functions/openai-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        signal: controller.signal
      }).finally(() => clearTimeout(t));

      if (!resp.ok) {
        const errData = await resp.json().catch(() => ({ error: 'Unknown error' }));
        console.error('??OpenAI ?„ë¡???¤ë¥˜(?µì…˜):', resp.status, errData);
        if (resp.status === 404) {
          throw new Error('OpenAI ?„ë¡???¨ìˆ˜ê°€ ë°°í¬?˜ì? ?Šì•˜?µë‹ˆ?? Netlify ë°°í¬ ?íƒœë¥??•ì¸?´ì£¼?¸ìš”.');
        } else if (errData.code === 'MISSING_API_KEY') {
          throw new Error('Netlify ?˜ê²½ë³€??OPENAI_API_KEYê°€ ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ?? Site settings?ì„œ ?˜ê²½ë³€?˜ë? ?¤ì •?˜ê³  ?¬ë°°?¬í•´ì£¼ì„¸??');
        } else {
          throw new Error(`OpenAI ?„ë¡???¤ë¥˜: ${resp.status} ${errData.error || 'Unknown error'}`);
        }
      }

      const data = await resp.json();
      console.log('??OpenAI ?„ë¡???µì…˜) ?¸ì¶œ ?±ê³µ');
      return data?.choices?.[0]?.message?.content?.trim() || '';
    }

    // ?“„ ë¡œì»¬ Fallback: GPT ?†ì´ ê¸°ë³¸ HTML ë¬¸ì„œ ?ì„±
    function buildBasicHTMLDocument(title, dateString, text) {
      // ê°„ë‹¨??ë§ˆí¬?¤ìš´ ?¤í????Œì‹± (#, ##, ###)
      const lines = String(text || '').split(/\r?\n/);
      const parts = [];
      let para = [];
      const flushPara = () => {
        if (para.length) {
          const content = para.join(' ').trim();
          if (content) parts.push(`<p>${escapeHtml(content)}</p>`);
          para = [];
        }
      };
      const escapeHtml = (s) => s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      for (const line of lines) {
        if (/^\s*#\s+/.test(line)) { flushPara(); parts.push(`<h1>${escapeHtml(line.replace(/^\s*#\s+/, ''))}</h1>`); continue; }
        if (/^\s*##\s+/.test(line)) { flushPara(); parts.push(`<h2>${escapeHtml(line.replace(/^\s*##\s+/, ''))}</h2>`); continue; }
        if (/^\s*###\s+/.test(line)) { flushPara(); parts.push(`<h3>${escapeHtml(line.replace(/^\s*###\s+/, ''))}</h3>`); continue; }
        if (/^\s*$/.test(line)) { flushPara(); continue; }
        para.push(line.trim());
      }
      flushPara();

      const bodyHtml = parts.join('\n');
      return `<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${escapeHtml(title || '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??)}</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Noto Sans CJK KR','Apple SD Gothic Neo',sans-serif; line-height: 1.6; margin: 24px; color: #222; }
    h1,h2,h3 { margin: 24px 0 12px; line-height: 1.25; }
    h1 { font-size: 28px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    p { margin: 10px 0; }
    .meta { color: #666; font-size: 13px; margin-bottom: 16px; }
    @media print { body { margin: 12mm; } }
  </style>
  </head>
  <body>
  <div class="meta">?‘ì„±?? ${escapeHtml(dateString || '')}</div>
  <h1>${escapeHtml(title || '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??)}</h1>
  ${bodyHtml}
  </body>
  </html>`;
    }

    // ?“„ ?„ì²´ HTML ë¬¸ì„œ ?œí”Œë¦??´ë? HTML ì¡°ê°??ì¤€ë¹„ëœ ê²½ìš° ?¬ìš©)
    function buildFullHTMLDocument(title, dateString, innerHtml) {
      const safe = (s)=>String(s||'').replace(/[<>]/g, m=>({"<":"&lt;",">":"&gt;"}[m]));
      return `<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${safe(title || '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??)}</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Noto Sans CJK KR','Apple SD Gothic Neo',sans-serif; line-height: 1.6; margin: 24px; color: #222; }
    h1,h2,h3 { margin: 24px 0 12px; line-height: 1.25; }
    h1 { font-size: 28px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    p { margin: 10px 0; }
    .meta { color: #666; font-size: 13px; margin-bottom: 16px; }
    @media print { body { margin: 12mm; } }
  </style>
  </head>
  <body>
  <div class="meta">?‘ì„±?? ${safe(dateString || '')}</div>
  <h1>${safe(title || '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??)}</h1>
  ${innerHtml || ''}
  </body>
  </html>`;
    }

    // ?”§ ì´ˆê²½??ë§ˆí¬?¤ìš´?’HTML ë³€?˜ê¸° (?ˆì „?¥ì¹˜)
    function mdLite(src) {
      if (!src) return '';
      let s = src;

      // ?¤ë”©(##, ### ??h3/h4)
      s = s.replace(/^####\s?(.*)$/gm, '<h4>$1</h4>');
      s = s.replace(/^###\s?(.*)$/gm, '<h3>$1</h3>');
      s = s.replace(/^##\s?(.*)$/gm,  '<h3>$1</h3>');

      // êµµê²Œ/ê¸°ìš¸??(**bold**, *em*)
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      s = s.replace(/(^|[^\*])\*(?!\*)([^*]+?)\*(?!\*)/g, '$1<em>$2</em>');

      // ?«ì ë¦¬ìŠ¤??(1. ... ?¬ëŸ¬ì¤???<ol>)
      s = s.replace(/(?:^|\n)((?:\d+\.\s+.*(?:\n|$))+)/gm, (m, block) => {
        const items = block.trim().split(/\n/)
          .map(l => l.replace(/^\d+\.\s+/, '').trim())
          .filter(Boolean)
          .map(v => `<li>${v}</li>`).join('\n');
        return `\n<ol>\n${items}\n</ol>\n`;
      });

      // ë¶ˆë¦¿ ë¦¬ìŠ¤??(- ... ?¬ëŸ¬ì¤???<ul>)
      s = s.replace(/(?:^|\n)((?:-\s+.*(?:\n|$))+)/gm, (m, block) => {
        const items = block.trim().split(/\n/)
          .map(l => l.replace(/^-+\s+/, '').trim())
          .filter(Boolean)
          .map(v => `<li>${v}</li>`).join('\n');
        return `\n<ul>\n${items}\n</ul>\n`;
      });

      // ?¨ë½ ê°ì‹¸ê¸??´ë? ?œê·¸ë¡??œì‘?˜ëŠ” ì¤„ì? ?œì™¸)
      const chunks = s.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
      return chunks.map(p => (/^<(h3|h4|ul|ol)\b/i.test(p) ? p : `<p>${p.replace(/\n/g, '<br>')}</p>`)).join('\n');
    }

    // ?“¦ ?ìŠ¤?¸ë? ?¬ê¸° ê¸°ì??¼ë¡œ ì¡°ê°?´ê¸° (ë¬¸ë‹¨ ê²½ê³„ ?°ì„ )
    function splitTextBySize(text, maxLen) {
      const chunks = [];
      const parts = String(text||'').split(/\n\n+/);
      let buf = '';
      for (const part of parts) {
        const block = (part + '\n\n');
        if ((buf + block).length > maxLen) {
          if (buf) chunks.push(buf);
          if (block.length > maxLen) {
            // ?ˆë¬´ ???¨ì¼ ë¸”ë¡?€ ê°•ì œë¡?ë¶„í• 
            for (let i = 0; i < block.length; i += maxLen) {
              chunks.push(block.slice(i, i + maxLen));
            }
            buf = '';
          } else {
            buf = block;
          }
        } else {
          buf += block;
        }
      }
      if (buf) chunks.push(buf);
      return chunks;
    }

    // ?¤– ?€?©ëŸ‰ ?ìŠ¤????(ì¡°ê°ë³? HTML ë³¸ë¬¸ ì¡°ê° ??ìµœì¢… HTMLë¡??©ì„±
    async function generateHtmlFromFinalReportChunked(finalReport, title, dateString) {
      const CHUNK_CHAR_LIMIT = 2600; // ì¡°ê°??ê¸¸ì´ ì¶•ì†Œ(ì¶œë ¥ 1:1 ë³€???¬ìœ  ?•ë³´)
      const sections = splitTextBySize(finalReport, CHUNK_CHAR_LIMIT);
      console.log(`?§© ?€?©ëŸ‰ ë³´ê³ ??ë¶„í• : ${sections.length}ê°?ì¡°ê°`);
      const system = [
        '?ˆëŠ” HTML ë§ˆí¬???„ë¬¸ê°€?´ë‹¤.',
        '?„ë˜ ?ìŠ¤??ì¡°ê°??HTML ë³¸ë¬¸ ì¡°ê°?¼ë¡œ ë³€?˜í•˜??',
        'ë°˜ë“œ??ë³¸ë¬¸ ì¡°ê°ë§?ì¶œë ¥?˜ê³  <html>, <head>, <body>???¬í•¨?˜ì? ë§ˆë¼.',
        '?ˆìš© ?œê·¸: <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>',
        'ë¬¸ì²´???„ë¬¸?ì´ê³??•ì¤‘??"~?µë‹ˆ?? ?•ì‹?¼ë¡œ ?‘ì„±.',
        '???„ì£¼ ì¤‘ìš”: ?…ë ¥??ë§ˆí¬?¤ìš´(##, **bold**, - bullet, 1. list)?´ë¼ë©?ëª¨ë“  ë§ˆí¬?¤ìš´ ê¸°í˜¸ë¥??œê±°?˜ê³  ?™ë“±??HTML ?œê·¸ë¡?ë³€?˜í•´??',
        '??ë§ˆí¬?¤ìš´ ê¸°í˜¸ë¥?ê·¸ë?ë¡??¨ê¸°ì§€ ë§?ê²? ?ìŠ¤??ë³´ì¡´, ?”ì•½/?ëµ ê¸ˆì?.',
        '?„ì£¼ ì¤‘ìš”: ?ˆë? ?”ì•½?˜ê±°???ëµ?˜ì? ë§?ê²? ?…ë ¥ ?ìŠ¤?¸ì˜ ëª¨ë“  ë¬¸ì¥???œì„œ?€ë¡?1:1ë¡?HTML ?œê·¸ë§??…í???ì¶œë ¥??ê²?'
      ].join(' ');

      const htmlParts = [];
      let idx = 0;
      const statusEl = document.getElementById('html-status');
      for (let sec of sections) {
        idx += 1;
        // ?”§ ë§ˆí¬?¤ìš´??ë¯¸ë¦¬ HTMLë¡??•ê·œ??LLM??ê·œì¹™ ?´ê²¨???ˆì „)
        const processedSec = mdLite(sec);
        const user = `?¤ìŒ?€ ìµœì¢… ë³´ê³ ?œì˜ ?¼ë?ë¶??¹ì…˜ ${idx}/${sections.length})?´ë‹¤. ?´ë? HTML ë³¸ë¬¸ ì¡°ê°?¼ë¡œ ë³€?˜í•˜??\n\n${processedSec}`;
        try {
          statusEl && (statusEl.style.display = 'block', statusEl.textContent = `HTML ì¡°ê° ë³€??ì¤?.. (${idx}/${sections.length})`);
          const part = await callOpenAIWithOptions(system, user, {
            max_tokens: 2800,     // ì¡°ê°??ì¶œë ¥ ?¬ìœ  ??
            temperature: 0.2,
            timeoutMs: 70000      // ê¸?ì¡°ê° ë³€???€?„ì•„????
          });
          // ?¤íŒ¨?´ë„ mdLite HTML??ë°±ì—…?¼ë¡œ ?¬ìš©
          htmlParts.push(part ? part : processedSec);
        } catch (e) {
          console.warn(`? ï¸ ì¡°ê° ${idx} ë³€???¤íŒ¨, mdLite ë°±ì—… ?¬ìš©:`, e.message);
          // ?¤íŒ¨ ??mdLite ë³€??ê²°ê³¼ë¥?ì¦‰ì‹œ ?¬ìš©
          htmlParts.push(processedSec);
        }
        // ì¡°ê°ê°?ì§§ì? ê°„ê²©?¼ë¡œ ë°±ì—”??ë¶€???„í™”
        await new Promise(r => setTimeout(r, 500));
      }
      const inner = htmlParts.join('\n\n');
      return buildFullHTMLDocument(title, dateString, inner);
    }

    // ====== GPT0 ë³´ì¡° ? í‹¸ ======
    async function buildScenarioMarketTimeseriesText(n){
      try{
        console.log(`?? buildScenarioMarketTimeseriesText È£Ãâ: ½Ã³ª¸®¿À ${n}`);
        console.log('?? marketDataByScenario »óÅÂ:', Object.keys(marketDataByScenario).length, '°³');
        
        const scen = scenarioData[n] || {};
        const indicatorMeta = window.INDICATOR_META || indicatorMetaById || {};
        
        let pick = [];
        let links = [];
        let indicators = [];
        
        if (scenarioToIndicatorsMap.has(n)) {
          pick = scenarioToIndicatorsMap.get(n).slice(0, 8);
          console.log(`? ½Ã³ª¸®¿À ${n} ¸ÅÇÎ¿¡¼­ ${pick.length}°³ ÁöÇ¥ ¹ß°ß`);
        } else {
          links = Array.isArray(scen.links) ? scen.links : [];
          indicators = Array.isArray(scen.indicators) ? scen.indicators : [];
          pick = (links && links.length ? links : indicators).slice(0, 8);
          console.log(`?? ½Ã³ª¸®¿À ${n} ¸ÅÇÎ ¾øÀ½ ¡æ ±âÁ¸ ¹æ½Ä »ç¿ë: ${pick.length}°³ ÁöÇ¥`);
        }
        
        console.log('?? ½Ã³ª¸®¿À °³¿ä', scen);
        console.log('?? ¸µÅ© ±â¹İ ÁöÇ¥:', links);
        console.log('?? ÀÎµğÄÉÀÌÅÍ ±â¹İ ÁöÇ¥:', indicators);
        console.log('?? ¼±ÅÃ ´ë»ó:', pick);
        
        const header = [`½Ã³ª¸®¿À: ${n}`, `[ºĞ¼®´ë»ó ÁöÇ¥¼ö] ${pick.length}`, `[ÁöÇ¥¸í Áß½É ºĞ¼®]`, ''];
        
        const availableMarketData = Object.keys(marketDataByScenario);
        console.log('?? »ç¿ë °¡´ÉÇÑ ¸¶ÄÏµ¥ÀÌÅÍ ID:', availableMarketData);
        console.log('?? ½Ã³ª¸®¿Àº° ¸¶ÄÏµ¥ÀÌÅÍ ¸ÅÇÎ »ùÇÃ:');
        
        function formatMarketData(indicatorId, name, ticker, weight, corr) {
          console.log(`?? formatMarketData È£Ãâ: indicatorId=${indicatorId}, name=${name}, ticker=${ticker}`);
          console.log('?? »ç¿ë °¡´ÉÇÑ ¸¶ÄÏµ¥ÀÌÅÍ Å°µé:', Object.keys(marketDataByScenario));
          
          let marketData = marketDataByScenario[indicatorId];
          
          if (!marketData && indicatorId.includes(':')) {
            const baseId = indicatorId.split(':')[0];
            marketData = marketDataByScenario[baseId];
            if (marketData) {
              console.log(`?? ±âº» ID·Î ¸¶ÄÏµ¥ÀÌÅÍ Ã£À½: ${indicatorId} -> ${baseId}`);
            }
          }
          
          if (!marketData && indicatorId.startsWith('IND')) {
            const num = indicatorId.replace('IND', '');
            const paddedId = 'IND' + String(parseInt(num)).padStart(3, '0');
            marketData = marketDataByScenario[paddedId];
            if (marketData) {
              console.log(`?? Á¦·ÎÆĞµù ID·Î ¸¶ÄÏµ¥ÀÌÅÍ Ã£À½: ${indicatorId} -> ${paddedId}`);
            }
          }
          
          if (!marketData) {
            console.log(`? ¸¶ÄÏµ¥ÀÌÅÍ¸¦ Ã£À» ¼ö ¾øÀ½: ${indicatorId}`);
            const nameInfo = name ? `[ÀÌ¸§: ${name}]` : '';
            const tickerInfo = ticker ? `[Æ¼Ä¿: ${ticker}]` : '';
            const weightInfo = weight ? `[°¡ÁßÄ¡: ${weight}]` : '';
            const corrInfo = corr ? `[»ó°ü°è¼ö: ${corr}]` : '';
            
            return `ÀÌ¸§: ${name || 'N/A'} ${tickerInfo} ${weightInfo} ${corrInfo}
¸¶ÄÏµ¥ÀÌÅÍ ¾øÀ½ - »ç¿ë °¡´ÉÇÑ ID ${Object.keys(marketDataByScenario).slice(0, 5).join(', ')}...`;
          }
          
          const tickerInfo = ticker ? `[Æ¼Ä¿: ${ticker}]` : '';
          const nameInfo = name ? `[ÀÌ¸§: ${name}]` : '';
          const weightInfo = weight ? `[°¡ÁßÄ¡: ${weight}]` : '';
          const corrInfo = corr ? `[»ó°ü°è¼ö: ${corr}]` : '';
          
          const primaryIdentifier = name || ticker || indicatorId;
          let output = [`${primaryIdentifier} ${tickerInfo} ${nameInfo} ${weightInfo} ${corrInfo} [ID: ${indicatorId}]`];
          
          if (marketData.returns) {
            const ret = marketData.returns;
            output.push(`  ¼öÀÍ·ü: 20d ${(ret['20d']*100).toFixed(2)}% (¿¬È¯»ê ${(ret['20d_ann']*100).toFixed(1)}%), 60d ${(ret['60d']*100).toFixed(2)}% (¿¬È¯»ê ${(ret['60d_ann']*100).toFixed(1)}%), 120d ${(ret['120d']*100).toFixed(2)}% (¿¬È¯»ê ${(ret['120d_ann']*100).toFixed(1)}%)`);
          }
          
          if (marketData.vol) {
            const vol = marketData.vol;
            output.push(`  º¯µ¿¼º(¿¬È¯»ê): 20d ${(vol['20d_vol_ann']*100).toFixed(1)}%, 60d ${(vol['60d_vol_ann']*100).toFixed(1)}%, 120d ${(vol['120d_vol_ann']*100).toFixed(1)}%`);
          }
          
          if (marketData.mdd) {
            const mdd = marketData.mdd;
            const mdd6m = mdd['mdd_6m'] ? `6°³¿ùMDD=${(mdd['mdd_6m']*100).toFixed(1)}%` : '';
            const dd6m = mdd['dd_6m'] ? `ÇöÀç´©Àû=${(mdd['dd_6m']*100).toFixed(1)}%` : '';
            const mdd1y = mdd['mdd_1y'] ? `1³âMDD=${(mdd['mdd_1y']*100).toFixed(1)}%` : '';
            const mddText = [mdd6m, dd6m, mdd1y].filter(Boolean).join(', ');
            if (mddText) output.push(`  ÃÖ´ë³«Æø: ${mddText}`);
          }
          
          if (marketData.trend) {
            const trend = marketData.trend;
            output.push(`  Ãß¼¼ºĞ¼®: SMA20 ´ëºñ ${(trend['gap_to_sma20']*100).toFixed(1)}%, SMA60 ´ëºñ ${(trend['gap_to_sma60']*100).toFixed(1)}%, SMA120 ´ëºñ ${(trend['gap_to_sma120']*100).toFixed(1)}%`);
            if (trend['cross_20_60'] && trend['cross_20_60'] !== 'none') {
              output.push(`    - 20 vs 60 ±³Â÷: ${trend['cross_20_60']}`);
            }
            if (trend['cross_60_120'] && trend['cross_60_120'] !== 'none') {
              output.push(`    - 60 vs 120 ±³Â÷: ${trend['cross_60_120']}`);
            }
          }
          
          if (marketData.slope60) {
            const slope = marketData.slope60;
            output.push(`  60ÀÏ ±â¿ï±â ${slope.slope.toFixed(2)} (tÅë°è ${slope.tstat.toFixed(2)})`);
          }
          
          if (marketData.pos_52w) {
            const pos = marketData.pos_52w;
            output.push(`  52ÁÖ Æ÷Áö¼Ç ${pos.pos_pct.toFixed(1)}% ±¸°£ (0~1 Æ÷Áö¼Ç ${pos.pos_0to1.toFixed(3)})`);
          }
          
          return output.join('\n');
        }
        
        let out = header.slice();
        for (let i = 0; i < pick.length; i++) {
          const item = pick[i];
          console.log(`?? ÁöÇ¥${i+1} µ¥ÀÌÅÍ`, item);
          
          let id, name, ticker, weight, corr;
          
          if (scenarioToIndicatorsMap.has(n)) {
            id = item.indicatorId || '';
            name = item.indicatorName || '';
            ticker = item.bloombergTicker || '';
            weight = 0;
            corr = 0;
          } else {
            id = item.Indicator_ID || item.IndicatorID || item.indicator_id || item.indicatorID || item.id || item.ID || '';
            name = item.Indicator_Name || item.IndicatorName || item.indicator_name || item.indicatorName || item.name || item.Name || item.NAME || '';
            ticker = item.Bloomberg_Ticker || item.BloombergTicker || item.bloomberg_ticker || item.bloombergTicker || item.ticker || item.Ticker || item.TICKER || '';
            weight = item.Weight || item.weight || item.WEIGHT || 0;
            corr = item.Correlation_Coeff || item.CorrelationCoeff || item.correlation_coeff || item.correlationCoeff || item.corr || item.Corr || item.CORR || 0;
          }
          
          id = String(id || '').trim();
          const meta = indicatorMeta[id] || indicatorMeta[id.toUpperCase?.() ? id.toUpperCase() : id] || null;
          if (meta) {
            if (!name) name = meta.name || name;
            if (!ticker) ticker = meta.ticker || ticker;
          }
          
          if (!id) {
            console.log(`??ID°¡ ¾ø´Â ÁöÇ¥°Ç³Ê¶Ü:`, item);
            continue;
          }
          
          const thresholdLow = meta?.threshold_low ?? item.Threshold_Low ?? item.threshold_low ?? null;
          const thresholdHigh = meta?.threshold_high ?? item.Threshold_High ?? item.threshold_high ?? null;
          const marketEntry = marketDataByScenario[id] || (id.includes(':') ? marketDataByScenario[id.split(':')[0]] : null);
          const latestFromMarket = marketEntry?.latest ?? marketEntry?.latest_value ?? marketEntry?.current ?? marketEntry?.current_value ?? null;
          const currentValue = meta?.current_value ?? item.Current_Value ?? item.current_value ?? item.CurrentValue ?? latestFromMarket ?? null;
          
          const marketDataText = formatMarketData(id, name, ticker, weight, corr);
          const displayLabel = name || ticker || id;
          const indicatorSummary = [
            `- ${id} | ${name || 'ÁöÇ¥¸í ¹ÌÁ¤'} (${ticker || 'Æ¼Ä¿ ¾øÀ½'})`,
            `  ¡¤ ÃÖ±Ù°ª: ${currentValue ?? 'N/A'}`,
            `  ¡¤ Threshold: Low ${thresholdLow ?? 'N/A'}, High ${thresholdHigh ?? 'N/A'}`
          ].join('\n');
          
          out.push(`[${i+1}] ${displayLabel}`);
          out.push(indicatorSummary);
          out.push(marketDataText);
          out.push('');
        }
        
        return out.join('\n').trim();
      }catch(e){ 
        console.error('buildScenarioMarketTimeseriesText ¿À·ù:', e);
        return `½Ã³ª¸®¿À ${n} ¸¶ÄÏµ¥ÀÌÅÍ Ã³¸® Áß ¿À·ù ¹ß»ı: ${e.message}`; 
      }
    }
    async function buildScenarioNewsFullText(n){
      try{
        // ?ˆë¡œ??keyword_news.xlsx ?°ì´???¬ìš©
        const newsContent = getKeywordNewsContent(n);
        return newsContent || 'ê´€???´ìŠ¤ ?”ì•½ ?†ìŒ';
      }catch(e){ 
        return `?´ìŠ¤ ?”ì•½ ?˜ì§‘ ?¤íŒ¨: ${e.message}`; 
      }
    }

    async function fetchArticleAsText(url){
      // 1) ë¡œì»¬ ?„ë¡???œë²„ ?œë„: http://localhost:3000/api/fetch-article?url=...
      try{
        const proxyUrl = `http://localhost:3000/api/fetch-article?url=${encodeURIComponent(url)}`;
        const r = await fetch(proxyUrl, { cache: 'no-store' });
        if (r.ok) {
          const text = await r.text();
          if (text && text.length > 0) return text.slice(0, 12000);
        }
      }catch(_){ /* ignore and fallback */ }
      // 2) ì§ì ‘ ?”ì²­ (?€ë¶€ë¶?CORSë¡??¤íŒ¨?˜ë?ë¡??¤íŒ¨???ˆë‚´)
      try{
        const resp = await fetch(url, { mode: 'no-cors' });
        if (!resp || resp.type === 'opaque') return `?ë¬¸?€ CORSë¡?ì§ì ‘ ?˜ì§‘ ë¶ˆê?. URLë§??œê³µ: ${url}`;
        const html = await resp.text();
        return stripHtmlToText(html).slice(0, 8000);
      }catch(_){
        return `?ë¬¸ ?‘ê·¼ ?¤íŒ¨(CORS ê°€?¥ì„±). URLë§??œê³µ: ${url}`;
      }
    }

    function stripHtmlToText(html){
      try{
        const div = document.createElement('div');
        div.innerHTML = html;
        return (div.textContent || div.innerText || '').replace(/\s+/g,' ').trim();
      }catch(_){ return ''; }
    }



    async function buildCurrentMarketStateText(){
      try{
        console.log('?” buildCurrentMarketStateText ?¨ìˆ˜ ?œì‘');
        
        const a = await fetch('go_scen/data/market_data/market_index.txt').then(r=>r.ok?r.text():'').catch(()=> '');
        console.log('?“Š market_index.txt ë¡œë“œ ê²°ê³¼:', a ? '?±ê³µ' : '?¤íŒ¨', '?´ìš© ê¸¸ì´:', a.length);
        
        const b = await fetch('go_scen/data/market_data/daily_market_recap.txt').then(r=>r.ok?r.text():'').catch(()=> '');
        console.log('?“Š daily_market_recap.txt ë¡œë“œ ê²°ê³¼:', b ? '?±ê³µ' : '?¤íŒ¨', '?´ìš© ê¸¸ì´:', b.length);
        
        const result = `[ë§ˆì¼“ ?¸ë±??\n${a}\n\n[?°ì¼ë¦?ë¦¬ìº¡]\n${b}`.trim();
        console.log('?” ìµœì¢… ê²°í•© ê²°ê³¼:', result);
        
        return result;
      }catch(e){ 
        console.error('??buildCurrentMarketStateText ?¤ë¥˜:', e);
        return `?œí™© ?ìŠ¤??ë¡œë“œ ?¤íŒ¨: ${e.message}`; 
      }
    }

    // ?œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¥??œë‚˜ë¦¬ì˜¤ IDë¡?ë³€??(n -> SC001, SC002 ??
    function getScenarioIdFromNumber(n) {
      const result = `SC${String(n).padStart(3, '0')}`;
      console.log(`?” getScenarioIdFromNumber(${n}) ??"${result}"`);
      return result;
    }

    // ?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?´ìš© ê°€?¸ì˜¤ê¸?
    function getScenarioSummaryContent(n) {
      try {
        console.log(`?” getScenarioSummaryContent ?¸ì¶œ: ?œë‚˜ë¦¬ì˜¤ ${n}`);
        console.log('?“‹ scenarioSummaryByScenarioId ?íƒœ:', Object.keys(scenarioSummaryByScenarioId).length, 'ê°??œë‚˜ë¦¬ì˜¤');
        console.log('?“‹ ?¬ìš© ê°€?¥í•œ ?œë‚˜ë¦¬ì˜¤ ID??', Object.keys(scenarioSummaryByScenarioId));
        
        const scenarioId = getScenarioIdFromNumber(n);
        console.log('?†” ë³€?˜ëœ ?œë‚˜ë¦¬ì˜¤ ID:', scenarioId);
        
        const content = scenarioSummaryByScenarioId[scenarioId];
        console.log('?“„ ?´ë‹¹ ?œë‚˜ë¦¬ì˜¤ ?”ì•½:', content);
        
        if (!content) {
          console.log(`???”ì•½ ?°ì´???†ìŒ: ?œë‚˜ë¦¬ì˜¤ ${scenarioId}`);
        }
        
        return content || `?œë‚˜ë¦¬ì˜¤ ${scenarioId} ?”ì•½ ?•ë³´ ?†ìŒ`;
      } catch(e) {
        return `?œë‚˜ë¦¬ì˜¤ ?”ì•½ ë¡œë“œ ?¤íŒ¨: ${e.message}`;
      }
    }

    // ?¤ì›Œ???´ìŠ¤ ?´ìš© ê°€?¸ì˜¤ê¸?
    function getKeywordNewsContent(n) {
      try {
        console.log(`?” getKeywordNewsContent ?¸ì¶œ: ?œë‚˜ë¦¬ì˜¤ ${n}`);
        console.log('?“° keywordNewsByScenarioId ?íƒœ:', Object.keys(keywordNewsByScenarioId).length, 'ê°??œë‚˜ë¦¬ì˜¤');
        console.log('?“° ?¬ìš© ê°€?¥í•œ ?œë‚˜ë¦¬ì˜¤ ID??', Object.keys(keywordNewsByScenarioId));
        console.log('?“° keywordNewsByScenarioId ?„ì²´ ?´ìš©:', keywordNewsByScenarioId);
        
        const scenarioId = getScenarioIdFromNumber(n);
        console.log('?†” ë³€?˜ëœ ?œë‚˜ë¦¬ì˜¤ ID:', scenarioId);
        
        // ?•í™•??ë§¤ì¹­ ?•ì¸
        const exactMatch = keywordNewsByScenarioId[scenarioId];
        console.log('?” ?•í™•??ë§¤ì¹­ ê²°ê³¼:', exactMatch);
        
        // SC004 ?¹ë³„ ?”ë²„ê¹?
        if (scenarioId === 'SC004') {
          console.log('?¯ SC004 ?¹ë³„ ?”ë²„ê¹?');
          console.log('  - keywordNewsByScenarioId ?„ì²´ ?¤ë“¤:', Object.keys(keywordNewsByScenarioId));
          console.log('  - SC004 ì§ì ‘ ?‘ê·¼:', keywordNewsByScenarioId['SC004']);
          console.log('  - 4 ?¬í•¨ ?¤ë“¤:', Object.keys(keywordNewsByScenarioId).filter(key => key.includes('4')));
          console.log('  - 004 ?¬í•¨ ?¤ë“¤:', Object.keys(keywordNewsByScenarioId).filter(key => key.includes('004')));
        }
        
        // ë¶€ë¶?ë§¤ì¹­ ?œë„ (SC004 -> SC4, 4, 004 ??
        let newsArray = exactMatch;
        if (!newsArray || newsArray.length === 0) {
          const partialMatches = Object.keys(keywordNewsByScenarioId).filter(key => 
            key.includes(scenarioId.replace('SC', '')) || 
            key.includes(scenarioId) ||
            scenarioId.includes(key.replace('SC', ''))
          );
          console.log('?” ë¶€ë¶?ë§¤ì¹­ ?œë„ ê²°ê³¼:', partialMatches);
          
          if (partialMatches.length > 0) {
            newsArray = keywordNewsByScenarioId[partialMatches[0]];
            console.log(`??ë¶€ë¶?ë§¤ì¹­?¼ë¡œ ?´ìŠ¤ ì°¾ìŒ: ${scenarioId} -> ${partialMatches[0]}`);
          }
        }
        
        console.log('?“‹ ìµœì¢… ?´ìŠ¤ ë°°ì—´:', newsArray);
        
        if (!newsArray || newsArray.length === 0) {
          console.log(`???´ìŠ¤ ?°ì´???†ìŒ: ?œë‚˜ë¦¬ì˜¤ ${scenarioId}`);
          return '?´ë‹¹ê¸°ì‚¬ ?†ìŒ';
        }
        
        const newsContent = newsArray.map((item, index) => {
          let content = `[ê¸°ì‚¬ ${index + 1}]`;
          if (item.title) content += `\n?œëª©: ${item.title}`;
          if (item.press) content += `\n?¸ë¡ ?? ${item.press}`;
          if (item.keyword) content += `\n?¤ì›Œ?? ${item.keyword}`;
          if (item.url) content += `\nURL: ${item.url}`;
          if (item.news && item.news !== '?´ìŠ¤ ?´ìš© ?†ìŒ') {
            content += `\n?”ì•½: ${item.news}`;
          } else {
            content += `\n?”ì•½: ?´ìŠ¤ ?´ìš© ?†ìŒ`;
          }
          return content;
        }).join('\n\n---\n\n');
        
        return newsContent;
      } catch(e) {
        return `?¤ì›Œ???´ìŠ¤ ë¡œë“œ ?¤íŒ¨: ${e.message}`;
      }
    }

    // risk_eng.ipynb?ì„œ ?ì´?„íŠ¸ ??•  ?ìŠ¤??ì¶”ì¶œ
    async function loadRiskAgentRoles() {
      // ê¸°ë³¸ê°?(fallback)
      const defaults = {
        gpt0_marketdata: '?…ë ¥???œê³„???ìŠ¤???‘ì? ë³€???”ì•½)ë¥?ê¸°ë°˜?¼ë¡œ ë³€?™ì„±, ì¶”ì„¸(?????¡ë³´), êµ¬ê°„ë³??ˆì§, ê°„ë‹¨???ê?(ê°€?¥ì‹œ)???”ì•½?˜ê³  ?µì‹¬ ?”ì ???œë¡œ ?•ë¦¬?˜ë¼. ê³¼ë„??ì¶”ì •?€ ?¼í•˜ê³??…ë ¥ ??ê·¼ê±°ë¥?ëª…ì‹œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.',
        gpt0_news: '?…ë ¥???´ìŠ¤ ?”ì•½?¤ì„ ë°”íƒ•?¼ë¡œ ?œë‚˜ë¦¬ì˜¤?€???°ê³„?? ë¦¬ìŠ¤???¸ë¦¬ê±? ?œì¥ ?í–¥?„ë? ë¶„ì„?˜ë¼. ê°?ê¸°ì‚¬???µì‹¬ ?¬ì¸?¸ë? ì¢…í•©?˜ì—¬ ?œë‚˜ë¦¬ì˜¤ ?¤í˜„ ê°€?¥ì„±, ? í–‰/?™í–‰ ? í˜¸, ê¸ˆìœµ?œì¥ ?Œê¸‰?¨ê³¼ë¥??„ì¶œ?˜ê³  ì¢…í•©?ì¸ ?œì‚¬?ì„ ?œì‹œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.',
        gpt0_scenario_summary: '?œë‚˜ë¦¬ì˜¤ ?”ì•½ ?´ìš©??ë¶„ì„?˜ì—¬ ì£¼ìš” ë¦¬ìŠ¤???”ì¸, ?í–¥ ?„íŒŒ ê²½ë¡œ, ëª¨ë‹ˆ?°ë§ ?¬ì¸?¸ë? ì²´ê³„?ìœ¼ë¡??•ë¦¬?˜ê³ , ê¸ˆìœµê¸°ê? ê´€?ì—?œì˜ ?œì‚¬?ê³¼ ?€??ë°©ì•ˆ???„ì¶œ?˜ë¼. ?œë‚˜ë¦¬ì˜¤???µì‹¬ ?™ì¸ê³?? ì¬???í–¥?„ë? ëª…í™•??êµ¬ë¶„?˜ì—¬ ?œì‹œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.',
        gpt0_scenpdf: '?œë‚˜ë¦¬ì˜¤ PDF?ì„œ ì¶”ì¶œ???ìŠ¤?¸ë? ë°”íƒ•?¼ë¡œ ?¤ìŒ??ì²´ê³„?ìœ¼ë¡?ë¶„ì„?˜ë¼: 1) ?œë‚˜ë¦¬ì˜¤ ê°œìš” ë°??µì‹¬ ?™ì¸, 2) ?¨ê³„ë³??„ê°œ ê³¼ì •(?´ë²¤?¸â†’ì§€?œâ†’? í˜¸), 3) ?œë‚˜ë¦¬ì˜¤ ?¤í˜„ ê°€?¥ì„± ?‰ê?, 4) ì£¼ìš” ëª¨ë‹ˆ?°ë§ ??ª©ê³??„ê³„ì¹? 5) ì¡°ê¸°ê²½ë³´ ? í˜¸ ë°??°ì´???ŒìŠ¤. ?Œì£¼?œë³„ë¡?êµ¬ë¶„?˜ì—¬ ?‘ì„±?˜ë¼.',
        gpt0_marketstate: 'ë§ˆì¼“ ?¸ë±???”ì•½ê³??°ì¼ë¦?ë¦¬ìº¡ ?ìŠ¤?¸ë? ê²°í•©???„ì¬ ?œì¥Â·ê²½ì œ ?í™©??8ì¤??´ì™¸ë¡??”ì•½?˜ê³ , ?¹ì¼ ?µì‹¬ ?¬ì¸??5ê°€ì§€ë¥?ë¶ˆë¦¿?¼ë¡œ ?•ë¦¬?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.',
        gpt1: 'GPT0 ê°?ëª¨ë“ˆ??ë¶„ì„ ê²°ê³¼(?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´?? ê¸°ì‚¬?´ìŠ¤, ?œë‚˜ë¦¬ì˜¤ ?”ì•½, PDF ë¶„ì„, ?„ì¬ ?œí™©)ë¥?ì¢…í•©?˜ì—¬ ?¼ê????ˆê²Œ ?•ì œ?˜ê³ , GPT2 ë¶„ë°° ?‘ì—…???„í•œ ?µì‹¬ ?”ì•½ê³?êµ¬ì¡°?”ëœ ?•ë³´ë¥??ì„±?˜ë¼. ì¤‘ë³µ ?œê±°, ?í˜¸ ?°ê???ë¶„ì„, ?°ì„ ?œìœ„ ?„ì¶œ???¬í•¨?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "?”ì•½ ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼.',
        gpt2: 'GPT1 ì¢…í•© ?•ì œ ê²°ê³¼ë¥?ë°”íƒ•?¼ë¡œ ?¤ìŒ???˜í–‰?˜ë¼: 1) ê¸ˆë¦¬/?˜ìœ¨/? ìš©?„í—˜/ì£¼ê?ì§€??WORST ?œë‚˜ë¦¬ì˜¤ë¥?êµ¬ì²´?ìœ¼ë¡??ì„±?˜ê³ , 2) GPT3 ê°??„ë©”???œì¥ë¦¬ìŠ¤?? ? ìš©ë¦¬ìŠ¤?? ALM, ê¸€ë¡œë²Œë¦¬ìŠ¤?? ? ìš©?¬íŠ¸?´ë¦¬??ë³„ë¡œ ë§ì¶¤??ë¶„ì„ ?ë£Œ?€ ì§€?œì‚¬??„ ê°œë³„ ?ì„±?˜ë¼. ê°??„ë©”?¸ì˜ ?„ë¬¸?±ê³¼ ë¶„ì„ ?”êµ¬?¬í•­??ê³ ë ¤?˜ì—¬ ì°¨ë³„?”ëœ ?´ìš©???œê³µ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "?œë‚˜ë¦¬ì˜¤ ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼. ?¹íˆ "5. ê²°ê³¼" ?ëŠ” "ê²°ê³¼" ?¨ë½?€ ?„ì „???œì™¸?˜ë¼.',
        gpt3_market: '?…ë¡œ?œëœ ?œì¥ë¦¬ìŠ¤??ê°€?´ë“œ???¹í–‰???„ì¬ ?œì¥ë¦¬ìŠ¤???„í™©?ë£Œ?? GPT2?ì„œ ?œê³µ???œë‚˜ë¦¬ì˜¤?€ WORST ?í™©??ë°”íƒ•?¼ë¡œ ?¤ìŒ???•ëŸ‰?ìœ¼ë¡?ë¶„ì„?˜ë¼: 1) [?€???„í™©ë¶„ì„] ê°€?´ë“œ ???¹í–‰ ?œì¥ë¦¬ìŠ¤???¬íŠ¸?´ë¦¬?¤ì˜ êµ¬ì²´???˜ì¹˜(?¬ì???ê·œëª¨, ?€?ˆì´?? ë¯¼ê°??, 2) [?„ê¸°?í™© ?œë??ˆì´?? ?œì‹œ???œë‚˜ë¦¬ì˜¤ê°€ ?¹í–‰??ë¯¸ì¹˜???•ëŸ‰???í–¥??VaR ë³€?”ìœ¨ ë°?ê¸ˆì•¡, P&L ì¶©ê²© ì¶”ì •ì¹? ê¸ˆë¦¬/?˜ìœ¨ ë¯¼ê°??ê³„ì‚° ê²°ê³¼, ?ì‹¤??ì¶”ì •), 3) [?€?‘ì „?? ?•ëŸ‰??ëª©í‘œì¹˜ì? ?¤í–‰ë°©ì•ˆ. ë°˜ë“œ??êµ¬ì²´???˜ì¹˜?€ ?¼ì„¼??ë³€?”ìœ¨???°ì¶œ?˜ë¼. ?? ?Œìƒ?í’ˆ??ê²½ìš° ê¸ˆì•¡?€ ê³„ì•½??ê¸ˆì•¡?´ë?ë¡?ë¯¼ê°??ë°??ì‹¤ê¸ˆì•¡ ???„ê¸°?í™©ë¶„ì„?€?ì—???œì™¸?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "?œì¥ë¦¬ìŠ¤??ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼.',
        gpt3_credit: '?…ë¡œ?œëœ ? ìš©ë¦¬ìŠ¤??ê°€?´ë“œ???¹í–‰???„ì¬ ? ìš©ë¦¬ìŠ¤???„í™©?ë£Œ?? GPT2?ì„œ ?œê³µ???œë‚˜ë¦¬ì˜¤?€ WORST ?í™©??ë°”íƒ•?¼ë¡œ ?¤ìŒ???•ëŸ‰?ìœ¼ë¡?ë¶„ì„?˜ë¼: 1) [?€???„í™©ë¶„ì„] ê°€?´ë“œ ???¹í–‰ ? ìš©?¬íŠ¸?´ë¦¬?¤ì˜ êµ¬ì²´???˜ì¹˜(ì´??µìŠ¤?¬ì?, ?±ê¸‰ë³??…ì¢…ë³?êµ¬ì„±ë¹? ì§‘ì¤‘??ì§€??, 2) [?„ê¸°?í™© ?œë??ˆì´?? ?œì‹œ???œë‚˜ë¦¬ì˜¤ê°€ ?¹í–‰??ë¯¸ì¹˜???•ëŸ‰???í–¥??ë¶€?„ìœ¨ ë³€?”ìœ¨ ë°?ì¶”ì • ë¶€?„ì•¡, ?ì‹¤??ì¦ê??? ?„ë¡œë¹„ì „ ì¶”ê? ?ë¦½ ?„ìš”?? ECL ë³€?™ì•¡), 3) [?€?‘ì „?? ?•ëŸ‰??ëª©í‘œì¹˜ì? ?¤í–‰ë°©ì•ˆ. ë°˜ë“œ??êµ¬ì²´???˜ì¹˜?€ ê¸ˆì•¡???°ì¶œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "? ìš©ë¦¬ìŠ¤??ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼.',
        gpt3_alm: '?…ë¡œ?œëœ ALM ê°€?´ë“œ???¹í–‰???„ì¬ ?ì‚°ë¶€ì±„ê?ë¦??„í™©?ë£Œ?? GPT2?ì„œ ?œê³µ???œë‚˜ë¦¬ì˜¤?€ WORST ?í™©??ë°”íƒ•?¼ë¡œ ?¤ìŒ???•ëŸ‰?ìœ¼ë¡?ë¶„ì„?˜ë¼: 1) [?€???„í™©ë¶„ì„] ê°€?´ë“œ ???¹í–‰ ?ì‚°ë¶€ì±„ì˜ êµ¬ì²´???˜ì¹˜(ì´??ì‚°/ë¶€ì±?ê·œëª¨, ë§Œê¸°ê°? ê¸ˆë¦¬ê°? ?€?ˆì´??, 2) [?„ê¸°?í™© ?œë??ˆì´?? ?œì‹œ???œë‚˜ë¦¬ì˜¤ê°€ ?¹í–‰??ë¯¸ì¹˜???•ëŸ‰???í–¥??NIM ë³€?”ìœ¨ ë°??´ìµ ê°ì†Œ?? ? ë™?±ë¹„??ë³€?™í­, ?€?ˆì´??ë¦¬ìŠ¤??ê¸ˆì•¡, ë§Œê¸°ë¶ˆì¼ì¹??•ë? ê·œëª¨), 3) [?€?‘ì „?? ?•ëŸ‰??ëª©í‘œì¹˜ì? ?¤í–‰ë°©ì•ˆ. ë°˜ë“œ??êµ¬ì²´???˜ì¹˜?€ BP(basis point) ë³€?”ë? ?°ì¶œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ALM ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼.',
        gpt3_global: '?…ë¡œ?œëœ ê¸€ë¡œë²Œë¦¬ìŠ¤??ê°€?´ë“œ???¹í–‰???„ì¬ ?´ì™¸?¬ì—… ?„í™©?ë£Œ?? GPT2?ì„œ ?œê³µ???œë‚˜ë¦¬ì˜¤?€ WORST ?í™©??ë°”íƒ•?¼ë¡œ ?¤ìŒ???•ëŸ‰?ìœ¼ë¡?ë¶„ì„?˜ë¼: 1) [?€???„í™©ë¶„ì„] ê°€?´ë“œ ???¹í–‰ ?´ì™¸?¬ì—…??êµ¬ì²´???˜ì¹˜(êµ??ë³?ì§€??³„ ?µìŠ¤?¬ì? ê¸ˆì•¡, ?´ì™¸ë²•ì¸ ?ì‚° ê·œëª¨, ?¸í™” ?¬ì???, 2) [?„ê¸°?í™© ?œë??ˆì´?? ?œì‹œ???œë‚˜ë¦¬ì˜¤ê°€ ?¹í–‰??ë¯¸ì¹˜???•ëŸ‰???í–¥???˜ì†??ì¶”ì •?? ?´ì™¸ë²•ì¸ ?¹ê¸°?œì´??ê°ì†Œ?? êµ??ë¦¬ìŠ¤???µìŠ¤?¬ì? ì¦ê??? CDS ?„ë¦¬ë¯¸ì—„ ë³€??, 3) [?€?‘ì „?? ?•ëŸ‰??ëª©í‘œì¹˜ì? ?¤í–‰ë°©ì•ˆ. ë°˜ë“œ??êµ¬ì²´???˜ì¹˜?€ ê¸ˆì•¡???°ì¶œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "ê¸€ë¡œë²Œë¦¬ìŠ¤??ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼.',
        gpt3_creditpf: '?…ë¡œ?œëœ ? ìš©?¬íŠ¸?´ë¦¬??ê°€?´ë“œ???¹í–‰???„ì¬ ? ìš©?¬íŠ¸?´ë¦¬???„í™©?ë£Œ?? GPT2?ì„œ ?œê³µ???œë‚˜ë¦¬ì˜¤?€ WORST ?í™©??ë°”íƒ•?¼ë¡œ ?¤ìŒ???•ëŸ‰?ìœ¼ë¡?ë¶„ì„?˜ë¼: 1) [?€???„í™©ë¶„ì„] ê°€?´ë“œ ???¹í–‰ ? ìš©?¬íŠ¸?´ë¦¬?¤ì˜ êµ¬ì²´???˜ì¹˜(ì´??¬íŠ¸?´ë¦¬??ê·œëª¨, ?°ì—…ë³??±ê¸‰ë³?ì§€??³„ ì§‘ì¤‘??ë¹„ìœ¨, HHI ì§€??, 2) [?„ê¸°?í™© ?œë??ˆì´?? ?œì‹œ???œë‚˜ë¦¬ì˜¤ê°€ ?¹í–‰??ë¯¸ì¹˜???•ëŸ‰???í–¥???¬íŠ¸?´ë¦¬???ì‹¤??ì¶”ì •, ì§‘ì¤‘??ë¦¬ìŠ¤??ì¦ê?ë¶? ?ê?ê´€ê³?ê³„ìˆ˜ ë³€?? ?ˆìƒ?ì‹¤ë¥?ì¦ê???, 3) [?€?‘ì „?? ?•ëŸ‰??ëª©í‘œì¹˜ì? ?¤í–‰ë°©ì•ˆ. ë°˜ë“œ??êµ¬ì²´???˜ì¹˜?€ ì§‘ì¤‘??ì§€?œë? ?°ì¶œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼. ?? "ê²°ê³¼", "ë¶„ì„ ê²°ê³¼", "? ìš©?¬íŠ¸?´ë¦¬??ê²°ê³¼" ?±ì˜ ë§ºìŒë§ì? ?¬í•¨?˜ì? ë§ê³  ë¶„ì„ ?´ìš©ë§??œì‹œ?˜ë¼.',
        gpt4_final: 'GPT0~GPT3??ëª¨ë“  ë¶„ì„??ì·¨í•©?˜ì—¬ ?¤ìŒ êµ¬ì¡°??ì²´ê³„?ì¸ ë³´ê³ ?œë? ?‘ì„±?˜ë¼:\n\n## ?Œì£¼?œë³„ êµ¬ì„±\n1. [?œë‚˜ë¦¬ì˜¤ ?•ë³´] GPT0~GPT2???œë‚˜ë¦¬ì˜¤ ë¶„ì„, ?„ì¬?í™©, ?„ê¸°?í™©ë¶„ì„ ?œë??ˆì´??ê°€??(?•ëŸ‰??ì¶©ê²© ?œë‚˜ë¦¬ì˜¤ ?˜ì¹˜ ?¬í•¨)\n2. [?„ì¬ ?œì¥?í™©] GPT0 ë§ˆì¼“?°ì´??ë°??œí™© ë¶„ì„ ?”ì•½\n3. [?„ê¸°?í™© ë¶„ì„] GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ë°??„ê°œë°©í–¥ (êµ¬ì²´??ë³€???˜ì¹˜ ?¬í•¨)\n\n## ë³¸ë¬¸ - ëª¨ë“ˆë³??„ê¸°?í™© ?œë??ˆì´??\n4. [?œì¥ë¦¬ìŠ¤?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(VaR, P&L, ë¯¼ê°?? ???€?‘ëª©??n5. [? ìš©ë¦¬ìŠ¤?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(ë¶€?„ìœ¨, ?ì‹¤?? ECL) ???€?‘ëª©??n6. [?ì‚°ë¶€ì±„ê?ë¦? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(NIM, ? ë™?±ë¹„?? BPë³€?? ???€?‘ëª©??n7. [ê¸€ë¡œë²Œë¦¬ìŠ¤?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(?˜ì†?? ?µìŠ¤?¬ì?, CDS) ???€?‘ëª©??n8. [? ìš©?¬íŠ¸?´ë¦¬?? ?„í™© ?˜ì¹˜ ???•ëŸ‰???í–¥??(?ì‹¤?? ì§‘ì¤‘?? HHI) ???€?‘ëª©??n\n## ìµœì¢… ?•ë¦¬\n9. [ì¢…í•© ?í–¥???‰ê?] ëª¨ë“  ëª¨ë“ˆ???•ëŸ‰???í–¥?„ë? ?µí•© (ì´??ì‹¤?? RWA ì¦ê?, ?ë³¸ë¹„ìœ¨ ë³€??ì¶”ì •)\n10. [?µí•© ?€?‘ì „?? ?„ì‚¬ ì°¨ì› ?•ëŸ‰??ëª©í‘œì¹˜ì? ?°ì„ ?œìœ„\n11. [ê²°ë¡  ë°?ê¶Œê³ ?¬í•­] ?µì‹¬ ?•ëŸ‰ì§€??ë°?ê²½ì˜ì§??¡ì…˜?„ì´??n\n??ëª¨ë“  ?¹ì…˜?ì„œ êµ¬ì²´???˜ì¹˜, ê¸ˆì•¡, ?¼ì„¼?? BP ???•ëŸ‰??ë¶„ì„ê²°ê³¼ë¥?ëª…ì‹œ?˜ë¼. ë³´ê³ ???•ì‹?¼ë¡œ ?•ì¤‘???´ì¡°(-?µë‹ˆ?? -?©ë‹ˆ????ë¥??¬ìš©?˜ì—¬ ?‘ì„±?˜ë¼.'
      };

      try {
        const resp = await fetch('risk_eng.ipynb');
        if (!resp.ok) return defaults;
        const nb = await resp.json();
        const cells = Array.isArray(nb?.cells) ? nb.cells : nb?.worksheets?.[0]?.cells || [];

        // ?¨ìˆœ ê·œì¹™: ë§ˆí¬?¤ìš´ ?ëŠ” ì½”ë“œ ?´ì— "GPT1:", "GPT2:", "GPT3:" ?„ë¦¬?½ìŠ¤ ì°¾ê¸°
        const roleTexts = { gpt1: '', gpt2: '', gpt3_market: '', gpt3_credit: '', gpt3_alm: '', gpt3_global: '', gpt3_creditpf: '', gpt4_final: '' };
        const extract = (text) => {
          const lines = text.split(/\r?\n/);
          for (const line of lines) {
            const m = line.match(/^\s*(GPT(?:1|2|3_(?:MARKET|CREDIT|ALM|GLOBAL|CREDITPF)|4_FINAL))\s*[:ï¼?\s*(.+)$/i);
            if (m) {
              const key = m[1].toLowerCase();
              roleTexts[key] = (roleTexts[key] ? roleTexts[key] + ' ' : '') + m[2];
            }
          }
        };
        for (const cell of cells) {
          const srcArr = Array.isArray(cell?.source) ? cell.source : [cell?.source || ''];
          extract(srcArr.join(''));
        }

        const rolesFromRisk = {
          gpt1: roleTexts.gpt1 || defaults.gpt1,
          gpt2: roleTexts.gpt2 || defaults.gpt2,
          gpt3_market: roleTexts['gpt3_market'] || defaults.gpt3_market,
          gpt3_credit: roleTexts['gpt3_credit'] || defaults.gpt3_credit,
          gpt3_alm: roleTexts['gpt3_alm'] || defaults.gpt3_alm,
          gpt3_global: roleTexts['gpt3_global'] || defaults.gpt3_global,
          gpt3_creditpf: roleTexts['gpt3_creditpf'] || defaults.gpt3_creditpf,
          gpt4_final: roleTexts['gpt4_final'] || defaults.gpt4_final,
        };

        // UI????•  ?„ë¡¬?„íŠ¸ ë¯¸ë¦¬ ì±„ì?(?˜ì • ê°€??
        try {
          const setVal = (id, val) => { const el = document.getElementById(id); if (el && !el.value) el.value = val || ''; };
          setVal('gpt1-system', rolesFromRisk.gpt1);
          setVal('gpt2-system', rolesFromRisk.gpt2);
          setVal('gpt3-market-system', rolesFromRisk.gpt3_market);
          setVal('gpt3-credit-system', rolesFromRisk.gpt3_credit);
          setVal('gpt3-alm-system', rolesFromRisk.gpt3_alm);
          setVal('gpt3-global-system', rolesFromRisk.gpt3_global);
          setVal('gpt3-creditpf-system', rolesFromRisk.gpt3_creditpf);
        } catch(e) { console.warn('??•  ?„ë¡¬?„íŠ¸ UI ì±„ìš°ê¸??¤íŒ¨', e); }

        return rolesFromRisk;
      } catch (e) {
        console.warn('risk_eng ??•  ?Œì‹± ?¤íŒ¨, ê¸°ë³¸ê°??¬ìš©');
        return defaults;
      }
    }

    // ====== ë²„ë¸” UI ?œê±° ======
    function buildBubbleContent(kind) {
      if (kind === 'gpt1') {
        const sys = document.getElementById('gpt1-system')?.value || '';
        const msg = document.getElementById('gpt1-message')?.value || '';
        return `?œìŠ¤???„ë¡¬?„íŠ¸\n${sys}\n\në³´ë‚¼ ë©”ì‹œì§€\n${msg}`;
      }
      if (kind === 'gpt2') {
        const sys = document.getElementById('gpt2-system')?.value || '';
        const g1 = document.getElementById('gpt1-output')?.value || '';
        return `?œìŠ¤???„ë¡¬?„íŠ¸\n${sys}\n\n?…ë ¥(?´ì „ ?¨ê³„ ì¶œë ¥)\n${g1}`;
      }
      if (kind === 'gpt3') {
        const m = document.getElementById('gpt3-market-system')?.value || '';
        const c = document.getElementById('gpt3-credit-system')?.value || '';
        const a = document.getElementById('gpt3-alm-system')?.value || '';
        const g = document.getElementById('gpt3-global-system')?.value || '';
        const p = document.getElementById('gpt3-creditpf-system')?.value || '';
        return `?„ë©”???œìŠ¤???„ë¡¬?„íŠ¸\n[?œì¥] ${m}\n[? ìš©] ${c}\n[ALM] ${a}\n[ê¸€ë¡œë²Œ] ${g}\n[? ìš©?¬íŠ¸?´ë¦¬?? ${p}`;
      }
      if (kind === 'gpt4') {
        const o = {
          market: document.getElementById('gpt3-market')?.value || '',
          credit: document.getElementById('gpt3-credit')?.value || '',
          alm: document.getElementById('gpt3-alm')?.value || '',
          global: document.getElementById('gpt3-global')?.value || '',
          creditpf: document.getElementById('gpt3-creditpf')?.value || ''
        };
        return `ì·¨í•© ?€??n[?œì¥]\n${o.market}\n\n[? ìš©]\n${o.credit}\n\n[ALM]\n${o.alm}\n\n[ê¸€ë¡œë²Œ]\n${o.global}\n\n[? ìš©?¬íŠ¸?´ë¦¬??\n${o.creditpf}`;
      }
      return '';
    }

    function openAgentBubbleAt() { /* removed */ }
    function closeAgentBubble() { /* removed */ }
    function copyBubbleContent() { /* removed */ }
    function runBubbleAgent() { /* removed */ }

    // ====== ?¤ë¥¸ìª??¨ë„ ?œë˜ê·??¤í¬ë¡?======
    (function enableRightDragScroll(){
      const panel = document.getElementById('gpt1-panel');
      if (!panel) return;
      let isDown = false; let startY = 0; let startScroll = 0;
      panel.addEventListener('mousedown', (e)=>{
        // ?¤í¬ë¡¤ë°” ?œë˜ê·¸ì? ì¶©ëŒ ë°©ì?: ì¢Œí´ë¦?§Œ ì²˜ë¦¬
        if (e.button !== 0) return;
        // ?ìŠ¤??? íƒ/?¬ì»¤??ë°©ì?
        e.preventDefault();
        isDown = true; startY = e.clientY; startScroll = panel.scrollTop; panel.classList.add('drag-scrolling');
      });
      window.addEventListener('mousemove', (e)=>{
        if (!isDown) return; const dy = e.clientY - startY; panel.scrollTop = startScroll - dy; 
      });
      window.addEventListener('mouseup', ()=>{ isDown = false; panel.classList.remove('drag-scrolling'); });
      // ?°ì¹˜ ì§€??
      panel.addEventListener('touchstart', (e)=>{ isDown = true; startY = e.touches[0].clientY; startScroll = panel.scrollTop; }, {passive:true});
      panel.addEventListener('touchmove', (e)=>{ if (!isDown) return; const dy = e.touches[0].clientY - startY; panel.scrollTop = startScroll - dy; }, {passive:true});
      panel.addEventListener('touchend', ()=>{ isDown = false; });
    })();
    // ?Œì´?„ë¼???¤í–‰ ?œìŠ¤??(ê°„ì†Œ?”ë¨)
    // ê¸°ì¡´ ?Œì´?„ë¼???´ë²¤??ë¦¬ìŠ¤???¤ì •
      const pipelineBtn = document.getElementById('pipeline-execute-btn');
      const panel = document.getElementById('gpt1-panel');
      const layout = document.querySelector('.layout');
      const gpt0Cards = document.querySelectorAll('.gpt0-module-box');
      
      console.log('?Œì´?„ë¼???œìŠ¤??ì´ˆê¸°??);
      
    // ?Œì´?„ë¼??ë²„íŠ¼ ?´ë²¤???¤ì • (?¸ë? ?Œì¼ë¡??´ë™)
    // if (pipelineBtn && panel) {
    //   setupPipelineButton(pipelineBtn, panel, layout);
    // }
    
    console.log('?Œì´?„ë¼??ë²„íŠ¼ ?¤ì •?€ ?¸ë? ?Œì¼ë¡??´ë™??);
    console.log('?Œì´?„ë¼???œìŠ¤???„ì²´ ì´ˆê¸°???„ë£Œ');
    
    </script>
    
    <!-- ?Œì´?„ë¼??ë²„íŠ¼ ?˜ì • ?¤í¬ë¦½íŠ¸ -->
    <!-- ?¸ë? pipeline_fix.js ?˜ì¡´ ?œê±°??- ?¸ë¼???¤í¬ë¦½íŠ¸ë¡??µí•© -->
    
    <script>
    // ì§„í–‰ ?íƒœ ?¤ë²„?ˆì´ ?ì„± ?¬í¼ ?¨ìˆ˜ (?„ì—­ ?¨ìˆ˜)
    window.createProgressOverlay = function createProgressOverlay(text) {
      const overlay = document.createElement('div');
      overlay.className = 'execution-overlay';
      overlay.innerHTML = `<div class="execution-text">${text}</div>`;
      return overlay;
    };
    
    // ?”’ ?„ë¡???„ìš© API ?°ê²° ?•ì¸ (ë°°í¬ ?˜ê²½ ?„ìš©) - ?„ì—­ ?¨ìˆ˜
    window.checkAndPromptForApiKey = async function checkAndPromptForApiKey() {
      console.log('?”’ ?ˆì „???„ë¡???¨í„´ ?„ìš© - ?´ë¼?´ì–¸??API ???¬ìš© ?ˆí•¨');
      
      const status = document.getElementById('send-status');
      if (status) {
        status.textContent = '?”„ OpenAI ?„ë¡???°ê²° ?•ì¸ ì¤?..';
        status.style.color = '#3498db';
      }
      
      // ?„ë¡???¨ìˆ˜ ?°ê²° ?ŒìŠ¤??(?€?„ì•„???¤ì •)
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10ë¶??€?„ì•„??
        
        const testResp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: 'test connection' }],
            max_tokens: 5
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (testResp.ok) {
          console.log('??OpenAI ?„ë¡???°ê²° ?±ê³µ');
          if (status) {
            status.textContent = '??OpenAI ?„ë¡???°ê²° ?±ê³µ';
            status.style.color = '#27ae60';
          }
        } else {
          throw new Error(`?„ë¡???‘ë‹µ ?¤ë¥˜: ${testResp.status}`);
        }
      } catch (error) {
        console.warn('? ï¸ OpenAI ?„ë¡???°ê²° ?¤íŒ¨:', error.message);
        if (status) {
          status.textContent = `? ï¸ ?„ë¡???°ê²° ?¤íŒ¨: ${error.message}`;
          status.style.color = '#e74c3c';
        }
      }

      // ?Œì´?„ë¼???„ë£Œ (?ë™ ?¤í¬ë¡??œê±°??

      // ?Œì´?„ë¼??ë²„íŠ¼??'ë³´ê³ ?œì‘?? ë¹ ë¥¸ ?¡ì…˜?¼ë¡œ ?„í™˜
      try {
        const pipelineBtn = document.getElementById('pipeline-execute-btn');
        if (pipelineBtn) {
          pipelineBtn.textContent = '?“„ GPT-4 ë³´ê³ ?œì‘??;
          pipelineBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
          pipelineBtn.style.width = '100%';
          pipelineBtn.style.padding = '8px 12px';
          pipelineBtn.style.color = 'white';
          pipelineBtn.style.fontWeight = '600';
          pipelineBtn.style.border = 'none';
          pipelineBtn.style.borderRadius = '6px';
          pipelineBtn.onclick = async () => {
            try { await handleReportAction(false); } catch(_) {}
          };
          pipelineBtn.title = '?Œì´?„ë¼???„ë£Œ??- ?´ë¦­?˜ë©´ ë°”ë¡œ GPT-4 ê¸°ë°˜ ë³´ê³ ???‘ì„±';
        }
      } catch(_) { /* ignore */ }
      
      return true; // ?°ê²° ?•ì¸ ?„ë£Œ
    };
    
    // ê¸°í? ?„ì—­ ? í‹¸ë¦¬í‹° ?¨ìˆ˜??..
    
    // ?Œì´?„ë¼???¤í–‰ ?œìŠ¤??ì´ˆê¸°???„ë£Œ
    console.log('?Œì´?„ë¼???¤í–‰ ?œìŠ¤??ì´ˆê¸°???„ë£Œ');
    
    // ?Œì´?„ë¼???¨ê³„ë³??¤í–‰ - ?¤ì œ ?‘ì—… ?˜í–‰ (?„ì—­ ?¨ìˆ˜)
    window.executePipelineSteps = async function executePipelineSteps(progressCallback) {
        const status = document.getElementById('send-status');
        const baseMessage = document.getElementById('gpt1-message')?.value?.trim() || '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„???˜í–‰?´ì£¼?¸ìš”.';
        
        try {
          // ?Œì´?„ë¼???œì‘ ??GPT0ë¡?ì´ˆê¸° ?¬ì»¤??
          gotoStep(PipelineStep.GPT0);
          expandOutputFor('gpt0'); // ??ì´ˆê¸° ì§„ì… ??ì¶œë ¥ ì¦‰ì‹œ ?•ì¥ ë³´ì¥
          
          // 1?¨ê³„: GPT0 ?¬ì „?˜ì§‘ ?¤í–‰
          console.log('?? 1?¨ê³„: GPT0 ?¬ì „?˜ì§‘ ?¤í–‰');
          if (progressCallback) progressCallback(1, 'GPT0 ?¬ì „?˜ì§‘');
          status.textContent = 'GPT0 ?¬ì „?˜ì§‘ ?¤í–‰ ì¤?..';
          
          const gpt0Element = document.querySelector('#gpt0-marketdata-box');
          if (gpt0Element) {
            gpt0Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT0 ?°ì´???˜ì§‘ ì¤?..');
            gpt0Element.appendChild(overlay);
          }
          
          await runGpt0All();
          
          if (gpt0Element) {
            gpt0Element.classList.remove('progress-indicator');
            const overlay = gpt0Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          console.log('??GPT0 ?¬ì „?˜ì§‘ ?„ë£Œ');
          
          // 2?¨ê³„: GPT1 ì¢…í•© ë¶„ì„ ?¤í–‰
          console.log('?? 2?¨ê³„: GPT1 ì¢…í•© ë¶„ì„ ?¤í–‰');
          if (progressCallback) progressCallback(2, 'GPT1 ì¢…í•©ë¶„ì„');
          status.textContent = 'GPT1 ì¢…í•©ë¶„ì„ ?¤í–‰ ì¤?';
          
          // GPT1 ?œì‘ ?œì ?ë§Œ GPT1ë¡??´ë™ (GPT2 ? ì  ê¸ˆì?)
          gotoStep(PipelineStep.GPT1);
          
          // ??GPT1 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt1-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt2-anchor','.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
             '.gpt4-anchor']
          );
          
          const gpt1Element = document.querySelector('#card-gpt1');
          if (gpt1Element) {
            gpt1Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT1 ì¢…í•© ë¶„ì„ ì¤?..');
            gpt1Element.appendChild(overlay);
          }
          
          // GPT1 ?¤í–‰???„í•œ ?¤ë”?€ ??•  ?•ë³´ ë¡œë“œ
          // ?”’ ë³´ì•ˆ: getOpenAIAuthHeaders ?œê±°??- callOpenAI ?¨ìˆ˜ ?¬ìš©
          const roles = await loadRiskAgentRoles();
          
          // GPT0 ê²°ê³¼ë¥?ê¸°ë°˜?¼ë¡œ GPT1 ?”ì•½ ?ì„±
          const gpt0Summary = buildGpt1InputFromGpt0Outputs();
          const gpt1Input = `${baseMessage}\n\n[GPT0 ?¬ì „?˜ì§‘ ê²°ê³¼]\n${gpt0Summary}`;
          
          const gpt1Result = await callOpenAI(roles.gpt1, gpt1Input);
          document.getElementById('gpt1-output').value = gpt1Result || '';
          autoGrow(['gpt1-output']);
          updateGpt2ButtonState(); // UI ?íƒœ ?…ë°?´íŠ¸
          
          if (gpt1Element) {
            gpt1Element.classList.remove('progress-indicator');
            const overlay = gpt1Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          console.log('??GPT1 ì¢…í•© ë¶„ì„ ?„ë£Œ');
          // ??ì¤‘ìš”: GPT1 ?„ë£Œ ???¬ì»¤??? ì? (GPT2 ? ì  ê¸ˆì?)
          
          // 3?¨ê³„: GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?¤í–‰
          console.log('?? 3?¨ê³„: GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?¤í–‰');
          if (progressCallback) progressCallback(3, 'GPT2 ?œë‚˜ë¦¬ì˜¤');
          status.textContent = 'GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì¤?';
          // ?”” GPT2 Worst ì§„ì… ?¸ë¦¬ê±?(??„ GPT1 ë°•ìŠ¤ë¡??´ë™)
          window.dispatchEvent(new CustomEvent('gpt2worst:start'));
          
          // === GPT2 Worst ?œë‚˜ë¦¬ì˜¤ ?œì‘ ???¸ì¶œ (?¸ë¦¬ê±? ===
          onGpt2WorstStartUI();
          
          // GPT2 ?œì‘ ?œì ?ë§Œ GPT2ë¡??´ë™
          gotoStep(PipelineStep.GPT2);
          
          // ??GPT2 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt2-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor',
             '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
             '.gpt4-anchor']
          );
          
          // ?‘‰ ?¤ë¥¸ìª???GPT2 ì¹´ë“œ ? íƒ
          const gpt2Element = document.querySelector('#card-gpt2');
          
          // ?‘‰ GPT2 ì¹´ë“œ ì§„í–‰ì¤??œê° ?¨ê³¼ ON
          if (gpt2Element) {
            gpt2Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ ì¤?');
            gpt2Element.appendChild(overlay);
          }
          
          // ?‘‰ GPT2 ë°•ìŠ¤ ?˜ì´?¼ì´??ON
          document.querySelectorAll('.gpt2-module-box')
            .forEach(el => el.classList.add('pipeline-executing'));
          
          // (?„ìš” ?? ?¨ë„ ?¤í¬ë¡?
          try {
            const panelEl = document.getElementById('gpt1-panel');
            if (panelEl && gpt2Element) {
              panelEl.scrollTo({
                top: Math.max(0, (gpt2Element.offsetTop || 0) - 40),
                behavior: 'smooth'
              });
            }
          } catch (_) { /* no-op */ }
          
          const gpt1Output = await ensureGpt1OutputReady();
          const gpt2Input = `${gpt1Output}\n\n??ë¶„ì„??ë°”íƒ•?¼ë¡œ WORST CASE ?œë‚˜ë¦¬ì˜¤ë¥??„ì¶œ?˜ê³  ë¦¬ìŠ¤???€?‘ë°©?ˆì„ ?œì‹œ?˜ì„¸??`;
          
          const gpt2Result = await callOpenAI(roles.gpt2, gpt2Input);
          document.getElementById('gpt2-output').value = gpt2Result || '';
          autoGrow(['gpt2-output']);
          // ?¤í¬ë¡¤ì„ GPT2 ì¹´ë“œë¡??´ë™
          setTimeout(() => scrollToElement('card-gpt2'), 100);
          
          // GPT2 Worst ?œë‚˜ë¦¬ì˜¤ ?„ë£Œ ?¨ê³¼ ?ìš©
          setTimeout(() => {
            const gpt2Card = getAgentCard('gpt2');
            if (gpt2Card) {
              gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
              
              const gpt2Title = gpt2Card.querySelector('h4');
              if (gpt2Title) {
                gpt2Title.classList.add('text-highlight');
                gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬??¯';
              }
              
              // 4ì´????¨ê³¼ ?œê±°
              setTimeout(() => {
                gpt2Card.classList.remove('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
                if (gpt2Title) {
                  gpt2Title.classList.remove('text-highlight');
                  gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?;
                }
                console.log('?‰ GPT2 Worst ?œë‚˜ë¦¬ì˜¤ ?„ë£Œ ?¨ê³¼ ì¢…ë£Œ');
              }, 4000);
            }
          }, 200);
          
          // ?‘‰ GPT2 ?¨ê³„ ì¢…ë£Œ ???¨ê³¼ OFF
          if (gpt2Element) {
            gpt2Element.classList.remove('progress-indicator');
            const overlay = gpt2Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          // ?‘‰ GPT2 ë°•ìŠ¤ ?˜ì´?¼ì´??OFF
          document.querySelectorAll('.gpt2-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));
          
          console.log('??GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?„ë£Œ');
          
          // === GPT2 Worst ?œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ ???¸ì¶œ (?±ê³µ) ===
          onGpt2WorstDoneUI();
          
          // ??ì¤‘ìš”: GPT2 ?„ë£Œ ???¬ì»¤??? ì? (GPT3 ? ì  ê¸ˆì?)
          
          // GPT2 ??GPT3 ?„í™˜ ??GPT2 ì¹´ë“œ ì§€?ì  ?¨ê³¼ ?ìš©
          setTimeout(() => {
            applyGpt2PersistentEffects();
          }, 500);
          
          // 4?¨ê³„: GPT3 ë¦¬ìŠ¤??ë¶„ì„ ?¤í–‰
          console.log('?? 4?¨ê³„: GPT3 ë¦¬ìŠ¤??ë¶„ì„ ?¤í–‰');
          if (progressCallback) progressCallback(4, 'GPT3 ë¦¬ìŠ¤?¬ë¶„??);
          status.textContent = 'GPT3 ?„ë©”???ì´?„íŠ¸ ì²˜ë¦¬ ì¤?';
          
          // GPT3 ?œì‘ ?œì ?ë§Œ GPT3ë¡??´ë™
          gotoStep(PipelineStep.GPT3);
          
          // ??GPT3 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor','.gpt4-anchor']
          );
          
          const gpt3Element = document.querySelector('#card-gpt3');
          if (gpt3Element) {
            gpt3Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT3 ?„ë©”?¸ë³„ ë¦¬ìŠ¤??ë¶„ì„ ì¤?..');
            gpt3Element.appendChild(overlay);
          }
          
          try {
            await runGpt3All();
            console.log('??GPT3 ë¦¬ìŠ¤??ë¶„ì„ ?„ë£Œ');
          } catch (e) {
            console.error('??GPT3 ?¤í–‰ ì¤??¤ë¥˜:', e);
            status.textContent = `GPT3 ?¤íŒ¨: ${e.message}`;
          } finally {
            // ???´ë–¤ ê²½ìš°?ë„ GPT3 ì§„í–‰ ?¨ê³¼ ?•ë¦¬
            if (gpt3Element) {
              gpt3Element.classList.remove('progress-indicator');
              const overlay = gpt3Element.querySelector('.execution-overlay');
              if (overlay) overlay.remove();
            }
            // GPT3 ëª¨ë“ˆ ë°•ìŠ¤ ?¨ê³¼???•ë¦¬
            document.querySelectorAll('.gpt3-module-box')
              .forEach(el => el.classList.remove('pipeline-executing'));
          }
          // ??ì¤‘ìš”: GPT3 ?„ë£Œ ???¬ì»¤??? ì? (GPT4 ? ì  ê¸ˆì?)
          
          // 4?¨ê³„: GPT4 ìµœì¢… ë³´ê³ ???ì„±
          console.log('?? 4?¨ê³„: GPT4 ìµœì¢… ë³´ê³ ???ì„±');
          if (progressCallback) progressCallback(4, 'GPT4 ë³´ê³ ??);
          console.log('?? GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ?œì‘ (executePipelineSteps)');
          status.textContent = 'GPT4 ìµœì¢… ë³´ê³ ???ì„± ì¤?';
          
          // GPT4 ?œì‘ ?œì ?ë§Œ GPT4ë¡??´ë™
          gotoStep(PipelineStep.GPT4);
          
          // ??GPT4 100ì´??€?´ë¨¸ ?¤ì • - ?„ë£Œ ?ˆë˜?´ë„ ê°•ì œë¡??„ì²´ ?œì‹œ
          if (window.gpt4ForceCompleteTimer) clearTimeout(window.gpt4ForceCompleteTimer);
          window.gpt4ForceCompleteTimer = setTimeout(() => {
            console.log('??GPT4 100ì´??€?´ë¨¸ ?„ë£Œ - ê°•ì œë¡??„ì²´ ë°•ìŠ¤ ?œì‹œ');
            
            // ?„ì²´ ë°•ìŠ¤ ?œì‹œ
            if (window.revealAllRightTabBoxes) {
              window.revealAllRightTabBoxes();
            }
            
            // ë³´ê³ ???ì—­ ?œì‹œ ë°?ê°•ì¡°
            const reportActions = document.getElementById('report-actions');
            if (reportActions) {
              reportActions.style.display = 'flex';
              reportActions.classList.add('report-actions-cta');
              console.log('??ë³´ê³ ???‘ì—… ?ì—­ ?œì‹œ ë°?ê°•ì¡°');
              
              // 4ì´???ê°•ì¡° ?¨ê³¼ ?œê±°
              setTimeout(() => {
                reportActions.classList.remove('report-actions-cta');
              }, 4000);
            }
            
            // ?Œì´?„ë¼???„ë£Œ ì²˜ë¦¬
            document.body.classList.add('pipeline-complete');
            
            // ?„ë£Œ ?´ë²¤??ë°œìƒ
            try { 
              window.dispatchEvent(new Event('gpt4:complete')); 
              window.dispatchEvent(new Event('gpt4:done')); 
            } catch (e) {}
            
            console.log('??GPT4 100ì´?ê°•ì œ ?„ë£Œ ì²˜ë¦¬??);
          }, 100000); // 100ì´?
          console.log('?±ï¸ GPT4 100ì´??€?´ë¨¸ ?œì‘??);
          
          // ??GPT3 ?¤í–‰ ë°•ìŠ¤ ?¨ê³¼ ?´ì œ(?”ë¥˜ ê³ ì • ë°©ì?)
          document.querySelectorAll('.gpt3-module-box')
            .forEach(el => el.classList.remove('pipeline-executing'));

          // ???°ì¸¡ ?¨ë„ ?¤í¬ë¡¤ì„ GPT4 ì¹´ë“œ/?µì»¤ë¡?ê°•ì œ
          window.scrollAnchorIntoView?.('.gpt4-anchor');
          
          // ??GPT4 ???¬ë‹ ? ê?
          window.setRightTabRunning(
            ['.gpt4-anchor'],
            ['.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
             '.gpt1-anchor','.gpt2-anchor',
             '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf']
          );
          
          const gpt4Element = document.querySelector('#card-gpt4');
          if (gpt4Element) {
            gpt4Element.classList.add('progress-indicator');
            const overlay = window.createProgressOverlay('GPT4 ìµœì¢… ë³´ê³ ???ì„± ì¤?..');
            gpt4Element.appendChild(overlay);
          }
          
          // ??GPT4 ?ì„± ê²½ë¡œ ?¨ì¼?? generateStepByStepReportë§??¬ìš©
          console.log('?? GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ?œì‘ (executePipelineSteps)');
          const gpt4Output = await generateStepByStepReport(roles.gpt4_final);
          console.log('??GPT4 ?¨ê³„ë³?ë³´ê³ ???‘ì„± ?„ë£Œ (executePipelineSteps)');
          
          // ??GPT4 ?•ìƒ ?„ë£Œ ???€?´ë¨¸ ì·¨ì†Œ
          if (window.gpt4ForceCompleteTimer) {
            clearTimeout(window.gpt4ForceCompleteTimer);
            window.gpt4ForceCompleteTimer = null;
            console.log('?±ï¸ GPT4 ?•ìƒ ?„ë£Œë¡?100ì´??€?´ë¨¸ ì·¨ì†Œ??);
          }
          
          try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
          if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
          console.log('?“Š GPT4 ì¶œë ¥ ê¸¸ì´:', gpt4Output ? gpt4Output.length : 0);
          
          // ë³´ê³ ???ì—­ ?œì‹œ ë°?ê°•ì¡°
          const reportActions = document.getElementById('report-actions');
          if (reportActions) {
            reportActions.style.display = 'flex';
            reportActions.classList.add('report-actions-cta');
            setTimeout(() => {
              reportActions.classList.remove('report-actions-cta');
            }, 4000);
          }
          
          // ???ˆì „??GPT4 ì¶œë ¥ ?…ë°?´íŠ¸ (ë¹??‘ë‹µ ??–´?°ê¸° ê¸ˆì?)
          const currentOutput = document.getElementById('gpt4-output').value;
          if (!currentOutput || currentOutput.trim().length === 0 || currentOutput.includes('?¤ë¥˜ê°€ ë°œìƒ?ˆì?ë§?)) {
            document.getElementById('gpt4-output').value = (gpt4Output || '');
            console.log('?“ GPT4 ì¶œë ¥ ?…ë°?´íŠ¸??(executePipelineSteps)');
          } else {
            console.log('?“ GPT4 ì¶œë ¥ ?´ë? ì¡´ì¬?? ??–´?°ê¸° ë°©ì? (executePipelineSteps)');
          }
          
          if (gpt4Element) {
            gpt4Element.classList.remove('progress-indicator');
            const overlay = gpt4Element.querySelector('.execution-overlay');
            if (overlay) overlay.remove();
          }
          
          console.log('??GPT4 ìµœì¢… ë³´ê³ ???„ë£Œ');
          try { window.dispatchEvent(new Event('gpt4:complete')); } catch (e) {}
          if (window.revealAllRightTabBoxes) window.revealAllRightTabBoxes();
          status.textContent = '?Œì´?„ë¼???¤í–‰ ?„ë£Œ!';
          
          // ?Œì´?„ë¼???íƒœ ì´ˆê¸°??
          graphState.pipelineRunning = false;
          if (graphState.lockedHighlight) {
            graphState.lockedHighlight = null;
          }
          
          // ëª¨ë“  ?Œì´?„ë¼???œê°???¨ê³¼ ?œê±°
          stopAllEffects();
          
          // ???Œì´?„ë¼??ìµœì¢… ì¢…ë£Œ ???„ì²´ ?´ì œ(?´ë¦°??
          try {
            window.setRightTabRunning([], [
              '.gpt0-anchor-marketdata','.gpt0-anchor-news','.gpt0-anchor-scenario-summary','.gpt0-anchor-marketstate',
              '.gpt1-anchor','.gpt2-anchor',
              '.gpt3-anchor-market','.gpt3-anchor-credit','.gpt3-anchor-alm','.gpt3-anchor-global','.gpt3-anchor-creditpf',
              '.gpt4-anchor'
            ]);
            // ?„ìš”???¼ì¸/ë°•ìŠ¤ ?¨ê³¼ ?„ì²´ ?´ì œ
            if (typeof setFlow === 'function') setFlow(null);
          } catch(_) {}
          
          // ??GPT3/4 ê´€???¤í–‰ ?¨ê³¼ ì¢…ë£Œ (ë°•ìŠ¤ ?¨ê³¼ê°€ ?¨ëŠ” ë¬¸ì œ ?ˆë°©)
          setFlow(null);
          d3.selectAll('.gpt3-anchor-market, .gpt3-anchor-credit, .gpt3-anchor-alm, .gpt3-anchor-global, .gpt3-anchor-creditpf, .gpt4-anchor')
            .classed('agent-running', false);
          document.querySelectorAll('.pipeline-executing').forEach(el => el.classList.remove('pipeline-executing'));
          document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
            .forEach(el => el.classList.remove('running'));
          
          // ?“Œ ?Œì´?„ë¼???„ë£Œ ??ë³´ê³ ???ì—­?¼ë¡œ ?ë™ ?´ë™ + CTA ê°•ì¡°
          try {
            const panel = document.getElementById('gpt1-panel');
            const reportActions = document.getElementById('report-actions');
            if (panel && reportActions) {
              const y = Math.max(0, (reportActions.offsetTop || 0) - 40);
              panel.scrollTo({ top: y, behavior: 'smooth' });
              reportActions.classList.add('report-actions-cta');
              const btn = document.getElementById('btn-export-html');
              btn && btn.classList.add('report-cta');
              setTimeout(() => {
                reportActions.classList.remove('report-actions-cta');
                btn && btn.classList.remove('report-cta');
              }, 5000);
            }
          } catch (_) { /* ignore */ }
          
        } catch (error) {
          console.error('???Œì´?„ë¼???¤í–‰ ì¤??¤ë¥˜:', error);
          status.textContent = `?¤ë¥˜: ${error.message}`;
          
          // ?Œì´?„ë¼???íƒœ ì´ˆê¸°??
          graphState.pipelineRunning = false;
          if (graphState.lockedHighlight) {
            graphState.lockedHighlight = null;
          }
          
          // ëª¨ë“  ?Œì´?„ë¼???œê°???¨ê³¼ ?œê±°
          stopAllEffects();
          
          // ??GPT3/4 ê´€???¤í–‰ ?¨ê³¼ ì¢…ë£Œ (ë°•ìŠ¤ ?¨ê³¼ê°€ ?¨ëŠ” ë¬¸ì œ ?ˆë°©)
          setFlow(null);
          d3.selectAll('.gpt3-anchor-market, .gpt3-anchor-credit, .gpt3-anchor-alm, .gpt3-anchor-global, .gpt3-anchor-creditpf, .gpt4-anchor')
            .classed('agent-running', false);
          document.querySelectorAll('.pipeline-executing').forEach(el => el.classList.remove('pipeline-executing'));
          document.querySelectorAll('.gpt0-module-box, .gpt1-module-box, .gpt2-module-box, .gpt3-module-box')
            .forEach(el => el.classList.remove('running'));
          
          // ?¤ë¥˜ ë°œìƒ ??ëª¨ë“  ì§„í–‰ ?íƒœ ?•ë¦¬
          document.querySelectorAll('.progress-indicator').forEach(el => {
            el.classList.remove('progress-indicator');
          });
          document.querySelectorAll('.execution-overlay').forEach(el => {
            el.remove();
          });
          
          throw error;
        }
      }; // executePipelineSteps ?¨ìˆ˜ ì¢…ë£Œ
    
    console.log('?Œì´?„ë¼???œìŠ¤???„ì²´ ì´ˆê¸°???„ë£Œ');
    
    </script>
    
    <!-- ?Œì´?„ë¼??ë²„íŠ¼ ?˜ì • ?¤í¬ë¦½íŠ¸ -->
    <!-- ?¸ë? pipeline_fix.js ?˜ì¡´ ?œê±°??- ?¸ë¼???¤í¬ë¦½íŠ¸ë¡??µí•© -->
    
    <script>
    // ì§„í–‰ ?íƒœ ?¤ë²„?ˆì´ ?ì„± ?¬í¼ ?¨ìˆ˜ (?„ì—­ ?¨ìˆ˜)
    window.createProgressOverlay = function createProgressOverlay(text) {
            const overlay = document.createElement('div');
            overlay.className = 'execution-overlay';
      overlay.innerHTML = `<div class="execution-text">${text}</div>`;
      return overlay;
    };
    
    // ?”’ ?„ë¡???„ìš© API ?°ê²° ?•ì¸ (ë°°í¬ ?˜ê²½ ?„ìš©) - ?„ì—­ ?¨ìˆ˜
    window.checkAndPromptForApiKey = async function checkAndPromptForApiKey() {
      console.log('?”’ ?ˆì „???„ë¡???¨í„´ ?„ìš© - ?´ë¼?´ì–¸??API ???¬ìš© ?ˆí•¨');
      
      const status = document.getElementById('send-status');
      if (status) {
        status.textContent = '?”„ OpenAI ?„ë¡???°ê²° ?•ì¸ ì¤?..';
        status.style.color = '#3498db';
      }
      
      // ?„ë¡???¨ìˆ˜ ?°ê²° ?ŒìŠ¤??(?€?„ì•„???¤ì •)
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 600000); // 10ë¶??€?„ì•„??
        
        const testResp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: 'test connection' }],
            max_tokens: 5
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (testResp.ok) {
          console.log('??OpenAI ?„ë¡???°ê²° ?ŒìŠ¤???±ê³µ');
          if (status) {
            status.textContent = '??OpenAI ?„ë¡???°ê²° ?±ê³µ';
            status.style.color = '#27ae60';
            setTimeout(() => {
              status.textContent = '';
              status.style.color = '';
            }, 3000);
          }
          return true;
        } else {
          const errData = await testResp.json().catch(() => ({}));
          console.error('??OpenAI ?„ë¡???ŒìŠ¤???¤íŒ¨:', testResp.status, errData);
          
          if (testResp.status === 404) {
            if (status) {
              status.textContent = '???„ë¡???¨ìˆ˜ê°€ ë°°í¬?˜ì? ?ŠìŒ - Netlify ë°°í¬ ?•ì¸ ?„ìš”';
              status.style.color = '#e74c3c';
            }
          } else if (errData.code === 'MISSING_API_KEY') {
            if (status) {
              status.innerHTML = `
                <div style="text-align: left; font-size: 12px; color: #e74c3c;">
                  <strong>??Netlify ?˜ê²½ë³€??OPENAI_API_KEY ?¤ì • ?„ìš”</strong><br>
                  1. Netlify ?€?œë³´????Site settings<br>
                  2. Environment variables ??Add variable<br>
                  3. Key: OPENAI_API_KEY, Value: sk-your-key<br>
                  4. Deploy ??Trigger deploy
                </div>
              `;
            }
          } else {
            if (status) {
              status.textContent = `???„ë¡???¤ë¥˜: ${errData.error || 'Unknown error'}`;
              status.style.color = '#e74c3c';
            }
          }
          return false;
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          console.error('??OpenAI ?„ë¡???°ê²° ?€?„ì•„??);
          if (status) {
            status.textContent = '???„ë¡???°ê²° ?€?„ì•„??- ?¤íŠ¸?Œí¬ ?•ì¸ ?„ìš”';
            status.style.color = '#e74c3c';
          }
        } else {
          console.error('??OpenAI ?„ë¡???°ê²° ?¤ë¥˜:', e.message);
          if (status) {
            status.textContent = '???¤í”Œë¦¬íŒŒ???¨ìˆ˜ ë°°í¬ ?íƒœ ?•ì¸ ?„ìš”';
            status.style.color = '#e74c3c';
          }
        }
        return false;
      }
    };
    
    // ?”’ ë³´ì•ˆ ê°œì„ ???Œì´?„ë¼??ê²€ì¦?(API ???•ì¸ ?ëµ) - ?„ì—­ ?¨ìˆ˜
    window.validatePipelineRequirements = async function validatePipelineRequirements() {
      const issues = [];
      
      // OpenAI ?„ë¡???°ê²° ?•ì¸ (API ???•ì¸ ?€??
      if (!(await window.checkAndPromptForApiKey())) {
        issues.push('OpenAI ?„ë¡???¨ìˆ˜ê°€ ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ??');
      }
      
      // ?„ìˆ˜ DOM ?”ì†Œ ?•ì¸
      const requiredElements = [
        '#send-status',
        '#gpt1-output',
        '#gpt2-output'
      ];
      
      requiredElements.forEach(selector => {
        if (!document.querySelector(selector)) {
          issues.push(`?„ìˆ˜ ?”ì†Œ ${selector}ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤.`);
        }
      });
      
      return issues;
    };
    
    // ?Œì´?„ë¼???¤í–‰ ?±ê³µ ??ê²°ê³¼ ?”ì•½ (?„ì—­ ?¨ìˆ˜)
    window.showPipelineResults = function showPipelineResults() {
      const results = [];
      
      const gpt1Output = document.getElementById('gpt1-output')?.value;
      const gpt2Output = document.getElementById('gpt2-output')?.value;
      const gpt3MarketOutput = document.getElementById('gpt3-market')?.value;
      const gpt4Output = document.getElementById('gpt4-output')?.value;
      
      if (gpt1Output) results.push('??GPT1 ì¢…í•©ë¶„ì„ ?„ë£Œ');
      if (gpt2Output) results.push('??GPT2 WORST ?œë‚˜ë¦¬ì˜¤ ?„ë£Œ');
      if (gpt3MarketOutput) results.push('??GPT3 ë¦¬ìŠ¤?¬ë¶„???„ë£Œ');
      if (gpt4Output) results.push('??GPT4 ë³´ê³ ???”ì•½3) ?„ë£Œ');
      
      const summary = `?‰ ?Œì´?„ë¼???¤í–‰ ?„ë£Œ!

${results.join('\n')}

ì´?${results.length}ê°?ë¶„ì„ ?¨ê³„ê°€ ?±ê³µ?ìœ¼ë¡??„ë£Œ?˜ì—ˆ?µë‹ˆ??
?°ì¸¡ ?¨ë„?ì„œ ê²°ê³¼ë¥??•ì¸?˜ì‹¤ ???ˆìŠµ?ˆë‹¤.`;

      console.log(summary);
      return results.length;
    };
    
    // ë³´ê³ ???ì„± ë°??œì‹œ (?„ì—­ ?¨ìˆ˜)
    window.generateAndShowReport = async function generateAndShowReport({ force = false } = {}) {
        console.log('?“„ ìµœì¢… ë³´ê³ ???ì„± ì¤?..');
        
        // ê¸°ì¡´ ë³´ê³ ???ì„± ?¨ìˆ˜ ?¸ì¶œ (ì¤‘ë³µ ê°€???ìš©)
        if (typeof generateHTMLReportDirect === 'function') {
          await generateHTMLReportDirect({ force });
        } else {
          console.log('ë³´ê³ ???ì„± ?¨ìˆ˜ë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤');
        }
    };
    
    // ?Œì´?„ë¼???„ë£Œ ??ë³´ê³ ?œì‘???ì—­?¼ë¡œ ?ë™ ?¤í¬ë¡?
    function scrollToReportSection() {
      const panel = document.getElementById('gpt1-panel');
      if (!panel) return;

      // ???œë˜ê·?ì¤‘ì´ë©?ê°œì… ê¸ˆì?
      if (window.__userDraggingTab) return;

      // ??ë¬´ì‘???œê±°: ??ƒ ë³´ê³ ???‘ì—… ?ì—­?¼ë¡œ ?¤í¬ë¡?
      const reportActions = document.getElementById('report-actions');
      if (reportActions) {
        const y = Math.max(0, (reportActions.offsetTop || 0) - 40);
        panel.scrollTo({ top: y, behavior: 'smooth' });

        // CTA ê°•ì¡° (ê¸°ì¡´ ? ì?)
        reportActions.classList.add('report-actions-cta');
        const btn = document.getElementById('btn-export-html');
        btn && btn.classList.add('report-cta');
        setTimeout(() => {
          reportActions.classList.remove('report-actions-cta');
          btn && btn.classList.remove('report-cta');
        }, 4000);
      }
      
      console.log('???Œì´?„ë¼???„ë£Œ - ë³´ê³ ???‘ì—… ?ì—­?¼ë¡œ ?¤í¬ë¡?);
    }
    
    // API ???íƒœ ?•ì¸ ?”ë²„ê·??¨ìˆ˜ (ê°œë°œ???„êµ¬?ì„œ ?¬ìš© ê°€??
    window.debugApiKeyStatus = async function() {
      console.log('?” === ë³´ì•ˆ ê°•í™”??OpenAI ?„ë¡???íƒœ ?”ë²„ê¹?===');
      console.log('?”’ ?´ë¼?´ì–¸??API ???¬ìš© ê¸ˆì? - ?„ë¡???„ìš© ëª¨ë“œ');
      console.log('?“ API ???•ë³´??ë³´ì•ˆ???œì‹œ?˜ì? ?ŠìŠµ?ˆë‹¤.');
      
      console.log('\n?š« ?ˆê±°??API ???•ì¸ ?¨ìˆ˜??ë³´ì•ˆ???œê±°?˜ì—ˆ?µë‹ˆ??');
      console.log('?’¡ ?˜ê²½ë³€???íƒœ??Netlify ?€?œë³´?œì—???•ì¸?˜ì„¸??');
      
      console.log('\n?”’ OpenAI ?„ë¡???¨ìˆ˜ ?ŒìŠ¤??');
      try {
        console.log('  ?”„ /.netlify/functions/openai-proxy ?ŒìŠ¤??ì¤?..');
        const proxyResp = await fetch('/.netlify/functions/openai-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: 'test' }],
            max_tokens: 5
          })
        });
        
        console.log(`  ?“¡ ?„ë¡???‘ë‹µ: ${proxyResp.status} ${proxyResp.statusText}`);
        
        if (proxyResp.ok) {
          console.log('  ???„ë¡???¨ìˆ˜: ?•ìƒ ?‘ë™ ì¤?);
        } else if (proxyResp.status === 404) {
          console.log('  ???„ë¡???¨ìˆ˜: ë°°í¬?˜ì? ?ŠìŒ (404)');
          console.log('  ?’¡ ?´ê²°ë°©ë²•: ?„ë¡œ?íŠ¸ë¥?Netlify???¬ë°°???„ìš”');
        } else {
          const errorData = await proxyResp.json().catch(() => ({}));
          if (errorData.code === 'MISSING_API_KEY') {
            console.log('  ???„ë¡???¨ìˆ˜: ?˜ê²½ë³€??OPENAI_API_KEY ë¯¸ì„¤??);
            console.log('  ?’¡ ?´ê²°ë°©ë²•: Netlify ?€?œë³´?œì—???˜ê²½ë³€???¤ì • ???¬ë°°??);
          } else {
            console.log(`  ? ï¸ ?„ë¡???¨ìˆ˜: ?¤ë¥˜ ë°œìƒ (${errorData.error || 'Unknown'})`);
          }
        }
      } catch (e) {
        console.log(`  ???„ë¡???¨ìˆ˜: ?°ê²° ?¤íŒ¨ (${e.message})`);
        console.log('  ?’¡ ?¤íŠ¸?Œí¬ ë¬¸ì œ?´ê±°??ë¡œì»¬ ?˜ê²½?ì„œ??netlify dev ?„ìš”');
      }
      
      console.log('\n?¯ Netlify ?˜ê²½ë³€???¤ì • ê°€?´ë“œ:');
      console.log('1. Netlify ?€?œë³´????Site settings ??Environment variables');
      console.log('2. ??ë³€??ì¶”ê?: OPENAI_API_KEY = sk-your-openai-api-key');
      console.log('3. ?¬ì´???¬ë°°??(Deploy ??—??Trigger deploy)');
      
      console.log('\n?›  ?”ë²„ê·?ëª…ë ¹??');
      console.log('- debugApiKeyStatus(): ???¨ìˆ˜ ?¤í–‰');
      console.log('- testOpenAIProxy(): ?„ë¡???¨ìˆ˜ ì§ì ‘ ?ŒìŠ¤??);
      console.log('- checkDomainRouting(): ?„ë©”???¼ìš°???•ì¸');
    };
    
    // ?“¡ OpenAI ?„ë¡??ì§ì ‘ ?ŒìŠ¤???¨ìˆ˜
    window.testOpenAIProxy = async function() {
      console.log('?” === OpenAI ?„ë¡??ì§ì ‘ ?ŒìŠ¤??===');
      
      const testUrls = [
        `${location.origin}/.netlify/functions/openai-proxy`,
        'https://chartupndown.com/.netlify/functions/openai-proxy'
      ];
      
      for (const url of testUrls) {
        console.log(`\n?“¡ ?ŒìŠ¤??URL: ${url}`);
        
        try {
          // GET ?”ì²­?¼ë¡œ ?¨ìˆ˜ ?íƒœ ?•ì¸
          const getResp = await fetch(url, { method: 'GET' });
          console.log(`  GET ${getResp.status}: ${getResp.statusText}`);
          
          if (getResp.ok) {
            const data = await getResp.json();
            console.log('  ?“¦ ?‘ë‹µ ?°ì´??', data);
          } else {
            const errorText = await getResp.text().catch(() => 'Unknown error');
            console.log(`  ???¤ë¥˜: ${errorText}`);
          }
        } catch (e) {
          console.log(`  ???¤íŠ¸?Œí¬ ?¤ë¥˜: ${e.message}`);
        }
      }
    };
    
    // ?Œ ?„ë©”???¼ìš°???•ì¸ ?¨ìˆ˜
    window.checkDomainRouting = async function() {
      console.log('?” === ?„ë©”???¼ìš°???íƒœ ?•ì¸ ===');
      console.log(`?„ì¬ ?„ë©”?? ${location.hostname}`);
      console.log(`?„ì²´ URL: ${location.href}`);
      
      // ?‘ë‹µ ?¤ë”?ì„œ Netlify ?•ì¸
      try {
        const resp = await fetch(location.origin);
        const headers = {};
        for (const [key, value] of resp.headers.entries()) {
          if (key.toLowerCase().includes('netlify') || key.toLowerCase().includes('nf')) {
            headers[key] = value;
          }
        }
        
        if (Object.keys(headers).length > 0) {
          console.log('??Netlify ?¤ë” ê°ì?:');
        } else {
          console.log('? ï¸ Netlify ?¤ë” ?†ìŒ - DNS ?¤ì • ?•ì¸ ?„ìš”');
        }
      } catch (e) {
        console.log(`???„ë©”???•ì¸ ?¤íŒ¨: ${e.message}`);
      }
    };
    
    console.log('?’¡ ?”ë²„ê·??„êµ¬: ê°œë°œ???„êµ¬?ì„œ ?¤ìŒ ?¨ìˆ˜???¤í–‰ ê°€??);
    console.log('- debugApiKeyStatus(): ?„ë¡???íƒœ ?•ì¸');
    console.log('- testOpenAIProxy(): ?„ë¡???¨ìˆ˜ ì§ì ‘ ?ŒìŠ¤??);
    console.log('- checkDomainRouting(): ?„ë©”???¼ìš°???•ì¸');
    
    // ?œë‚˜ë¦¬ì˜¤ PDF ?ˆì°½ ?´ê¸° ?¨ìˆ˜ (ê¸°ì¡´ ?¨ìˆ˜ ??–´?°ê¸°)
    window.openScenarioPDF = function(n, scenarioId) {
      // 01~09ê¹Œì??????ë¦¬ ?¨ë”©, 10 ?´ìƒ?€ ê·¸ë?ë¡?
      const folderName = String(n).padStart(2, '0');
      const pdfPath = `go_scen/scen/${folderName}/scenario_${folderName}.pdf`;
      const pdfTitle = `?œë‚˜ë¦¬ì˜¤ ${n}: ${scenarioId || '?ì„¸ ë³´ê³ ??}`;
      
      console.log(`?“– ?œë‚˜ë¦¬ì˜¤ PDF ?ˆì°½ ?´ê¸°: ${pdfTitle}`);
      console.log(`?“‚ PDF ê²½ë¡œ: ${pdfPath}`);
      
      // ??ì°½ì—??PDF ì§ì ‘ ?´ê¸°
      try {
        const newWindow = window.open(pdfPath, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        if (newWindow) {
          newWindow.focus();
          console.log('??PDF ?ˆì°½ ?´ê¸° ?±ê³µ');
        } else {
          // ?ì—…??ì°¨ë‹¨??ê²½ìš° ?€ì²?ë°©ë²•
          console.warn('?ì—…??ì°¨ë‹¨?? ì§ì ‘ ë§í¬ ?´ê¸° ?œë„');
          const link = document.createElement('a');
          link.href = pdfPath;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      } catch (error) {
        console.error('PDF ?´ê¸° ?¤íŒ¨:', error);
        alert(`?œë‚˜ë¦¬ì˜¤ PDFë¥??????†ìŠµ?ˆë‹¤: ${error.message}`);
      }
    };
    // ?°ì¸¡ ?¨ë„?ì„œ ?¼í„°ë§?ì¤??œì–´
    function onCenterScenario() {
      const n = document.getElementById('center-input').value;
      if (!n) return;
      highlightScenario(n);
      centerOnScenario(n, 1.3);
    }
    function onZoomIn() { zoomDelta(1); }
    function onZoomOut() { zoomDelta(-1); }

    // ====== risk_eng ?´ìš© ë¡œë”© ======
    async function loadRiskEngContent() {
      try {
        // ?¸íŠ¸ë¶??ë³¸???ìŠ¤?¸ë¡œ ë¡œë“œ ?? ?ë‹¨ ë©”í?/ë§ˆí¬?¤ìš´ ?¼ë?ë§??”ì•½ ?œì‹œ
        const resp = await fetch('risk_eng.ipynb');
        if (!resp.ok) throw new Error('risk_eng.ipynb ë¡œë“œ ?¤íŒ¨');
        const nb = await resp.json();
        const cells = Array.isArray(nb?.cells) ? nb.cells : nb?.worksheets?.[0]?.cells || [];
        let preview = '';
        for (const cell of cells) {
          if (cell.cell_type === 'markdown' && Array.isArray(cell.source)) {
            preview += cell.source.join('');
          } else if (cell.cell_type === 'markdown' && typeof cell.source === 'string') {
            preview += cell.source;
          }
          if (preview.length > 1200) break;
        }
        if (!preview) preview = '?¸íŠ¸ë¶ì— ?œì‹œ??ë§ˆí¬?¤ìš´ ?€??ì°¾ì? ëª»í–ˆ?µë‹ˆ?? ì½”ë“œ/ê²°ê³¼???¸íŠ¸ë¶ì—???•ì¸?˜ì„¸??';
        document.getElementById('risk-eng-content').textContent = preview;
      } catch (e) {
        document.getElementById('risk-eng-content').textContent = 'risk_eng.ipynbë¥?ë¶ˆëŸ¬?¤ì? ëª»í–ˆ?µë‹ˆ??';
        console.error(e);
      }
    }

    // ====== GPT3 ê°€?´ë“œ TXT ?…ë¡œ??ì²˜ë¦¬ (?„ë©”?¸ë³„) ======
    (function setupGpt3Guideline(){
      const setup = (id, nameId, key) => {
        const input = document.getElementById(id);
        const nameEl = document.getElementById(nameId);
        if (!input) return;
        input.addEventListener('change', async (e)=>{
          const file = e.target.files?.[0];
          if (!file) return;
          nameEl.textContent = file.name;
          try {
            const text = await file.text();
            window.gpt3Guidelines = window.gpt3Guidelines || {};
            window.gpt3Guidelines[key] = text.slice(0, 200000);
          } catch(_) { /* ignore */ }
        });
      };
      setup('gpt3-market-guideline', 'gpt3-market-guideline-name', 'market');
      setup('gpt3-credit-guideline', 'gpt3-credit-guideline-name', 'credit');
      setup('gpt3-alm-guideline', 'gpt3-alm-guideline-name', 'alm');
      setup('gpt3-global-guideline', 'gpt3-global-guideline-name', 'global');
      setup('gpt3-creditpf-guideline', 'gpt3-creditpf-guideline-name', 'creditpf');
    })();

    // ?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë”© ?€ê¸??¨ìˆ˜
    function waitForLibraries() {
      return new Promise((resolve) => {
        const checkLibraries = () => {
          if (typeof Chart !== 'undefined' && typeof d3 !== 'undefined' && typeof XLSX !== 'undefined') {
            console.log('ëª¨ë“  ?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë”© ?„ë£Œ');
            resolve();
          } else {
            console.log('?¼ì´ë¸ŒëŸ¬ë¦?ë¡œë”© ?€ê¸?ì¤?..');
            setTimeout(checkLibraries, 100);
          }
        };
        checkLibraries();
      });
    }
    
    // ???œì‘
    async function startApp() {
      try {
        initializeTheme();
        await waitForLibraries();
        await initializeApp();
        // ê¸°ë³¸ ??•  ?„ë¡¬?„íŠ¸ë¥?UI??ì±„ì? (?¬ìš©???˜ì • ê°€??
        try { await loadRiskAgentRoles(); } catch(_) {}
        renderScenarioList();
        // ì´ˆê¸° UI ?íƒœ ?¤ì •
        updateGpt2ButtonState();
        // ì´ˆê¸° ?Œë” ?ˆì •?? ?ˆì´?„ì›ƒ/?°íŠ¸ ë¡œë”© ????ë²???ê°•ì œ ?Œë”
        warmFirstRender();
      } catch (e) {
        console.error('ì´ˆê¸°???¤ë¥˜:', e);
        // ?¤íŒ¨?˜ë”?¼ë„ ê¸°ë³¸ UI??ë³´ì´?„ë¡ ?œë„
        try { initializeApp(); } catch(_) {}
        // ?¤íŒ¨ ì¼€?´ìŠ¤?ì„œ??ì´ˆê¸° ?Œë” ë³´ì • ?œë„
        try { warmFirstRender(); } catch(_) {}
      }
    }
    
    // ?ˆë„??ë¦¬ì‚¬?´ì¦ˆ ?´ë²¤??
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        console.log('?–¥ï¸??ˆë„??ë¦¬ì‚¬?´ì¦ˆ ê°ì? - ?¤íŠ¸?Œí¬ ?¤ì‹œ ?Œë”ë§?);
        renderNetwork();
      }, 300); // 300ms ?”ë°”?´ìŠ¤
    });
    
    // ?˜ì´ì§€ ë¡œë“œ ?„ë£Œ ???œì‘
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }
    // onload/page-show ?œì ?ë„ ??ë²????Œë” ë³´ì • (BFCache ë³µê? ?¬í•¨)
    window.addEventListener('load', () => { try { warmFirstRender(); } catch(_) {} });
    window.addEventListener('pageshow', () => { try { warmFirstRender(); } catch(_) {} });

    // ??ì´ˆê¸° ?íƒœ: ëª¨ë“  GPT ì¹´ë“œ ì´ˆê¸°??(ì´ˆë¡???œê±°)
    function initializeGptCardsState() {
      console.log('?”„ GPT ì¹´ë“œ ì´ˆê¸° ?íƒœ ?¤ì • ?œì‘');
      
      // ëª¨ë“  GPT ì¹´ë“œ?ì„œ running, done, active ?´ë˜???œê±°
      const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      allCards.forEach(idSuffix => {
        const card = getAgentCard(idSuffix);
        if (card) {
          card.classList.remove('running', 'done', 'active', 'expanded');
          console.log(`- ${idSuffix} ì¹´ë“œ ì´ˆê¸°???„ë£Œ`);
        }
      });
      
      console.log('??GPT ì¹´ë“œ ì´ˆê¸° ?íƒœ ?¤ì • ?„ë£Œ');
    }
    
    // ?˜ì´ì§€ ë¡œë“œ ??ì´ˆê¸°???¤í–‰
    window.addEventListener('DOMContentLoaded', initializeGptCardsState);
    window.addEventListener('load', initializeGptCardsState);

    // ?“± Wake Lock (?”ë©´ êº¼ì§ ë°©ì?) ê¸°ëŠ¥
    let wakeLock = null;
    
    // Wake Lock ?œì„±???¨ìˆ˜
    async function requestWakeLock() {
      try {
        // Wake Lock API ì§€??ì²´í¬
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('?”’ Wake Lock ?œì„±?? ?”ë©´ êº¼ì§ ë°©ì?');
          
          // Wake Lock ?´ì œ ?´ë²¤??ë¦¬ìŠ¤??
          wakeLock.addEventListener('release', () => {
            console.log('?”“ Wake Lock ?´ì œ??);
          });
          
          return true;
        } else {
          console.warn('? ï¸ Wake Lock APIë¥?ì§€?í•˜ì§€ ?ŠëŠ” ë¸Œë¼?°ì??…ë‹ˆ??');
          return false;
        }
      } catch (err) {
        console.error('??Wake Lock ?œì„±???¤íŒ¨:', err.message);
        return false;
      }
    }
    
    // Wake Lock ?´ì œ ?¨ìˆ˜
    async function releaseWakeLock() {
      if (wakeLock !== null) {
        try {
          await wakeLock.release();
          wakeLock = null;
          console.log('??Wake Lock ?•ìƒ ?´ì œ');
        } catch (err) {
          console.error('??Wake Lock ?´ì œ ?¤íŒ¨:', err.message);
        }
      }
    }
    
    // ?˜ì´ì§€ visibility ë³€ê²???Wake Lock ?¬í™œ?±í™”
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && wakeLock !== null) {
        console.log('?“± ?˜ì´ì§€ ?¤ì‹œ ?œì„±??- Wake Lock ?¬ìš”ì²?);
        await requestWakeLock();
      }
    });
    
    // ?˜ì´ì§€ ì¢…ë£Œ ??Wake Lock ?•ë¦¬
    window.addEventListener('beforeunload', () => {
      if (wakeLock !== null) {
        releaseWakeLock();
      }
    });

    // ??ëª¨ë°”???˜ê²½ ê°ì? ?¨ìˆ˜
    function isMobileEnvironment() {
      return window.innerWidth <= 900; // ëª¨ë°”???¸ë¡œ/ê°€ë¡?ëª¨ë‘ ?¬í•¨
    }

    // ??ëª¨ë°”?¼ì—??GPT ì¹´ë“œ ?œì‹œ ?œì–´ ?¨ìˆ˜
    function showOnlyGpt0CardMobile() {
      if (!isMobileEnvironment()) return false; // ëª¨ë°”?¼ì´ ?„ë‹ˆë©?ê¸°ì¡´ ?™ì‘
      
      console.log('?“± ëª¨ë°”???˜ê²½ - GPT0 ì¹´ë“œë§??œì‹œ');
      
      const panel = $rightPanel();
      if (panel) {
        panel.classList.add('mobile-initial-mode');
        panel.classList.remove('show-all', 'solo-mode');
      }
      
      // GPT0ë§??œì‹œ, ?˜ë¨¸ì§€???¨ê?
      const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      allCards.forEach(idSuffix => {
        const card = getAgentCard(idSuffix);
        if (card) {
          if (idSuffix === 'gpt0') {
            card.style.display = 'block';
            card.style.visibility = 'visible';
            card.style.opacity = '1';
          } else {
            card.style.display = 'none';
            card.style.visibility = 'hidden';
            card.style.opacity = '0';
          }
        }
      });
      
      // GPT0 ì¹´ë“œë¡??¤í¬ë¡?
      setTimeout(() => {
        const gpt0Card = getAgentCard('gpt0');
        if (gpt0Card && panel) {
          panel.scrollTo({ top: gpt0Card.offsetTop - 12, behavior: 'smooth' });
        }
      }, 100);
      
      return true; // ëª¨ë°”??ëª¨ë“œ ?œì„±?”ë¨
    }

    // ??ë¶„ì„ ?¤í–‰ ??ëª¨ë“  ì¹´ë“œ ?œì‹œ (ëª¨ë°”??
    function showAllCardsOnPipelineStart() {
      if (!isMobileEnvironment()) return;
      
      console.log('?“± ëª¨ë°”??- ë¶„ì„ ?œì‘?¼ë¡œ ëª¨ë“  ì¹´ë“œ ?œì‹œ');
      
      const panel = $rightPanel();
      if (panel) {
        panel.classList.remove('mobile-initial-mode');
        panel.classList.add('show-all');
      }
      
      // ëª¨ë“  ì¹´ë“œ ?œì‹œ
      const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      allCards.forEach(idSuffix => {
        const card = getAgentCard(idSuffix);
        if (card) {
          card.style.display = 'block';
          card.style.visibility = 'visible';
          card.style.opacity = '1';
        }
      });
    }

    // ====== ?¼ìª½ ?œë‚˜ë¦¬ì˜¤ ëª©ë¡ ======
    function renderScenarioList() {
      const el = document.getElementById('left-scenarios');
      if (!el) return;
      const scenList = Object.entries(scenarioData)
        .map(([n, d]) => `- ${n}. ${d?.overview?.Scenario_Name || '?œë‚˜ë¦¬ì˜¤ ' + n}`)
        .join('\n');
      el.textContent = `ì´?${Object.keys(scenarioData).length}ê°?\n${scenList}\n\n?? ?°ì¸¡ ?¨ë„???œë‚˜ë¦¬ì˜¤ë²ˆí˜¸ ?…ë ¥ ???¼í„°ë§?ì¤Œì„ ?¬ìš©?˜ì„¸??`;
    }

    // ì´ˆê¸° ?Œë” ë³´ì •: ?°íŠ¸/?ˆì´?„ì›ƒ ì¤€ë¹???ê°•ì œ ?Œë” + ?„ìš” ??ëª?ì°¨ë? ?¬ì‹œ??
    async function warmFirstRender() {
      try {
        // ?°íŠ¸ ì¤€ë¹??€ê¸?(ì§€??ë¸Œë¼?°ì? ?œì •)
        if (document.fonts && document.fonts.ready) {
          await Promise.race([
            document.fonts.ready,
            new Promise(resolve => setTimeout(resolve, 300))
          ]);
        }
      } catch(_) {}

      // ?ˆì´?„ì›ƒ???ˆì •???¤ìŒ ?„ë ˆ?„ì— ?Œë”
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      try { renderNetwork(); } catch(_) {}

      // ì»¨í…Œ?´ë„ˆ ?¬ì´ì¦ˆê? ?‘ì? ê²½ìš°(ì´ˆê¸° 0 ???’ì´ ?´ìŠˆ) ëª?ì°¨ë? ?¬ì‹œ??
      const container = document.getElementById('network-graph');
      if (!container) return;
      let tries = 0;
      const retry = () => {
        tries++;
        const rect = container.getBoundingClientRect();
        if (rect.width < 300 || rect.height < 300) {
          try { renderNetwork(); } catch(_) {}
          try { window.dispatchEvent(new Event('resize')); } catch(_) {}
          if (tries < 5) setTimeout(retry, 150);
        }
      };
      retry();
    }
    // =====================
    // PPT ì¶œë ¥: GPT ?¬ë§·????PPTX ?ì„±
    // =====================
    // ?”Œ ?¤ì •ê°?(?„ìš” ???˜ì •)
    const OPENAI_API_URL = "https://api.openai.com/v1/responses"; // Responses API ?”ë“œ?¬ì¸??
    const OPENAI_MODEL   = "gpt-4o-mini"; // ?¬ìš© ëª¨ë¸(?ˆì‹œ). ?„ìš” ??ë³€ê²?
    // ???¤ì œ ?¤ëŠ” ?œë²„?ì„œ ë³´ê??˜ê³ , ?¬ê¸´ ? í° ?†ì´ ?„ë¡?œë¡œ ?¸ì¶œ?˜ëŠ” ê±?ê¶Œì¥?©ë‹ˆ??
    let OPENAI_API_KEY   = ""; // ?°ëª¨/?´ë? ?ŒìŠ¤?¸ìš© ?„ì‹œ ?…ë ¥?€. ?´ì˜?ì„  ë¹„ìš°?¸ìš”.
    
    // ë¡œì»¬ ?ŒìŠ¤?? localStorage?ì„œ ???½ì–´?¤ê¸° (?˜ë“œì½”ë”©???¤ëŠ” ë³´ì•ˆ???œê±°??
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:') {
      // localStorage?ì„œ ?½ì–´?¤ê¸°
      const localKey = localStorage.getItem('openai_api_key');
      if (localKey) {
        OPENAI_API_KEY = localKey;
      }
    }

    // ?§± ?„ë¡¬?„íŠ¸ ë¹Œë”
    function buildSectionPrompt({ templateKey, sectionName, sourceText }) {
      const systemPrompt = `[??• ] ?¹ì‹ ?€ ê¸ˆìœµ ë¦¬ìŠ¤??ê´€ë¦??„ë¬¸ê°€?´ì ë³´ê³ ???‘ì„± ?„ë¬¸ê°€?…ë‹ˆ?? ì²´ê³„?ì´ê³??„ë¬¸?ì¸ ë³´ê³ ???•ì‹?¼ë¡œ PPT ì½˜í…ì¸ ë? ?‘ì„±?©ë‹ˆ??
[ì¶œë ¥?•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œ??HTMLë§?ì¶œë ¥?©ë‹ˆ?? ?ˆìš© ?œê·¸: <h1>, <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ?¸ì‚¿ë§?ë¶ˆí•„??ë¬¸êµ¬/AI ?¸ìš© ì½”ë“œ(contentReference, oaicite, index ?? ?ˆë? ê¸ˆì?
- ë¶ˆë¦¿?€ <ul><li>??/li></ul>, ë²ˆí˜¸ëª©ë¡?€ <ol><li>??/li></ol>ë¡??‘ì„±
- ?? ?´ë?ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì?
- ì²´ê³„?ì´ê³??¼ë¦¬?ì¸ êµ¬ì¡°ë¡??‘ì„±?˜ë˜, ê°??¹ì…˜?€ ?ì„¸?˜ê³  êµ¬ì²´?ì¸ ?´ìš© ?¬í•¨
- ?„ë¬¸?ì¸ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?˜ë©°, ?•ëŸ‰??ë¶„ì„ê³??•ì„±???¸ì‚¬?´íŠ¸ë¥?ëª¨ë‘ ?¬í•¨`;

      const userPrompt = `[ë¬¸ì„œ ?œí”Œë¦? ${templateKey}
[?¹ì…˜] ${sectionName}
[?ë¬¸] ?„ë˜ ?ë¬¸???½ê³ , ?´ë‹¹ ?¹ì…˜??ë§ì¶° ì²´ê³„?ì´ê³??„ë¬¸?ì¸ ë³´ê³ ???•ì‹?¼ë¡œ HTML???‘ì„±?˜ì„¸??

${sourceText}

[?‘ì„± ì§€ì¹?
- ${sectionName}??ë§ëŠ” ëª…í™•???Œì œëª?<h3>)??2~3ê°??¬í•¨?˜ì—¬ ì²´ê³„?ìœ¼ë¡?êµ¬ì„±
- ê°??Œì œëª??˜ì— ?ì„¸??ë¶„ì„ ?´ìš©???¬í•¨
- ì¤‘ìš”???©ì–´ ë°??µì‹¬ ?˜ì¹˜??<strong>?¼ë¡œ ê°•ì¡°
- ì£¼ìš” ?¬ì¸?¸ëŠ” <ul><li>??/li></ul> ?ëŠ” <ol><li>??/li></ol> ?¬ìš©
- ?ì„¸???¤ëª…?€ <p>??/p>ë¡??‘ì„±?˜ë˜, êµ¬ì²´?ì´ê³??¤ìš©?ì¸ ?´ìš© ?¬í•¨
- ?•ëŸ‰???°ì´?°ì? ?•ì„±??ë¶„ì„??ê· í˜•?ˆê²Œ ?œì‹œ
- ë¬¸ì²´???„ë¬¸?ì´ê³??•ì¤‘??"~?µë‹ˆ?? ?•ì‹?¼ë¡œ ?µì¼
- ?ˆìš© ?œê·¸ ???¬ìš© ê¸ˆì?, ë¶ˆí•„??ë¬¸êµ¬ ê¸ˆì?`;

      return { systemPrompt, userPrompt };
    }

    // ?œì????¤ì–´ê°?"?œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ?”ì•½)" ?ì ?‘ì„±???„ë¡¬?„íŠ¸
    function buildCoverScenarioPrompt({ scenarioName, sourceText }) {
      const systemPrompt = `[??• ] ?¹ì‹ ?€ ê¸ˆìœµ ë¦¬ìŠ¤??ê´€ë¦??„ë¬¸ê°€ë¡œì„œ 'ë³´ê³ ?? ?œì? ?˜ë‹¨???¤ì–´ê°?\"?œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ?”ì•½)\" ?ì ?´ìš©??ì²´ê³„?ì¸ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±?©ë‹ˆ??
[ì¶œë ¥?•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œ??HTMLë§?ì¶œë ¥?©ë‹ˆ?? ?ˆìš© ?œê·¸: <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ?¸ì‚¿ë§?ë¶ˆí•„??ë¬¸êµ¬/AI ?¸ìš© ì½”ë“œ(contentReference, oaicite, index ?? ?ˆë? ê¸ˆì?
- ?„ë¬¸?ì´ê³?ì²´ê³„?ì¸ ë³´ê³ ???•ì‹?¼ë¡œ ?‘ì„±
- ?¬í•¨: ?œë‚˜ë¦¬ì˜¤ ê°œìš”, ?µì‹¬ ë¶„ì„ ?¬ì¸?? ë¦¬ìŠ¤???”ì¸ ë°?ëª¨ë‹ˆ?°ë§ ì§€??
- ë¬¸ì²´???„ë¬¸?ì´ê³??•ì¤‘??"~?µë‹ˆ?? ?•ì‹?¼ë¡œ ?µì¼
- ?? ?´ë?ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì?`;

      const userPrompt = `[?œë‚˜ë¦¬ì˜¤ëª? ${scenarioName || ''}
[?ë¬¸] ?„ë˜ ?ìŠ¤?¸ëŠ” ?œë‚˜ë¦¬ì˜¤ PDF?ì„œ ì¶”ì¶œ???´ìš©?…ë‹ˆ?? ?œì? ?˜ë‹¨ ?ì???¤ì–´ê°?ì²´ê³„?ì´ê³??„ë¬¸?ì¸ ë³´ê³ ???•ì‹?¼ë¡œ ?•ë¦¬?˜ì„¸??

${sourceText}

[?‘ì„± ì§€ì¹?
- ë§??„ì— <h3>?œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ?”ì•½)</h3> ?œëª© ?¬í•¨
- ?œë‚˜ë¦¬ì˜¤ ê°œìš”ë¥?<p>??/p>ë¡?ëª…í™•???¤ëª…
- ?µì‹¬ ë¶„ì„ ?¬ì¸?¸ëŠ” <ul><li>??/li></ul>ë¡?êµ¬ì²´?ìœ¼ë¡?4~6ê°??‘ì„±
- ë¦¬ìŠ¤???”ì¸ ë°?ëª¨ë‹ˆ?°ë§ ì§€?œë„ <ul><li>??/li></ul>ë¡?3~5ê°?ì¶”ê?
- ë¬¸ì²´???„ë¬¸?ì´ê³??•ì¤‘??"~?µë‹ˆ?? ?•ì‹?¼ë¡œ ?µì¼
- ?ˆìš© ?œê·¸ ???¬ìš© ê¸ˆì?, ë¶ˆí•„??ë¬¸êµ¬ ê¸ˆì?`;

      return { systemPrompt, userPrompt };
    }

    // GPT0 ë§ˆì¼“?°ì´???œí™© + ?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´???°ê³„ ë¶„ì„ ?¬ë¼?´ë“œ???„ë¡¬?„íŠ¸
    function buildGpt0MarketSlidePrompt({ scenarioName, scenMarketText, marketStateText }) {
      const systemPrompt = `[??• ] ë³´ê³ ?œì˜ '?„ì¬ ë§ˆì¼“/?œí™© Â· ?œë‚˜ë¦¬ì˜¤ ?°ê³„' ?¬ë¼?´ë“œ ì½˜í…ì¸ ë? ?‘ì„±?©ë‹ˆ??
[ì¶œë ¥?•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œ??HTMLë§?ì¶œë ¥?©ë‹ˆ?? ?ˆìš© ?œê·¸: <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ?¸ì‚¿ë§?ë¶ˆí•„??ë¬¸êµ¬/AI ?¸ìš© ì½”ë“œ(contentReference, oaicite, index ?? ?ˆë? ê¸ˆì?
- ê¸¸ì´??6~12ê°œì˜ ë¬¸ì¥/ë¶ˆë¦¿ ?ˆì—??ê°„ê²°?˜ê²Œ
- ?¬í•¨: (1) ?„ì¬ ë§ˆì¼“/?œí™© ?µì‹¬ 3~5ê°? (2) ?œë‚˜ë¦¬ì˜¤ ?°ê²° ë§ˆì¼“?°ì´???µì‹¬ 3~5ê°? (3) ?œì‚¬??ë¦¬ìŠ¤???¸ë¦¬ê±?2~4ê°?
- ?? ?´ë?ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì?`;

      const userPrompt = `[?œë‚˜ë¦¬ì˜¤ëª? ${scenarioName || ''}
[GPT0-?„ì¬ ?œí™© ë¶„ì„]
${marketStateText || ''}

[GPT0-?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´??ë¶„ì„]
${scenMarketText || ''}

[?‘ì„± ì§€ì¹?
- ë§??„ì— <h3>?„ì¬ ë§ˆì¼“/?œí™© ë°??œë‚˜ë¦¬ì˜¤ ?°ê³„ ë¶„ì„</h3> ?œëª© ?¬í•¨
- ê°?ë¸”ë¡?€ ?Œì œëª?<h3>)ê³?ë¶ˆë¦¿(<ul><li>) ?•íƒœë¡?ê°„ê²° ?”ì•½
- ?ˆìš© ?œê·¸ ???¬ìš© ê¸ˆì?, ë¶ˆí•„??ë¬¸êµ¬ ê¸ˆì?`;

      return { systemPrompt, userPrompt };
    }

    // GPT3 ?„ë©”???œì¥/? ìš©/ALM/ê¸€ë¡œë²Œ/? ìš©PF) ë¶„ì„ ?”ì•½ ?¬ë¼?´ë“œ???„ë¡¬?„íŠ¸
    function buildGpt3DomainsSlidePrompt({ outMarket, outCredit, outAlm, outGlobal, outCreditPf }) {
      const systemPrompt = `[??• ] ë³´ê³ ?œì˜ 'GPT3 ?„ë©”??ë¶„ì„ ?”ì•½' ?¬ë¼?´ë“œ ì½˜í…ì¸ ë? ?‘ì„±?©ë‹ˆ??
[ì¶œë ¥?•ì‹ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
- ë°˜ë“œ??HTMLë§?ì¶œë ¥?©ë‹ˆ?? ?ˆìš© ?œê·¸: <h2>, <h3>, <p>, <strong>, <em>, <ul>, <ol>, <li>
- ?¸ì‚¿ë§?ë¶ˆí•„??ë¬¸êµ¬/AI ?¸ìš© ì½”ë“œ(contentReference, oaicite, index ?? ?ˆë? ê¸ˆì?
- ê°??„ë©”???œì¥/? ìš©/ALM/ê¸€ë¡œë²Œ/? ìš©PF)ë³„ë¡œ ?Œì œëª?<h3>)??ë§Œë“¤ê³? ?µì‹¬ ?¬ì¸??3~6ê°œë? <ul><li>??/li></ul>ë¡?ê°„ê²°???”ì•½
- ?? ?´ë?ì§€, ë§í¬, ì½”ë“œë¸”ë¡ ê¸ˆì?`;

      const userPrompt = `?„ë˜??GPT3 ê°??„ë©”???ì´?„íŠ¸??ë¶„ì„ ê²°ê³¼?…ë‹ˆ?? ê°??„ë©”?¸ë³„ë¡??Œì£¼?œì? ?µì‹¬ ?¬ì¸?¸ë? ?”ì•½?˜ì—¬ ???¥ì§œë¦??¬ë¼?´ë“œë¥?ë§Œë“œ?¸ìš”.

[?œì¥ë¦¬ìŠ¤??
${outMarket || ''}

[? ìš©ë¦¬ìŠ¤??
${outCredit || ''}

[ALM]
${outAlm || ''}

[ê¸€ë¡œë²Œë¦¬ìŠ¤??
${outGlobal || ''}

[? ìš©?¬íŠ¸?´ë¦¬??
${outCreditPf || ''}

[?‘ì„± ì§€ì¹?
- ì½˜í…ì¸ ê? ?†ëŠ” ?„ë©”?¸ì? ?ëµ
- ê°??„ë©”?¸ì˜ ?µì‹¬ ?¬ì¸?¸ëŠ” 3~6ê°??˜ì??¼ë¡œ ê°„ê²°???•ë¦¬`;

      return { systemPrompt, userPrompt };
    }

    // ?”’ ?¤ë” ?¬í¼ (?¸í™˜???”ë?) ???„ë¡??ëª¨ë“œ?ì„œ???¬ìš©?˜ì? ?ŠìŒ
    async function getOpenAIAuthHeaders() {
      // ?„ë¡???„ìš© ëª¨ë“œ: ?´ë¼?´ì–¸???¤ë”???„ìš” ?†ìŒ. (?¸í™˜??? ì??©ìœ¼ë¡?ë¹??¤ë” ë°˜í™˜)
      // ë¡œì»¬ ê°œë°œ ?¸ì˜: localhost/file://?ì„œ localStorage ?¤ê? ?ˆìœ¼ë©??ŒìŠ¤???ˆìš©
      try {
        const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.protocol === 'file:';
        if (isLocal) {
          const k = localStorage.getItem('openai_api_key');
          if (k) {
            console.warn('? ï¸ ë¡œì»¬ ê°œë°œ ëª¨ë“œ: ?„ì‹œ Authorization ?¤ë” ?¬ìš©');
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${k}` };
          }
        }
      } catch(_) { /* ignore */ }
      console.log('?”’ ?„ë¡???„ìš© ëª¨ë“œ: ?´ë¼?´ì–¸??Authorization ?¤ë” ë¯¸ì‚¬??);
      return { 'Content-Type': 'application/json' };
    }

    // ?”’ PPT???ˆì „??OpenAI ?„ë¡???¸ì¶œ (Netlify Functions ?„ìš©)
    async function callOpenAIForPPT({ systemPrompt, userPrompt }) {
      console.log('?”„ PPT??OpenAI ?„ë¡???¸ì¶œ ?œì‘...');

      const body = {
        model: OPENAI_MODEL || 'gpt-4o-mini',
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        max_tokens: 16000,
        temperature: 0.1
      };

      const res = await fetch('/.netlify/functions/openai-proxy', {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const errData = await res.json().catch(() => ({ error: 'Unknown error' }));
        console.error('??PPT OpenAI ?„ë¡???¤ë¥˜:', res.status, errData);
        
        // êµ¬ì²´?ì¸ ?¤ë¥˜ ë©”ì‹œì§€ ?œê³µ
        if (res.status === 404) {
          throw new Error('PPT OpenAI ?„ë¡???¨ìˆ˜ê°€ ë°°í¬?˜ì? ?Šì•˜?µë‹ˆ?? Netlify ë°°í¬ ?íƒœë¥??•ì¸?´ì£¼?¸ìš”.');
        } else if (errData.code === 'MISSING_API_KEY') {
          throw new Error('PPT??Netlify ?˜ê²½ë³€??OPENAI_API_KEYê°€ ?¤ì •?˜ì? ?Šì•˜?µë‹ˆ?? Site settings?ì„œ ?˜ê²½ë³€?˜ë? ?¤ì •?˜ê³  ?¬ë°°?¬í•´ì£¼ì„¸??');
        } else {
          throw new Error(`PPT OpenAI ?„ë¡???¤ë¥˜: ${res.status} ${errData.error || 'Unknown error'}`);
        }
      }

      const data = await res.json();
      console.log('??PPT OpenAI ?„ë¡???¸ì¶œ ?±ê³µ');
      
      const outputText =
        data.choices?.[0]?.message?.content ||
        data.output_text ||
        data.response?.[0]?.content?.[0]?.text ||
        JSON.stringify(data);

      return (outputText || "").trim();
    }

    // HTML ???ìŠ¤????ë³€??(PptxGenJS??
    const PPT_FONT = 'NanumSquare';
    function htmlToTextRunsForPptx(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const runs = [];
      const body = doc.body;
      const walk = (node) => {
        if (!node) return;
        node.childNodes.forEach((child) => {
          if (child.nodeType === 1) {
            const tag = child.tagName.toLowerCase();
            if (tag === 'p') {
              const text = child.textContent.trim();
              if (text) runs.push({ text, options: { fontSize: 14, fontFace: PPT_FONT, lineSpacing: 24, paraSpaceAfter: 6 } });
            } else if (tag === 'ul' || tag === 'ol') {
              // ê¸€ë¨¸ë¦¬ê¸°í˜¸ë¥??œê±°?˜ê³  ?¼ë°˜ ë¬¸ë‹¨?¼ë¡œ ë³€??
              child.querySelectorAll(':scope > li').forEach((li) => {
                const text = li.textContent.trim();
                if (text) runs.push({ text: `- ${text}`, options: { fontSize: 14, fontFace: PPT_FONT, lineSpacing: 24, paraSpaceAfter: 4 } });
              });
            } else {
              walk(child);
            }
          }
        });
      };
      walk(body);
      return runs.length ? runs : [{ text: body.textContent.trim(), options: { fontSize: 14, fontFace: PPT_FONT } }];
    }

    function extractFirstHeading(html, fallback) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const h = doc.querySelector('h3, h2, h1');
      return (h?.textContent || fallback || '?œëª© ?†ìŒ').trim();
    }

    async function generatePPTFromFinalReport() {
      try {
        const pptBtn = document.getElementById('btn-export-ppt');
        pptBtn?.classList.add('ppt-progress');
        pptBtn?.classList.add('blink-text');
        pptBtn && (pptBtn.disabled = true);
        const textarea = document.getElementById('gpt4-output');
        const sourceText = (textarea?.value || '').trim();
        if (!sourceText) {
          if (typeof showToast === 'function') showToast('GPT4 ìµœì¢… ë³´ê³ ???´ìš©??ë¹„ì–´ ?ˆìŠµ?ˆë‹¤.', 'error');
          else alert('GPT4 ìµœì¢… ë³´ê³ ???´ìš©??ë¹„ì–´ ?ˆìŠµ?ˆë‹¤.');
          return;
        }

        const sendEl = document.getElementById('send-status');
        if (sendEl) sendEl.textContent = 'PPT ?‘ì„±???¹ì…˜ ?ì„± ì¤?..';

        // ?œëª© ë°??¹ì…˜ 3ê°??ì„± (?”ì•½ / ?µì‹¬ ?´ìš© / ê²°ë¡ ) + ?œì? ?˜ë‹¨ ?ì???œë‚˜ë¦¬ì˜¤ PDF ?”ì•½
        const templateKey = 'background-content-conclusion';
        const { systemPrompt: sys1, userPrompt: usr1 } = buildSectionPrompt({ templateKey, sectionName: '?”ì•½', sourceText });
        const summaryHtml = await callOpenAIForPPT({ systemPrompt: sys1, userPrompt: usr1 });

        const { systemPrompt: sys2, userPrompt: usr2 } = buildSectionPrompt({ templateKey, sectionName: '?µì‹¬ ?´ìš©', sourceText });
        const contentHtml = await callOpenAIForPPT({ systemPrompt: sys2, userPrompt: usr2 });

        const { systemPrompt: sys3, userPrompt: usr3 } = buildSectionPrompt({ templateKey, sectionName: 'ê²°ë¡  ë°?ê¶Œê³ ', sourceText });
        const conclusionHtml = await callOpenAIForPPT({ systemPrompt: sys3, userPrompt: usr3 });

        // gpt0 ?œë‚˜ë¦¬ì˜¤ PDF ?”ì•½ ?ìŠ¤?¸ë? ?œì? ?˜ë‹¨ ?ì?©ìœ¼ë¡?ë³€??
        const scenPdfText = (document.getElementById('gpt0-scenpdf')?.value || '').trim();
        let coverScenarioHtml = '';
        if (scenPdfText) {
          const scenarioName = (document.getElementById('selected-scenario-name')?.textContent || '').trim();
          const { systemPrompt: sysC, userPrompt: usrC } = buildCoverScenarioPrompt({ scenarioName, sourceText: scenPdfText });
          coverScenarioHtml = await callOpenAIForPPT({ systemPrompt: sysC, userPrompt: usrC });
        }

        if (sendEl) sendEl.textContent = 'PPT ?Œì¼ ?ì„± ì¤?..';

        const Pptx = window.PptxGenJS || window.pptxgen || window.pptxgenjs || window.PptxGen; // UMD ë³€???¸í™˜
        if (typeof Pptx === 'undefined') {
          throw new Error('PptxGenJS ë¡œë”© ?¤íŒ¨. ?¤íŠ¸?Œí¬ ?ëŠ” CDN ì°¨ë‹¨???•ì¸?˜ì„¸??');
        }

        const pptx = new Pptx();
        // ?ˆì´?„ì›ƒ: ?¸ë¡œ??A4 (?¬ìš©???ˆì´?„ì›ƒ ?±ë¡ ???´ë¦„?¼ë¡œ ì§€??
        const LAYOUT_W = 8.27;  // A4 portrait ??in)
        const LAYOUT_H = 11.69; // A4 portrait ?’ì´(in)
        const MARGIN_X = 0.8;
        const MARGIN_Y = 0.9;
        pptx.defineLayout({ name: 'A4_P', width: LAYOUT_W, height: LAYOUT_H });
        pptx.layout = 'A4_P';
        const title = extractFirstHeading(`<h1>${(document.getElementById('selected-scenario-name')?.textContent || '').trim()}</h1>`, 'AI ?ë™ ?ì„± ë³´ê³ ??);

        // ?œì? ?¬ë¼?´ë“œ (?ë‹¨ ë°°ë„ˆ + ?˜ë‹¨ ?œë‚˜ë¦¬ì˜¤ ë¶„ì„ ?ì)
        let slide = pptx.addSlide();
        slide.addShape(pptx.ShapeType.rect, {
          x: 0, y: 0, w: LAYOUT_W, h: MARGIN_Y + 1.2,
          fill: { color: '2C7BE5' }, line: { color: '2C7BE5' }
        });
        slide.addText(title || 'AI ?ë™ ?ì„± ë³´ê³ ??, {
          x: MARGIN_X, y: MARGIN_Y + 0.1, w: LAYOUT_W - MARGIN_X * 2, h: 0.9,
          align: 'center', fontSize: 38, bold: true, color: 'FFFFFF', fontFace: PPT_FONT
        });
        slide.addText(new Date().toLocaleString(), {
          x: MARGIN_X, y: MARGIN_Y + 1.4, w: LAYOUT_W - MARGIN_X * 2, h: 0.4,
          align: 'center', fontSize: 13, color: '666666', fontFace: PPT_FONT
        });

        // ?˜ë‹¨ ?ì: ?œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ?”ì•½) - ?œì? ?´ë???ë°°ì¹˜
        if (coverScenarioHtml) {
          const boxX = MARGIN_X;
          const boxW = LAYOUT_W - MARGIN_X * 2;
          const boxY = MARGIN_Y + 2.0; // ?œëª©/?¼ì ?„ë˜ ê³µë°± ?ê³  ?œì‘
          const boxH = LAYOUT_H - boxY - MARGIN_Y; // ?˜ë‹¨ ?¬ë°±ê¹Œì? ì±„ì?
          // ë°°ê²½ ë°•ìŠ¤
          slide.addShape(pptx.ShapeType.roundRect, {
            x: boxX, y: boxY, w: boxW, h: boxH,
            fill: { color: 'F9FBFF' }, line: { color: 'D6E4FF' }, rectRadius: 0.15
          });
          // ?œëª©
          slide.addText('?œë‚˜ë¦¬ì˜¤ ë¶„ì„(PDF ?”ì•½)', {
            x: boxX + 0.2, y: boxY + 0.2, w: boxW - 0.4, h: 0.5,
            fontSize: 18, bold: true, color: '2C7BE5', fontFace: PPT_FONT
          });
          // ?´ìš©
          const runsC = htmlToTextRunsForPptx(coverScenarioHtml);
          slide.addText(runsC.map(r => ({ text: r.text + '\n', options: r.options })), {
            x: boxX + 0.2, y: boxY + 0.8, w: boxW - 0.4, h: boxH - 1.0
          });
        }

        // ??ë²ˆì§¸ ?¬ë¼?´ë“œ: GPT0 ?„ì¬ ë§ˆì¼“/?œí™© + ?œë‚˜ë¦¬ì˜¤ ë§ˆì¼“?°ì´???°ê³„ ë¶„ì„
        try {
          const scenName = (document.getElementById('selected-scenario-name')?.textContent || '').trim();
          const scenMarketText = (document.getElementById('gpt0-marketdata')?.value || '').trim();
          const marketStateText = (document.getElementById('gpt0-marketstate')?.value || '').trim();
          if (scenMarketText || marketStateText) {
            const { systemPrompt: sysM, userPrompt: usrM } = buildGpt0MarketSlidePrompt({ scenarioName: scenName, scenMarketText, marketStateText });
            const marketSlideHtml = await callOpenAIForPPT({ systemPrompt: sysM, userPrompt: usrM });
            const s2 = pptx.addSlide();
            // ?¹ì…˜ ë°°ë„ˆ
            s2.addShape(pptx.ShapeType.rect, {
              x: MARGIN_X, y: MARGIN_Y, w: LAYOUT_W - MARGIN_X * 2, h: 0.55,
              fill: { color: 'F0F5FF' }, line: { color: 'F0F5FF' }
            });
            s2.addText('?„ì¬ ë§ˆì¼“/?œí™© ë°??œë‚˜ë¦¬ì˜¤ ?°ê³„ ë¶„ì„', { x: MARGIN_X + 0.1, y: MARGIN_Y + 0.05, w: LAYOUT_W - (MARGIN_X + 0.1) * 2, h: 0.45, fontSize: 24, bold: true, fontFace: PPT_FONT, color: '2C7BE5' });
            const runs2 = htmlToTextRunsForPptx(marketSlideHtml);
            const cY2 = MARGIN_Y + 0.8; const cH2 = LAYOUT_H - cY2 - MARGIN_Y;
            s2.addText(runs2.map(r => ({ text: r.text + '\n', options: r.options })), { x: MARGIN_X, y: cY2, w: LAYOUT_W - MARGIN_X * 2, h: cH2 });
            s2.addText('2', { x: LAYOUT_W / 2 - 0.15, y: LAYOUT_H - MARGIN_Y + 0.1, w: 0.3, h: 0.3, fontSize: 10, color: '888888', align: 'center' });
          }
        } catch(_) { /* ignore */ }

        // ??ë²ˆì§¸ ?¬ë¼?´ë“œ: GPT3 ê°??„ë©”??ë¶„ì„ ?”ì•½(?Œì£¼?œë³„ ë³¸ë¬¸)
        try {
          const outMarket = (document.getElementById('gpt3-market')?.value || '').trim();
          const outCredit = (document.getElementById('gpt3-credit')?.value || '').trim();
          const outAlm    = (document.getElementById('gpt3-alm')?.value || '').trim();
          const outGlobal = (document.getElementById('gpt3-global')?.value || '').trim();
          const outCreditPf = (document.getElementById('gpt3-creditpf')?.value || '').trim();
          if (outMarket || outCredit || outAlm || outGlobal || outCreditPf) {
            const { systemPrompt: sysD, userPrompt: usrD } = buildGpt3DomainsSlidePrompt({ outMarket, outCredit, outAlm, outGlobal, outCreditPf });
            const domSlideHtml = await callOpenAIForPPT({ systemPrompt: sysD, userPrompt: usrD });
            const s3 = pptx.addSlide();
            s3.addShape(pptx.ShapeType.rect, {
              x: MARGIN_X, y: MARGIN_Y, w: LAYOUT_W - MARGIN_X * 2, h: 0.55,
              fill: { color: 'F0F5FF' }, line: { color: 'F0F5FF' }
            });
            s3.addText('GPT3 ?„ë©”??ë¶„ì„ ?”ì•½', { x: MARGIN_X + 0.1, y: MARGIN_Y + 0.05, w: LAYOUT_W - (MARGIN_X + 0.1) * 2, h: 0.45, fontSize: 24, bold: true, fontFace: PPT_FONT, color: '2C7BE5' });
            const runs3 = htmlToTextRunsForPptx(domSlideHtml);
            const cY3 = MARGIN_Y + 0.8; const cH3 = LAYOUT_H - cY3 - MARGIN_Y;
            s3.addText(runs3.map(r => ({ text: r.text + '\n', options: r.options })), { x: MARGIN_X, y: cY3, w: LAYOUT_W - MARGIN_X * 2, h: cH3 });
            s3.addText('3', { x: LAYOUT_W / 2 - 0.15, y: LAYOUT_H - MARGIN_Y + 0.1, w: 0.3, h: 0.3, fontSize: 10, color: '888888', align: 'center' });
          }
        } catch(_) { /* ignore */ }

        // ?¹ì…˜ ?¬ë¼?´ë“œ??(?”ì•½/?µì‹¬/ê²°ë¡ )
        const sections = [
          { name: '?”ì•½', html: summaryHtml },
          { name: '?µì‹¬ ?´ìš©', html: contentHtml },
          { name: 'ê²°ë¡  ë°?ê¶Œê³ ', html: conclusionHtml },
        ];

        sections.forEach(({ name, html }, idx) => {
          const s = pptx.addSlide();
          const heading = extractFirstHeading(html, name);
          // ?¹ì…˜ ë°°ë„ˆ ë°?
          s.addShape(pptx.ShapeType.rect, {
            x: MARGIN_X, y: MARGIN_Y, w: LAYOUT_W - MARGIN_X * 2, h: 0.55,
            fill: { color: 'F0F5FF' }, line: { color: 'F0F5FF' }
          });
          s.addText(heading, { x: MARGIN_X + 0.1, y: MARGIN_Y + 0.05, w: LAYOUT_W - (MARGIN_X + 0.1) * 2, h: 0.45, fontSize: 24, bold: true, fontFace: PPT_FONT, color: '2C7BE5' });
          const runs = htmlToTextRunsForPptx(html);
          const contentY = MARGIN_Y + 0.8;
          const contentH = LAYOUT_H - contentY - MARGIN_Y;
          s.addText(runs.map(r => ({ text: r.text + '\n', options: r.options })), { x: MARGIN_X, y: contentY, w: LAYOUT_W - MARGIN_X * 2, h: contentH });
          // ?˜ì´ì§€ ë²ˆí˜¸(?Œë°•?˜ê²Œ ?˜ë‹¨ ì¤‘ì•™)
          s.addText(String(idx + 1), { x: LAYOUT_W / 2 - 0.15, y: LAYOUT_H - MARGIN_Y + 0.1, w: 0.3, h: 0.3, fontSize: 10, color: '888888', align: 'center' });
        });

        await pptx.writeFile({ fileName: `ìµœì¢…ë³´ê³ ??${Date.now()}.pptx` });
        if (sendEl) sendEl.textContent = '';
        if (typeof showToast === 'function') showToast('PPT ?Œì¼???ì„±?˜ì—ˆ?µë‹ˆ??', 'success');
      } catch (err) {
        console.error(err);
        const sendEl = document.getElementById('send-status');
        if (sendEl) sendEl.textContent = '';
        if (typeof showToast === 'function') showToast(`PPT ?ì„± ?¤íŒ¨: ${err.message}`, 'error');
        else alert(`PPT ?ì„± ?¤íŒ¨: ${err.message}`);
      } finally {
        const pptBtn = document.getElementById('btn-export-ppt');
        pptBtn?.classList.remove('ppt-progress');
        pptBtn?.classList.remove('blink-text');
        pptBtn && (pptBtn.disabled = false);
      }
    }

    // ====== HTML ë³´ê³ ???ì„± ê¸°ëŠ¥ ======
    let generatedHTMLCode = '';

    ;(function restoreOnReady(){
  const run = () => {
    const savedHTML = localStorage.getItem('generatedHTMLCode');
    const savedState = JSON.parse(localStorage.getItem('reportState') || '{}');
    if (savedHTML && savedState?.isGenerated) {
      window.generatedHTMLCode = savedHTML;
      window.reportState = { ...(window.reportState||{}), isGenerated: true, htmlContent: savedHTML };
      const htmlBtn = document.getElementById('btn-export-html');
      if (htmlBtn) {
        htmlBtn.textContent = 'ë³´ê³ ?œë³´ê¸?;
        htmlBtn.disabled = false;
      }
    }
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }
})();


        // ?Œì´?„ë¼???œê°???¨ê³¼ ? ê? ?¨ìˆ˜
    function setPipelineVisuals(active) {
      console.log(`[viz] ${active ? 'on' : 'off'}`);
      // ?œë‚˜ë¦¬ì˜¤ ?¸ë“œ?¤ì— ?¤í–‰ ì¤??¨ê³¼
      d3.selectAll('.scenario-group').classed('agent-running', active);
      d3.selectAll('.scenario-node').classed('agent-running', active);
      // ?°ê²°? ë“¤??ê¹œë°•???¨ê³¼
      d3.selectAll('.connection-line').classed('blink-y-all', active);
      // ?Œì´?„ë¼??? ë“¤???ë¦„ ? ë‹ˆë©”ì´??
      d3.selectAll('.pipeline-line').classed('flow', active);
    }

        // ?Œì´?„ë¼??+ ë³´ê³ ???µí•© ?¸ë“¤??(?ë‹¨ ë²„íŠ¼??
    async function handlePipelineAndReport() {
      const topBtn = document.getElementById('top-pipeline-btn');
      const status = document.getElementById('send-status');
      const reportBtnsContainer = document.getElementById('report-buttons-container');
      
      try {
        console.log('?? ?Œì´?„ë¼??+ ë³´ê³ ???µí•© ?¤í–‰ ?œì‘');
        
        // ?“± Wake Lock ?œì„±??(?”ë©´ êº¼ì§ ë°©ì?)
        const wakeLockEnabled = await requestWakeLock();
        
        // ?“± ëª¨ë°”???˜ê²½?ì„œ ëª¨ë“  ì¹´ë“œ ?œì‹œ
        if (typeof showAllCardsOnPipelineStart === 'function') {
          showAllCardsOnPipelineStart();
        }
        
        // ?Œì´?„ë¼???œê°???¨ê³¼ ?œì‘
        setPipelineVisuals(true);
        
        // ?Œì´?„ë¼???œì‘ ??ë³´ê³ ?œë³´ê¸?& ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?¨ê?
        if (reportBtnsContainer) {
          reportBtnsContainer.style.display = 'none';
        }
        
        // ë²„íŠ¼ ?íƒœ ë³€ê²?- ?Œì´?„ë¼???¤í–‰ ì¤?
        if (topBtn) {
          topBtn.style.display = 'inline-block'; // ???œì‘ ??ë¶„ì„?¤í–‰ ë²„íŠ¼ ?œì‹œ
          topBtn.disabled = true;
          topBtn.textContent = '??ë¶„ì„ì¤?..';
          topBtn.classList.add('blink-text');
          topBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
        }
        
        if (status) {
          const wakeLockMsg = wakeLockEnabled ? ' ?”’' : '';
          status.textContent = `?? ?Œì´?„ë¼???¤í–‰ ì¤?..${wakeLockMsg}`;
          status.style.color = '#3498db';
          status.classList.add('status-shine');
        }
        
        // 1?¨ê³„: ?Œì´?„ë¼???¤í–‰
        await window.executePipelineSteps((step, description) => {
          if (status) {
            status.textContent = `?“Š ${step}/5?¨ê³„: ${description}`;
          }
          if (topBtn) {
            topBtn.textContent = `??${step}/5?¨ê³„`;
          }
        });
        
        // 2?¨ê³„: ?Œì´?„ë¼???„ë£Œ ???ë™ ë³´ê³ ???ì„±
        if (status) {
          status.textContent = '?“„ ë³´ê³ ???ì„± ì¤?..';
          status.style.color = '#2ecc71';
        }
        if (topBtn) {
          topBtn.textContent = '?“„ ë³´ê³ ???ì„±ì¤?..';
          topBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
        }
        
        // ë³´ê³ ???ë™ ?ì„± (ì¤‘ë³µ ê°€???ìš©??
        await generateHTMLReportDirect();
        
        // ?„ë£Œ ?íƒœ - ë¶„ì„?¤í–‰ ë²„íŠ¼ ?¨ê¸°ê¸? ë³´ê³ ?œë³´ê¸?& ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?œì‹œ
        if (topBtn) {
          topBtn.disabled = false;
          topBtn.classList.remove('blink-text');
          topBtn.style.display = 'none'; // ???„ë£Œ ??ë¶„ì„?¤í–‰ ë²„íŠ¼ ?¨ê?
        }
        
        // ?„ë£Œ ??ë³´ê³ ?œë³´ê¸?& ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ì»¨í…Œ?´ë„ˆ ?œì‹œ
        if (reportBtnsContainer) {
          reportBtnsContainer.style.display = 'flex';
        }
        
        if (status) {
          status.textContent = '?‰ ë¶„ì„ ë°?ë³´ê³ ???ì„±???„ë£Œ?˜ì—ˆ?µë‹ˆ??';
          status.style.color = '#27ae60';
          status.classList.remove('status-shine');
        }
        
        // ?Œì´?„ë¼???œê°???¨ê³¼ ì¢…ë£Œ
        setPipelineVisuals(false);
        
        // ?“± Wake Lock ?´ì œ (?”ë©´ êº¼ì§ ë°©ì? ?´ì œ)
        await releaseWakeLock();
        
        console.log('???Œì´?„ë¼??+ ë³´ê³ ???µí•© ?¤í–‰ ?„ë£Œ');
        
      } catch (error) {
        console.error('???Œì´?„ë¼??+ ë³´ê³ ???µí•© ?¤í–‰ ?¤íŒ¨:', error);
        
        // ?Œì´?„ë¼???œê°???¨ê³¼ ì¢…ë£Œ
        setPipelineVisuals(false);
        
        // ?“± Wake Lock ?´ì œ (?¤ë¥˜ ??
        await releaseWakeLock();
        
        // ?¤ë¥˜ ?íƒœ ë³µì›
        if (topBtn) {
          topBtn.style.display = 'inline-block'; // ???¤ë¥˜ ??ë¶„ì„?¤í–‰ ë²„íŠ¼ ?œì‹œ
          topBtn.disabled = false;
          topBtn.textContent = 'ë¶„ì„?¤í–‰';
          topBtn.classList.remove('blink-text');
          topBtn.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
        }
        
        // ?¤ë¥˜ ??ë³´ê³ ?œë³´ê¸?& ?¤ì‹œ?¤í–‰ ë²„íŠ¼ ?¨ê?
        if (reportBtnsContainer) {
          reportBtnsContainer.style.display = 'none';
        }
        
        if (status) {
          status.textContent = `???¤í–‰ ?¤íŒ¨: ${error.message}`;
          status.style.color = '#e74c3c';
          status.classList.remove('status-shine');
        }
        
        alert(`?¤í–‰ ?¤íŒ¨: ${error.message}`);
      }
    }

    // ë³´ê³ ???¡ì…˜ ?¸ë“¤??(?‘ì„±/ë³´ê¸° ? ê?)
    async function handleReportAction(forceRegenerate = false) {
      try {
        console.log('?“„ ë³´ê³ ???¡ì…˜ ?¸ë“¤???¸ì¶œ??);
        
        // ?˜ë‹¨ ë²„íŠ¼ ê¹œë°•??ê°•ì¡°
        const btn = document.getElementById('btn-export-html');
        const reportActions = document.getElementById('report-actions');
        btn && btn.classList.add('report-cta');
        reportActions && reportActions.classList.add('report-actions-cta');
        setTimeout(()=>{ btn && btn.classList.remove('report-cta'); }, 1800);
        setTimeout(()=>{ reportActions && reportActions.classList.remove('report-actions-cta'); }, 2200);



      if (window.reportState.isGenerated && !forceRegenerate) {
        previewHTML();

      } else {
        await generateHTMLReportDirect({ force: forceRegenerate });
        // ë³´ê³ ???ì„± ??ë°”ë¡œ ?ˆì°½?ì„œ ë³´ê¸°
        if (window.reportState.isGenerated && window.reportState.htmlContent) {
          previewHTMLDirect(window.reportState.htmlContent);
        }
        }
      } catch(error) {
        console.error('??ë³´ê³ ???¡ì…˜ ?¸ë“¤???¤ë¥˜:', error);
        

        
        if (window.reportState.isGenerated && !forceRegenerate) {
          previewHTML();
        } else {
          await generateHTMLReportDirect({ force: forceRegenerate });
        }
      }
    }



    // ?„ì—­ ë³´ê³ ???íƒœ ì´ˆê¸°??(ì¤‘ë³µ ?ì„± ë°©ì???
    window.reportState = window.reportState || { isGenerated: false, generating: false, htmlContent: '' };

    // ?ì—… ?†ì´ ë°”ë¡œ HTML ë³´ê³ ???ì„± ë°??¤ìš´ë¡œë“œ
    async function generateHTMLReportDirect({ force = false } = {}) {
      // ì¤‘ë³µ ?ì„± ê°€??
      if (window.reportState.generating && !force) {
        console.warn('[report] ?´ë? ?ì„± ì¤?- ì¤‘ë³µ ?¤í–‰ ì°¨ë‹¨');
        return;
      }
      if (window.reportState.isGenerated && !force) {
        console.log('[report] ?´ë? ?ì„±??- ì¤‘ë³µ ?¤í–‰ ì°¨ë‹¨');
        return;
      }

      window.reportState.generating = true;
      
      try {
        // ?˜ë‹¨ ë²„íŠ¼ ?íƒœ ?…ë°?´íŠ¸
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = true;
          htmlBtn.textContent = 'ë³´ê³ ???ì„±ì¤?..';
          htmlBtn.classList.add('report-progress');
          htmlBtn.classList.add('blink-text');
        }
        


        // GPT4 ìµœì¢… ë³´ê³ ???´ìš©???°ì„ ?ìœ¼ë¡?ê°€?¸ì˜¤ê¸?
        let finalReport = document.getElementById('gpt4-output')?.value?.trim() || '';
        
        // GPT4 ì¶œë ¥???†ëŠ” ê²½ìš°?ë§Œ ?¤ë¥¸ ?ŒìŠ¤ë¥?ê³ ë ¤
        if (!finalReport) {
          console.warn('? ï¸ GPT4 ì¶œë ¥??ë¹„ì–´?ˆìŒ - ?¤ë¥¸ ?ŒìŠ¤ ?•ì¸');
          
          // ??ë°±ì—… ?ŒìŠ¤??GPT3 ê²°ê³¼ë¥??°ì„  ?¬í•¨ (?•ìƒ?™ì‘?˜ëŠ” ë²„ì „??ë°±ì—… ?ŒìŠ¤ ?¨í„´)
          const backupSources = [
            document.getElementById('gpt3-market')?.value,
            document.getElementById('gpt3-credit')?.value,
            document.getElementById('gpt3-alm')?.value,
            document.getElementById('gpt3-global')?.value,
            document.getElementById('gpt3-creditpf')?.value,
            document.getElementById('gpt1-output')?.value,
            document.getElementById('gpt0-marketdata')?.value
          ].filter(v => v && v.trim());

          if (backupSources.length > 0) {
            finalReport = backupSources.join('\n\n---\n\n');
            console.log('?“ ë°±ì—… ?ŒìŠ¤ë¡?ë³´ê³ ???ì„±');
          } else {
            throw new Error('GPT4 ìµœì¢… ë³´ê³ ??ë°?ëª¨ë“  ë°±ì—… ?ŒìŠ¤ê°€ ë¹„ì–´?ˆìŠµ?ˆë‹¤. ë¨¼ì? ë¶„ì„???¤í–‰?´ì£¼?¸ìš”.');
          }
        } else {
          console.log('??GPT4 ì¶œë ¥???°ì„ ?ìœ¼ë¡??¬ìš©?˜ì—¬ HTML ë³´ê³ ???ì„±');
        }

        // ?„ì¬ ? ì§œ ?ì„±
        const today = new Date();
        const dateString = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');

        // HTML ?ì„± ?„ë¡¬?„íŠ¸ êµ¬ì„± (ê°„ì†Œ??
        const title = '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??;
        const htmlPrompt = 
          '?¤ìŒ ?ìŠ¤?¸ë? ?„ì „??HTML5 ë¬¸ì„œë¡?ë³€?˜í•˜?¸ìš”.\n' +
          '?œëª©: ' + title + '\n' +
          '?‘ì„±?? ' + dateString + '\n' +
          '?‘ì„±?? ë¦¬ìŠ¤?¬ê?ë¦¬í?\n\n' +
          '?ë¬¸:\n' + finalReport + '\n\n' +
          '?”êµ¬?¬í•­:\n' +
          '1) ?„ì „??HTML5 ë¬¸ì„œ ?•íƒœë¡?ì¶œë ¥\n' +
          '2) head??CSS ?¤í????¬í•¨\n' +
          '3) ?œëª©, ëª©ì°¨, ë³¸ë¬¸ ?¹ì…˜?¼ë¡œ êµ¬ì„±\n' +
          '4) ?œêµ­?????œì? ì¤€??n' +
          '5) ?¸ì‡„ ê°€?¥í•œ ?•íƒœ\n' +
          '6) ë¬¸ì²´???„ë¬¸?ì´ê³??•ì¤‘??"~?µë‹ˆ?? ?•ì‹?¼ë¡œ ?µì¼\n\n' +
          '?¤ì§ HTML ì½”ë“œë§?ì¶œë ¥?˜ê³  ?¤ë¥¸ ?¤ëª…?€ ?¬í•¨?˜ì? ë§ˆì„¸??';

        // OpenAI API ?¸ì¶œ (ê¸°ì¡´ ë°©ì‹ ? ì? - gpt-4o-mini ?¬ìš©)
        // ?”’ ë³´ì•ˆ: getOpenAIAuthHeaders ?œê±°??- callOpenAI ?¨ìˆ˜ ?¬ìš©

        // ?”§ ì²˜ìŒë¶€??ë¶„í•  ë³€?˜ìœ¼ë¡?ì²˜ë¦¬ (?€?©ëŸ‰ ?ˆì •??
        console.log('?§© ?€?©ëŸ‰ ë³´ê³ ?? ë¶„í•  ?ì„± ?œì‘');
        let htmlCode = '';
        try {
          htmlCode = await generateHtmlFromFinalReportChunked(finalReport, title, dateString);
        } catch (eChunk) {
          console.warn('? ï¸ ë¶„í•  ?ì„± ?¤íŒ¨, ìµœì¢… ë¡œì»¬ Fallback ?¬ìš©:', eChunk.message);
          htmlCode = buildBasicHTMLDocument(title, dateString, finalReport);
        }
        
        // ê¸°ì¡´ fetch ì½”ë“œ ?œê±°??
        /*const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: '?ˆëŠ” HTML ë§ˆí¬???„ë¬¸ê°€?´ë‹¤. ì£¼ì–´ì§??ìŠ¤?¸ë? ?„ì „??HTML5 ë¬¸ì„œë¡?ë³€?˜í•œ?? ?¤ì§ HTML ì½”ë“œë§?ì¶œë ¥?˜ê³  ?¤ë¥¸ ?¤ëª…?€ ?¼ì ˆ ?¬í•¨?˜ì? ?ŠëŠ”??'
              },
              {
                role: 'user',
                content: htmlPrompt
              }
            ],
            max_tokens: 16000,
            temperature: 0.1
          })
        });*/

        // ê¸°ì¡´ ?‘ë‹µ ì²˜ë¦¬ ì½”ë“œ ?œê±°??- callOpenAIê°€ ì²˜ë¦¬
        /*if (!response.ok) {
          throw new Error(`OpenAI API ?¤ë¥˜: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const htmlCode = data.choices[0]?.message?.content?.trim();*/

        if (!htmlCode) {
          throw new Error('HTML ?ì„± ê²°ê³¼ê°€ ë¹„ì–´?ˆìŠµ?ˆë‹¤.');
        }

        // ?ì„±??HTML ?€??ë°??íƒœ ?…ë°?´íŠ¸
        generatedHTMLCode = htmlCode;
        window.reportState.isGenerated = true;
        window.reportState.htmlContent = htmlCode;

                // ?”¸ ì¶”ê?: ?íƒœ ?ì†??
        try {
          localStorage.setItem('generatedHTMLCode', htmlCode);
          localStorage.setItem('reportState', JSON.stringify({ isGenerated: true }));
        } catch (e) {
          console.warn('ë³´ê³ ???€???ëµ(?©ëŸ‰ ì´ˆê³¼):', e);
        }
        
        // ?˜ë‹¨ ë²„íŠ¼ ?íƒœ ?…ë°?´íŠ¸
        if (htmlBtn) {
          htmlBtn.textContent = 'ë³´ê³ ?œë³´ê¸?;
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          // ë°•ìŠ¤ ?¤í??¼ë¡œ ë³€ê²?
          htmlBtn.style.width = '100%';
          htmlBtn.style.padding = '8px 12px';
          htmlBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
          htmlBtn.style.color = 'white';
          htmlBtn.style.fontWeight = '600';
          htmlBtn.style.border = 'none';
          htmlBtn.style.borderRadius = '6px';
        }



        // ë³´ê³ ???ì„± ?„ë£Œ ?Œë¦¼ (?ë™ ?ˆì°½ ?´ê¸° ?œê±°)
        console.log('??ë³´ê³ ???ì„± ?„ë£Œ - ?¬ìš©?ê? "ë³´ê³ ?œë³´ê¸? ?´ë¦­ ???ˆì°½ ?´ë¦¼');
         
         try {
           const reportActions = document.getElementById('report-actions');
           const htmlBtnRef = document.getElementById('btn-export-html');
           reportActions && reportActions.classList.add('report-actions-cta');
           htmlBtnRef && htmlBtnRef.classList.add('report-cta');
           setTimeout(() => {
             reportActions && reportActions.classList.remove('report-actions-cta');
             htmlBtnRef && htmlBtnRef.classList.remove('report-cta');
           }, 2500);
         } catch(_) { /* ignore */ }
        
      } catch (error) {
        console.error('HTML ë³´ê³ ???ì„± ?¤íŒ¨:', error);
        
        // ?˜ë‹¨ ë²„íŠ¼ ?íƒœ ë³µì›
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          
          // ?¤íŒ¨ ?œì—ë§?ë²„íŠ¼ ?ìŠ¤??ë³µì›
          if (!window.reportState.isGenerated) {
            htmlBtn.textContent = 'ë³´ê³ ?œì‘??;
            // ë°•ìŠ¤ ?¤í??¼ë¡œ ë³€ê²?
            htmlBtn.style.width = '100%';
            htmlBtn.style.padding = '8px 12px';
            htmlBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            htmlBtn.style.color = 'white';
            htmlBtn.style.fontWeight = '600';
            htmlBtn.style.border = 'none';
            htmlBtn.style.borderRadius = '6px';
            // ?¤íŒ¨ ?œì—??CTA ?¨ê³¼ë¡??¬ìš©??? ë„
            try {
              const reportActions = document.getElementById('report-actions');
              reportActions && reportActions.classList.add('report-actions-cta');
              htmlBtn && htmlBtn.classList.add('report-cta');
              setTimeout(() => {
                reportActions && reportActions.classList.remove('report-actions-cta');
                htmlBtn && htmlBtn.classList.remove('report-cta');
              }, 3000);
            } catch(_) { /* ignore */ }
          }
        }
        

        
        alert(`ë³´ê³ ???ì„± ?¤íŒ¨: ${error.message}`);
      } finally {
        // ?ì„± ?íƒœ ?´ì œ
        window.reportState.generating = false;
      }
    }

    async function generateHTMLReport() {
      try {
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = true;
          htmlBtn.textContent = 'ë³´ê³ ???ì„±ì¤?..';
          htmlBtn.classList.add('report-progress');
          htmlBtn.classList.add('blink-text');
        }

        // ëª¨ë‹¬ ?´ê¸°
        const modal = document.getElementById('html-modal');
        const statusDiv = document.getElementById('html-status');
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'HTML ë³´ê³ ???ì„± ì¤?..';
        modal.classList.add('show');

        // GPT4 ìµœì¢… ë³´ê³ ???´ìš© ê°€?¸ì˜¤ê¸?
        const finalReport = document.getElementById('gpt4-output').value || '';
        if (!finalReport.trim()) {
          throw new Error('GPT4 ìµœì¢… ë³´ê³ ?œê? ë¹„ì–´?ˆìŠµ?ˆë‹¤. ë¨¼ì? ë¶„ì„???¤í–‰?´ì£¼?¸ìš”.');
        }

        // ?„ì¬ ? ì§œ ?ì„±
        const today = new Date();
        const dateString = today.getFullYear() + '-' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(today.getDate()).padStart(2, '0');

        // HTML ?ì„± ?„ë¡¬?„íŠ¸ êµ¬ì„± (ê°„ì†Œ??
        const title = '?œë‚˜ë¦¬ì˜¤ ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??;
        const htmlPrompt = 
          '?¤ìŒ ?ìŠ¤?¸ë? ?„ì „??HTML5 ë¬¸ì„œë¡?ë³€?˜í•˜?¸ìš”.\n' +
          '?œëª©: ' + title + '\n' +
          '?‘ì„±?? ' + dateString + '\n' +
          '?‘ì„±?? ë¦¬ìŠ¤?¬ê?ë¦¬í?\n\n' +
          '?ë¬¸:\n' + finalReport + '\n\n' +
          '?”êµ¬?¬í•­:\n' +
          '1) ?„ì „??HTML5 ë¬¸ì„œ ?•íƒœë¡?ì¶œë ¥\n' +
          '2) head??CSS ?¤í????¬í•¨\n' +
          '3) ?œëª©, ëª©ì°¨, ë³¸ë¬¸ ?¹ì…˜?¼ë¡œ êµ¬ì„±\n' +
          '4) ?œêµ­?????œì? ì¤€??n' +
          '5) ?¸ì‡„ ê°€?¥í•œ ?•íƒœ\n' +
          '6) ë¬¸ì²´???„ë¬¸?ì´ê³??•ì¤‘??"~?µë‹ˆ?? ?•ì‹?¼ë¡œ ?µì¼\n\n' +
          '?¤ì§ HTML ì½”ë“œë§?ì¶œë ¥?˜ê³  ?¤ë¥¸ ?¤ëª…?€ ?¬í•¨?˜ì? ë§ˆì„¸??';

        // OpenAI API ?¸ì¶œ (ê¸°ì¡´ ë°©ì‹ ? ì? - gpt-4o-mini ?¬ìš©)
        // ?”’ ë³´ì•ˆ: getOpenAIAuthHeaders ?œê±°??- callOpenAI ?¨ìˆ˜ ?¬ìš©

        // ?”’ ?ˆì „??OpenAI ?„ë¡???¸ì¶œë¡?ë³€ê²½ë¨
        const systemPrompt = '?ˆëŠ” HTML ë§ˆí¬???„ë¬¸ê°€?´ë‹¤. ì£¼ì–´ì§??ìŠ¤?¸ë? ?„ì „??HTML5 ë¬¸ì„œë¡?ë³€?˜í•œ?? ?¤ì§ HTML ì½”ë“œë§?ì¶œë ¥?˜ê³  ?¤ë¥¸ ?¤ëª…?€ ?¼ì ˆ ?¬í•¨?˜ì? ?ŠëŠ”??';
        const htmlCode = await callOpenAI(systemPrompt, htmlPrompt);
        
        // ê¸°ì¡´ fetch ì½”ë“œ ?œê±°??
        /*const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: '?ˆëŠ” HTML ë§ˆí¬???„ë¬¸ê°€?´ë‹¤. ì£¼ì–´ì§??ìŠ¤?¸ë? ?„ì „??HTML5 ë¬¸ì„œë¡?ë³€?˜í•œ?? ?¤ì§ HTML ì½”ë“œë§?ì¶œë ¥?˜ê³  ?¤ë¥¸ ?¤ëª…?€ ?¼ì ˆ ?¬í•¨?˜ì? ?ŠëŠ”??'
              },
              {
                role: 'user',
                content: htmlPrompt
              }
            ],
            max_tokens: 16000,
            temperature: 0.1
          })
        });*/

        // ê¸°ì¡´ ?‘ë‹µ ì²˜ë¦¬ ì½”ë“œ ?œê±°??- callOpenAIê°€ ì²˜ë¦¬
        /*if (!response.ok) {
          throw new Error(`OpenAI API ?¤ë¥˜: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const htmlCode = data.choices[0]?.message?.content?.trim();*/

        if (!htmlCode) {
          throw new Error('HTML ?ì„± ê²°ê³¼ê°€ ë¹„ì–´?ˆìŠµ?ˆë‹¤.');
        }

        // ?ì„±??HTML ?€??ë°??œì‹œ
        generatedHTMLCode = htmlCode;
        window.reportState.isGenerated = true;
        window.reportState.htmlContent = htmlCode;

                // ?”¸ ì¶”ê?: ?íƒœ ?ì†??
        try {
          localStorage.setItem('generatedHTMLCode', htmlCode);
          localStorage.setItem('reportState', JSON.stringify({ isGenerated: true }));
        } catch (e) {
          console.warn('ë³´ê³ ???€???ëµ(?©ëŸ‰ ì´ˆê³¼):', e);
        }
        
        const previewDiv = document.getElementById('html-preview');
        previewDiv.textContent = htmlCode;

        statusDiv.textContent = 'HTML ë³´ê³ ???ì„± ?„ë£Œ!';
        statusDiv.style.backgroundColor = '#d4edda';
        
        // ë²„íŠ¼ ?íƒœ ë³€ê²?
        if (htmlBtn) {
          htmlBtn.textContent = 'ë³´ê³ ?œë³´ê¸?;
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          // ë°•ìŠ¤ ?¤í??¼ë¡œ ë³€ê²?
          htmlBtn.style.width = '100%';
          htmlBtn.style.padding = '8px 12px';
          htmlBtn.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
          htmlBtn.style.color = 'white';
          htmlBtn.style.fontWeight = '600';
          htmlBtn.style.border = 'none';
          htmlBtn.style.borderRadius = '6px';
        }
        statusDiv.style.color = '#155724';

        // 5ì´????íƒœ ë©”ì‹œì§€ ?¨ê¸°ê¸?
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 5000);

      } catch (error) {
        console.error('HTML ?ì„± ?¤ë¥˜:', error);
        const statusDiv = document.getElementById('html-status');
        statusDiv.textContent = `HTML ?ì„± ?¤íŒ¨: ${error.message}`;
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
        
        if (typeof showToast === 'function') {
          showToast(`HTML ?ì„± ?¤íŒ¨: ${error.message}`, 'error');
        } else {
          alert(`HTML ?ì„± ?¤íŒ¨: ${error.message}`);
        }
      } finally {
        const htmlBtn = document.getElementById('btn-export-html');
        if (htmlBtn) {
          htmlBtn.disabled = false;
          htmlBtn.classList.remove('report-progress');
          htmlBtn.classList.remove('blink-text');
          // ?íƒœ???°ë¼ ?ìŠ¤???¤ì •
          if (!window.reportState.isGenerated) {
            htmlBtn.textContent = 'ë³´ê³ ?œì‘??;
            // ë°•ìŠ¤ ?¤í??¼ë¡œ ë³€ê²?
            htmlBtn.style.width = '100%';
            htmlBtn.style.padding = '8px 12px';
            htmlBtn.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
            htmlBtn.style.color = 'white';
            htmlBtn.style.fontWeight = '600';
            htmlBtn.style.border = 'none';
            htmlBtn.style.borderRadius = '6px';
          }
        }
      }
    }

    function getCurrentScenarioTitle() {
      // ?„ì¬ ? íƒ???œë‚˜ë¦¬ì˜¤ ë²ˆí˜¸ë¡œë????œëª© ?ì„±
      const scenario = document.getElementById('scenario-number')?.value || '1';
      return `?œë‚˜ë¦¬ì˜¤ ${scenario} ë¦¬ìŠ¤??ë¶„ì„ ë³´ê³ ??;
    }

    function closeHTMLModal() {
      const modal = document.getElementById('html-modal');
      modal?.classList.remove('show');
    }

    // ?ì—… ?†ì´ ë°”ë¡œ ?¤ìš´ë¡œë“œ?˜ëŠ” ?¨ìˆ˜
    function downloadHTMLDirect(htmlCode, title, dateString) {
      try {
        const blob = new Blob([htmlCode], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `?œë‚˜ë¦¬ì˜¤_${getCurrentScenarioNumber()}_ë¦¬ìŠ¤?¬ë¶„?ë³´ê³ ì„œ_${getCurrentDateString()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        if (typeof showToast === 'function') {
          showToast('HTML ë³´ê³ ?œê? ?ì„±?˜ê³  ?¤ìš´ë¡œë“œ?˜ì—ˆ?µë‹ˆ??', 'success');
        } else {
          alert('HTML ë³´ê³ ?œê? ?ì„±?˜ê³  ?¤ìš´ë¡œë“œ?˜ì—ˆ?µë‹ˆ??');
        }
      } catch (error) {
        console.error('HTML ?¤ìš´ë¡œë“œ ?¤íŒ¨:', error);
        alert('HTML ?¤ìš´ë¡œë“œ ?¤íŒ¨: ' + error.message);
      }
    }

    function downloadHTML() {
      if (!generatedHTMLCode) {
        alert('ë¨¼ì? HTML???ì„±?´ì£¼?¸ìš”.');
        return;
      }

      const blob = new Blob([generatedHTMLCode], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `?œë‚˜ë¦¬ì˜¤_${getCurrentScenarioNumber()}_ë¦¬ìŠ¤?¬ë¶„?ë³´ê³ ì„œ_${getCurrentDateString()}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      if (typeof showToast === 'function') {
        showToast('HTML ?Œì¼???¤ìš´ë¡œë“œ?˜ì—ˆ?µë‹ˆ??', 'success');
      }
    }

    function copyHTMLCode() {
      if (!generatedHTMLCode) {
        alert('ë¨¼ì? HTML???ì„±?´ì£¼?¸ìš”.');
        return;
      }

      navigator.clipboard.writeText(generatedHTMLCode).then(() => {
        if (typeof showToast === 'function') {
          showToast('HTML ì½”ë“œê°€ ?´ë¦½ë³´ë“œ??ë³µì‚¬?˜ì—ˆ?µë‹ˆ??', 'success');
        } else {
          alert('HTML ì½”ë“œê°€ ?´ë¦½ë³´ë“œ??ë³µì‚¬?˜ì—ˆ?µë‹ˆ??');
        }
      }).catch(err => {
        console.error('?´ë¦½ë³´ë“œ ë³µì‚¬ ?¤íŒ¨:', err);
        // ?´ë°±: ?ìŠ¤??? íƒ
        const previewDiv = document.getElementById('html-preview');
        const range = document.createRange();
        range.selectNodeContents(previewDiv);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        alert('HTML ì½”ë“œë¥?? íƒ?ˆìŠµ?ˆë‹¤. Ctrl+Cë¡?ë³µì‚¬?˜ì„¸??');
      });
    }

    function previewHTML() {
      if (!generatedHTMLCode) {
        alert('ë¨¼ì? HTML???ì„±?´ì£¼?¸ìš”.');
        return;
      }

      // ??ì°½ì—??HTML ë¯¸ë¦¬ë³´ê¸°
      const previewWindow = window.open('', '_blank');
      previewWindow.document.open();
      previewWindow.document.write(generatedHTMLCode);
      previewWindow.document.close();
    }

    // ?ì„±ê³??™ì‹œ???ˆì°½?ì„œ ë³´ì—¬ì£¼ëŠ” ?¨ìˆ˜
    function previewHTMLDirect(htmlCode) {
      try {
        // ??ì°½ì—??HTML ë°”ë¡œ ë³´ê¸°
        const previewWindow = window.open('', '_blank');
        if (previewWindow) {
          previewWindow.document.open();
          previewWindow.document.write(htmlCode);
          previewWindow.document.close();
          
          if (typeof showToast === 'function') {
            showToast('ë³´ê³ ?œê? ?ˆì°½?ì„œ ?´ë ¸?µë‹ˆ??', 'success');
          } else {
            alert('ë³´ê³ ?œê? ?ˆì°½?ì„œ ?´ë ¸?µë‹ˆ??');
          }
        } else {
          // ?ì—…??ì°¨ë‹¨??ê²½ìš° ?€ì²?ë°©ë²•
          if (typeof showToast === 'function') {
            showToast('?ì—…??ì°¨ë‹¨?˜ì—ˆ?µë‹ˆ?? ë¸Œë¼?°ì????ì—… ì°¨ë‹¨???´ì œ?´ì£¼?¸ìš”.', 'warning');
          } else {
            alert('?ì—…??ì°¨ë‹¨?˜ì—ˆ?µë‹ˆ?? ë¸Œë¼?°ì????ì—… ì°¨ë‹¨???´ì œ?´ì£¼?¸ìš”.');
          }
        }
      } catch (error) {
        console.error('HTML ë¯¸ë¦¬ë³´ê¸° ?¤íŒ¨:', error);
        alert('HTML ë¯¸ë¦¬ë³´ê¸° ?¤íŒ¨: ' + error.message);
      }
    }

    function getCurrentScenarioNumber() {
      return document.getElementById('scenario-number')?.value || '1';
    }

    function getCurrentDateString() {
      const today = new Date();
      return today.getFullYear() + 
             String(today.getMonth() + 1).padStart(2, '0') + 
             String(today.getDate()).padStart(2, '0');
    }

    // HTML ëª¨ë‹¬ ?´ë¦­ ?´ë²¤??(ëª¨ë‹¬ ë°”ê¹¥ ?´ë¦­???«ê¸°)
    document.addEventListener('DOMContentLoaded', function() {
      const htmlModal = document.getElementById('html-modal');
      if (htmlModal) {
        htmlModal.addEventListener('click', function(event) {
          if (event.target === htmlModal) {
            closeHTMLModal();
          }
        });
      }
      
      // ?˜ì´ì§€ ì´ˆê¸°??
      initializePage();
    });

  </script>
  
  <!-- ?˜ì •???„ì—­ ?¨ìˆ˜??-->
  <script src="fixed_functions.js"></script>
  
  <!-- ?Œì´?„ë¼???¸ë¼???¤í¬ë¦½íŠ¸ -->
  <script id="pipeline-inline">
// ?„ë˜ ?¤í¬ë¦½íŠ¸ë¥?<script id="pipeline-inline">??/script> ?ˆì— ê·¸ë?ë¡?ë¶™ì—¬?£ê¸°

(function () {
  'use strict';

  /* ===== ?¤í–‰ ë²„íŠ¼ ?ìƒ‰ ===== */
  let _topRunBtn = null;
  function getTopRunBtn() {
    if (_topRunBtn && document.body.contains(_topRunBtn)) return _topRunBtn;
    _topRunBtn =
      document.querySelector('#top-pipeline-btn') ||
      document.querySelector('#run-pipeline-btn') ||
      document.querySelector('#analyze-start-btn') ||
      document.querySelector('button[data-action="run-pipeline"]') ||
      document.querySelector('button#analyze-start') ||
      document.querySelector('button.top-run');
    return _topRunBtn;
  }
  function setTopButtonState(state, label) {
    const btn = getTopRunBtn();
    if (!btn) return;
    const txt = String(label || '').trim();
    if (state === 'idle') {
      btn.disabled = false; btn.removeAttribute('aria-busy'); if (txt) btn.textContent = txt;
    } else if (state === 'running') {
      btn.disabled = true; btn.setAttribute('aria-busy','true'); if (txt) btn.textContent = txt;
    } else if (state === 'report') {
      btn.disabled = false; btn.removeAttribute('aria-busy'); btn.textContent = 'ë³´ê³ ???‘ì„±';
    } else if (state === 'retry') {
      btn.disabled = false; btn.removeAttribute('aria-busy'); btn.textContent = '?¤ì‹œ ?¤í–‰';
    }
  }
  function showStatus(message) {
    // ê¸°ì¡´ showStatusê°€ ?ˆìœ¼ë©?ê·¸ë?ë¡??¬ìš©
    if (typeof window.showStatus === 'function') return window.showStatus(message);
    const el = document.querySelector('#send-status') || document.querySelector('.status');
    if (el) el.textContent = String(message || '');
  }

  /* ===== ê³µìš© ?€?‰í„° ? í‹¸ ===== */
  function getCardEl(id) {
    return (
      document.querySelector(`#card-${id}`) ||
      document.querySelector(`[data-card="${id}"]`) ||
      document.querySelector(`.${id}-module-box`) ||
      null
    );
  }
  function getLineEl(id) {
    return (
      document.querySelector(`.pipeline-line.to-${id}`) ||
      document.querySelector(`[data-to="${id}"]`) ||
      null
    );
  }

  /* ===== ?¨ê³¼ ?€?„ë¼?? ??flow)+ë°•ìŠ¤(active) 1ë¶„ì”© ?œì°¨ ===== */
  const Effects = {
    order: ['gpt0','gpt1','gpt2','gpt3','gpt4'],
    durMs: 60000, // 1ë¶?
    timers: [],
    running: false,

    start({ order, durationMs } = {}) {
      this.stop();
      if (Array.isArray(order) && order.length) this.order = order.slice();
      if (typeof durationMs === 'number' && durationMs > 0) this.durMs = durationMs;

      this.running = true;
      let acc = 0;

      this.order.forEach((id, idx) => {
        const tStart = setTimeout(() => {
          if (!this.running) return;
          if (idx > 0) this._stopOne(this.order[idx-1]);
          this._startOne(id);
        }, acc);
        this.timers.push(tStart);
        acc += this.durMs;

        const tEnd = setTimeout(() => {
          if (!this.running) return;
          this._stopOne(id);
        }, acc);
        this.timers.push(tEnd);
      });

      const tAllEnd = setTimeout(() => this.stop(), acc + 10);
      this.timers.push(tAllEnd);
    },

    stop() {
      this.running = false;
      this.timers.forEach(t => clearTimeout(t));
      this.timers = [];
      this._stopAll();
    },

    _startOne(id) {
      const card = getCardEl(id);
      if (card) card.classList.add('active');

      // D3ê°€ ?ˆìœ¼ë©?D3ë¡? ?†ìœ¼ë©?DOM classë¡??´ë°±
      const line = getLineEl(id);
      if (window.d3 && typeof d3.selectAll === 'function') {
        try {
          d3.selectAll('.pipeline-line').classed('flow', false);
          if (line) d3.select(line).classed('flow', true);
        } catch(e) { if (line) line.classList.add('flow'); }
      } else {
        // ?„ì§ ? ì´ ?™ì ?¼ë¡œ ?ì„± ?ˆë?????ˆìœ¼ë¯€ë¡? ?¬ì‹œ??ë£¨í”„(ìµœë? 3ì´?
        if (line) {
          line.classList.add('flow');
        } else {
          let tries = 0;
          const interval = setInterval(() => {
            const l = getLineEl(id);
            if (l) { l.classList.add('flow'); clearInterval(interval); }
            if (++tries > 30) clearInterval(interval);
          }, 100);
        }
      }
    },

    _stopOne(id) {
      const card = getCardEl(id);
      if (card) card.classList.remove('active');
      const line = getLineEl(id);
      if (window.d3 && typeof d3.selectAll === 'function') {
        try { d3.selectAll('.pipeline-line').classed('flow', false); }
        catch(e) { if (line) line.classList.remove('flow'); }
      } else {
        if (line) line.classList.remove('flow');
      }
    },

    _stopAll() {
      ['gpt0','gpt1','gpt2','gpt3','gpt4'].forEach(id => this._stopOne(id));
    }
  };

  /* ===== ?Œì´?„ë¼???¤í–‰(?¨ê³¼?€ ?„ì „ ë¶„ë¦¬) ===== */
  async function startPipelineWithEffects() {
    Effects.start({ durationMs: 60000 }); // ?„ìš” ??60000 ??20000 ?±ìœ¼ë¡?ì¡°ì ˆ

    try {
      setTopButtonState('running','1/4?¨ê³„: gpt0 ?¤í–‰');

      if (typeof window.executePipelineSteps === 'function') {
        await window.executePipelineSteps((step, desc) => {
          showStatus(`?“Š ${step}/4?¨ê³„: ${desc}`);
          setTopButtonState('running', `${step}/4?¨ê³„: ${desc}`);
        });
      } else {
        // ?´ë°±(?¤í–‰ê¸??†ì„ ??ê°„ë‹¨ ?€?„ë¼?¸ë§Œ ì§„í–‰)
        showStatus('?“Š 2/4?¨ê³„: gpt1 ?¤í–‰'); await new Promise(r=>setTimeout(r,1200));
        showStatus('?“Š 3/4?¨ê³„: gpt2 ?¤í–‰'); await new Promise(r=>setTimeout(r,1200));
        showStatus('?“Š 4/4?¨ê³„: gpt3 ?¤í–‰'); await new Promise(r=>setTimeout(r,1200));
      }

      setTopButtonState('report');
      showStatus('?‰ ë¶„ì„ ?„ë£Œ! "ë³´ê³ ???‘ì„±" ë²„íŠ¼?¼ë¡œ ê²°ê³¼ë¥??ì„±?˜ì„¸??');
    } catch (err) {
      console.error('???Œì´?„ë¼???¤í–‰ ?¤ë¥˜:', err);
      setTopButtonState('retry');
      showStatus(`???¤ë¥˜: ${err.message || err}`);
    } finally {
      Effects.stop();
    }
  }

  /* ===== ì´ˆê¸° ë°”ì¸??===== */
  document.addEventListener('DOMContentLoaded', () => {
    setTopButtonState('idle','ë¶„ì„ ?œì‘');
    const btn = getTopRunBtn();
    if (btn) {
      btn.removeAttribute('onclick');
      btn.addEventListener('click', () => startPipelineWithEffects());
    }
    // ?¸ë??ì„œ ?œì–´?????ˆë„ë¡??¸ì¶œ
    window.startPipelineWithEffects = startPipelineWithEffects;
    window.pipelineEffects = Effects;
  });
})();
  </script>
  
  <!-- [PATCH] GPT4 ?„ë£Œ ???¤ë¥¸ìª????„ì²´ ë°•ìŠ¤ ?„ê°œ ? í‹¸ -->
  <!-- [PATCH] ?„ë£Œ ?µí•© ?¸ë“¤?? ê¹œë°•???„ì „ ì¢…ë£Œ + ?„ì²´ ë°•ìŠ¤ ?„ê°œ -->
  <script id="patch-unified-done-handler">
(function(){
  /* ?¤ë¥¸ìª??¨ë„ ë£¨íŠ¸ ?ìƒ‰(?„ë½ ë°©ì?: #gpt1-panel ?¬í•¨) */
  function getRightPanelRoot() {
    return (
      document.querySelector('.right-tab-panel') ||
      document.querySelector('#gpt1-panel') ||
      document.querySelector('#gpt-right-panel') ||
      document.querySelector('.right-tab') ||
      document.querySelector('[data-panel="right"]') ||
      document.querySelector('#gpt-panels') ||
      (document.querySelector('#gpt3-panel') && document.querySelector('#gpt3-panel').closest('.tab-content')) ||
      document.body
    );
  }

  /* 1) ëª¨ë“  ì§„í–‰/ê¹œë°•???¤ë²„?ˆì´ ?œê±° */
  function stopAllPipelineEffects() {
    const removeClasses = ['running','active','done','blink','shimmer','loading','animate-pulse','status-shine'];
    document.querySelectorAll('.running, .active, .done, .blink, .shimmer, .loading, .animate-pulse, .status-shine')
      .forEach(el => removeClasses.forEach(c => el.classList.remove(c)));
    document.querySelectorAll('.progress-indicator, .execution-overlay, .progress, .progress-bar, .skeleton, .spinner')
      .forEach(el => { try { el.remove(); } catch(e) { el.style.display = 'none'; } });

    // GPT3 ëª¨ë“ˆë³?ë°•ìŠ¤ ?¨ê³¼ ?„ì „ ?œê±°
    document.querySelectorAll('.gpt3-module-box.running, .gpt0-module-box.running, .gpt1-module-box.running, .gpt2-module-box.running, .gpt4-module-box.running')
      .forEach(el => el.classList.remove('running'));

    // ?¸ë¼??? ë‹ˆë©”ì´?˜ë„ ê°•ì œ ì¢…ë£Œ
    document.querySelectorAll('*').forEach(el => {
      if (el.style && (el.style.animation || el.style.webkitAnimation)) {
        el.style.animation = 'none';
        el.style.webkitAnimation = 'none';
      }
    });

    // ?íƒœ ?ìŠ¤??ë°˜ì§???´ì œ
    const status = document.querySelector('#send-status, .send-status, [data-role="status"]');
    if (status) status.classList.remove('status-shine');
  }

  /* 2) ?¤ë¥¸ìª????„ì²´ ë°•ìŠ¤ ?„ê°œ */
  function showAllRightBoxes() {
    const root = getRightPanelRoot();
    if (root) root.classList.add('show-all');

    // ?°ì¸¡ ?¨ë„ ?„ë³´?¤ì„ ëª¨ë‘ ?€?ìœ¼ë¡??™ì‹œ ë³´ê°•
    const panels = [
      document.querySelector('#gpt1-panel'),
      document.querySelector('.right-tab-panel'),
      document.querySelector('#gpt-right-panel'),
      document.querySelector('#right-tab'),
      document.querySelector('aside#right-panel'),
      document.querySelector('[data-panel="right"]')
    ].filter(Boolean);

    panels.forEach(p => { p.classList.remove('solo-mode','gpt2worst-mode'); p.classList.add('show-all'); });

    const selectors = [
      '.gpt-box','.agent-card','.panel-box','.module-card','[data-role="box"]'
    ].join(',');

    // ?¨ê?/?‘í˜/?¬ëª… ?œê±°
    document.querySelectorAll(selectors).forEach(el => {
      el.classList.remove('hidden','collapse','collapsed','invisible','opacity-0');
      el.style.display = '';
      el.style.opacity = '';
      el.style.visibility = '';
      el.style.maxHeight = '';
      el.style.height = '';
      el.setAttribute('aria-hidden','false');
    });

    // GPT0~GPT4ê¹Œì? ëª¨ë“  ì¹´ë“œ ëª…ì‹œ?ìœ¼ë¡??œì‹œ
    const cardIds = [
      'card-gpt0-marketdata', 'card-gpt0-news', 'card-gpt0-scenario-summary', 'card-gpt0-marketstate',
      'card-gpt1', 'card-gpt2', 
      'card-gpt3-market', 'card-gpt3-credit', 'card-gpt3-alm', 'card-gpt3-global', 'card-gpt3-creditpf',
      'card-gpt4'
    ];
    
    cardIds.forEach(id => {
      const card = document.getElementById(id);
      if (card) {
        card.style.display = 'block';
        card.classList.remove('hidden', 'collapse', 'collapsed', 'invisible');
        card.setAttribute('aria-hidden', 'false');
        console.log(`???„ë£Œ ??${id} ?œì‹œ??);
      }
    });

    // ?„ì½”?”ì–¸/? ê? ?„ê°œ
    document.querySelectorAll('details').forEach(d => d.open = true);
    document.querySelectorAll('[aria-expanded="false"]').forEach(t => t.setAttribute('aria-expanded','true'));

    // ?¤í¬ë¡??ë‹¨?¼ë¡œ
    const scroller = root.querySelector('.scrollable, .tab-scroll, #gpt4-panel, #gpt3-panel, #gpt2-panel, #gpt1-panel') || root;
    if (scroller && typeof scroller.scrollTo === 'function') {
      scroller.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  /* 3) ?„ë£Œ ??ê³µí†µ ì²˜ë¦¬ (ë©±ë“±) */
  function onPipelineDone() {
    // ?´ë? ì²˜ë¦¬??ê²½ìš°?ë„ ?”ì—¬ ?¨ê³¼/?´ë˜???•ë¦¬ë¥?1?????˜í–‰
    stopAllPipelineEffects();

    // ?°ì¸¡ ?¨ë„ ?„ë³´ ?„ë????€??solo-mode ?´ì œ + show-all ë¶€???ˆì´??ë°©ì?)
    const panels = [
      document.querySelector('#gpt1-panel'),
      document.querySelector('.right-tab-panel'),
      document.querySelector('#gpt-right-panel'),
      document.querySelector('#right-tab'),
      document.querySelector('aside#right-panel'),
      document.querySelector('[data-panel="right"]')
    ].filter(Boolean);

    panels.forEach(p => { p.classList.remove('solo-mode','gpt2worst-mode'); p.classList.add('show-all'); });

    // ?”ì—¬ ?¤ë²„?ˆì´/?¤í–‰ ?´ë˜???œê±°(ë³´ìˆ˜??ì¤‘ë³µ ?˜í–‰)
    document.querySelectorAll('.execution-overlay').forEach(el => el.remove());
    document.querySelectorAll('.agent-card.running, .agent-card.active')
      .forEach(el => el.classList.remove('running','active'));

    document.body.classList.add('pipeline-complete');
    showAllRightBoxes();

    // ?„ìš” ??GPT4 ?µì»¤ë¡??¤í¬ë¡?? ì?
    window.scrollAnchorIntoView?.('.gpt4-anchor');

    // GPT3 ?ìŠ¤???ì—­ ?ë™ ?•ì¥
    ['gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf'].forEach(id => {
      const ta = document.getElementById(id);
      if (ta) { ta.style.height = 'auto'; ta.style.height = ta.scrollHeight + 'px'; }
    });
  }

  /* 4) ?´ë²¤??ë°”ì¸?? ?„ë£Œ ?´ë²¤?¸ë? ?¨ì¼ ì²˜ë¦¬ë¡??µí•© */
  // ?„ë£Œ ?´ë²¤?¸ëŠ” ëª¨ë‘ ê°™ì? ?¸ë“¤?¬ë¡œ ì²˜ë¦¬(ì¤‘ë³µ ?ˆì „)
  ['gpt4:done','gpt4:complete','pipeline:done'].forEach(evt => {
    window.addEventListener(evt, onPipelineDone, { once: false });
  });

  // gpt4:completeë§??˜ì˜¤???˜ê²½???„í•´ done ë¸Œë¦¿ì§€ ë³´ì¥
  window.addEventListener('gpt4:complete', () => {
    try { window.dispatchEvent(new Event('gpt4:done')); } catch(e) {}
  });

  /* 6) ?´ë°±: ë³´ê³ ??DOM ?ì„± ê°ì? ?œì—???„ë£Œ ì²˜ë¦¬ 1??ê°•ì œ */
  function isReportReady() {
    return !!document.querySelector('#final-report, [data-role="report"], #gpt4-report');
  }
  const mo = new MutationObserver(() => {
    if (isReportReady()) {
      onPipelineDone();
      mo.disconnect();
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
    mo.observe(document.body, { childList: true, subtree: true });
    if (isReportReady()) { onPipelineDone(); mo.disconnect(); }
  });

  /* 7) ?¸ë??ì„œ ?˜ë™ ?¸ì¶œ ê°€?¥í•˜?„ë¡ ?¸ì¶œ(?”ë²„ê·??˜ë™ ?¸ë¦¬ê±°ìš©) */
  window.__forcePipelineDone = onPipelineDone;
  
  /* 8) revealAllRightTabBoxes ?¨ìˆ˜ë¥?window???¸ì¶œ (?¸í™˜?? */
  window.revealAllRightTabBoxes = function() {
    console.log('?”“ revealAllRightTabBoxes ?¸ì¶œ??- GPT0~GPT4 ?„ì²´ ë°•ìŠ¤ ?œì‹œ');
    
    // solo-mode ?œê±° ë°?show-all ì¶”ê?
    const panels = [
      document.querySelector('#gpt1-panel'),
      document.querySelector('.right-tab-panel'),
      document.querySelector('#gpt-right-panel'),
      document.querySelector('#right-tab'),
      document.querySelector('aside#right-panel'),
      document.querySelector('[data-panel="right"]')
    ].filter(Boolean);
    
    panels.forEach(p => {
      p.classList.remove('solo-mode','gpt2worst-mode');
      p.classList.add('show-all');
    });
    
    // ëª¨ë“  agent-card?€ ê´€??ë°•ìŠ¤ ?œì‹œ
    const allCards = document.querySelectorAll('.agent-card, .gpt-box, .panel-box, .module-card, [data-role="box"]');
    allCards.forEach(card => {
      card.style.display = '';
      card.classList.remove('hidden', 'collapse', 'collapsed', 'invisible');
      card.setAttribute('aria-hidden', 'false');
    });
    
    // GPT0~GPT4ê¹Œì? ëª¨ë“  ì¹´ë“œ ëª…ì‹œ?ìœ¼ë¡??œì‹œ
    const cardIds = [
      'card-gpt0-marketdata', 'card-gpt0-news', 'card-gpt0-scenario-summary', 'card-gpt0-marketstate',
      'card-gpt1', 'card-gpt2', 
      'card-gpt3-market', 'card-gpt3-credit', 'card-gpt3-alm', 'card-gpt3-global', 'card-gpt3-creditpf',
      'card-gpt4'
    ];
    
    cardIds.forEach(id => {
      const card = document.getElementById(id);
      if (card) {
        card.style.display = 'block';
        card.classList.remove('hidden');
        console.log(`??${id} ?œì‹œ??);
      }
    });
    
    document.body.classList.add('pipeline-complete');
    
    console.log('???„ì²´ ë°•ìŠ¤ ?œì‹œ ?„ë£Œ');
  };
})();

  // ë§ˆí¬?¤ìš´??HTMLë¡?ë³€?˜í•˜???¨ìˆ˜
  function convertMarkdownToHtml(markdown) {
    if (!markdown) return '';
    
    let html = markdown;
    
    // HTML ?¹ìˆ˜ë¬¸ì ?´ìŠ¤ì¼€?´í”„ (ë¨¼ì? ì²˜ë¦¬)
    html = html.replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;');
    
    // ?œëª© ë³€??(####, ###, ##, # ?œì„œë¡?ì²˜ë¦¬)
    html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
    html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
    html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
    
    // êµµê²Œ + ?´íƒ¤ë¦? ***?ìŠ¤??** ?ëŠ” ___?ìŠ¤??__
    html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\_\_\_(.*?)\_\_\_/g, '<strong><em>$1</em></strong>');
    
    // êµµê²Œ: **?ìŠ¤??* ?ëŠ” __?ìŠ¤??_
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\_\_(.*?)\_\_/g, '<strong>$1</strong>');
    
    // ?´íƒ¤ë¦? *?ìŠ¤?? ?ëŠ” _?ìŠ¤??
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    html = html.replace(/\_(.*?)\_/g, '<em>$1</em>');
    
    // ì½”ë“œ ë¸”ë¡: ```ì½”ë“œ```
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    
    // ?¸ë¼??ì½”ë“œ: `ì½”ë“œ`
    html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
    
    // ë§í¬: [?ìŠ¤??(URL)
    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // ?´ë?ì§€: ![alt](URL)
    html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">');
    
    // ?˜í‰?? --- ?ëŠ” ***
    html = html.replace(/^---$/gim, '<hr>');
    html = html.replace(/^\*\*\*$/gim, '<hr>');
    
    // ë¦¬ìŠ¤??ì²˜ë¦¬ (ê°œì„ ??ë²„ì „)
    const lines = html.split('\n');
    const result = [];
    let inList = false;
    let listType = null;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const unorderedMatch = line.match(/^[\s]*[-*+]\s+(.+)$/);
      const orderedMatch = line.match(/^[\s]*\d+\.\s+(.+)$/);
      
      if (unorderedMatch) {
        if (!inList || listType !== 'ul') {
          if (inList) result.push(`</${listType}>`);
          result.push('<ul>');
          listType = 'ul';
          inList = true;
        }
        result.push(`<li>${unorderedMatch[1]}</li>`);
      } else if (orderedMatch) {
        if (!inList || listType !== 'ol') {
          if (inList) result.push(`</${listType}>`);
          result.push('<ol>');
          listType = 'ol';
          inList = true;
        }
        result.push(`<li>${orderedMatch[1]}</li>`);
      } else {
        if (inList) {
          result.push(`</${listType}>`);
          inList = false;
          listType = null;
        }
        result.push(line);
      }
    }
    
    if (inList) {
      result.push(`</${listType}>`);
    }
    
    html = result.join('\n');
    
    // ì¤„ë°”ê¿?ì²˜ë¦¬: ??ê°??´ìƒ??ì¤„ë°”ê¿ˆì? ?¨ë½?¼ë¡œ, ?˜ë‚˜??<br>ë¡?
    html = html.replace(/\n\n+/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    html = '<p>' + html + '</p>';
    
    // ë¹??¨ë½ ?œê±°
    html = html.replace(/<p><\/p>/g, '');
    html = html.replace(/<p><br><\/p>/g, '');
    
    return html;
  }

  // ë³´ê³ ?œì‘??ë²„íŠ¼ ?´ë¦­ ?´ë²¤??
  function showHtmlReport() {
    // gpt4 ì¶œë ¥ ?´ìš© ê°€?¸ì˜¤ê¸?(textarea?´ë?ë¡?value ?¬ìš©)
    let gpt4Content = document.querySelector("#gpt4-output")?.value || "";
    
    // ?´ìš©??ë¹„ì–´?ˆê±°??placeholderë§??ˆëŠ” ê²½ìš° ì²˜ë¦¬
    if (!gpt4Content.trim() || gpt4Content.includes("GPT4 ìµœì¢… ë¶„ì„ ê²°ê³¼ê°€ ?¬ê¸°???œì‹œ?©ë‹ˆ??)) {
      gpt4Content = "? ï¸ ë³´ê³ ???´ìš©???„ì§ ?ì„±?˜ì? ?Šì•˜?µë‹ˆ??\n\n" +
                   "?¤ìŒ ?¨ê³„ë¥??•ì¸?´ì£¼?¸ìš”:\n" +
                   "1. ?Œì´?„ë¼?¸ì´ ?„ë£Œ?˜ì—ˆ?”ì? ?•ì¸\n" +
                   "2. GPT4 ?¨ê³„ê°€ ?•ìƒ?ìœ¼ë¡??¤í–‰?˜ì—ˆ?”ì? ?•ì¸\n" +
                   "3. GPT4 ì¶œë ¥ ê²°ê³¼???´ìš©???ˆëŠ”ì§€ ?•ì¸\n\n" +
                   "ë¬¸ì œê°€ ì§€?ë˜ë©??Œì´?„ë¼?¸ì„ ?¤ì‹œ ?¤í–‰?´ì£¼?¸ìš”.";
    }

    // ë§ˆí¬?¤ìš´??HTMLë¡?ë³€??
    const htmlContent = convertMarkdownToHtml(gpt4Content);

    // HTML ?¬ë§· êµ¬ì„±
    const htmlReport = `
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <title>GPT4 ë³´ê³ ??/title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: 'Segoe UI', 'Malgun Gothic', Arial, sans-serif; 
            padding: 15px; 
            line-height: 1.5; 
            max-width: 1200px; 
            margin: 0 auto;
            background-color: #f8f9fa;
            color: #333;
          }
          .report-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          }
          h1 { 
            color: #2c3e50; 
            border-bottom: 3px solid #3498db;
            padding-bottom: 8px;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            line-height: 1.3;
          }
          h2 { 
            color: #34495e; 
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #ecf0f1;
            font-size: 1.4em;
            line-height: 1.3;
          }
          h3 { 
            color: #34495e; 
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.2em;
            line-height: 1.3;
          }
          h4 { 
            color: #34495e; 
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 1.1em;
            line-height: 1.3;
          }
          p { 
            margin-top: 0;
            margin-bottom: 8px; 
            line-height: 1.6;
          }
          .content {
            font-family: inherit;
            line-height: 1.6;
          }
          strong {
            font-weight: 700;
            color: #2c3e50;
          }
          em {
            font-style: italic;
            color: #7f8c8d;
          }
          code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #c7254e;
          }
          pre {
            background-color: #f4f4f4;
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
            margin: 10px 0;
          }
          pre code {
            background: none;
            padding: 0;
            color: #333;
          }
          ul, ol {
            margin: 10px 0;
            padding-left: 25px;
          }
          li {
            margin: 4px 0;
            line-height: 1.5;
          }
          hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 20px 0;
          }
          a {
            color: #3498db;
            text-decoration: none;
          }
          a:hover {
            text-decoration: underline;
          }
          .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
          }
          .metric {
            font-weight: bold;
            color: #e74c3c;
          }
          .positive { color: #27ae60; }
          .negative { color: #e74c3c; }
          
          /* ?”¥ ëª¨ë°”??ìµœì ?? ?°íŠ¸ ?¬ê¸° ì¶•ì†Œ */
          @media (max-width: 768px) {
            body {
              padding: 8px;
              font-size: 12px; /* 14px ??12px */
            }
            .report-container {
              padding: 12px; /* 15px ??12px */
              border-radius: 4px;
            }
            h1 {
              font-size: 1.3em; /* 1.5em ??1.3em */
              margin-bottom: 10px;
              padding-bottom: 5px;
            }
            h2 {
              font-size: 1.15em; /* 1.3em ??1.15em */
              margin-top: 12px;
              margin-bottom: 6px;
              padding-bottom: 3px;
            }
            h3 {
              font-size: 1.05em; /* 1.15em ??1.05em */
              margin-top: 10px;
              margin-bottom: 5px;
            }
            h4 {
              font-size: 1em; /* 1.05em ??1em */
              margin-top: 8px;
              margin-bottom: 4px;
            }
            p {
              margin-bottom: 5px;
              line-height: 1.4; /* 1.5 ??1.4 */
              font-size: 0.95em; /* ì¶”ê?: ë³¸ë¬¸ ?ìŠ¤??ì¶•ì†Œ */
            }
            ul, ol {
              margin: 6px 0;
              padding-left: 18px;
              font-size: 0.95em; /* ì¶”ê?: ë¦¬ìŠ¤???ìŠ¤??ì¶•ì†Œ */
            }
            li {
              margin: 2px 0;
              line-height: 1.4;
            }
            pre {
              padding: 10px;
              margin: 8px 0;
              font-size: 0.85em;
            }
            hr {
              margin: 15px 0;
            }
          }
          
          /* ?”¥ ëª¨ë°”??ê°€ë¡œëª¨??ìµœì ??*/
          @media (orientation: landscape) and (max-height: 600px) {
            body {
              padding: 6px;
              font-size: 11px;
            }
            .report-container {
              padding: 10px;
            }
            h1 { font-size: 1.2em; margin-bottom: 8px; }
            h2 { font-size: 1.1em; margin-top: 10px; margin-bottom: 5px; }
            h3 { font-size: 1em; margin-top: 8px; margin-bottom: 4px; }
            h4 { font-size: 0.95em; margin-top: 6px; margin-bottom: 3px; }
            p { font-size: 0.9em; margin-bottom: 4px; line-height: 1.3; }
            ul, ol { font-size: 0.9em; margin: 5px 0; padding-left: 15px; }
            li { margin: 1px 0; line-height: 1.3; }
          }
          
          /* ë§¤ìš° ?‘ì? ëª¨ë°”???”ë©´ */
          @media (max-width: 480px) {
            body {
              padding: 6px;
              font-size: 11px; /* 13px ??11px */
            }
            .report-container {
              padding: 12px;
            }
            h1 {
              font-size: 1.4em;
              margin-bottom: 10px;
            }
            h2 {
              font-size: 1.2em;
              margin-top: 12px;
              margin-bottom: 6px;
            }
            h3 {
              font-size: 1.1em;
              margin-top: 10px;
              margin-bottom: 5px;
            }
            h4 {
              font-size: 1.05em;
              margin-top: 8px;
              margin-bottom: 4px;
            }
          }
        </style>
      </head>
      <body>
        <div class="report-container">
          <h1>?“Š GPT4 ìµœì¢… ë¶„ì„ ë³´ê³ ??/h1>
          <div class="content">${htmlContent}</div>
        </div>
      </body>
      </html>
    `;

    // iframe??ì¶œë ¥
    const reportFrame = document.getElementById("html-report-frame");
    reportFrame.srcdoc = htmlReport;

    // ëª¨ë‹¬ ?´ê¸°
    document.getElementById("html-report-modal").classList.add("show");
  }

  // ë³´ê³ ???«ê¸° ?¨ìˆ˜
  function closeHtmlReport() {
    document.getElementById("html-report-modal").classList.remove("show");
  }

  // ?Œì´?„ë¼???¬ì‹œ???¨ìˆ˜
  function restartPipeline() {
    console.log('?”„ ?Œì´?„ë¼???¬ì‹œ???”ì²­');
    
    // ë³´ê³ ??ë²„íŠ¼ ì»¨í…Œ?´ë„ˆ ?¨ê?
    const reportBtnsContainer = document.getElementById('report-buttons-container');
    if (reportBtnsContainer) {
      reportBtnsContainer.style.display = 'none';
    }
    
    // ë¶„ì„?¤í–‰ ë²„íŠ¼ ?œì‹œ
    const topBtn = document.getElementById('top-pipeline-btn');
    if (topBtn) {
      topBtn.style.display = 'inline-block';
      topBtn.textContent = '?? ë¶„ì„?¤í–‰';
      topBtn.disabled = false;
      topBtn.style.background = 'linear-gradient(135deg, #4a90e2, #357abd)';
    }
    
    // ?Œì´?„ë¼???¬ì‹œ??
    handlePipelineAndReport();
  }

  // ==== A. ?°ì¸¡ ???œì–´ ?¨ìˆ˜ ë³´ê°• ====
  // ?°ì¸¡ ???˜ë¦¬ë¨¼íŠ¸ ìºì‹œ
  const $rightPanel = () => document.querySelector('aside.sidebar-right');

  // ì¹´ë“œ ?¬í¼: id??gpt1, gpt2, gpt3, gpt4 ??"?‘ë?"ë§??£ìœ¼ë©???
  function getAgentCard(idSuffix) {
    // ?°ì„ ?œìœ„: #card-gpt1, [data-agent="gpt1"], .gpt1-module-box
    return document.querySelector(`#card-${idSuffix}`)
        || document.querySelector(`[data-agent="${idSuffix}"]`)
        || document.querySelector(`.${idSuffix}-module-box`);
  }

  // ì¹´ë“œ ?íƒœ ? ê?
  function setAgentState(idSuffix, { running=false, done=false, expanded=true, active=true } = {}) {
    const card = getAgentCard(idSuffix);
    if (!card) return;

    // ?¤í–‰/?„ë£Œ ?íƒœ
    card.classList.toggle('running', !!running);
    card.classList.toggle('done', !!done);
    card.classList.toggle('active', !!active);

    // ?´ìš© ?•ì¥ (details ì§€??& ?¼ë°˜ div ì§€??
    card.classList.toggle('expanded', !!expanded);
    if (card.tagName?.toLowerCase() === 'details') {
      if (expanded) card.setAttribute('open', '');
      else card.removeAttribute('open');
    }
  }

  // ???¨ë…?œì‹œ ?´ì œ (?¬ëŸ¬ ì¹´ë“œ ?™ì‹œ ?¸ì¶œ???„í•´ ë°˜ë“œ???¸ì¶œ)
  function disableSoloMode() {
    const panel = $rightPanel();
    if (panel) panel.classList.remove('solo-mode');
  }

  // ?ˆì „ ?¤í¬ë¡?(ì¹´ë“œê°€ ?¤ì œë¡?ë³´ì—¬ì§€ê²?ë³´ì •)
  function scrollToAgent(idSuffix) {
    const panel = $rightPanel();
    const card  = getAgentCard(idSuffix);
    if (!panel || !card) return;
    try {
      const top = card.offsetTop - 12; // ?½ê°„ ???¬ìœ 
      panel.scrollTo({ top, behavior: 'smooth' });
    } catch(_) {}
  }

  // ==== B. GPT2 Worst ?œë‚˜ë¦¬ì˜¤ ?œì‘ ???™ì‹œ ?¸ì¶œ ?¸ë¦¬ê±?====
  function onGpt2WorstStartUI() {
    console.log('?? onGpt2WorstStartUI ?¤í–‰ ?œì‘');
    
    // 1) ëª¨ë“  ?¨ë„ ?´ë˜???•ë¦¬
    const panel = $rightPanel();
    if (panel) {
      console.log('?“‹ ?¨ë„ ?´ë˜???•ë¦¬ ì¤?..');
      panel.classList.remove('solo-mode', 'show-all');
      panel.classList.add('gpt2worst-mode');
      console.log('???¨ë„ ?´ë˜???¤ì • ?„ë£Œ:', panel.className);
    }

    // 2) ëª¨ë“  ì¹´ë“œ ì´ˆê¸°??(ê°•ì œë¡??¨ê?)
    console.log('?” ëª¨ë“  ì¹´ë“œ ì´ˆê¸°??ì¤?..');
    const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
    allCards.forEach(idSuffix => {
      const card = getAgentCard(idSuffix);
      if (card) {
        card.classList.remove('gpt2worst-visible', 'running', 'active');
        card.style.display = 'none';
        card.style.visibility = 'hidden';
        card.style.opacity = '0';
        console.log(`- ${idSuffix} ì¹´ë“œ ?¨ê? ?„ë£Œ`);
      }
    });

    // 3) GPT1, GPT2 ì¹´ë“œë§?ë³´ì´ê¸?
    console.log('?‘ï¸?GPT1, GPT2 ì¹´ë“œ ?œì‹œ ì¤?..');
    setAgentState('gpt1', { running: true, done: false, expanded: true, active: true });
    setAgentState('gpt2', { running: true, done: false, expanded: true, active: true });
    
    const gpt1Card = getAgentCard('gpt1');
    const gpt2Card = getAgentCard('gpt2');
    
    if (gpt1Card) {
      gpt1Card.classList.add('gpt2worst-visible');
      gpt1Card.style.display = 'block';
      gpt1Card.style.visibility = 'visible';
      gpt1Card.style.opacity = '1';
      console.log('??GPT1 ì¹´ë“œ ?œì‹œ ?„ë£Œ');
    }
    
    if (gpt2Card) {
      gpt2Card.classList.add('gpt2worst-visible');
      gpt2Card.style.display = 'block';
      gpt2Card.style.visibility = 'visible';
      gpt2Card.style.opacity = '1';
      console.log('??GPT2 ì¹´ë“œ ?œì‹œ ?„ë£Œ');
    }

    // 4) ?¤í¬ë¡¤ì? GPT1~GPT2 ì¤‘ê°„ì§€?ìœ¼ë¡?ë³´ì • (????ë³´ì´?„ë¡)
    if (panel && gpt1Card && gpt2Card) {
      const mid = (gpt1Card.offsetTop + gpt2Card.offsetTop) / 2 - 40;
      panel.scrollTo({ top: Math.max(mid, 0), behavior: 'smooth' });
      console.log('?“œ ?¤í¬ë¡??„ì¹˜ ì¡°ì • ?„ë£Œ');
    } else {
      // ?´ë°±
      gpt2Card ? scrollToAgent('gpt2') : scrollToAgent('gpt1');
      console.log('?“œ ?´ë°± ?¤í¬ë¡??¤í–‰');
    }
    
    console.log('?‰ onGpt2WorstStartUI ?¤í–‰ ?„ë£Œ');
  }

  // ==== C. GPT2 Worst ?œë‚˜ë¦¬ì˜¤ ì¢…ë£Œ ???íƒœ ?•ë¦¬ ====
  function onGpt2WorstDoneUI() {
    console.log('? onGpt2WorstDoneUI ?¤í–‰ ?œì‘');
    
    // GPT1?€ ?¤í–‰ ?œì‹œ ? ì?(?„ìš”??done), GPT2??done ì²˜ë¦¬
    setAgentState('gpt1', { running: false, done: true, expanded: true, active: true });
    setAgentState('gpt2', { running: false, done: true, expanded: true, active: true });

    // GPT2 Worst ëª¨ë“œ ?´ì œ (ëª¨ë“  ì¹´ë“œ ?¤ì‹œ ë³´ì´ê¸?
    const panel = $rightPanel();
    if (panel) {
      panel.classList.remove('gpt2worst-mode');
      console.log('??gpt2worst-mode ?´ë˜???œê±° ?„ë£Œ');
    }

    // ëª¨ë“  ì¹´ë“œ ?¤ì‹œ ë³´ì´ê¸?
    console.log('?‘ï¸?ëª¨ë“  ì¹´ë“œ ë³µì› ì¤?..');
    const allCards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
    allCards.forEach(idSuffix => {
      const card = getAgentCard(idSuffix);
      if (card) {
        card.classList.remove('gpt2worst-visible');
        card.style.display = '';
        card.style.visibility = '';
        card.style.opacity = '';
        console.log(`- ${idSuffix} ì¹´ë“œ ë³µì› ?„ë£Œ`);
      }
    });
    
    console.log('?‰ onGpt2WorstDoneUI ?¤í–‰ ?„ë£Œ');
  }

      // ==== D. ?”ë²„ê¹?? í‹¸ë¦¬í‹° ====
    function debugGpt2WorstMode() {
      const panel = $rightPanel();
      console.log('?” GPT2 Worst ëª¨ë“œ ?”ë²„ê¹?');
      console.log('- ?¨ë„:', panel);
      console.log('- gpt2worst-mode ?´ë˜??', panel?.classList.contains('gpt2worst-mode'));
      console.log('- solo-mode ?´ë˜??', panel?.classList.contains('solo-mode'));
      console.log('- show-all ?´ë˜??', panel?.classList.contains('show-all'));
      
      const cards = ['gpt0', 'gpt1', 'gpt2', 'gpt3', 'gpt4'];
      cards.forEach(id => {
        const card = getAgentCard(id);
        console.log(`- ${id} ì¹´ë“œ:`, card);
        console.log(`  - ?œì‹œ ?íƒœ:`, card?.style.display);
        console.log(`  - gpt2worst-visible ?´ë˜??`, card?.classList.contains('gpt2worst-visible'));
        console.log(`  - running ?´ë˜??`, card?.classList.contains('running'));
      });
    }

    // GPT2 Worst ëª¨ë“œ ê°•ì œ ?ŒìŠ¤???¨ìˆ˜
    function testGpt2WorstMode() {
      console.log('?§ª GPT2 Worst ëª¨ë“œ ?ŒìŠ¤???œì‘');
      onGpt2WorstStartUI();
      
      // 3ì´????ë™?¼ë¡œ ?„ë£Œ
      setTimeout(() => {
        console.log('??3ì´????ë™ ?„ë£Œ');
        onGpt2WorstDoneUI();
      }, 3000);
    }

    // GPT1, GPT2 ì¹´ë“œ ?¨ê³¼ ?ŒìŠ¤???¨ìˆ˜
    function testGpt1Gpt2Effects() {
      console.log('?§ª GPT1, GPT2 ì¹´ë“œ ?¨ê³¼ ?ŒìŠ¤???œì‘');
      showGpt1Gpt2Cards();
    }

    // GPT2 ?¤í–‰ ?¨ê³¼ ?ŒìŠ¤???¨ìˆ˜
    function testGpt2ExecutionEffects() {
      console.log('?§ª GPT2 ?¤í–‰ ?¨ê³¼ ?ŒìŠ¤???œì‘');
      applyGpt2ExecutionEffects();
    }

    // GPT2 ??GPT3 ?„í™˜ ??ì§€?ì  ?¨ê³¼ ?ìš© ?¨ìˆ˜
    function applyGpt2PersistentEffects() {
      console.log('?? GPT2 ??GPT3 ?„í™˜ ??ì§€?ì  ?¨ê³¼ ?ìš© ?œì‘');
      
      const gpt2Card = getAgentCard('gpt2');
      if (gpt2Card) {
        // GPT2 ì¹´ë“œ???¬ê¸° ë³€???†ëŠ” ?¨ê³¼ ì¶”ê?
        gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
        
        // GPT2 ?œëª©??ê¸€???¨ê³¼ ì¶”ê?
        const gpt2Title = gpt2Card.querySelector('h4');
        if (gpt2Title) {
          gpt2Title.classList.add('text-highlight');
          gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬???;
        }
        
        // GPT2 ì¹´ë“œë¡??¤í¬ë¡?
        scrollToElement('card-gpt2');
        console.log('?“œ GPT2 ??GPT3 ?„í™˜ ??GPT2 ì¹´ë“œ ì§€???¨ê³¼ ?ìš© (?¬ê¸° ë³€???†ìŒ)');
        
        // GPT3 ?œì‘ ??10ì´ˆê¹Œì§€ ?¨ê³¼ ? ì?
        window.gpt2PersistentEffects = {
          card: gpt2Card,
          title: gpt2Title,
          active: true
        };
      }
    }

    // GPT2 ??GPT3 ?„í™˜ ?¨ê³¼ ?ŒìŠ¤???¨ìˆ˜
    function testGpt2ToGpt3Transition() {
      console.log('?§ª GPT2 ??GPT3 ?„í™˜ ?¨ê³¼ ?ŒìŠ¤???œì‘');
      applyGpt2PersistentEffects();
    }

    // ==== E. ?¤í¬ë¡?? í‹¸ë¦¬í‹° ====
    function scrollToElement(elementId, offset = -40) {
      // ?”’ ?¤ì½”??? ê¸ˆ: GPT3 êµ¬ê°„?€ GPT3 ì¹´ë“œ/ëª¨ë“ˆë§? GPT4 êµ¬ê°„?€ GPT4 ì¹´ë“œë¡?ê°•ì œ
      const scope = window.__RightFocusScope || null;
      if (scope === 'gpt3') {
        if (!(elementId === 'card-gpt3' || /^gpt3-/.test(elementId))) {
          elementId = 'card-gpt3';
        }
      } else if (scope === 'gpt4') {
        elementId = 'card-gpt4';
      }

      const element = document.getElementById(elementId);
      if (!element) {
        console.warn(`? ï¸ ?”ì†Œë¥?ì°¾ì„ ???†ìŠµ?ˆë‹¤: ${elementId}`);
        return;
      }
      
      const panel = $rightPanel();
      if (panel) {
        const targetY = Math.max(0, (element.offsetTop || 0) + offset);
        panel.scrollTo({ top: targetY, behavior: 'smooth' });
        console.log(`?“œ ${elementId}ë¡??¤í¬ë¡??„ë£Œ`);
      } else {
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        console.log(`?“œ ${elementId}ë¡?ê¸°ë³¸ ?¤í¬ë¡??„ë£Œ`);
      }
    }

    // GPT0 ?„ë£Œ ??GPT1, GPT2 ì¹´ë“œ ?œì‹œ ?¨ìˆ˜
    function showGpt1Gpt2Cards() {
      console.log('?? GPT0 ?„ë£Œ - GPT1, GPT2 ì¹´ë“œ ?œì‹œ ?œì‘');
      
      const panel = $rightPanel();
      if (panel) {
        // show-all ?´ë˜??ì¶”ê?ë¡?ëª¨ë“  ì¹´ë“œ ?œì‹œ
        panel.classList.add('show-all');
        panel.classList.remove('solo-mode');
        console.log('??show-all ?´ë˜??ì¶”ê? ?„ë£Œ');
      }

      // GPT1, GPT2 ì¹´ë“œ ê°•ì œ ?œì‹œ
      const gpt1Card = getAgentCard('gpt1');
      const gpt2Card = getAgentCard('gpt2');
      
      if (gpt1Card) {
        gpt1Card.style.display = 'block';
        gpt1Card.style.visibility = 'visible';
        gpt1Card.style.opacity = '1';
        console.log('??GPT1 ì¹´ë“œ ?œì‹œ ?„ë£Œ');
      }
      
      if (gpt2Card) {
        gpt2Card.style.display = 'block';
        gpt2Card.style.visibility = 'visible';
        gpt2Card.style.opacity = '1';
        console.log('??GPT2 ì¹´ë“œ ?œì‹œ ?„ë£Œ');
      }

      // GPT1 ì¹´ë“œë¡??¤í¬ë¡?
      setTimeout(() => {
        if (gpt1Card) {
          scrollToElement('card-gpt1');
          console.log('?“œ GPT1 ì¹´ë“œë¡??¤í¬ë¡??„ë£Œ');
          
          // GPT1 ì¹´ë“œ ê¹œë°•???¨ê³¼ ì¶”ê?
          gpt1Card.classList.add('card-blink', 'border-pulse', 'border-glow');
          
          // GPT1 ?œëª©??ê¸€???¨ê³¼ ì¶”ê?
          const gpt1Title = gpt1Card.querySelector('h4');
          if (gpt1Title) {
            gpt1Title.classList.add('text-highlight');
            gpt1Title.textContent = 'GPT1 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬???;
          }
          
          // 2ë¶???GPT2 ì¹´ë“œë¡??´ë™?˜ê³  ?¨ê³¼ ì¶”ê? (ì¡°ê¸° ?¨ê³„ ì§„ì… ??ì·¨ì†Œë¥??„í•œ ?€?´ë¨¸ ë³´ê?)
          window.__gpt1ToGpt2Timer && clearTimeout(window.__gpt1ToGpt2Timer);
          window.__gpt1ToGpt2Timer = setTimeout(() => {
            if (gpt2Card) {
              // GPT1 ì¹´ë“œ ?¨ê³¼ ?œê±°
              gpt1Card.classList.remove('card-blink', 'border-pulse', 'border-glow');
              if (gpt1Title) {
                gpt1Title.classList.remove('text-highlight');
                gpt1Title.textContent = 'GPT1 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?;
              }
              console.log('??GPT1 ì¹´ë“œ ?¨ê³¼ ?œê±° ?„ë£Œ');
              
              // GPT2 ì¹´ë“œë¡??¤í¬ë¡?
              scrollToElement('card-gpt2');
              console.log('?“œ GPT2 ì¹´ë“œë¡??¤í¬ë¡??„ë£Œ');
              
              // GPT2 ì¹´ë“œ ì§€???¨ê³¼ ?ìš©
              gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
              
              // GPT2 ?œëª©??ê¸€???¨ê³¼ ì¶”ê?
              const gpt2Title = gpt2Card.querySelector('h4');
              if (gpt2Title) {
                gpt2Title.classList.add('text-highlight');
                gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬???;
              }
              console.log('??GPT2 ì¹´ë“œ ?¨ê³¼ ì¶”ê? ?„ë£Œ (?¬ê¸° ë³€???†ìŒ)');
              
              // GPT3 ?œì‘ ??4ë¶„ê¹Œì§€ ?¨ê³¼ ? ì? (GPT3 ?´ë²¤??ë¦¬ìŠ¤?ˆì—??ì²˜ë¦¬)
              console.log('??GPT2 ì¹´ë“œ ?¨ê³¼ ? ì? ì¤?(GPT3 ?œì‘ ??4ë¶„ê¹Œì§€)');
            }
          }, 120000);
        }
      }, 200);
    }

    // GPT3 ëª¨ë“ˆë³??œì°¨ ?¤í¬ë¡??¨ìˆ˜
    function scrollToGpt3Module(moduleName) {
      const moduleMap = {
        'market': 'gpt3-market',
        'credit': 'gpt3-credit', 
        'alm': 'gpt3-alm',
        'global': 'gpt3-global',
        'creditpf': 'gpt3-creditpf'
      };
      
      const elementId = moduleMap[moduleName];
      if (elementId) {
        setTimeout(() => {
          scrollToElement(elementId);
          
          // ?´ë‹¹ ëª¨ë“ˆ??ê¹œë°•???¨ê³¼ ì¶”ê?
          const element = document.getElementById(elementId);
          if (element) {
            element.classList.add('card-blink', 'border-pulse', 'border-glow');
            
            // 2ì´????¨ê³¼ ?œê±°
            setTimeout(() => {
              element.classList.remove('card-blink', 'border-pulse', 'border-glow');
            }, 2000);
          }
        }, 100);
        console.log(`?“œ GPT3 ${moduleName} ëª¨ë“ˆë¡??¤í¬ë¡?ë°??¨ê³¼ ?ìš©`);
      }
    }

    // GPT3 ì¹´ë“œë¡??¤í¬ë¡¤í•˜???¨ìˆ˜
    function scrollToGpt3Card() {
      setTimeout(() => {
        scrollToElement('card-gpt3');
        
        // GPT3 ì¹´ë“œ??ê¹œë°•???¨ê³¼ ì¶”ê?
        const gpt3Card = getAgentCard('gpt3');
        if (gpt3Card) {
          gpt3Card.classList.add('card-blink', 'border-pulse', 'border-glow');
          
          // GPT3 ?œëª©??ê¸€???¨ê³¼ ì¶”ê?
          const gpt3Title = gpt3Card.querySelector('h4');
          if (gpt3Title) {
            gpt3Title.classList.add('text-highlight');
            gpt3Title.textContent = 'GPT3 ?„ë©”?¸ë³„ ë¦¬ìŠ¤??ë¶„ì„ ??;
          }
          
          // 3ì´????¨ê³¼ ?œê±°
          setTimeout(() => {
            gpt3Card.classList.remove('card-blink', 'border-pulse', 'border-glow');
            if (gpt3Title) {
              gpt3Title.classList.remove('text-highlight');
              gpt3Title.textContent = 'GPT3 ?„ë©”?¸ë³„ ë¦¬ìŠ¤??ë¶„ì„';
            }
          }, 3000);
        }
      }, 100);
      console.log('?“œ GPT3 ì¹´ë“œë¡??¤í¬ë¡?ë°??¨ê³¼ ?ìš©');
    }

    // GPT2 ?¤í–‰ ???¨ê³¼ ?ìš© ?¨ìˆ˜
    function applyGpt2ExecutionEffects() {
      console.log('?? GPT2 ?¤í–‰ ?¨ê³¼ ?ìš© ?œì‘');
      
      const gpt2Card = getAgentCard('gpt2');
      if (gpt2Card) {
        // GPT2 ì¹´ë“œ???¬ê¸° ë³€???†ëŠ” ?¤í–‰ ?¨ê³¼ ì¶”ê?
        gpt2Card.classList.add('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
        
        // GPT2 ?œëª©??ê¸€???¨ê³¼ ì¶”ê?
        const gpt2Title = gpt2Card.querySelector('h4');
        if (gpt2Title) {
          gpt2Title.classList.add('text-highlight');
          gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬???';
        }
        
        // GPT2 ì¹´ë“œë¡??¤í¬ë¡?
        setTimeout(() => {
          scrollToElement('card-gpt2');
          console.log('?“œ GPT2 ?¤í–‰ ì¹´ë“œë¡??¤í¬ë¡??„ë£Œ');
        }, 500);
        
        // 4ì´????¨ê³¼ ?œê±°
        setTimeout(() => {
          gpt2Card.classList.remove('card-blink', 'border-pulse', 'border-glow', 'border-gradient');
          if (gpt2Title) {
            gpt2Title.classList.remove('text-highlight');
            gpt2Title.textContent = 'GPT2 ?„ë¡¬?„íŠ¸ / ì¶œë ¥ë¬?;
          }
          console.log('?‰ GPT2 ?¤í–‰ ?¨ê³¼ ?„ë£Œ (?¬ê¸° ë³€???†ìŒ)');
        }, 4000);
      }
    }

    // ==== F. textarea ?ë™ ?’ì´ ?•ì¥ ? í‹¸ ====
  function autoGrow(ids) {
    (ids || []).forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight || 0) + 'px';
      if (!el.__autogrowBound) {
        el.addEventListener('input', () => {
          el.style.height = 'auto';
          el.style.height = (el.scrollHeight || 0) + 'px';
        });
        el.__autogrowBound = true;
      }
    });
  }
  
  // ì´ˆê¸° ?œë”ë§?????ë²??„ì²´ ?ìš©(?¤í–‰/ë¦¬ì‚¬?´ì¦ˆ ?€??
  window.addEventListener('load', () => {
    autoGrow(['gpt1-output','gpt2-system','gpt2-output','gpt3-market','gpt3-credit','gpt3-alm','gpt3-global','gpt3-creditpf','gpt4-output']);  // ?”¹ GPT4 ì¶œë ¥ textarea???ë™ ?’ì´ ?•ì¥
  });

  // === [ì¶”ê?] Right ???„ì²´ ì¹´ë“œ ?¸ì¶œ/?•ì¥ ? í‹¸ ===
  function showAllRightCardsExpanded() {
    const panel = $rightPanel && $rightPanel();
    if (!panel) return;

    panel.classList.remove('solo-mode', 'gpt2worst-mode');
    panel.classList.add('show-all');

    ['gpt0','gpt1','gpt2','gpt3','gpt4'].forEach(id =>
      setAgentState(id, { expanded: true, active: true }) // expanded ?´ë˜??? ê?
    );
  }
  </script>
</body>
</html>

